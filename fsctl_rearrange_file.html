<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="FSCTL_REARRANGE_FILE - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>FSCTL_REARRANGE_FILE - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            FSCTL_REARRANGE_FILE - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">#define FSCTL_REARRANGE_FILE /* IOCTL code */</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ni-ntifs-fsctl_rearrange_file">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/fsctl_rearrange_file.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ni-ntifs-fsctl_rearrange_file)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2 id="description">Description</h2>

<p><strong>FSCTL_REARRANGE_FILE</strong> rearranges allocation within the file, moving clusters from a requested contiguous source range within a file to another location within the same file.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="major-code">Major code</h3>

<h3 id="input-buffer">Input buffer</h3>

<p>Pointer to a <a rel="noopener" target="_blank" href="rearrange_file_data"><strong>REARRANGE_FILE_DATA</strong></a> structure that describes the allocation to be rearranged. (For 32-bit callers, the input buffer is a pointer to a <strong>REARRANGE_FILE_DATA32</strong> structure.)</p>

<h3 id="input-buffer-length">Input buffer length</h3>

<p>Size in bytes of the input buffer.</p>

<h3 id="output-buffer">Output buffer</h3>

<p>None; set to NULL.</p>

<h3 id="output-buffer-length">Output buffer length</h3>

<p>Set to zero.</p>

<h3 id="inputoutput-buffer">Input/output buffer</h3>

<h3 id="inputoutput-buffer-length">Input/output buffer length</h3>

<h3 id="status-block">Status block</h3>

<h2 id="return-values">Return values</h2>

<p><strong>FSCTL_REARRANGE_FILE</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> upon successful completion; otherwise it returns an <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> code such as one of the following.</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td>STATUS_ACCESS_DENIED</td>
  <td>Only kernel-mode calls are allowed.</td>
</tr>
<tr>
  <td>STATUS_BUFFER_TOO_SMALL</td>
  <td>The specified input buffer length is smaller than sizeof(<a href="rearrange_file_data" title="typedef struct _REARRANGE_FILE_DATA {&#10;  ULONGLONG SourceStartingOffset;&#10;  ULONGLONG TargetOffset;&#10;  HANDLE    SourceFileHandle;&#10;  ULONG     Length;&#10;  ULONG     Flags;&#10;} REARRANGE_FILE_DATA, *PREARRANGE_FILE_DATA;">REARRANGE_FILE_DATA</a>).</td>
</tr>
<tr>
  <td>STATUS_PENDING</td>
  <td>Operation completion is pending.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p><a rel="noopener" target="_blank" href="rearrange_file_data">Request parameters</a> contain source and target file byte offsets, and length in bytes of the source region to move, all of which must be cluster-aligned.</p>

<ul>
<li>If moving clusters down, the target file offset indicates the point at which the lower boundary of the moving source range should be aligned.</li>
<li>If moving clusters up, the target file offset indicates the point at which the source range's upper boundary should be aligned.</li>
</ul>

<p>In both cases, the target offset indicates that the source range should be inserted before the cluster that begins at the target offset, the distinction being forced by the constraint that the allocation size remains fixed.</p>

<p>Unlike <a rel="noopener" target="_blank" href="fsctl_shuffle_file"><strong>FSCTL_SHUFFLE_FILE</strong></a>, <strong>FSCTL_REARRANGE_FILE</strong> doesn't allow adding allocations containing random data.</p>

<p>To perform this operation, call <a rel="noopener" target="_blank" href="fltfscontrolfile"><strong>FltFsControlFile</strong></a> or <a rel="noopener" target="_blank" href="ntfscontrolfile"><strong>ZwFsControlFile</strong></a> with the following parameters.</p>

<table>
<thead>
<tr>
  <th>Parameter</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>Instance</strong></td>
  <td>[in] For <strong><a href="fltfscontrolfile" title="NTSTATUS FLTAPI FltFsControlFile(&#10;  [in]            PFLT_INSTANCE Instance,&#10;  [in]            PFILE_OBJECT  FileObject,&#10;  [in]            ULONG         FsControlCode,&#10;  [in, optional]  PVOID         InputBuffer,&#10;  [in]            ULONG         InputBufferLength,&#10;  [out, optional] PVOID         OutputBuffer,&#10;  [in]            ULONG         OutputBufferLength,&#10;  [out, optional] PULONG        LengthReturned&#10;);">FltFsControlFile</a></strong> only. An opaque instance pointer for the caller. This parameter is required and cannot be NULL.</td>
</tr>
<tr>
  <td><strong>FileObject</strong></td>
  <td>[in] For <strong><a href="fltfscontrolfile" title="NTSTATUS FLTAPI FltFsControlFile(&#10;  [in]            PFLT_INSTANCE Instance,&#10;  [in]            PFILE_OBJECT  FileObject,&#10;  [in]            ULONG         FsControlCode,&#10;  [in, optional]  PVOID         InputBuffer,&#10;  [in]            ULONG         InputBufferLength,&#10;  [out, optional] PVOID         OutputBuffer,&#10;  [in]            ULONG         OutputBufferLength,&#10;  [out, optional] PULONG        LengthReturned&#10;);">FltFsControlFile</a></strong> only. A file object pointer for the file or directory that is the target of this request. This parameter is required and cannot be NULL.</td>
</tr>
<tr>
  <td><strong>FileHandle</strong></td>
  <td>[in] For <strong><a href="ntfscontrolfile" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtFsControlFile(&#10;    _In_ HANDLE FileHandle,&#10;    _In_opt_ HANDLE Event,&#10;    _In_opt_ PIO_APC_ROUTINE ApcRoutine,&#10;    _In_opt_ PVOID ApcContext,&#10;    _Out_ PIO_STATUS_BLOCK IoStatusBlock,&#10;    _In_ ULONG FsControlCode,&#10;    _In_reads_bytes_opt_(InputBufferLength) PVOID InputBuffer,&#10;    _In_ ULONG InputBufferLength,&#10;    _Out_writes_bytes_opt_(OutputBufferLength) PVOID OutputBuffer,&#10;    _In_ ULONG OutputBufferLength&#10;    );">ZwFsControlFile</a></strong> only. File handle of the file or directory that is the target of this request. This parameter is required and cannot be NULL.</td>
</tr>
<tr>
  <td><strong>IoStatusBlock</strong></td>
  <td>[out] For <strong><a href="ntfscontrolfile" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtFsControlFile(&#10;    _In_ HANDLE FileHandle,&#10;    _In_opt_ HANDLE Event,&#10;    _In_opt_ PIO_APC_ROUTINE ApcRoutine,&#10;    _In_opt_ PVOID ApcContext,&#10;    _Out_ PIO_STATUS_BLOCK IoStatusBlock,&#10;    _In_ ULONG FsControlCode,&#10;    _In_reads_bytes_opt_(InputBufferLength) PVOID InputBuffer,&#10;    _In_ ULONG InputBufferLength,&#10;    _Out_writes_bytes_opt_(OutputBufferLength) PVOID OutputBuffer,&#10;    _In_ ULONG OutputBufferLength&#10;    );">ZwFsControlFile</a></strong> only. Pointer to an <a rel="noopener" target="_blank" href="io_status_block"><strong>IO_STATUS_BLOCK</strong></a> structure that contains the final status of the request.</td>
</tr>
<tr>
  <td><strong>FsControlCode</strong></td>
  <td>[in] Set to <strong>FSCTL_REARRANGE_FILE</strong>.</td>
</tr>
<tr>
  <td><strong>InputBuffer</strong></td>
  <td>[in] See IOCTL parameters.</td>
</tr>
<tr>
  <td><strong>InputBufferLength</strong></td>
  <td>[in] See IOCTL parameters.</td>
</tr>
</tbody>
</table>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="fltfscontrolfile"><strong>FltFsControlFile</strong></a></p>

<p><a rel="noopener" target="_blank" href="fsctl_shuffle_file"><strong>FSCTL_SHUFFLE_FILE</strong></a></p>

<p><a rel="noopener" target="_blank" href="rearrange_file_data"><strong>REARRANGE_FILE_DATA</strong></a></p>

<p><a rel="noopener" target="_blank" href="ntfscontrolfile"><strong>ZwFsControlFile</strong></a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ni-ntifs-fsctl_rearrange_file">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/ni-ntifs-fsctl_rearrange_file.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
