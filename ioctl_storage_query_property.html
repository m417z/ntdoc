<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="IOCTL_STORAGE_QUERY_PROPERTY - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>IOCTL_STORAGE_QUERY_PROPERTY - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            IOCTL_STORAGE_QUERY_PROPERTY - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntddstor.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x002d, 0x500, METHOD_BUFFERED, FILE_ANY_ACCESS)
#define IOCTL_STORAGE_QUERY_PROPERTY 0x002D1400</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntddstor/ni-ntddstor-ioctl_storage_query_property">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// winioctl.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x002d, 0x500, METHOD_BUFFERED, FILE_ANY_ACCESS)
#define IOCTL_STORAGE_QUERY_PROPERTY 0x002D1400</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_protocol_command">View the official Win32 API reference</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// winioctl.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x002d, 0x500, METHOD_BUFFERED, FILE_ANY_ACCESS)
#define IOCTL_STORAGE_QUERY_PROPERTY 0x002D1400</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_query_property">View the official Win32 API reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ioctl_storage_query_property.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ni-ntddstor-ioctl_storage_query_property)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="ioctl_storage_query_property-ioctl">IOCTL_STORAGE_QUERY_PROPERTY IOCTL</h1>

<h2 id="description">Description</h2>

<p>A driver can use <strong>IOCTL_STORAGE_QUERY_PROPERTY</strong> to return properties of a storage device or adapter. The request indicates the kind of information to retrieve, such as inquiry data for a device or capabilities and limitations of an adapter. <strong>IOCTL_STORAGE_QUERY_PROPERTY</strong> can also be used to determine whether the port driver supports a particular property or which fields in the property descriptor can be modified with a subsequent change-property request.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="major-code">Major code</h3>

<h3 id="input-buffer">Input buffer</h3>

<p><strong>Parameters.DeviceIoControl.InputBufferLength</strong> indicates the size, in bytes, of the parameter buffer at <strong>Irp->AssociatedIrp.SystemBuffer</strong>, which must be &gt;= <strong>sizeof</strong>(<a rel="noopener" target="_blank" href="storage_property_query"><strong>STORAGE_PROPERTY_QUERY</strong></a>).</p>

<p><strong>Irp->AssociatedIrp.SystemBuffer</strong> contains <a rel="noopener" target="_blank" href="storage_property_query"><strong>STORAGE_PROPERTY_QUERY</strong></a> data that specifies whether to query the device or the adapter, the type of query to perform, and any additional parameters required for the query, such as the page code for a particular SCSI mode sense page. Device properties must be retrieved only from a device; attempting to retrieve device properties from an adapter will cause an error.</p>

<p><strong>Parameters.DeviceIoControl.OutputBufferLength</strong> indicates the number of bytes that can be written to <strong>Irp->AssociatedIrp.SystemBuffer</strong>. <strong>OutputBufferLength</strong> can be zero to determine whether a property exists without retrieving its data.</p>

<h3 id="input-buffer-length">Input buffer length</h3>

<p><strong>Parameters.DeviceIoControl.InputBufferLength</strong> indicates the size, in bytes, of the parameter buffer at <strong>Irp->AssociatedIrp.SystemBuffer</strong>, which must be &gt;= <strong>sizeof</strong>(<a rel="noopener" target="_blank" href="storage_property_query"><strong>STORAGE_PROPERTY_QUERY</strong></a>).</p>

<h3 id="output-buffer">Output buffer</h3>

<p>The driver returns query data to the buffer at <strong>Irp->AssociatedIrp.SystemBuffer</strong>. Varying amounts of bus-specific data can be appended to the structure.</p>

<h3 id="output-buffer-length">Output buffer length</h3>

<p>Cast the structure returned to a <a rel="noopener" target="_blank" href="storage_descriptor_header"><strong>STORAGE_DESCRIPTOR_HEADER</strong></a> and check its <strong>Size</strong> member to determine the number of bytes the structure actually requires.</p>

<h3 id="inputoutput-buffer">Input/output buffer</h3>

<h3 id="inputoutput-buffer-length">Input/output buffer length</h3>

<h3 id="status-block">Status block</h3>

<p>The <strong>Information</strong> field is set to the number of bytes returned. The <strong>Status</strong> field is set to <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a>, or possibly to STATUS_INVALID_DEVICE_REQUEST, STATUS_INVALID_PARAMETER, or STATUS_NOT_SUPPORTED.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="storage_descriptor_header"><strong>STORAGE_DESCRIPTOR_HEADER</strong></a></p>

<p><a rel="noopener" target="_blank" href="storage_property_query"><strong>STORAGE_PROPERTY_QUERY</strong></a></p>

<p><a rel="noopener" target="_blank" href="storage_rpmb_data_frame"><strong>STORAGE_RPMB_DATA_FRAME</strong></a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntddstor/ni-ntddstor-ioctl_storage_query_property">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntddstor/ni-ntddstor-ioctl_storage_query_property.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Win32 API reference (ni-winioctl-ioctl_storage_protocol_command)</h1>
</div>
<div class="ntdoc-description">
<h1><a href="ioctl_storage_protocol_command" title="// CTL_CODE(0x002d, 0x4f0, METHOD_BUFFERED, FILE_READ_ACCESS | FILE_WRITE_ACCESS)&#10;#define IOCTL_STORAGE_PROTOCOL_COMMAND 0x002DD3C0">IOCTL_STORAGE_PROTOCOL_COMMAND</a> IOCTL</h1>

<h2>Description</h2>

<p>Windows applications can use <strong><a href="ioctl_storage_protocol_command" title="// CTL_CODE(0x002d, 0x4f0, METHOD_BUFFERED, FILE_READ_ACCESS | FILE_WRITE_ACCESS)&#10;#define IOCTL_STORAGE_PROTOCOL_COMMAND 0x002DD3C0">IOCTL_STORAGE_PROTOCOL_COMMAND</a></strong> to conduct pass-through of protocol specific commands to the storage device or adapter. The request indicates the bus specific command which is further sent to a specific type of device to process. For more information, see the page on <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/fileio/working-with-nvme-devices#using-ioctl_storage_protocol_command-to-send-commands">working with NVMe drives</a>.</p>

<p>To perform this operation, call the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol"><strong>DeviceIoControl</strong></a> function with the following parameters.</p>

<div class="codehilite">
<pre><span></span><code><span class="n">BOOL</span><span class="w"> </span><span class="n">DeviceIoControl</span><span class="p">(</span>
<span class="w">  </span><span class="p">(</span><span class="n">HANDLE</span><span class="p">)</span><span class="w"> </span><span class="n">hDevice</span><span class="p">,</span><span class="w">                 </span><span class="c1">// handle to device</span>
<span class="w">  </span><span class="n"><a href="ioctl_storage_protocol_command" title="// CTL_CODE(0x002d, 0x4f0, METHOD_BUFFERED, FILE_READ_ACCESS | FILE_WRITE_ACCESS)&#10;#define IOCTL_STORAGE_PROTOCOL_COMMAND 0x002DD3C0">IOCTL_STORAGE_PROTOCOL_COMMAND</a></span><span class="p">,</span><span class="w">   </span><span class="c1">// dwIoControlCode</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPDWORD</span><span class="p">)</span><span class="w"> </span><span class="n">lpInBuffer</span><span class="p">,</span><span class="w">             </span><span class="c1">// input buffer</span>
<span class="w">  </span><span class="p">(</span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="p">)</span><span class="w"> </span><span class="n">nInBufferSize</span><span class="p">,</span><span class="w">            </span><span class="c1">// size of input buffer</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPDWORD</span><span class="p">)</span><span class="w"> </span><span class="n">lpOutBuffer</span><span class="p">,</span><span class="w">            </span><span class="c1">// output buffer</span>
<span class="w">  </span><span class="p">(</span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="p">)</span><span class="w"> </span><span class="n">nOutBufferSize</span><span class="p">,</span><span class="w">           </span><span class="c1">// size of output buffer</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPDWORD</span><span class="p">)</span><span class="w"> </span><span class="n">lpBytesReturned</span><span class="p">,</span><span class="w">        </span><span class="c1">// number of bytes returned</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPOVERLAPPED</span><span class="p">)</span><span class="w"> </span><span class="n">lpOverlapped</span><span class="w">       </span><span class="c1">// OVERLAPPED structure</span>
<span class="p">);</span>
</code></pre>
</div>

<h2>Parameters</h2>

<h3>Input buffer</h3>

<h3>Input buffer length</h3>

<h3>Output buffer</h3>

<h3>Output buffer length</h3>

<h3>Input/output buffer</h3>

<h3>Input/output buffer length</h3>

<h3>Status block</h3>

<p>Irp->IoStatus.Status is set to <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the request is successful.</p>

<p>Otherwise, Status to the appropriate error condition as a <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> code.</p>

<p>For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/ntstatus-values">NTSTATUS Values</a>.</p>

<h2>See also</h2>

<ul>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">DeviceIoControl</a></li>
<li><a rel="noopener" target="_blank" href="storage_property_id">STORAGE_PROPERTY_ID</a></li>
<li><a rel="noopener" target="_blank" href="storage_property_query">STORAGE_PROPERTY_QUERY</a></li>
</ul>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_protocol_command">View the official Win32 API reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/sdk-api/blob/docs/sdk-api-src/content/winioctl/ni-winioctl-ioctl_storage_protocol_command.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Win32 API reference (ni-winioctl-ioctl_storage_query_property)</h1>
</div>
<div class="ntdoc-description">
<h1>IOCTL_STORAGE_QUERY_PROPERTY IOCTL</h1>

<h2>Description</h2>

<p>Windows applications can use this control code to return the properties of a storage device or adapter. The request indicates the kind of information to retrieve, such as the inquiry data for a device or the capabilities and limitations of an adapter. <strong>IOCTL_STORAGE_QUERY_PROPERTY</strong> can also be used to determine whether the port driver supports a particular property or which fields in the property descriptor can be modified with a subsequent change-property request.</p>

<div class="codehilite">
<pre><span></span><code><span class="n">BOOL</span><span class="w"> </span><span class="n">DeviceIoControl</span><span class="p">(</span>
<span class="w">     </span><span class="n">_In_</span><span class="w">        </span><span class="p">(</span><span class="n">HANDLE</span><span class="p">)</span><span class="w">       </span><span class="n">hDevice</span><span class="p">,</span><span class="w">                </span><span class="c1">// handle to a partition</span>
<span class="w">     </span><span class="n">_In_</span><span class="w">        </span><span class="p">(</span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="p">)</span><span class="w"> </span><span class="n">IOCTL_STORAGE_QUERY_PROPERTY</span><span class="p">,</span><span class="w">  </span><span class="c1">// dwIoControlCode</span>
<span class="w">     </span><span class="n">_In_</span><span class="w">        </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="w">       </span><span class="n">lpInBuffer</span><span class="p">,</span><span class="w">             </span><span class="c1">// input buffer - <a href="storage_property_query" title="typedef struct _STORAGE_PROPERTY_QUERY {&#10;  STORAGE_PROPERTY_ID PropertyId;&#10;  STORAGE_QUERY_TYPE  QueryType;&#10;  UCHAR               AdditionalParameters[1];&#10;} STORAGE_PROPERTY_QUERY, *PSTORAGE_PROPERTY_QUERY;">STORAGE_PROPERTY_QUERY</a> structure</span>
<span class="w">     </span><span class="n">_In_</span><span class="w">        </span><span class="p">(</span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="p">)</span><span class="w">        </span><span class="n">nInBufferSize</span><span class="p">,</span><span class="w">          </span><span class="c1">// size of input buffer</span>
<span class="w">     </span><span class="n">_Out_opt_</span><span class="w">   </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="w">       </span><span class="n">lpOutBuffer</span><span class="p">,</span><span class="w">            </span><span class="c1">// output buffer - see Remarks</span>
<span class="w">     </span><span class="n">_In_</span><span class="w">        </span><span class="p">(</span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="p">)</span><span class="w">        </span><span class="n">nOutBufferSize</span><span class="p">,</span><span class="w">         </span><span class="c1">// size of output buffer</span>
<span class="w">     </span><span class="n">_Out_opt_</span><span class="w">   </span><span class="p">(</span><span class="n">LPDWORD</span><span class="p">)</span><span class="w">      </span><span class="n">lpBytesReturned</span><span class="p">,</span><span class="w">        </span><span class="c1">// number of bytes returned</span>
<span class="w">     </span><span class="n">_Inout_opt_</span><span class="w"> </span><span class="p">(</span><span class="n">LPOVERLAPPED</span><span class="p">)</span><span class="w"> </span><span class="n">lpOverlapped</span><span class="w">            </span><span class="c1">// OVERLAPPED structure</span>
<span class="p">);</span>
</code></pre>
</div>

<h2>Parameters</h2>

<h3>Input buffer</h3>

<h3>Input buffer length</h3>

<h3>Output buffer</h3>

<h3>Output buffer length</h3>

<h3>Input/output buffer</h3>

<h3>Input/output buffer length</h3>

<h3>Status block</h3>

<p>Irp->IoStatus.Status is set to <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the request is successful.</p>

<p>Otherwise, Status to the appropriate error condition as a <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> code.</p>

<p>For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/ntstatus-values">NTSTATUS Values</a>.</p>

<h2>Remarks</h2>

<p>The optional output buffer returned through the <em>lpOutBuffer</em> parameter can be one of several structures depending on the value of the <strong>PropertyId</strong> member of the <a rel="noopener" target="_blank" href="storage_property_query">STORAGE_PROPERTY_QUERY</a> structure pointed to by the <em>lpInBuffer</em> parameter. These values are enumerated by the <a rel="noopener" target="_blank" href="storage_property_id">STORAGE_PROPERTY_ID</a> enumeration. If the <strong>QueryType</strong> member of the <strong><a href="storage_property_query" title="typedef struct _STORAGE_PROPERTY_QUERY {&#10;  STORAGE_PROPERTY_ID PropertyId;&#10;  STORAGE_QUERY_TYPE  QueryType;&#10;  UCHAR               AdditionalParameters[1];&#10;} STORAGE_PROPERTY_QUERY, *PSTORAGE_PROPERTY_QUERY;">STORAGE_PROPERTY_QUERY</a></strong> is set to <strong>PropertyExistsQuery</strong> then no structure is returned.</p>

<h2>See also</h2>

<ul>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/FileIO/disk-management-control-codes">Disk Management Control Codes</a></li>
<li><a rel="noopener" target="_blank" href="storage_descriptor_header">STORAGE_DESCRIPTOR_HEADER</a></li>
<li><a rel="noopener" target="_blank" href="storage_property_query">STORAGE_PROPERTY_QUERY</a></li>
</ul>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows/win32/api/winioctl/ni-winioctl-ioctl_storage_query_property">View the official Win32 API reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/sdk-api/blob/docs/sdk-api-src/content/winioctl/ni-winioctl-ioctl_storage_query_property.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
