<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="KeSetCoalescableTimer - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>KeSetCoalescableTimer - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            KeSetCoalescableTimer - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">BOOLEAN KeSetCoalescableTimer(
  [in, out]      PKTIMER       Timer,
  [in]           LARGE_INTEGER DueTime,
  [in]           <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>         Period,
  [in]           <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>         TolerableDelay,
  [in, optional] PKDPC         Dpc
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kesetcoalescabletimer">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/kesetcoalescabletimer.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdm-kesetcoalescabletimer)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2 id="description">Description</h2>

<p>The <strong>KeSetCoalescableTimer</strong> routine sets the initial expiration time and period of a timer object and specifies how much delay can be tolerated in the expiration times.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="timer-in-out"><code>Timer</code> [in, out]</h3>

<p>A pointer to a timer object. This parameter points to a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/eprocess">KTIMER</a> structure, which is an opaque, system structure that represents the timer object. This object must have been previously initialized by the <a href="keinitializetimerex" title="VOID KeInitializeTimerEx(&#10;  [out] PKTIMER    Timer,&#10;  [in]  TIMER_TYPE Type&#10;);">KeInitializeTimerEx</a> or <a href="keinitializetimer" title="VOID KeInitializeTimer(&#10;  [out] PKTIMER Timer&#10;);">KeInitializeTimer</a> routine.</p>

<h3 id="duetime-in"><code>DueTime</code> [in]</h3>

<p>Specifies an absolute or relative time at which the timer is to expire. If the value of the <em>DueTime</em> parameter is negative, the expiration time is relative to the current system time. Otherwise, the expiration time is absolute. The expiration time is expressed in system time units, which are 100-nanosecond intervals. Absolute expiration times track any changes that are made to the system clock. Relative expiration times are not affected by system clock changes.</p>

<h3 id="period-in"><code>Period</code> [in]</h3>

<p>Specifies the interval between periodic timer expirations in milliseconds. The value of this parameter must not exceed <a href="maxlong" title="#define MAXLONG 0x7fffffff // winnt">MAXLONG</a>. This parameter is optional and can be set to zero to indicate that the timer is nonperiodic.</p>

<h3 id="tolerabledelay-in"><code>TolerableDelay</code> [in]</h3>

<p>Specifies a tolerance, in milliseconds, for the timer period that <em>Period</em> specifies and for the initial time interval that <em>DueTime</em> specifies. For a periodic timer, the time interval between two successive timer expirations will be in the range from (*Period* - <em>TolerableDelay</em>) to (*Period* + <em>TolerableDelay</em>). The initial expiration time will be in the range from <em>DueTime</em> to (*DueTime* + <em>TolerableDelay</em>). The <em>TolerableDelay</em> value cannot be negative.</p>

<h3 id="dpc-in-optional"><code>Dpc</code> [in, optional]</h3>

<p>A pointer to a DPC object. This parameter points to a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/eprocess">KDPC</a> structure, which is an opaque, system structure that represents the DPC object. This object must have been previously initialized by the <a href="keinitializedpc" title="VOID KeInitializeDpc(&#10;  [out]          __drv_aliasesMem PRKDPC Dpc,&#10;  [in]           PKDEFERRED_ROUTINE      DeferredRoutine,&#10;  [in, optional] __drv_aliasesMem PVOID  DeferredContext&#10;);">KeInitializeDpc</a> routine. This parameter is optional and can be specified as <strong>NULL</strong> if the caller does not require a DPC.</p>

<h2 id="return-value">Return value</h2>

<p><strong>KeSetCoalescableTimer</strong> returns <strong>TRUE</strong> if the timer object was already in the system timer queue. Otherwise, it returns <strong>FALSE</strong>.</p>

<h2 id="remarks">Remarks</h2>

<p>This routine does the following:</p>

<ul>
<li><p>Sets the timer to a non-signaled state.</p></li>
<li><p>Associates the timer with the DPC, if a DPC is specified.</p></li>
<li><p>Cancels the timer if it is already active.</p></li>
<li><p>Makes the timer active and sets the due time and period of the timer to the specified values. The timer can expire immediately if the specified due time has already passed.</p></li>
</ul>

<p>The <a href="kesettimerex" title="BOOLEAN KeSetTimerEx(&#10;  [in, out]      PKTIMER       Timer,&#10;  [in]           LARGE_INTEGER DueTime,&#10;  [in]           LONG          Period,&#10;  [in, optional] PKDPC         Dpc&#10;);">KeSetTimerEx</a> routine is similar to <strong>KeSetCoalescableTimer</strong> but does not accept a <em>TolerableDelay</em> parameter. The <em>TolerableDelay</em> parameter of <strong>KeSetCoalescableTimer</strong> enables the caller to specify a tolerance for the timer period. A call to <strong>KeSetCoalescableTimer</strong> with <em>TolerableDelay</em> = 0 is the same as a call to <strong><a href="kesettimerex" title="BOOLEAN KeSetTimerEx(&#10;  [in, out]      PKTIMER       Timer,&#10;  [in]           LARGE_INTEGER DueTime,&#10;  [in]           LONG          Period,&#10;  [in, optional] PKDPC         Dpc&#10;);">KeSetTimerEx</a></strong>. In many instances, developers can easily modify existing drivers by replacing calls to <strong><a href="kesettimerex" title="BOOLEAN KeSetTimerEx(&#10;  [in, out]      PKTIMER       Timer,&#10;  [in]           LARGE_INTEGER DueTime,&#10;  [in]           LONG          Period,&#10;  [in, optional] PKDPC         Dpc&#10;);">KeSetTimerEx</a></strong> with calls to <strong>KeSetCoalescableTimer</strong>.</p>

<p>If two <strong>KeSetCoalescableTimer</strong> calls specify the same timer object, and the second call occurs before the <em>DueTime</em> that is specified for the first call expires, the second call implicitly cancels the timer from the first call. However, if a timer expiration from the first call has already enabled a DPC to run, the DPC might run after the timer is canceled. The second call replaces the pending expiration time from the first call with a new expiration time, and activates the timer again.</p>

<p>If the <em>Period</em> parameter is nonzero, the timer is periodic. For a periodic timer, the first timer expiration occurs at the time indicated by the <em>DueTime</em> parameter. Later expirations are separated by the interval that is specified by <em>Period</em>. If <em>Period</em> = 0, the timer is nonperiodic and expires at the time that is indicated by <em>DueTime</em>.</p>

<p>If the <em>Dpc</em> parameter is non-<strong>NULL</strong>, the routine creates an association between the specified DPC object and the timer object. After the timer expires, the timer service removes the timer object from the system timer queue and sets this object to a signaled state. If a DPC object is associated with the timer object, the timer service inserts the DPC object into the system DPC queue to run as soon as conditions allow.</p>

<p>Only one instance of a particular DPC object can be in the system DPC queue at a time. To avoid potential race conditions, avoid passing the same DPC object to both the <strong>KeSetCoalescableTimer</strong> and <a href="keinsertqueuedpc" title="BOOLEAN KeInsertQueueDpc(&#10;  [in, out]      PRKDPC                 Dpc,&#10;  [in, optional] PVOID                  SystemArgument1,&#10;  [in, optional] __drv_aliasesMem PVOID SystemArgument2&#10;);">KeInsertQueueDpc</a> routines.</p>

<p>Avoid changing the importance or the target processor of a DPC that is associated with an active timer. Either cancel the timer or make sure that the timer has expired before you call a routine such as <a href="kesetimportancedpc" title="VOID KeSetImportanceDpc(&#10;  [in, out] PRKDPC          Dpc,&#10;  [in]      KDPC_IMPORTANCE Importance&#10;);">KeSetImportanceDpc</a> or <a href="kesettargetprocessordpcex" title="NTSTATUS KeSetTargetProcessorDpcEx(&#10;  [in, out] PKDPC             Dpc,&#10;  [in]      PPROCESSOR_NUMBER ProcNumber&#10;);">KeSetTargetProcessorDpcEx</a> to change the DPC settings. For example, if a driver updates the target processor of a DPC while a timer enables the DPC to run, the DPC might run on an arbitrary processor.</p>

<p>A periodic timer automatically restarts as soon as it expires. Therefore, in a multiprocessor system, the DPC for a periodic timer might be running on two or more processors at the same time.</p>

<p>Drivers must cancel any active timers in their <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_unload">Unload</a> routines. Call the <a href="kecanceltimer" title="BOOLEAN KeCancelTimer(&#10;  [in, out] PKTIMER unnamedParam1&#10;);">KeCancelTimer</a> routine to cancel a timer. If a DPC is associated with a timer that is periodic or that might recently have expired, a driver must wait (for example, by calling the <a href="keflushqueueddpcs" title="VOID KeFlushQueuedDpcs();">KeFlushQueuedDpcs</a> routine) to free the DPC and its associated data until all pending DPC executions on all processors finish.</p>

<p><strong>KeSetCoalescableTimer</strong> uses the <em>TolerableDelay</em> parameter to perform timer coalescing. That is, the routine adjusts the expiration times for the timer to coincide with the expiration times of other software timers. Timer coalescing helps increase the length of idle periods so that the operating system can reduce power consumption and improve energy efficiency.</p>

<p>To use timer coalescing effectively, a caller should specify a <em>TolerableDelay</em> value of at least 32 milliseconds. This value equals two default system clock intervals of 15.6 milliseconds. If you can, use a larger <em>TolerableDelay</em> value, such as 100 milliseconds.</p>

<p>Try to specify the <em>Period</em> and <em>TolerableDelay</em> values in multiples of 50 milliseconds. Typical <em>Period</em> values are 50, 100, 250, 500, and 1000 milliseconds. Typical <em>TolerableDelay</em> values are 50, 100, 150, and 250 milliseconds.</p>

<p>Typically, a timer with a large <em>Period</em> value can use a proportionally large <em>TolerableDelay</em> value. For example, a timer with <em>Period</em> = 500 milliseconds might use <em>TolerableDelay</em> = 50 milliseconds, but a timer with <em>Period</em> = 10 seconds might use <em>TolerableDelay</em> = 1 second.</p>

<p>Expiration times are measured relative to the system clock, and the accuracy with which the operating system can detect when a timer expires is limited by the granularity of the system clock. For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/timer-accuracy">Timer Accuracy</a>.</p>

<p>For more information about timer objects, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/timer-objects-and-dpcs">Timer Objects and DPCs</a>. For more information about timer coalescing, see the <a rel="noopener" target="_blank" href="https://download.microsoft.com/download/9/C/5/9C5B2167-8017-4BAE-9FDE-D599BAC8184A/TimerCoal.docx">Windows Timer Coalescing</a> white paper on the WHDC website.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/eprocess">KDPC</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/eprocess">KTIMER</a></p>

<p><a href="kecanceltimer" title="BOOLEAN KeCancelTimer(&#10;  [in, out] PKTIMER unnamedParam1&#10;);">KeCancelTimer</a></p>

<p><a href="keflushqueueddpcs" title="VOID KeFlushQueuedDpcs();">KeFlushQueuedDpcs</a></p>

<p><a href="keinitializedpc" title="VOID KeInitializeDpc(&#10;  [out]          __drv_aliasesMem PRKDPC Dpc,&#10;  [in]           PKDEFERRED_ROUTINE      DeferredRoutine,&#10;  [in, optional] __drv_aliasesMem PVOID  DeferredContext&#10;);">KeInitializeDpc</a></p>

<p><a href="keinitializetimer" title="VOID KeInitializeTimer(&#10;  [out] PKTIMER Timer&#10;);">KeInitializeTimer</a></p>

<p><a href="keinitializetimerex" title="VOID KeInitializeTimerEx(&#10;  [out] PKTIMER    Timer,&#10;  [in]  TIMER_TYPE Type&#10;);">KeInitializeTimerEx</a></p>

<p><a href="keinsertqueuedpc" title="BOOLEAN KeInsertQueueDpc(&#10;  [in, out]      PRKDPC                 Dpc,&#10;  [in, optional] PVOID                  SystemArgument1,&#10;  [in, optional] __drv_aliasesMem PVOID SystemArgument2&#10;);">KeInsertQueueDpc</a></p>

<p><a href="kesetimportancedpc" title="VOID KeSetImportanceDpc(&#10;  [in, out] PRKDPC          Dpc,&#10;  [in]      KDPC_IMPORTANCE Importance&#10;);">KeSetImportanceDpc</a></p>

<p><a href="kesettargetprocessordpcex" title="NTSTATUS KeSetTargetProcessorDpcEx(&#10;  [in, out] PKDPC             Dpc,&#10;  [in]      PPROCESSOR_NUMBER ProcNumber&#10;);">KeSetTargetProcessorDpcEx</a></p>

<p><a href="kesettimerex" title="BOOLEAN KeSetTimerEx(&#10;  [in, out]      PKTIMER       Timer,&#10;  [in]           LARGE_INTEGER DueTime,&#10;  [in]           LONG          Period,&#10;  [in, optional] PKDPC         Dpc&#10;);">KeSetTimerEx</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-driver_unload">Unload</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kesetcoalescabletimer">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/nf-wdm-kesetcoalescabletimer.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
