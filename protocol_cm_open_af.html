<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="PROTOCOL_CM_OPEN_AF - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>PROTOCOL_CM_OPEN_AF - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            PROTOCOL_CM_OPEN_AF - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ndis.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">PROTOCOL_CM_OPEN_AF ProtocolCmOpenAf;

NDIS_STATUS ProtocolCmOpenAf(
  [in]  NDIS_HANDLE CallMgrBindingContext,
  [in]  PCO_ADDRESS_FAMILY AddressFamily,
  [in]  NDIS_HANDLE NdisAfHandle,
  [out] PNDIS_HANDLE CallMgrAfContext
)
{...}</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-protocol_cm_open_af">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/protocol_cm_open_af.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nc-ndis-protocol_cm_open_af)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1>PROTOCOL_CM_OPEN_AF callback function</h1>
<h2>Description</h2>
<p>The
<em>ProtocolCmOpenAf</em> function is required. This function allocates per-open resources for a call manager
to interact with a connection-oriented NDIS client that is opening the address family.</p>
<p><strong>Note</strong> You must declare the function by using the <strong>PROTOCOL_CM_OPEN_AF</strong> type.
For more information, see the following Examples section.</p>
<h2>Parameters</h2>
<h3><code>CallMgrBindingContext</code> [in]</h3>
<p>For a non-integrated call manager, <em>CallMgrBindingContext</em> specifies the handle to a call manager-allocated context area in which the call managers maintains
its per-binding state information. The call manager supplied this handle when it called
<a href="ndisopenadapterex" title="NDIS_STATUS NdisOpenAdapterEx(&#10;  [in]  NDIS_HANDLE           NdisProtocolHandle,&#10;  [in]  NDIS_HANDLE           ProtocolBindingContext,&#10;  [in]  PNDIS_OPEN_PARAMETERS OpenParameters,&#10;  [in]  NDIS_HANDLE           BindContext,&#10;  [out] PNDIS_HANDLE          NdisBindingHandle&#10;);">NdisOpenAdapterEx</a>.</p>
<p>For an integrated call manager (MCM), <em>CallMgrBindingContext</em> specifies the handle to a miniport-allocated context area in which the miniport maintains its per-adapter state information. The miniport supplied this handle in its <a href="ndismsetattributesex" title="VOID NdisMSetAttributesEx(&#10;  [in]           NDIS_HANDLE         MiniportAdapterHandle,&#10;  [in]           NDIS_HANDLE         MiniportAdapterContext,&#10;  [in, optional] UINT                CheckForHangTimeInSeconds,&#10;  [in]           ULONG               AttributeFlags,&#10;  [in, optional] NDIS_INTERFACE_TYPE AdapterType&#10;);">NdisMSetAttributesEx</a> call (for 5.x drivers) or its <a href="ndismsetminiportattributes" title="NDIS_STATUS NdisMSetMiniportAttributes(&#10;       NDIS_HANDLE                       NdisMiniportHandle,&#10;  [in] PNDIS_MINIPORT_ADAPTER_ATTRIBUTES MiniportAttributes&#10;);">NdisMSetMiniportAttributes</a> call (for 6.x drivers).</p>
<h3><code>AddressFamily</code> [in]</h3>
<p>Specifies the address family that a client is opening. This address family was registered by the
call manager when it called
<a href="ndiscmregisteraddressfamilyex" title="NDIS_STATUS NdisCmRegisterAddressFamilyEx(&#10;  [in] NDIS_HANDLE        NdisBindingHandle,&#10;  [in] PCO_ADDRESS_FAMILY AddressFamily&#10;);">NdisCmRegisterAddressFamilyEx</a>.</p>
<h3><code>NdisAfHandle</code> [in]</h3>
<p>Specifies a handle, supplied by NDIS, that uniquely identifies this address family instance. This
handle is opaque to the call manager and reserved for system use.</p>
<h3><code>CallMgrAfContext</code> [out]</h3>
<p>Specifies the handle to a call manager-supplied context area in which the call manager maintains
state about this open of an address family it provides.</p>
<h2>Return value</h2>
<p><em>ProtocolCmOpenAf</em> returns the status of its operation(s) as one of the following:</p>
<table>
<thead>
<tr>
<th>Return code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>NDIS_STATUS_SUCCESS</strong></td>
<td>Indicates that the call manager has successfully allocated and initialized any resources necessary to accept requests from the client to this address family.</td>
</tr>
<tr>
<td><strong>NDIS_STATUS_PENDING</strong></td>
<td>Indicates that the requested operation is being handled asynchronously. The call manager must call <a href="ndiscmopenaddressfamilycomplete" title="VOID NdisCmOpenAddressFamilyComplete(&#10;  [in] NDIS_STATUS Status,&#10;  [in] NDIS_HANDLE NdisAfHandle,&#10;  [in] NDIS_HANDLE CallMgrAfContext&#10;);">NdisCmOpenAddressFamilyComplete</a> when it has completed all its open-AF operations to indicate to NDIS (and the client) that the operation(s) has been completed.</td>
</tr>
<tr>
<td><strong>NDIS_STATUS_RESOURCES</strong></td>
<td>Indicates that the call manager could not complete its necessary operation(s) because of a lack of available system resources, such as memory.</td>
</tr>
<tr>
<td><strong>NDIS_STATUS_<em>XXX</em></strong></td>
<td>Indicates that the call manager could not set itself into a state where it can accept requests from the client to operate on this address family. This could be an error status propagated from another NDIS library function or any error status determined appropriate by the driver writer.</td>
</tr>
</tbody>
</table>
<h2>Remarks</h2>
<p><em>ProtocolCmOpenAf</em> performs any required allocations of dynamic resources and structures that the
call manager writer deems necessary to perform operations on behalf of the client that is opening an
instance of this address family. Such resources include, but are not limited to, memory buffers, data
structures, events, and other such similar resources. A call manager should also initialize any relevant
per-open data before returning control to NDIS.</p>
<p>When a call manager has allocated its per-open state area, the address of the state area should be set
in the
<em>CallMgrAfContext</em> handle before returning control to NDIS. To do this, dereference
<em>CallMgrAfContext</em> and store a pointer to the data area as the value of the handle. For example:</p>
<pre><code>*CallMgrAfContext = SomeBuffer;
</code></pre>
<p>If
<em>ProtocolCmOpenAf</em> cannot allocate the per-open resources it needs to carry out subsequent requests
on behalf of the client opening this address family, it should free all resources that it allocated for
the open and return control to the NDIS with NDIS_STATUS_RESOURCES.</p>
<p>If
<em>ProtocolCmOpenAf</em> has completed its required operations and the CM is ready to accept requests from
the client,
<em>ProtocolCmOpenAf</em> should return control as quickly as possible with a status of
NDIS_STATUS_SUCCESS.</p>
<h3>Examples</h3>
<p>To define a <em>ProtocolCmOpenAf</em> function, you must first provide a function declaration that identifies the type of function you're defining. Windows provides a set of function types for drivers. Declaring a function using the function types helps <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/code-analysis-for-drivers">Code Analysis for Drivers</a>, <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/static-driver-verifier">Static Driver Verifier</a> (SDV), and other verification tools find errors, and it's a requirement for writing drivers for the Windows operating system.</p>
<p>For example, to define a <em>ProtocolCmOpenAf</em> function that is named "MyCmOpenAf", use the <strong>PROTOCOL_CM_OPEN_AF</strong> type as shown in this code example:</p>
<pre><code>PROTOCOL_CM_OPEN_AF MyCmOpenAf;
</code></pre>
<p>Then, implement your function as follows:</p>
<pre><code>_Use_decl_annotations_
NDIS_STATUS
MyCmOpenAf(
NDIS_HANDLE  CallMgrBindingContext,
PCO_ADDRESS_FAMILY  AddressFamily,
NDIS_HANDLE  NdisAfHandle,
PNDIS_HANDLE  CallMgrAfContext
)
{...}
</code></pre>
<p>The <strong>PROTOCOL_CM_OPEN_AF</strong> function type is defined in the Ndis.h header file. To more accurately identify errors when you run the code analysis tools, be sure to add the _Use_decl_annotations_ annotation to your function definition. The _Use_decl_annotations_ annotation ensures that the annotations that are applied to the <strong>PROTOCOL_CM_OPEN_AF</strong> function type in the header file are used. For more information about the requirements for function declarations, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/declaring-functions-by-using-function-role-types-for-ndis-drivers">Declaring Functions by Using Function Role Types for NDIS Drivers</a>.</p>
<p>For information about _Use_decl_annotations_, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/visualstudio/code-quality/annotating-function-behavior">Annotating Function Behavior</a>.</p>
<h2>See also</h2>
<p><a href="ndisclopenaddressfamilyex" title="NDIS_STATUS NdisClOpenAddressFamilyEx(&#10;  [in]  NDIS_HANDLE        NdisBindingHandle,&#10;  [in]  PCO_ADDRESS_FAMILY AddressFamily,&#10;  [in]  NDIS_HANDLE        ClientAfContext,&#10;  [out] PNDIS_HANDLE       NdisAfHandle&#10;);">NdisClOpenAddressFamilyEx</a></p>
<p><a href="ndiscmopenaddressfamilycomplete" title="VOID NdisCmOpenAddressFamilyComplete(&#10;  [in] NDIS_STATUS Status,&#10;  [in] NDIS_HANDLE NdisAfHandle,&#10;  [in] NDIS_HANDLE CallMgrAfContext&#10;);">NdisCmOpenAddressFamilyComplete</a></p>
<p><a href="ndiscmregisteraddressfamilyex" title="NDIS_STATUS NdisCmRegisterAddressFamilyEx(&#10;  [in] NDIS_HANDLE        NdisBindingHandle,&#10;  [in] PCO_ADDRESS_FAMILY AddressFamily&#10;);">NdisCmRegisterAddressFamilyEx</a></p>
<p><a href="ndisopenadapterex" title="NDIS_STATUS NdisOpenAdapterEx(&#10;  [in]  NDIS_HANDLE           NdisProtocolHandle,&#10;  [in]  NDIS_HANDLE           ProtocolBindingContext,&#10;  [in]  PNDIS_OPEN_PARAMETERS OpenParameters,&#10;  [in]  NDIS_HANDLE           BindContext,&#10;  [out] PNDIS_HANDLE          NdisBindingHandle&#10;);">NdisOpenAdapterEx</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-protocol_cm_open_af">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ndis/nc-ndis-protocol_cm_open_af.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
