<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="IOCTL_GNSS_CREATE_GEOFENCE - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>IOCTL_GNSS_CREATE_GEOFENCE - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            IOCTL_GNSS_CREATE_GEOFENCE - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// gnssdriver.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x0022, 0x050, METHOD_BUFFERED, FILE_ANY_ACCESS)
#define IOCTL_GNSS_CREATE_GEOFENCE 0x00220140</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/gnssdriver/ni-gnssdriver-ioctl_gnss_create_geofence">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ioctl_gnss_create_geofence.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ni-gnssdriver-ioctl_gnss_create_geofence)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2 id="description">Description</h2>

<p>The <strong>IOCTL_GNSS_CREATE_GEOFENCE</strong> control code is used by the GNSS adapter to create a geofence.</p>

<p>Applies to GNSS DDI version 2 and later.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="major-code">Major code</h3>

<h3 id="input-buffer">Input buffer</h3>

<p>A pointer to a <a href="gnss_geofence_create_param" title="typedef struct {&#10;  ULONG               Size;&#10;  ULONG               Version;&#10;  ULONG               AlertTypes;&#10;  GNSS_GEOFENCE_STATE InitialState;&#10;  GNSS_GEOREGION      Boundary;&#10;  BYTE                Unused[512];&#10;} GNSS_GEOFENCE_CREATE_PARAM, *PGNSS_GEOFENCE_CREATE_PARAM;">GNSS_GEOFENCE_CREATE_PARAM</a> structure that defines the geofence to be created.</p>

<h3 id="input-buffer-length">Input buffer length</h3>

<p>Set to sizeof(<strong><a href="gnss_geofence_create_param" title="typedef struct {&#10;  ULONG               Size;&#10;  ULONG               Version;&#10;  ULONG               AlertTypes;&#10;  GNSS_GEOFENCE_STATE InitialState;&#10;  GNSS_GEOREGION      Boundary;&#10;  BYTE                Unused[512];&#10;} GNSS_GEOFENCE_CREATE_PARAM, *PGNSS_GEOFENCE_CREATE_PARAM;">GNSS_GEOFENCE_CREATE_PARAM</a></strong>).</p>

<h3 id="output-buffer">Output buffer</h3>

<p>A pointer to a <a href="gnss_geofence_create_response" title="typedef struct {&#10;  ULONG    Size;&#10;  ULONG    Version;&#10;  NTSTATUS CreationStatus;&#10;  ULONG    GeofenceID;&#10;  BYTE     Unused[512];&#10;} GNSS_GEOFENCE_CREATE_RESPONSE, *PGNSS_GEOFENCE_CREATE_RESPONSE;">GNSS_GEOFENCE_CREATE_RESPONSE</a> structure.</p>

<h3 id="output-buffer-length">Output buffer length</h3>

<p>Set to sizeof(<strong><a href="gnss_geofence_create_response" title="typedef struct {&#10;  ULONG    Size;&#10;  ULONG    Version;&#10;  NTSTATUS CreationStatus;&#10;  ULONG    GeofenceID;&#10;  BYTE     Unused[512];&#10;} GNSS_GEOFENCE_CREATE_RESPONSE, *PGNSS_GEOFENCE_CREATE_RESPONSE;">GNSS_GEOFENCE_CREATE_RESPONSE</a></strong>).</p>

<h3 id="inputoutput-buffer">Input/output buffer</h3>

<h3 id="inputoutput-buffer-length">Input/output buffer length</h3>

<h3 id="status-block">Status block</h3>

<p><strong>Irp->IoStatus.Status</strong> is set to <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the request is successful. Otherwise, <strong>Status</strong> to the appropriate error condition as a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/using-ntstatus-values">NTSTATUS</a> code.</p>

<h2 id="remarks">Remarks</h2>

<h3 id="gnss-adapter-notes">GNSS adapter notes</h3>

<p>If the call is successful, the GNSS engine registers the geofence and assigns a unique ID. The GNSS adapter uses the unique ID for all interaction with the driver regarding this specific geofence.</p>

<p>If the call fails, the GNSS driver must ensure that the GNSS engine does not end up creating the geofence and start tracking it. A failure should roll the state of the GNSS engine back to the previous state before adding this geofence.</p>

<p>The GNSS adapter does not expect the driver to persist the geofences across driver restarts. The GNSS adapter explicitly clears all geofences from the GNSS driver through the <strong>GNSS_ResetGeofencesTracking</strong> command at appropriate times (initialization, tracking status change after a failure, etc.).</p>

<h3 id="gnss-driver-notes">GNSS driver notes</h3>

<p>If this is the first geofence, the GNSS driver should start geofence tracking, continue monitoring the geofence against the current location of the device in a power efficient manner, and raise alerts if a geofence is breached. If the GNSS engine is unable to track the geofence (due to bad signal conditions or other transient errors), an error status must be raised through the <strong>LISTEN_GEOFENCES_TRACKINGSTATUS</strong> event.</p>

<p>The GNSS engine must adhere to the following guidelines for geofence tracking:</p>

<ul>
<li><p>The device tracking operation and breach detection must be optimized to take into account the size and area of the geofence. If all conditions are the same, larger geofences should be tracked less aggressively compared to smaller geofences.</p></li>
<li><p>The device tracking operation must be dynamically optimized to take into account the relative distance of the geofence with respect to the current position. All conditions being equal, farther geofences should be tracked less aggressively compared to the closer ones and the aggression should increase as the device gets closer to the geofence.</p></li>
<li><p>The breach detection mechanism must be asymmetric for entry and exit. As a general rule, the rules for determining exit from a geofence should be relaxed compared to the rules for determining entry into the geofence.</p></li>
<li><p>The breach detection mechanism must take into account potential false positives arising due to the inherent inaccuracy of device location. For example, if the device is hovering near the edge of a geofence, a sub-optimal breach detection mechanism may generate too many entry and exit events back to back even if the device is not physically moving in and out. Asymmetric exit detection and hysteresis are typical measures to avoid such errors.</p></li>
<li><p>The device tracking operation of the GNSS engine must use all forms of available location changed signals that are either available on the SoC or can be used at low-power. Such signals may include, but not limited to, data from accelerometer and other sensors, cellular signal change, WiFi connect/disconnect, and so on.</p></li>
<li><p>The geofence tracking and breach detection operations must be entirely implemented in the GNSS engine on SoC. Neither the GNSS driver nor any other extension component on the application processor should wake up for device tracking or breach detection.</p></li>
<li><p>The GNSS driver and the GNSS engine must expose documented IHV-specific tuning parameters to facilitate performance and power tuning of the geofence tracking functionality. Microsoft and OEMs will make use of tuning parameters and determine the right balance between the quality of service, reliability, and power cost of the geofence experience end-to-end. Tuning parameters can be made available either through registry settings or through IHV SoC configuration data.</p></li>
</ul>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/creating-ioctl-requests-in-drivers">Creating IOCTL Requests in Drivers</a></p>

<p><a href="wdfiotargetsendinternalioctlotherssynchronously" title="NTSTATUS WdfIoTargetSendInternalIoctlOthersSynchronously(&#10;  [in]            WDFIOTARGET               IoTarget,&#10;  [in, optional]  WDFREQUEST                Request,&#10;  [in]            ULONG                     IoctlCode,&#10;  [in, optional]  PWDF_MEMORY_DESCRIPTOR    OtherArg1,&#10;  [in, optional]  PWDF_MEMORY_DESCRIPTOR    OtherArg2,&#10;  [in, optional]  PWDF_MEMORY_DESCRIPTOR    OtherArg4,&#10;  [in, optional]  PWDF_REQUEST_SEND_OPTIONS RequestOptions,&#10;  [out, optional] PULONG_PTR                BytesReturned&#10;);">WdfIoTargetSendInternalIoctlOthersSynchronously</a></p>

<p><a href="wdfiotargetsendinternalioctlsynchronously" title="NTSTATUS WdfIoTargetSendInternalIoctlSynchronously(&#10;  [in]            WDFIOTARGET               IoTarget,&#10;  [in, optional]  WDFREQUEST                Request,&#10;  [in]            ULONG                     IoctlCode,&#10;  [in, optional]  PWDF_MEMORY_DESCRIPTOR    InputBuffer,&#10;  [in, optional]  PWDF_MEMORY_DESCRIPTOR    OutputBuffer,&#10;  [in, optional]  PWDF_REQUEST_SEND_OPTIONS RequestOptions,&#10;  [out, optional] PULONG_PTR                BytesReturned&#10;);">WdfIoTargetSendInternalIoctlSynchronously</a></p>

<p><a href="wdfiotargetsendioctlsynchronously" title="NTSTATUS WdfIoTargetSendIoctlSynchronously(&#10;  [in]            WDFIOTARGET               IoTarget,&#10;  [in, optional]  WDFREQUEST                Request,&#10;  [in]            ULONG                     IoctlCode,&#10;  [in, optional]  PWDF_MEMORY_DESCRIPTOR    InputBuffer,&#10;  [in, optional]  PWDF_MEMORY_DESCRIPTOR    OutputBuffer,&#10;  [in, optional]  PWDF_REQUEST_SEND_OPTIONS RequestOptions,&#10;  [out, optional] PULONG_PTR                BytesReturned&#10;);">WdfIoTargetSendIoctlSynchronously</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/gnssdriver/ni-gnssdriver-ioctl_gnss_create_geofence">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/gnssdriver/ni-gnssdriver-ioctl_gnss_create_geofence.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
