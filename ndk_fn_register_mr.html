<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="NDK_FN_REGISTER_MR - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>NDK_FN_REGISTER_MR - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            NDK_FN_REGISTER_MR - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ndkpi.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">NDK_FN_REGISTER_MR NdkFnRegisterMr;

<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> NdkFnRegisterMr(
  [in]           <a href="ndk_mr" title="typedef struct _NDK_MR {&#10;  NDK_OBJECT_HEADER     Header;&#10;  const NDK_MR_DISPATCH *Dispatch;&#10;} NDK_MR;">NDK_MR</a> *pNdkMr,
  [in]           <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> *Mdl,
  [in]           <a href="size_t-2" title="typedef ULONG_PTR SIZE_T;">SIZE_T</a> Length,
  [in]           <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> Flags,
  [in]           <a href="ndk_fn_request_completion" title="NDK_FN_REQUEST_COMPLETION NdkFnRequestCompletion;&#10;&#10;VOID NdkFnRequestCompletion(&#10;  [in, optional] PVOID Context,&#10;  [in]           NTSTATUS Status&#10;)&#10;{...}">NDK_FN_REQUEST_COMPLETION</a> RequestCompletion,
  [in, optional] PVOID RequestContext
)
{...}</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndkpi/nc-ndkpi-ndk_fn_register_mr">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ndk_fn_register_mr.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nc-ndkpi-ndk_fn_register_mr)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="ndk_fn_register_mr-callback-function">NDK_FN_REGISTER_MR callback function</h1>

<h2 id="description">Description</h2>

<p>The <em>NdkRegisterMr</em> (<em>NDK_FN_REGISTER_MR</em>) function registers a virtually contiguous memory region with an NDK adapter.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="pndkmr-in"><code>pNdkMr</code> [in]</h3>

<p>A pointer to an NDK memory region (MR) object
(<a href="ndk_mr" title="typedef struct _NDK_MR {&#10;  NDK_OBJECT_HEADER     Header;&#10;  const NDK_MR_DISPATCH *Dispatch;&#10;} NDK_MR;">NDK_MR</a>).</p>

<h3 id="mdl-in"><code>Mdl</code> [in]</h3>

<p>An <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> or chain of MDLs that represent a virtually contiguous memory region from the starting virtual address up to the number of bytes specified in the <em>Length</em> parameter.</p>

<h3 id="length-in"><code>Length</code> [in]</h3>

<p>The number of bytes to register starting from the first <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a>'s virtual address. The first <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a>'s virtual address can be obtained by calling the <a href="mmgetmdlvirtualaddress" title="#define MmGetMdlVirtualAddress(Mdl) \&#10;    ((PVOID) ((PCHAR) ((Mdl)-&gt;StartVa) + (Mdl)-&gt;ByteOffset))">MmGetMdlVirtualAddress</a> macro. The length must not exceed the total number of bytes represented by the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> chain.</p>

<h3 id="flags-in"><code>Flags</code> [in]</h3>

<p>A bitmask of flags that specify the access permissions for the registered memory region. The following flags can be set:</p>

<table>
<thead>
<tr>
  <th>Value</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>NDK_MR_FLAG_ALLOW_LOCAL_READ</strong>&lt;br&gt;&lt;br&gt;0x00000000</td>
  <td></td>
</tr>
<tr>
  <td><strong>NDK_MR_FLAG_ALLOW_LOCAL_WRITE</strong>&lt;br&gt;&lt;br&gt;0x00000001</td>
  <td></td>
</tr>
<tr>
  <td><strong>NDK_MR_FLAG_ALLOW_REMOTE_READ</strong>&lt;br&gt;&lt;br&gt;0x00000002</td>
  <td></td>
</tr>
<tr>
  <td><strong>NDK_MR_FLAG_ALLOW_REMOTE_WRITE</strong>&lt;br&gt;&lt;br&gt;0x00000005</td>
  <td></td>
</tr>
<tr>
  <td><strong>NDK_MR_FLAG_RDMA_READ_SINK</strong>&lt;br&gt;&lt;br&gt;0x00000008</td>
  <td></td>
</tr>
</tbody>
</table>

<h3 id="requestcompletion-in"><code>RequestCompletion</code> [in]</h3>

<p>A pointer to a request completion callback routine <em>NdkRequestCompletion</em> (<a href="ndk_fn_request_completion" title="NDK_FN_REQUEST_COMPLETION NdkFnRequestCompletion;&#10;&#10;VOID NdkFnRequestCompletion(&#10;  [in, optional] PVOID Context,&#10;  [in]           NTSTATUS Status&#10;)&#10;{...}">NDK_FN_REQUEST_COMPLETION</a>).</p>

<h3 id="requestcontext-in-optional"><code>RequestContext</code> [in, optional]</h3>

<p>A context value to pass to the <em>Context</em> parameter of the callback function that is specified in the <em>RequestCompletion</em> parameter.</p>

<h2 id="return-value">Return value</h2>

<p>The
<em>NdkRegisterMr</em> function returns one of the following <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> codes.</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></strong></td>
  <td>The MR registration was completed successfully.</td>
</tr>
<tr>
  <td><strong>STATUS_PENDING</strong></td>
  <td>The operation is pending and will be completed later. The driver will call the specified <em>RequestCompletion</em> (<a href="ndk_fn_request_completion" title="NDK_FN_REQUEST_COMPLETION NdkFnRequestCompletion;&#10;&#10;VOID NdkFnRequestCompletion(&#10;  [in, optional] PVOID Context,&#10;  [in]           NTSTATUS Status&#10;)&#10;{...}">NDK_FN_REQUEST_COMPLETION</a>) function to complete the pending operation.</td>
</tr>
<tr>
  <td><strong>STATUS_INVALID_PARAMETER</strong></td>
  <td>The part of the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> chain from the starting virtual address up to the length in bytes does not represent a virtually contiguous memory region.</td>
</tr>
<tr>
  <td><strong>STATUS_INSUFFICIENT_RESOURCES</strong></td>
  <td>The request failed due to insufficient resources. &lt;br&gt;&lt;br&gt;<strong>Important</strong> The request can fail inline as well as asynchronously with this status code.</td>
</tr>
<tr>
  <td><strong>Other status codes</strong></td>
  <td>An error occurred.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>On an <a href="ndk_mr" title="typedef struct _NDK_MR {&#10;  NDK_OBJECT_HEADER     Header;&#10;  const NDK_MR_DISPATCH *Dispatch;&#10;} NDK_MR;">NDK_MR</a> object that was created with the <em>FastRegister</em> parameter set to FALSE, <em>NdkRegisterMr</em> is used to register a virtually contiguous memory region with the adapter.</p>

<p>The NDK consumer must pass an <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> or chain of MDLs that represent virtually contiguous memory region that is pinned in physical memory. The base virtual address for the memory region being registered is the virtual address indicated by the <a href="mmgetmdlvirtualaddress" title="#define MmGetMdlVirtualAddress(Mdl) \&#10;    ((PVOID) ((PCHAR) ((Mdl)-&gt;StartVa) + (Mdl)-&gt;ByteOffset))">MmGetMdlVirtualAddress</a> macro. If the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> chain does not represent a virtually contiguous memory region from the starting virtual address up to the specified length in bytes, the NDK provider must fail the request.</p>

<p>The provider must treat the virtual address that <a href="mmgetmdlvirtualaddress" title="#define MmGetMdlVirtualAddress(Mdl) \&#10;    ((PVOID) ((PCHAR) ((Mdl)-&gt;StartVa) + (Mdl)-&gt;ByteOffset))">MmGetMdlVirtualAddress</a> returns as an index to the start of the memory region being registered. The provider must not use the virtual address as a valid virtual address for reading or writing buffer contents.</p>

<p>The NDK consumer must not use the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> chain while the registration request is pending.</p>

<p><em>NdkRegisterMr</em> does not support zero-based virtual addresses.</p>

<p>An NDK consumer must pass the <strong>NDK_MR_FLAG_RDMA_READ_SINK</strong> flag when it registers memory that might be used as the sink buffer for an RDMA read request. Certain NDK providers might require enabling special access rights on the sink buffer for an RDMA read request on adapters for which the <strong>NDK_ADAPTER_FLAG_RDMA_READ_SINK_NOT_REQUIRED</strong> flag is not set in the <strong>AdapterFlags</strong> member of the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ndkinfo/ns-ndkinfo-ndk_adapter_info">NDK_ADAPTER_INFO</a> structure. The <strong>NDK_MR_FLAG_RDMA_READ_SINK</strong> flag allows such providers to support registration requests appropriately.</p>

<p><strong>Note</strong> Buffers can be registered for multiple purposes. Therefore, the <strong>NDK_MR_FLAG_RDMA_READ_SINK</strong> flag might be accompanied by other flags.</p>

<p>If an NDK consumer passes the <strong>NDK_MR_FLAG_RDMA_READ_SINK</strong> flag on an adapter for which the <strong>NDK_ADAPTER_FLAG_RDMA_READ_SINK_NOT_REQUIRED</strong> flag is set in the <strong>AdapterFlags</strong> member of the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ndkinfo/ns-ndkinfo-ndk_adapter_info">NDK_ADAPTER_INFO</a> structure, the provider is not required to handle the <strong>NDK_MR_FLAG_RDMA_READ_SINK</strong> flag and must not fail the request due to the presence of this flag.</p>

<p>To deregister the memory region, use the <em>NdkDeregisterMr</em> (<a href="ndk_fn_deregister_mr" title="NDK_FN_DEREGISTER_MR NdkFnDeregisterMr;&#10;&#10;NTSTATUS NdkFnDeregisterMr(&#10;  [in]           NDK_MR *pNdkMr,&#10;  [in]           NDK_FN_REQUEST_COMPLETION RequestCompletion,&#10;  [in, optional] PVOID RequestContext&#10;)&#10;{...}">NDK_FN_DEREGISTER_MR</a>) function.</p>

<h2 id="see-also">See also</h2>

<p><a href="mmgetmdlvirtualaddress" title="#define MmGetMdlVirtualAddress(Mdl) \&#10;    ((PVOID) ((PCHAR) ((Mdl)-&gt;StartVa) + (Mdl)-&gt;ByteOffset))">MmGetMdlVirtualAddress</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/ndkpi-object-lifetime-requirements">NDKPI Object Lifetime Requirements</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ndkinfo/ns-ndkinfo-ndk_adapter_info">NDK_ADAPTER_INFO</a></p>

<p><a href="ndk_fn_deregister_mr" title="NDK_FN_DEREGISTER_MR NdkFnDeregisterMr;&#10;&#10;NTSTATUS NdkFnDeregisterMr(&#10;  [in]           NDK_MR *pNdkMr,&#10;  [in]           NDK_FN_REQUEST_COMPLETION RequestCompletion,&#10;  [in, optional] PVOID RequestContext&#10;)&#10;{...}">NDK_FN_DEREGISTER_MR</a></p>

<p><a href="ndk_fn_request_completion" title="NDK_FN_REQUEST_COMPLETION NdkFnRequestCompletion;&#10;&#10;VOID NdkFnRequestCompletion(&#10;  [in, optional] PVOID Context,&#10;  [in]           NTSTATUS Status&#10;)&#10;{...}">NDK_FN_REQUEST_COMPLETION</a></p>

<p><a href="ndk_mr" title="typedef struct _NDK_MR {&#10;  NDK_OBJECT_HEADER     Header;&#10;  const NDK_MR_DISPATCH *Dispatch;&#10;} NDK_MR;">NDK_MR</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndkpi/nc-ndkpi-ndk_fn_register_mr">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ndkpi/nc-ndkpi-ndk_fn_register_mr.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
