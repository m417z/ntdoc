<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="NdisAllocateSpinLock - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>NdisAllocateSpinLock - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            NdisAllocateSpinLock - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ndis.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">VOID NdisAllocateSpinLock(
  [out] PNDIS_SPIN_LOCK SpinLock
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nf-ndis-ndisallocatespinlock">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ndisallocatespinlock.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ndis-ndisallocatespinlock)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="ndisallocatespinlock-function">NdisAllocateSpinLock function</h1>

<h2 id="description">Description</h2>

<p>The
<strong>NdisAllocateSpinLock</strong> function initializes a variable of type NDIS_SPIN_LOCK, used to synchronize
access to resources shared among non-ISR driver functions.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="spinlock-out"><code>SpinLock</code> [out]</h3>

<p>Pointer to an opaque variable that represents a spin lock.</p>

<h2 id="remarks">Remarks</h2>

<p>Before a driver calls
<a href="ndisacquirespinlock" title="void NdisAcquireSpinLock(&#10;  [in] _SpinLock&#10;);">NdisAcquireSpinLock</a>,
<a href="ndisdpracquirespinlock" title="void NdisDprAcquireSpinLock(&#10;  [in] _SpinLock&#10;);">NdisDprAcquireSpinLock</a>, or any of
the
<strong>NdisInterlocked*Xxx<em></strong> functions, it must call
<strong>NdisAllocateSpinLock</strong> to initialize the spin lock passed as a required parameter to these
<strong>Ndis*Xxx</em></strong> functions. The caller must provide nonpaged storage for the variable at
<em>SpinLock</em> .</p>

<p>After calling
<strong>NdisAllocateSpinLock</strong>, the driver can call
<strong><a href="ndisacquirespinlock" title="void NdisAcquireSpinLock(&#10;  [in] _SpinLock&#10;);">NdisAcquireSpinLock</a></strong> to obtain exclusive use of the resource(s) the spin lock protects. When
resource access is complete, the driver calls
<a href="ndisreleasespinlock" title="void NdisReleaseSpinLock(&#10;  [in] _SpinLock&#10;);">NdisReleaseSpinLock</a> so that other
driver functions can access the resource(s) protected by that spin lock.</p>

<p>As a general rule, to improve performance a driver should use different locks to protect different
critical sections. Thus, a driver might initialize more than one spin lock with
<strong>NdisAllocateSpinLock</strong>.</p>

<p>Each spin lock that a driver allocates protects a discrete set of shared resources from simultaneous
access by driver functions that run at IRQL &lt;= DISPATCH_LEVEL. For example, a driver that maintains an
internal queue of packets might initialize one spin lock to protect its queue and another to protect a
set of state variables that several driver functions, not including the
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_isr">MiniportInterrupt</a> or
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_disable_interrupt">MiniportDisableInterruptEx</a> function, access while the driver is processing packets.</p>

<p><strong><a href="ndisacquirespinlock" title="void NdisAcquireSpinLock(&#10;  [in] _SpinLock&#10;);">NdisAcquireSpinLock</a></strong> raises the IRQL to DISPATCH_LEVEL and stores the old IRQL in the spin lock.
Releasing the spin lock sets the IRQL to the value stored in the spin lock. Because NDIS sometimes enters
drivers at PASSIVE_LEVEL, problems can arise with the following code:</p>

<pre><code><a href="ndisacquirespinlock" title="void NdisAcquireSpinLock(&#10;  [in] _SpinLock&#10;);">NdisAcquireSpinLock</a>(A);
<a href="ndisacquirespinlock" title="void NdisAcquireSpinLock(&#10;  [in] _SpinLock&#10;);">NdisAcquireSpinLock</a>(B);
<a href="ndisreleasespinlock" title="void NdisReleaseSpinLock(&#10;  [in] _SpinLock&#10;);">NdisReleaseSpinLock</a>(A);
<a href="ndisreleasespinlock" title="void NdisReleaseSpinLock(&#10;  [in] _SpinLock&#10;);">NdisReleaseSpinLock</a>(B);
</code></pre>

<p>A driver should not access spin locks in this sequence for the following reasons:</p>

<ul>
<li>Between
<strong><a href="ndisreleasespinlock" title="void NdisReleaseSpinLock(&#10;  [in] _SpinLock&#10;);">NdisReleaseSpinLock</a></strong>(A) and
<strong><a href="ndisreleasespinlock" title="void NdisReleaseSpinLock(&#10;  [in] _SpinLock&#10;);">NdisReleaseSpinLock</a></strong>(B) the code is running at PASSIVE_LEVEL instead of DISPATCH_LEVEL and is
subject to inappropriate interruption.</li>
<li>After
<strong><a href="ndisreleasespinlock" title="void NdisReleaseSpinLock(&#10;  [in] _SpinLock&#10;);">NdisReleaseSpinLock</a></strong>(B) the code is running at DISPATCH_LEVEL which could cause the caller to
fault at much later time with an IRQL_NOT_LESS_OR_EQUAL stop error.</li>
</ul>

<p>A driver should
never use two spin locks to protect the same (sub)set of resources because nested spin lock
acquisitions so frequently cause deadlocks. Even if a driver could be designed to prevent deadlocks,
nested spin lock acquisitions have an adverse effect on driver performance and I/O throughput.</p>

<p>A miniport driver cannot use a spin lock to protect resources that its non-ISR functions share with
its
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_isr">MiniportInterrupt</a> or
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_disable_interrupt">MiniportDisableInterruptEx</a> function. To access resources shared with a
<em>MiniportInterrupt</em> or
<em>MiniportDisableInterruptEx</em> function, a miniport driver must call
<a href="ndismsynchronizewithinterruptex" title="BOOLEAN NdisMSynchronizeWithInterruptEx(&#10;  [in] NDIS_HANDLE                            NdisInterruptHandle,&#10;  [in] ULONG                                  MessageId,&#10;  [in] MINIPORT_SYNCHRONIZE_INTERRUPT_HANDLER SynchronizeFunction,&#10;  [in] PVOID                                  SynchronizeFunction,&#10;  [in] PVOID                                  SynchronizeContext&#10;);">NdisMSynchronizeWithInterruptEx</a> to have its
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_synchronize_interrupt">MiniportSynchronizeInterrupt</a> function access those resources at DIRQL.</p>

<p>When a driver no longer requires resource protection, for example, when a NIC is being removed and the
driver is releasing the resources it allocated for that NIC, the driver calls
<a href="ndisfreespinlock" title="VOID NdisFreeSpinLock(&#10;  [in] PNDIS_SPIN_LOCK SpinLock&#10;);">NdisFreeSpinLock</a>.</p>

<p>Freeing a spin lock and releasing a spin lock are potentially confusing.
<strong><a href="ndisfreespinlock" title="VOID NdisFreeSpinLock(&#10;  [in] PNDIS_SPIN_LOCK SpinLock&#10;);">NdisFreeSpinLock</a></strong> clears the memory at
<em>SpinLock</em> so it no longer represents a spin lock. Releasing an acquired spin lock with
<a href="ndisreleasespinlock" title="void NdisReleaseSpinLock(&#10;  [in] _SpinLock&#10;);">NdisReleaseSpinLock</a> simply allows
another thread of execution to acquire that spin lock.</p>

<p>For more information about acquiring and releasing NDIS spin locks, see
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/synchronization-and-notification-in-network-drivers">Synchronization
and Notification in Network Drivers</a>.</p>

<p>Callers of
<strong>NdisAllocateSpinLock</strong> can run at any IRQL. Usually a caller is running at IRQL = PASSIVE_LEVEL
during initialization.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/windows/embedded/gg156036(v=winembedded.80)">DriverEntry of NDIS Protocol
Drivers</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_disable_interrupt">MiniportDisableInterruptEx</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_halt">MiniportHaltEx</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_initialize">MiniportInitializeEx</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_isr">MiniportInterrupt</a></p>

<p><a href="ndisacquirespinlock" title="void NdisAcquireSpinLock(&#10;  [in] _SpinLock&#10;);">NdisAcquireSpinLock</a></p>

<p><a href="ndisdpracquirespinlock" title="void NdisDprAcquireSpinLock(&#10;  [in] _SpinLock&#10;);">NdisDprAcquireSpinLock</a></p>

<p><a href="ndisdprreleasespinlock" title="void NdisDprReleaseSpinLock(&#10;  [in] _SpinLock&#10;);">NdisDprReleaseSpinLock</a></p>

<p><a href="ndisfreespinlock" title="VOID NdisFreeSpinLock(&#10;  [in] PNDIS_SPIN_LOCK SpinLock&#10;);">NdisFreeSpinLock</a></p>

<p><a href="ndisinterlockedaddulong" title="void NdisInterlockedAddUlong(&#10;  [in] _Addend,&#10;  [in] _Increment,&#10;  [in] _SpinLock&#10;);">NdisInterlockedAddUlong</a></p>

<p><a href="ndisinterlockedinsertheadlist" title="void NdisInterlockedInsertHeadList(&#10;  [in] _ListHead,&#10;  [in] _ListEntry,&#10;  [in] _SpinLock&#10;);">NdisInterlockedInsertHeadList</a></p>

<p><a href="ndisinterlockedinserttaillist" title="void NdisInterlockedInsertTailList(&#10;  [in] _ListHead,&#10;  [in] _ListEntry,&#10;  [in] _SpinLock&#10;);">NdisInterlockedInsertTailList</a></p>

<p><a href="ndisinterlockedremoveheadlist" title="PLIST_ENTRY NdisInterlockedRemoveHeadList(&#10;  [in]  _ListHead,&#10;  [in]  _SpinLock&#10;);">NdisInterlockedRemoveHeadList</a></p>

<p><a href="ndismsynchronizewithinterruptex" title="BOOLEAN NdisMSynchronizeWithInterruptEx(&#10;  [in] NDIS_HANDLE                            NdisInterruptHandle,&#10;  [in] ULONG                                  MessageId,&#10;  [in] MINIPORT_SYNCHRONIZE_INTERRUPT_HANDLER SynchronizeFunction,&#10;  [in] PVOID                                  SynchronizeFunction,&#10;  [in] PVOID                                  SynchronizeContext&#10;);">NdisMSynchronizeWithInterruptEx</a></p>

<p><a href="ndisreleasespinlock" title="void NdisReleaseSpinLock(&#10;  [in] _SpinLock&#10;);">NdisReleaseSpinLock</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-ndis_timer_function">NetTimerCallback</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nf-ndis-ndisallocatespinlock">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ndis/nf-ndis-ndisallocatespinlock.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
