<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="NdisMEnableVirtualization - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>NdisMEnableVirtualization - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            NdisMEnableVirtualization - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ndis.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">NDIS_STATUS NdisMEnableVirtualization(
  [in] NDIS_HANDLE NdisMiniportHandle,
  [in] <a href="ushort" title="typedef unsigned short USHORT;">USHORT</a>      NumVFs,
  [in] BOOLEAN     EnableVFMigration,
  [in] BOOLEAN     EnableMigrationInterrupt,
  [in] BOOLEAN     EnableVirtualization
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nf-ndis-ndismenablevirtualization">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ndismenablevirtualization.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ndis-ndismenablevirtualization)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1>NdisMEnableVirtualization function</h1>
<h2>Description</h2>
<p>A miniport driver calls the <strong>NdisMEnableVirtualization</strong> function during the creation or deletion of a NIC switch on the network adapter. By calling this function, the driver configures the single root I/O virtualization (SR-IOV) Extended Capability structure in the PCI Express (PCIe) configuration space for the network adapter's Physical Function (PF).</p>
<p><strong>Note</strong> <strong>NdisMEnableVirtualization</strong> must only be called by the miniport driver for the network adapter's PF.</p>
<h2>Parameters</h2>
<h3><code>NdisMiniportHandle</code> [in]</h3>
<p>The network adapter handle that NDIS passed to the
<em>MiniportAdapterHandle</em> parameter of
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_initialize">MiniportInitializeEx</a>.</p>
<h3><code>NumVFs</code> [in]</h3>
<p>A <a href="ushort" title="typedef unsigned short USHORT;">USHORT</a> value that contains the number of Virtual Functions (VFs) that are to be enabled for the network adapter. <strong>NdisMEnableVirtualization</strong> sets the <strong>NumVFs</strong> member of the SR-IOV Extended Capability structure to the value of the <em>NumVFs</em> parameter.</p>
<p><strong>Note</strong> If the <em>EnableVirtualization</em> parameter is FALSE, <em>NumVFs</em> must be set to zero.</p>
<h3><code>EnableVFMigration</code> [in]</h3>
<p>This parameter is reserved for NDIS and must be set to FALSE.</p>
<h3><code>EnableMigrationInterrupt</code> [in]</h3>
<p>This parameter is reserved for NDIS and must be set to FALSE.</p>
<h3><code>EnableVirtualization</code> [in]</h3>
<p>A BOOLEAN value that specifies whether virtualization should be enabled in the PCI configuration space of the network adapter. If <em>EnableVirtualization</em> is TRUE, <strong>NdisMEnableVirtualization</strong> sets the <strong>VF Enable</strong> bit of the SR-IOV Control member. <strong>NdisMEnableVirtualization</strong> clears this bit if <em>EnableVirtualization</em> is FALSE.</p>
<h2>Return value</h2>
<p><strong>NdisMEnableVirtualization</strong> can return one of the following status values.</p>
<table>
<thead>
<tr>
<th>Return code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>NDIS_STATUS_SUCCESS</strong></td>
<td>The virtualization operation completed successfully.</td>
</tr>
<tr>
<td><strong>NDIS_STATUS_NOT_SUPPORTED</strong></td>
<td>The adapter or system does not support SR-IOV.</td>
</tr>
<tr>
<td><strong>NDIS_STATUS_INVALID_PARAMETER</strong></td>
<td>The <em>EnableVirtualization</em> parameter is set to FALSE and the <em>NumVFs</em> parameter is set to a nonzero value.</td>
</tr>
<tr>
<td><strong>NDIS_STATUS_FAILURE</strong></td>
<td>The virtualization operation failed.<br /><br /><strong>Note</strong> The <strong>NdisMEnableVirtualization</strong> function fails if it is called to enable virtualization when virtualization is already enabled. The driver must first disable virtualization (by calling the function with the <strong>EnableVirtualization</strong> parameter set to FALSE) before the driver can reenable virtualization.</td>
</tr>
</tbody>
</table>
<h2>Remarks</h2>
<p>PF miniport drivers call <strong>NdisMEnableVirtualization</strong> to configure the SR-IOV Extended Capability fields in the PCI configuration space. This call is used to enable or disable virtualization in the configuration space, and also to specify the number of VFs that should be exposed to the PCIe fabric by the network adapter.</p>
<p>When the PF miniport driver handles an OID method request of <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/oid-nic-switch-create-switch">OID_NIC_SWITCH_CREATE_SWITCH</a>, the driver calls <strong>NdisMEnableVirtualization</strong> to enable virtualization on the network adapter for the NIC switch. The driver does this by calling <strong>NdisMEnableVirtualization</strong> with the following parameter settings.</p>
<table>
<thead>
<tr>
<th>Term</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>NumVFs</em></td>
<td>Set to the number of VFs to be enabled for the NIC switch.</td>
</tr>
<tr>
<td><em>EnableVirtualization</em></td>
<td>Set to TRUE.</td>
</tr>
</tbody>
</table>
<p>When the PF miniport driver handles an OID method request of <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/oid-nic-switch-delete-switch">OID_NIC_SWITCH_DELETE_SWITCH</a>, the driver calls <strong>NdisMEnableVirtualization</strong> to disable virtualization on the network adapter. The driver does this by calling <strong>NdisMEnableVirtualization</strong> with the following parameter settings:</p>
<table>
<thead>
<tr>
<th>Term</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>NumVFs</em></td>
<td>Set to zero.</td>
</tr>
<tr>
<td><em>EnableVirtualization</em></td>
<td>Set to FALSE.</td>
</tr>
</tbody>
</table>
<p>For more information on how to create a NIC switch, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/creating-a-nic-switch">Creating a NIC Switch</a>.</p>
<p>For more information about the SR-IOV interface, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/overview-of-single-root-i-o-virtualization--sr-iov-">Overview of Single Root I/O Virtualization (SR-IOV)</a>.</p>
<h3>Interfacing to a Virtual Bus Driver</h3>
<p>If an independent hardware vendor (IHV) provides a virtual bus driver (VBD) as part of its SR-IOV <a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/windows/hardware/difxapi/driverpackagepreinstall">driver package</a>, its miniport driver must not call <strong>NdisMEnableVirtualization</strong>. Instead, the driver must interface with the VBD through a private communication channel, and request that the VBD call <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-enable_virtualization">EnableVirtualization</a>. This function is provided by the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/windows/hardware/drivers/hh406642(v=vs.85)">GUID_PCI_VIRTUALIZATION_INTERFACE</a> interface that is supported by the underlying PCI bus driver.</p>
<p>The VBD that runs in the Hyper-V parent partition's management operating system can query the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/windows/hardware/drivers/hh406642(v=vs.85)">GUID_PCI_VIRTUALIZATION_INTERFACE</a> interface by issuing an <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/irp-mn-query-interface">IRP_MN_QUERY_INTERFACE</a> request to its physical device object (PDO) on the PCI bus. This request must be made from IRQL = PASSIVE_LEVEL. In this request, the driver must set the <em>InterfaceType</em> parameter to GUID_PCI_VIRTUALIZATION_INTERFACE.</p>
<h2>See also</h2>
<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-enable_virtualization">EnableVirtualization</a></p>
<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/windows/hardware/drivers/hh406642(v=vs.85)">GUID_PCI_VIRTUALIZATION_INTERFACE</a></p>
<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/oid-nic-switch-create-switch">OID_NIC_SWITCH_CREATE_SWITCH</a></p>
<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/oid-nic-switch-delete-switch">OID_NIC_SWITCH_DELETE_SWITCH</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nf-ndis-ndismenablevirtualization">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ndis/nf-ndis-ndismenablevirtualization.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
