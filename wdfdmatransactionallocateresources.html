<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="WdfDmaTransactionAllocateResources - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>WdfDmaTransactionAllocateResources - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
        <link rel="stylesheet" href="modules/highlight.js/styles/github.ntdoc.min.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/highlight.js/styles/github-dark-dimmed.ntdoc.min.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            WdfDmaTransactionAllocateResources - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdfdmatransaction.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> WdfDmaTransactionAllocateResources(
  [in] WDFDMATRANSACTION   DmaTransaction,
  [in] <a href="wdf_dma_direction" title="typedef enum _WDF_DMA_DIRECTION {&#10;  WdfDmaDirectionReadFromDevice = FALSE,&#10;  WdfDmaDirectionWriteToDevice = TRUE&#10;} WDF_DMA_DIRECTION;">WDF_DMA_DIRECTION</a>   DmaDirection,
  [in] <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>               RequiredMapRegisters,
  [in] PFN_WDF_RESERVE_DMA EvtReserveDmaFunction,
  [in] PVOID               EvtReserveDmaContext
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdmatransaction/nf-wdfdmatransaction-wdfdmatransactionallocateresources">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/wdfdmatransactionallocateresources.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdfdmatransaction-wdfdmatransactionallocateresources)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1>WdfDmaTransactionAllocateResources function</h1>
<h2>Description</h2>
<p>[Applies to KMDF only]</p>
<p>The <strong>WdfDmaTransactionAllocateResources</strong> method reserves a single-packet or system-mode DMA enabler for exclusive (and repeated) use with the specified transaction object. The driver can initialize and initiate the transaction multiple times while holding reserved resources.</p>
<h2>Parameters</h2>
<h3><code>DmaTransaction</code> [in]</h3>
<p>A handle to the DMA transaction object for which DMA resources should be reserved.</p>
<h3><code>DmaDirection</code> [in]</h3>
<p>A <a href="wdf_dma_direction" title="typedef enum _WDF_DMA_DIRECTION {&#10;  WdfDmaDirectionReadFromDevice = FALSE,&#10;  WdfDmaDirectionWriteToDevice = TRUE&#10;} WDF_DMA_DIRECTION;">WDF_DMA_DIRECTION</a>-typed value specifying the DMA transfer direction for which the resources are being reserved. If the driver did not specify a duplex profile, the framework ignores this value.</p>
<h3><code>RequiredMapRegisters</code> [in]</h3>
<p>The number of map registers the driver wants to reserve. If zero, the framework derives the required number of map registers from the initialized transaction.</p>
<h3><code>EvtReserveDmaFunction</code> [in]</h3>
<p>A pointer to the driver's <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdmatransaction/nc-wdfdmatransaction-evt_wdf_reserve_dma">EvtReserveDma</a> event callback function.</p>
<h3><code>EvtReserveDmaContext</code> [in]</h3>
<p>A pointer to a buffer containing the context to be provided to the driver's <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdmatransaction/nc-wdfdmatransaction-evt_wdf_reserve_dma">EvtReserveDma</a> event callback function.</p>
<h2>Return value</h2>
<p><strong>WdfDmaTransactionAllocateResources</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the operation succeeds. Otherwise, this method returns one of the following values.</p>
<table>
<thead>
<tr>
<th>Return code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>STATUS_INVALID_PARAMETER</strong></td>
<td>The <em>DmaDirection</em> parameter contains an invalid value.</td>
</tr>
<tr>
<td><strong>STATUS_INSUFFICIENT_RESOURCES</strong></td>
<td>The number of map register requests exceeds the number assigned to the enabler, or the driver previously called <a href="wdfdmatransactionsetimmediateexecution" title="VOID WdfDmaTransactionSetImmediateExecution(&#10;  [in] WDFDMATRANSACTION DmaTransaction,&#10;  [in] BOOLEAN           UseImmediateExecution&#10;);">WdfDmaTransactionSetImmediateExecution</a> and the resources needed for the request are unavailable.</td>
</tr>
<tr>
<td><strong>STATUS_INVALID_DEVICE_REQUEST</strong></td>
<td>DMA version 3 or later is not enabled, or the driver called this method for a scatter-gather DMA enabler.</td>
</tr>
</tbody>
</table>
<h2>Remarks</h2>
<p><strong>WdfDmaTransactionAllocateResources</strong> sends a request for map registers to the system DMA engine. When the request has been fulfilled, the framework calls the driver's <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdmatransaction/nc-wdfdmatransaction-evt_wdf_reserve_dma">EvtReserveDma</a> event callback function. For more information about reserving resources, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/wdf/reserving-dma-resources">Reserving DMA Resources</a>.</p>
<p>Framework-based drivers typically call <strong>WdfDmaTransactionAllocateResources</strong> from within an <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/wdf/request-handlers">I/O request handler</a>. A driver can also call <strong>WdfDmaTransactionAllocateResources</strong> from its <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdriver/nc-wdfdriver-evt_wdf_driver_device_add">EvtDriverDeviceAdd</a> callback function, after creating a DMA enabler object.</p>
<p>When called with a scatter/gather DMA enabler, <strong>WdfDmaTransactionAllocateResources</strong> causes a verifier bug check.</p>
<p>The driver must create the transaction specified by <em>DmaTransaction</em> prior to calling <strong>WdfDmaTransactionAllocateResources</strong>. After calling <strong>WdfDmaTransactionAllocateResources</strong>, the driver initializes and initiates the transaction. The driver can reinitialize and reinitiate the same transaction object multiple times, avoiding the delay that would otherwise occur between transactions as map registers were freed back to the HAL and then reallocated.</p>
<p>A driver could call <strong>WdfDmaTransactionAllocateResources</strong> in the following situations:</p>
<ul>
<li>The driver receives a set of DMA channels in its <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdevice/nc-wdfdevice-evt_wdf_device_prepare_hardware">EvtDevicePrepareHardware</a> callback function. In <em>EvtDevicePrepareHardware</em>, the driver initializes a DMA transaction and calls <strong>WdfDmaTransactionAllocateResources</strong> to reserve the enabler for exclusive use with this transaction. Alternatively, the driver can call <strong>WdfDmaTransactionAllocateResources</strong> from a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/wdf/request-handlers">request handler</a> and then initiate the transaction multiple times.</li>
<li>The driver needs to perform a series of transactions on the enabler. The driver reserves the enabler, initializes and initiates multiple transactions using the same transaction object, and then releases the enabler.</li>
</ul>
<p>Before calling <strong>WdfDmaTransactionAllocateResources</strong>, the driver must determine the number of map registers needed for any transaction that it will initiate using this reservation. To do so, the driver can call either the <a href="address_and_size_to_span_pages" title="#define ADDRESS_AND_SIZE_TO_SPAN_PAGES(Address, Size) ((BYTE_OFFSET(Address) + ((SIZE_T)(Size)) + PAGE_MASK) &gt;&gt; PAGE_SHIFT)">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a> macro or <a href="wdfdmatransactiongettransferinfo" title="VOID WdfDmaTransactionGetTransferInfo(&#10;  [in]            WDFDMATRANSACTION DmaTransaction,&#10;  [out, optional] ULONG             *MapRegisterCount,&#10;  [out, optional] ULONG             *ScatterGatherElementCount&#10;);">WdfDmaTransactionGetTransferInfo</a>.</p>
<p>When calling <strong>WdfDmaTransactionAllocateResources</strong>, the driver should not request more map registers than it requested when it created the enabler.</p>
<p>To call <strong>WdfDmaTransactionAllocateResources</strong> in a non-blocking manner, the driver should first call <a href="wdfdmatransactionsetimmediateexecution" title="VOID WdfDmaTransactionSetImmediateExecution(&#10;  [in] WDFDMATRANSACTION DmaTransaction,&#10;  [in] BOOLEAN           UseImmediateExecution&#10;);">WdfDmaTransactionSetImmediateExecution</a>.</p>
<p><strong>WdfDmaTransactionAllocateResources</strong> requires DMA version 3.
To select DMA version 3, set the <strong>WdmDmaVersionOverride</strong> member of <a href="wdf_dma_enabler_config" title="typedef struct _WDF_DMA_ENABLER_CONFIG {&#10;  ULONG                                    Size;&#10;  WDF_DMA_PROFILE                          Profile;&#10;  size_t                                   MaximumLength;&#10;  PFN_WDF_DMA_ENABLER_FILL                 EvtDmaEnablerFill;&#10;  PFN_WDF_DMA_ENABLER_FLUSH                EvtDmaEnablerFlush;&#10;  PFN_WDF_DMA_ENABLER_DISABLE              EvtDmaEnablerDisable;&#10;  PFN_WDF_DMA_ENABLER_ENABLE               EvtDmaEnablerEnable;&#10;  PFN_WDF_DMA_ENABLER_SELFMANAGED_IO_START EvtDmaEnablerSelfManagedIoStart;&#10;  PFN_WDF_DMA_ENABLER_SELFMANAGED_IO_STOP  EvtDmaEnablerSelfManagedIoStop;&#10;  ULONG                                    AddressWidthOverride;&#10;  ULONG                                    WdmDmaVersionOverride;&#10;  ULONG                                    Flags;&#10;} WDF_DMA_ENABLER_CONFIG, *PWDF_DMA_ENABLER_CONFIG;">WDF_DMA_ENABLER_CONFIG</a> to 3.</p>
<h2>See also</h2>
<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdevice/nc-wdfdevice-evt_wdf_device_prepare_hardware">EvtDevicePrepareHardware</a></p>
<p><a href="wdfdmaenablercreate" title="NTSTATUS WdfDmaEnablerCreate(&#10;  [in]           WDFDEVICE               Device,&#10;  [in]           PWDF_DMA_ENABLER_CONFIG Config,&#10;  [in, optional] PWDF_OBJECT_ATTRIBUTES  Attributes,&#10;  [out]          WDFDMAENABLER           *DmaEnablerHandle&#10;);">WdfDmaEnablerCreate</a></p>
<p><a href="wdfdmatransactioncreate" title="NTSTATUS WdfDmaTransactionCreate(&#10;  [in]           WDFDMAENABLER          DmaEnabler,&#10;  [in, optional] PWDF_OBJECT_ATTRIBUTES Attributes,&#10;  [out]          WDFDMATRANSACTION      *DmaTransaction&#10;);">WdfDmaTransactionCreate</a></p>
<p><a href="wdfdmatransactionexecute" title="NTSTATUS WdfDmaTransactionExecute(&#10;  [in]           WDFDMATRANSACTION DmaTransaction,&#10;  [in, optional] WDFCONTEXT        Context&#10;);">WdfDmaTransactionExecute</a></p>
<p><a href="wdfdmatransactionfreeresources" title="VOID WdfDmaTransactionFreeResources(&#10;  [in] WDFDMATRANSACTION DmaTransaction&#10;);">WdfDmaTransactionFreeResources</a></p>
<p><a href="wdfdmatransactionsetimmediateexecution" title="VOID WdfDmaTransactionSetImmediateExecution(&#10;  [in] WDFDMATRANSACTION DmaTransaction,&#10;  [in] BOOLEAN           UseImmediateExecution&#10;);">WdfDmaTransactionSetImmediateExecution</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdmatransaction/nf-wdfdmatransaction-wdfdmatransactionallocateresources">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdfdmatransaction/nf-wdfdmatransaction-wdfdmatransactionallocateresources.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script src="modules/highlight.js/highlight.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
