<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="NDK_FN_BUILD_LAM - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>NDK_FN_BUILD_LAM - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            NDK_FN_BUILD_LAM - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ndkpi.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">NDK_FN_BUILD_LAM NdkFnBuildLam;

<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> NdkFnBuildLam(
  [in]           <a href="ndk_adapter" title="typedef struct _NDK_ADAPTER {&#10;  NDK_OBJECT_HEADER          Header;&#10;  const NDK_ADAPTER_DISPATCH *Dispatch;&#10;} NDK_ADAPTER;">NDK_ADAPTER</a> *pNdkAdapter,
  [in]           <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> *Mdl,
  [in]           <a href="size_t-2" title="typedef ULONG_PTR SIZE_T;">SIZE_T</a> Length,
  [in]           <a href="ndk_fn_request_completion" title="NDK_FN_REQUEST_COMPLETION NdkFnRequestCompletion;&#10;&#10;VOID NdkFnRequestCompletion(&#10;  [in, optional] PVOID Context,&#10;  [in]           NTSTATUS Status&#10;)&#10;{...}">NDK_FN_REQUEST_COMPLETION</a> RequestCompletion,
  [in, optional] PVOID RequestContext,
                 <a href="ndk_logical_address_mapping" title="typedef struct _NDK_LOGICAL_ADDRESS_MAPPING {&#10;  PVOID               AdapterContext;&#10;  ULONG               AdapterPageCount;&#10;  NDK_LOGICAL_ADDRESS AdapterPageArray[1];&#10;} NDK_LOGICAL_ADDRESS_MAPPING;">NDK_LOGICAL_ADDRESS_MAPPING</a> *pNdkLAM,
                 <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> *pLAMSize,
  [out]          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> *pFBO
)
{...}</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndkpi/nc-ndkpi-ndk_fn_build_lam">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ndk_fn_build_lam.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nc-ndkpi-ndk_fn_build_lam)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="ndk_fn_build_lam-callback-function">NDK_FN_BUILD_LAM callback function</h1>

<h2 id="description">Description</h2>

<p>The <em>NdkBuildLam</em> (*NDK_FN_BUILD_LAM*) function gets an adapter logical address mapping (LAM) from the NDK provider for a virtually contiguous memory region.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="pndkadapter-in"><code>pNdkAdapter</code> [in]</h3>

<p>A pointer to an NDK adapter object (<a href="ndk_adapter" title="typedef struct _NDK_ADAPTER {&#10;  NDK_OBJECT_HEADER          Header;&#10;  const NDK_ADAPTER_DISPATCH *Dispatch;&#10;} NDK_ADAPTER;">NDK_ADAPTER</a>).</p>

<h3 id="mdl-in"><code>Mdl</code> [in]</h3>

<p>A memory descriptor list (<a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a>) or chain of MDLs. The portion of the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> chain from the starting virtual address up to the number of bytes in the <em>Length</em> parameter must represent a virtually contiguous memory region.</p>

<h3 id="length-in"><code>Length</code> [in]</h3>

<p>The number of bytes to map starting from the first <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a>'s virtual address. The <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> virtual address can be obtained with the <a href="mmgetmdlvirtualaddress" title="#define MmGetMdlVirtualAddress(Mdl) \&#10;    ((PVOID) ((PCHAR) ((Mdl)-&gt;StartVa) + (Mdl)-&gt;ByteOffset))">MmGetMdlVirtualAddress</a> macro. <em>Length</em> must not exceed the total number of bytes represented by the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> chain.</p>

<h3 id="requestcompletion-in"><code>RequestCompletion</code> [in]</h3>

<p>A pointer to a <em>NdkRequestCompletion</em> (<a href="ndk_fn_request_completion" title="NDK_FN_REQUEST_COMPLETION NdkFnRequestCompletion;&#10;&#10;VOID NdkFnRequestCompletion(&#10;  [in, optional] PVOID Context,&#10;  [in]           NTSTATUS Status&#10;)&#10;{...}">NDK_FN_REQUEST_COMPLETION</a>) callback function.</p>

<h3 id="requestcontext-in-optional"><code>RequestContext</code> [in, optional]</h3>

<p>A context value for the provider to pass back to the <em>NdkRequestCompletion</em> callback function that is specified in the <em>RequestCompletion</em> parameter.</p>

<h3 id="pndklam"><code>pNdkLAM</code></h3>

<p>A pointer to a buffer that will hold an <a href="ndk_logical_address_mapping" title="typedef struct _NDK_LOGICAL_ADDRESS_MAPPING {&#10;  PVOID               AdapterContext;&#10;  ULONG               AdapterPageCount;&#10;  NDK_LOGICAL_ADDRESS AdapterPageArray[1];&#10;} NDK_LOGICAL_ADDRESS_MAPPING;">NDK_LOGICAL_ADDRESS_MAPPING</a> structure that contains an adapter page array. The adapter page array is stored in the <strong>AdapterPageArray</strong> member and the <strong>AdapterPageCount</strong> member contains the number of adapter page elements.</p>

<h3 id="plamsize"><code>pLAMSize</code></h3>

<p>The size, in bytes, of the buffer at the <em>pNdkLAM</em> parameter for input, or the actual number of bytes written for output.</p>

<h3 id="pfbo-out"><code>pFBO</code> [out]</h3>

<p>The first byte offset (FBO) value is returned in this location. The FBO is the starting offset within the first adapter page.</p>

<h2 id="return-value">Return value</h2>

<p>The
<em>NdkBuildLam</em> function returns one of the following <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> codes.</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></strong></td>
  <td>The operation completed successfully.</td>
</tr>
<tr>
  <td><strong>STATUS_PENDING</strong></td>
  <td>The request is pending, the function specified at the <em>RequestCompletion</em> parameter(<a href="ndk_fn_request_completion" title="NDK_FN_REQUEST_COMPLETION NdkFnRequestCompletion;&#10;&#10;VOID NdkFnRequestCompletion(&#10;  [in, optional] PVOID Context,&#10;  [in]           NTSTATUS Status&#10;)&#10;{...}">NDK_FN_REQUEST_COMPLETION</a>) will be called when the LAM build operation is complete.</td>
</tr>
<tr>
  <td><strong>STATUS_INVALID_PARAMETER</strong></td>
  <td>The portion of the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> chain from the starting virtual address up to the number of bytes specified in the <em>Length</em> parameter does not represent a virtually contiguous memory region.</td>
</tr>
<tr>
  <td><strong>STATUS_INSUFFICIENT_RESOURCES</strong></td>
  <td>The request failed due to insufficient resources. <br><br><strong>Important</strong> The request can fail inline as well as asynchronously with this status code.</td>
</tr>
<tr>
  <td><strong>STATUS_BUFFER_TOO_SMALL</strong></td>
  <td>The buffer size indicated by the <em>*pLAMSize</em> parameter is too small to hold the LAM. In this case, the value of <em>*pLAMSize</em> is updated with the required buffer size.</td>
</tr>
<tr>
  <td><strong>Other status codes</strong></td>
  <td>An error occurred.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>The part of the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> chain from the starting virtual address up to the number of bytes specified in the <em>Length</em> parameter must represent a virtually contiguous memory region. Otherwise, the NDK provider must fail the request. It is the responsibility of the NDK consumer to ensure that the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> chain is locked. That is, the pages of the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> change are pinned in physical memory.</p>

<p><strong>Important</strong> The NDK consumer must not use the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> chain while <em>NdkBuildLam</em> is pending completion.</p>

<p>An adapter accesses physical memory with logical addresses. This is similar to a CPU accessing physical memory with virtual addresses. If an NDK consumer will use physical memory pages directly as local data buffers in send, receive, read, or write requests, it must get an NDK adapter logical address mapping from the NDK provider and use the logical addresses rather than physical addresses. Similarly, an NDK consumer must also use logical addresses in fast-register requests.</p>

<p>An NDK consumer can call the <em>NdkGetPrivilegedMemoryRegionToken</em> (<a href="ndk_fn_get_privileged_memory_region_token" title="NDK_FN_GET_PRIVILEGED_MEMORY_REGION_TOKEN NdkFnGetPrivilegedMemoryRegionToken;&#10;&#10;VOID NdkFnGetPrivilegedMemoryRegionToken(&#10;  [in]  NDK_PD *pNdkPd,&#10;  [out] UINT32 *pToken&#10;)&#10;{...}">NDK_FN_GET_PRIVILEGED_MEMORY_REGION_TOKEN</a>) function to get a privileged memory region token from an NDK provider.</p>

<p>All adapter pages returned by an NDK provider must be of <strong><a href="page_size" title="#define PAGE_SIZE 0x1000">PAGE_SIZE</a></strong> bytes in length, where <strong><a href="page_size" title="#define PAGE_SIZE 0x1000">PAGE_SIZE</a></strong> is the memory page size that is supported by the host platform as defined in wdm.h.</p>

<p>The provider must treat the virtual address value that the <a href="mmgetmdlvirtualaddress" title="#define MmGetMdlVirtualAddress(Mdl) \&#10;    ((PVOID) ((PCHAR) ((Mdl)-&gt;StartVa) + (Mdl)-&gt;ByteOffset))">MmGetMdlVirtualAddress</a> macro returns for the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> as an index to the start of the memory region being mapped. The provider must not use the virtual address value as a valid virtual address for reading or writing buffer contents.</p>

<p>If a provider has an error while processing an <em>NdkBuildLam</em> request, the provider must release any partial mappings it built internally thus far before completing the request with failure.</p>

<h2 id="see-also">See also</h2>

<p><a href="mmgetmdlvirtualaddress" title="#define MmGetMdlVirtualAddress(Mdl) \&#10;    ((PVOID) ((PCHAR) ((Mdl)-&gt;StartVa) + (Mdl)-&gt;ByteOffset))">MmGetMdlVirtualAddress</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/ndkpi-object-lifetime-requirements">NDKPI Object Lifetime Requirements</a></p>

<p><a href="ndk_adapter" title="typedef struct _NDK_ADAPTER {&#10;  NDK_OBJECT_HEADER          Header;&#10;  const NDK_ADAPTER_DISPATCH *Dispatch;&#10;} NDK_ADAPTER;">NDK_ADAPTER</a></p>

<p><a href="ndk_adapter_dispatch" title="typedef struct _NDK_ADAPTER_DISPATCH {&#10;  NDK_FN_QUERY_EXTENSION_INTERFACE NdkQueryExtension;&#10;  NDK_FN_QUERY_ADAPTER_INFO        NdkQueryAdapterInfo;&#10;  NDK_FN_CREATE_CQ                 NdkCreateCq;&#10;  NDK_FN_CREATE_PD                 NdkCreatePd;&#10;  NDK_FN_CREATE_SHARED_ENDPOINT    NdkCreateSharedEndpoint;&#10;  NDK_FN_CREATE_CONNECTOR          NdkCreateConnector;&#10;  NDK_FN_CREATE_LISTENER           NdkCreateListener;&#10;  NDK_FN_BUILD_LAM                 NdkBuildLAM;&#10;  NDK_FN_RELEASE_LAM               NdkReleaseLAM;&#10;} NDK_ADAPTER_DISPATCH;">NDK_ADAPTER_DISPATCH</a></p>

<p><a href="ndk_fn_get_privileged_memory_region_token" title="NDK_FN_GET_PRIVILEGED_MEMORY_REGION_TOKEN NdkFnGetPrivilegedMemoryRegionToken;&#10;&#10;VOID NdkFnGetPrivilegedMemoryRegionToken(&#10;  [in]  NDK_PD *pNdkPd,&#10;  [out] UINT32 *pToken&#10;)&#10;{...}">NDK_FN_GET_PRIVILEGED_MEMORY_REGION_TOKEN</a></p>

<p><a href="ndk_fn_release_lam" title="NDK_FN_RELEASE_LAM NdkFnReleaseLam;&#10;&#10;VOID NdkFnReleaseLam(&#10;  [in] NDK_ADAPTER *pNdkAdapter,&#10;  [in] NDK_LOGICAL_ADDRESS_MAPPING *pNdkLAM&#10;)&#10;{...}">NDK_FN_RELEASE_LAM</a></p>

<p><a href="ndk_fn_request_completion" title="NDK_FN_REQUEST_COMPLETION NdkFnRequestCompletion;&#10;&#10;VOID NdkFnRequestCompletion(&#10;  [in, optional] PVOID Context,&#10;  [in]           NTSTATUS Status&#10;)&#10;{...}">NDK_FN_REQUEST_COMPLETION</a></p>

<p><a href="ndk_logical_address_mapping" title="typedef struct _NDK_LOGICAL_ADDRESS_MAPPING {&#10;  PVOID               AdapterContext;&#10;  ULONG               AdapterPageCount;&#10;  NDK_LOGICAL_ADDRESS AdapterPageArray[1];&#10;} NDK_LOGICAL_ADDRESS_MAPPING;">NDK_LOGICAL_ADDRESS_MAPPING</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndkpi/nc-ndkpi-ndk_fn_build_lam">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ndkpi/nc-ndkpi-ndk_fn_build_lam.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
