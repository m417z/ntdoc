<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="LPD3DHAL_DRAWPRIMITIVES2CB - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>LPD3DHAL_DRAWPRIMITIVES2CB - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            LPD3DHAL_DRAWPRIMITIVES2CB - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// d3dhal.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">LPD3DHAL_DRAWPRIMITIVES2CB Lpd3dhalDrawprimitives2cb;

<a href="dword" title="typedef unsigned long DWORD;">DWORD</a> Lpd3dhalDrawprimitives2cb(
  LPD3DHAL_DRAWPRIMITIVES2DATA unnamedParam1
)
{...}</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dhal/nc-d3dhal-lpd3dhal_drawprimitives2cb">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/lpd3dhal_drawprimitives2cb.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nc-d3dhal-lpd3dhal_drawprimitives2cb)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="lpd3dhal_drawprimitives2cb-callback-function">LPD3DHAL_DRAWPRIMITIVES2CB callback function</h1>

<h2 id="description">Description</h2>

<p>The <strong>D3dDrawPrimitives2</strong> function renders primitives and returns the updated render state.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="unnamedparam1"><code>unnamedParam1</code></h3>

<p><em>pdp</em> [in]</p>

<p>Points to a <a href="d3dhal_drawprimitives2data" title="typedef struct _D3DHAL_DRAWPRIMITIVES2DATA {&#10;  ULONG_PTR                 dwhContext;&#10;  DWORD                     dwFlags;&#10;  DWORD                     dwVertexType;&#10;  LPDDRAWI_DDRAWSURFACE_LCL lpDDCommands;&#10;  DWORD                     dwCommandOffset;&#10;  DWORD                     dwCommandLength;&#10;  union {&#10;    LPDDRAWI_DDRAWSURFACE_LCL lpDDVertex;&#10;    LPVOID                    lpVertices;&#10;  };&#10;  DWORD                     dwVertexOffset;&#10;  DWORD                     dwVertexLength;&#10;  DWORD                     dwReqVertexBufSize;&#10;  DWORD                     dwReqCommandBufSize;&#10;  LPDWORD                   lpdwRStates;&#10;  union {&#10;    DWORD   dwVertexSize;&#10;    HRESULT ddrval;&#10;  };&#10;...">D3DHAL_DRAWPRIMITIVES2DATA</a> structure that contains the information required for the driver to render one or more primitives.</p>

<h2 id="return-value">Return value</h2>

<p><strong>D3dDrawPrimitives2</strong> returns one of the following callback codes:</p>

<h2 id="remarks">Remarks</h2>

<p><strong>D3dDrawPrimitives2</strong> must be implemented in Microsoft Direct3D drivers.</p>

<p>The driver must do the following:</p>

<ul>
<li>Ensure that the context handle specified by the <strong>dwhContext</strong> member of the <a href="d3dhal_drawprimitives2data" title="typedef struct _D3DHAL_DRAWPRIMITIVES2DATA {&#10;  ULONG_PTR                 dwhContext;&#10;  DWORD                     dwFlags;&#10;  DWORD                     dwVertexType;&#10;  LPDDRAWI_DDRAWSURFACE_LCL lpDDCommands;&#10;  DWORD                     dwCommandOffset;&#10;  DWORD                     dwCommandLength;&#10;  union {&#10;    LPDDRAWI_DDRAWSURFACE_LCL lpDDVertex;&#10;    LPVOID                    lpVertices;&#10;  };&#10;  DWORD                     dwVertexOffset;&#10;  DWORD                     dwVertexLength;&#10;  DWORD                     dwReqVertexBufSize;&#10;  DWORD                     dwReqCommandBufSize;&#10;  LPDWORD                   lpdwRStates;&#10;  union {&#10;    DWORD   dwVertexSize;&#10;    HRESULT ddrval;&#10;  };&#10;...">D3DHAL_DRAWPRIMITIVES2DATA</a> structure at <em>pdp</em> is valid.</li>
<li>Check that a flip to the drawing surface associated with the context is not in progress. If the drawing surface is involved in a flip, the driver should set the <strong>ddrval</strong> member of <a href="d3dhal_drawprimitives2data" title="typedef struct _D3DHAL_DRAWPRIMITIVES2DATA {&#10;  ULONG_PTR                 dwhContext;&#10;  DWORD                     dwFlags;&#10;  DWORD                     dwVertexType;&#10;  LPDDRAWI_DDRAWSURFACE_LCL lpDDCommands;&#10;  DWORD                     dwCommandOffset;&#10;  DWORD                     dwCommandLength;&#10;  union {&#10;    LPDDRAWI_DDRAWSURFACE_LCL lpDDVertex;&#10;    LPVOID                    lpVertices;&#10;  };&#10;  DWORD                     dwVertexOffset;&#10;  DWORD                     dwVertexLength;&#10;  DWORD                     dwReqVertexBufSize;&#10;  DWORD                     dwReqCommandBufSize;&#10;  LPDWORD                   lpdwRStates;&#10;  union {&#10;    DWORD   dwVertexSize;&#10;    HRESULT ddrval;&#10;  };&#10;...">D3DHAL_DRAWPRIMITIVES2DATA</a> to DDERR_WASSTILLDRAWING and return DDHAL_DRIVER_HANDLED.</li>
<li>Determine the location of the first <a href="lpd3dhal_dp2command" title="typedef struct _D3DHAL_DP2COMMAND {&#10;  BYTE  bCommand;&#10;  BYTE  bReserved;&#10;  union {&#10;    WORD wPrimitiveCount;&#10;    WORD wStateCount;&#10;  };&#10;} D3DHAL_DP2COMMAND, *LPD3DHAL_DP2COMMAND;">D3DHAL_DP2COMMAND</a> structure by adding the number of bytes in the <strong>dwCommandOffset</strong> member of <a href="d3dhal_drawprimitives2data" title="typedef struct _D3DHAL_DRAWPRIMITIVES2DATA {&#10;  ULONG_PTR                 dwhContext;&#10;  DWORD                     dwFlags;&#10;  DWORD                     dwVertexType;&#10;  LPDDRAWI_DDRAWSURFACE_LCL lpDDCommands;&#10;  DWORD                     dwCommandOffset;&#10;  DWORD                     dwCommandLength;&#10;  union {&#10;    LPDDRAWI_DDRAWSURFACE_LCL lpDDVertex;&#10;    LPVOID                    lpVertices;&#10;  };&#10;  DWORD                     dwVertexOffset;&#10;  DWORD                     dwVertexLength;&#10;  DWORD                     dwReqVertexBufSize;&#10;  DWORD                     dwReqCommandBufSize;&#10;  LPDWORD                   lpdwRStates;&#10;  union {&#10;    DWORD   dwVertexSize;&#10;    HRESULT ddrval;&#10;  };&#10;...">D3DHAL_DRAWPRIMITIVES2DATA</a> to the command buffer to which the <strong>lpDDCommands</strong> member of <a href="d3dhal_drawprimitives2data" title="typedef struct _D3DHAL_DRAWPRIMITIVES2DATA {&#10;  ULONG_PTR                 dwhContext;&#10;  DWORD                     dwFlags;&#10;  DWORD                     dwVertexType;&#10;  LPDDRAWI_DDRAWSURFACE_LCL lpDDCommands;&#10;  DWORD                     dwCommandOffset;&#10;  DWORD                     dwCommandLength;&#10;  union {&#10;    LPDDRAWI_DDRAWSURFACE_LCL lpDDVertex;&#10;    LPVOID                    lpVertices;&#10;  };&#10;  DWORD                     dwVertexOffset;&#10;  DWORD                     dwVertexLength;&#10;  DWORD                     dwReqVertexBufSize;&#10;  DWORD                     dwReqCommandBufSize;&#10;  LPDWORD                   lpdwRStates;&#10;  union {&#10;    DWORD   dwVertexSize;&#10;    HRESULT ddrval;&#10;  };&#10;...">D3DHAL_DRAWPRIMITIVES2DATA</a> points.</li>
<li>Determine the location of the first vertex in the vertex buffer. This should only be done if there is data in the vertex buffer; that is, when a D3DDP2OP_<em>Xxx</em> command token is received (except when the token is D3DDP2OP_LINELIST_IMM or D3DDP2OP_TRIANGLEFAN_IMM). These two opcodes indicate that the vertex data is passed immediately in the command stream, rather than in a vertex buffer. So, assuming there is data in the vertex buffer, if the vertex buffer is in user memory, the first vertex is <strong>dwVertexOffset</strong> bytes into the buffer that <strong>lpVertices</strong> points to. Otherwise, the driver should apply <strong>dwVertexOffset</strong> to the memory associated with the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ddrawint/ns-ddrawint-dd_surface_local">DD_SURFACE_LOCAL</a> structure to which <strong>lpDDVertex</strong> points. <strong>dwVertexOffset</strong>, <strong>lpVertices</strong>, and <strong>lpDDVertex</strong> are members of <a href="d3dhal_drawprimitives2data" title="typedef struct _D3DHAL_DRAWPRIMITIVES2DATA {&#10;  ULONG_PTR                 dwhContext;&#10;  DWORD                     dwFlags;&#10;  DWORD                     dwVertexType;&#10;  LPDDRAWI_DDRAWSURFACE_LCL lpDDCommands;&#10;  DWORD                     dwCommandOffset;&#10;  DWORD                     dwCommandLength;&#10;  union {&#10;    LPDDRAWI_DDRAWSURFACE_LCL lpDDVertex;&#10;    LPVOID                    lpVertices;&#10;  };&#10;  DWORD                     dwVertexOffset;&#10;  DWORD                     dwVertexLength;&#10;  DWORD                     dwReqVertexBufSize;&#10;  DWORD                     dwReqCommandBufSize;&#10;  LPDWORD                   lpdwRStates;&#10;  union {&#10;    DWORD   dwVertexSize;&#10;    HRESULT ddrval;&#10;  };&#10;...">D3DHAL_DRAWPRIMITIVES2DATA</a>.</li>
<li>Check the <strong>dwVertexType</strong> member of <a href="d3dhal_drawprimitives2data" title="typedef struct _D3DHAL_DRAWPRIMITIVES2DATA {&#10;  ULONG_PTR                 dwhContext;&#10;  DWORD                     dwFlags;&#10;  DWORD                     dwVertexType;&#10;  LPDDRAWI_DDRAWSURFACE_LCL lpDDCommands;&#10;  DWORD                     dwCommandOffset;&#10;  DWORD                     dwCommandLength;&#10;  union {&#10;    LPDDRAWI_DDRAWSURFACE_LCL lpDDVertex;&#10;    LPVOID                    lpVertices;&#10;  };&#10;  DWORD                     dwVertexOffset;&#10;  DWORD                     dwVertexLength;&#10;  DWORD                     dwReqVertexBufSize;&#10;  DWORD                     dwReqCommandBufSize;&#10;  LPDWORD                   lpdwRStates;&#10;  union {&#10;    DWORD   dwVertexSize;&#10;    HRESULT ddrval;&#10;  };&#10;...">D3DHAL_DRAWPRIMITIVES2DATA</a> to ensure that the driver supports the requested <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/display/fvf--flexible-vertex-format-">FVF</a>. The driver should fail the call if any of the following conditions exist:
<ul>
<li>Vertex coordinates are not specified; that is, if D3DFVF_XYZRHW is not set.</li>
<li>Normals are specified; that is, if D3DFVF_NORMAL is set.</li>
<li>Any of the reserved D3DFVF_RESERVED <em>x</em> bits are set.</li>
</ul></li>
<li>Process all of the commands in the command buffer sequentially. For each <a href="lpd3dhal_dp2command" title="typedef struct _D3DHAL_DP2COMMAND {&#10;  BYTE  bCommand;&#10;  BYTE  bReserved;&#10;  union {&#10;    WORD wPrimitiveCount;&#10;    WORD wStateCount;&#10;  };&#10;} D3DHAL_DP2COMMAND, *LPD3DHAL_DP2COMMAND;">D3DHAL_DP2COMMAND</a> structure, the driver should do the following:
<ul>
<li>If the command is D3DDP2OP_RENDERSTATE, process the <strong>wStateCount</strong> <a href="d3dhal_dp2renderstate" title="typedef struct _D3DHAL_DP2RENDERSTATE {&#10;  D3DRENDERSTATETYPE RenderState;&#10;  union {&#10;    D3DVALUE dvState;&#10;    DWORD    dwState;&#10;  };&#10;} D3DHAL_DP2RENDERSTATE;">D3DHAL_DP2RENDERSTATE</a> structures that follow in the command buffer, updating the driver state for each render state structure. When the D3DHALDP2_EXECUTEBUFFER flag is set, the driver should also reflect the state change in the array that <strong>lpdwRStates</strong> points to. <strong>wStateCount</strong>  and <strong>lpdwRStates</strong> are members of <a href="d3dhal_drawprimitives2data" title="typedef struct _D3DHAL_DRAWPRIMITIVES2DATA {&#10;  ULONG_PTR                 dwhContext;&#10;  DWORD                     dwFlags;&#10;  DWORD                     dwVertexType;&#10;  LPDDRAWI_DDRAWSURFACE_LCL lpDDCommands;&#10;  DWORD                     dwCommandOffset;&#10;  DWORD                     dwCommandLength;&#10;  union {&#10;    LPDDRAWI_DDRAWSURFACE_LCL lpDDVertex;&#10;    LPVOID                    lpVertices;&#10;  };&#10;  DWORD                     dwVertexOffset;&#10;  DWORD                     dwVertexLength;&#10;  DWORD                     dwReqVertexBufSize;&#10;  DWORD                     dwReqCommandBufSize;&#10;  LPDWORD                   lpdwRStates;&#10;  union {&#10;    DWORD   dwVertexSize;&#10;    HRESULT ddrval;&#10;  };&#10;...">D3DHAL_DRAWPRIMITIVES2DATA</a>.</li>
<li>If the command is D3DDP2OP_TEXTURESTAGESTATE, process the <strong>wStateCount</strong> <a href="d3dhal_dp2texturestagestate" title="typedef struct _D3DHAL_DP2TEXTURESTAGESTATE {&#10;  WORD  wStage;&#10;  WORD  TSState;&#10;  DWORD dwValue;&#10;} D3DHAL_DP2TEXTURESTAGESTATE;">D3DHAL_DP2TEXTURESTAGESTATE</a> structures that follow in the command buffer, updating the driver's texture state associated with the specified texture stage for each texture state structure.</li>
<li>If the command is D3DDP2OP_VIEWPORTINFO, process the <a href="d3dhal_dp2viewportinfo" title="typedef struct _D3DHAL_DP2VIEWPORTINFO {&#10;  DWORD dwX;&#10;  DWORD dwY;&#10;  DWORD dwWidth;&#10;  DWORD dwHeight;&#10;} D3DHAL_DP2VIEWPORTINFO;">D3DHAL_DP2VIEWPORTINFO</a> structure that follows in the command buffer, updating the viewport information stored in the driver's internal rendering context.</li>
<li>If the command is D3DDP2OP_WINFO, process the <a href="d3dhal_dp2winfo" title="typedef struct _D3DHAL_DP2WINFO {&#10;  D3DVALUE dvWNear;&#10;  D3DVALUE dvWFar;&#10;} D3DHAL_DP2WINFO;">D3DHAL_DP2WINFO</a> structure that follows in the command buffer, updating the w-buffering information stored in the driver's internal rendering context.</li>
<li>Otherwise, process the D3DHAL_DP2<em>Xxx</em> primitive structures that follow the D3DDP2OP_<em>Xxx</em> primitive rendering command in the command buffer.</li>
<li>If the command is unknown, call the runtime's <strong>D3dParseUnknownCommand</strong> callback. The runtime provides this callback to the driver's <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ddrawint/nc-ddrawint-pdd_getdriverinfo">DdGetDriverInfo</a> callback with the GUID_D3DParseUnknownCommandCallback GUID.</li>
</ul></li>
</ul>

<p>The driver does not need to probe for readability of the memory where the command and vertex buffers are stored. However, the driver must stay within the bounds specified by the <strong>dwCommandLength</strong> and <strong>dwVertexLength</strong> members of <a href="d3dhal_drawprimitives2data" title="typedef struct _D3DHAL_DRAWPRIMITIVES2DATA {&#10;  ULONG_PTR                 dwhContext;&#10;  DWORD                     dwFlags;&#10;  DWORD                     dwVertexType;&#10;  LPDDRAWI_DDRAWSURFACE_LCL lpDDCommands;&#10;  DWORD                     dwCommandOffset;&#10;  DWORD                     dwCommandLength;&#10;  union {&#10;    LPDDRAWI_DDRAWSURFACE_LCL lpDDVertex;&#10;    LPVOID                    lpVertices;&#10;  };&#10;  DWORD                     dwVertexOffset;&#10;  DWORD                     dwVertexLength;&#10;  DWORD                     dwReqVertexBufSize;&#10;  DWORD                     dwReqCommandBufSize;&#10;  LPDWORD                   lpdwRStates;&#10;  union {&#10;    DWORD   dwVertexSize;&#10;    HRESULT ddrval;&#10;  };&#10;...">D3DHAL_DRAWPRIMITIVES2DATA</a>.</p>

<p>If the driver must fail <strong>D3dDrawPrimitives2</strong>, it should fill in the <strong>dwErrorOffset</strong> member of <a href="d3dhal_drawprimitives2data" title="typedef struct _D3DHAL_DRAWPRIMITIVES2DATA {&#10;  ULONG_PTR                 dwhContext;&#10;  DWORD                     dwFlags;&#10;  DWORD                     dwVertexType;&#10;  LPDDRAWI_DDRAWSURFACE_LCL lpDDCommands;&#10;  DWORD                     dwCommandOffset;&#10;  DWORD                     dwCommandLength;&#10;  union {&#10;    LPDDRAWI_DDRAWSURFACE_LCL lpDDVertex;&#10;    LPVOID                    lpVertices;&#10;  };&#10;  DWORD                     dwVertexOffset;&#10;  DWORD                     dwVertexLength;&#10;  DWORD                     dwReqVertexBufSize;&#10;  DWORD                     dwReqCommandBufSize;&#10;  LPDWORD                   lpdwRStates;&#10;  union {&#10;    DWORD   dwVertexSize;&#10;    HRESULT ddrval;&#10;  };&#10;...">D3DHAL_DRAWPRIMITIVES2DATA</a> with the offset into the command buffer where the first unhandled <a href="lpd3dhal_dp2command" title="typedef struct _D3DHAL_DP2COMMAND {&#10;  BYTE  bCommand;&#10;  BYTE  bReserved;&#10;  union {&#10;    WORD wPrimitiveCount;&#10;    WORD wStateCount;&#10;  };&#10;} D3DHAL_DP2COMMAND, *LPD3DHAL_DP2COMMAND;">D3DHAL_DP2COMMAND</a> can be found.</p>

<p><strong>Note</strong> The following comments are valid only for applications that are written using Microsoft DirectX 7.0 interfaces and that communicate with drivers through DirectX 8.0 and DirectX 8.1 runtimes.</p>

<p>The following comments are not valid for applications that are written using DirectX 8.0 and later interfaces because such applications no longer use the concept of a current vertex buffer (that is, vertex data is no longer passed in via the <strong>lpDDVertex</strong> member of <a href="d3dhal_drawprimitives2data" title="typedef struct _D3DHAL_DRAWPRIMITIVES2DATA {&#10;  ULONG_PTR                 dwhContext;&#10;  DWORD                     dwFlags;&#10;  DWORD                     dwVertexType;&#10;  LPDDRAWI_DDRAWSURFACE_LCL lpDDCommands;&#10;  DWORD                     dwCommandOffset;&#10;  DWORD                     dwCommandLength;&#10;  union {&#10;    LPDDRAWI_DDRAWSURFACE_LCL lpDDVertex;&#10;    LPVOID                    lpVertices;&#10;  };&#10;  DWORD                     dwVertexOffset;&#10;  DWORD                     dwVertexLength;&#10;  DWORD                     dwReqVertexBufSize;&#10;  DWORD                     dwReqCommandBufSize;&#10;  LPDWORD                   lpdwRStates;&#10;  union {&#10;    DWORD   dwVertexSize;&#10;    HRESULT ddrval;&#10;  };&#10;...">D3DHAL_DRAWPRIMITIVES2DATA</a>). Therefore, with these applications, the driver's <strong>D3dDrawPrimitives2</strong> function should never cause rendering from a vertex buffer to stall even if the buffer is implicit or explicit and there is an outstanding lock on it.</p>

<p>If the driver is used with a DirectX 8.1 or later runtime, the driver's <strong>D3dDrawPrimitives2</strong> function should never cause rendering from the current vertex buffer (passed in via <strong>lpDDVertex</strong>) to stall if the buffer is implicit. If the buffer is explicit and there is an outstanding lock on it, the driver should stall at the end of its <strong>D3dDrawPrimitives2</strong> function if it does not rename the buffer (does not set D3DHALDP2_SWAPVERTEXBUFFER). If the driver renames the buffer, then the driver does not stall. DirectX 8.1 and later runtimes call the driver's <strong>D3dDrawPrimitives2</strong> function to render from a locked explicit vertex buffer only when necessary so performance is rarely affected. An implicit vertex buffer is created by the driver's <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ddrawint/nc-ddrawint-pdd_createsurface">CreateD3DBuffer</a> callback with only the DDSCAPS_EXECUTEBUFFER flag set. An explicit vertex buffer is created by the driver's <em>CreateD3DBuffer</em> callback with the DDSCAPS_EXECUTEBUFFER and DDSCAPS2_VERTEXBUFFER flags set. The explicit vertex buffer becomes locked by the driver's <a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/windows/hardware/drivers/ff568216(v=vs.85)">LockD3DBuffer</a> callback.</p>

<p>If the driver is used with a DirectX 8.0 runtime, the driver should sometimes stall when rendering from an implicit current vertex buffer to prevent synchronization issues and resulting corruption. In addition, the DirectX 8.0 runtime calls the driver's <strong>D3dDrawPrimitives2</strong> function to render from a locked explicit current vertex buffer more often then really necessary so performance is degraded. The following are stalling workarounds for a driver that is used with a DirectX 8.0 runtime:</p>

<ul>
<li><p>The driver should stall when it transitions between rendering user-memory primitives (identified by D3DHALDP2_USERMEMVERTICES) and rendering from an implicit current vertex buffer only if it does not rename the buffer (does not set D3DHALDP2_SWAPVERTEXBUFFER).</p>

<p>The following example shows when <strong>D3dDrawPrimitives2</strong> should stall on an implicit current vertex buffer:</p>

<div class="codehilite">
<pre><span></span><code><span class="n">DrawPrimitives2</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">D3DHALDP2_USERMEMVERTICES</span><span class="p">);</span><span class="w"> </span><span class="c1">// Do not stall</span>
<span class="n">DrawPrimitives2</span><span class="p">(</span><span class="n">Implicit</span><span class="w"> </span><span class="n">VB</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Stall</span>
</code></pre>
</div>

<p>The following example shows when <strong>D3dDrawPrimitives2</strong> should not stall on an implicit current vertex buffer:</p>

<div class="codehilite">
<pre><span></span><code><span class="n">DrawPrimitives2</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">D3DHALDP2_USERMEMVERTICES</span><span class="p">);</span><span class="w"> </span><span class="c1">// Do not stall</span>
<span class="n">DrawPrimitives2</span><span class="p">(</span><span class="n">Explicit</span><span class="w"> </span><span class="n">VB</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Do not stall if not locked</span>
<span class="n">DrawPrimitives2</span><span class="p">(</span><span class="n">Explicit</span><span class="w"> </span><span class="n">VB</span><span class="p">,</span><span class="w"> </span><span class="n">D3DHALDP2_SWAPVERTEXBUFFER</span><span class="p">);</span><span class="w"> </span><span class="c1">// Do not stall whether locked</span>
<span class="n">DrawPrimitives2</span><span class="p">(</span><span class="n">Implicit</span><span class="w"> </span><span class="n">VB</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Do not stall whether locked</span>
<span class="n">DrawPrimitives2</span><span class="p">(</span><span class="n">Implicit</span><span class="w"> </span><span class="n">VB</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Do not stall whether locked</span>
<span class="n">DrawPrimitives2</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">D3DHALDP2_USERMEMVERTICES</span><span class="p">);</span><span class="w"> </span><span class="c1">// Do not stall</span>
<span class="n">DrawPrimitives2</span><span class="p">(</span><span class="n">Implicit</span><span class="w"> </span><span class="n">VB</span><span class="p">,</span><span class="w"> </span><span class="n">D3DHALDP2_SWAPVERTEXBUFFER</span><span class="p">);</span><span class="w"> </span><span class="c1">// Do not stall because D3DHALDP2_SWAPVERTEXBUFFER is set</span>
</code></pre>
</div>

<p>If the runtime sets the D3DHALDP2_REQCOMMANDBUFSIZE flag, then the driver is not required to stall. By coincidence, the DirectX 8.0 runtime also sets D3DHALDP2_REQCOMMANDBUFSIZE when it most commonly renders from a locked explicit current vertex buffer. The driver can therefore improve performance by not stalling when it detects D3DHALDP2_REQCOMMANDBUFSIZE while rendering from a locked explicit current vertex buffer.</p>

<p>The following example shows when <strong>D3dDrawPrimitives2</strong> should stall on an explicit current vertex buffer:</p>

<div class="codehilite">
<pre><span></span><code><span class="n">DrawPrimitives2</span><span class="p">(</span><span class="n">Explicit</span><span class="w"> </span><span class="n">VB</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Stall when locked (happens rarely)</span>
</code></pre>
</div>

<p>The following example shows when <strong>D3dDrawPrimitives2</strong> should not stall on an explicit current vertex buffer:</p>

<div class="codehilite">
<pre><span></span><code><span class="n">DrawPrimitives2</span><span class="p">(</span><span class="n">Explicit</span><span class="w"> </span><span class="n">VB</span><span class="p">,</span><span class="w"> </span><span class="n">D3DHALDP2_REQCOMMANDBUFSIZE</span><span class="p">);</span><span class="w"> </span><span class="c1">// Do not stall whether locked</span>
<span class="n">DrawPrimitives2</span><span class="p">(</span><span class="n">Explicit</span><span class="w"> </span><span class="n">VB</span><span class="p">,</span><span class="w"> </span><span class="n">D3DHALDP2_SWAPVERTEXBUFFER</span><span class="p">);</span><span class="w"> </span><span class="c1">// Do not stall whether locked</span>
<span class="n">DrawPrimitives2</span><span class="p">(</span><span class="n">Explicit</span><span class="w"> </span><span class="n">VB</span><span class="p">,</span><span class="w"> </span><span class="n">D3DHALDP2_SWAPVERTEXBUFFER</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">D3DHALDP2_REQCOMMANDBUFSIZE</span><span class="p">);</span><span class="w"> </span><span class="c1">// Do not stall</span>
</code></pre>
</div>

<h2 id="see-also">See also</h2>

<p><a href="lpd3dhal_dp2indexedlinelist" title="typedef struct _D3DHAL_DP2INDEXEDLINELIST {&#10;  WORD wV1;&#10;  WORD wV2;&#10;} D3DHAL_DP2INDEXEDLINELIST, *LPD3DHAL_DP2INDEXEDLINELIST;">D3DHAL_DP2INDEXEDLINELIST</a></p>

<p><a href="lpd3dhal_dp2indexedlinestrip" title="typedef struct _D3DHAL_DP2INDEXEDLINESTRIP {&#10;  WORD wV[2];&#10;} D3DHAL_DP2INDEXEDLINESTRIP, *LPD3DHAL_DP2INDEXEDLINESTRIP;">D3DHAL_DP2INDEXEDLINESTRIP</a></p>

<p><a href="lpd3dhal_dp2indexedtrianglefan" title="typedef struct _D3DHAL_DP2INDEXEDTRIANGLEFAN {&#10;  WORD wV[3];&#10;} D3DHAL_DP2INDEXEDTRIANGLEFAN, *LPD3DHAL_DP2INDEXEDTRIANGLEFAN;">D3DHAL_DP2INDEXEDTRIANGLEFAN</a></p>

<p><a href="lpd3dhal_dp2indexedtrianglelist" title="typedef struct _D3DHAL_DP2INDEXEDTRIANGLELIST {&#10;  WORD wV1;&#10;  WORD wV2;&#10;  WORD wV3;&#10;  WORD wFlags;&#10;} D3DHAL_DP2INDEXEDTRIANGLELIST, *LPD3DHAL_DP2INDEXEDTRIANGLELIST;">D3DHAL_DP2INDEXEDTRIANGLELIST</a></p>

<p><a href="lpd3dhal_dp2indexedtrianglestrip" title="typedef struct _D3DHAL_DP2INDEXEDTRIANGLESTRIP {&#10;  WORD wV[3];&#10;} D3DHAL_DP2INDEXEDTRIANGLESTRIP, *LPD3DHAL_DP2INDEXEDTRIANGLESTRIP;">D3DHAL_DP2INDEXEDTRIANGLESTRIP</a></p>

<p><a href="lpd3dhal_dp2linelist" title="typedef struct _D3DHAL_DP2LINELIST {&#10;  WORD wVStart;&#10;} D3DHAL_DP2LINELIST, *LPD3DHAL_DP2LINELIST;">D3DHAL_DP2LINELIST</a></p>

<p><a href="lpd3dhal_dp2linestrip" title="typedef struct _D3DHAL_DP2LINESTRIP {&#10;  WORD wVStart;&#10;} D3DHAL_DP2LINESTRIP, *LPD3DHAL_DP2LINESTRIP;">D3DHAL_DP2LINESTRIP</a></p>

<p><a href="lpd3dhal_dp2points" title="typedef struct _D3DHAL_DP2POINTS {&#10;  WORD wCount;&#10;  WORD wVStart;&#10;} D3DHAL_DP2POINTS, *LPD3DHAL_DP2POINTS;">D3DHAL_DP2POINTS</a></p>

<p><a href="lpd3dhal_dp2trianglefan" title="typedef struct _D3DHAL_DP2TRIANGLEFAN {&#10;  WORD wVStart;&#10;} D3DHAL_DP2TRIANGLEFAN, *LPD3DHAL_DP2TRIANGLEFAN;">D3DHAL_DP2TRIANGLEFAN</a></p>

<p><a href="lpd3dhal_dp2trianglelist" title="typedef struct _D3DHAL_DP2TRIANGLELIST {&#10;  WORD wVStart;&#10;} D3DHAL_DP2TRIANGLELIST, *LPD3DHAL_DP2TRIANGLELIST;">D3DHAL_DP2TRIANGLELIST</a></p>

<p><a href="lpd3dhal_dp2trianglestrip" title="typedef struct _D3DHAL_DP2TRIANGLESTRIP {&#10;  WORD wVStart;&#10;} D3DHAL_DP2TRIANGLESTRIP, *LPD3DHAL_DP2TRIANGLESTRIP;">D3DHAL_DP2TRIANGLESTRIP</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/display/fvf--flexible-vertex-format-">FVF</a></p></li>
</ul>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dhal/nc-d3dhal-lpd3dhal_drawprimitives2cb">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/d3dhal/nc-d3dhal-lpd3dhal_drawprimitives2cb.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
