<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="FSRTL_PER_STREAM_CONTEXT - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>FSRTL_PER_STREAM_CONTEXT - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            FSRTL_PER_STREAM_CONTEXT - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">typedef struct _FSRTL_PER_STREAM_CONTEXT {
  <a href="list_entry" title="typedef struct _LIST_ENTRY LIST_ENTRY, *PLIST_ENTRY;">LIST_ENTRY</a>     Links;
  PVOID          OwnerId;
  PVOID          InstanceId;
  PFREE_FUNCTION FreeCallback;
} FSRTL_PER_STREAM_CONTEXT, *PFSRTL_PER_STREAM_CONTEXT;</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ns-ntifs-_fsrtl_per_stream_context">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/fsrtl_per_stream_context.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ns-ntifs-_fsrtl_per_stream_context)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="_fsrtl_per_stream_context-structure">_FSRTL_PER_STREAM_CONTEXT structure</h1>

<h2 id="description">Description</h2>

<p>The <strong>FSRTL_PER_STREAM_CONTEXT</strong> structure contains context information that a file system filter driver maintains about a file stream.</p>

<h2 id="members">Members</h2>

<h3 id="links"><code>Links</code></h3>

<p>Link for this structure in the list of all per-stream context structures associated with the same file stream. <a href="fsrtlinsertperstreamcontext" title="NTSTATUS FsRtlInsertPerStreamContext(&#10;       PFSRTL_ADVANCED_FCB_HEADER PerStreamContext,&#10;  [in] PFSRTL_PER_STREAM_CONTEXT  Ptr&#10;);">FsRtlInsertPerStreamContext</a> inserts this member into the list of all per-stream context structures for a file stream. To get a pointer to the head of the list from a file object, use the <a href="fsrtlgetperstreamcontextpointer" title="void FsRtlGetPerStreamContextPointer(&#10;  _fo&#10;);">FsRtlGetPerStreamContextPointer</a> macro, and cast the result to a <strong>PFSRTL_ADVANCED_FCB_HEADER</strong> pointer. The list pointer is the <strong>FilterContexts</strong> member in the advanced file control block (FCB) header structure for the file stream.</p>

<h3 id="ownerid"><code>OwnerId</code></h3>

<p>Pointer to a filter-driver-allocated variable that uniquely identifies the owner of the per-stream context structure. The format of this variable is filter-driver-specific. Filter writers should choose a value that is both meaningful and convenient, such as the address of a driver object or device object. Filter drivers must set this member to a non-<strong>NULL</strong> value.</p>

<h3 id="instanceid"><code>InstanceId</code></h3>

<p>Pointer to a filter-driver-allocated variable that can be used to distinguish among per-stream context structures created by the same filter driver. The format of this variable is filter-driver-specific. Filter writers should choose a value that is both meaningful and convenient, such as the address of the stream context object for the file stream. (To get this address from a file object, use the <a href="fsrtlgetperstreamcontextpointer" title="void FsRtlGetPerStreamContextPointer(&#10;  _fo&#10;);">FsRtlGetPerStreamContextPointer</a> macro.)</p>

<p>This member is optional and can be <strong>NULL</strong>.</p>

<h3 id="freecallback"><code>FreeCallback</code></h3>

<p>Pointer to a callback routine that frees the per-stream context structure. This routine and its parameters are defined as follows:</p>

<p><!-- CODE_MARKER --></p>

<pre><code>VOID
(*PFREE_FUNCTION) (
     IN PVOID Buffer
     );
</code></pre>

<h4 id="buffer">Buffer</h4>

<p>Pointer to the <strong>FSRTL_PER_STREAM_CONTEXT</strong> structure to free.</p>

<h2 id="remarks">Remarks</h2>

<p>File system filter drivers can use a <strong>FSRTL_PER_STREAM_CONTEXT</strong> structure to maintain context information for a file stream. This structure can be used as is or embedded in a driver-defined, per-stream context structure.</p>

<p>When a file system tears down the stream context object for a file stream, it must call <a href="fsrtlteardownperstreamcontexts" title="VOID FsRtlTeardownPerStreamContexts(&#10;  [in] PFSRTL_ADVANCED_FCB_HEADER AdvancedHeader&#10;);">FsRtlTeardownPerStreamContexts</a>, which in turn calls the <em>FreeCallback</em> routines of all per-stream context structures associated with the file stream.</p>

<p><strong>Note</strong> The <em>FreeCallback</em> routine cannot recursively call down into the file system or acquire any file system resources. Also, this routine must assume that the file object for the file stream has already been freed.</p>

<p>The <strong>FSRTL_PER_STREAM_CONTEXT</strong> structure can be allocated from paged or nonpaged pool.</p>

<p>The <strong>FsRtlSupportsPerStreamContexts</strong> macro determines whether a file system supports per-stream contexts for a given file stream.</p>

<p><!-- CODE_MARKER --></p>

<pre><code>BOOLEAN FsRtlSupportsPerStreamContexts(
  [in] <a href="file_object" title="typedef struct _FILE_OBJECT {&#10;  CSHORT                                Type;&#10;  CSHORT                                Size;&#10;  PDEVICE_OBJECT                        DeviceObject;&#10;  PVPB                                  Vpb;&#10;  PVOID                                 FsContext;&#10;  PVOID                                 FsContext2;&#10;  PSECTION_OBJECT_POINTERS              SectionObjectPointer;&#10;  PVOID                                 PrivateCacheMap;&#10;  NTSTATUS                              FinalStatus;&#10;  struct _FILE_OBJECT                   *RelatedFileObject;&#10;  BOOLEAN                               LockOperation;&#10;  BOOLEAN                               DeletePending;&#10;  BOOLEAN                               ReadAccess;&#10;  BOOLEAN                               WriteAccess;&#10;  BOOLEAN                               DeleteAccess;&#10;  BOOLEAN                               SharedRead;&#10;  BOOLEAN                               SharedWrite;&#10;  BOOLEAN                               SharedDelete;&#10;  ULONG                                 Flags;&#10;...">PFILE_OBJECT</a> FileObject
);
</code></pre>

<p>Parameters</p>

<p><em>FileObject [in]</em></p>

<p><strong><a href="file_object" title="typedef struct _FILE_OBJECT {&#10;  CSHORT                                Type;&#10;  CSHORT                                Size;&#10;  PDEVICE_OBJECT                        DeviceObject;&#10;  PVPB                                  Vpb;&#10;  PVOID                                 FsContext;&#10;  PVOID                                 FsContext2;&#10;  PSECTION_OBJECT_POINTERS              SectionObjectPointer;&#10;  PVOID                                 PrivateCacheMap;&#10;  NTSTATUS                              FinalStatus;&#10;  struct _FILE_OBJECT                   *RelatedFileObject;&#10;  BOOLEAN                               LockOperation;&#10;  BOOLEAN                               DeletePending;&#10;  BOOLEAN                               ReadAccess;&#10;  BOOLEAN                               WriteAccess;&#10;  BOOLEAN                               DeleteAccess;&#10;  BOOLEAN                               SharedRead;&#10;  BOOLEAN                               SharedWrite;&#10;  BOOLEAN                               SharedDelete;&#10;  ULONG                                 Flags;&#10;...">PFILE_OBJECT</a></strong></p>

<p>A pointer to a file object for the file stream.</p>

<p>Return value</p>

<p><strong>BOOLEAN</strong></p>

<p>The <strong>FsRtlSupportsPerStreamContexts</strong> macro returns <strong>TRUE</strong> if the file system supports per-stream contexts for the file stream, <strong>FALSE</strong> otherwise.</p>

<p>File system filter drivers call <strong>FsRtlSupportsPerStreamContexts</strong> to determine whether the underlying file system supports per-stream contexts for the file stream represented by a given file object. Note that a file system might support per-stream contexts for some types of files but not for others. For example, NTFS and FAT do not currently support per-stream contexts for paging files.</p>

<p>For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ifs/tracking-per-stream-context-in-a-legacy-file-system-filter-driver">Tracking Per-Stream Context in a Legacy File System Filter Driver</a>.</p>

<h2 id="see-also">See also</h2>

<p><a href="fsrtl_advanced_fcb_header" title="typedef struct _FSRTL_ADVANCED_FCB_HEADER {&#10;  FSRTL_COMMON_FCB_HEADER          DUMMYSTRUCTNAME;&#10;  PFAST_MUTEX                      FastMutex;&#10;  LIST_ENTRY                       FilterContexts;&#10;  EX_PUSH_LOCK                     PushLock;&#10;  PVOID                            *FileContextSupportPointer;&#10;  union {&#10;    OPLOCK Oplock;&#10;    PVOID  ReservedForRemote;&#10;  };&#10;  PVOID                            AePushLock;&#10;  PVOID                            ReservedContextLegacy;&#10;  ULONG                            BypassIoOpenCount;&#10;  struct _FSRTL_PER_STREAM_CONTEXT *ReservedContext;&#10;} FSRTL_ADVANCED_FCB_HEADER;">FSRTL_ADVANCED_FCB_HEADER</a></p>

<p><a href="fsrtl_common_fcb_header" title="typedef struct _FSRTL_COMMON_FCB_HEADER {&#10;  CSHORT        NodeTypeCode;&#10;  CSHORT        NodeByteSize;&#10;  UCHAR         Flags;&#10;  UCHAR         IsFastIoPossible;&#10;  UCHAR         Flags2;&#10;  UCHAR         Reserved : 4;&#10;  UCHAR         Version : 4;&#10;  PERESOURCE    Resource;&#10;  PERESOURCE    PagingIoResource;&#10;  LARGE_INTEGER AllocationSize;&#10;  LARGE_INTEGER FileSize;&#10;  LARGE_INTEGER ValidDataLength;&#10;} FSRTL_COMMON_FCB_HEADER;">FSRTL_COMMON_FCB_HEADER</a></p>

<p><a href="fsrtlgetperstreamcontextpointer" title="void FsRtlGetPerStreamContextPointer(&#10;  _fo&#10;);">FsRtlGetPerStreamContextPointer</a></p>

<p><a href="fsrtlinsertperstreamcontext" title="NTSTATUS FsRtlInsertPerStreamContext(&#10;       PFSRTL_ADVANCED_FCB_HEADER PerStreamContext,&#10;  [in] PFSRTL_PER_STREAM_CONTEXT  Ptr&#10;);">FsRtlInsertPerStreamContext</a></p>

<p><a href="fsrtllookupperstreamcontext" title="void FsRtlLookupPerStreamContext(&#10;  _sc,&#10;  _oid,&#10;  _iid&#10;);">FsRtlLookupPerStreamContext</a></p>

<p><a href="fsrtlremoveperstreamcontext" title="PFSRTL_PER_STREAM_CONTEXT FsRtlRemovePerStreamContext(&#10;  [in]           PFSRTL_ADVANCED_FCB_HEADER StreamContext,&#10;  [in, optional] PVOID                      OwnerId,&#10;  [in, optional] PVOID                      InstanceId&#10;);">FsRtlRemovePerStreamContext</a></p>

<p><a href="fsrtlteardownperstreamcontexts" title="VOID FsRtlTeardownPerStreamContexts(&#10;  [in] PFSRTL_ADVANCED_FCB_HEADER AdvancedHeader&#10;);">FsRtlTeardownPerStreamContexts</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ifs/pfree-function">PFREE_FUNCTION</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ifs/tracking-per-stream-context-in-a-legacy-file-system-filter-driver">Tracking Per-Stream Context in a Legacy File System Filter Driver</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ns-ntifs-_fsrtl_per_stream_context">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/ns-ntifs-_fsrtl_per_stream_context.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
