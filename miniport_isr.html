<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="MINIPORT_ISR - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>MINIPORT_ISR - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            MINIPORT_ISR - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ndis.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">MINIPORT_ISR MiniportIsr;

BOOLEAN MiniportIsr(
  [in]  NDIS_HANDLE MiniportInterruptContext,
  [out] PBOOLEAN QueueDefaultInterruptDpc,
  [out] PULONG TargetProcessors
)
{...}</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_isr">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/miniport_isr.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nc-ndis-miniport_isr)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="miniport_isr-callback-function">MINIPORT_ISR callback function</h1>

<h2 id="description">Description</h2>

<p>NDIS calls the
<em>MiniportInterrupt</em> function when a NIC, or another device that shares the
interrupt with the NIC, generates an interrupt.</p>

<p><strong>Note</strong> You must declare this function by using the <strong>MINIPORT_ISR</strong> type. For more information,
see the following Examples section.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="miniportinterruptcontext-in"><code>MiniportInterruptContext</code> [in]</h3>

<p>A handle to a block of interrupt context information. The miniport driver supplied this handle in
the
<em>MiniportInterruptContext</em> parameter that the miniport driver passed to the
<a href="ndismregisterinterruptex" title="NDIS_STATUS NdisMRegisterInterruptEx(&#10;  [in]  NDIS_HANDLE                              MiniportAdapterHandle,&#10;  [in]  NDIS_HANDLE                              MiniportInterruptContext,&#10;  [in]  PNDIS_MINIPORT_INTERRUPT_CHARACTERISTICS MiniportInterruptCharacteristics,&#10;  [out] PNDIS_HANDLE                             NdisInterruptHandle&#10;);">NdisMRegisterInterruptEx</a> function.</p>

<h3 id="queuedefaultinterruptdpc-out"><code>QueueDefaultInterruptDpc</code> [out]</h3>

<p>A pointer to a BOOLEAN variable that the miniport driver sets before it returns from this call. A
miniport driver sets this value to <strong>TRUE</strong> to indicate that the driver requires a DPC on the default
(current) CPU. If this value is set to <strong>TRUE</strong>, NDIS ignores the value of the
<em>TargetProcessors</em> parameter. If it is set to <strong>FALSE</strong>, NDIS uses the value of the
<em>TargetProcessors</em> parameter to schedule DPCs. If
<em>QueueDefaultInterruptDpc</em> is <strong>TRUE</strong>, NDIS will schedule a DPC regardless of the
return value from
<em>MiniportInterrupt</em>.</p>

<h3 id="targetprocessors-out"><code>TargetProcessors</code> [out]</h3>

<p>A bitmask that indicates the target processors for which NDIS should schedule a DPC. This bitmask represents the first 32 processors in processor group 0. Each bit in
the bitmask identifies a CPU. If the caller sets bit 0, NDIS schedules a DPC for CPU 0. If the caller sets bit 1, NDIS
schedules a DPC for CPU 1, and so on. If
<em>QueueDefaultInterruptDpc</em> is set to <strong>FALSE</strong> and
<em>TargetProcessors</em> is set to zero, NDIS will not schedule any DPCs. Otherwise,
NDIS will schedule DPCs regardless of the return value from
<em>MiniportInterrupt</em>.</p>

<p><strong>Note</strong> NDIS
6.20 and later drivers should not use this parameter to schedule DPCs. Instead, they should set this parameter to zero and use the
<a href="ndismqueuedpcex" title="KAFFINITY NdisMQueueDpcEx(&#10;  [in] IN NDIS_HANDLE     NdisInterruptHandle,&#10;  [in] IN ULONG           MessageId,&#10;  [in] IN PGROUP_AFFINITY TargetProcessors,&#10;  [in] IN PVOID           MiniportDpcContext&#10;);">NdisMQueueDpcEx</a> function to schedule DPCs.</p>

<h2 id="return-value">Return value</h2>

<p><em>MiniportInterrupt</em> returns one of the following values:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong><em>*TRUE</em></strong>*</td>
  <td><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_isr">MiniportInterrupt</a> determined that the underlying NIC generated the interrupt.</td>
</tr>
<tr>
  <td><strong><em>*FALSE</em></strong>*</td>
  <td><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_isr">MiniportInterrupt</a> determined that the underlying NIC did not generate the interrupt.</td>
</tr>
</tbody>
</table>

<p><strong>Note</strong> NDIS will queue DPCs based on the values that are specified in the
<em>QueueDefaultInterruptDpc</em> and
<em>TargetProcessors</em> parameters regardless of the value that
<em>MiniportInterrupt</em> returns. However,
<em>MiniportInterrupt</em> must still return the correct value.</p>

<h2 id="remarks">Remarks</h2>

<p>Miniport drivers that register an interrupt with the
<a href="ndismregisterinterruptex" title="NDIS_STATUS NdisMRegisterInterruptEx(&#10;  [in]  NDIS_HANDLE                              MiniportAdapterHandle,&#10;  [in]  NDIS_HANDLE                              MiniportInterruptContext,&#10;  [in]  PNDIS_MINIPORT_INTERRUPT_CHARACTERISTICS MiniportInterruptCharacteristics,&#10;  [out] PNDIS_HANDLE                             NdisInterruptHandle&#10;);">NdisMRegisterInterruptEx</a> function
must provide a
<em>MiniportInterrupt</em> function.</p>

<p>A miniport driver should do as little work as possible in its
<em>MiniportInterrupt</em> function. It should defer I/O operations for the interrupts
that the NIC generates to the
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_interrupt_dpc">MiniportInterruptDPC</a> function.</p>

<p>When an interrupt occurs on a NIC's interrupt line, NDIS calls the miniport driver's
<em>MiniportInterrupt</em> function.</p>

<p>All NICs can share line-based interrupts with other devices on the I/O bus. If the NIC did not
generate the interrupt,
<em>MiniportInterrupt</em> should return <strong>FALSE</strong> immediately so that the system can call
the driver of the device that generated the interrupt. If the
<em>QueueDefaultInterruptDpc</em> is set to <strong>FALSE</strong> and the
<em>TargetProcessors</em> parameter is set to zero, NDIS will not schedule any DPCs.
Otherwise, NDIS will schedule DPCs regardless of the re<em>MiniportInterrupt</em>turn value from
<em>MiniportInterrupt</em>.</p>

<p>If the interrupt is for the NIC,
<em>MiniportInterrupt</em> dismisses the interrupt on the NIC, saves whatever state it
must about the interrupt, and defers as much of the I/O processing as possible to the
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_interrupt_dpc">MiniportInterruptDPC</a> function.</p>

<p>If the underlying NIC generated the specified interrupt and the miniport driver will request deferred
procedure calls (DPCs), the miniport driver should disable all further interrupts from the NIC and
reenable the interrupts after all the DPCs are finished.</p>

<p>The miniport driver should set
<em>QueueDefaultInterruptDpc</em> to <strong>TRUE</strong> to schedule a DPC for the default CPU only.
The driver could do this, for example, if:</p>

<ul>
<li>The NIC generated the interrupt to signal the completion of a send operation, or any other request
that doesn't run on other CPUs.</li>
<li>The NIC generated the interrupt to signal received data and the miniport driver cannot process
received packets in separate DPCs.</li>
<li>The interrupt indicates received packets and the miniport driver can process received packets in
separate DPCs, but <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/ndis-receive-side-scaling2">receive side scaling (RSS)</a> is not enabled for the miniport driver. For more information,
see
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/oid-gen-receive-scale-capabilities">OID_GEN_RECEIVE_SCALE_CAPABILITIES</a> and
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/oid-gen-receive-scale-parameters">OID_GEN_RECEIVE_SCALE_PARAMETERS</a>.</li>
</ul>

<p>If a miniport driver processes received packets in separate DPCs, the driver sets the
<em>QueueDefaultInterruptDpc</em> parameter to <strong>FALSE</strong>. The miniport driver should set the
<em>TargetProcessors</em> bit for the CPU that is associated with each nonempty receive
queue. NDIS will schedule a DPC on each of the indicated CPUs.</p>

<p><strong>Note</strong> NDIS will queue DPCs based on the values that are specified in the
<em>QueueDefaultInterruptDpc</em> and
<em>TargetProcessors</em> parameters regardless of the value that
<em>MiniportInterrupt</em> returns. However,
<em>MiniportInterrupt</em> must still return the correct value.</p>

<p>If
<em>MiniportInterrupt</em> shares resources, such as NIC registers or state variables,
with another
<em>MiniportXxx</em> function that runs at a lower IRQL, that
<em>MiniportXxx</em> function must call the
<a href="ndismsynchronizewithinterruptex" title="BOOLEAN NdisMSynchronizeWithInterruptEx(&#10;  [in] NDIS_HANDLE                            NdisInterruptHandle,&#10;  [in] ULONG                                  MessageId,&#10;  [in] MINIPORT_SYNCHRONIZE_INTERRUPT_HANDLER SynchronizeFunction,&#10;  [in] PVOID                                  SynchronizeFunction,&#10;  [in] PVOID                                  SynchronizeContext&#10;);">NdisMSynchronizeWithInterruptEx</a> function. This ensures that the driver's
<em>MiniportSynchronizeInterrupt</em> function accesses the shared resources in a
synchronized and multiprocessor-safe manner.</p>

<p>A miniport driver can call the
<a href="ndismderegisterinterruptex" title="VOID NdisMDeregisterInterruptEx(&#10;  [in] NDIS_HANDLE NdisInterruptHandle&#10;);">NdisMDeregisterInterruptEx</a> function from its
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_initialize">MiniportInitializeEx</a> or
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_halt">MiniportHaltEx</a> function to release
resources that it allocated with
<a href="ndismregisterinterruptex" title="NDIS_STATUS NdisMRegisterInterruptEx(&#10;  [in]  NDIS_HANDLE                              MiniportAdapterHandle,&#10;  [in]  NDIS_HANDLE                              MiniportInterruptContext,&#10;  [in]  PNDIS_MINIPORT_INTERRUPT_CHARACTERISTICS MiniportInterruptCharacteristics,&#10;  [out] PNDIS_HANDLE                             NdisInterruptHandle&#10;);">NdisMRegisterInterruptEx</a>. After
<strong><a href="ndismderegisterinterruptex" title="VOID NdisMDeregisterInterruptEx(&#10;  [in] NDIS_HANDLE NdisInterruptHandle&#10;);">NdisMDeregisterInterruptEx</a></strong> returns, NDIS does not call a miniport
driver's
<em>MiniportInterrupt</em> or
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_interrupt_dpc">MiniportInterruptDPC</a> function.</p>

<p>NDIS calls
<em>MiniportInterrupt</em> at the DIRQL of the interrupt that the miniport driver
registered in a previous call to
<a href="ndismregisterinterruptex" title="NDIS_STATUS NdisMRegisterInterruptEx(&#10;  [in]  NDIS_HANDLE                              MiniportAdapterHandle,&#10;  [in]  NDIS_HANDLE                              MiniportInterruptContext,&#10;  [in]  PNDIS_MINIPORT_INTERRUPT_CHARACTERISTICS MiniportInterruptCharacteristics,&#10;  [out] PNDIS_HANDLE                             NdisInterruptHandle&#10;);">NdisMRegisterInterruptEx</a>. Therefore,
<em>MiniportInterrupt</em> must call the subset of the NDIS functions, such as the
<strong>NdisRaw<em></strong>Xxx</em> or
<strong>NdisRead/WriteRegister<em></strong>Xxx</em> functions, that are safe to call at any IRQL.</p>

<h3 id="examples">Examples</h3>

<p>To define a <em>MiniportInterrupt</em> function, you must first provide a function declaration that identifies the type of function you're defining. Windows provides a set of function types for drivers. Declaring a function using the function types helps <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/code-analysis-for-drivers">Code Analysis for Drivers</a>, <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/static-driver-verifier">Static Driver Verifier</a> (SDV), and other verification tools find errors, and it's a requirement for writing drivers for the Windows operating system.</p>

<p>For example, to define a <em>MiniportInterrupt</em> function that is named "MyInterrupt", use the <strong>MINIPORT_ISR</strong> type as shown in this code example:</p>

<pre><code>MINIPORT_ISR MyInterrupt;
</code></pre>

<p>Then, implement your function as follows:</p>

<pre><code>_Use_decl_annotations_
BOOLEAN
 MyInterrupt(
    NDIS_HANDLE  MiniportInterruptContext,
    PBOOLEAN  QueueDefaultInterruptDpc,
    PULONG  TargetProcessors
    )
  {...}
</code></pre>

<p>The <strong>MINIPORT_ISR</strong> function type is defined in the Ndis.h header file. To more accurately identify errors when you run the code analysis tools, be sure to add the _Use_decl_annotations_ annotation to your function definition. The _Use_decl_annotations_ annotation ensures that the annotations that are applied to the <strong>MINIPORT_ISR</strong> function type in the header file are used. For more information about the requirements for function declarations, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/declaring-functions-by-using-function-role-types-for-ndis-drivers">Declaring Functions by Using Function Role Types for NDIS Drivers</a>.</p>

<p>For information about _Use_decl_annotations_, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/visualstudio/code-quality/annotating-function-behavior">Annotating Function Behavior</a>.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_halt">MiniportHaltEx</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_initialize">MiniportInitializeEx</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_interrupt_dpc">MiniportInterruptDPC</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_synchronize_interrupt">MiniportSynchronizeInterrupt</a></p>

<p><a href="ndis_miniport_interrupt_characteristics" title="typedef struct _NDIS_MINIPORT_INTERRUPT_CHARACTERISTICS {&#10;  NDIS_OBJECT_HEADER                     Header;&#10;  MINIPORT_ISR_HANDLER                   InterruptHandler;&#10;  MINIPORT_INTERRUPT_DPC_HANDLER         InterruptDpcHandler;&#10;  MINIPORT_DISABLE_INTERRUPT_HANDLER     DisableInterruptHandler;&#10;  MINIPORT_ENABLE_INTERRUPT_HANDLER      EnableInterruptHandler;&#10;  BOOLEAN                                MsiSupported;&#10;  BOOLEAN                                MsiSyncWithAllMessages;&#10;  MINIPORT_MSI_ISR_HANDLER               MessageInterruptHandler;&#10;  MINIPORT_MSI_INTERRUPT_DPC_HANDLER     MessageInterruptDpcHandler;&#10;  MINIPORT_DISABLE_MSI_INTERRUPT_HANDLER DisableMessageInterruptHandler;&#10;  MINIPORT_ENABLE_MSI_INTERRUPT_HANDLER  EnableMessageInterruptHandler;&#10;  NDIS_INTERRUPT_TYPE                    InterruptType;&#10;  PIO_INTERRUPT_MESSAGE_INFO             MessageInfoTable;&#10;} NDIS_MINIPORT_INTERRUPT_CHARACTERISTICS, *PNDIS_MINIPORT_INTERRUPT_CHARACTERISTICS;">NDIS_MINIPORT_INTERRUPT_CHARACTERISTICS</a></p>

<p><a href="ndismderegisterinterruptex" title="VOID NdisMDeregisterInterruptEx(&#10;  [in] NDIS_HANDLE NdisInterruptHandle&#10;);">NdisMDeregisterInterruptEx</a></p>

<p><a href="ndismqueuedpcex" title="KAFFINITY NdisMQueueDpcEx(&#10;  [in] IN NDIS_HANDLE     NdisInterruptHandle,&#10;  [in] IN ULONG           MessageId,&#10;  [in] IN PGROUP_AFFINITY TargetProcessors,&#10;  [in] IN PVOID           MiniportDpcContext&#10;);">NdisMQueueDpcEx</a></p>

<p><a href="ndismregisterinterruptex" title="NDIS_STATUS NdisMRegisterInterruptEx(&#10;  [in]  NDIS_HANDLE                              MiniportAdapterHandle,&#10;  [in]  NDIS_HANDLE                              MiniportInterruptContext,&#10;  [in]  PNDIS_MINIPORT_INTERRUPT_CHARACTERISTICS MiniportInterruptCharacteristics,&#10;  [out] PNDIS_HANDLE                             NdisInterruptHandle&#10;);">NdisMRegisterInterruptEx</a></p>

<p><a href="ndismsynchronizewithinterruptex" title="BOOLEAN NdisMSynchronizeWithInterruptEx(&#10;  [in] NDIS_HANDLE                            NdisInterruptHandle,&#10;  [in] ULONG                                  MessageId,&#10;  [in] MINIPORT_SYNCHRONIZE_INTERRUPT_HANDLER SynchronizeFunction,&#10;  [in] PVOID                                  SynchronizeFunction,&#10;  [in] PVOID                                  SynchronizeContext&#10;);">NdisMSynchronizeWithInterruptEx</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/oid-gen-receive-scale-capabilities">OID_GEN_RECEIVE_SCALE_CAPABILITIES</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/oid-gen-receive-scale-parameters">OID_GEN_RECEIVE_SCALE_PARAMETERS</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/ndis-receive-side-scaling2">Receive Side Scaling (RSS)</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_isr">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ndis/nc-ndis-miniport_isr.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
