<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="IOCTL_EHSTOR_BANDMGMT_SET_BAND_SECURITY - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>IOCTL_EHSTOR_BANDMGMT_SET_BAND_SECURITY - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            IOCTL_EHSTOR_BANDMGMT_SET_BAND_SECURITY - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ehstorbandmgmt.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x002d, 0x526, METHOD_BUFFERED, FILE_READ_ACCESS | FILE_WRITE_ACCESS)
#define IOCTL_EHSTOR_BANDMGMT_SET_BAND_SECURITY 0x002DD498</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ehstorbandmgmt/ni-ehstorbandmgmt-ioctl_ehstor_bandmgmt_set_band_security">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ioctl_ehstor_bandmgmt_set_band_security.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ni-ehstorbandmgmt-ioctl_ehstor_bandmgmt_set_band_security)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1>IOCTL_EHSTOR_BANDMGMT_SET_BAND_SECURITY IOCTL</h1>
<h2>Description</h2>
<p>The security properties of bands in a band-managed storage device are modified with the <strong>IOCTL_EHSTOR_BANDMGMT_SET_BAND_SECURITY</strong> request.</p>
<h2>Parameters</h2>
<h3>Major code</h3>
<h3>Input buffer</h3>
<p>The buffer at <em>Irp-&gt;AssociatedIrp.SystemBuffer</em> must contain a  <a href="set_band_security_parameters" title="typedef struct _SET_BAND_SECURITY_PARAMETERS {&#10;  ULONG         StructSize;&#10;  ULONG         Flags;&#10;  ULONG         Reserved;&#10;  ULONG         BandId;&#10;  LARGE_INTEGER BandStart;&#10;  ULONG         CurrentAuthKeyOffset;&#10;  ULONG         NewAuthKeyOffset;&#10;  ULONG         BandSecurityInfoOffset;&#10;} SET_BAND_SECURITY_PARAMETERS, *PSET_BAND_SECURITY_PARAMETERS;">SET_BAND_SECURITY_PARAMETERS</a> structure followed by the <strong>AUTH_KEY</strong> and <a href="band_security_info" title="typedef struct _BAND_SECURITY_INFO {&#10;  ULONG      StructSize;&#10;  LOCKSTATE  ReadLock;&#10;  LOCKSTATE  WriteLock;&#10;  ALGOIDTYPE CryptoAlgoIdType;&#10;  union {&#10;    struct {&#10;      ULONG Offset;&#10;      ULONG Length;&#10;    } CryptoAlgoOidString;&#10;    ULONG CryptoAlgoNumericId;&#10;  };&#10;  BYTE       Metadata[32];&#10;} BAND_SECURITY_INFO, *PBAND_SECURITY_INFO;">BAND_SECURITY_INFO</a> structures.</p>
<p>If the <strong>AuthKeyOffset</strong> member of <a href="set_band_security_parameters" title="typedef struct _SET_BAND_SECURITY_PARAMETERS {&#10;  ULONG         StructSize;&#10;  ULONG         Flags;&#10;  ULONG         Reserved;&#10;  ULONG         BandId;&#10;  LARGE_INTEGER BandStart;&#10;  ULONG         CurrentAuthKeyOffset;&#10;  ULONG         NewAuthKeyOffset;&#10;  ULONG         BandSecurityInfoOffset;&#10;} SET_BAND_SECURITY_PARAMETERS, *PSET_BAND_SECURITY_PARAMETERS;">SET_BAND_SECURITY_PARAMETERS</a> is set to <strong>EHSTOR_BANDMGR_NO_KEY</strong>, the input data in the system buffer need not include an <strong>AUTH_KEY</strong> structure. Also, if a new authentication key is not given, no updated key structure is included.</p>
<h3>Input buffer length</h3>
<p><em>Parameters.DeviceIoControl.InputBufferLength</em> indicates the size, in bytes, of the buffer, which must be at least <strong>sizeof</strong> (<a href="set_band_security_parameters" title="typedef struct _SET_BAND_SECURITY_PARAMETERS {&#10;  ULONG         StructSize;&#10;  ULONG         Flags;&#10;  ULONG         Reserved;&#10;  ULONG         BandId;&#10;  LARGE_INTEGER BandStart;&#10;  ULONG         CurrentAuthKeyOffset;&#10;  ULONG         NewAuthKeyOffset;&#10;  ULONG         BandSecurityInfoOffset;&#10;} SET_BAND_SECURITY_PARAMETERS, *PSET_BAND_SECURITY_PARAMETERS;">SET_BAND_SECURITY_PARAMETERS</a>) + 2 * <strong>sizeof</strong>(AUTH_KEY) + <strong>sizeof</strong>(<a href="band_security_info" title="typedef struct _BAND_SECURITY_INFO {&#10;  ULONG      StructSize;&#10;  LOCKSTATE  ReadLock;&#10;  LOCKSTATE  WriteLock;&#10;  ALGOIDTYPE CryptoAlgoIdType;&#10;  union {&#10;    struct {&#10;      ULONG Offset;&#10;      ULONG Length;&#10;    } CryptoAlgoOidString;&#10;    ULONG CryptoAlgoNumericId;&#10;  };&#10;  BYTE       Metadata[32];&#10;} BAND_SECURITY_INFO, *PBAND_SECURITY_INFO;">BAND_SECURITY_INFO</a>) when all input structures are required.</p>
<h3>Output buffer</h3>
<p>None.</p>
<h3>Output buffer length</h3>
<p>None.</p>
<h3>Input/output buffer</h3>
<h3>Input/output buffer length</h3>
<h3>Status block</h3>
<p>One of the following values can be returned in the <strong>Status</strong> field.</p>
<table>
<thead>
<tr>
<th>Status Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></td>
<td>Security properties for the band were changed.</td>
</tr>
<tr>
<td>STATUS_INVALID_DEVICE_REQUEST</td>
<td>The storage device does not support band management.</td>
</tr>
<tr>
<td>STATUS_INVALID_BUFFER_SIZE</td>
<td>The input buffer size is invalid.</td>
</tr>
<tr>
<td>STATUS_INVALID_PARAMETER</td>
<td>Information in the input buffer is invalid.</td>
</tr>
<tr>
<td>STATUS_NOT_FOUND</td>
<td>A band was not found for the selection criteria provided.</td>
</tr>
<tr>
<td>STATUS_ACCESS_DENIED</td>
<td>The authentication key provided is not valid.</td>
</tr>
<tr>
<td>STATUS_IO_DEVICE_ERROR</td>
<td>Communication failed. The storage device might be incompatible with security protocols.</td>
</tr>
</tbody>
</table>
<h2>Remarks</h2>
<p>Read and write locking and unlocking for bands are set with this IOCTL in the <a href="band_security_info" title="typedef struct _BAND_SECURITY_INFO {&#10;  ULONG      StructSize;&#10;  LOCKSTATE  ReadLock;&#10;  LOCKSTATE  WriteLock;&#10;  ALGOIDTYPE CryptoAlgoIdType;&#10;  union {&#10;    struct {&#10;      ULONG Offset;&#10;      ULONG Length;&#10;    } CryptoAlgoOidString;&#10;    ULONG CryptoAlgoNumericId;&#10;  };&#10;  BYTE       Metadata[32];&#10;} BAND_SECURITY_INFO, *PBAND_SECURITY_INFO;">BAND_SECURITY_INFO</a> structure included as input in the system buffer.</p>
<p>Authentication key changes will not affect the lock state of the band. It is not necessary to unmount a volume to change an authentication key with this request.</p>
<p>When a band is unlocked, meaning either the <strong>Readlock</strong> or <strong>WriteLock</strong> members of <a href="band_security_info" title="typedef struct _BAND_SECURITY_INFO {&#10;  ULONG      StructSize;&#10;  LOCKSTATE  ReadLock;&#10;  LOCKSTATE  WriteLock;&#10;  ALGOIDTYPE CryptoAlgoIdType;&#10;  union {&#10;    struct {&#10;      ULONG Offset;&#10;      ULONG Length;&#10;    } CryptoAlgoOidString;&#10;    ULONG CryptoAlgoNumericId;&#10;  };&#10;  BYTE       Metadata[32];&#10;} BAND_SECURITY_INFO, *PBAND_SECURITY_INFO;">BAND_SECURITY_INFO</a> are FALSE, the silo driver will cache the provided authentication key if <strong>SETBANDSEC_AUTHKEY_CACHING_ENABLED</strong> is set in the <strong>Flags</strong> member of <a href="set_band_security_parameters" title="typedef struct _SET_BAND_SECURITY_PARAMETERS {&#10;  ULONG         StructSize;&#10;  ULONG         Flags;&#10;  ULONG         Reserved;&#10;  ULONG         BandId;&#10;  LARGE_INTEGER BandStart;&#10;  ULONG         CurrentAuthKeyOffset;&#10;  ULONG         NewAuthKeyOffset;&#10;  ULONG         BandSecurityInfoOffset;&#10;} SET_BAND_SECURITY_PARAMETERS, *PSET_BAND_SECURITY_PARAMETERS;">SET_BAND_SECURITY_PARAMETERS</a>.</p>
<p>As a special case, this IOCTL can be used to notify the silo driver that a band was unlocked without the use of the locking members in <a href="band_security_info" title="typedef struct _BAND_SECURITY_INFO {&#10;  ULONG      StructSize;&#10;  LOCKSTATE  ReadLock;&#10;  LOCKSTATE  WriteLock;&#10;  ALGOIDTYPE CryptoAlgoIdType;&#10;  union {&#10;    struct {&#10;      ULONG Offset;&#10;      ULONG Length;&#10;    } CryptoAlgoOidString;&#10;    ULONG CryptoAlgoNumericId;&#10;  };&#10;  BYTE       Metadata[32];&#10;} BAND_SECURITY_INFO, *PBAND_SECURITY_INFO;">BAND_SECURITY_INFO</a>. To do this, the <strong>NewAuthKeyOffset</strong> member of <a href="set_band_security_parameters" title="typedef struct _SET_BAND_SECURITY_PARAMETERS {&#10;  ULONG         StructSize;&#10;  ULONG         Flags;&#10;  ULONG         Reserved;&#10;  ULONG         BandId;&#10;  LARGE_INTEGER BandStart;&#10;  ULONG         CurrentAuthKeyOffset;&#10;  ULONG         NewAuthKeyOffset;&#10;  ULONG         BandSecurityInfoOffset;&#10;} SET_BAND_SECURITY_PARAMETERS, *PSET_BAND_SECURITY_PARAMETERS;">SET_BAND_SECURITY_PARAMETERS</a> is set to <strong>CurrentAuthKeyOffset</strong> with <strong>BandSecurityInfoOffset</strong> set to 0. In this case, no security changes occur, but the key provided at <strong>CurrentAuthKeyOffset</strong> is cached in memory, provided that <strong>SETBANDSEC_AUTHKEY_CACHING_ENABLED</strong> is set in <strong>Flags</strong>.</p>
<p>The changes made to the band table by this request are committed to the device atomically before the IOCTL request completes. Therefore, it is guaranteed that the band is modified with all of its properties set or no properties set at all should a system or power failure occur.</p>
<h2>See also</h2>
<p><a href="band_security_info" title="typedef struct _BAND_SECURITY_INFO {&#10;  ULONG      StructSize;&#10;  LOCKSTATE  ReadLock;&#10;  LOCKSTATE  WriteLock;&#10;  ALGOIDTYPE CryptoAlgoIdType;&#10;  union {&#10;    struct {&#10;      ULONG Offset;&#10;      ULONG Length;&#10;    } CryptoAlgoOidString;&#10;    ULONG CryptoAlgoNumericId;&#10;  };&#10;  BYTE       Metadata[32];&#10;} BAND_SECURITY_INFO, *PBAND_SECURITY_INFO;">BAND_SECURITY_INFO</a></p>
<p><a href="ioctl_ehstor_bandmgmt_delete_band" title="// CTL_CODE(0x002d, 0x529, METHOD_BUFFERED, FILE_READ_ACCESS | FILE_WRITE_ACCESS)&#10;#define IOCTL_EHSTOR_BANDMGMT_DELETE_BAND 0x002DD4A4">IOCTL_EHSTOR_BANDMGMT_DELETE_BAND</a></p>
<p><a href="set_band_security_parameters" title="typedef struct _SET_BAND_SECURITY_PARAMETERS {&#10;  ULONG         StructSize;&#10;  ULONG         Flags;&#10;  ULONG         Reserved;&#10;  ULONG         BandId;&#10;  LARGE_INTEGER BandStart;&#10;  ULONG         CurrentAuthKeyOffset;&#10;  ULONG         NewAuthKeyOffset;&#10;  ULONG         BandSecurityInfoOffset;&#10;} SET_BAND_SECURITY_PARAMETERS, *PSET_BAND_SECURITY_PARAMETERS;">SET_BAND_SECURITY_PARAMETERS</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ehstorbandmgmt/ni-ehstorbandmgmt-ioctl_ehstor_bandmgmt_set_band_security">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ehstorbandmgmt/ni-ehstorbandmgmt-ioctl_ehstor_bandmgmt_set_band_security.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
