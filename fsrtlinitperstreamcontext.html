<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="FsRtlInitPerStreamContext - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>FsRtlInitPerStreamContext - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            FsRtlInitPerStreamContext - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">void FsRtlInitPerStreamContext(
  _fc,
  _owner,
  _inst,
  _cb
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-fsrtlinitperstreamcontext">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/fsrtlinitperstreamcontext.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ntifs-fsrtlinitperstreamcontext)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1>FsRtlInitPerStreamContext macro</h1>
<h2>Description</h2>
<p>The <strong>FsRtlInitPerStreamContext</strong> macro initializes a filter driver context structure.</p>
<h2>Parameters</h2>
<h3><code>_fc</code></h3>
<p>Pointer to a caller-allocated <a href="fsrtl_per_stream_context" title="typedef struct _FSRTL_PER_STREAM_CONTEXT {&#10;  LIST_ENTRY     Links;&#10;  PVOID          OwnerId;&#10;  PVOID          InstanceId;&#10;  PFREE_FUNCTION FreeCallback;&#10;} FSRTL_PER_STREAM_CONTEXT, *PFSRTL_PER_STREAM_CONTEXT;">FSRTL_PER_STREAM_CONTEXT</a> structure to be used to maintain context information for a file stream. This structure can be used as is or embedded in a driver-defined per-stream context structure. Both structure types are commonly allocated by calling <strong><a href="exallocatepoolwithtag" title="PVOID ExAllocatePoolWithTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithTag</a></strong>.</p>
<h3><code>_owner</code></h3>
<p>Pointer to a caller-allocated variable that uniquely identifies the owner of the per-stream context structure. The format of this variable is filter driver − specific. Filter writers should choose a value that is both meaningful and convenient, such as the address of a driver object or device object. Callers must specify a non-<strong>NULL</strong> value for this parameter.</p>
<h3><code>_inst</code></h3>
<p>Pointer to a filter driver − allocated variable that can be used to distinguish among per-stream context structures created by the same filter driver. The format of this variable is filter driver − specific. Filter writers should choose a value that is both meaningful and convenient, such as the address of the stream context object for the file stream. (To get this address from a file object, use the <strong><a href="fsrtlgetperstreamcontextpointer" title="void FsRtlGetPerStreamContextPointer(&#10;  _fo&#10;);">FsRtlGetPerStreamContextPointer</a></strong> macro.) This parameter is optional and can be <strong>NULL</strong>.</p>
<h3><code>_cb</code></h3>
<p>Pointer to a callback routine that frees the per-stream context structure. Callers must specify a non-<strong>NULL</strong> value for this parameter. This routine and its parameters are defined as follows:</p>
<table>
<thead>
<tr>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>typedef VOID (*<a href="pfree_function" title="typedef VOID ( *FreeCallback)(&#10;  _In_ PVOID Buffer&#10;);">PFREE_FUNCTION</a>) (           IN PVOID Buffer           );</code></td>
</tr>
</tbody>
</table>
<p><em>Buffer</em></p>
<p>Pointer to the per-stream context structure to be freed. The <em>FreeCallback</em> routine typically casts this pointer to the appropriate structure pointer type and frees it by calling <strong><a href="exfreepool" title="void ExFreePool(&#10;  a&#10;);">ExFreePool</a></strong>.</p>
<h2>Remarks</h2>
<p>A file system filter driver uses the <strong>FsRtlInitPerStreamContext</strong> macro to initialize a newly allocated per-stream context structure before associating it with a file stream. The initialized context structure can be passed as a parameter to <a href="fsrtlinsertperstreamcontext" title="NTSTATUS FsRtlInsertPerStreamContext(&#10;       PFSRTL_ADVANCED_FCB_HEADER PerStreamContext,&#10;  [in] PFSRTL_PER_STREAM_CONTEXT  Ptr&#10;);">FsRtlInsertPerStreamContext</a>.</p>
<p><strong>FsRtlInitPerStreamContext</strong> stores the address of the <em>FreeCallback</em> routine in the <strong>FreeCallback</strong> member of the <a href="fsrtl_per_stream_context" title="typedef struct _FSRTL_PER_STREAM_CONTEXT {&#10;  LIST_ENTRY     Links;&#10;  PVOID          OwnerId;&#10;  PVOID          InstanceId;&#10;  PFREE_FUNCTION FreeCallback;&#10;} FSRTL_PER_STREAM_CONTEXT, *PFSRTL_PER_STREAM_CONTEXT;">FSRTL_PER_STREAM_CONTEXT</a> structure.</p>
<p>The <em>FreeCallback</em> routine is called at IRQL &lt;= APC_LEVEL. Usually, it is called at IRQL PASSIVE_LEVEL.</p>
<p><strong>Note</strong> The <em>FreeCallback</em> routine cannot recursively call down into the file system or acquire any file system resources. Also, this routine must assume that the file object for the file stream has already been freed.</p>
<p>To associate an initialized per-stream context structure with a file stream, call <a href="fsrtlinsertperstreamcontext" title="NTSTATUS FsRtlInsertPerStreamContext(&#10;       PFSRTL_ADVANCED_FCB_HEADER PerStreamContext,&#10;  [in] PFSRTL_PER_STREAM_CONTEXT  Ptr&#10;);">FsRtlInsertPerStreamContext</a>.</p>
<p>After the context structure has been associated with a file stream, it can be retrieved by calling <a href="fsrtllookupperstreamcontext" title="void FsRtlLookupPerStreamContext(&#10;  _sc,&#10;  _oid,&#10;  _iid&#10;);">FsRtlLookupPerStreamContext</a> or removed by calling <a href="fsrtlremoveperstreamcontext" title="PFSRTL_PER_STREAM_CONTEXT FsRtlRemovePerStreamContext(&#10;  [in]           PFSRTL_ADVANCED_FCB_HEADER StreamContext,&#10;  [in, optional] PVOID                      OwnerId,&#10;  [in, optional] PVOID                      InstanceId&#10;);">FsRtlRemovePerStreamContext</a>.</p>
<p>For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ifs/tracking-per-stream-context-in-a-legacy-file-system-filter-driver">Tracking Per-Stream Context in a Legacy File System Filter Driver</a>.</p>
<h2>See also</h2>
<p><a href="exallocatepoolwithtag" title="PVOID ExAllocatePoolWithTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithTag</a></p>
<p><a href="exfreepool" title="void ExFreePool(&#10;  a&#10;);">ExFreePool</a></p>
<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/ff547357(v=vs.85)">FSRTL_PER_STREAM_CONTEXT</a></p>
<p><a href="fsrtlgetperstreamcontextpointer" title="void FsRtlGetPerStreamContextPointer(&#10;  _fo&#10;);">FsRtlGetPerStreamContextPointer</a></p>
<p><a href="fsrtlinsertperstreamcontext" title="NTSTATUS FsRtlInsertPerStreamContext(&#10;       PFSRTL_ADVANCED_FCB_HEADER PerStreamContext,&#10;  [in] PFSRTL_PER_STREAM_CONTEXT  Ptr&#10;);">FsRtlInsertPerStreamContext</a></p>
<p><a href="fsrtllookupperstreamcontext" title="void FsRtlLookupPerStreamContext(&#10;  _sc,&#10;  _oid,&#10;  _iid&#10;);">FsRtlLookupPerStreamContext</a></p>
<p><a href="fsrtlremoveperstreamcontext" title="PFSRTL_PER_STREAM_CONTEXT FsRtlRemovePerStreamContext(&#10;  [in]           PFSRTL_ADVANCED_FCB_HEADER StreamContext,&#10;  [in, optional] PVOID                      OwnerId,&#10;  [in, optional] PVOID                      InstanceId&#10;);">FsRtlRemovePerStreamContext</a></p>
<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/ff547257(v=vs.85)">FsRtlSetupAdvancedHeader</a></p>
<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/ff547285(v=vs.85)">FsRtlSupportsPerStreamContexts</a></p>
<p><a href="fsrtlteardownperstreamcontexts" title="VOID FsRtlTeardownPerStreamContexts(&#10;  [in] PFSRTL_ADVANCED_FCB_HEADER AdvancedHeader&#10;);">FsRtlTeardownPerStreamContexts</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-fsrtlinitperstreamcontext">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/nf-ntifs-fsrtlinitperstreamcontext.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
