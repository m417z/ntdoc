<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="FSCTL_GET_VOLUME_BITMAP - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>FSCTL_GET_VOLUME_BITMAP - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            FSCTL_GET_VOLUME_BITMAP - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x0009, 0x01b, METHOD_NEITHER, FILE_ANY_ACCESS)
#define FSCTL_GET_VOLUME_BITMAP 0x0009006F</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ni-ntifs-fsctl_get_volume_bitmap">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// winioctl.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x0009, 0x01b, METHOD_NEITHER, FILE_ANY_ACCESS)
#define FSCTL_GET_VOLUME_BITMAP 0x0009006F</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows/win32/api/winioctl/ni-winioctl-fsctl_get_volume_bitmap">View the official Win32 API reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/fsctl_get_volume_bitmap.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ni-ntifs-fsctl_get_volume_bitmap)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2>Description</h2>
<p>The <strong>FSCTL_GET_VOLUME_BITMAP</strong> control code retrieves a bitmap of occupied and available clusters on a volume.</p>
<h2>Parameters</h2>
<h3>Major code</h3>
<p>FSCTL_GET_VOLUME_BITMAP</p>
<h3>Input buffer</h3>
<h3>Input buffer length</h3>
<h3>Output buffer</h3>
<h3>Output buffer length</h3>
<h3>Input/output buffer</h3>
<h3>Input/output buffer length</h3>
<h3>Status block</h3>
<h2>Remarks</h2>
<p>To perform this operation, call <strong><a href="fltfscontrolfile" title="NTSTATUS FLTAPI FltFsControlFile(&#10;  [in]            PFLT_INSTANCE Instance,&#10;  [in]            PFILE_OBJECT  FileObject,&#10;  [in]            ULONG         FsControlCode,&#10;  [in, optional]  PVOID         InputBuffer,&#10;  [in]            ULONG         InputBufferLength,&#10;  [out, optional] PVOID         OutputBuffer,&#10;  [in]            ULONG         OutputBufferLength,&#10;  [out, optional] PULONG        LengthReturned&#10;);">FltFsControlFile</a></strong> or <strong><a href="ntfscontrolfile" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtFsControlFile(&#10;    _In_ HANDLE FileHandle,&#10;    _In_opt_ HANDLE Event,&#10;    _In_opt_ PIO_APC_ROUTINE ApcRoutine,&#10;    _In_opt_ PVOID ApcContext,&#10;    _Out_ PIO_STATUS_BLOCK IoStatusBlock,&#10;    _In_ ULONG FsControlCode,&#10;    _In_reads_bytes_opt_(InputBufferLength) PVOID InputBuffer,&#10;    _In_ ULONG InputBufferLength,&#10;    _Out_writes_bytes_opt_(OutputBufferLength) PVOID OutputBuffer,&#10;    _In_ ULONG OutputBufferLength&#10;    );">ZwFsControlFile</a></strong>.</p>
<p>See <a href="https://learn.microsoft.com/windows/win32/api/winioctl/ni-winioctl-fsctl_get_volume_bitmap">FSCTL_GET_VOLUME_BITMAP IOCTL (winioctl.h)</a>.</p>
<h2>See also</h2>
<p><strong><a href="fltfscontrolfile" title="NTSTATUS FLTAPI FltFsControlFile(&#10;  [in]            PFLT_INSTANCE Instance,&#10;  [in]            PFILE_OBJECT  FileObject,&#10;  [in]            ULONG         FsControlCode,&#10;  [in, optional]  PVOID         InputBuffer,&#10;  [in]            ULONG         InputBufferLength,&#10;  [out, optional] PVOID         OutputBuffer,&#10;  [in]            ULONG         OutputBufferLength,&#10;  [out, optional] PULONG        LengthReturned&#10;);">FltFsControlFile</a></strong></p>
<p><strong><a href="ntfscontrolfile" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtFsControlFile(&#10;    _In_ HANDLE FileHandle,&#10;    _In_opt_ HANDLE Event,&#10;    _In_opt_ PIO_APC_ROUTINE ApcRoutine,&#10;    _In_opt_ PVOID ApcContext,&#10;    _Out_ PIO_STATUS_BLOCK IoStatusBlock,&#10;    _In_ ULONG FsControlCode,&#10;    _In_reads_bytes_opt_(InputBufferLength) PVOID InputBuffer,&#10;    _In_ ULONG InputBufferLength,&#10;    _Out_writes_bytes_opt_(OutputBufferLength) PVOID OutputBuffer,&#10;    _In_ ULONG OutputBufferLength&#10;    );">ZwFsControlFile</a></strong></p>
<p><strong><a href="volume_bitmap_buffer" title="typedef struct {&#10;  LARGE_INTEGER StartingLcn;&#10;  LARGE_INTEGER BitmapSize;&#10;  UCHAR         Buffer[1];&#10;} VOLUME_BITMAP_BUFFER, *PVOLUME_BITMAP_BUFFER;">VOLUME_BITMAP_BUFFER</a></strong></p>
<p><strong><a href="starting_lcn_input_buffer" title="typedef struct {&#10;  LARGE_INTEGER StartingLcn;&#10;} STARTING_LCN_INPUT_BUFFER, *PSTARTING_LCN_INPUT_BUFFER;">STARTING_LCN_INPUT_BUFFER</a></strong></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ni-ntifs-fsctl_get_volume_bitmap">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/ni-ntifs-fsctl_get_volume_bitmap.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Win32 API reference (ni-winioctl-fsctl_get_volume_bitmap)</h1>
</div>
<div class="ntdoc-description">
<h1>FSCTL_GET_VOLUME_BITMAP IOCTL</h1>
<h2>Description</h2>
<p>Retrieves a bitmap of occupied and available clusters on a volume.</p>
<p>To perform this operation, call the <a href="https://learn.microsoft.com/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol"><strong>DeviceIoControl</strong></a> function with the following parameters.</p>
<pre lang="cpp"><code>BOOL DeviceIoControl(
  (HANDLE) hDevice,             // handle to volume
  FSCTL_GET_VOLUME_BITMAP,      // dwIoControlCode
  (LPVOID) lpInBuffer,          // input buffer
  (<a href="dword" title="typedef unsigned long DWORD;">DWORD</a>) nInBufferSize,        // size of input buffer
  (LPVOID) lpOutBuffer,         // output buffer
  (<a href="dword" title="typedef unsigned long DWORD;">DWORD</a>) nOutBufferSize,       // size of output buffer
  (LPDWORD) lpBytesReturned,    // number of bytes returned
  (LPOVERLAPPED) lpOverlapped   // OVERLAPPED structure
);
</code></pre>
<h2>Parameters</h2>
<h3>Input buffer</h3>
<h3>Input buffer length</h3>
<h3>Output buffer</h3>
<h3>Output buffer length</h3>
<h3>Input/output buffer</h3>
<h3>Input/output buffer length</h3>
<h3>Status block</h3>
<p>Irp-&gt;IoStatus.Status is set to <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the request is successful.</p>
<p>Otherwise, Status to the appropriate error condition as a <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> code.</p>
<p>For more information, see <a href="https://learn.microsoft.com/windows-hardware/drivers/kernel/ntstatus-values">NTSTATUS Values</a>.</p>
<h2>Remarks</h2>
<p>The <strong>FSCTL_GET_VOLUME_BITMAP</strong> control code retrieves a data structure that describes the allocation state of each cluster in the file system from the requested starting LCN to the last cluster on the volume. The bitmap uses one bit to represent each cluster:</p>
<ul>
<li>The value 1 indicates that the cluster is allocated (in use).</li>
<li>The value 0 indicates that the cluster is not allocated (free).</li>
</ul>
<p>Note that the bitmap represents a point in time, and can be incorrect as soon as it has been read if the volume has write activity. Thus, it is possible to attempt to move a cluster onto an allocated cluster in spite of a recent bitmap indicating that the cluster is unallocated. Programs using the <a href="https://learn.microsoft.com/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">DeviceIoControl</a> function with the <a href="fsctl_move_file" title="// CTL_CODE(0x0009, 0x01d, METHOD_BUFFERED, FILE_ANY_ACCESS)&#10;#define FSCTL_MOVE_FILE 0x00090074">FSCTL_MOVE_FILE</a> control code must be prepared for this possibility.</p>
<p>The handle used here must be a Volume handle and have been opened with any access. Note that only Administrators can open Volume handles.</p>
<p>The starting LCN in the input buffer may be rounded down before the bitmap is calculated. The rounding limit is file system dependent.</p>
<p>For the implications of overlapped I/O on this operation, see the Remarks section of the <a href="https://learn.microsoft.com/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">DeviceIoControl</a> topic.</p>
<p>This operation aligns the bitmap it returns on a page boundary.</p>
<p><strong>Windows Server 2003 and Windows XP:</strong> This operation aligns the bitmap it returns on a byte boundary.</p>
<p>In Windows 8 and Windows Server 2012, this code is supported by the following technologies.</p>
<table>
<thead>
<tr>
<th>Technology</th>
<th>Supported</th>
</tr>
</thead>
<tbody>
<tr>
<td>Server Message Block (SMB) 3.0 protocol</td>
<td>No</td>
</tr>
<tr>
<td>SMB 3.0 Transparent Failover (TFO)</td>
<td>No</td>
</tr>
<tr>
<td>SMB 3.0 with Scale-out File Shares (SO)</td>
<td>No</td>
</tr>
<tr>
<td>Cluster Shared Volume File System (CsvFS)</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<h2>See also</h2>
<ul>
<li><a href="https://learn.microsoft.com/windows/win32/api/fileapi/nf-fileapi-createfilea">CreateFile</a></li>
<li><a href="https://learn.microsoft.com/windows/desktop/FileIO/defragmenting-files">Defragmentation</a></li>
<li><a href="https://learn.microsoft.com/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">DeviceIoControl</a></li>
<li><a href="https://learn.microsoft.com/windows/desktop/FileIO/disk-management-control-codes">Disk Management Control Codes</a></li>
<li><a href="fsctl_move_file" title="// CTL_CODE(0x0009, 0x01d, METHOD_BUFFERED, FILE_ANY_ACCESS)&#10;#define FSCTL_MOVE_FILE 0x00090074">FSCTL_MOVE_FILE</a></li>
<li><a href="https://learn.microsoft.com/windows/win32/api/errhandlingapi/nf-errhandlingapi-getlasterror">GetLastError</a></li>
<li><a href="https://learn.microsoft.com/windows/win32/api/ioapiset/nf-ioapiset-getoverlappedresult">GetOverlappedResult</a></li>
<li><a href="https://learn.microsoft.com/windows/win32/api/ioapiset/nf-ioapiset-getqueuedcompletionstatus">GetQueuedCompletionStatus</a></li>
<li><a href="https://learn.microsoft.com/windows/win32/api/minwinbase/ns-minwinbase-overlapped">OVERLAPPED</a></li>
<li><a href="starting_lcn_input_buffer" title="typedef struct {&#10;  LARGE_INTEGER StartingLcn;&#10;} STARTING_LCN_INPUT_BUFFER, *PSTARTING_LCN_INPUT_BUFFER;">STARTING_LCN_INPUT_BUFFER</a></li>
<li><a href="volume_bitmap_buffer" title="typedef struct {&#10;  LARGE_INTEGER StartingLcn;&#10;  LARGE_INTEGER BitmapSize;&#10;  UCHAR         Buffer[1];&#10;} VOLUME_BITMAP_BUFFER, *PVOLUME_BITMAP_BUFFER;">VOLUME_BITMAP_BUFFER</a></li>
</ul>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows/win32/api/winioctl/ni-winioctl-fsctl_get_volume_bitmap">View the official Win32 API reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/sdk-api/blob/docs/sdk-api-src/content/winioctl/ni-winioctl-fsctl_get_volume_bitmap.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
