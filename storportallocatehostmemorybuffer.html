<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="StorPortAllocateHostMemoryBuffer - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>StorPortAllocateHostMemoryBuffer - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            StorPortAllocateHostMemoryBuffer - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// storport.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> StorPortAllocateHostMemoryBuffer(
  [in]           PVOID            HwDeviceExtension,
  [in]           <a href="size_t-2" title="typedef ULONG_PTR SIZE_T;">SIZE_T</a>           MinimumBytes,
  [in]           <a href="size_t-2" title="typedef ULONG_PTR SIZE_T;">SIZE_T</a>           PreferredBytes,
  [in]           <a href="ulonglong" title="typedef unsigned __int64 ULONGLONG;">ULONGLONG</a>        UtilizationBytes,
  [in]           <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>            AlignmentBytes,
  [in]           <a href="physical_address" title="typedef LARGE_INTEGER PHYSICAL_ADDRESS, *PPHYSICAL_ADDRESS;">PHYSICAL_ADDRESS</a> LowestAcceptableAddress,
  [in]           <a href="physical_address" title="typedef LARGE_INTEGER PHYSICAL_ADDRESS, *PPHYSICAL_ADDRESS;">PHYSICAL_ADDRESS</a> HighestAcceptableAddress,
  [in, optional] <a href="physical_address" title="typedef LARGE_INTEGER PHYSICAL_ADDRESS, *PPHYSICAL_ADDRESS;">PHYSICAL_ADDRESS</a> BoundaryAddressMultiple,
  [in, out]      <a href="access_range" title="typedef struct _ACCESS_RANGE {&#10;  SCSI_PHYSICAL_ADDRESS RangeStart;&#10;  ULONG                 RangeLength;&#10;  BOOLEAN               RangeInMemory;&#10;} ACCESS_RANGE, *PACCESS_RANGE;">PACCESS_RANGE</a>    PhysicalAddressRanges,
  [in, out]      PULONG           PhysicalAddressRangeCount
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/storport/nf-storport-storportallocatehostmemorybuffer">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/storportallocatehostmemorybuffer.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-storport-storportallocatehostmemorybuffer)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="storportallocatehostmemorybuffer-function">StorPortAllocateHostMemoryBuffer function</h1>

<h2 id="description">Description</h2>

<p><strong>StorPortAllocateHostMemoryBuffer</strong> allocates one or more ranges of physically contiguous memory to be used as a Host Memory Buffer (HMB).</p>

<h2 id="parameters">Parameters</h2>

<h3 id="hwdeviceextension-in"><code>HwDeviceExtension</code> [in]</h3>

<p>A pointer to the hardware device extension for the host bus adapter (HBA).</p>

<h3 id="minimumbytes-in"><code>MinimumBytes</code> [in]</h3>

<p>The minimum amount of memory that will be useful to the device, in bytes. A value of 0 indicates that any size of memory up to the preferred size is acceptable.</p>

<h3 id="preferredbytes-in"><code>PreferredBytes</code> [in]</h3>

<p>The amount of memory the device prefers, in bytes. This must be a multiple of the page size.</p>

<h3 id="utilizationbytes-in"><code>UtilizationBytes</code> [in]</h3>

<p>The total number of blocks allocated on the device, in bytes.</p>

<h3 id="alignmentbytes-in"><code>AlignmentBytes</code> [in]</h3>

<p>The Host Memory Buffer alignment requirement from the device.</p>

<h3 id="lowestacceptableaddress-in"><code>LowestAcceptableAddress</code> [in]</h3>

<p>The lowest physical address that is valid for the allocation. For example, if the device can only reference physical memory in the 8 MB to 16 MB range, this value would be set to 0x800000 (8 MB).</p>

<h3 id="highestacceptableaddress-in"><code>HighestAcceptableAddress</code> [in]</h3>

<p>The highest physical address that is valid for the allocation. For example, if the device can only reference physical memory below 16 MB, this value would be set to 0xFFFFFF (16 MB - 1).</p>

<h3 id="boundaryaddressmultiple-in-optional"><code>BoundaryAddressMultiple</code> [in, optional]</h3>

<p>The physical address multiple that this allocation must not cross. This parameter is currently not used and must be set to 0.</p>

<h3 id="physicaladdressranges-in-out"><code>PhysicalAddressRanges</code> [in, out]</h3>

<p>An array of physical address ranges that make up the Host Memory Buffer. The caller should provide a pre-allocated array. <strong>StorPortAllocateHostMemoryBuffer</strong> will fill in the array with one or more physical address ranges.</p>

<h3 id="physicaladdressrangecount-in-out"><code>PhysicalAddressRangeCount</code> [in, out]</h3>

<p>The number of entries in <strong>PhysicalAddressRanges</strong>. This function will update this parameter to indicate how many physical address ranges it filled in.</p>

<h2 id="return-value">Return value</h2>

<p><strong>StorPortAllocateHostMemoryBuffer</strong> returns one of the following status codes:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td>STOR_STATUS_SUCCESS</td>
  <td>The <strong>PhysicalAddressRanges</strong> array contains one or more valid physical address ranges that represent the host memory buffer.</td>
</tr>
<tr>
  <td>STOR_STATUS_INVALID_PARAMETER</td>
  <td>This could indicate a minimum value that is greater than a maximum value, a non-page-aligned size, or that <strong>PhysicalAddressRanges</strong> is empty.</td>
</tr>
<tr>
  <td>STOR_STATUS_INSUFFICIENT_RESOURCES</td>
  <td>The host memory buffer could not be allocated.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>HMB is memory that the device may use directly and exclusively. The device may use this memory however it sees fit, but it must ensure that there is no data loss or data corruption in the event of a surprise removal or unexpected power loss.</p>

<p>Depending on the allocation policy, this function may allocate as much as the device's preferred size, as little as the device's minimum size, or no memory at all.</p>

<p>This function will attempt to allocate as few physically contiguous address ranges as possible, but it may have to use multiple physical address ranges to satisfy the desired HMB size.</p>

<p>The caller should subsequently call <strong><a href="storportfreehostmemorybuffer" title="ULONG StorPortFreeHostMemoryBuffer(&#10;  [in] PVOID         HwDeviceExtension,&#10;       PACCESS_RANGE PhysicalAddressRanges,&#10;  [in] ULONG         PhysicalAddressRangeCount&#10;);">StorPortFreeHostMemoryBuffer</a></strong> when it is done with the host memory buffer.</p>

<h2 id="see-also">See also</h2>

<p><strong><a href="storportfreehostmemorybuffer" title="ULONG StorPortFreeHostMemoryBuffer(&#10;  [in] PVOID         HwDeviceExtension,&#10;       PACCESS_RANGE PhysicalAddressRanges,&#10;  [in] ULONG         PhysicalAddressRangeCount&#10;);">StorPortFreeHostMemoryBuffer</a></strong></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/storport/nf-storport-storportallocatehostmemorybuffer">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/storport/nf-storport-storportallocatehostmemorybuffer.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
