<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="RtlQueryRegistryValues - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>RtlQueryRegistryValues - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            RtlQueryRegistryValues - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">#ifndef _NTRTL_H

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">NTSYSAPI
<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a>
NTAPI
RtlQueryRegistryValues(
    _In_ <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RelativeTo,
    _In_ PCWSTR Path,
    _Inout_ _At_(*(*QueryTable).EntryContext, _Pre_unknown_) <a href="rtl_query_registry_table" title="typedef struct _RTL_QUERY_REGISTRY_TABLE&#10;{&#10;    PRTL_QUERY_REGISTRY_ROUTINE QueryRoutine;&#10;    ULONG Flags;&#10;    PWSTR Name;&#10;    PVOID EntryContext;&#10;    ULONG DefaultType;&#10;    PVOID DefaultData;&#10;    ULONG DefaultLength;&#10;} RTL_QUERY_REGISTRY_TABLE, *PRTL_QUERY_REGISTRY_TABLE;">PRTL_QUERY_REGISTRY_TABLE</a> QueryTable,
    _In_opt_ PVOID Context,
    _In_opt_ PVOID Environment
    );
</span><span class="ntdoc-code-footer">
#endif
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://github.com/winsiderss/systeminformer/blob/443d121781061210978931c1766974f1372e359a/phnt/include/ntrtl.h#L10207">View code on GitHub</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">NTSYSAPI <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> RtlQueryRegistryValues(
  [in]           <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                     RelativeTo,
  [in]           PCWSTR                    Path,
  [in, out]      <a href="rtl_query_registry_table" title="typedef struct _RTL_QUERY_REGISTRY_TABLE&#10;{&#10;    PRTL_QUERY_REGISTRY_ROUTINE QueryRoutine;&#10;    ULONG Flags;&#10;    PWSTR Name;&#10;    PVOID EntryContext;&#10;    ULONG DefaultType;&#10;    PVOID DefaultData;&#10;    ULONG DefaultLength;&#10;} RTL_QUERY_REGISTRY_TABLE, *PRTL_QUERY_REGISTRY_TABLE;">PRTL_QUERY_REGISTRY_TABLE</a> QueryTable,
  [in, optional] PVOID                     Context,
  [in, optional] PVOID                     Environment
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlqueryregistryvalues">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<p>This function is <a rel="noopener" target="_blank" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlqueryregistryvalues">documented in Windows Driver Kit</a>.</p>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/rtlqueryregistryvalues.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdm-rtlqueryregistryvalues)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2 id="description">Description</h2>

<p>The <strong>RtlQueryRegistryValues</strong> routine allows the caller to query several values from the registry subtree with a single call.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="relativeto-in"><code>RelativeTo</code> [in]</h3>

<p>Specifies whether <em>Path</em> is an absolute registry path or is relative to a predefined path as one of the following.</p>

<table>
<thead>
<tr>
  <th>Value</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td><a href="rtl_registry_absolute" title="#define RTL_REGISTRY_ABSOLUTE 0">RTL_REGISTRY_ABSOLUTE</a></td>
  <td>Path is an absolute registry path.</td>
</tr>
<tr>
  <td><a href="rtl_registry_control" title="#define RTL_REGISTRY_CONTROL 2 // \Registry\Machine\System\CurrentControlSet\Control">RTL_REGISTRY_CONTROL</a></td>
  <td>Path is relative to <strong>\Registry\Machine\System\CurrentControlSet\Control</strong>.</td>
</tr>
<tr>
  <td><a href="rtl_registry_devicemap" title="#define RTL_REGISTRY_DEVICEMAP 4 // \Registry\Machine\Hardware\DeviceMap">RTL_REGISTRY_DEVICEMAP</a></td>
  <td>Path is relative to <strong>\Registry\Machine\Hardware\DeviceMap</strong>.</td>
</tr>
<tr>
  <td><a href="rtl_registry_services" title="#define RTL_REGISTRY_SERVICES 1 // \Registry\Machine\System\CurrentControlSet\Services">RTL_REGISTRY_SERVICES</a></td>
  <td>Path is relative to <strong>\Registry\Machine\System\CurrentControlSet\Services</strong>.</td>
</tr>
<tr>
  <td><a href="rtl_registry_user" title="#define RTL_REGISTRY_USER 5 // \Registry\User\CurrentUser">RTL_REGISTRY_USER</a></td>
  <td>Path is relative to <strong>\Registry\User\CurrentUser</strong>. (For a system process, this is <strong>\User\.Default</strong>.)</td>
</tr>
<tr>
  <td><a href="rtl_registry_windows_nt" title="#define RTL_REGISTRY_WINDOWS_NT 3 // \Registry\Machine\Software\Microsoft\Windows NT\CurrentVersion">RTL_REGISTRY_WINDOWS_NT</a></td>
  <td>Path is relative to <strong>\Registry\Machine\Software\Microsoft\Windows NT\CurrentVersion</strong>.</td>
</tr>
</tbody>
</table>

<p>The <em>RelativeTo</em> value can be modified by bitwise-ORing it with one of the following flags.</p>

<table>
<thead>
<tr>
  <th>Flag</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td><a href="rtl_registry_optional" title="#define RTL_REGISTRY_OPTIONAL 0x80000000">RTL_REGISTRY_OPTIONAL</a></td>
  <td>Specifies that the key referenced by this parameter and the <em>Path</em> parameter are optional.</td>
</tr>
<tr>
  <td><a href="rtl_registry_handle" title="#define RTL_REGISTRY_HANDLE 0x40000000">RTL_REGISTRY_HANDLE</a></td>
  <td>Specifies that the <em>Path</em> parameter is actually a registry handle to use.</td>
</tr>
</tbody>
</table>

<h3 id="path-in"><code>Path</code> [in]</h3>

<p>Pointer to either an absolute registry path or a path relative to the known location specified by the <em>RelativeTo</em> parameter. Note that the names of keys in such a path must be known to the caller, including the last key in the path. If the <a href="rtl_registry_handle" title="#define RTL_REGISTRY_HANDLE 0x40000000">RTL_REGISTRY_HANDLE</a> flag is specified, this parameter is a registry handle for an already opened key to be queried directly.</p>

<h3 id="querytable-in-out"><code>QueryTable</code> [in, out]</h3>

<p>Pointer to a table of one or more value names and subkey names in which the caller is interested. Each table entry contains the address of a caller-supplied <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-rtl_query_registry_routine">QueryRoutine</a> function that will be called for each value name that exists in the registry. The table must be terminated with a <strong>NULL</strong> table entry, which is a table entry with a <strong>NULL</strong> <strong>QueryRoutine</strong> member and a <strong>NULL</strong> <strong>Name</strong> member. The structure for query table entries is defined as follows:</p>

<div class="codehilite">
<pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_RTL_QUERY_REGISTRY_TABLE</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n"><a href="prtl_query_registry_routine" title="typedef RTL_QUERY_REGISTRY_ROUTINE *PRTL_QUERY_REGISTRY_ROUTINE;">PRTL_QUERY_REGISTRY_ROUTINE</a></span><span class="w"> </span><span class="n">QueryRoutine</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w"> </span><span class="n">Flags</span><span class="p">;</span>
<span class="w">    </span><span class="n">PWSTR</span><span class="w"> </span><span class="n">Name</span><span class="p">;</span>
<span class="w">    </span><span class="n">PVOID</span><span class="w"> </span><span class="n">EntryContext</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w"> </span><span class="n">DefaultType</span><span class="p">;</span>
<span class="w">    </span><span class="n">PVOID</span><span class="w"> </span><span class="n">DefaultData</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w"> </span><span class="n">DefaultLength</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n"><a href="rtl_query_registry_table" title="typedef struct _RTL_QUERY_REGISTRY_TABLE&#10;{&#10;    PRTL_QUERY_REGISTRY_ROUTINE QueryRoutine;&#10;    ULONG Flags;&#10;    PWSTR Name;&#10;    PVOID EntryContext;&#10;    ULONG DefaultType;&#10;    PVOID DefaultData;&#10;    ULONG DefaultLength;&#10;} RTL_QUERY_REGISTRY_TABLE, *PRTL_QUERY_REGISTRY_TABLE;">RTL_QUERY_REGISTRY_TABLE</a></span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n"><a href="rtl_query_registry_table" title="typedef struct _RTL_QUERY_REGISTRY_TABLE&#10;{&#10;    PRTL_QUERY_REGISTRY_ROUTINE QueryRoutine;&#10;    ULONG Flags;&#10;    PWSTR Name;&#10;    PVOID EntryContext;&#10;    ULONG DefaultType;&#10;    PVOID DefaultData;&#10;    ULONG DefaultLength;&#10;} RTL_QUERY_REGISTRY_TABLE, *PRTL_QUERY_REGISTRY_TABLE;">PRTL_QUERY_REGISTRY_TABLE</a></span><span class="p">;</span>
</code></pre>
</div>

<p>If the caller allocates storage for the query table pointed to by the <em>QueryTable</em> parameter, the caller is responsible for releasing this storage after the <strong>RtlQueryRegistryValues</strong> call returns.</p>

<h4 id="queryroutine">QueryRoutine</h4>

<p>The address of a <em>QueryRoutine</em> function that is called with the name, type, data, and data length of a registry value. If this member and the <strong>Name</strong> member are both <strong>NULL</strong>, it marks the end of the table.</p>

<p>A <em>QueryRoutine</em> function is declared as follows:</p>

<div class="codehilite">
<pre><span></span><code><span class="n"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a></span>
<span class="nf">QueryRoutine</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">PWSTR</span><span class="w"> </span><span class="n">ValueName</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w"> </span><span class="n">ValueType</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">PVOID</span><span class="w"> </span><span class="n">ValueData</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w"> </span><span class="n">ValueLength</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">PVOID</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n">PVOID</span><span class="w"> </span><span class="n">EntryContext</span>
<span class="w">    </span><span class="p">);</span>
</code></pre>
</div>

<p>For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-rtl_query_registry_routine">QueryRoutine</a>.</p>

<h4 id="flags">Flags</h4>

<p>Flags to control how the remaining members of the <strong><a href="rtl_query_registry_table" title="typedef struct _RTL_QUERY_REGISTRY_TABLE&#10;{&#10;    PRTL_QUERY_REGISTRY_ROUTINE QueryRoutine;&#10;    ULONG Flags;&#10;    PWSTR Name;&#10;    PVOID EntryContext;&#10;    ULONG DefaultType;&#10;    PVOID DefaultData;&#10;    ULONG DefaultLength;&#10;} RTL_QUERY_REGISTRY_TABLE, *PRTL_QUERY_REGISTRY_TABLE;">RTL_QUERY_REGISTRY_TABLE</a></strong> structure are to be interpreted. The following flag bits are defined for this member.</p>

<table>
<thead>
<tr>
  <th>Value</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td><a href="rtl_query_registry_subkey" title="#define RTL_QUERY_REGISTRY_SUBKEY 0x00000001">RTL_QUERY_REGISTRY_SUBKEY</a></td>
  <td>The <strong>Name</strong> of this table entry is another path to a registry key, and all following table entries are for that key rather than the key specified by the <em>Path</em> parameter. This change in focus lasts until the end of the table or until another RTL_REGISTRY_SUBKEY or <a href="rtl_query_registry_topkey" title="#define RTL_QUERY_REGISTRY_TOPKEY 0x00000002">RTL_QUERY_REGISTRY_TOPKEY</a> entry is seen. Each such entry must specify a path that is relative to the <em>Path</em> specified in the call to <strong>RtlQueryRegistryValues</strong>.</td>
</tr>
<tr>
  <td><a href="rtl_query_registry_topkey" title="#define RTL_QUERY_REGISTRY_TOPKEY 0x00000002">RTL_QUERY_REGISTRY_TOPKEY</a></td>
  <td>Resets the current registry key handle to the original one specified by the <em>RelativeTo</em> and <em>Path</em> parameters. This is useful for getting back to the original node after descending into subkeys with the <a href="rtl_query_registry_subkey" title="#define RTL_QUERY_REGISTRY_SUBKEY 0x00000001">RTL_QUERY_REGISTRY_SUBKEY</a> flag.</td>
</tr>
<tr>
  <td><a href="rtl_query_registry_required" title="#define RTL_QUERY_REGISTRY_REQUIRED 0x00000004">RTL_QUERY_REGISTRY_REQUIRED</a></td>
  <td>Specifies that this registry value must exist if <strong>DefaultType</strong> = REG_NONE; otherwise, if it is not found, **RtlQueryRegistryValues** immediately exits with a status code of STATUS_OBJECT_NAME_NOT_FOUND. This exit occurs if the <strong>Name</strong> member is <strong>NULL</strong> and the current key has no subkeys, or if <strong>Name</strong> specifies a nonexistent subkey. (If this flag is not specified, then when no match is found for a non-<strong>NULL</strong> <strong>Name</strong>, the routine uses the <strong>DefaultValue</strong> member as the value. When <strong>Name</strong> is <strong>NULL</strong> and the current key has no subkeys, the routine simply skips that table entry.)</td>
</tr>
<tr>
  <td><a href="rtl_query_registry_novalue" title="#define RTL_QUERY_REGISTRY_NOVALUE 0x00000008">RTL_QUERY_REGISTRY_NOVALUE</a></td>
  <td>Specifies that even though there is no <strong>Name</strong> for this table entry, all the caller wants is a callback: that is, the caller does not want to enumerate all the values under the current key. <em>QueryRoutine</em> is called with <strong>NULL</strong> for <em>ValueData</em>, REG_NONE for <em>ValueType</em>, and zero for <em>ValueLength</em>.</td>
</tr>
<tr>
  <td><a href="rtl_query_registry_noexpand" title="#define RTL_QUERY_REGISTRY_NOEXPAND 0x00000010">RTL_QUERY_REGISTRY_NOEXPAND</a></td>
  <td>For a registry value of type REG_EXPAND_SZ or REG_MULTI_SZ, this flag overrides the default behavior, which is to preprocess the registry value before calling the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-rtl_query_registry_routine">QueryRoutine</a> routine. By default, <strong>RtlQueryRegistryValues</strong> expands environment variable references in REG_EXPAND_SZ values, and enumerates each null-terminated string in a REG_MULTI_SZ value in a separate <em>QueryRoutine</em> call, so that the strings are presented as REG_SZ values that have the same *ValueName*. If this flag is set, *QueryRoutine* receives the raw REG_EXPAND_SZ or REG_MULTI_SZ value from the registry. For more information about the data formats for these values, see <strong><a href="key_value_basic_information" title="typedef struct _KEY_VALUE_BASIC_INFORMATION&#10;{&#10;    ULONG TitleIndex;&#10;    ULONG Type;&#10;    ULONG NameLength;&#10;    _Field_size_bytes_(NameLength) WCHAR Name[1];&#10;} KEY_VALUE_BASIC_INFORMATION, *PKEY_VALUE_BASIC_INFORMATION;">KEY_VALUE_BASIC_INFORMATION</a></strong>.</td>
</tr>
<tr>
  <td><a href="rtl_query_registry_direct" title="#define RTL_QUERY_REGISTRY_DIRECT 0x00000020">RTL_QUERY_REGISTRY_DIRECT</a></td>
  <td>The <strong>QueryRoutine</strong> member is not used (and must be <strong>NULL</strong>), and the <em>EntryContext</em> points to the buffer to store the value. If the caller sets this flag, the caller should additionally set the <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> flag to guard against buffer overflow. For more information, see the Remarks section.</td>
</tr>
<tr>
  <td><a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a></td>
  <td>Use this flag with the <a href="rtl_query_registry_direct" title="#define RTL_QUERY_REGISTRY_DIRECT 0x00000020">RTL_QUERY_REGISTRY_DIRECT</a> flag to verify that the REG_<em>XXX</em> type of the stored registry value matches the type expected by the caller. If the types do not match, the call fails. For more information, see the Remarks section.</td>
</tr>
<tr>
  <td><a href="rtl_query_registry_delete" title="#define RTL_QUERY_REGISTRY_DELETE 0x00000040">RTL_QUERY_REGISTRY_DELETE</a></td>
  <td>This flag is used to delete value keys after they have been queried.</td>
</tr>
</tbody>
</table>

<p>Starting with Windows 2000, inbox support is provided for all flag bits in the preceding table, with the exception of <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a>. Inbox support for <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> is available starting with Windows 8. For earlier versions of Windows, support for <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> is provided through Windows Update. For more information, see Remarks.</p>

<h4 id="name">Name</h4>

<p>This is the name of a Value that the caller queried. If <strong>Name</strong> is <strong>NULL</strong>, the <em>QueryRoutine</em> function specified for this table entry is called for all values associated with the current registry key. If the <a href="rtl_query_registry_direct" title="#define RTL_QUERY_REGISTRY_DIRECT 0x00000020">RTL_QUERY_REGISTRY_DIRECT</a> flag is set, a non-<strong>NULL</strong> value for <strong>Name</strong> must be provided.</p>

<h4 id="entrycontext">EntryContext</h4>

<p>If the <a href="rtl_query_registry_direct" title="#define RTL_QUERY_REGISTRY_DIRECT 0x00000020">RTL_QUERY_REGISTRY_DIRECT</a> flag is set, this is a pointer to the buffer to store the result of the query operation for this key. Otherwise, this value is passed as the <em>EntryContext</em> parameter of <em>QueryRoutine</em>.</p>

<h4 id="defaulttype">DefaultType</h4>

<p>The least significant byte of this member specifies the REG_*XXX* type of the data to be returned, if no matching key is found and the <a href="rtl_query_registry_required" title="#define RTL_QUERY_REGISTRY_REQUIRED 0x00000004">RTL_QUERY_REGISTRY_REQUIRED</a> flag is not specified. Specify REG_NONE for no default type. If the <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> flag is set, the most significant byte of this member specifies the REG_<em>XXX</em> type of the stored registry value that the caller expects. Bits 8 to 23 of this member are reserved and should be zero.</p>

<h4 id="defaultdata">DefaultData</h4>

<p>A pointer to the default value to be returned if no matching key is found and the <a href="rtl_query_registry_required" title="#define RTL_QUERY_REGISTRY_REQUIRED 0x00000004">RTL_QUERY_REGISTRY_REQUIRED</a> flag is not specified. This member is ignored if **DefaultType** = REG_NONE. Otherwise, the type of data pointed to by <strong>DefaultData</strong> should conform to the registry value type specified by the <strong>DefaultType</strong> member. For more information registry value types, see the definition of the <em>Type</em> parameter in <strong><a href="key_value_basic_information" title="typedef struct _KEY_VALUE_BASIC_INFORMATION&#10;{&#10;    ULONG TitleIndex;&#10;    ULONG Type;&#10;    ULONG NameLength;&#10;    _Field_size_bytes_(NameLength) WCHAR Name[1];&#10;} KEY_VALUE_BASIC_INFORMATION, *PKEY_VALUE_BASIC_INFORMATION;">KEY_VALUE_BASIC_INFORMATION</a></strong>.</p>

<h4 id="defaultlength">DefaultLength</h4>

<p>Specifies the length, in bytes, of the <strong>DefaultData</strong> member. If <strong>DefaultType</strong> is REG_SZ, REG_EXPAND_SZ, or REG_MULTI_SZ, callers can optionally specify zero to indicate **RtlQueryRegistryValues** should compute the length based on the default data value. If **DefaultType** = REG_NONE, this member is ignored.</p>

<h3 id="context-in-optional"><code>Context</code> [in, optional]</h3>

<p>Specifies the value passed as the <em>Context</em> parameter of a <em>QueryRoutine</em> function each time it is called.</p>

<h3 id="environment-in-optional"><code>Environment</code> [in, optional]</h3>

<p>Pointer to the environment used when expanding variable values in REG_EXPAND_SZ registry values, or a <strong>NULL</strong> pointer (optional).</p>

<h2 id="return-value">Return value</h2>

<p><strong>RtlQueryRegistryValues</strong> returns an <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> code. The possible return values include:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></strong></td>
  <td>The entire query table was processed successfully.</td>
</tr>
<tr>
  <td><strong>STATUS_INVALID_PARAMETER</strong></td>
  <td>Processing of the query table terminated with an invalid table entry. A table entry can be invalid if the specified flags require the <strong>QueryRoutine</strong> or <strong>Name</strong> member to be non-<strong>NULL</strong>, but a <strong>NULL</strong> value was provided.</td>
</tr>
<tr>
  <td><strong>STATUS_OBJECT_NAME_NOT_FOUND</strong></td>
  <td>The <em>Path</em> parameter does not match a valid key, or processing of the query table terminated with an entry with the <a href="rtl_query_registry_required" title="#define RTL_QUERY_REGISTRY_REQUIRED 0x00000004">RTL_QUERY_REGISTRY_REQUIRED</a> flag set and no matching key is found. This occurs if the <strong>Name</strong> member is <strong>NULL</strong> and the current key has no subkeys, or if <strong>Name</strong> specifies a nonexistent subkey.</td>
</tr>
<tr>
  <td><strong>STATUS_BUFFER_TOO_SMALL</strong></td>
  <td>The <a href="rtl_query_registry_direct" title="#define RTL_QUERY_REGISTRY_DIRECT 0x00000020">RTL_QUERY_REGISTRY_DIRECT</a> flag is set, and the buffer specified by <strong>EntryContext</strong> is too small to hold the key value data.</td>
</tr>
<tr>
  <td><strong>STATUS_OBJECT_TYPE_MISMATCH</strong></td>
  <td>The <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> flag is set and the type of the stored registry value does not match the type expected by the caller.</td>
</tr>
</tbody>
</table>

<p><strong>RtlQueryRegistryValues</strong> also terminates processing of the table if the <em>QueryRoutine</em> function for a table entry returns an <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> error code, and returns that error code as its result. (With one exception: If <em>QueryRoutine</em> returns STATUS_BUFFER_TOO_SMALL, the error code is ignored.)</p>

<h2 id="remarks">Remarks</h2>

<p>The caller specifies an initial key path and a table. The table contains one or more entries that describe the key values and subkey names in which the caller is interested. The table is terminated by an entry with a <strong>NULL</strong> <strong>QueryRoutine</strong> member and a <strong>NULL</strong> <strong>Name</strong> member. The table must be allocated from nonpaged pool.</p>

<p>Kernel-mode drivers must specify the <a href="rtl_query_registry_noexpand" title="#define RTL_QUERY_REGISTRY_NOEXPAND 0x00000010">RTL_QUERY_REGISTRY_NOEXPAND</a> flag to prevent calling environment variable routines. These routines are unsafe, so kernel-mode drivers should not use them.</p>

<blockquote>
  <p>[!CAUTION]
  If you use the <a href="rtl_query_registry_direct" title="#define RTL_QUERY_REGISTRY_DIRECT 0x00000020">RTL_QUERY_REGISTRY_DIRECT</a> flag, an untrusted user-mode application may be able to cause a buffer overflow. A buffer overflow can occur if a driver uses this flag to read a registry value to which the wrong type is assigned. In all cases, a driver that uses the <a href="rtl_query_registry_direct" title="#define RTL_QUERY_REGISTRY_DIRECT 0x00000020">RTL_QUERY_REGISTRY_DIRECT</a> flag should additionally use the <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> flag to prevent such overflows.</p>
</blockquote>

<p>If the <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> flag is set in a table entry, the caller must specify the expected REG_<em>XXX</em> type in the 8 most significant bits (MSBs) of the 32-bit <strong>DefaultType</strong> member of the table entry. As shown in the following code example, the <a href="rtl_query_registry_typecheck_shift" title="#define RTL_QUERY_REGISTRY_TYPECHECK_SHIFT 24">RTL_QUERY_REGISTRY_TYPECHECK_SHIFT</a> constant, which is defined to be 24, can be used as the shift count required to place the expected REG_<em>XXX</em> type in the 8 MSBs of the <strong>DefaultType</strong> member.</p>

<div class="codehilite">
<pre><span></span><code><span class="n"><a href="rtl_query_registry_table" title="typedef struct _RTL_QUERY_REGISTRY_TABLE&#10;{&#10;    PRTL_QUERY_REGISTRY_ROUTINE QueryRoutine;&#10;    ULONG Flags;&#10;    PWSTR Name;&#10;    PVOID EntryContext;&#10;    ULONG DefaultType;&#10;    PVOID DefaultData;&#10;    ULONG DefaultLength;&#10;} RTL_QUERY_REGISTRY_TABLE, *PRTL_QUERY_REGISTRY_TABLE;">RTL_QUERY_REGISTRY_TABLE</a></span><span class="w"> </span><span class="n">QueryRegTable</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">...</span>
<span class="n">QueryRegTable</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">DefaultType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">REG_SZ</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n"><a href="rtl_query_registry_typecheck_shift" title="#define RTL_QUERY_REGISTRY_TYPECHECK_SHIFT 24">RTL_QUERY_REGISTRY_TYPECHECK_SHIFT</a></span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">REG_NONE</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">QueryRegTable</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">DefaultType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">REG_DWORD</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n"><a href="rtl_query_registry_typecheck_shift" title="#define RTL_QUERY_REGISTRY_TYPECHECK_SHIFT 24">RTL_QUERY_REGISTRY_TYPECHECK_SHIFT</a></span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">REG_NONE</span><span class="p">;</span>
<span class="p">...</span>
</code></pre>
</div>

<p>Starting with Windows 8, if an <strong>RtlQueryRegistryValues</strong> call accesses an untrusted hive, and the caller sets the <a href="rtl_query_registry_direct" title="#define RTL_QUERY_REGISTRY_DIRECT 0x00000020">RTL_QUERY_REGISTRY_DIRECT</a> flag for this call, the caller must additionally set the <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> flag. A violation of this rule by a call from user mode causes an exception. A violation of this rule by a call from kernel mode causes a 0x139 bug check (KERNEL_SECURITY_CHECK_FAILURE).</p>

<p>Only system hives are trusted. An <strong>RtlQueryRegistryValues</strong> call that accesses a system hive does not cause an exception or a bug check if the <a href="rtl_query_registry_direct" title="#define RTL_QUERY_REGISTRY_DIRECT 0x00000020">RTL_QUERY_REGISTRY_DIRECT</a> flag is set and the <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> flag is not set. However, as a best practice, the <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> flag should always be set if the <a href="rtl_query_registry_direct" title="#define RTL_QUERY_REGISTRY_DIRECT 0x00000020">RTL_QUERY_REGISTRY_DIRECT</a> flag is set.</p>

<p>Similarly, in versions of Windows before Windows 8, as a best practice, an <strong>RtlQueryRegistryValues</strong> call that sets the <a href="rtl_query_registry_direct" title="#define RTL_QUERY_REGISTRY_DIRECT 0x00000020">RTL_QUERY_REGISTRY_DIRECT</a> flag should additionally set the <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> flag. However, failure to follow this recommendation does not cause an exception or a bug check.</p>

<p>The following is a list of system hives:</p>

<ul>
<li><p>\REGISTRY\MACHINE\HARDWARE</p></li>
<li><p>\REGISTRY\MACHINE\SOFTWARE</p></li>
<li><p>\REGISTRY\MACHINE\SYSTEM</p></li>
<li><p>\REGISTRY\MACHINE\SECURITY</p></li>
<li><p>\REGISTRY\MACHINE\SAM</p></li>
</ul>

<p>Support for the <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> flag is available through Windows Update for Windows 7, Windows Vista, Windows Server 2003, and Windows XP. For more information about this update, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/security-updates/securitybulletins/2011/ms11-011">Vulnerabilities in Windows Kernel Could Allow Elevation of Privilege (2393802)</a>. In versions of these operating systems that do not have this update, the caller can use the <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> flag. However, this flag is ignored by the <strong>RtlQueryRegistryValues</strong> routine.</p>

<p>Starting with Windows Driver Kit (WDK) 8, the <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> flag is defined in the Wdm.h header file as follows:</p>

<div class="codehilite">
<pre><span></span><code><span class="cp">#define <a href="rtl_query_registry_typecheck" title="#define RTL_QUERY_REGISTRY_TYPECHECK 0x00000100">RTL_QUERY_REGISTRY_TYPECHECK</a> 0x00000100</span>
</code></pre>
</div>

<p>If an entry does not specify the <a href="rtl_query_registry_direct" title="#define RTL_QUERY_REGISTRY_DIRECT 0x00000020">RTL_QUERY_REGISTRY_DIRECT</a> flag, **RtlQueryRegistryValues** uses the specified *QueryRoutine* function to report the value name, type, data, and data length, in bytes, to the caller. If the **Name** member of the entry is **NULL**, **RtlQueryRegistryValues** reports every direct subkey of the key. If the key type is REG_MULTI_SZ and the <a href="rtl_query_registry_noexpand" title="#define RTL_QUERY_REGISTRY_NOEXPAND 0x00000010">RTL_QUERY_REGISTRY_NOEXPAND</a> flag not is specified, the routine calls <em>QueryRoutine</em> separately for each individual string; otherwise the routine reports it as a single value. If an entry specifies the <a href="rtl_query_registry_direct" title="#define RTL_QUERY_REGISTRY_DIRECT 0x00000020">RTL_QUERY_REGISTRY_DIRECT</a> flag, <strong>RtlQueryRegistryValues</strong> stores the value of the key in the buffer pointed to by the entry's <strong>EntryContext</strong> member. The format of the returned data is as follows.</p>

<table>
<thead>
<tr>
  <th>Key data type</th>
  <th>How data is returned</th>
</tr>
</thead>
<tbody>
<tr>
  <td>A null-terminated Unicode string (such as REG_SZ, REG_EXPAND_SZ).</td>
  <td><strong>EntryContext</strong> must point to an initialized <strong><a href="unicode_string" title="typedef struct _UNICODE_STRING&#10;{&#10;    USHORT Length;&#10;    USHORT MaximumLength;&#10;    _Field_size_bytes_part_opt_(MaximumLength, Length) PWCH Buffer;&#10;} UNICODE_STRING, *PUNICODE_STRING;">UNICODE_STRING</a></strong> structure. If the <strong>Buffer</strong> member of <strong><a href="unicode_string" title="typedef struct _UNICODE_STRING&#10;{&#10;    USHORT Length;&#10;    USHORT MaximumLength;&#10;    _Field_size_bytes_part_opt_(MaximumLength, Length) PWCH Buffer;&#10;} UNICODE_STRING, *PUNICODE_STRING;">UNICODE_STRING</a></strong> is <strong>NULL</strong>, the routine allocates storage for the string data. Otherwise, it stores the string data in the buffer that <strong>Buffer</strong> points to.</td>
</tr>
<tr>
  <td>REG_MULTI_SZ</td>
  <td>You must specify the <a href="rtl_query_registry_noexpand" title="#define RTL_QUERY_REGISTRY_NOEXPAND 0x00000010">RTL_QUERY_REGISTRY_NOEXPAND</a> flag for this key data type. <strong>EntryContext</strong> points to an initialized <strong><a href="unicode_string" title="typedef struct _UNICODE_STRING&#10;{&#10;    USHORT Length;&#10;    USHORT MaximumLength;&#10;    _Field_size_bytes_part_opt_(MaximumLength, Length) PWCH Buffer;&#10;} UNICODE_STRING, *PUNICODE_STRING;">UNICODE_STRING</a></strong> structure. The routine stores the key value as a single string value. Each individual component within the string is terminated by a zero. If the <strong>Buffer</strong> member of <strong><a href="unicode_string" title="typedef struct _UNICODE_STRING&#10;{&#10;    USHORT Length;&#10;    USHORT MaximumLength;&#10;    _Field_size_bytes_part_opt_(MaximumLength, Length) PWCH Buffer;&#10;} UNICODE_STRING, *PUNICODE_STRING;">UNICODE_STRING</a></strong> is <strong>NULL</strong>, the routine allocates storage for the string data. Otherwise, it stores the string data in the buffer that <strong>Buffer</strong> points to.</td>
</tr>
<tr>
  <td>Nonstring data with size, in bytes, &lt;= <strong>sizeof</strong>(<a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>)</td>
  <td>The value is stored in the memory location specified by <strong>EntryContext</strong>.</td>
</tr>
<tr>
  <td>Nonstring data with size, in bytes, > <strong>sizeof</strong>(<a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>)</td>
  <td>The buffer pointed to by <strong>EntryContext</strong> must begin with a signed <a href="long" title="typedef long LONG;">LONG</a> value. The magnitude of the value must specify the size, in bytes, of the buffer. If the sign of the value is negative, <strong>RtlQueryRegistryValues</strong> will only store the data of the key value. Otherwise, it will use the first <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> in the buffer to record the value length, in bytes, the second <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> to record the value type, and the rest of the buffer to store the value data.</td>
</tr>
</tbody>
</table>

<p>If an error occurs at any stage of processing of the query table, <strong>RtlQueryRegistryValues</strong> stops processing the table and returns the error status.</p>

<p>See <a href="ntsetvaluekey" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtSetValueKey(&#10;    _In_ HANDLE KeyHandle,&#10;    _In_ PCUNICODE_STRING ValueName,&#10;    _In_opt_ ULONG TitleIndex,&#10;    _In_ ULONG Type,&#10;    _In_reads_bytes_opt_(DataSize) PVOID Data,&#10;    _In_ ULONG DataSize&#10;    );">ZwSetValueKey</a> for a description of the possible REG_<em>XXX</em> values.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-rtl_query_registry_routine">QueryRoutine</a></p>

<p><a href="rtlzeromemory" title="VOID RtlZeroMemory(&#10;  _Out_ VOID UNALIGNED *Destination,&#10;  _In_  SIZE_T         Length&#10;);">RtlZeroMemory</a></p>

<p><strong><a href="unicode_string" title="typedef struct _UNICODE_STRING&#10;{&#10;    USHORT Length;&#10;    USHORT MaximumLength;&#10;    _Field_size_bytes_part_opt_(MaximumLength, Length) PWCH Buffer;&#10;} UNICODE_STRING, *PUNICODE_STRING;">UNICODE_STRING</a></strong></p>

<p><a href="ntenumeratekey" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtEnumerateKey(&#10;    _In_ HANDLE KeyHandle,&#10;    _In_ ULONG Index,&#10;    _In_ KEY_INFORMATION_CLASS KeyInformationClass,&#10;    _Out_writes_bytes_to_opt_(Length, *ResultLength) PVOID KeyInformation,&#10;    _In_ ULONG Length,&#10;    _Out_ PULONG ResultLength&#10;    );">ZwEnumerateKey</a></p>

<p><a href="ntenumeratevaluekey" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtEnumerateValueKey(&#10;    _In_ HANDLE KeyHandle,&#10;    _In_ ULONG Index,&#10;    _In_ KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass,&#10;    _Out_writes_bytes_to_opt_(Length, *ResultLength) PVOID KeyValueInformation,&#10;    _In_ ULONG Length,&#10;    _Out_ PULONG ResultLength&#10;    );">ZwEnumerateValueKey</a></p>

<p><a href="ntsetvaluekey" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtSetValueKey(&#10;    _In_ HANDLE KeyHandle,&#10;    _In_ PCUNICODE_STRING ValueName,&#10;    _In_opt_ ULONG TitleIndex,&#10;    _In_ ULONG Type,&#10;    _In_reads_bytes_opt_(DataSize) PVOID Data,&#10;    _In_ ULONG DataSize&#10;    );">ZwSetValueKey</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlqueryregistryvalues">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/nf-wdm-rtlqueryregistryvalues.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
