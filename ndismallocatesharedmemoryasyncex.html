<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="NdisMAllocateSharedMemoryAsyncEx - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>NdisMAllocateSharedMemoryAsyncEx - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            NdisMAllocateSharedMemoryAsyncEx - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ndis.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">NDIS_STATUS NdisMAllocateSharedMemoryAsyncEx(
  [in] NDIS_HANDLE MiniportDmaHandle,
  [in] <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>       Length,
  [in] BOOLEAN     Cached,
  [in] PVOID       Context
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nf-ndis-ndismallocatesharedmemoryasyncex">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ndismallocatesharedmemoryasyncex.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ndis-ndismallocatesharedmemoryasyncex)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="ndismallocatesharedmemoryasyncex-function">NdisMAllocateSharedMemoryAsyncEx function</h1>

<h2 id="description">Description</h2>

<blockquote>
  <p>[!CAUTION]
  For ARM and ARM64 processors, we strongly recommend that NDIS driver writers use WDF DMA or WDM DMA instead of NDIS Scatter/Gather DMA.</p>
  
  <p>For more information about WDF DMA, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/wdf/handling-dma-operations-in-kmdf-drivers">Handling DMA Operations in KMDF Drivers</a>.</p>
  
  <p>For more information about WDM DMA, see the DMA-related child topics of <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/managing-input-output-for-drivers">Managing Input/Output for Drivers</a>.</p>
</blockquote>

<p>Miniport drivers call the
<strong>NdisMAllocateSharedMemoryAsyncEx</strong> function to allocate additional memory shared between the driver and
its bus-master DMA NIC, usually when the miniport driver is running low on available NIC receive
buffers.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="miniportdmahandle-in"><code>MiniportDmaHandle</code> [in]</h3>

<p>A handle to a context area that NDIS uses to manage a DMA resource. The caller obtained this
handle by calling the
<a href="ndismregisterscattergatherdma" title="NDIS_STATUS NdisMRegisterScatterGatherDma(&#10;  [in]      NDIS_HANDLE              MiniportAdapterHandle,&#10;  [in, out] PNDIS_SG_DMA_DESCRIPTION DmaDescription,&#10;  [out]     PNDIS_HANDLE             NdisMiniportDmaHandle&#10;);">NdisMRegisterScatterGatherDma</a> function.</p>

<h3 id="length-in"><code>Length</code> [in]</h3>

<p>The number of bytes to allocate.</p>

<h3 id="cached-in"><code>Cached</code> [in]</h3>

<p>This parameter is ignored (cached memory is always used on x86 and x64 systems).</p>

<h3 id="context-in"><code>Context</code> [in]</h3>

<p>A pointer to driver-determined context to be passed to the
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_allocate_shared_mem_complete">MiniportSharedMemoryAllocateComplete</a> function when it is called.</p>

<h2 id="return-value">Return value</h2>

<p><strong>NdisMAllocateSharedMemoryAsyncEx</strong> can return one of the following:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>NDIS_STATUS_PENDING</strong></td>
  <td>NDIS will call the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_allocate_shared_mem_complete">MiniportSharedMemoryAllocateComplete</a> function and provide information that describes the allocated shared memory. If the attempt to allocate shared memory fails, NDIS calls <em>MiniportSharedMemoryAllocateComplete</em> and passes <strong>NULL</strong> pointers.</td>
</tr>
<tr>
  <td><strong>NDIS_STATUS_FAILURE</strong></td>
  <td>The requested memory could not be allocated at this time. If NdisMAllocateSharedMemoryAsyncEx returns this status, a subsequent call with the same parameters might succeed, depending on whether system resources have become available.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p><strong>Note</strong> A miniport driver must have already called <a href="ndismregisterscattergatherdma" title="NDIS_STATUS NdisMRegisterScatterGatherDma(&#10;  [in]      NDIS_HANDLE              MiniportAdapterHandle,&#10;  [in, out] PNDIS_SG_DMA_DESCRIPTION DmaDescription,&#10;  [out]     PNDIS_HANDLE             NdisMiniportDmaHandle&#10;);">NdisMRegisterScatterGatherDma</a> or <a href="ndismregisterdmachannel" title="NDIS_STATUS NdisMRegisterDmaChannel(&#10;  [out] PNDIS_HANDLE          MiniportDmaHandle,&#10;  [in]  NDIS_HANDLE           MiniportAdapterHandle,&#10;  [in]  UINT                  DmaChannel,&#10;  [in]  BOOLEAN               Dma32BitAddresses,&#10;  [in]  PNDIS_DMA_DESCRIPTION DmaDescription,&#10;  [in]  ULONG                 MaximumLength&#10;);">NdisMRegisterDmaChannel</a> to initialize a
scatter/gather DMA channel before calling <strong>NdisMAllocateSharedMemoryAsyncEx</strong>.</p>

<p>Drivers of bus-master DMA NICs call
<strong>NdisMAllocateSharedMemoryAsyncEx</strong> to dynamically allocate shared memory. Such drivers also allocate
shared memory space during initialization. These drivers use the dynamically allocated shared memory for
transfer operations when high network traffic places excessive demands on the existing shared memory
space.</p>

<p>Such a miniport driver usually maintains one or more state variables to track the number of shared
memory buffers available for incoming transfers. When the number of available buffers reaches a
driver-determined low, the miniport driver calls
<strong>NdisMAllocateSharedMemoryAsyncEx</strong> to allocate more buffer space in shared memory. When the number of
available buffers climbs to a driver-determined high, the miniport driver calls
<a href="ndismfreesharedmemory" title="VOID NdisMFreeSharedMemory(&#10;  [in] NDIS_HANDLE           MiniportAdapterHandle,&#10;  [in] ULONG                 Length,&#10;  [in] BOOLEAN               Cached,&#10;  [in] PVOID                 VirtualAddress,&#10;  [in] NDIS_PHYSICAL_ADDRESS PhysicalAddress&#10;);">NdisMFreeSharedMemory</a> one or more
times to release its preceding dynamic allocations.</p>

<p>Usually, such a miniport driver retains the block of shared memory that its
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_initialize">MiniportInitializeEx</a> function
allocated with
<a href="ndismallocatesharedmemory" title="VOID NdisMAllocateSharedMemory(&#10;  [in]  NDIS_HANDLE            MiniportAdapterHandle,&#10;  [in]  ULONG                  Length,&#10;  [in]  BOOLEAN                Cached,&#10;  [out] PVOID                  *VirtualAddress,&#10;  [out] PNDIS_PHYSICAL_ADDRESS PhysicalAddress&#10;);">NdisMAllocateSharedMemory</a> until
a NIC is removed. When the NIC is removed, NDIS calls the miniport driver's
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_halt">MiniportHaltEx</a> function. This allocation
is sufficient to handle an average demand for transfers through the NIC.</p>

<p>A miniport driver should set a limit on how much shared memory it can allocate. This limit is
driver-specific and should be high enough so that the driver does not run out of buffers. Do not et a
limit that is excessively high, as this could result in a wasteful consumption of shared memory that
could reduce system performance.</p>

<p>Any miniport driver that calls
<strong>NdisMAllocateSharedMemoryAsyncEx</strong> or
<a href="ndismallocatesharedmemory" title="VOID NdisMAllocateSharedMemory(&#10;  [in]  NDIS_HANDLE            MiniportAdapterHandle,&#10;  [in]  ULONG                  Length,&#10;  [in]  BOOLEAN                Cached,&#10;  [out] PVOID                  *VirtualAddress,&#10;  [out] PNDIS_PHYSICAL_ADDRESS PhysicalAddress&#10;);">NdisMAllocateSharedMemory</a> must release all outstanding allocations with one or more calls to
<a href="ndismfreesharedmemory" title="VOID NdisMFreeSharedMemory(&#10;  [in] NDIS_HANDLE           MiniportAdapterHandle,&#10;  [in] ULONG                 Length,&#10;  [in] BOOLEAN               Cached,&#10;  [in] PVOID                 VirtualAddress,&#10;  [in] NDIS_PHYSICAL_ADDRESS PhysicalAddress&#10;);">NdisMFreeSharedMemory</a> when its NIC is removed.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_halt">MiniportHaltEx</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_initialize">MiniportInitializeEx</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_allocate_shared_mem_complete">MiniportSharedMemoryAllocateComplete</a></p>

<p><a href="ndismallocatesharedmemory" title="VOID NdisMAllocateSharedMemory(&#10;  [in]  NDIS_HANDLE            MiniportAdapterHandle,&#10;  [in]  ULONG                  Length,&#10;  [in]  BOOLEAN                Cached,&#10;  [out] PVOID                  *VirtualAddress,&#10;  [out] PNDIS_PHYSICAL_ADDRESS PhysicalAddress&#10;);">NdisMAllocateSharedMemory</a></p>

<p><a href="ndismfreesharedmemory" title="VOID NdisMFreeSharedMemory(&#10;  [in] NDIS_HANDLE           MiniportAdapterHandle,&#10;  [in] ULONG                 Length,&#10;  [in] BOOLEAN               Cached,&#10;  [in] PVOID                 VirtualAddress,&#10;  [in] NDIS_PHYSICAL_ADDRESS PhysicalAddress&#10;);">NdisMFreeSharedMemory</a></p>

<p><a href="ndismregisterdmachannel" title="NDIS_STATUS NdisMRegisterDmaChannel(&#10;  [out] PNDIS_HANDLE          MiniportDmaHandle,&#10;  [in]  NDIS_HANDLE           MiniportAdapterHandle,&#10;  [in]  UINT                  DmaChannel,&#10;  [in]  BOOLEAN               Dma32BitAddresses,&#10;  [in]  PNDIS_DMA_DESCRIPTION DmaDescription,&#10;  [in]  ULONG                 MaximumLength&#10;);">NdisMRegisterDmaChannel</a></p>

<p><a href="ndismregisterscattergatherdma" title="NDIS_STATUS NdisMRegisterScatterGatherDma(&#10;  [in]      NDIS_HANDLE              MiniportAdapterHandle,&#10;  [in, out] PNDIS_SG_DMA_DESCRIPTION DmaDescription,&#10;  [out]     PNDIS_HANDLE             NdisMiniportDmaHandle&#10;);">NdisMRegisterScatterGatherDma</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nf-ndis-ndismallocatesharedmemoryasyncex">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ndis/nf-ndis-ndismallocatesharedmemoryasyncex.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
