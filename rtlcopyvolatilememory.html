<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="RtlCopyVolatileMemory - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>RtlCopyVolatileMemory - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            RtlCopyVolatileMemory - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">volatile void * RtlCopyVolatileMemory(
  [out] volatile void       *Destination,
  [in]  volatile const void *Source,
  [in]  <a href="size_t" title="typedef unsigned __int64 size_t;">size_t</a>              Length
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlcopyvolatilememory">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/rtlcopyvolatilememory.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdm-rtlcopyvolatilememory)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2 id="description">Description</h2>

<p><strong>RtlCopyVolatileMemory</strong> function provides <strong><a href="rtlcopymemory" title="void RtlCopyMemory(&#10;  Destination,&#10;  Source,&#10;  Length&#10;);">RtlCopyMemory</a></strong> behavior (for example, copying memory from one location to another) in situations where the developer needs to be sure that the copy operation occurs (for example, isn't subject to compiler optimizations).</p>

<h2 id="parameters">Parameters</h2>

<h3 id="destination-out"><code>Destination</code> [out]</h3>

<p>A pointer to the starting address of the copied block's destination.</p>

<h3 id="source-in"><code>Source</code> [in]</h3>

<p>A pointer to the starting address of the block of memory to copy.</p>

<h3 id="length-in"><code>Length</code> [in]</h3>

<p>The size of the block of memory to copy, in bytes.</p>

<h2 id="return-value">Return value</h2>

<p>Returns the value of <em>Destination</em>.</p>

<h2 id="remarks">Remarks</h2>

<p>The <strong>RtlCopyVolatileMemory</strong> function has the following properties:</p>

<ul>
<li><p>The function isn't recognized as a compiler intrinsic so the compiler will never optimize away the call (either entirely or replace the call with an equivalent sequence of instructions). This differs from <strong><a href="rtlcopymemory" title="void RtlCopyMemory(&#10;  Destination,&#10;  Source,&#10;  Length&#10;);">RtlCopyMemory</a></strong> which is subject to various compiler optimizations.</p></li>
<li><p>When the call returns, the data has been copied from <em>Source</em> to <em>Destination</em>. This functions memory accesses to the <em>Source</em> and <em>Destination</em> will only be performed within the function (for example, the compiler can't move memory accesses out of this function).</p></li>
<li><p>The function may perform unaligned memory accesses if the platform allows for it.</p></li>
<li><p>The function may access memory locations more than once as part of its copy operation.</p></li>
<li><p>It's similar to <strong><a href="rtlcopymemory" title="void RtlCopyMemory(&#10;  Destination,&#10;  Source,&#10;  Length&#10;);">RtlCopyMemory</a></strong> in that it doesn't support copy operations when <em>Source</em> and <em>Destination</em> overlap each other.</p></li>
</ul>

<blockquote>
  <p>[!NOTE]
  This function works on all versions of Windows, not just the latest. You need to consume the latest WDK to get the function declaration from the wdm.h header. You also need the library (volatileaccessk.lib) from the latest WDK. However, the resulting driver will run fine on older versions of Windows.</p>
</blockquote>

<h3 id="example">Example</h3>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="n">HEADER</span><span class="w"> </span><span class="n">MyHeader</span><span class="p">;</span>

<span class="n"><a href="uchar" title="typedef unsigned char UCHAR;">UCHAR</a></span><span class="w"> </span><span class="n">RawBuffer</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>

<span class="c1">// Ensure that the shared memory (which could be constantly changing)</span>
<span class="c1">// is copied in to the local MyHeader variable.</span>
<span class="c1">// Note that the compiler is allowed to optimize away calls to</span>
<span class="c1">// <a href="rtlcopymemory" title="void RtlCopyMemory(&#10;  Destination,&#10;  Source,&#10;  Length&#10;);">RtlCopyMemory</a> so those functions are not guaranteed to actually</span>
<span class="c1">// make a local copy of data.</span>
<span class="c1">//</span>
<span class="c1">// RtlCopyVolatileMemory does not handle a source/dest buffer that overlap</span>
<span class="c1">// with each other (<a href="rtlcopymemory" title="void RtlCopyMemory(&#10;  Destination,&#10;  Source,&#10;  Length&#10;);">RtlCopyMemory</a> semantics).</span>
<span class="c1">//</span>
<span class="c1">// Assume SharedMemory points to virtual memory that is also mapped in an untrusted process.</span>
<span class="c1">// Assume that untrusted process is changing the memory contents while you are accessing it.</span>

<span class="n">PVOID</span><span class="w"> </span><span class="n">SharedMemory</span><span class="p">;</span>

<span class="n">RtlCopyVolatileMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyHeader</span><span class="p">,</span><span class="w"> </span><span class="n">SharedMemory</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">MyHeader</span><span class="p">));</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">MyHeader</span><span class="p">.</span><span class="n">Size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// Because MyHeader is local and we are guaranteed we actually made</span>
<span class="w">    </span><span class="c1">// a local copy, we can be sure that the &quot;Size&quot; value will not change</span>
<span class="w">    </span><span class="c1">// between the previous bounds check and the below call to <a href="rtlfillmemory" title="void RtlFillMemory(&#10;   void*  Destination,&#10;   size_t Length&#10;   int    Fill&#10;);">RtlFillMemory</a>.</span>
<span class="w">    </span><span class="c1">// If <a href="rtlcopymemory" title="void RtlCopyMemory(&#10;  Destination,&#10;  Source,&#10;  Length&#10;);">RtlCopyMemory</a> had been used to copy the data, it is possible</span>
<span class="w">    </span><span class="c1">// that a compiler may optimize away the call to <a href="rtlcopymemory" title="void RtlCopyMemory(&#10;  Destination,&#10;  Source,&#10;  Length&#10;);">RtlCopyMemory</a> and instead fetch</span>
<span class="w">    </span><span class="c1">// the &quot;size&quot; field of MyHeader directly from untrusted memory two times.</span>
<span class="w">    </span><span class="c1">// The first time it would be fetched for the bounds check, and the second</span>
<span class="w">    </span><span class="c1">// time it is fetched is for the call to <a href="rtlfillmemory" title="void RtlFillMemory(&#10;   void*  Destination,&#10;   size_t Length&#10;   int    Fill&#10;);">RtlFillMemory</a>. It is possible the memory</span>
<span class="w">    </span><span class="c1">// could have changed between the two accesses resulting in the size check</span>
<span class="w">    </span><span class="c1">// being ineffective.</span>

<span class="w">    </span><span class="n"><a href="rtlfillmemory" title="void RtlFillMemory(&#10;   void*  Destination,&#10;   size_t Length&#10;   int    Fill&#10;);">RtlFillMemory</a></span><span class="w"> </span><span class="p">(</span><span class="n">RawBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">MyHeader</span><span class="p">.</span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>
</code></pre>
</div>

<h2 id="see-also">See also</h2>

<p><strong><a href="rtlcopymemory" title="void RtlCopyMemory(&#10;  Destination,&#10;  Source,&#10;  Length&#10;);">RtlCopyMemory</a></strong></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlcopyvolatilememory">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/nf-wdm-rtlcopyvolatilememory.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
