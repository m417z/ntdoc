<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="FsRtlUpperOplockFsctrl - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>FsRtlUpperOplockFsctrl - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            FsRtlUpperOplockFsctrl - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> FsRtlUpperOplockFsctrl(
  [in] POPLOCK Oplock,
  [in] PIRP    Irp,
  [in] <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>   OpenCount,
  [in] <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>   LowerOplockState,
  [in] <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>   Flags
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-_fsrtl_advanced_fcb_header-fsrtlupperoplockfsctrl">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/fsrtlupperoplockfsctrl.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ntifs-_fsrtl_advanced_fcb_header-fsrtlupperoplockfsctrl)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="fsrtlupperoplockfsctrl-function">FsRtlUpperOplockFsctrl function</h1>

<h2 id="description">Description</h2>

<p>The <strong>FsRtlUpperOplockFsctrl</strong> routine processes opportunistic lock (oplock) requests and acknowledgments for secondary, or layered, file systems. The upper file system submits the state of the oplock held in the lower file system. <strong>FsRtlUpperOplockFsctrl</strong> will determine whether to grant or deny the upper file system oplock.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="oplock-in"><code>Oplock</code> [in]</h3>

<p>An opaque oplock pointer for the file. This pointer must have been initialized by a previous call to <strong><a href="fsrtlinitializeoplock" title="VOID FsRtlInitializeOplock(&#10;  [in, out] POPLOCK Oplock&#10;);">FsRtlInitializeOplock</a></strong>.</p>

<h3 id="irp-in"><code>Irp</code> [in]</h3>

<p>A pointer to the <a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a> for the I/O operation.</p>

<h3 id="opencount-in"><code>OpenCount</code> [in]</h3>

<p>Number of user handles for the file, if an exclusive oplock is being requested. Setting a nonzero value for a level 2, R, or RH oplock request indicates that there are byte-range locks on the file. For more information about oplock types, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/fileio/types-of-opportunistic-locks">Types of Oplocks</a>.</p>

<h3 id="loweroplockstate-in"><code>LowerOplockState</code> [in]</h3>

<p>The value the lower oplock level held by the upper file system. This a bitwise OR combination of the following:</p>

<table>
<thead>
<tr>
  <th>Value</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td>OPLOCK_LEVEL_CACHE_READ</td>
  <td>Indicates an oplock Read (R) type.</td>
</tr>
<tr>
  <td>OPLOCK_LEVEL_CACHE_WRITE</td>
  <td>Indicates an oplock Write (W) type.</td>
</tr>
<tr>
  <td>OPLOCK_LEVEL_CACHE_HANDLE</td>
  <td>Indicates an oplock Handle (H) type.</td>
</tr>
</tbody>
</table>

<h3 id="flags-in"><code>Flags</code> [in]</h3>

<p>A bitmask for the associated oplock operations. A file system or filter driver sets bits to specify the behavior of <strong>FsRtlUpperOplockFsctrl</strong>. The <strong>Flags</strong> parameter has the following options:</p>

<table>
<thead>
<tr>
  <th>Value</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td>OPLOCK_FSCTRL_FLAG_ALL_KEYS_MATCH (0x00000001)</td>
  <td>The file system verified that all oplock keys on any currently open handles match. By specifying this flag, you allow the oplock package to grant an oplock of level RW or RWH when more than one open handle to the file exists.</td>
</tr>
</tbody>
</table>

<h2 id="return-value">Return value</h2>

<p><strong>FsRtlUpperOplockFsctrl</strong> returns one of the following <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> values:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></td>
  <td>For an <a href="irp_mj_create" title="#define IRP_MJ_CREATE 0x00">IRP_MJ_CREATE</a> request, <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> indicates that the requested filter opportunistic lock (oplock) was granted. For a FSCTL operation, the meaning of <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> depends on the FSCTL code. For more information, see the Remarks section in <strong><a href="fsrtloplockfsctrlex" title="NTSTATUS FsRtlOplockFsctrlEx(&#10;  [in] POPLOCK Oplock,&#10;  [in] PIRP    Irp,&#10;  [in] ULONG   OpenCount,&#10;  [in] ULONG   Flags&#10;);">FsRtlOplockFsctrlEx</a></strong>.</td>
</tr>
<tr>
  <td>STATUS_CANCELLED</td>
  <td>The I/O operation was canceled. STATUS_CANCELLED is an error code.</td>
</tr>
<tr>
  <td>STATUS_INVALID_PARAMETER</td>
  <td>The FSCTL code for the I/O operation was not a valid values oplock request. Valid request types are listed in the Remarks section of <strong><a href="fsrtloplockfsctrlex" title="NTSTATUS FsRtlOplockFsctrlEx(&#10;  [in] POPLOCK Oplock,&#10;  [in] PIRP    Irp,&#10;  [in] ULONG   OpenCount,&#10;  [in] ULONG   Flags&#10;);">FsRtlOplockFsctrlEx</a></strong>. STATUS_INVALID_PARAMETER is an error code.</td>
</tr>
<tr>
  <td>STATUS_OPLOCK_NOT_GRANTED</td>
  <td>The oplock could not be granted. The level of the requested upper file system oplock is not valid for the oplock granted for the lower file system. STATUS_OPLOCK_NOT_GRANTED is an error code.</td>
</tr>
<tr>
  <td>STATUS_PENDING</td>
  <td>Used only for FSCTL operations. The meaning of STATUS_PENDING depends on the FSCTL code. For more information, see the Remarks section in <strong><a href="fsrtloplockfsctrlex" title="NTSTATUS FsRtlOplockFsctrlEx(&#10;  [in] POPLOCK Oplock,&#10;  [in] PIRP    Irp,&#10;  [in] ULONG   OpenCount,&#10;  [in] ULONG   Flags&#10;);">FsRtlOplockFsctrlEx</a></strong>. STATUS_PENDING is a success code.</td>
</tr>
<tr>
  <td>STATUS_CANNOT_GRANT_REQUESTED_OPLOCK</td>
  <td>An oplock acknowledgement for a new oplock is not allowed. The level of the upper file system of lock is not valid for the lower file system oplock.</td>
</tr>
</tbody>
</table>

<h2 id="see-also">See also</h2>

<p><strong><a href="fsrtlcheckupperoplock" title="NTSTATUS FsRtlCheckUpperOplock(&#10;  [in]           POPLOCK                       Oplock,&#10;  [in]           ULONG                         NewLowerOplockState,&#10;  [in, optional] PVOID                         CompletionRoutineContext,&#10;  [in, optional] POPLOCK_WAIT_COMPLETE_ROUTINE CompletionRoutine,&#10;                 POPLOCK_FS_PREPOST_IRP        PrePendRoutine,&#10;  [in]           ULONG                         Flags&#10;);">FsRtlCheckUpperOplock</a></strong></p>

<p><strong><a href="fsrtloplockfsctrlex" title="NTSTATUS FsRtlOplockFsctrlEx(&#10;  [in] POPLOCK Oplock,&#10;  [in] PIRP    Irp,&#10;  [in] ULONG   OpenCount,&#10;  [in] ULONG   Flags&#10;);">FsRtlOplockFsctrlEx</a></strong></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-_fsrtl_advanced_fcb_header-fsrtlupperoplockfsctrl">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/nf-ntifs-_fsrtl_advanced_fcb_header-fsrtlupperoplockfsctrl.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
