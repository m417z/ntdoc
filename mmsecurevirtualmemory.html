<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="MmSecureVirtualMemory - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>MmSecureVirtualMemory - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            MmSecureVirtualMemory - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntddk.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">HANDLE MmSecureVirtualMemory(
  [in] PVOID  Address,
  [in] <a href="size_t-2" title="typedef ULONG_PTR SIZE_T;">SIZE_T</a> Size,
  [in] <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>  ProbeMode
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntddk/nf-ntddk-mmsecurevirtualmemory">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/mmsecurevirtualmemory.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ntddk-mmsecurevirtualmemory)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2>Description</h2>

<p>The <strong>MmSecureVirtualMemory</strong> routine secures a user-space memory address range so that it cannot be freed and its page protection cannot be made more restrictive.</p>

<h2>Parameters</h2>

<h3><code>Address</code> [in]</h3>

<p>The beginning of the user virtual address range to secure.</p>

<h3><code>Size</code> [in]</h3>

<p>The size, in bytes, of the virtual address range to secure.</p>

<h3><code>ProbeMode</code> [in]</h3>

<p>Specifies the most restrictive page protection that is allowed. Use <a href="page_readwrite" title="#define PAGE_READWRITE 0x04 // Enables read-only or read/write access to the committed region of pages.">PAGE_READWRITE</a> to specify that the address range must remain both readable and writable, or use <a href="page_readonly" title="#define PAGE_READONLY 0x02 // Enables read-only access to the committed region of pages. An attempt to write or execute the committed region results in an access violation.">PAGE_READONLY</a> to specify that the address range must only remain readable.</p>

<table>
<thead>
<tr>
  <th>ProbeMode</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td><a href="page_readwrite" title="#define PAGE_READWRITE 0x04 // Enables read-only or read/write access to the committed region of pages.">PAGE_READWRITE</a></td>
  <td>Protection cannot be changed to <a href="page_noaccess" title="#define PAGE_NOACCESS 0x01 // Disables all access to the committed region of pages. An attempt to read from, write to, or execute the committed region results in an access violation.">PAGE_NOACCESS</a> or <a href="page_readonly" title="#define PAGE_READONLY 0x02 // Enables read-only access to the committed region of pages. An attempt to write or execute the committed region results in an access violation.">PAGE_READONLY</a>. All other protection changes are allowed.</td>
</tr>
<tr>
  <td><a href="page_readonly" title="#define PAGE_READONLY 0x02 // Enables read-only access to the committed region of pages. An attempt to write or execute the committed region results in an access violation.">PAGE_READONLY</a></td>
  <td>Protection cannot be changed to <a href="page_noaccess" title="#define PAGE_NOACCESS 0x01 // Disables all access to the committed region of pages. An attempt to read from, write to, or execute the committed region results in an access violation.">PAGE_NOACCESS</a>. All other protection changes are allowed.</td>
</tr>
</tbody>
</table>

<h2>Return value</h2>

<p>On success, <strong>MmSecureVirtualMemory</strong> returns an opaque pointer value that the driver passes to the <a href="mmunsecurevirtualmemory" title="VOID MmUnsecureVirtualMemory(&#10;  [in] HANDLE SecureHandle&#10;);">MmUnsecureVirtualMemory</a> routine to unsecure the memory address range. If the routine is unable to secure the memory address range, it returns <strong>NULL</strong>.</p>

<h2>Remarks</h2>

<p><strong>MmSecureVirtualMemory</strong> can be used to avoid certain race conditions on user-mode buffers. For example, if a driver checks to see if the buffer is writable, but then the originating user-mode process changes the buffer to be read-only before the driver can write to the buffer, then a race condition can result. The driver can use <strong>MmSecureVirtualMemory</strong> with <a href="page_readwrite" title="#define PAGE_READWRITE 0x04 // Enables read-only or read/write access to the committed region of pages.">PAGE_READWRITE</a> probe mode to guarantee that the buffer will remain writable until the driver calls <strong><a href="mmunsecurevirtualmemory" title="VOID MmUnsecureVirtualMemory(&#10;  [in] HANDLE SecureHandle&#10;);">MmUnsecureVirtualMemory</a></strong>. The routine also protects against the originating user-mode process freeing the buffer. Here are a few guidelines about calling these routines:</p>

<ul>
<li><p>Calling <strong>MmSecureVirtualMemory</strong> with <a href="page_readonly" title="#define PAGE_READONLY 0x02 // Enables read-only access to the committed region of pages. An attempt to write or execute the committed region results in an access violation.">PAGE_READONLY</a> does not guarantee that the buffer will remain read-only. The read-only probe mode prevents the user from changing the protection of the buffer to <a href="page_noaccess" title="#define PAGE_NOACCESS 0x01 // Disables all access to the committed region of pages. An attempt to read from, write to, or execute the committed region results in an access violation.">PAGE_NOACCESS</a>. It does <em>not</em> prevent changing the protection to <a href="page_readwrite" title="#define PAGE_READWRITE 0x04 // Enables read-only or read/write access to the committed region of pages.">PAGE_READWRITE</a> (or <a href="page_writecopy" title="#define PAGE_WRITECOPY 0x08 // Enables read-only or copy-on-write access to a mapped view of a file mapping object.">PAGE_WRITECOPY</a>, for mapped views).</p></li>
<li><p>If a driver calls <strong>MmSecureVirtualMemory</strong> and does not call <a href="mmunsecurevirtualmemory" title="VOID MmUnsecureVirtualMemory(&#10;  [in] HANDLE SecureHandle&#10;);">MmUnsecureVirtualMemory</a>, the memory is automatically unsecured when the process terminates.</p></li>
<li><p>If the driver calls <a href="mmunsecurevirtualmemory" title="VOID MmUnsecureVirtualMemory(&#10;  [in] HANDLE SecureHandle&#10;);">MmUnsecureVirtualMemory</a>, it must call it in the context of the process in which the memory was originally secured, and before that process terminates.</p></li>
<li><p>Typically drivers need to reference the process when they secure the memory, then later call <a href="kestackattachprocess" title="VOID KeStackAttachProcess(&#10;        PRKPROCESS   PROCESS,&#10;  [out] PRKAPC_STATE ApcState&#10;);">KeStackAttachProcess</a> to switch to the context of that process before calling <a href="mmunsecurevirtualmemory" title="VOID MmUnsecureVirtualMemory(&#10;  [in] HANDLE SecureHandle&#10;);">MmUnsecureVirtualMemory</a>.</p></li>
<li><p>To detect process termination drivers can use <a href="pssetcreateprocessnotifyroutine" title="NTSTATUS PsSetCreateProcessNotifyRoutine(&#10;  [in] PCREATE_PROCESS_NOTIFY_ROUTINE NotifyRoutine,&#10;  [in] BOOLEAN                        Remove&#10;);">PsSetCreateProcessNotifyRoutine</a>. Alternatively, the process can submit an <a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a> with a cancel routine that is invoked by the I/O manager when the process is exiting. In the cancel routine the driver can attach to the process and call <a href="mmunsecurevirtualmemory" title="VOID MmUnsecureVirtualMemory(&#10;  [in] HANDLE SecureHandle&#10;);">MmUnsecureVirtualMemory</a>.</p></li>
</ul>

<p>While <strong>MmSecureVirtualMemory</strong> can be used to guarantee that reading or writing user memory will not raise an exception due to insufficient page permissions, it does not protect against other types of exceptions. For example, it does not protect against exceptions raised when the system finds a bad disk block in the page file. Therefore, drivers must still wrap all user memory accesses in a <strong>try/except</strong> block. Because of this, we recommend that drivers do not use this function. For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/handling-exceptions">Handling Exceptions</a>.</p>

<h2>See also</h2>

<p><a href="mmunsecurevirtualmemory" title="VOID MmUnsecureVirtualMemory(&#10;  [in] HANDLE SecureHandle&#10;);">MmUnsecureVirtualMemory</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntddk/nf-ntddk-mmsecurevirtualmemory">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntddk/nf-ntddk-mmsecurevirtualmemory.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
