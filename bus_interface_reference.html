<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="BUS_INTERFACE_REFERENCE - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>BUS_INTERFACE_REFERENCE - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            BUS_INTERFACE_REFERENCE - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ks.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">typedef struct {
  <a href="interface" title="typedef struct _INTERFACE {&#10;  USHORT                 Size;&#10;  USHORT                 Version;&#10;  PVOID                  Context;&#10;  PINTERFACE_REFERENCE   InterfaceReference;&#10;  PINTERFACE_DEREFERENCE InterfaceDereference;&#10;} INTERFACE, *PINTERFACE;">INTERFACE</a>                  Interface;
  <a href="pfnreferencedeviceobject" title="PFNREFERENCEDEVICEOBJECT Pfnreferencedeviceobject;&#10;&#10;VOID Pfnreferencedeviceobject(&#10;  [in] PVOID Context&#10;)&#10;{...}">PFNREFERENCEDEVICEOBJECT</a>   ReferenceDeviceObject;
  <a href="pfndereferencedeviceobject" title="PFNDEREFERENCEDEVICEOBJECT Pfndereferencedeviceobject;&#10;&#10;VOID Pfndereferencedeviceobject(&#10;  [in] PVOID Context&#10;)&#10;{...}">PFNDEREFERENCEDEVICEOBJECT</a> DereferenceDeviceObject;
  <a href="pfnqueryreferencestring" title="PFNQUERYREFERENCESTRING Pfnqueryreferencestring;&#10;&#10;NTSTATUS Pfnqueryreferencestring(&#10;  [in]      PVOID Context,&#10;  [in, out] PWCHAR *String&#10;)&#10;{...}">PFNQUERYREFERENCESTRING</a>    QueryReferenceString;
} BUS_INTERFACE_REFERENCE, *PBUS_INTERFACE_REFERENCE;</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ks/ns-ks-bus_interface_reference">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/bus_interface_reference.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ns-ks-bus_interface_reference)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="bus_interface_reference-structure">BUS_INTERFACE_REFERENCE structure</h1>

<h2 id="description">Description</h2>

<p>A software device enumerator exports this interface to allow drivers to reference count physical device objects (PDOs) such that the device remains active while in use and is unloaded when not in use.</p>

<h2 id="members">Members</h2>

<h3 id="interface"><code>Interface</code></h3>

<p>Specifies the exported <a href="interface" title="typedef struct _INTERFACE {&#10;  USHORT                 Size;&#10;  USHORT                 Version;&#10;  PVOID                  Context;&#10;  PINTERFACE_REFERENCE   InterfaceReference;&#10;  PINTERFACE_DEREFERENCE InterfaceDereference;&#10;} INTERFACE, *PINTERFACE;">INTERFACE</a>.</p>

<h3 id="referencedeviceobject"><code>ReferenceDeviceObject</code></h3>

<p>Pointer to a driver-supplied <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ks/nc-ks-pfnreferencedeviceobject">KStrReferenceDeviceObject</a> routine.</p>

<h3 id="dereferencedeviceobject"><code>DereferenceDeviceObject</code></h3>

<p>Pointer to a driver-supplied <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ks/nc-ks-pfndereferencedeviceobject">KStrDereferenceDeviceObject</a> routine.</p>

<h3 id="queryreferencestring"><code>QueryReferenceString</code></h3>

<p>Pointer to a driver-supplied <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ks/nc-ks-pfnqueryreferencestring">KStrQueryReferenceString</a> routine.</p>

<h2 id="remarks">Remarks</h2>

<p>A driver obtains a BUS_INTERFACE_REFERENCE interface by creating and sending an <a href="irp_mj_pnp" title="#define IRP_MJ_PNP 0x1b">IRP_MJ_PNP</a> request that specifies an <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/irp-mn-query-interface">IRP_MN_QUERY_INTERFACE</a> minor function code. To do this, the driver should:</p>

<ul>
<li>Allocate and zero-fill a BUS_INTERFACE_REFERENCE structure from the paged memory pool.</li>
<li>Create an <a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a> for the query interface request and get the next stack location for the new <a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a>.</li>
<li>In the new stack location, provide a pointer to the new BUS_INTERFACE_REFERENCE structure in the <strong>Parameters.QueryInterface.Interface</strong> member.</li>
<li>Set a completion routine and send the request down the driver stack.</li>
<li>If your request is successful, the system fills in the BUS_INTERFACE_REFERENCE structure pointed to by <strong>Parameters.QueryInterface.Interface</strong>.</li>
</ul>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ks/ns-ks-bus_interface_reference">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ks/ns-ks-bus_interface_reference.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
