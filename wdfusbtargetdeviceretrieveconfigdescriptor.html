<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="WdfUsbTargetDeviceRetrieveConfigDescriptor - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>WdfUsbTargetDeviceRetrieveConfigDescriptor - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            WdfUsbTargetDeviceRetrieveConfigDescriptor - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdfusb.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> WdfUsbTargetDeviceRetrieveConfigDescriptor(
  [in]      WDFUSBDEVICE UsbDevice,
  [out]     PVOID        ConfigDescriptor,
  [in, out] PUSHORT      ConfigDescriptorLength
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfusb/nf-wdfusb-wdfusbtargetdeviceretrieveconfigdescriptor">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/wdfusbtargetdeviceretrieveconfigdescriptor.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdfusb-wdfusbtargetdeviceretrieveconfigdescriptor)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="wdfusbtargetdeviceretrieveconfigdescriptor-function">WdfUsbTargetDeviceRetrieveConfigDescriptor function</h1>

<h2 id="description">Description</h2>

<p>[Applies to KMDF and UMDF]</p>

<p>The <strong>WdfUsbTargetDeviceRetrieveConfigDescriptor</strong> method retrieves the USB configuration descriptor for the USB device that is associated with a specified framework USB device object.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="usbdevice-in"><code>UsbDevice</code> [in]</h3>

<p>A handle to a USB device object that was obtained from a previous call to <a rel="noopener" target="_blank" href="wdfusbtargetdevicecreatewithparameters">WdfUsbTargetDeviceCreateWithParameters</a>.</p>

<h3 id="configdescriptor-out"><code>ConfigDescriptor</code> [out]</h3>

<p>A pointer to a caller-allocated buffer that receives a <a rel="noopener" target="_blank" href="usb_configuration_descriptor">USB_CONFIGURATION_DESCRIPTOR</a> structure, followed by one or more <a rel="noopener" target="_blank" href="usb_interface_descriptor">USB_INTERFACE_DESCRIPTOR</a> and <a rel="noopener" target="_blank" href="usb_endpoint_descriptor">USB_ENDPOINT_DESCRIPTOR</a> structures. This parameter is optional and can be <strong>NULL</strong>, in which case <strong>WdfUsbTargetDeviceRetrieveConfigDescriptor</strong> returns the required buffer length. For more information, see the following Remarks section.</p>

<h3 id="configdescriptorlength-in-out"><code>ConfigDescriptorLength</code> [in, out]</h3>

<p>A pointer to a location that supplies the length of the buffer that <em>ConfigDescriptor</em> points to. If the pointer that is supplied for <em>ConfigDescriptor</em> is <strong>NULL</strong>, <strong>WdfUsbTargetDeviceRetrieveConfigDescriptor</strong> returns the required buffer length at the location that is pointed to by <em>ConfigDescriptorLength</em>.</p>

<h2 id="return-value">Return value</h2>

<p><strong>WdfUsbTargetDeviceRetrieveConfigDescriptor</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the operation succeeds. Otherwise, this method can return one of the following values:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>STATUS_INVALID_DEVICE_STATE</strong></td>
  <td>A configuration descriptor was not available for the specified target.</td>
</tr>
<tr>
  <td><strong>STATUS_INVALID_PARAMETER</strong></td>
  <td>An invalid parameter was detected.</td>
</tr>
<tr>
  <td><strong>STATUS_BUFFER_TOO_SMALL</strong></td>
  <td>The specified buffer size was too small for the data, or the caller supplied <strong>NULL</strong> for the <em>ConfigDescriptor</em> parameter.</td>
</tr>
</tbody>
</table>

<p>This method also might return other <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/ntstatus-values">NTSTATUS values</a>.</p>

<p>A bug check occurs if the driver supplies an invalid object handle.</p>

<h2 id="remarks">Remarks</h2>

<p>The <strong>WdfUsbTargetDeviceRetrieveConfigDescriptor</strong> method retrieves all of the specified USB device's configuration information (that is, the configuration descriptor plus any interface or endpoint descriptors that might be present). To learn about the format of this information, see the USB specification.</p>

<p>You can use <a rel="noopener" target="_blank" href="wdfusbtargetdeviceselectconfig"><strong>WdfUsbTargetDeviceSelectConfig</strong></a> to select only the first USB configuration listed in the descriptor list, but you can select multiple interfaces within this single configuration.</p>

<p>Drivers should call <strong>WdfUsbTargetDeviceRetrieveConfigDescriptor</strong> twice, as follows:</p>

<ol>
<li>Set the <em>ConfigDescriptor</em> pointer to <strong>NULL</strong>, so that <strong>WdfUsbTargetDeviceRetrieveConfigDescriptor</strong> will return the required buffer size in the address that <em>ConfigDescriptorLength</em> points to.</li>
<li>Allocate buffer space to hold the configuration information. For example, a driver might call <a rel="noopener" target="_blank" href="exallocatepoolwithtag">ExAllocatePoolWithTag</a> to allocate a buffer, or it might call <a rel="noopener" target="_blank" href="wdfmemorycreate">WdfMemoryCreate</a> to create a framework memory object.</li>
<li>Call <strong>WdfUsbTargetDeviceRetrieveConfigDescriptor</strong> again, passing it a pointer to the new buffer and the buffer's size.</li>
</ol>

<p>After the second call to <strong>WdfUsbTargetDeviceRetrieveConfigDescriptor</strong> returns, the buffer that is pointed to by <em>ConfigDescriptor</em> contains a <a rel="noopener" target="_blank" href="usb_configuration_descriptor">USB_CONFIGURATION_DESCRIPTOR</a> structure, followed by one or more <a rel="noopener" target="_blank" href="usb_interface_descriptor">USB_INTERFACE_DESCRIPTOR</a> and <a rel="noopener" target="_blank" href="usb_endpoint_descriptor">USB_ENDPOINT_DESCRIPTOR</a> structures. These latter structures are arranged in the order that is described in the USB specification.</p>

<p>For more information about the <strong>WdfUsbTargetDeviceRetrieveConfigDescriptor</strong> method and USB I/O targets, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/wdf/usb-i-o-targets">USB I/O Targets</a>.</p>

<h4 id="examples">Examples</h4>

<p>The following code example calls <strong>WdfUsbTargetDeviceRetrieveConfigDescriptor</strong> to obtain the required buffer size, calls <a rel="noopener" target="_blank" href="wdfmemorycreate">WdfMemoryCreate</a> to create a memory object and buffer, and then calls <strong>WdfUsbTargetDeviceRetrieveConfigDescriptor</strong> again to obtain a device's configuration information.</p>

<div class="codehilite">
<pre><span></span><code><span class="n"><a href="ushort" title="typedef unsigned short USHORT;">USHORT</a></span><span class="w">  </span><span class="n">size</span><span class="p">;</span>
<span class="n"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a></span><span class="w">  </span><span class="n">ntStatus</span><span class="p">;</span>
<span class="n">PMY_DEVICE_CONTEXT</span><span class="w">  </span><span class="n">myDeviceContext</span><span class="p">;</span>
<span class="n"><a href="usb_configuration_descriptor" title="typedef struct _USB_CONFIGURATION_DESCRIPTOR {&#10;  UCHAR  bLength;&#10;  UCHAR  bDescriptorType;&#10;  USHORT wTotalLength;&#10;  UCHAR  bNumInterfaces;&#10;  UCHAR  bConfigurationValue;&#10;  UCHAR  iConfiguration;&#10;  UCHAR  bmAttributes;&#10;  UCHAR  MaxPower;&#10;} USB_CONFIGURATION_DESCRIPTOR, *PUSB_CONFIGURATION_DESCRIPTOR;">PUSB_CONFIGURATION_DESCRIPTOR</a></span><span class="w">  </span><span class="n">configurationDescriptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="n"><a href="wdf_object_attributes" title="typedef struct _WDF_OBJECT_ATTRIBUTES {&#10;  ULONG                          Size;&#10;  PFN_WDF_OBJECT_CONTEXT_CLEANUP EvtCleanupCallback;&#10;  PFN_WDF_OBJECT_CONTEXT_DESTROY EvtDestroyCallback;&#10;  WDF_EXECUTION_LEVEL            ExecutionLevel;&#10;  WDF_SYNCHRONIZATION_SCOPE      SynchronizationScope;&#10;  WDFOBJECT                      ParentObject;&#10;  size_t                         ContextSizeOverride;&#10;  PCWDF_OBJECT_CONTEXT_TYPE_INFO ContextTypeInfo;&#10;} WDF_OBJECT_ATTRIBUTES, *PWDF_OBJECT_ATTRIBUTES;">WDF_OBJECT_ATTRIBUTES</a></span><span class="w">  </span><span class="n">objectAttribs</span><span class="p">;</span>
<span class="n">WDFMEMORY</span><span class="w">  </span><span class="n">memoryHandle</span><span class="p">;</span>

<span class="n">myDeviceContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetDeviceContext</span><span class="p">(</span><span class="n">Device</span><span class="p">);</span>

<span class="n">ntStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WdfUsbTargetDeviceRetrieveConfigDescriptor</span><span class="p">(</span>
<span class="w">                                            </span><span class="n">myDeviceContext</span><span class="o">-&gt;</span><span class="n">WdfUsbTargetDevice</span><span class="p">,</span>
<span class="w">                                            </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                                            </span><span class="o">&amp;</span><span class="n">size</span>
<span class="w">                                            </span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ntStatus</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">STATUS_BUFFER_TOO_SMALL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ntStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="n"><a href="wdf_object_attributes_init" title="VOID WDF_OBJECT_ATTRIBUTES_INIT(&#10;  [out] PWDF_OBJECT_ATTRIBUTES Attributes&#10;);">WDF_OBJECT_ATTRIBUTES_INIT</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">objectAttribs</span><span class="p">);</span>
<span class="n">objectAttribs</span><span class="p">.</span><span class="n">ParentObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myDeviceContext</span><span class="o">-&gt;</span><span class="n">WdfUsbTargetDevice</span><span class="p">;</span>

<span class="n">ntStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="wdfmemorycreate" title="NTSTATUS WdfMemoryCreate(&#10;  [in, optional]  PWDF_OBJECT_ATTRIBUTES Attributes,&#10;  [in]            POOL_TYPE              PoolType,&#10;  [in, optional]  ULONG                  PoolTag,&#10;  [in]            size_t                 BufferSize,&#10;  [out]           WDFMEMORY              *Memory,&#10;  [out, optional] PVOID                  *Buffer&#10;);">WdfMemoryCreate</a></span><span class="p">(</span>
<span class="w">                           </span><span class="o">&amp;</span><span class="n">objectAttribs</span><span class="p">,</span>
<span class="w">                           </span><span class="n">NonPagedPool</span><span class="p">,</span>
<span class="w">                           </span><span class="n">POOL_TAG</span><span class="p">,</span>
<span class="w">                           </span><span class="n">size</span><span class="p">,</span>
<span class="w">                           </span><span class="o">&amp;</span><span class="n">memoryHandle</span><span class="p">,</span>
<span class="w">                           </span><span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="o">&amp;</span><span class="n">configurationDescriptor</span>
<span class="w">                           </span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n"><a href="nt_success" title="#define NT_SUCCESS(Status) (((NTSTATUS)(Status)) &gt;= 0)">NT_SUCCESS</a></span><span class="p">(</span><span class="n">ntStatus</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ntStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">ntStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WdfUsbTargetDeviceRetrieveConfigDescriptor</span><span class="p">(</span>
<span class="w">                                            </span><span class="n">myDeviceContext</span><span class="o">-&gt;</span><span class="n">WdfUsbTargetDevice</span><span class="p">,</span>
<span class="w">                                            </span><span class="n">configurationDescriptor</span><span class="p">,</span>
<span class="w">                                            </span><span class="o">&amp;</span><span class="n">size</span>
<span class="w">                                            </span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n"><a href="nt_success" title="#define NT_SUCCESS(Status) (((NTSTATUS)(Status)) &gt;= 0)">NT_SUCCESS</a></span><span class="p">(</span><span class="n">ntStatus</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ntStatus</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="exallocatepoolwithtag">ExAllocatePoolWithTag</a></p>

<p><a rel="noopener" target="_blank" href="usb_configuration_descriptor">USB_CONFIGURATION_DESCRIPTOR</a></p>

<p><a rel="noopener" target="_blank" href="usb_endpoint_descriptor">USB_ENDPOINT_DESCRIPTOR</a></p>

<p><a rel="noopener" target="_blank" href="usb_interface_descriptor">USB_INTERFACE_DESCRIPTOR</a></p>

<p><a rel="noopener" target="_blank" href="wdfusbtargetdevicecreatewithparameters">WdfUsbTargetDeviceCreateWithParameters</a></p>

<p><a rel="noopener" target="_blank" href="wdfusbtargetdevicegetdevicedescriptor">WdfUsbTargetDeviceGetDeviceDescriptor</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfusb/nf-wdfusb-wdfusbtargetdeviceretrieveconfigdescriptor">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdfusb/nf-wdfusb-wdfusbtargetdeviceretrieveconfigdescriptor.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
