<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="NtAdjustGroupsToken - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>NtAdjustGroupsToken - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
        <link rel="stylesheet" href="modules/highlight.js/styles/github.ntdoc.min.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/highlight.js/styles/github-dark-dimmed.ntdoc.min.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            NtAdjustGroupsToken - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header language-cpp">#ifndef _NTSEAPI_H

</span><span class="ntdoc-code-intro language-cpp">/**
 * The NtAdjustGroupsToken routine enables or disables groups in the specified access token.
 *
 * \param TokenHandle Handle to the token that contains the groups to be modified. The handle must have TOKEN_ADJUST_GROUPS access.
 * \param ResetToDefault Specifies whether the function resets the groups to the default state. If this value is TRUE, the function resets all groups to their default state and ignores the NewState parameter.
 * \param NewState A pointer to a <a href="token_groups" title="typedef struct _TOKEN_GROUPS&#10;{&#10;    ULONG GroupCount;&#10;    SID_AND_ATTRIBUTES Groups[ANYSIZE_ARRAY];&#10;} TOKEN_GROUPS, *PTOKEN_GROUPS;">TOKEN_GROUPS</a> structure that specifies an array of groups and their attributes. If ResetToDefault is TRUE, the function ignores this parameter.
 * \param BufferLength Specifies the size, in bytes, of the buffer pointed to by the PreviousState parameter. This parameter can be zero if the PreviousState parameter is NULL.
 * \param PreviousState A pointer to a buffer that the function fills with a <a href="token_groups" title="typedef struct _TOKEN_GROUPS&#10;{&#10;    ULONG GroupCount;&#10;    SID_AND_ATTRIBUTES Groups[ANYSIZE_ARRAY];&#10;} TOKEN_GROUPS, *PTOKEN_GROUPS;">TOKEN_GROUPS</a> structure that contains the previous state of any groups that the function modifies.
 * \param ReturnLength A pointer to a variable that receives the required size, in bytes, of the buffer pointed to by the PreviousState parameter. This parameter can be NULL if PreviousState is NULL.
 * \return <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> Successful or errant status.
 * \sa https://learn.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-adjusttokengroups
 */
</span><span class="ntdoc-code-body language-cpp">NTSYSCALLAPI
<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a>
NTAPI
NtAdjustGroupsToken(
    _In_ HANDLE TokenHandle,
    _In_ BOOLEAN ResetToDefault,
    _In_opt_ <a href="token_groups" title="typedef struct _TOKEN_GROUPS&#10;{&#10;    ULONG GroupCount;&#10;    SID_AND_ATTRIBUTES Groups[ANYSIZE_ARRAY];&#10;} TOKEN_GROUPS, *PTOKEN_GROUPS;">PTOKEN_GROUPS</a> NewState,
    _In_opt_ <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> BufferLength,
    _Out_writes_bytes_to_opt_(BufferLength, *ReturnLength) <a href="token_groups" title="typedef struct _TOKEN_GROUPS&#10;{&#10;    ULONG GroupCount;&#10;    SID_AND_ATTRIBUTES Groups[ANYSIZE_ARRAY];&#10;} TOKEN_GROUPS, *PTOKEN_GROUPS;">PTOKEN_GROUPS</a> PreviousState,
    _Out_opt_ PULONG ReturnLength
    );
</span><span class="ntdoc-code-footer language-cpp">
#endif
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://github.com/winsiderss/systeminformer/blob/1c51abc47aeb7ebb428156de293fd87ca3576e9e/phnt/include/ntseapi.h#L776">View code on GitHub</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header language-cpp">#ifndef _NTZWAPI_H

</span><span class="ntdoc-code-intro language-cpp"></span><span class="ntdoc-code-body language-cpp">NTSYSCALLAPI
<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a>
NTAPI
ZwAdjustGroupsToken(
    _In_ HANDLE TokenHandle,
    _In_ BOOLEAN ResetToDefault,
    _In_opt_ <a href="token_groups" title="typedef struct _TOKEN_GROUPS&#10;{&#10;    ULONG GroupCount;&#10;    SID_AND_ATTRIBUTES Groups[ANYSIZE_ARRAY];&#10;} TOKEN_GROUPS, *PTOKEN_GROUPS;">PTOKEN_GROUPS</a> NewState,
    _In_opt_ <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> BufferLength,
    _Out_writes_bytes_to_opt_(BufferLength, *ReturnLength) <a href="token_groups" title="typedef struct _TOKEN_GROUPS&#10;{&#10;    ULONG GroupCount;&#10;    SID_AND_ATTRIBUTES Groups[ANYSIZE_ARRAY];&#10;} TOKEN_GROUPS, *PTOKEN_GROUPS;">PTOKEN_GROUPS</a> PreviousState,
    _Out_opt_ PULONG ReturnLength
    );
</span><span class="ntdoc-code-footer language-cpp">
#endif
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://github.com/winsiderss/systeminformer/blob/1c51abc47aeb7ebb428156de293fd87ca3576e9e/phnt/include/ntzwapi.h#L211">View code on GitHub</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<p>Enables and disables groups in the token.</p>
<h1>Parameters</h1>
<ul>
<li><code>TokenHandle</code> - a handle to the token. The handle must grant <code>TOKEN_ADJUST_GROUPS</code> access. Additionally, the handle must grant <code>TOKEN_QUERY</code> when the caller provides the <code>PreviousState</code> buffer.</li>
<li><code>ResetToDefault</code> - a boolean indicating if the function should reset group states to their defaults based on the presence of <code>SE_GROUP_ENABLED_BY_DEFAULT</code> flag.</li>
<li><code>NewState</code> - an optional pointer to a collection of group SIDs with their desired states, such as <code>SE_GROUP_DISABLED</code> (<code>0</code>) or <code>SE_GROUP_ENABLED</code>.</li>
<li><code>BufferLength</code> - the size of the <code>PreviousState</code> buffer in bytes.</li>
<li><code>PreviousState</code> - an optional pointer to a user-allocated buffer that receives the state of token groups prior to adjustment.</li>
<li><code>ReturnLength</code> - an optional pointer to a variable that receives the number of bytes written to the <code>PreviousState</code> buffer when the function succeeds or the number of bytes requires when the buffer is too small.</li>
</ul>
<h1>Notable return values</h1>
<ul>
<li><code>STATUS_CANT_ENABLE_DENY_ONLY</code> - the caller attempted to enable a group that has <code>SE_GROUP_USE_FOR_DENY_ONLY</code> flag set.</li>
<li><code>STATUS_CANT_DISABLE_MANDATORY</code> - the caller attempted to disable a group that has <code>SE_GROUP_MANDATORY</code> flag set.</li>
<li><code>STATUS_NOT_ALL_ASSIGNED</code> - this successful status indicates that not all of the requested groups were adjusted, such as when they are not present.</li>
<li><code>STATUS_BUFFER_TOO_SMALL</code> - the previous state data does not fit into the provided buffer.</li>
</ul>
<h1>Remarks</h1>
<p>Groups are taken into account for granting access checks when they have <code>SE_GROUP_ENABLED</code> flag set. Groups are taken into account for denying access checks when they have either <code>SE_GROUP_ENABLED</code> or <code>SE_GROUP_USE_FOR_DENY_ONLY</code> flags set.</p>
<p>Note that this function does not support token pseudo-handles such as <code><a href="ntcurrentprocesstoken" title="#define NtCurrentProcessToken() ((HANDLE)(LONG_PTR)-4) // NtOpenProcessToken(NtCurrentProcess())">NtCurrentProcessToken</a></code>. If you want to adjust the current process/thread token, you need to open it first.</p>
<h1>Related Win32 API</h1>
<ul>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-adjusttokengroups"><code>AdjustTokenGroups</code></a></li>
</ul>
<h1>See also</h1>
<ul>
<li><code><a href="ntfiltertoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtFilterToken(&#10;    _In_ HANDLE ExistingTokenHandle,&#10;    _In_ ULONG Flags,&#10;    _In_opt_ PTOKEN_GROUPS SidsToDisable,&#10;    _In_opt_ PTOKEN_PRIVILEGES PrivilegesToDelete,&#10;    _In_opt_ PTOKEN_GROUPS RestrictedSids,&#10;    _Out_ PHANDLE NewTokenHandle&#10;    );">NtFilterToken</a></code></li>
<li><code><a href="ntadjustprivilegestoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAdjustPrivilegesToken(&#10;    _In_ HANDLE TokenHandle,&#10;    _In_ BOOLEAN DisableAllPrivileges,&#10;    _In_opt_ PTOKEN_PRIVILEGES NewState,&#10;    _In_ ULONG BufferLength,&#10;    _Out_writes_bytes_to_opt_(BufferLength, *ReturnLength) PTOKEN_PRIVILEGES PreviousState,&#10;    _Out_opt_ PULONG ReturnLength&#10;    );">NtAdjustPrivilegesToken</a></code></li>
<li><code><a href="ntopenprocesstoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtOpenProcessToken(&#10;    _In_ HANDLE ProcessHandle,&#10;    _In_ ACCESS_MASK DesiredAccess,&#10;    _Out_ PHANDLE TokenHandle&#10;    );">NtOpenProcessToken</a></code></li>
<li><code><a href="ntopenthreadtoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtOpenThreadToken(&#10;    _In_ HANDLE ThreadHandle,&#10;    _In_ ACCESS_MASK DesiredAccess,&#10;    _In_ BOOLEAN OpenAsSelf,&#10;    _Out_ PHANDLE TokenHandle&#10;    );">NtOpenThreadToken</a></code></li>
</ul>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ntadjustgroupstoken.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>NTinternals.net (undocumented.ntinternals.net)</h1>
</div>
<div class="ntdoc-description">
<p>Function <code>NtAdjustGroupsToken</code> modify state of one or more groups available for Token Object. See also description of similar <em>Win32 API</em> <strong>AdjustTokenGroups</strong> in <em>Win32 SDK</em>.</p>
<h3>TokenHandle</h3>
<p><code>HANDLE</code> to Token Object opened with <code>TOKEN_ADJUST_GROUPS</code> access.</p>
<h3>ResetToDefault</h3>
<p>If set, groups are reset to token's defaults. In this case all other parameters are ignored.</p>
<h3>TokenGroups</h3>
<p>Pointer to <code><a href="token_groups" title="typedef struct _TOKEN_GROUPS&#10;{&#10;    ULONG GroupCount;&#10;    SID_AND_ATTRIBUTES Groups[ANYSIZE_ARRAY];&#10;} TOKEN_GROUPS, *PTOKEN_GROUPS;">TOKEN_GROUPS</a></code> structure containing groups to modify.</p>
<h3>PreviousGroupsLength</h3>
<p>Specifies length of <code>PreviousGroups</code> buffer, in bytes.</p>
<h3>PreviousGroups</h3>
<p>Optionally pointer to <code><a href="token_groups" title="typedef struct _TOKEN_GROUPS&#10;{&#10;    ULONG GroupCount;&#10;    SID_AND_ATTRIBUTES Groups[ANYSIZE_ARRAY];&#10;} TOKEN_GROUPS, *PTOKEN_GROUPS;">TOKEN_GROUPS</a></code> buffer receiving information about modified groups before modification begins.</p>
<h3>RequiredLength</h3>
<p>If <code>PreviousGroups</code> parameter is specified, and <code>PreviousGroupsLength</code> is to small, this value receives required length of buffer, in bytes.</p>
<h1>Documented by</h1>
<ul>
<li>Tomasz Nowak</li>
</ul>
<h1>See also</h1>
<ul>
<li><code><a href="ntadjustprivilegestoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAdjustPrivilegesToken(&#10;    _In_ HANDLE TokenHandle,&#10;    _In_ BOOLEAN DisableAllPrivileges,&#10;    _In_opt_ PTOKEN_PRIVILEGES NewState,&#10;    _In_ ULONG BufferLength,&#10;    _Out_writes_bytes_to_opt_(BufferLength, *ReturnLength) PTOKEN_PRIVILEGES PreviousState,&#10;    _Out_opt_ PULONG ReturnLength&#10;    );">NtAdjustPrivilegesToken</a></code></li>
<li><code><a href="ntcreatetoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtCreateToken(&#10;    _Out_ PHANDLE TokenHandle,&#10;    _In_ ACCESS_MASK DesiredAccess,&#10;    _In_opt_ POBJECT_ATTRIBUTES ObjectAttributes,&#10;    _In_ TOKEN_TYPE Type,&#10;    _In_ PLUID AuthenticationId,&#10;    _In_ PLARGE_INTEGER ExpirationTime,&#10;    _In_ PTOKEN_USER User,&#10;    _In_ PTOKEN_GROUPS Groups,&#10;    _In_ PTOKEN_PRIVILEGES Privileges,&#10;    _In_opt_ PTOKEN_OWNER Owner,&#10;    _In_ PTOKEN_PRIMARY_GROUP PrimaryGroup,&#10;    _In_opt_ PTOKEN_DEFAULT_DACL DefaultDacl,&#10;    _In_ PTOKEN_SOURCE Source&#10;    );">NtCreateToken</a></code></li>
<li><code><a href="ntopenprocesstoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtOpenProcessToken(&#10;    _In_ HANDLE ProcessHandle,&#10;    _In_ ACCESS_MASK DesiredAccess,&#10;    _Out_ PHANDLE TokenHandle&#10;    );">NtOpenProcessToken</a></code></li>
<li><code><a href="ntopenthreadtoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtOpenThreadToken(&#10;    _In_ HANDLE ThreadHandle,&#10;    _In_ ACCESS_MASK DesiredAccess,&#10;    _In_ BOOLEAN OpenAsSelf,&#10;    _Out_ PHANDLE TokenHandle&#10;    );">NtOpenThreadToken</a></code></li>
<li><code><a href="ntqueryinformationtoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtQueryInformationToken(&#10;    _In_ HANDLE TokenHandle,&#10;    _In_ TOKEN_INFORMATION_CLASS TokenInformationClass,&#10;    _Out_writes_bytes_to_opt_(TokenInformationLength, *ReturnLength) PVOID TokenInformation,&#10;    _In_ ULONG TokenInformationLength,&#10;    _Out_ PULONG ReturnLength&#10;    );">NtQueryInformationToken</a></code></li>
<li><code><a href="ntsetinformationtoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtSetInformationToken(&#10;    _In_ HANDLE TokenHandle,&#10;    _In_ TOKEN_INFORMATION_CLASS TokenInformationClass,&#10;    _In_reads_bytes_(TokenInformationLength) PVOID TokenInformation,&#10;    _In_ ULONG TokenInformationLength&#10;    );">NtSetInformationToken</a></code></li>
<li><code><a href="token_groups" title="typedef struct _TOKEN_GROUPS&#10;{&#10;    ULONG GroupCount;&#10;    SID_AND_ATTRIBUTES Groups[ANYSIZE_ARRAY];&#10;} TOKEN_GROUPS, *PTOKEN_GROUPS;">TOKEN_GROUPS</a></code></li>
</ul>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/undocumented.ntinternals.net/ntadjustgroupstoken.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script src="modules/highlight.js/highlight.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
