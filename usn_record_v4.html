<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="USN_RECORD_V4 - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>USN_RECORD_V4 - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            USN_RECORD_V4 - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">typedef struct {
  <a href="usn_record_common_header" title="typedef struct {&#10;  ULONG  RecordLength;&#10;  USHORT MajorVersion;&#10;  USHORT MinorVersion;&#10;} USN_RECORD_COMMON_HEADER, *PUSN_RECORD_COMMON_HEADER;">USN_RECORD_COMMON_HEADER</a> Header;
  FILE_ID_128              FileReferenceNumber;
  FILE_ID_128              ParentFileReferenceNumber;
  USN                      Usn;
  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                    Reason;
  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                    SourceInfo;
  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                    RemainingExtents;
  <a href="ushort" title="typedef unsigned short USHORT;">USHORT</a>                   NumberOfExtents;
  <a href="ushort" title="typedef unsigned short USHORT;">USHORT</a>                   ExtentSize;
  <a href="usn_record_extent" title="typedef struct {&#10;  LONGLONG Offset;&#10;  LONGLONG Length;&#10;} USN_RECORD_EXTENT, *PUSN_RECORD_EXTENT;">USN_RECORD_EXTENT</a>        Extents[1];
} USN_RECORD_V4, *PUSN_RECORD_V4;</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ns-ntifs-usn_record_v4">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// winioctl.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">typedef struct {
  <a href="usn_record_common_header" title="typedef struct {&#10;  ULONG  RecordLength;&#10;  USHORT MajorVersion;&#10;  USHORT MinorVersion;&#10;} USN_RECORD_COMMON_HEADER, *PUSN_RECORD_COMMON_HEADER;">USN_RECORD_COMMON_HEADER</a> Header;
  FILE_ID_128              FileReferenceNumber;
  FILE_ID_128              ParentFileReferenceNumber;
  USN                      Usn;
  <a href="dword" title="typedef unsigned long DWORD;">DWORD</a>                    Reason;
  <a href="dword" title="typedef unsigned long DWORD;">DWORD</a>                    SourceInfo;
  <a href="dword" title="typedef unsigned long DWORD;">DWORD</a>                    RemainingExtents;
  <a href="word" title="typedef unsigned short WORD;">WORD</a>                     NumberOfExtents;
  <a href="word" title="typedef unsigned short WORD;">WORD</a>                     ExtentSize;
  <a href="usn_record_extent" title="typedef struct {&#10;  LONGLONG Offset;&#10;  LONGLONG Length;&#10;} USN_RECORD_EXTENT, *PUSN_RECORD_EXTENT;">USN_RECORD_EXTENT</a>        Extents[1];
} USN_RECORD_V4, *PUSN_RECORD_V4;</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows/win32/api/winioctl/ns-winioctl-usn_record_v4">View the official Win32 API reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/usn_record_v4.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ns-ntifs-usn_record_v4)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2>Description</h2>
<p>The <strong>USN_RECORD_V4</strong> structure contains the information for an update sequence number (USN) change journal version 4.0 record. The version 2.0 record is defined by the <strong><a href="usn_record_v2" title="typedef struct {&#10;  ULONG         RecordLength;&#10;  USHORT        MajorVersion;&#10;  USHORT        MinorVersion;&#10;  ULONGLONG     FileReferenceNumber;&#10;  ULONGLONG     ParentFileReferenceNumber;&#10;  USN           Usn;&#10;  LARGE_INTEGER TimeStamp;&#10;  ULONG         Reason;&#10;  ULONG         SourceInfo;&#10;  ULONG         SecurityId;&#10;  ULONG         FileAttributes;&#10;  USHORT        FileNameLength;&#10;  USHORT        FileNameOffset;&#10;  WCHAR         FileName[1];&#10;} USN_RECORD_V2, *PUSN_RECORD_V2;">USN_RECORD_V2</a></strong> structure (also called <strong>USN_RECORD</strong> structure). See <a href="https://learn.microsoft.com/windows/win32/api/winioctl/ns-winioctl-usn_record_v4">USN_RECORD_V4 structure (winioctl.h)</a> for details.</p>
<h2>Members</h2>
<h3><code>Header</code></h3>
<h3><code>FileReferenceNumber</code></h3>
<h3><code>ParentFileReferenceNumber</code></h3>
<h3><code>Usn</code></h3>
<h3><code>Reason</code></h3>
<h3><code>SourceInfo</code></h3>
<h3><code>RemainingExtents</code></h3>
<h3><code>NumberOfExtents</code></h3>
<h3><code>ExtentSize</code></h3>
<h3><code>Extents[1]</code></h3>
<h2>Remarks</h2>
<h2>See also</h2>
<p><strong><a href="fsctl_read_usn_journal" title="// CTL_CODE(0x0009, 0x02e, METHOD_NEITHER, FILE_ANY_ACCESS)&#10;#define FSCTL_READ_USN_JOURNAL 0x000900BB">FSCTL_READ_USN_JOURNAL</a></strong></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ns-ntifs-usn_record_v4">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/ns-ntifs-usn_record_v4.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Win32 API reference (ns-winioctl-usn_record_v4)</h1>
</div>
<div class="ntdoc-description">
<h1>USN_RECORD_V4 structure</h1>
<h2>Description</h2>
<p>Contains the information for an update sequence number (USN) change journal version 4.0 record. The version 2.0 and 3.0 records are defined by the <a href="usn_record_v2" title="typedef struct {&#10;  ULONG         RecordLength;&#10;  USHORT        MajorVersion;&#10;  USHORT        MinorVersion;&#10;  ULONGLONG     FileReferenceNumber;&#10;  ULONGLONG     ParentFileReferenceNumber;&#10;  USN           Usn;&#10;  LARGE_INTEGER TimeStamp;&#10;  ULONG         Reason;&#10;  ULONG         SourceInfo;&#10;  ULONG         SecurityId;&#10;  ULONG         FileAttributes;&#10;  USHORT        FileNameLength;&#10;  USHORT        FileNameOffset;&#10;  WCHAR         FileName[1];&#10;} USN_RECORD_V2, *PUSN_RECORD_V2;">USN_RECORD_V2</a> (also called <strong>USN_RECORD</strong>) and <a href="usn_record_v3" title="typedef struct {&#10;  ULONG         RecordLength;&#10;  USHORT        MajorVersion;&#10;  USHORT        MinorVersion;&#10;  FILE_ID_128   FileReferenceNumber;&#10;  FILE_ID_128   ParentFileReferenceNumber;&#10;  USN           Usn;&#10;  LARGE_INTEGER TimeStamp;&#10;  ULONG         Reason;&#10;  ULONG         SourceInfo;&#10;  ULONG         SecurityId;&#10;  ULONG         FileAttributes;&#10;  USHORT        FileNameLength;&#10;  USHORT        FileNameOffset;&#10;  WCHAR         FileName[1];&#10;} USN_RECORD_V3, *PUSN_RECORD_V3;">USN_RECORD_V3</a> structures respectively.</p>
<h2>Members</h2>
<h3><code>Header</code></h3>
<p>A <a href="usn_record_common_header" title="typedef struct {&#10;  ULONG  RecordLength;&#10;  USHORT MajorVersion;&#10;  USHORT MinorVersion;&#10;} USN_RECORD_COMMON_HEADER, *PUSN_RECORD_COMMON_HEADER;">USN_RECORD_COMMON_HEADER</a> structure that describes the record length, major version, and minor version for the record.</p>
<h3><code>FileReferenceNumber</code></h3>
<p>The 128-bit ordinal number of the file or directory for which this record notes changes.</p>
<p>This value is an arbitrarily assigned value that associates a journal record with a file.</p>
<h3><code>ParentFileReferenceNumber</code></h3>
<p>The 128-bit ordinal number of the directory where the file or directory that is associated with this record
is located.</p>
<p>This value is an arbitrarily assigned value that associates a journal record with a parent directory.</p>
<h3><code>Usn</code></h3>
<p>The USN of this record.</p>
<h3><code>Reason</code></h3>
<p>The flags that identify reasons for changes that have accumulated in this file or directory journal record
since the file or directory opened.</p>
<p>When a file or directory closes, then a final USN record is generated with the
<strong>USN_REASON_CLOSE</strong> flag set. The next change (for example, after the next open
operation or deletion) starts a new record with a new set of reason flags.</p>
<p>A rename or move operation generates two USN records, one that records the old parent directory for the item,
and one that records a new parent.</p>
<p>The following table identifies the possible flags.</p>
<p><strong>Note</strong> Unused bits are reserved.</p>
<table>
<thead>
<tr>
<th>Value</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>USN_REASON_BASIC_INFO_CHANGE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00008000</td>
<td>A user has either changed one or more file or directory attributes (for example, the read-only, hidden, system, archive, or sparse attribute), or one or more time stamps.</td>
</tr>
<tr>
<td><strong>USN_REASON_CLOSE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x80000000</td>
<td>The file or directory is closed.</td>
</tr>
<tr>
<td><strong>USN_REASON_COMPRESSION_CHANGE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00020000</td>
<td>The compression state of the file or directory is changed from or to compressed.</td>
</tr>
<tr>
<td><strong>USN_REASON_DATA_EXTEND</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00000002</td>
<td>The file or directory is extended (added to).</td>
</tr>
<tr>
<td><strong>USN_REASON_DATA_OVERWRITE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00000001</td>
<td>The data in the file or directory is overwritten.</td>
</tr>
<tr>
<td><strong>USN_REASON_DATA_TRUNCATION</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00000004</td>
<td>The file or directory is truncated.</td>
</tr>
<tr>
<td><strong>USN_REASON_EA_CHANGE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00000400</td>
<td>The user made a change to the extended attributes of a file or directory.<!-- raw HTML omitted --><!-- raw HTML omitted -->These NTFS file system attributes are not accessible to Windows-based applications.</td>
</tr>
<tr>
<td><strong>USN_REASON_ENCRYPTION_CHANGE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00040000</td>
<td>The file or directory is encrypted or decrypted.</td>
</tr>
<tr>
<td><strong>USN_REASON_FILE_CREATE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00000100</td>
<td>The file or directory is created for the first time.</td>
</tr>
<tr>
<td><strong>USN_REASON_FILE_DELETE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00000200</td>
<td>The file or directory is deleted.</td>
</tr>
<tr>
<td><strong>USN_REASON_HARD_LINK_CHANGE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00010000</td>
<td>An NTFS file system hard link is added to or removed from the file or directory.<!-- raw HTML omitted --><!-- raw HTML omitted -->An NTFS file system hard link, similar to a POSIX hard link, is one of several directory entries that see the same file or directory.</td>
</tr>
<tr>
<td><strong>USN_REASON_INDEXABLE_CHANGE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00004000</td>
<td>A user changes the <strong>FILE_ATTRIBUTE_NOT_CONTENT_INDEXED</strong> attribute.<!-- raw HTML omitted --><!-- raw HTML omitted -->That is, the user changes the file or directory from one where content can be indexed to one where content cannot be indexed, or vice versa. Content indexing permits rapid searching of data by building a database of selected content.</td>
</tr>
<tr>
<td><strong>USN_REASON_INTEGRITY_CHANGE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00800000</td>
<td>A user changed the state of the <strong>FILE_ATTRIBUTE_INTEGRITY_STREAM</strong> attribute for the given stream.<!-- raw HTML omitted --><!-- raw HTML omitted -->On the ReFS file system, integrity streams maintain a checksum of all data for that stream, so that the contents of the file can be validated during read or write operations.</td>
</tr>
<tr>
<td><strong>USN_REASON_NAMED_DATA_EXTEND</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00000020</td>
<td>The one or more named data streams for a file are extended (added to).</td>
</tr>
<tr>
<td><strong>USN_REASON_NAMED_DATA_OVERWRITE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00000010</td>
<td>The data in one or more named data streams for a file is overwritten.</td>
</tr>
<tr>
<td><strong>USN_REASON_NAMED_DATA_TRUNCATION</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00000040</td>
<td>The one or more named data streams for a file is truncated.</td>
</tr>
<tr>
<td><strong>USN_REASON_OBJECT_ID_CHANGE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00080000</td>
<td>The object identifier of a file or directory is changed.</td>
</tr>
<tr>
<td><strong>USN_REASON_RENAME_NEW_NAME</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00002000</td>
<td>A file or directory is renamed, and the file name in the <strong>USN_RECORD_V4</strong> structure is the new name.</td>
</tr>
<tr>
<td><strong>USN_REASON_RENAME_OLD_NAME</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00001000</td>
<td>The file or directory is renamed, and the file name in the <strong>USN_RECORD_V4</strong> structure is the previous name.</td>
</tr>
<tr>
<td><strong>USN_REASON_REPARSE_POINT_CHANGE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00100000</td>
<td>The reparse point that is contained in a file or directory is changed, or a reparse point is added to or deleted from a file or directory.</td>
</tr>
<tr>
<td><strong>USN_REASON_SECURITY_CHANGE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00000800</td>
<td>A change is made in the access rights to a file or directory.</td>
</tr>
<tr>
<td><strong>USN_REASON_STREAM_CHANGE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00200000</td>
<td>A named stream is added to or removed from a file, or a named stream is renamed.</td>
</tr>
<tr>
<td><strong>USN_REASON_TRANSACTED_CHANGE</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00400000</td>
<td>The given stream is modified through a committed TxF transaction.</td>
</tr>
</tbody>
</table>
<h3><code>SourceInfo</code></h3>
<p>Additional information about the source of the change, set by the
<a href="fsctl_mark_handle" title="// CTL_CODE(0x0009, 0x03f, METHOD_BUFFERED, FILE_ANY_ACCESS)&#10;#define FSCTL_MARK_HANDLE 0x000900FC">FSCTL_MARK_HANDLE</a> of the
<a href="https://learn.microsoft.com/windows/desktop/api/ioapiset/nf-ioapiset-deviceiocontrol">DeviceIoControl</a> operation.</p>
<p>When a thread writes a new USN record, the source information flags in the prior record continue to be
present only if the thread also sets those flags. Therefore, the source information structure allows
applications to filter out USN records that are set only by a known source, for example, an antivirus filter.</p>
<p>One of the following values can be set.</p>
<table>
<thead>
<tr>
<th>Value</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>USN_SOURCE_AUXILIARY_DATA</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00000002</td>
<td>The operation adds a private data stream to a file or directory.<!-- raw HTML omitted --><!-- raw HTML omitted -->One example is a virus detector adding checksum information. As the virus detector modifies the item, the system generates USN records. <strong>USN_SOURCE_AUXILIARY_DATA</strong> indicates that the modifications did not change the application data.</td>
</tr>
<tr>
<td><strong>USN_SOURCE_DATA_MANAGEMENT</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00000001</td>
<td>The operation provides information about a change to the file or directory made by the operating system.<!-- raw HTML omitted --><!-- raw HTML omitted -->A typical use is when the Remote Storage system moves data from external to local storage. Remote Storage is the hierarchical storage management software. Such a move usually at a minimum adds the <strong>USN_REASON_DATA_OVERWRITE</strong> flag to a USN record. However, the data has not changed from the user's point of view. By noting <strong>USN_SOURCE_DATA_MANAGEMENT</strong> in the <strong>SourceInfo</strong> member, you can determine that although a write operation is performed on the item, data has not changed.</td>
</tr>
<tr>
<td><strong>USN_SOURCE_REPLICATION_MANAGEMENT</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00000004</td>
<td>The operation is modifying a file to match the contents of the same file which exists in another member of the replica set.</td>
</tr>
<tr>
<td><strong>USN_SOURCE_CLIENT_REPLICATION_MANAGEMENT</strong><!-- raw HTML omitted --><!-- raw HTML omitted -->0x00000008</td>
<td>The operation is modifying a file on client systems to match the contents of the same file that exists in the cloud.</td>
</tr>
</tbody>
</table>
<h3><code>RemainingExtents</code></h3>
<p>The number of extents that remain after the current <strong>USN_RECORD_V4</strong> record. Multiple version 4.0 records may be required to describe all of the modified extents for a given file. When the <strong>RemainingExtents</strong> member is 0, the current <strong>USN_RECORD_V4</strong> record is the last <strong>USN_RECORD_V4</strong> record for the file. The last <strong>USN_RECORD_V4</strong> entry for a given file is always followed by a <a href="usn_record_v3" title="typedef struct {&#10;  ULONG         RecordLength;&#10;  USHORT        MajorVersion;&#10;  USHORT        MinorVersion;&#10;  FILE_ID_128   FileReferenceNumber;&#10;  FILE_ID_128   ParentFileReferenceNumber;&#10;  USN           Usn;&#10;  LARGE_INTEGER TimeStamp;&#10;  ULONG         Reason;&#10;  ULONG         SourceInfo;&#10;  ULONG         SecurityId;&#10;  ULONG         FileAttributes;&#10;  USHORT        FileNameLength;&#10;  USHORT        FileNameOffset;&#10;  WCHAR         FileName[1];&#10;} USN_RECORD_V3, *PUSN_RECORD_V3;">USN_RECORD_V3</a> record with at least the <strong>USN_REASON_CLOSE</strong> flag set.</p>
<h3><code>NumberOfExtents</code></h3>
<p>The number of extents in current <strong>USN_RECORD_V4</strong> entry.</p>
<h3><code>ExtentSize</code></h3>
<p>The size of each <a href="usn_record_extent" title="typedef struct {&#10;  LONGLONG Offset;&#10;  LONGLONG Length;&#10;} USN_RECORD_EXTENT, *PUSN_RECORD_EXTENT;">USN_RECORD_EXTENT</a> structure in the <strong>Extents</strong> member, in bytes.</p>
<h3><code>Extents</code></h3>
<p>An array of <a href="usn_record_extent" title="typedef struct {&#10;  LONGLONG Offset;&#10;  LONGLONG Length;&#10;} USN_RECORD_EXTENT, *PUSN_RECORD_EXTENT;">USN_RECORD_EXTENT</a> structures that represent the extents in the <strong>USN_RECORD_V4</strong> entry.</p>
<h2>Remarks</h2>
<p>A <strong>USN_RECORD_V4</strong> record is only output when range tracking is turned on and the file size is equal or larger than the value of the <strong>RangeTrackFileSizeThreshold</strong> member. The user always receives one or more <strong>USN_RECORD_V4</strong> records followed by one <a href="usn_record_v3" title="typedef struct {&#10;  ULONG         RecordLength;&#10;  USHORT        MajorVersion;&#10;  USHORT        MinorVersion;&#10;  FILE_ID_128   FileReferenceNumber;&#10;  FILE_ID_128   ParentFileReferenceNumber;&#10;  USN           Usn;&#10;  LARGE_INTEGER TimeStamp;&#10;  ULONG         Reason;&#10;  ULONG         SourceInfo;&#10;  ULONG         SecurityId;&#10;  ULONG         FileAttributes;&#10;  USHORT        FileNameLength;&#10;  USHORT        FileNameOffset;&#10;  WCHAR         FileName[1];&#10;} USN_RECORD_V3, *PUSN_RECORD_V3;">USN_RECORD_V3</a> record.</p>
<p>To provide a path forward compatibility in change journal clients, Microsoft provides a major and minor version number of the change journal software in the <strong>USN_RECORD_V4</strong> structure. Your code should examine these values, examine its own compatibility with the change journal software, and gracefully handle any incompatibility if necessary.</p>
<p>A change in the minor version number indicates that the existing <strong>USN_RECORD_V4</strong> structure members are still valid, but that new members may have been added between the penultimate member and the last, which is a variable-length string.</p>
<p>To handle such a change gracefully, your code should not do any compile-time pointer arithmetic that relies on the location of the last member. For example, a change in the minor version number makes the <code>sizeof(USN_RECORD)</code> call unreliable. Instead, rely on run-time calculations that use the <strong>RecordLength</strong> member.</p>
<p>An increase in the major version number of the change journal software indicates that the <strong>USN_RECORD_V4</strong> structure may have undergone major changes, and that the current definition may not be reliable. If your code detects a change in the major version number of the change journal software, the code should not work with the change journal.</p>
<p>For more information, see <a href="https://learn.microsoft.com/windows/desktop/FileIO/creating-modifying-and-deleting-a-change-journal">Creating, Modifying, and Deleting a Change Journal</a>.</p>
<h2>See also</h2>
<p><a href="fsctl_mark_handle" title="// CTL_CODE(0x0009, 0x03f, METHOD_BUFFERED, FILE_ANY_ACCESS)&#10;#define FSCTL_MARK_HANDLE 0x000900FC">FSCTL_MARK_HANDLE</a></p>
<p><a href="fsctl_read_usn_journal" title="// CTL_CODE(0x0009, 0x02e, METHOD_NEITHER, FILE_ANY_ACCESS)&#10;#define FSCTL_READ_USN_JOURNAL 0x000900BB">FSCTL_READ_USN_JOURNAL</a></p>
<p><a href="fsctl_usn_track_modified_ranges" title="// CTL_CODE(0x0009, 0x0bd, METHOD_BUFFERED, FILE_ANY_ACCESS)&#10;#define FSCTL_USN_TRACK_MODIFIED_RANGES 0x000902F4">FSCTL_USN_TRACK_MODIFIED_RANGES</a></p>
<p><a href="https://learn.microsoft.com/windows/desktop/api/fileapi/nf-fileapi-getfileattributesa">GetFileAttributes</a></p>
<p><a href="https://learn.microsoft.com/windows/desktop/api/fileapi/nf-fileapi-getvolumeinformationa">GetVolumeInformation</a></p>
<p><a href="https://learn.microsoft.com/windows/desktop/api/winioctl/ns-winioctl-read_usn_journal_data_v0">READ_USN_JOURNAL_DATA</a></p>
<p><a href="usn_record_common_header" title="typedef struct {&#10;  ULONG  RecordLength;&#10;  USHORT MajorVersion;&#10;  USHORT MinorVersion;&#10;} USN_RECORD_COMMON_HEADER, *PUSN_RECORD_COMMON_HEADER;">USN_RECORD_COMMON_HEADER</a></p>
<p><a href="usn_record_extent" title="typedef struct {&#10;  LONGLONG Offset;&#10;  LONGLONG Length;&#10;} USN_RECORD_EXTENT, *PUSN_RECORD_EXTENT;">USN_RECORD_EXTENT</a></p>
<p><a href="usn_record_v2" title="typedef struct {&#10;  ULONG         RecordLength;&#10;  USHORT        MajorVersion;&#10;  USHORT        MinorVersion;&#10;  ULONGLONG     FileReferenceNumber;&#10;  ULONGLONG     ParentFileReferenceNumber;&#10;  USN           Usn;&#10;  LARGE_INTEGER TimeStamp;&#10;  ULONG         Reason;&#10;  ULONG         SourceInfo;&#10;  ULONG         SecurityId;&#10;  ULONG         FileAttributes;&#10;  USHORT        FileNameLength;&#10;  USHORT        FileNameOffset;&#10;  WCHAR         FileName[1];&#10;} USN_RECORD_V2, *PUSN_RECORD_V2;">USN_RECORD_V2</a></p>
<p><a href="usn_record_v3" title="typedef struct {&#10;  ULONG         RecordLength;&#10;  USHORT        MajorVersion;&#10;  USHORT        MinorVersion;&#10;  FILE_ID_128   FileReferenceNumber;&#10;  FILE_ID_128   ParentFileReferenceNumber;&#10;  USN           Usn;&#10;  LARGE_INTEGER TimeStamp;&#10;  ULONG         Reason;&#10;  ULONG         SourceInfo;&#10;  ULONG         SecurityId;&#10;  ULONG         FileAttributes;&#10;  USHORT        FileNameLength;&#10;  USHORT        FileNameOffset;&#10;  WCHAR         FileName[1];&#10;} USN_RECORD_V3, *PUSN_RECORD_V3;">USN_RECORD_V3</a></p>
<p><a href="https://learn.microsoft.com/windows/desktop/FileIO/volume-management-structures">Volume Management Structures</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows/win32/api/winioctl/ns-winioctl-usn_record_v4">View the official Win32 API reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/sdk-api/blob/docs/sdk-api-src/content/winioctl/ns-winioctl-usn_record_v4.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
