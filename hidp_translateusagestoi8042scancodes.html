<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="HidP_TranslateUsagesToI8042ScanCodes - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>HidP_TranslateUsagesToI8042ScanCodes - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            HidP_TranslateUsagesToI8042ScanCodes - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// hidpi.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> HidP_TranslateUsagesToI8042ScanCodes(
  [in]           PUSAGE                        ChangedUsageList,
  [in]           <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                         UsageListLength,
  [in]           HIDP_KEYBOARD_DIRECTION       KeyAction,
  [in, out]      PHIDP_KEYBOARD_MODIFIER_STATE ModifierState,
  [in]           PHIDP_INSERT_SCANCODES        InsertCodesProcedure,
  [in, optional] PVOID                         InsertCodesContext
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/hidpi/nf-hidpi-hidp_translateusagestoi8042scancodes">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/hidp_translateusagestoi8042scancodes.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-hidpi-hidp_translateusagestoi8042scancodes)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="hidp_translateusagestoi8042scancodes-function">HidP_TranslateUsagesToI8042ScanCodes function</h1>

<h2 id="description">Description</h2>

<p>The <strong>HidP_TranslateUsagesToI8042ScanCodes</strong> routine maps a list of <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/hid/hid-usages">HID usages</a> on the HID_USAGE_PAGE_KEYBOARD usage page to their respective PS/2 scan codes (<a href="scan" title="WIAMICRO_API HRESULT Scan(&#10;  [in, out] PSCANINFO pScanInfo,&#10;            LONG      lPhase,&#10;  [out]     PBYTE     pBuffer,&#10;            LONG      lLength,&#10;  [out]     LONG      *plReceived&#10;);">Scan</a> Code Set 1).</p>

<h2 id="parameters">Parameters</h2>

<h3 id="changedusagelist-in"><code>ChangedUsageList</code> [in]</h3>

<p>Pointer to a list of keyboard (button) usages. The translate usages routine interprets a zero as a delimiter that ends the usage list.</p>

<h3 id="usagelistlength-in"><code>UsageListLength</code> [in]</h3>

<p>Specifies the maximum possible number of usages in the changed usage list.</p>

<h3 id="keyaction-in"><code>KeyAction</code> [in]</h3>

<p>Identifies the key direction for the specified change usage list.</p>

<p><!-- CODE_MARKER --></p>

<pre><code>typedef enum _HIDP_KEYBOARD_DIRECTION {
    HidP_Keyboard_Break,
    HidP_Keyboard_Make
} HIDP_KEYBOARD_DIRECTION;
</code></pre>

<h4 id="hidp_keyboard_break">HidP_Keyboard_Break</h4>

<p>Specifies a <em>break</em> direction (key up). The changed usage list contains the usages set to OFF that were previously set to ON (which corresponds to the keys that were previously down, but are now up).</p>

<h4 id="hidpkeyboard_make">HidPKeyboard_Make</h4>

<p>Specifies a <em>make</em> direction (key down). The changed usage list contains the usages set to ON that were previously set to OFF (which corresponds to the keys that were previously up, but now are down).</p>

<h3 id="modifierstate-in-out"><code>ModifierState</code> [in, out]</h3>

<p>Pointer to a _HIDP_KEYBOARD_MODIFIER_STATE structure that the caller maintains for use by the translate usages routine. The modifier state structure identifies the state of the keyboard modifier keys.</p>

<p><!-- CODE_MARKER --></p>

<pre><code>typedef struct _HIDP_KEYBOARD_MODIFIER_STATE {
    union {
      struct {
        <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> LeftControl: 1;
        <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> LeftShift: 1;
        <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> LeftAlt: 1;
        <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> LeftGUI: 1;
        <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RightControl: 1;
        <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RightShift: 1;
        <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RightAlt: 1;
        <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RigthGUI: 1;
        <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> CapsLock: 1;
        <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> ScollLock: 1;
        <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> NumLock: 1;
        <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> Reserved: 21;
      };
      <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> ul;
};
</code></pre>

<p>Each member of the modifier state structure identifies whether the corresponding usage is set to ON (1) or OFF (zero).</p>

<p>See the Remarks section for more information about how a modifier state structure is used with the translate usage routine.</p>

<h3 id="insertcodesprocedure-in"><code>InsertCodesProcedure</code> [in]</h3>

<p>Pointer to a caller-supplied PHIDP_INSERT_SCANCODES-typed callback routine that the translate usage routine uses to return the mapped scan codes to the caller of the translate usage routine.</p>

<p><!-- CODE_MARKER --></p>

<pre><code>typedef BOOLEAN (*PHIDP_INSERT_SCANCODES)(
    IN PVOID  Context,
    IN PCHAR  NewScanCodes,
    IN <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>  Length
    );
</code></pre>

<h4 id="context">Context</h4>

<p>Pointer to the context of the caller of the translate usage routine. The translate usage routine passes the <em>InsertCodesContext</em> pointer to the <em>InsertCodesProcedure</em> routine.</p>

<h4 id="newscancodes">NewScanCodes</h4>

<p>Pointer to the first byte of a scan code that the translate usage routine returns to the caller of the translate usage routine.</p>

<h4 id="length">Length</h4>

<p>Specifies the length, in bytes, of the scan code. A scan code cannot exceed four bytes.</p>

<h3 id="insertcodescontext-in-optional"><code>InsertCodesContext</code> [in, optional]</h3>

<p>Pointer to a caller-defined context that the translate usage routine passes to the <em>InsertCodesProcedure</em> routine.</p>

<h2 id="return-value">Return value</h2>

<p><strong>HidP_TranslateUsagesToI8042ScanCodes</strong> returns one of the following status values:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>HIDP_STATUS_SUCCESS</strong></td>
  <td>The translate usage routine successfully mapped all the valid usages in the changed usage list.</td>
</tr>
<tr>
  <td><strong>HIDP_STATUS_I8042_TRANS_UNKNOWN</strong></td>
  <td>A usage in the changed usage list mapped to an invalid keyboard scan code.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p><strong>HidP_TranslateUsagesToI8042ScanCodes</strong> sequentially maps the keyboard button usages in the changed usage list in the order in which they occur in the list, beginning with the value at <em>ChangedUsageList.</em> After the translate usage routine successfully maps a usage, it uses the caller's <em>InsertCodesProcedure</em> routine to return the corresponding scan code to the caller. The translate usage routine continues to map the usages in the list until one of the following occurs: a usage value in the list is zero; it maps the number of usages that is specified by <em>UsageListLength</em>; a usage maps to an invalid keyboard scan code.</p>

<p><strong>HidP_TranslateUsagesToI8042ScanCodes</strong> is designed primarily to be used in a processing loop that repeatedly determines the current usage list (usages that are currently set to ON), compares them with a previous usage list (usages that were previously set to ON), and maps the difference between the current and previous usage lists to make scan codes and break scan codes. The following operations illustrate how to use the translate usages routine.</p>

<p>Prior to beginning a processing loop, the processing code typically allocates and initializes the following data:</p>

<ul>
<li><p>A previous usage list, current usage list, break usage list, and a make usage list.</p>

<p>Each list is a zero-initialized array of usages. To ensure that the processing code maps all the usages that can change between consecutive HID input reports, the processing code must set the number of elements in each list to the maximum number of usages that <a href="hidp_getusages" title="NTSTATUS HidP_GetUsages(&#10;  [in]      HIDP_REPORT_TYPE     ReportType,&#10;  [in]      USAGE                UsagePage,&#10;  [in]      USHORT               LinkCollection,&#10;  [out]     PUSAGE               UsageList,&#10;  [in, out] PULONG               UsageLength,&#10;  [in]      PHIDP_PREPARSED_DATA PreparsedData,&#10;  [out]     PCHAR                Report,&#10;  [in]      ULONG                ReportLength&#10;);">HidP_GetUsages</a> can return for the HID_USAGE_PAGE_KEYBOARD usage page. This number is obtained using <a href="hidp_maxusagelistlength" title="ULONG HidP_MaxUsageListLength(&#10;  [in] HIDP_REPORT_TYPE     ReportType,&#10;  [in] USAGE                UsagePage,&#10;  [in] PHIDP_PREPARSED_DATA PreparsedData&#10;);">HidP_MaxUsageListLength</a>.</p></li>
<li><p>A zero-initialized _HIDP_KEYBOARD_MODIFIER_STATE structure for use by the translate usages routine.</p>

<p>In the processing loop, the code must maintain this structure for use by the translate usages routine. The processing code can read the state of the modifier keys, but the code must not modify the structure. The translate usage routine uses this structure to maintain internal information about the state of the modifier keys.</p></li>
</ul>

<p>After initializing the required structures, each iteration of the processing loop typically includes the following sequence of operations:</p>

<ol>
<li>Call <strong><a href="hidp_getusages" title="NTSTATUS HidP_GetUsages(&#10;  [in]      HIDP_REPORT_TYPE     ReportType,&#10;  [in]      USAGE                UsagePage,&#10;  [in]      USHORT               LinkCollection,&#10;  [out]     PUSAGE               UsageList,&#10;  [in, out] PULONG               UsageLength,&#10;  [in]      PHIDP_PREPARSED_DATA PreparsedData,&#10;  [out]     PCHAR                Report,&#10;  [in]      ULONG                ReportLength&#10;);">HidP_GetUsages</a></strong> to obtain the current usage list of usages that are set to ON. Set the <em>UsagePage</em> input parameter of the get usages routine to HID_USAGE_PAGE_KEYBOARD.</li>
<li>Call <strong><a href="hidp_usagelistdifference" title="NTSTATUS HidP_UsageListDifference(&#10;  [in]  PUSAGE PreviousUsageList,&#10;  [in]  PUSAGE CurrentUsageList,&#10;  [out] PUSAGE BreakUsageList,&#10;  [out] PUSAGE MakeUsageList,&#10;  [in]  ULONG  UsageListLength&#10;);">HidP_UsageListDifference</a></strong> to compare the current usage list of usages to a previous usage list. The usage list difference routine returns a break usage list and a make usage list.</li>
<li>Call the translate usage routine, setting <em>ChangedUsageList</em> to the break usage list, <em>KeyAction</em> to HidP_KeyboardBreak, and <em>ModifierState</em> to the structure that the processing code maintains for the translate usages routine. The translate usages routine uses the <em>InsertCodesProcedure</em>s callback routine to return the break scan codes to the processing loop.</li>
<li>Call the translate usage routine, setting <em>ChangedUsageList</em> to the make usage list, <em>KeyAction</em> to HidP_KeyboardMake, and <em>ModifierState</em> to the structure that the processing code maintains for the translate usages routine. The translate usages routine uses the <em>InsertCodesProcedure</em>s callback routine to return the make scan codes to the processing loop.</li>
<li>Update the previous usage list to the current usage list.</li>
</ol>

<p>For information about the mapping between HID usages and PS/2 keyboard scan codes, see the <a rel="noopener" target="_blank" href="https://go.microsoft.com/fwlink/p/?linkid=242210">key support and scan codes</a> website.</p>

<h2 id="see-also">See also</h2>

<p><a href="hidp_getusages" title="NTSTATUS HidP_GetUsages(&#10;  [in]      HIDP_REPORT_TYPE     ReportType,&#10;  [in]      USAGE                UsagePage,&#10;  [in]      USHORT               LinkCollection,&#10;  [out]     PUSAGE               UsageList,&#10;  [in, out] PULONG               UsageLength,&#10;  [in]      PHIDP_PREPARSED_DATA PreparsedData,&#10;  [out]     PCHAR                Report,&#10;  [in]      ULONG                ReportLength&#10;);">HidP_GetUsages</a></p>

<p><a href="hidp_maxusagelistlength" title="ULONG HidP_MaxUsageListLength(&#10;  [in] HIDP_REPORT_TYPE     ReportType,&#10;  [in] USAGE                UsagePage,&#10;  [in] PHIDP_PREPARSED_DATA PreparsedData&#10;);">HidP_MaxUsageListLength</a></p>

<p><a href="hidp_usagelistdifference" title="NTSTATUS HidP_UsageListDifference(&#10;  [in]  PUSAGE PreviousUsageList,&#10;  [in]  PUSAGE CurrentUsageList,&#10;  [out] PUSAGE BreakUsageList,&#10;  [out] PUSAGE MakeUsageList,&#10;  [in]  ULONG  UsageListLength&#10;);">HidP_UsageListDifference</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/hidpi/nf-hidpi-hidp_translateusagestoi8042scancodes">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/hidpi/nf-hidpi-hidp_translateusagestoi8042scancodes.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
