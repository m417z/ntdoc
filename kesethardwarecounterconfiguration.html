<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="KeSetHardwareCounterConfiguration - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>KeSetHardwareCounterConfiguration - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            KeSetHardwareCounterConfiguration - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntddk.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> KeSetHardwareCounterConfiguration(
  [in] <a href="hardware_counter" title="typedef struct _HARDWARE_COUNTER {&#10;  HARDWARE_COUNTER_TYPE Type;&#10;  ULONG                 Reserved;&#10;  ULONG64               Index;&#10;} HARDWARE_COUNTER, *PHARDWARE_COUNTER;">PHARDWARE_COUNTER</a> CounterArray,
  [in] <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>             Count
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntddk/nf-ntddk-kesethardwarecounterconfiguration">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/kesethardwarecounterconfiguration.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ntddk-kesethardwarecounterconfiguration)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2 id="description">Description</h2>

<p>The <strong>KeSetHardwareCounterConfiguration</strong> routine specifies a list of hardware counters to use for thread profiling.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="counterarray-in"><code>CounterArray</code> [in]</h3>

<p>A pointer to a <strong><a href="hardware_counter" title="typedef struct _HARDWARE_COUNTER {&#10;  HARDWARE_COUNTER_TYPE Type;&#10;  ULONG                 Reserved;&#10;  ULONG64               Index;&#10;} HARDWARE_COUNTER, *PHARDWARE_COUNTER;">HARDWARE_COUNTER</a></strong> array that describes the hardware counter configuration to use for thread profiling. Each array element is a structure that describes a hardware counter. Before the routine returns, it copies the contents of this array into its internal data structures.</p>

<h3 id="count-in"><code>Count</code> [in]</h3>

<p>Specifies the number of elements in the array that is pointed to by the <em>CounterArray</em> parameter.</p>

<h2 id="return-value">Return value</h2>

<p><strong>KeSetHardwareCounterConfiguration</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the call is successful. Possible error return values include the following:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>STATUS_INVALID_PARAMETER</strong></td>
  <td>The value of the <em>Count</em> parameter exceeds the maximum number of counters that is specified by the MAX_HW_COUNTERS constant, which is defined in the Ntddk.h header file.</td>
</tr>
<tr>
  <td><strong>STATUS_WMI_ALREADY_ENABLED</strong></td>
  <td>One or more of the counters that are specified in the <em>CounterArray</em> array are already enabled.</td>
</tr>
<tr>
  <td><strong>STATUS_NOT_IMPLEMENTED</strong></td>
  <td>This routine is not implemented for the processor architecture that the caller is running on.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>In Windows 7, this routine is implemented only for the x86-based, x64-based, and Itanium-based architectures. If a caller is running on a processor architecture that is not supported, the routine returns STATUS_NOT_IMPLEMENTED.</p>

<p>This routine tells the operating system which hardware counters to use for thread profiling. Call this routine only when thread profiling is disabled. If the <em>CounterArray</em> array specifies any hardware counters that are currently being used, the routine fails and returns STATUS_WMI_ALREADY_ENABLED.</p>

<p>An application thread can enable thread profiling to obtain a set of performance measurements from the hardware counters in the performance monitoring unit (PMU) of the local processor. The operating system supports only one profiling application at a time. Concurrent instances of a thread-profiling application are not supported. A thread can enable thread profiling for itself but not for other threads.</p>

<p>When thread profiling is enabled, the operating system uses the hardware counters that were specified in the last call to <strong>KeSetHardwareCounterConfiguration</strong>. Each successful <strong>KeSetHardwareCounterConfiguration</strong> call replaces any hardware counter configuration that might have been set in a previous <strong>KeSetHardwareCounterConfiguration</strong> call.</p>

<p>Set <em>Count</em> = 0 to specify an empty hardware counter configuration. This configuration effectively prevents the use of hardware counters for thread profiling. The default hardware counter configuration that exists after system startup and before the initial <strong>KeSetHardwareCounterConfiguration</strong> call is an empty configuration.</p>

<p>The effect of a successful <strong>KeSetHardwareCounterConfiguration</strong> call is global. If a thread in any process is profiled, the profiler uses the hardware counter configuration that was set by the last call to <strong>KeSetHardwareCounterConfiguration</strong>. In a multiprocessor system, a <strong>KeSetHardwareCounterConfiguration</strong> call sets the hardware counter configuration to use for thread profiling across all processors in the system, although each processor uses its own set of hardware counters.</p>

<p>To avoid resource conflicts, all drivers that use counter resources should use the <a href="halallocatehardwarecounters" title="NTHALAPI NTSTATUS HalAllocateHardwareCounters(&#10;        PGROUP_AFFINITY                 GroupAffinty,&#10;  [in]  ULONG                           GroupCount,&#10;  [in]  PPHYSICAL_COUNTER_RESOURCE_LIST ResourceList,&#10;  [out] PHANDLE                         CounterSetHandle&#10;);">HalAllocateHardwareCounters</a> and <a href="halfreehardwarecounters" title="NTSTATUS HalFreeHardwareCounters(&#10;  _In_ HANDLE CounterSetHandle&#10;);">HalFreeHardwareCounters</a> routines to coordinate their sharing of these resources.</p>

<p>To determine if thread profiling is enabled for a given thread, call the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/winbase/nf-winbase-querythreadprofiling"><strong>QueryThreadProfiling</strong></a> function.</p>

<p>To query the operating system for the hardware counter configuration that is currently in effect for thread profiling, call the <a href="kequeryhardwarecounterconfiguration" title="NTSTATUS KeQueryHardwareCounterConfiguration(&#10;  [out] PHARDWARE_COUNTER CounterArray,&#10;  [in]  ULONG             MaximumCount,&#10;  [out] PULONG            Count&#10;);">KeQueryHardwareCounterConfiguration</a> routine.</p>

<p>Virtualization software typically does not virtualize hardware performance counters. Thus, hardware performance counters are unlikely to be available in a virtual machine.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/windows/desktop/hcp/hcp-reference">Hardware Counter Profiling Reference</a></p>

<p><strong><a href="hardware_counter" title="typedef struct _HARDWARE_COUNTER {&#10;  HARDWARE_COUNTER_TYPE Type;&#10;  ULONG                 Reserved;&#10;  ULONG64               Index;&#10;} HARDWARE_COUNTER, *PHARDWARE_COUNTER;">HARDWARE_COUNTER</a></strong></p>

<p><a href="halallocatehardwarecounters" title="NTHALAPI NTSTATUS HalAllocateHardwareCounters(&#10;        PGROUP_AFFINITY                 GroupAffinty,&#10;  [in]  ULONG                           GroupCount,&#10;  [in]  PPHYSICAL_COUNTER_RESOURCE_LIST ResourceList,&#10;  [out] PHANDLE                         CounterSetHandle&#10;);">HalAllocateHardwareCounters</a></p>

<p><a href="halfreehardwarecounters" title="NTSTATUS HalFreeHardwareCounters(&#10;  _In_ HANDLE CounterSetHandle&#10;);">HalFreeHardwareCounters</a></p>

<p><a href="kequeryhardwarecounterconfiguration" title="NTSTATUS KeQueryHardwareCounterConfiguration(&#10;  [out] PHARDWARE_COUNTER CounterArray,&#10;  [in]  ULONG             MaximumCount,&#10;  [out] PULONG            Count&#10;);">KeQueryHardwareCounterConfiguration</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntddk/nf-ntddk-kesethardwarecounterconfiguration">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntddk/nf-ntddk-kesethardwarecounterconfiguration.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
