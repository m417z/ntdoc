<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="AuxKlibQueryModuleInformation - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>AuxKlibQueryModuleInformation - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            AuxKlibQueryModuleInformation - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// aux_klib.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> AuxKlibQueryModuleInformation(
  [in, out]       PULONG BufferSize,
  [in]            <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>  ElementSize,
  [out, optional] PVOID  QueryInfo
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/aux_klib/nf-aux_klib-auxklibquerymoduleinformation">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/auxklibquerymoduleinformation.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-aux_klib-auxklibquerymoduleinformation)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1>AuxKlibQueryModuleInformation function</h1>
<h2>Description</h2>
<p>The <strong>AuxKlibQueryModuleInformation</strong> routine retrieves information about the image modules that the operating system has loaded.</p>
<h2>Parameters</h2>
<h3><code>BufferSize</code> [in, out]</h3>
<p>A pointer to a location that contains or receives a buffer size, in bytes. If <em>QueryInfo</em> is <strong>NULL</strong>, the location receives the number of bytes that the driver must allocate for the array that receives the retrieved information. If <em>QueryInfo</em> is not <strong>NULL</strong>, the location must contain the specified number of bytes.</p>
<h3><code>ElementSize</code> [in]</h3>
<p>The size, in bytes, of each element of the array that <em>QueryInfo</em> points to. This value must be <strong>sizeof</strong>(<strong><a href="aux_module_basic_info" title="typedef struct _AUX_MODULE_BASIC_INFO {&#10;  PVOID ImageBase;&#10;} AUX_MODULE_BASIC_INFO, *PAUX_MODULE_BASIC_INFO;">AUX_MODULE_BASIC_INFO</a></strong>) or <strong>sizeof</strong>(<strong><a href="aux_module_extended_info" title="typedef struct _AUX_MODULE_EXTENDED_INFO {&#10;  AUX_MODULE_BASIC_INFO BasicInfo;&#10;  ULONG                 ImageSize;&#10;  USHORT                FileNameOffset;&#10;  UCHAR                 FullPathName[AUX_KLIB_MODULE_PATH_LEN];&#10;} AUX_MODULE_EXTENDED_INFO, *PAUX_MODULE_EXTENDED_INFO;">AUX_MODULE_EXTENDED_INFO</a></strong>).</p>
<h3><code>QueryInfo</code> [out, optional]</h3>
<p>A pointer to an array of <a href="aux_module_basic_info" title="typedef struct _AUX_MODULE_BASIC_INFO {&#10;  PVOID ImageBase;&#10;} AUX_MODULE_BASIC_INFO, *PAUX_MODULE_BASIC_INFO;">AUX_MODULE_BASIC_INFO</a> or <a href="aux_module_extended_info" title="typedef struct _AUX_MODULE_EXTENDED_INFO {&#10;  AUX_MODULE_BASIC_INFO BasicInfo;&#10;  ULONG                 ImageSize;&#10;  USHORT                FileNameOffset;&#10;  UCHAR                 FullPathName[AUX_KLIB_MODULE_PATH_LEN];&#10;} AUX_MODULE_EXTENDED_INFO, *PAUX_MODULE_EXTENDED_INFO;">AUX_MODULE_EXTENDED_INFO</a> structures that receives information about loaded image modules. If this pointer is <strong>NULL</strong>, <strong>AuxKlibQueryModuleInformation</strong> writes the required buffer size to the location that <em>BufferSize</em> points to.</p>
<h2>Return value</h2>
<p><strong>AuxKlibQueryModuleInformation</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the operation succeeds. <strong>AuxKlibQueryModuleInformation</strong> returns STATUS_BUFFER_TOO_SMALL if the <em>QueryInfo</em> pointer is not <strong>NULL</strong> and the driver-supplied <em>BufferSize</em> value is too small.</p>
<p>The routine might return other <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/ntstatus-values">NTSTATUS values</a>.</p>
<h2>Remarks</h2>
<p>To obtain information about the operating system's loaded image modules, a driver must:</p>
<ol>
<li>Call <strong>AuxKlibQueryModuleInformation</strong> with a <strong>NULL</strong> <em>QueryInfo</em> pointer. After <strong>AuxKlibQueryModuleInformation</strong> returns, the location that the <em>BufferSize</em> parameter points to will contain the number of bytes that the driver will have to allocate for the array.</li>
<li>Call a memory allocation routine, such as <a href="exallocatepoolwithtag" title="PVOID ExAllocatePoolWithTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithTag</a>, to allocate a buffer for the array.</li>
<li>Call <strong>AuxKlibQueryModuleInformation</strong> again. This time, the <em>QueryInfo</em> pointer must contain the address of the allocated buffer. After <strong>AuxKlibQueryModuleInformation</strong> returns, the buffer contains an array of module information.</li>
</ol>
<p>The number of loaded modules can change between the first and second calls to <strong>AuxKlibQueryModuleInformation</strong>. As a result, the second call to <strong>AuxKlibQueryModuleInformation</strong> might return STATUS_BUFFER_TOO_SMALL even if the driver allocates a buffer that is based on the size that was obtained from the first call.</p>
<p>If a call to <strong>AuxKlibQueryModuleInformation</strong> succeeds, the routine writes an <strong>ImageBase</strong> value to each element in the <em>QueryInfo</em> array. Each <strong>ImageBase</strong> value is a pointer to the base of a loaded driver image. This pointer remains valid only while the driver remains loaded. The caller should assume that the driver can be unloaded at any time unless the caller can guarantee otherwise. For example, a driver might be unloaded between a call to <strong>AuxKlibQueryModuleInformation</strong> that obtains a pointer to the driver image and a call to <a href="auxklibgetimageexportdirectory" title="PIMAGE_EXPORT_DIRECTORY AuxKlibGetImageExportDirectory(&#10;  [in] PVOID ImageBase&#10;);">AuxKlibGetImageExportDirectory</a> that uses this pointer.</p>
<p>Drivers must call <a href="auxklibinitialize" title="NTSTATUS AuxKlibInitialize();">AuxKlibInitialize</a> before calling <strong>AuxKlibQueryModuleInformation</strong>.</p>
<h4>Examples</h4>
<p>The following code example illustrates the steps that are listed in the preceding Remarks section.</p>
<pre><code><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a>  status;
<a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>  modulesSize;
<a href="aux_module_extended_info" title="typedef struct _AUX_MODULE_EXTENDED_INFO {&#10;  AUX_MODULE_BASIC_INFO BasicInfo;&#10;  ULONG                 ImageSize;&#10;  USHORT                FileNameOffset;&#10;  UCHAR                 FullPathName[AUX_KLIB_MODULE_PATH_LEN];&#10;} AUX_MODULE_EXTENDED_INFO, *PAUX_MODULE_EXTENDED_INFO;">AUX_MODULE_EXTENDED_INFO</a>*  modules;
<a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>  numberOfModules;
//
// Get the required array size.
//
status = AuxKlibQueryModuleInformation(
                                       &amp;modulesSize,
                                       sizeof(<a href="aux_module_extended_info" title="typedef struct _AUX_MODULE_EXTENDED_INFO {&#10;  AUX_MODULE_BASIC_INFO BasicInfo;&#10;  ULONG                 ImageSize;&#10;  USHORT                FileNameOffset;&#10;  UCHAR                 FullPathName[AUX_KLIB_MODULE_PATH_LEN];&#10;} AUX_MODULE_EXTENDED_INFO, *PAUX_MODULE_EXTENDED_INFO;">AUX_MODULE_EXTENDED_INFO</a>),
                                       NULL
                                       );

if (!<a href="nt_success" title="#define NT_SUCCESS(Status) (((NTSTATUS)(Status)) &gt;= 0)">NT_SUCCESS</a>(status) || modulesSize == 0) {
    break;
    }

//
// Calculate the number of modules.
//
numberOfModules = modulesSize / sizeof(<a href="aux_module_extended_info" title="typedef struct _AUX_MODULE_EXTENDED_INFO {&#10;  AUX_MODULE_BASIC_INFO BasicInfo;&#10;  ULONG                 ImageSize;&#10;  USHORT                FileNameOffset;&#10;  UCHAR                 FullPathName[AUX_KLIB_MODULE_PATH_LEN];&#10;} AUX_MODULE_EXTENDED_INFO, *PAUX_MODULE_EXTENDED_INFO;">AUX_MODULE_EXTENDED_INFO</a>);

//
// Allocate memory to receive data.
//
modules =
    (<a href="aux_module_extended_info" title="typedef struct _AUX_MODULE_EXTENDED_INFO {&#10;  AUX_MODULE_BASIC_INFO BasicInfo;&#10;  ULONG                 ImageSize;&#10;  USHORT                FileNameOffset;&#10;  UCHAR                 FullPathName[AUX_KLIB_MODULE_PATH_LEN];&#10;} AUX_MODULE_EXTENDED_INFO, *PAUX_MODULE_EXTENDED_INFO;">AUX_MODULE_EXTENDED_INFO</a>*) <a href="exallocatepoolwithtag" title="PVOID ExAllocatePoolWithTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithTag</a>(
                                      PagedPool,
                                      modulesSize,
                                      '3LxF'
                                      );
if (modules == NULL) {
    status = STATUS_INSUFFICIENT_RESOURCES;
    break;
    }

<a href="rtlzeromemory" title="VOID RtlZeroMemory(&#10;  _Out_ VOID UNALIGNED *Destination,&#10;  _In_  SIZE_T         Length&#10;);">RtlZeroMemory</a>(
              modules,
              modulesSize
              );

//
// Obtain the module information.
//
status = AuxKlibQueryModuleInformation(
                                       &amp;modulesSize,
                                       sizeof(<a href="aux_module_extended_info" title="typedef struct _AUX_MODULE_EXTENDED_INFO {&#10;  AUX_MODULE_BASIC_INFO BasicInfo;&#10;  ULONG                 ImageSize;&#10;  USHORT                FileNameOffset;&#10;  UCHAR                 FullPathName[AUX_KLIB_MODULE_PATH_LEN];&#10;} AUX_MODULE_EXTENDED_INFO, *PAUX_MODULE_EXTENDED_INFO;">AUX_MODULE_EXTENDED_INFO</a>),
                                       modules
                                       );
if (!<a href="nt_success" title="#define NT_SUCCESS(Status) (((NTSTATUS)(Status)) &gt;= 0)">NT_SUCCESS</a>(status)) {
    break;
    }
</code></pre>
<h2>See also</h2>
<p><a href="aux_module_basic_info" title="typedef struct _AUX_MODULE_BASIC_INFO {&#10;  PVOID ImageBase;&#10;} AUX_MODULE_BASIC_INFO, *PAUX_MODULE_BASIC_INFO;">AUX_MODULE_BASIC_INFO</a></p>
<p><a href="aux_module_extended_info" title="typedef struct _AUX_MODULE_EXTENDED_INFO {&#10;  AUX_MODULE_BASIC_INFO BasicInfo;&#10;  ULONG                 ImageSize;&#10;  USHORT                FileNameOffset;&#10;  UCHAR                 FullPathName[AUX_KLIB_MODULE_PATH_LEN];&#10;} AUX_MODULE_EXTENDED_INFO, *PAUX_MODULE_EXTENDED_INFO;">AUX_MODULE_EXTENDED_INFO</a></p>
<p><a href="auxklibgetimageexportdirectory" title="PIMAGE_EXPORT_DIRECTORY AuxKlibGetImageExportDirectory(&#10;  [in] PVOID ImageBase&#10;);">AuxKlibGetImageExportDirectory</a></p>
<p><a href="auxklibinitialize" title="NTSTATUS AuxKlibInitialize();">AuxKlibInitialize</a></p>
<p><a href="exallocatepoolwithtag" title="PVOID ExAllocatePoolWithTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithTag</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/aux_klib/nf-aux_klib-auxklibquerymoduleinformation">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/aux_klib/nf-aux_klib-auxklibquerymoduleinformation.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
