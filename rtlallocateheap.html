<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="RtlAllocateHeap - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>RtlAllocateHeap - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            RtlAllocateHeap - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">#ifndef _NTRTL_H

</span><span class="ntdoc-code-intro">/**
 * The RtlAllocateHeap routine allocates a block of memory from a heap.
 *
 * \param HeapHandle Handle for a private heap from which the memory will be allocated.
 * \param Flags Controllable aspects of heap allocation. Specifying any flags will override the corresponding value specified when the heap was created with <a href="rtlcreateheap" title="_Success_(return != 0)&#10;_Must_inspect_result_&#10;_Ret_maybenull_&#10;NTSYSAPI&#10;HANDLE&#10;NTAPI&#10;RtlCreateHeap(&#10;    _In_ ULONG Flags,&#10;    _In_opt_ PVOID HeapBase,&#10;    _In_opt_ SIZE_T ReserveSize,&#10;    _In_opt_ SIZE_T CommitSize,&#10;    _In_opt_ PVOID Lock,&#10;    _When_((Flags &amp; HEAP_CREATE_SEGMENT_HEAP) != 0, _In_reads_bytes_opt_(sizeof(RTL_SEGMENT_HEAP_PARAMETERS)))&#10;    _When_((Flags &amp; HEAP_CREATE_SEGMENT_HEAP) == 0, _In_reads_bytes_opt_(sizeof(RTL_HEAP_PARAMETERS)))&#10;    _In_opt_ PVOID Parameters&#10;    );">RtlCreateHeap</a>.
 * \param Size Number of bytes to be allocated. If the heap, specified by the HeapHandle parameter, is a nongrowable heap, Size must be less than or equal to the heap&#x27;s virtual memory threshold.
 * \return If the call to RtlAllocateHeap succeeds, the return value is a pointer to the newly-allocated block. The return value is NULL if the allocation failed.
 * \remarks https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-rtlallocateheap
 */
</span><span class="ntdoc-code-body">_Success_(return != 0)
_Must_inspect_result_
_Ret_maybenull_
_Post_writable_byte_size_(Size)
__drv_allocatesMem(Mem)
NTSYSAPI
DECLSPEC_ALLOCATOR
<a href="declspec_noalias" title="#define DECLSPEC_NOALIAS __declspec(noalias)">DECLSPEC_NOALIAS</a>
DECLSPEC_RESTRICT
PVOID
NTAPI
RtlAllocateHeap(
    _In_ HANDLE HeapHandle,
    _In_opt_ <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> Flags,
    _In_ <a href="size_t-2" title="typedef ULONG_PTR SIZE_T;">SIZE_T</a> Size
    );
</span><span class="ntdoc-code-footer">
#endif
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://github.com/winsiderss/systeminformer/blob/66e9024965df1192a53aee9b345a8df8f08d8beb/phnt/include/ntrtl.h#L6088">View code on GitHub</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">NTSYSAPI PVOID RtlAllocateHeap(
  [in]           PVOID  HeapHandle,
  [in, optional] <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>  Flags,
  [in]           <a href="size_t-2" title="typedef ULONG_PTR SIZE_T;">SIZE_T</a> Size
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-rtlallocateheap">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/rtlallocateheap.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ntifs-rtlallocateheap)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="rtlallocateheap-function">RtlAllocateHeap function</h1>

<h2 id="description">Description</h2>

<p>The <strong>RtlAllocateHeap</strong> routine allocates a block of memory from a heap.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="heaphandle-in"><code>HeapHandle</code> [in]</h3>

<p>Handle for a private heap from which the memory will be allocated. This parameter is a handle returned from a successful call to <a rel="noopener" target="_blank" href="rtlcreateheap"><strong>RtlCreateHeap</strong></a> .</p>

<h3 id="flags-in-optional"><code>Flags</code> [in, optional]</h3>

<p>Controllable aspects of heap allocation. Specifying any of these values will override the corresponding value specified when the heap was created with <strong><a href="rtlcreateheap" title="_Success_(return != 0)&#10;_Must_inspect_result_&#10;_Ret_maybenull_&#10;NTSYSAPI&#10;HANDLE&#10;NTAPI&#10;RtlCreateHeap(&#10;    _In_ ULONG Flags,&#10;    _In_opt_ PVOID HeapBase,&#10;    _In_opt_ SIZE_T ReserveSize,&#10;    _In_opt_ SIZE_T CommitSize,&#10;    _In_opt_ PVOID Lock,&#10;    _When_((Flags &amp; HEAP_CREATE_SEGMENT_HEAP) != 0, _In_reads_bytes_opt_(sizeof(RTL_SEGMENT_HEAP_PARAMETERS)))&#10;    _When_((Flags &amp; HEAP_CREATE_SEGMENT_HEAP) == 0, _In_reads_bytes_opt_(sizeof(RTL_HEAP_PARAMETERS)))&#10;    _In_opt_ PVOID Parameters&#10;    );">RtlCreateHeap</a></strong>. This parameter can be one or more of the following values.</p>

<table>
<thead>
<tr>
  <th>Flag</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td>HEAP_GENERATE_EXCEPTIONS</td>
  <td>The system will raise an exception to indicate a function failure, such as an out-of-memory condition, instead of returning <strong>NULL</strong>.</td>
</tr>
<tr>
  <td>HEAP_NO_SERIALIZE</td>
  <td>Mutual exclusion will not be used while <strong>RtlAllocateHeap</strong> is accessing the heap.</td>
</tr>
<tr>
  <td>HEAP_ZERO_MEMORY</td>
  <td>The allocated memory will be initialized to zero. Otherwise, the memory is not initialized to zero.</td>
</tr>
</tbody>
</table>

<h3 id="size-in"><code>Size</code> [in]</h3>

<p>Number of bytes to be allocated. If the heap, specified by the <em>HeapHandle</em> parameter, is a nongrowable heap, <em>Size</em> must be less than or equal to the heap's virtual memory threshold. (For more information, see the <strong>VirtualMemoryThreshold</strong> member of the <em>Parameters</em> parameter to <a rel="noopener" target="_blank" href="rtlcreateheap"><strong>RtlCreateHeap</strong></a>.)</p>

<h2 id="return-value">Return value</h2>

<p>If the call to <strong>RtlAllocateHeap</strong> succeeds, the return value is a pointer to the newly-allocated block. The return value is NULL if the allocation failed.</p>

<h2 id="remarks">Remarks</h2>

<p><strong>RtlAllocateHeap</strong> allocates a block of memory of the specified size from the specified heap.</p>

<p>To free a block of memory allocated by <strong>RtlAllocateHeap</strong>, call <strong><a href="rtlfreeheap" title="_Success_(return != 0)&#10;NTSYSAPI&#10;LOGICAL&#10;NTAPI&#10;RtlFreeHeap(&#10;    _In_ HANDLE HeapHandle,&#10;    _In_opt_ ULONG Flags,&#10;    _Frees_ptr_opt_ _Post_invalid_ PVOID BaseAddress&#10;    );">RtlFreeHeap</a></strong>.</p>

<p>Memory allocated by <strong>RtlAllocateHeap</strong> is not movable. Since the memory is not movable, it is possible for the heap to become fragmented.</p>

<p>Serialization ensures mutual exclusion when two or more threads attempt to simultaneously allocate or free blocks from the same heap. There is a small performance cost to serialization, but it must be used whenever multiple threads allocate and free memory from the same heap. Setting the HEAP_NO_SERIALIZE value eliminates mutual exclusion on the heap. Without serialization, two or more threads that use the same heap handle might attempt to allocate or free memory simultaneously, likely causing corruption in the heap. The HEAP_NO_SERIALIZE value can, therefore, be safely used only in the following situations:</p>

<ul>
<li><p>The process has only one thread.</p></li>
<li><p>The process has multiple threads, but only one thread calls the heap functions for a specific heap.</p></li>
<li><p>The process has multiple threads, and the application provides its own mechanism for mutual exclusion to a specific heap.</p></li>
</ul>

<blockquote>
  <p>[!NOTE]
  To guard against an access violation, use structured exception handling to protect any code that writes to or reads from a heap. For more information about structured exception handling with memory accesses, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/handling-exceptions">Handling Exceptions</a>.</p>
</blockquote>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="rtlcreateheap"><strong>RtlCreateHeap</strong></a></p>

<p><a rel="noopener" target="_blank" href="rtldestroyheap"><strong>RtlDestroyHeap</strong></a></p>

<p><a rel="noopener" target="_blank" href="rtlfreeheap"><strong>RtlFreeHeap</strong></a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-rtlallocateheap">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/nf-ntifs-rtlallocateheap.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>NTinternals.net (undocumented.ntinternals.net)</h1>
</div>
<div class="ntdoc-description">
<p>This function is <a rel="noopener" target="_blank" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-rtlallocateheap">documented in Windows Driver Kit</a>.</p>

<hr />

<p>Function maps <code>Win32 API</code> <code>HeapCreate</code>, see <code>Ms SDK</code>.</p>

<h1>Documented by</h1>

<ul>
<li>Tomasz Nowak</li>
</ul>

<h1>See also</h1>

<ul>
<li><code><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">NtAllocateVirtualMemory</a></code></li>
<li><code><a href="rtlcreateheap" title="_Success_(return != 0)&#10;_Must_inspect_result_&#10;_Ret_maybenull_&#10;NTSYSAPI&#10;HANDLE&#10;NTAPI&#10;RtlCreateHeap(&#10;    _In_ ULONG Flags,&#10;    _In_opt_ PVOID HeapBase,&#10;    _In_opt_ SIZE_T ReserveSize,&#10;    _In_opt_ SIZE_T CommitSize,&#10;    _In_opt_ PVOID Lock,&#10;    _When_((Flags &amp; HEAP_CREATE_SEGMENT_HEAP) != 0, _In_reads_bytes_opt_(sizeof(RTL_SEGMENT_HEAP_PARAMETERS)))&#10;    _When_((Flags &amp; HEAP_CREATE_SEGMENT_HEAP) == 0, _In_reads_bytes_opt_(sizeof(RTL_HEAP_PARAMETERS)))&#10;    _In_opt_ PVOID Parameters&#10;    );">RtlCreateHeap</a></code></li>
</ul>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/undocumented.ntinternals.net/rtlallocateheap.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
