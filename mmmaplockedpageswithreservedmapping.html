<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="MmMapLockedPagesWithReservedMapping - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>MmMapLockedPagesWithReservedMapping - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            MmMapLockedPagesWithReservedMapping - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">PVOID MmMapLockedPagesWithReservedMapping(
  [in] PVOID                                                    MappingAddress,
  [in] <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                                                    PoolTag,
  [in] <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">PMDL</a>                                                     MemoryDescriptorList,
  [in] __drv_strictTypeMatch(__drv_typeCond)<a href="memory_caching_type" title="typedef enum _MEMORY_CACHING_TYPE {&#10;  MmNonCached,&#10;  MmCached,&#10;  MmWriteCombined,&#10;  MmHardwareCoherentCached,&#10;  MmNonCachedUnordered,&#10;  MmUSWCCached,&#10;  MmMaximumCacheType,&#10;  MmNotMapped&#10;} MEMORY_CACHING_TYPE;">MEMORY_CACHING_TYPE</a> CacheType
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-mmmaplockedpageswithreservedmapping">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/mmmaplockedpageswithreservedmapping.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdm-mmmaplockedpageswithreservedmapping)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="mmmaplockedpageswithreservedmapping-function">MmMapLockedPagesWithReservedMapping function</h1>

<h2 id="description">Description</h2>

<p>The <strong>MmMapLockedPagesWithReservedMapping</strong> routine maps all or part of an address range that was previously reserved by the <a href="mmallocatemappingaddress" title="PVOID MmAllocateMappingAddress(&#10;  [in] SIZE_T NumberOfBytes,&#10;  [in] ULONG  PoolTag&#10;);">MmAllocateMappingAddress</a> routine.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="mappingaddress-in"><code>MappingAddress</code> [in]</h3>

<p>Pointer to the beginning of the reserved virtual memory range. This must be an address previously returned by <a href="mmallocatemappingaddress" title="PVOID MmAllocateMappingAddress(&#10;  [in] SIZE_T NumberOfBytes,&#10;  [in] ULONG  PoolTag&#10;);">MmAllocateMappingAddress</a>.</p>

<h3 id="pooltag-in"><code>PoolTag</code> [in]</h3>

<p>Specifies the pool tag for the reserved memory buffer. This must be identical to the value specified in the <em>PoolTag</em> parameter of the call to <a href="mmallocatemappingaddress" title="PVOID MmAllocateMappingAddress(&#10;  [in] SIZE_T NumberOfBytes,&#10;  [in] ULONG  PoolTag&#10;);">MmAllocateMappingAddress</a> that reserved the buffer.</p>

<h3 id="memorydescriptorlist-in"><code>MemoryDescriptorList</code> [in]</h3>

<p>A pointer to the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> that is to be mapped. This <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> must describe physical pages that are locked down. A locked-down <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> can be built by the <a href="mmprobeandlockpages" title="VOID MmProbeAndLockPages(&#10;  [in, out] PMDL            MemoryDescriptorList,&#10;  [in]      KPROCESSOR_MODE AccessMode,&#10;  [in]      LOCK_OPERATION  Operation&#10;);">MmProbeAndLockPages</a> or <a href="mmallocatepagesformdlex" title="PMDL MmAllocatePagesForMdlEx(&#10;  [in] PHYSICAL_ADDRESS    LowAddress,&#10;  [in] PHYSICAL_ADDRESS    HighAddress,&#10;  [in] PHYSICAL_ADDRESS    SkipBytes,&#10;  [in] SIZE_T              TotalBytes,&#10;  [in] MEMORY_CACHING_TYPE CacheType,&#10;  [in] ULONG               Flags&#10;);">MmAllocatePagesForMdlEx</a> routine.</p>

<h3 id="cachetype-in"><code>CacheType</code> [in]</h3>

<p>Specifies the <a href="memory_caching_type" title="typedef enum _MEMORY_CACHING_TYPE {&#10;  MmNonCached,&#10;  MmCached,&#10;  MmWriteCombined,&#10;  MmHardwareCoherentCached,&#10;  MmNonCachedUnordered,&#10;  MmUSWCCached,&#10;  MmMaximumCacheType,&#10;  MmNotMapped&#10;} MEMORY_CACHING_TYPE;">MEMORY_CACHING_TYPE</a> value to use to create the mapping.</p>

<h2 id="return-value">Return value</h2>

<p><strong>MmMapLockedPagesWithReservedMapping</strong> returns a pointer to the beginning of the mapped memory, or <strong>NULL</strong> if the system could not map the memory. This routine returns <strong>NULL</strong> only if there is an error in the function parameters (for example, the driver's mapping address is not large enough to span the supplied <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a>). This function is intended to enable drivers to make forward progress even in low-resource scenarios.</p>

<h2 id="remarks">Remarks</h2>

<p>The caller can use <strong>MmMapLockedPagesWithReservedMapping</strong> to map a subrange of the virtual memory range reserved by <a href="mmallocatemappingaddress" title="PVOID MmAllocateMappingAddress(&#10;  [in] SIZE_T NumberOfBytes,&#10;  [in] ULONG  PoolTag&#10;);">MmAllocateMappingAddress</a> as follows:</p>

<ul>
<li><p>Use <a href="ioallocatemdl" title="PMDL IoAllocateMdl(&#10;  [in, optional]      __drv_aliasesMem PVOID VirtualAddress,&#10;  [in]                ULONG                  Length,&#10;  [in]                BOOLEAN                SecondaryBuffer,&#10;  [in]                BOOLEAN                ChargeQuota,&#10;  [in, out, optional] PIRP                   Irp&#10;);">IoAllocateMdl</a> to allocate an <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a>. The returned <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> is built using the specified starting address and size of the subrange of the virtual memory range to map.</p></li>
<li><p>Use <a href="mmprobeandlockpages" title="VOID MmProbeAndLockPages(&#10;  [in, out] PMDL            MemoryDescriptorList,&#10;  [in]      KPROCESSOR_MODE AccessMode,&#10;  [in]      LOCK_OPERATION  Operation&#10;);">MmProbeAndLockPages</a> to lock down the physical pages described by the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> obtained in step 1.</p></li>
<li><p>Use <strong>MmMapLockedPagesWithReservedMapping</strong> to actually map the virtual memory to the physical memory that was locked down in step 2. Note that the virtual address returned by this function does include the byte offset that the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> specifies. However, the <strong>MappedSystemVa</strong> field of the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> that is set by this function does not include the byte offset.</p></li>
<li><p>Once the caller does not need to access the memory, it unmaps the memory with <a href="mmunmapreservedmapping" title="VOID MmUnmapReservedMapping(&#10;  [in] PVOID BaseAddress,&#10;  [in] ULONG PoolTag,&#10;  [in] PMDL  MemoryDescriptorList&#10;);">MmUnmapReservedMapping</a>. The caller can map and unmap the memory buffer as needed, and must unmap it prior to freeing the mapping range with <a href="mmfreemappingaddress" title="VOID MmFreeMappingAddress(&#10;  [in] PVOID BaseAddress,&#10;  [in] ULONG PoolTag&#10;);">MmFreeMappingAddress</a>.</p></li>
</ul>

<p>Note that the <em>MappingAddress</em> parameter specifies the beginning of the range of memory previously reserved by the caller, not the beginning of the memory subrange to be mapped. The caller specifies the starting address and length of the buffer when it allocates the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> with <a href="ioallocatemdl" title="PMDL IoAllocateMdl(&#10;  [in, optional]      __drv_aliasesMem PVOID VirtualAddress,&#10;  [in]                ULONG                  Length,&#10;  [in]                BOOLEAN                SecondaryBuffer,&#10;  [in]                BOOLEAN                ChargeQuota,&#10;  [in, out, optional] PIRP                   Irp&#10;);">IoAllocateMdl</a>. The buffer must fit inside the reserved memory range, but it can be a strict subset.</p>

<p>The routine uses the <em>CacheType</em> parameter only if the pages that are described by the <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> do not already have a cache type associated with them. However, in nearly all cases, the pages already have an associated cache type, and this cache type is used by the new mapping. An exception to this rule is for pages that are allocated by <a href="mmallocatepagesformdl" title="PMDL MmAllocatePagesForMdl(&#10;  [in] PHYSICAL_ADDRESS LowAddress,&#10;  [in] PHYSICAL_ADDRESS HighAddress,&#10;  [in] PHYSICAL_ADDRESS SkipBytes,&#10;  [in] SIZE_T           TotalBytes&#10;);">MmAllocatePagesForMdl</a>, which do not have a specific cache type associated with them. For such pages, the <em>CacheType</em> parameter determines the cache type of the mapping.</p>

<h2 id="see-also">See also</h2>

<p><a href="ioallocatemdl" title="PMDL IoAllocateMdl(&#10;  [in, optional]      __drv_aliasesMem PVOID VirtualAddress,&#10;  [in]                ULONG                  Length,&#10;  [in]                BOOLEAN                SecondaryBuffer,&#10;  [in]                BOOLEAN                ChargeQuota,&#10;  [in, out, optional] PIRP                   Irp&#10;);">IoAllocateMdl</a></p>

<p><a href="memory_caching_type" title="typedef enum _MEMORY_CACHING_TYPE {&#10;  MmNonCached,&#10;  MmCached,&#10;  MmWriteCombined,&#10;  MmHardwareCoherentCached,&#10;  MmNonCachedUnordered,&#10;  MmUSWCCached,&#10;  MmMaximumCacheType,&#10;  MmNotMapped&#10;} MEMORY_CACHING_TYPE;">MEMORY_CACHING_TYPE</a></p>

<p><a href="mmallocatemappingaddress" title="PVOID MmAllocateMappingAddress(&#10;  [in] SIZE_T NumberOfBytes,&#10;  [in] ULONG  PoolTag&#10;);">MmAllocateMappingAddress</a></p>

<p><a href="mmallocatepagesformdl" title="PMDL MmAllocatePagesForMdl(&#10;  [in] PHYSICAL_ADDRESS LowAddress,&#10;  [in] PHYSICAL_ADDRESS HighAddress,&#10;  [in] PHYSICAL_ADDRESS SkipBytes,&#10;  [in] SIZE_T           TotalBytes&#10;);">MmAllocatePagesForMdl</a></p>

<p><a href="mmallocatepagesformdlex" title="PMDL MmAllocatePagesForMdlEx(&#10;  [in] PHYSICAL_ADDRESS    LowAddress,&#10;  [in] PHYSICAL_ADDRESS    HighAddress,&#10;  [in] PHYSICAL_ADDRESS    SkipBytes,&#10;  [in] SIZE_T              TotalBytes,&#10;  [in] MEMORY_CACHING_TYPE CacheType,&#10;  [in] ULONG               Flags&#10;);">MmAllocatePagesForMdlEx</a></p>

<p><a href="mmfreemappingaddress" title="VOID MmFreeMappingAddress(&#10;  [in] PVOID BaseAddress,&#10;  [in] ULONG PoolTag&#10;);">MmFreeMappingAddress</a></p>

<p><a href="mmprobeandlockpages" title="VOID MmProbeAndLockPages(&#10;  [in, out] PMDL            MemoryDescriptorList,&#10;  [in]      KPROCESSOR_MODE AccessMode,&#10;  [in]      LOCK_OPERATION  Operation&#10;);">MmProbeAndLockPages</a></p>

<p><a href="mmunmapreservedmapping" title="VOID MmUnmapReservedMapping(&#10;  [in] PVOID BaseAddress,&#10;  [in] ULONG PoolTag,&#10;  [in] PMDL  MemoryDescriptorList&#10;);">MmUnmapReservedMapping</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-mmmaplockedpageswithreservedmapping">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/nf-wdm-mmmaplockedpageswithreservedmapping.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
