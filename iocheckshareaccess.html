<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="IoCheckShareAccess - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>IoCheckShareAccess - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            IoCheckShareAccess - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> IoCheckShareAccess(
  [in]      ACCESS_MASK   DesiredAccess,
  [in]      <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>         DesiredShareAccess,
  [in, out] <a href="file_object" title="typedef struct _FILE_OBJECT {&#10;  CSHORT                                Type;&#10;  CSHORT                                Size;&#10;  PDEVICE_OBJECT                        DeviceObject;&#10;  PVPB                                  Vpb;&#10;  PVOID                                 FsContext;&#10;  PVOID                                 FsContext2;&#10;  PSECTION_OBJECT_POINTERS              SectionObjectPointer;&#10;  PVOID                                 PrivateCacheMap;&#10;  NTSTATUS                              FinalStatus;&#10;  struct _FILE_OBJECT                   *RelatedFileObject;&#10;  BOOLEAN                               LockOperation;&#10;  BOOLEAN                               DeletePending;&#10;  BOOLEAN                               ReadAccess;&#10;  BOOLEAN                               WriteAccess;&#10;  BOOLEAN                               DeleteAccess;&#10;  BOOLEAN                               SharedRead;&#10;  BOOLEAN                               SharedWrite;&#10;  BOOLEAN                               SharedDelete;&#10;  ULONG                                 Flags;&#10;...">PFILE_OBJECT</a>  FileObject,
  [in, out] PSHARE_ACCESS ShareAccess,
  [in]      BOOLEAN       Update
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-iocheckshareaccess">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/iocheckshareaccess.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdm-iocheckshareaccess)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="iocheckshareaccess-function">IoCheckShareAccess function</h1>

<h2 id="description">Description</h2>

<p>The <strong>IoCheckShareAccess</strong> routine is called by file system drivers (FSDs) or other highest-level drivers to check whether shared access to a file object is permitted.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="desiredaccess-in"><code>DesiredAccess</code> [in]</h3>

<p>Specifies an <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/access-mask">ACCESS_MASK</a> value that indicates the desired type of access to the given *FileObject* for the current open request. Drivers compute the value of this parameter by taking the requested access in the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ifs/irp-mj-create">IRP_MJ_CREATE</a> request and then applying <a href="seaccesscheck" title="BOOLEAN SeAccessCheck(&#10;  [in]  PSECURITY_DESCRIPTOR      SecurityDescriptor,&#10;  [in]  PSECURITY_SUBJECT_CONTEXT SubjectSecurityContext,&#10;  [in]  BOOLEAN                   SubjectContextLocked,&#10;  [in]  ACCESS_MASK               DesiredAccess,&#10;  [in]  ACCESS_MASK               PreviouslyGrantedAccess,&#10;  [out] PPRIVILEGE_SET            *Privileges,&#10;  [in]  PGENERIC_MAPPING          GenericMapping,&#10;  [in]  KPROCESSOR_MODE           AccessMode,&#10;  [out] PACCESS_MASK              GrantedAccess,&#10;  [out] PNTSTATUS                 AccessStatus&#10;);">SeAccessCheck</a> for each security descriptor to determine the actual access granted. If the granted access is more restrictive than the desired access, then that is an error, and the driver should complete the current <a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a> with a status of STATUS_ACCESS_DENIED. (Note that **<a href="seaccesscheck" title="BOOLEAN SeAccessCheck(&#10;  [in]  PSECURITY_DESCRIPTOR      SecurityDescriptor,&#10;  [in]  PSECURITY_SUBJECT_CONTEXT SubjectSecurityContext,&#10;  [in]  BOOLEAN                   SubjectContextLocked,&#10;  [in]  ACCESS_MASK               DesiredAccess,&#10;  [in]  ACCESS_MASK               PreviouslyGrantedAccess,&#10;  [out] PPRIVILEGE_SET            *Privileges,&#10;  [in]  PGENERIC_MAPPING          GenericMapping,&#10;  [in]  KPROCESSOR_MODE           AccessMode,&#10;  [out] PACCESS_MASK              GrantedAccess,&#10;  [out] PNTSTATUS                 AccessStatus&#10;);">SeAccessCheck</a>** clears the MAXIMUM_ALLOWED bit in the granted access; be sure to not use that bit when comparing desired access to granted access.) The driver then passes the granted access as the value of <em>DesiredAccess</em>.</p>

<h3 id="desiredshareaccess-in"><code>DesiredShareAccess</code> [in]</h3>

<p>Specifies the desired type of shared access to <em>FileObject</em> for the current open request. The value of this parameter is usually the same as the <em>ShareAccess</em> passed to the file system or highest-level driver by the I/O manager when the open request was made. This value can be zero, or any combination of the following:</p>

<p><a href="file_share_read" title="#define FILE_SHARE_READ 0x00000001">FILE_SHARE_READ</a></p>

<p><a href="file_share_write" title="#define FILE_SHARE_WRITE 0x00000002">FILE_SHARE_WRITE</a></p>

<p><a href="file_share_delete" title="#define FILE_SHARE_DELETE 0x00000004">FILE_SHARE_DELETE</a></p>

<h3 id="fileobject-in-out"><code>FileObject</code> [in, out]</h3>

<p>Pointer to the file object for which to check access for the current open request.</p>

<h3 id="shareaccess-in-out"><code>ShareAccess</code> [in, out]</h3>

<p>Pointer to the common share-access data structure associated with <em>FileObject</em>. Drivers should treat this structure as opaque.</p>

<h3 id="update-in"><code>Update</code> [in]</h3>

<p>Specifies whether to update the share-access status for <em>FileObject</em>. A Boolean value of <strong>TRUE</strong> means this routine will update the share access information for the file object if the open request is permitted.</p>

<h2 id="return-value">Return value</h2>

<p><strong>IoCheckShareAccess</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the requester's access to the file object is compatible with the way in which it is currently open. If the request is denied because of a sharing violation, then STATUS_SHARING_VIOLATION is returned.</p>

<h2 id="remarks">Remarks</h2>

<p><strong>IoCheckShareAccess</strong> checks a file object open request to determine whether the types of desired and shared accesses specified are compatible with the way in which the file object is currently being accessed by other opens.</p>

<p>File systems maintain state about files through structures called file control blocks (FCBs). The SHARE_ACCESS is a structure describing how the file is currently accessed by all opens. This state is contained in the FCB as part of the open state for each file object. Each file object should have only one share access structure. Other highest-level drivers might call this routine to check the access requested when a file object representing such a driver's device object is opened.</p>

<p><strong>IoCheckShareAccess</strong> is not an atomic operation. Therefore, drivers calling this routine must protect the shared file object passed to <strong>IoCheckShareAccess</strong> by means of some kind of lock, such as a mutex or a resource lock, in order to prevent corruption of the shared access counts.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/access-mask">ACCESS_MASK</a></p>

<p><a href="iocreatefile" title="NTSTATUS IoCreateFile(&#10;  [out]          PHANDLE            FileHandle,&#10;  [in]           ACCESS_MASK        DesiredAccess,&#10;  [in]           POBJECT_ATTRIBUTES ObjectAttributes,&#10;  [out]          PIO_STATUS_BLOCK   IoStatusBlock,&#10;  [in, optional] PLARGE_INTEGER     AllocationSize,&#10;  [in]           ULONG              FileAttributes,&#10;  [in]           ULONG              ShareAccess,&#10;  [in]           ULONG              Disposition,&#10;  [in]           ULONG              CreateOptions,&#10;  [in, optional] PVOID              EaBuffer,&#10;  [in]           ULONG              EaLength,&#10;  [in]           CREATE_FILE_TYPE   CreateFileType,&#10;  [in, optional] PVOID              InternalParameters,&#10;  [in]           ULONG              Options&#10;);">IoCreateFile</a></p>

<p><a href="iocreatefileex" title="NTSTATUS IoCreateFileEx(&#10;  [out]          PHANDLE                   FileHandle,&#10;  [in]           ACCESS_MASK               DesiredAccess,&#10;  [in]           POBJECT_ATTRIBUTES        ObjectAttributes,&#10;  [out]          PIO_STATUS_BLOCK          IoStatusBlock,&#10;  [in, optional] PLARGE_INTEGER            AllocationSize,&#10;  [in]           ULONG                     FileAttributes,&#10;  [in]           ULONG                     ShareAccess,&#10;  [in]           ULONG                     Disposition,&#10;  [in]           ULONG                     CreateOptions,&#10;  [in, optional] PVOID                     EaBuffer,&#10;  [in]           ULONG                     EaLength,&#10;  [in]           CREATE_FILE_TYPE          CreateFileType,&#10;  [in, optional] PVOID                     InternalParameters,&#10;  [in]           ULONG                     Options,&#10;  [in, optional] PIO_DRIVER_CREATE_CONTEXT DriverContext&#10;);">IoCreateFileEx</a></p>

<p><a href="iogetrelateddeviceobject" title="PDEVICE_OBJECT IoGetRelatedDeviceObject(&#10;  [in] PFILE_OBJECT FileObject&#10;);">IoGetRelatedDeviceObject</a></p>

<p><a href="ioremoveshareaccess" title="VOID IoRemoveShareAccess(&#10;  [in]      PFILE_OBJECT  FileObject,&#10;  [in, out] PSHARE_ACCESS ShareAccess&#10;);">IoRemoveShareAccess</a></p>

<p><a href="iosetshareaccess" title="VOID IoSetShareAccess(&#10;  [in]      ACCESS_MASK   DesiredAccess,&#10;  [in]      ULONG         DesiredShareAccess,&#10;  [in, out] PFILE_OBJECT  FileObject,&#10;  [out]     PSHARE_ACCESS ShareAccess&#10;);">IoSetShareAccess</a></p>

<p><a href="ioupdateshareaccess" title="VOID IoUpdateShareAccess(&#10;  [in]      PFILE_OBJECT  FileObject,&#10;  [in, out] PSHARE_ACCESS ShareAccess&#10;);">IoUpdateShareAccess</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-iocheckshareaccess">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/nf-wdm-iocheckshareaccess.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
