<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="FltCbdqRemoveIo - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>FltCbdqRemoveIo - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
        <link rel="stylesheet" href="modules/highlight.js/styles/github.ntdoc.min.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/highlight.js/styles/github-dark-dimmed.ntdoc.min.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            FltCbdqRemoveIo - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// fltkernel.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="flt_callback_data" title="typedef struct _FLT_CALLBACK_DATA {&#10;  FLT_CALLBACK_DATA_FLAGS     Flags;&#10;  PETHREAD                    Thread;&#10;  PFLT_IO_PARAMETER_BLOCK     Iopb;&#10;  IO_STATUS_BLOCK             IoStatus;&#10;  struct _FLT_TAG_DATA_BUFFER *TagData;&#10;  union {&#10;    struct {&#10;      LIST_ENTRY QueueLinks;&#10;      PVOID      QueueContext[2];&#10;    };&#10;    PVOID FilterContext[4];&#10;  };&#10;  KPROCESSOR_MODE             RequestorMode;&#10;} FLT_CALLBACK_DATA, *PFLT_CALLBACK_DATA;">PFLT_CALLBACK_DATA</a> FLTAPI FltCbdqRemoveIo(
  [in, out] <a href="flt_callback_data_queue" title="typedef struct _FLT_CALLBACK_DATA_QUEUE {&#10;  IO_CSQ                                        Csq;&#10;  FLT_CALLBACK_DATA_QUEUE_FLAGS                 Flags;&#10;  PFLT_INSTANCE                                 Instance;&#10;  PFLT_CALLBACK_DATA_QUEUE_INSERT_IO            InsertIo;&#10;  PFLT_CALLBACK_DATA_QUEUE_REMOVE_IO            RemoveIo;&#10;  PFLT_CALLBACK_DATA_QUEUE_PEEK_NEXT_IO         PeekNextIo;&#10;  PFLT_CALLBACK_DATA_QUEUE_ACQUIRE              Acquire;&#10;  PFLT_CALLBACK_DATA_QUEUE_RELEASE              Release;&#10;  PFLT_CALLBACK_DATA_QUEUE_COMPLETE_CANCELED_IO CompleteCanceledIo;&#10;} FLT_CALLBACK_DATA_QUEUE, *PFLT_CALLBACK_DATA_QUEUE;">PFLT_CALLBACK_DATA_QUEUE</a>            Cbdq,
  [in]      PFLT_CALLBACK_DATA_QUEUE_IO_CONTEXT Context
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fltkernel/nf-fltkernel-fltcbdqremoveio">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/fltcbdqremoveio.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-fltkernel-fltcbdqremoveio)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1>FltCbdqRemoveIo function</h1>
<h2>Description</h2>
<p><em>FltCbdqRemoveIo</em> removes a particular item from a minifilter driver's callback data queue.</p>
<h2>Parameters</h2>
<h3><code>Cbdq</code> [in, out]</h3>
<p>Pointer to a cancel-safe callback data queue. This queue must have been initialized by calling <a href="fltcbdqinitialize" title="NTSTATUS FLTAPI FltCbdqInitialize(&#10;  [in]      PFLT_INSTANCE                                 Instance,&#10;  [in, out] PFLT_CALLBACK_DATA_QUEUE                      Cbdq,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_INSERT_IO            CbdqInsertIo,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_REMOVE_IO            CbdqRemoveIo,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_PEEK_NEXT_IO         CbdqPeekNextIo,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_ACQUIRE              CbdqAcquire,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_RELEASE              CbdqRelease,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_COMPLETE_CANCELED_IO CbdqCompleteCanceledIo&#10;);">FltCbdqInitialize</a>.</p>
<h3><code>Context</code> [in]</h3>
<p>Context pointer for the item to be removed. This context is initialized by <a href="fltcbdqinsertio" title="NTSTATUS FLTAPI FltCbdqInsertIo(&#10;  [in, out]      PFLT_CALLBACK_DATA_QUEUE            Cbdq,&#10;  [in]           PFLT_CALLBACK_DATA                  Cbd,&#10;  [in, optional] PFLT_CALLBACK_DATA_QUEUE_IO_CONTEXT Context,&#10;  [in, optional] PVOID                               InsertContext&#10;);">FltCbdqInsertIo</a> when the I/O request is first inserted in the queue. This parameter is required and must be non-<strong>NULL</strong>.</p>
<h2>Return value</h2>
<p><em>FltCbdqRemoveIo</em> returns a pointer to the callback data structure for the I/O request that was removed from the queue. If no matching I/O request is found or if the queue is empty, <em>FltCbdqRemoveIo</em> returns <strong>NULL</strong>.</p>
<h2>Remarks</h2>
<p><em>FltCbdqRemoveIo</em> removes the callback data (<a href="flt_callback_data" title="typedef struct _FLT_CALLBACK_DATA {&#10;  FLT_CALLBACK_DATA_FLAGS     Flags;&#10;  PETHREAD                    Thread;&#10;  PFLT_IO_PARAMETER_BLOCK     Iopb;&#10;  IO_STATUS_BLOCK             IoStatus;&#10;  struct _FLT_TAG_DATA_BUFFER *TagData;&#10;  union {&#10;    struct {&#10;      LIST_ENTRY QueueLinks;&#10;      PVOID      QueueContext[2];&#10;    };&#10;    PVOID FilterContext[4];&#10;  };&#10;  KPROCESSOR_MODE             RequestorMode;&#10;} FLT_CALLBACK_DATA, *PFLT_CALLBACK_DATA;">FLT_CALLBACK_DATA</a>) structure for a particular I/O operation from a minifilter driver's callback data queue. <em>FltCbdqRemoveIo</em> can only be used to delete a callback data structure that has a <em>Context</em> structure associated with it. This association is created when the callback data structure is inserted into the callback data queue by <a href="fltcbdqinsertio" title="NTSTATUS FLTAPI FltCbdqInsertIo(&#10;  [in, out]      PFLT_CALLBACK_DATA_QUEUE            Cbdq,&#10;  [in]           PFLT_CALLBACK_DATA                  Cbd,&#10;  [in, optional] PFLT_CALLBACK_DATA_QUEUE_IO_CONTEXT Context,&#10;  [in, optional] PVOID                               InsertContext&#10;);">FltCbdqInsertIo</a>.</p>
<p>Minifilter drivers can use the <strong>FltCbdq</strong><em>Xxx</em> routines to implement a callback data queue for <a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a>-based I/O operations. By using these routines, minifilter drivers can make their queues cancel-safe; the system transparently handles I/O cancellation for the minifilter drivers.</p>
<p>The <strong>FltCbdq</strong><em>Xxx</em> routines can only be used for <a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a>-based I/O operations. To determine whether a given callback data structure represents an <a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a>-based I/O operation, use the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/ff544654(v=vs.85)">FLT_IS_IRP_OPERATION</a> macro.</p>
<p>A callback data queue is initialized by <a href="fltcbdqinitialize" title="NTSTATUS FLTAPI FltCbdqInitialize(&#10;  [in]      PFLT_INSTANCE                                 Instance,&#10;  [in, out] PFLT_CALLBACK_DATA_QUEUE                      Cbdq,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_INSERT_IO            CbdqInsertIo,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_REMOVE_IO            CbdqRemoveIo,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_PEEK_NEXT_IO         CbdqPeekNextIo,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_ACQUIRE              CbdqAcquire,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_RELEASE              CbdqRelease,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_COMPLETE_CANCELED_IO CbdqCompleteCanceledIo&#10;);">FltCbdqInitialize</a>. <em>FltCbdqRemoveIo</em> uses the routines provided in the queue's dispatch table to lock the queue and remove the callback data structure from the queue. The remove operation itself is performed by the minifilter driver's <em>CbdqRemoveIo</em> callback routine.</p>
<p>If the queue is protected by a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/spin-locks">spin lock</a> rather than a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/mutex-objects">mutex object</a> or <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-exinitializeresourcelite">resource variable</a>, the caller of <em>FltCbdqRemoveIo</em> can be running at IRQL &lt;= DISPATCH_LEVEL. If a mutex or resource is used, the caller must be running at IRQL &lt;= APC_LEVEL.</p>
<p>There is a potential race between the filter manager removing a cancelled I/O request, and the filter driver removing it because it was completed. It is important to note that the request context remains valid after it is first removed, which will cause a second removal attempt to fail.</p>
<h2>See also</h2>
<p><a href="flt_callback_data" title="typedef struct _FLT_CALLBACK_DATA {&#10;  FLT_CALLBACK_DATA_FLAGS     Flags;&#10;  PETHREAD                    Thread;&#10;  PFLT_IO_PARAMETER_BLOCK     Iopb;&#10;  IO_STATUS_BLOCK             IoStatus;&#10;  struct _FLT_TAG_DATA_BUFFER *TagData;&#10;  union {&#10;    struct {&#10;      LIST_ENTRY QueueLinks;&#10;      PVOID      QueueContext[2];&#10;    };&#10;    PVOID FilterContext[4];&#10;  };&#10;  KPROCESSOR_MODE             RequestorMode;&#10;} FLT_CALLBACK_DATA, *PFLT_CALLBACK_DATA;">FLT_CALLBACK_DATA</a></p>
<p><a href="flt_callback_data_queue" title="typedef struct _FLT_CALLBACK_DATA_QUEUE {&#10;  IO_CSQ                                        Csq;&#10;  FLT_CALLBACK_DATA_QUEUE_FLAGS                 Flags;&#10;  PFLT_INSTANCE                                 Instance;&#10;  PFLT_CALLBACK_DATA_QUEUE_INSERT_IO            InsertIo;&#10;  PFLT_CALLBACK_DATA_QUEUE_REMOVE_IO            RemoveIo;&#10;  PFLT_CALLBACK_DATA_QUEUE_PEEK_NEXT_IO         PeekNextIo;&#10;  PFLT_CALLBACK_DATA_QUEUE_ACQUIRE              Acquire;&#10;  PFLT_CALLBACK_DATA_QUEUE_RELEASE              Release;&#10;  PFLT_CALLBACK_DATA_QUEUE_COMPLETE_CANCELED_IO CompleteCanceledIo;&#10;} FLT_CALLBACK_DATA_QUEUE, *PFLT_CALLBACK_DATA_QUEUE;">FLT_CALLBACK_DATA_QUEUE</a></p>
<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/ff544654(v=vs.85)">FLT_IS_IRP_OPERATION</a></p>
<p><a href="fltcbdqdisable" title="VOID FLTAPI FltCbdqDisable(&#10;  [in, out] PFLT_CALLBACK_DATA_QUEUE Cbdq&#10;);">FltCbdqDisable</a></p>
<p><a href="fltcbdqenable" title="VOID FLTAPI FltCbdqEnable(&#10;  [in, out] PFLT_CALLBACK_DATA_QUEUE Cbdq&#10;);">FltCbdqEnable</a></p>
<p><a href="fltcbdqinitialize" title="NTSTATUS FLTAPI FltCbdqInitialize(&#10;  [in]      PFLT_INSTANCE                                 Instance,&#10;  [in, out] PFLT_CALLBACK_DATA_QUEUE                      Cbdq,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_INSERT_IO            CbdqInsertIo,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_REMOVE_IO            CbdqRemoveIo,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_PEEK_NEXT_IO         CbdqPeekNextIo,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_ACQUIRE              CbdqAcquire,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_RELEASE              CbdqRelease,&#10;  [in]      PFLT_CALLBACK_DATA_QUEUE_COMPLETE_CANCELED_IO CbdqCompleteCanceledIo&#10;);">FltCbdqInitialize</a></p>
<p><a href="fltcbdqinsertio" title="NTSTATUS FLTAPI FltCbdqInsertIo(&#10;  [in, out]      PFLT_CALLBACK_DATA_QUEUE            Cbdq,&#10;  [in]           PFLT_CALLBACK_DATA                  Cbd,&#10;  [in, optional] PFLT_CALLBACK_DATA_QUEUE_IO_CONTEXT Context,&#10;  [in, optional] PVOID                               InsertContext&#10;);">FltCbdqInsertIo</a></p>
<p><a href="fltcbdqremovenextio" title="PFLT_CALLBACK_DATA FLTAPI FltCbdqRemoveNextIo(&#10;  [in, out]      PFLT_CALLBACK_DATA_QUEUE Cbdq,&#10;  [in, optional] PVOID                    PeekContext&#10;);">FltCbdqRemoveNextIo</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fltkernel/nf-fltkernel-fltcbdqremoveio">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/fltkernel/nf-fltkernel-fltcbdqremoveio.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script src="modules/highlight.js/highlight.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
