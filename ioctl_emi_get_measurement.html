<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="IOCTL_EMI_GET_MEASUREMENT - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>IOCTL_EMI_GET_MEASUREMENT - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            IOCTL_EMI_GET_MEASUREMENT - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// emi.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x0022, 0x003, METHOD_BUFFERED, FILE_READ_ACCESS)
#define IOCTL_EMI_GET_MEASUREMENT 0x0022400C</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows/win32/api/emi/ni-emi-ioctl_emi_get_measurement">View the official Win32 API reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ioctl_emi_get_measurement.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Win32 API reference (ni-emi-ioctl_emi_get_measurement)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="ioctl_emi_get_measurement-ioctl">IOCTL_EMI_GET_MEASUREMENT IOCTL</h1>

<h2 id="description">Description</h2>

<p>The <strong>IOCTL_EMI_GET_MEASUREMENT</strong>
control code retrieves the current energy measurement and the time at which the measurement was taken.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="input-buffer">Input buffer</h3>

<p>None.</p>

<h3 id="input-buffer-length">Input buffer length</h3>

<p>None.</p>

<h3 id="output-buffer">Output buffer</h3>

<p>The <strong>AssociatedIrp.SystemBuffer</strong> member specifies the address of a caller-allocated buffer that contains the measurement data from provider device driver.</p>

<h3 id="output-buffer-length">Output buffer length</h3>

<p>The length of output buffer should be the size of <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/emi/ns-emi-emi_channel_measurement_data">EMI_MEASUREMENT_DATA_V1</a> or <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/emi/ns-emi-emi_measurement_data_v2">EMI_MEASUREMENT_DATA_V2</a> multiply by number of channels, it is specified in the  <strong>Parameters.DeviceIoControl.OutputBufferLength</strong> member.</p>

<h3 id="status-block">Status block</h3>

<p>Irp->IoStatus.Status is set to <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the request is successful. Otherwise, Status to the appropriate error condition as a <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> code.</p>

<p>For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/ntstatus-values">NTSTATUS Values</a>.</p>

<h3 id="remarks">Remarks</h3>

<p>For EMI version 1 and 2, the EMI measurement data reported from each channel should be accumulated and translated to the unit specified by the channel on each request, as the EMI interface of any device should be shared across the system, therefore how freqeunt the counters are being sampled and accumulated depends on how often each of its consumer requests and also the driver implementation.</p>

<p>For the EMI version 2, Multiple channels are exposed by the same device should be sampled at once on each request, hence the caller should use the  <strong>ChannelCount</strong>  in the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/emi/ns-emi-emi_metadata_v2">EMI_METADATA_V2</a> to traverse the channels, for example:</p>

<p><!-- CODE_MARKER --></p>

<pre><code>
  status = DeviceIoControl(DeviceHandle,
                           IOCTL_EMI_GET_MEASUREMENT,
                           NULL,
                           NULL,
                           Data,
                           ChannelDataSize,
                           BytesReturned,
                           NULL);

  EMI_CHANNEL_V2* Channel = &amp;MetaData-&gt;Channels[0];
  for (int i = 0 ; i &lt; MetaData-&gt;ChannelCount &amp;&amp; status ; i++) {

      //
      // Get energy measurement for each energy counter.
      //

      AbsoluteEnergy = Measurement-&gt;ChannelData[i].AbsoluteEnergy;
      AbsoluteTime = Measurement-&gt;ChannelData[i].AbsoluteTime;
  }

</code></pre>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/emi/ns-emi-emi_metadata_v2">EMI_METADATA_V2</a><br />
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/emi/ns-emi-emi_measurement_data_v2">EMI_MEASUREMENT_DATA_V2</a><br />
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/powermeter/energy-meter-interface">Energy Metering Interface</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows/win32/api/emi/ni-emi-ioctl_emi_get_measurement">View the official Win32 API reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/sdk-api/blob/docs/sdk-api-src/content/emi/ni-emi-ioctl_emi_get_measurement.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
