<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="FwpsInjectionHandleCreate0 - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>FwpsInjectionHandleCreate0 - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            FwpsInjectionHandleCreate0 - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// fwpsk.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> FwpsInjectionHandleCreate0(
  [in, optional] <a href="address_family" title="typedef USHORT ADDRESS_FAMILY;">ADDRESS_FAMILY</a> addressFamily,
  [in]           <a href="uint32" title="typedef unsigned int UINT32;">UINT32</a>         flags,
  [out]          HANDLE         *injectionHandle
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nf-fwpsk-fwpsinjectionhandlecreate0">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/fwpsinjectionhandlecreate0.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-fwpsk-fwpsinjectionhandlecreate0)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="fwpsinjectionhandlecreate0-function">FwpsInjectionHandleCreate0 function</h1>

<h2 id="description">Description</h2>

<p>The
<strong>FwpsInjectionHandleCreate0</strong> function creates a handle that can be used by
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/packet-injection-functions">packet injection functions</a> to inject
packet or stream data into the TCP/IP network stack and by the
<a href="fwpsquerypacketinjectionstate0" title="FWPS_PACKET_INJECTION_STATE FwpsQueryPacketInjectionState0(&#10;  [in]            HANDLE                injectionHandle,&#10;  [in]            const NET_BUFFER_LIST *netBufferList,&#10;  [out, optional] HANDLE                *injectionContext&#10;);">FwpsQueryPacketInjectionState0</a> function to query the packet injection state.</p>

<p><strong>Note</strong> <strong>FwpsInjectionHandleCreate0</strong> is a specific version of <strong>FwpsInjectionHandleCreate</strong>. See <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/FWP/wfp-version-independent-names-and-targeting-specific-versions-of-windows">WFP Version-Independent Names and Targeting Specific Versions of Windows</a> for more information.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="addressfamily-in-optional"><code>addressFamily</code> [in, optional]</h3>

<p>The address family for which the injection handle is being created. This can be one of the
following address families:</p>

<h4 id="af_unspec">AF_UNSPEC</h4>

<p>The address family is unspecified.</p>

<h4 id="af_inet">AF_INET</h4>

<p>The IPv4 address family.</p>

<h4 id="af_inet6">AF_INET6</h4>

<p>The IPv6 address family.</p>

<p>For transport, stream, and forward injections, this parameter is optional and can be set to
AF_UNSPEC, which indicates an unspecified address family. This value is defined in
Ws2def.h.</p>

<h3 id="flags-in"><code>flags</code> [in]</h3>

<p>A flag value set by a callout driver to indicate the type of data to be injected. This flag can have
one or more of the following values:</p>

<h4 id="fwps_injection_type_forward">FWPS_INJECTION_TYPE_FORWARD</h4>

<p>Packet data will be injected by calling the
<a href="fwpsinjectforwardasync0" title="NTSTATUS FwpsInjectForwardAsync0(&#10;  [in]           HANDLE                injectionHandle,&#10;  [in, optional] HANDLE                injectionContext,&#10;  [in]           UINT32                flags,&#10;  [in]           ADDRESS_FAMILY        addressFamily,&#10;  [in]           COMPARTMENT_ID        compartmentId,&#10;  [in]           IF_INDEX              interfaceIndex,&#10;  [in, out]      NET_BUFFER_LIST       *netBufferList,&#10;  [in]           FWPS_INJECT_COMPLETE0 completionFn,&#10;  [in, optional] HANDLE                completionContext&#10;);">FwpsInjectForwardAsync0</a> function.</p>

<h4 id="fwps_injection_type_network">FWPS_INJECTION_TYPE_NETWORK</h4>

<p>Network data will be injected by calling either the
<a href="fwpsinjectnetworkreceiveasync0" title="NTSTATUS FwpsInjectNetworkReceiveAsync0(&#10;  [in]           HANDLE                injectionHandle,&#10;  [in, optional] HANDLE                injectionContext,&#10;  [in]           UINT32                flags,&#10;  [in]           COMPARTMENT_ID        compartmentId,&#10;  [in]           IF_INDEX              interfaceIndex,&#10;  [in]           IF_INDEX              subInterfaceIndex,&#10;  [in, out]      NET_BUFFER_LIST       *netBufferList,&#10;  [in]           FWPS_INJECT_COMPLETE0 completionFn,&#10;  [in, optional] HANDLE                completionContext&#10;);">FwpsInjectNetworkReceiveAsync0</a> function or the
<a href="fwpsinjectnetworksendasync0" title="NTSTATUS FwpsInjectNetworkSendAsync0(&#10;  [in]           HANDLE                injectionHandle,&#10;  [in, optional] HANDLE                injectionContext,&#10;  [in]           UINT32                flags,&#10;  [in]           COMPARTMENT_ID        compartmentId,&#10;  [in, out]      NET_BUFFER_LIST       *netBufferList,&#10;  [in]           FWPS_INJECT_COMPLETE0 completionFn,&#10;  [in, optional] HANDLE                completionContext&#10;);">FwpsInjectNetworkSendAsync0</a> function.</p>

<h4 id="fwps_injection_type_stream">FWPS_INJECTION_TYPE_STREAM</h4>

<p>Stream data will be injected by calling the
<a href="fwpsstreaminjectasync0" title="NTSTATUS FwpsStreamInjectAsync0(&#10;  [in]           HANDLE                injectionHandle,&#10;  [in, optional] HANDLE                injectionContext,&#10;  [in]           UINT32                flags,&#10;  [in]           UINT64                flowId,&#10;  [in]           UINT32                calloutId,&#10;  [in]           UINT16                layerId,&#10;  [in]           UINT32                streamFlags,&#10;  [in, out]      NET_BUFFER_LIST       *netBufferList,&#10;  [in]           SIZE_T                dataLength,&#10;  [in]           FWPS_INJECT_COMPLETE0 completionFn,&#10;  [in, optional] HANDLE                completionContext&#10;);">FwpsStreamInjectAsync0</a> function.</p>

<h4 id="fwps_injection_type_transport">FWPS_INJECTION_TYPE_TRANSPORT</h4>

<p>Transport data will be injected by calling either the
<a href="fwpsinjecttransportreceiveasync0" title="NTSTATUS FwpsInjectTransportReceiveAsync0(&#10;  [in]           HANDLE                injectionHandle,&#10;  [in, optional] HANDLE                injectionContext,&#10;                 PVOID                 reserved,&#10;  [in]           UINT32                flags,&#10;  [in]           ADDRESS_FAMILY        addressFamily,&#10;  [in]           COMPARTMENT_ID        compartmentId,&#10;  [in]           IF_INDEX              interfaceIndex,&#10;  [in]           IF_INDEX              subInterfaceIndex,&#10;  [in, out]      NET_BUFFER_LIST       *netBufferList,&#10;  [in]           FWPS_INJECT_COMPLETE0 completionFn,&#10;  [in, optional] HANDLE                completionContext&#10;);">FwpsInjectTransportReceiveAsync0</a> function or the
<a href="fwpsinjecttransportsendasync0" title="NTSTATUS FwpsInjectTransportSendAsync0(&#10;  [in]           HANDLE                      injectionHandle,&#10;  [in, optional] HANDLE                      injectionContext,&#10;  [in]           UINT64                      endpointHandle,&#10;  [in]           UINT32                      flags,&#10;  [in, optional] FWPS_TRANSPORT_SEND_PARAMS0 *sendArgs,&#10;  [in]           ADDRESS_FAMILY              addressFamily,&#10;  [in]           COMPARTMENT_ID              compartmentId,&#10;  [in, out]      NET_BUFFER_LIST             *netBufferList,&#10;  [in]           FWPS_INJECT_COMPLETE0       completionFn,&#10;  [in, optional] HANDLE                      completionContext&#10;);">FwpsInjectTransportSendAsync0</a> function.</p>

<p>To create an injection handle to be used by multiple injection functions, combine the
injection type bits with bitwise OR operations. If the flag value is set to zero, the resulting
injection handle can be used for transport, stream, and forward injections.</p>

<h3 id="injectionhandle-out"><code>injectionHandle</code> [out]</h3>

<p>A pointer to a variable that receives the handle.</p>

<h2 id="return-value">Return value</h2>

<p>The
<strong>FwpsInjectionHandleCreate0</strong> function returns one of the following <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> codes.</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></strong></td>
  <td>The injection handle was successfully created.</td>
</tr>
<tr>
  <td><strong>STATUS_FWP_TCPIP_NOT_READY</strong></td>
  <td>The TCP/IP network stack is not ready. A callout driver should call the FwpsInjectionHandleCreate0 function again at a later time to create an injection handle.</td>
</tr>
<tr>
  <td><strong>Other status codes</strong></td>
  <td>An error occurred.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>A callout driver calls the
<strong>FwpsInjectionHandleCreate0</strong> function to create a handle that can be used for injecting packet or
stream data into the TCP/IP network stack and to query the packet injection state. A callout driver
passes the created handle to the
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/packet-injection-functions">packet injection
functions</a> and
<a href="fwpsquerypacketinjectionstate0" title="FWPS_PACKET_INJECTION_STATE FwpsQueryPacketInjectionState0(&#10;  [in]            HANDLE                injectionHandle,&#10;  [in]            const NET_BUFFER_LIST *netBufferList,&#10;  [out, optional] HANDLE                *injectionContext&#10;);">FwpsQueryPacketInjectionState0</a>.</p>

<p>After a callout driver has finished using an injection handle, it must call the
<a href="fwpsinjectionhandledestroy0" title="NTSTATUS FwpsInjectionHandleDestroy0(&#10;  [in] HANDLE injectionHandle&#10;);">FwpsInjectionHandleDestroy0</a> function to destroy the handle. If pending injections have not yet
completed, this function will wait for their completion before returning.</p>

<p>When injections are being made to the network layer and both IPv4 and IPv6 address families are being
filtered, the callout driver must create two injection handles by calling the
<strong>FwpsInjectionHandleCreate0</strong> function twice: one call with
<em>addressFamily</em> set to AF_INET, and a second call with
<em>addressFamily</em> set to AF_INET6.</p>

<p>For the MAC layers ( *MAC_FRAME_NATIVE, *MAC_FRAME_ETHERNET, *VSWITCH_ETHERNET), you can use the same injection handle acquired with the FWPS_INJECTION_TYPE_L2 flag. The Injection type is tied closer to the injection functions than the layers.</p>

<p>For a code example, see <a rel="noopener" target="_blank" href="https://github.com/microsoft/Windows-driver-samples/blob/master/network/trans/WFPSampler/syslib/HelperFunctions_InjectionData.cpp">WFPSampler HelperFunctions_InjectionData.cpp</a>.</p>

<h2 id="see-also">See also</h2>

<p><a href="fwpsinjectionhandledestroy0" title="NTSTATUS FwpsInjectionHandleDestroy0(&#10;  [in] HANDLE injectionHandle&#10;);">FwpsInjectionHandleDestroy0</a></p>

<p><a href="fwpsquerypacketinjectionstate0" title="FWPS_PACKET_INJECTION_STATE FwpsQueryPacketInjectionState0(&#10;  [in]            HANDLE                injectionHandle,&#10;  [in]            const NET_BUFFER_LIST *netBufferList,&#10;  [out, optional] HANDLE                *injectionContext&#10;);">FwpsQueryPacketInjectionState0</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/packet-injection-functions">Packet Injection Functions</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nf-fwpsk-fwpsinjectionhandlecreate0">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/fwpsk/nf-fwpsk-fwpsinjectionhandlecreate0.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
