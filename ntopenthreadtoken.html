<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="NtOpenThreadToken - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>NtOpenThreadToken - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            NtOpenThreadToken - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">#ifndef _NTSEAPI_H

</span><span class="ntdoc-code-intro">/**
 * The NtOpenThreadToken routine opens the access token associated with a thread, and returns a handle that can be used to access that token.
 *
 * @param ThreadHandle Handle to the thread whose access token is to be opened. The handle must have <a href="thread_query_information" title="#define THREAD_QUERY_INFORMATION 0x0040">THREAD_QUERY_INFORMATION</a> access.
 * @param DesiredAccess ACCESS_MASK structure specifying the requested types of access to the access token.
 * @param OpenAsSelf Boolean value specifying whether the access check is to be made against the security context of the thread calling NtOpenThreadToken or against the security context of the process for the calling thread.
 * @param TokenHandle Pointer to a caller-allocated variable that receives a handle to the newly opened access token.
 * @return <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> Successful or errant status.
 * @sa https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntopenthreadtoken
 */
</span><span class="ntdoc-code-body">NTSYSCALLAPI
<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a>
NTAPI
NtOpenThreadToken(
    _In_ HANDLE ThreadHandle,
    _In_ ACCESS_MASK DesiredAccess,
    _In_ BOOLEAN OpenAsSelf,
    _Out_ PHANDLE TokenHandle
    );
</span><span class="ntdoc-code-footer">
#endif
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://github.com/winsiderss/systeminformer/blob/7d3941c464a201af155e4b9b0afb66e748a28ca4/phnt/include/ntseapi.h#L489">View code on GitHub</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">#ifndef _NTZWAPI_H

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">NTSYSCALLAPI
<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a>
NTAPI
ZwOpenThreadToken(
    _In_ HANDLE ThreadHandle,
    _In_ ACCESS_MASK DesiredAccess,
    _In_ BOOLEAN OpenAsSelf,
    _Out_ PHANDLE TokenHandle
    );
</span><span class="ntdoc-code-footer">
#endif
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://github.com/winsiderss/systeminformer/blob/7d3941c464a201af155e4b9b0afb66e748a28ca4/phnt/include/ntzwapi.h#L2768">View code on GitHub</a></span></code></pre></div>
</div>
<div class="ntdoc-description">
<p>Opens a handle to an impersonation token of a thread. This function is <a rel="noopener" target="_blank" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntopenthreadtoken">documented in Windows Driver Kit</a>.</p>

<h1 id="parameters">Parameters</h1>

<ul>
<li><code>ThreadHandle</code> - a handle to the thread or the <code><a href="ntcurrentthread" title="#define NtCurrentThread() ((HANDLE)(LONG_PTR)-2)">NtCurrentThread</a></code> pseudo-handle. The handle must grant <code><a href="thread_query_limited_information" title="#define THREAD_QUERY_LIMITED_INFORMATION 0x0800">THREAD_QUERY_LIMITED_INFORMATION</a></code> access.</li>
<li><code>DesiredAccess</code> - the requested access mask.</li>
<li><code>OpenAsSelf</code> - a boolean determining whether the system should perform the access check on the target token using the effective security context of the calling thread (<code>FALSE</code>) or ignore impersonation and use the security context of the calling process (<code>TRUE</code>).</li>
<li><code>TokenHandle</code> - a pointer to a variable that receives a handle to the token.</li>
</ul>

<h1 id="access-masks">Access masks</h1>

<table>
<thead>
<tr>
  <th>Access mask</th>
  <th>Use</th>
</tr>
</thead>
<tbody>
<tr>
  <td><code>TOKEN_ASSIGN_PRIMARY</code></td>
  <td>Allows creating processes with this token and assigning the token as primary via <code><a href="ntsetinformationprocess" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtSetInformationProcess(&#10;    _In_ HANDLE ProcessHandle,&#10;    _In_ PROCESSINFOCLASS ProcessInformationClass,&#10;    _In_reads_bytes_(ProcessInformationLength) PVOID ProcessInformation,&#10;    _In_ ULONG ProcessInformationLength&#10;    );">NtSetInformationProcess</a></code> with <code>ProcessAccessToken</code>.</td>
</tr>
<tr>
  <td><code>TOKEN_DUPLICATE</code></td>
  <td>Allows duplicating the token via <code><a href="ntduplicatetoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtDuplicateToken(&#10;    _In_ HANDLE ExistingTokenHandle,&#10;    _In_ ACCESS_MASK DesiredAccess,&#10;    _In_opt_ POBJECT_ATTRIBUTES ObjectAttributes,&#10;    _In_ BOOLEAN EffectiveOnly,&#10;    _In_ TOKEN_TYPE Type,&#10;    _Out_ PHANDLE NewTokenHandle&#10;    );">NtDuplicateToken</a></code>.</td>
</tr>
<tr>
  <td><code>TOKEN_IMPERSONATE</code></td>
  <td>Allows impersonating the token via <code><a href="ntsetinformationthread" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtSetInformationThread(&#10;    _In_ HANDLE ThreadHandle,&#10;    _In_ THREADINFOCLASS ThreadInformationClass,&#10;    _In_reads_bytes_(ThreadInformationLength) PVOID ThreadInformation,&#10;    _In_ ULONG ThreadInformationLength&#10;    );">NtSetInformationThread</a></code> with <code>ThreadImpersonationToken</code>.</td>
</tr>
<tr>
  <td><code>TOKEN_QUERY</code></td>
  <td>Allows querying most information classes via <code><a href="ntqueryinformationtoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtQueryInformationToken(&#10;    _In_ HANDLE TokenHandle,&#10;    _In_ TOKEN_INFORMATION_CLASS TokenInformationClass,&#10;    _Out_writes_bytes_to_opt_(TokenInformationLength, *ReturnLength) PVOID TokenInformation,&#10;    _In_ ULONG TokenInformationLength,&#10;    _Out_ PULONG ReturnLength&#10;    );">NtQueryInformationToken</a></code>.</td>
</tr>
<tr>
  <td><code>TOKEN_QUERY_SOURCE</code></td>
  <td>Allows querying <code><a href="tokensource" title="#define TokenSource 7 // q: TOKEN_SOURCE">TokenSource</a></code> via <code><a href="ntqueryinformationtoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtQueryInformationToken(&#10;    _In_ HANDLE TokenHandle,&#10;    _In_ TOKEN_INFORMATION_CLASS TokenInformationClass,&#10;    _Out_writes_bytes_to_opt_(TokenInformationLength, *ReturnLength) PVOID TokenInformation,&#10;    _In_ ULONG TokenInformationLength,&#10;    _Out_ PULONG ReturnLength&#10;    );">NtQueryInformationToken</a></code>.</td>
</tr>
<tr>
  <td><code>TOKEN_ADJUST_PRIVILEGES</code></td>
  <td>Allows adjusting token privileges via <code><a href="ntadjustprivilegestoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAdjustPrivilegesToken(&#10;    _In_ HANDLE TokenHandle,&#10;    _In_ BOOLEAN DisableAllPrivileges,&#10;    _In_opt_ PTOKEN_PRIVILEGES NewState,&#10;    _In_ ULONG BufferLength,&#10;    _Out_writes_bytes_to_opt_(BufferLength, *ReturnLength) PTOKEN_PRIVILEGES PreviousState,&#10;    _Out_opt_ PULONG ReturnLength&#10;    );">NtAdjustPrivilegesToken</a></code></td>
</tr>
<tr>
  <td><code>TOKEN_ADJUST_GROUPS</code></td>
  <td>Allows adjusting token privileges via <code><a href="ntadjustgroupstoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAdjustGroupsToken(&#10;    _In_ HANDLE TokenHandle,&#10;    _In_ BOOLEAN ResetToDefault,&#10;    _In_opt_ PTOKEN_GROUPS NewState,&#10;    _In_opt_ ULONG BufferLength,&#10;    _Out_writes_bytes_to_opt_(BufferLength, *ReturnLength) PTOKEN_GROUPS PreviousState,&#10;    _Out_opt_ PULONG ReturnLength&#10;    );">NtAdjustGroupsToken</a></code></td>
</tr>
<tr>
  <td><code>TOKEN_ADJUST_DEFAULT</code></td>
  <td>Allows setting most information classes via <code><a href="ntsetinformationtoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtSetInformationToken(&#10;    _In_ HANDLE TokenHandle,&#10;    _In_ TOKEN_INFORMATION_CLASS TokenInformationClass,&#10;    _In_reads_bytes_(TokenInformationLength) PVOID TokenInformation,&#10;    _In_ ULONG TokenInformationLength&#10;    );">NtSetInformationToken</a></code>.</td>
</tr>
<tr>
  <td><code>TOKEN_ADJUST_SESSIONID</code></td>
  <td>Allows setting <code><a href="tokensessionid" title="#define TokenSessionId 12 // q; s: ULONG (requires SeTcbPrivilege)">TokenSessionId</a></code> via <code><a href="ntsetinformationtoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtSetInformationToken(&#10;    _In_ HANDLE TokenHandle,&#10;    _In_ TOKEN_INFORMATION_CLASS TokenInformationClass,&#10;    _In_reads_bytes_(TokenInformationLength) PVOID TokenInformation,&#10;    _In_ ULONG TokenInformationLength&#10;    );">NtSetInformationToken</a></code>.</td>
</tr>
<tr>
  <td><code>TOKEN_ALL_ACCESS_P</code></td>
  <td>All of the above except for the <code>TOKEN_ADJUST_SESSIONID</code> right, plus standard rights.</td>
</tr>
<tr>
  <td><code>TOKEN_ALL_ACCESS</code></td>
  <td>All of the above plus standard rights.</td>
</tr>
</tbody>
</table>

<h1 id="notable-return-values">Notable return values</h1>

<ul>
<li><code>STATUS_NO_TOKEN</code> - the thread is not impersonating at the moment.</li>
<li><code>STATUS_CANT_OPEN_ANONYMOUS</code> - the caller attempted to open a token that has anonymous level of impersonation.</li>
</ul>

<h1 id="remarks">Remarks</h1>

<p>To avoid retaining unused resources, call <code><a href="ntclose" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtClose(&#10;    _In_ _Post_ptr_invalid_ HANDLE Handle&#10;    );">NtClose</a></code> to close the returned handle when it is no longer required.</p>

<p>Instead of opening the current thread token for query, consider using the <code><a href="ntcurrentthreadtoken" title="#define NtCurrentThreadToken() ((HANDLE)(LONG_PTR)-5) // NtOpenThreadToken(NtCurrentThread())">NtCurrentThreadToken</a></code> pseudo-handle on Windows 8 and above.</p>

<p>To specify handle attributes, use <code><a href="ntopenthreadtokenex" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtOpenThreadTokenEx(&#10;    _In_ HANDLE ThreadHandle,&#10;    _In_ ACCESS_MASK DesiredAccess,&#10;    _In_ BOOLEAN OpenAsSelf,&#10;    _In_ ULONG HandleAttributes,&#10;    _Out_ PHANDLE TokenHandle&#10;    );">NtOpenThreadTokenEx</a></code>.</p>

<p>To set a thread token, use <code><a href="ntsetinformationthread" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtSetInformationThread(&#10;    _In_ HANDLE ThreadHandle,&#10;    _In_ THREADINFOCLASS ThreadInformationClass,&#10;    _In_reads_bytes_(ThreadInformationLength) PVOID ThreadInformation,&#10;    _In_ ULONG ThreadInformationLength&#10;    );">NtSetInformationThread</a></code> with <code>ThreadImpersonationToken</code>. See <code><a href="threadinfoclass" title="typedef enum _THREADINFOCLASS&#10;{&#10;    ThreadBasicInformation, // q: THREAD_BASIC_INFORMATION&#10;    ThreadTimes, // q: KERNEL_USER_TIMES&#10;    ThreadPriority, // s: KPRIORITY (requires SeIncreaseBasePriorityPrivilege)&#10;    ThreadBasePriority, // s: KPRIORITY&#10;    ThreadAffinityMask, // s: KAFFINITY&#10;    ThreadImpersonationToken, // s: HANDLE&#10;    ThreadDescriptorTableEntry, // q: DESCRIPTOR_TABLE_ENTRY (or WOW64_DESCRIPTOR_TABLE_ENTRY)&#10;    ThreadEnableAlignmentFaultFixup, // s: BOOLEAN&#10;    ThreadEventPair, // Obsolete&#10;    ThreadQuerySetWin32StartAddress, // qs: PVOID (requires THREAD_Set_LIMITED_INFORMATION)&#10;    ThreadZeroTlsCell, // s: ULONG // TlsIndex // 10&#10;    ThreadPerformanceCount, // q: LARGE_INTEGER&#10;    ThreadAmILastThread, // q: ULONG&#10;    ThreadIdealProcessor, // s: ULONG&#10;    ThreadPriorityBoost, // qs: ULONG&#10;    ThreadSetTlsArrayAddress, // s: ULONG_PTR&#10;    ThreadIsIoPending, // q: ULONG&#10;    ThreadHideFromDebugger, // q: BOOLEAN; s: void&#10;...">THREADINFOCLASS</a></code> for more details.</p>

<h1 id="related-win32-api">Related Win32 API</h1>

<ul>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openthreadtoken"><code>OpenThreadToken</code></a></li>
</ul>

<h1 id="see-also">See also</h1>

<ul>
<li><code><a href="ntcurrentthreadtoken" title="#define NtCurrentThreadToken() ((HANDLE)(LONG_PTR)-5) // NtOpenThreadToken(NtCurrentThread())">NtCurrentThreadToken</a></code></li>
<li><code><a href="ntcurrentthreadeffectivetoken" title="#define NtCurrentThreadEffectiveToken() ((HANDLE)(LONG_PTR)-6) // NtOpenThreadToken(NtCurrentThread()) + NtOpenProcessToken(NtCurrentProcess())">NtCurrentThreadEffectiveToken</a></code></li>
<li><code><a href="ntopenthreadtokenex" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtOpenThreadTokenEx(&#10;    _In_ HANDLE ThreadHandle,&#10;    _In_ ACCESS_MASK DesiredAccess,&#10;    _In_ BOOLEAN OpenAsSelf,&#10;    _In_ ULONG HandleAttributes,&#10;    _Out_ PHANDLE TokenHandle&#10;    );">NtOpenThreadTokenEx</a></code></li>
<li><code><a href="ntopenprocesstoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtOpenProcessToken(&#10;    _In_ HANDLE ProcessHandle,&#10;    _In_ ACCESS_MASK DesiredAccess,&#10;    _Out_ PHANDLE TokenHandle&#10;    );">NtOpenProcessToken</a></code></li>
<li><code><a href="ntqueryinformationtoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtQueryInformationToken(&#10;    _In_ HANDLE TokenHandle,&#10;    _In_ TOKEN_INFORMATION_CLASS TokenInformationClass,&#10;    _Out_writes_bytes_to_opt_(TokenInformationLength, *ReturnLength) PVOID TokenInformation,&#10;    _In_ ULONG TokenInformationLength,&#10;    _Out_ PULONG ReturnLength&#10;    );">NtQueryInformationToken</a></code></li>
<li><code><a href="ntsetinformationtoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtSetInformationToken(&#10;    _In_ HANDLE TokenHandle,&#10;    _In_ TOKEN_INFORMATION_CLASS TokenInformationClass,&#10;    _In_reads_bytes_(TokenInformationLength) PVOID TokenInformation,&#10;    _In_ ULONG TokenInformationLength&#10;    );">NtSetInformationToken</a></code></li>
<li><code><a href="ntduplicatetoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtDuplicateToken(&#10;    _In_ HANDLE ExistingTokenHandle,&#10;    _In_ ACCESS_MASK DesiredAccess,&#10;    _In_opt_ POBJECT_ATTRIBUTES ObjectAttributes,&#10;    _In_ BOOLEAN EffectiveOnly,&#10;    _In_ TOKEN_TYPE Type,&#10;    _Out_ PHANDLE NewTokenHandle&#10;    );">NtDuplicateToken</a></code></li>
<li><code><a href="ntopenthread" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtOpenThread(&#10;    _Out_ PHANDLE ThreadHandle,&#10;    _In_ ACCESS_MASK DesiredAccess,&#10;    _In_ PCOBJECT_ATTRIBUTES ObjectAttributes,&#10;    _In_opt_ PCLIENT_ID ClientId&#10;    );">NtOpenThread</a></code></li>
</ul>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ntopenthreadtoken.md">Edit description on GitHub</a>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
