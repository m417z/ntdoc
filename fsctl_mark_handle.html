<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="FSCTL_MARK_HANDLE - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>FSCTL_MARK_HANDLE - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
        <link rel="stylesheet" href="modules/highlight.js/styles/github.ntdoc.min.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/highlight.js/styles/github-dark-dimmed.ntdoc.min.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            FSCTL_MARK_HANDLE - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header language-cpp">// ntifs.h

</span><span class="ntdoc-code-intro language-cpp"></span><span class="ntdoc-code-body language-cpp">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x0009, 0x03f, METHOD_BUFFERED, FILE_ANY_ACCESS)
#define FSCTL_MARK_HANDLE 0x000900FC</span><span class="ntdoc-code-footer language-cpp"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ni-ntifs-fsctl_mark_handle">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header language-cpp">// winioctl.h

</span><span class="ntdoc-code-intro language-cpp"></span><span class="ntdoc-code-body language-cpp">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x0009, 0x03f, METHOD_BUFFERED, FILE_ANY_ACCESS)
#define FSCTL_MARK_HANDLE 0x000900FC</span><span class="ntdoc-code-footer language-cpp"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows/win32/api/winioctl/ni-winioctl-fsctl_mark_handle">View the official Win32 API reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/fsctl_mark_handle.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ni-ntifs-fsctl_mark_handle)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2>Description</h2>
<p>The <strong>FSCTL_MARK_HANDLE</strong> control code marks a specified file or directory and its change journal record with information about changes to that file or directory.</p>
<h2>Parameters</h2>
<h3>Major code</h3>
<p>FSCTL_MARK_HANDLE</p>
<h3>Input buffer</h3>
<p>Pointer to a <strong><a href="mark_handle_info" title="typedef struct _MARK_HANDLE_INFO {&#10;  union {&#10;    ULONG UsnSourceInfo;&#10;    ULONG CopyNumber;&#10;  } DUMMYUNIONNAME;&#10;  ULONG  UsnSourceInfo;&#10;  HANDLE VolumeHandle;&#10;  ULONG  HandleInfo;&#10;} MARK_HANDLE_INFO, *PMARK_HANDLE_INFO;">MARK_HANDLE_INFO</a></strong> structure containing the information to use to mark a specified file or directory, and its update sequence number (USN) change journal record with data about changes.</p>
<h3>Input buffer length</h3>
<p>Size of the <strong><a href="mark_handle_info" title="typedef struct _MARK_HANDLE_INFO {&#10;  union {&#10;    ULONG UsnSourceInfo;&#10;    ULONG CopyNumber;&#10;  } DUMMYUNIONNAME;&#10;  ULONG  UsnSourceInfo;&#10;  HANDLE VolumeHandle;&#10;  ULONG  HandleInfo;&#10;} MARK_HANDLE_INFO, *PMARK_HANDLE_INFO;">MARK_HANDLE_INFO</a></strong> structure that <strong>InputBuffer</strong> points to, in bytes.</p>
<h3>Output buffer</h3>
<p>Set to NULL.</p>
<h3>Output buffer length</h3>
<p>n/a (ignored)</p>
<h3>Input/output buffer</h3>
<p>n/a</p>
<h3>Input/output buffer length</h3>
<p>n/a</p>
<h3>Status block</h3>
<p>Reserved for system use.</p>
<h2>Remarks</h2>
<p>To perform this operation, call <strong><a href="fltfscontrolfile" title="NTSTATUS FLTAPI FltFsControlFile(&#10;  [in]            PFLT_INSTANCE Instance,&#10;  [in]            PFILE_OBJECT  FileObject,&#10;  [in]            ULONG         FsControlCode,&#10;  [in, optional]  PVOID         InputBuffer,&#10;  [in]            ULONG         InputBufferLength,&#10;  [out, optional] PVOID         OutputBuffer,&#10;  [in]            ULONG         OutputBufferLength,&#10;  [out, optional] PULONG        LengthReturned&#10;);">FltFsControlFile</a></strong> or <strong><a href="ntfscontrolfile" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtFsControlFile(&#10;    _In_ HANDLE FileHandle,&#10;    _In_opt_ HANDLE Event,&#10;    _In_opt_ PIO_APC_ROUTINE ApcRoutine,&#10;    _In_opt_ PVOID ApcContext,&#10;    _Out_ PIO_STATUS_BLOCK IoStatusBlock,&#10;    _In_ ULONG FsControlCode,&#10;    _In_reads_bytes_opt_(InputBufferLength) PVOID InputBuffer,&#10;    _In_ ULONG InputBufferLength,&#10;    _Out_writes_bytes_opt_(OutputBufferLength) PVOID OutputBuffer,&#10;    _In_ ULONG OutputBufferLength&#10;    );">ZwFsControlFile</a></strong> with the following parameters.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Instance</strong></td>
<td>[in] For <strong><a href="fltfscontrolfile" title="NTSTATUS FLTAPI FltFsControlFile(&#10;  [in]            PFLT_INSTANCE Instance,&#10;  [in]            PFILE_OBJECT  FileObject,&#10;  [in]            ULONG         FsControlCode,&#10;  [in, optional]  PVOID         InputBuffer,&#10;  [in]            ULONG         InputBufferLength,&#10;  [out, optional] PVOID         OutputBuffer,&#10;  [in]            ULONG         OutputBufferLength,&#10;  [out, optional] PULONG        LengthReturned&#10;);">FltFsControlFile</a></strong> only. An opaque instance pointer for the caller. This parameter is required and cannot be NULL.</td>
</tr>
<tr>
<td><strong>FileObject</strong></td>
<td>[in] For <strong><a href="fltfscontrolfile" title="NTSTATUS FLTAPI FltFsControlFile(&#10;  [in]            PFLT_INSTANCE Instance,&#10;  [in]            PFILE_OBJECT  FileObject,&#10;  [in]            ULONG         FsControlCode,&#10;  [in, optional]  PVOID         InputBuffer,&#10;  [in]            ULONG         InputBufferLength,&#10;  [out, optional] PVOID         OutputBuffer,&#10;  [in]            ULONG         OutputBufferLength,&#10;  [out, optional] PULONG        LengthReturned&#10;);">FltFsControlFile</a></strong> only. A file object pointer for the file or directory that is the target of this request. This parameter is required and cannot be NULL.</td>
</tr>
<tr>
<td><strong>FileHandle</strong></td>
<td>[in] For <strong><a href="ntfscontrolfile" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtFsControlFile(&#10;    _In_ HANDLE FileHandle,&#10;    _In_opt_ HANDLE Event,&#10;    _In_opt_ PIO_APC_ROUTINE ApcRoutine,&#10;    _In_opt_ PVOID ApcContext,&#10;    _Out_ PIO_STATUS_BLOCK IoStatusBlock,&#10;    _In_ ULONG FsControlCode,&#10;    _In_reads_bytes_opt_(InputBufferLength) PVOID InputBuffer,&#10;    _In_ ULONG InputBufferLength,&#10;    _Out_writes_bytes_opt_(OutputBufferLength) PVOID OutputBuffer,&#10;    _In_ ULONG OutputBufferLength&#10;    );">ZwFsControlFile</a></strong> only. File handle of the file or directory that is the target of this request. This parameter is required and cannot be NULL.</td>
</tr>
<tr>
<td><strong>FsControlCode</strong></td>
<td>[in] Set to <strong>FSCTL_MARK_HANDLE</strong>.</td>
</tr>
<tr>
<td><strong>InputBuffer</strong></td>
<td>[in] Pointer to a <strong><a href="mark_handle_info" title="typedef struct _MARK_HANDLE_INFO {&#10;  union {&#10;    ULONG UsnSourceInfo;&#10;    ULONG CopyNumber;&#10;  } DUMMYUNIONNAME;&#10;  ULONG  UsnSourceInfo;&#10;  HANDLE VolumeHandle;&#10;  ULONG  HandleInfo;&#10;} MARK_HANDLE_INFO, *PMARK_HANDLE_INFO;">MARK_HANDLE_INFO</a></strong> structure containing the information to use to mark a specified file or directory, and its update sequence number (USN) change journal record with data about changes.</td>
</tr>
<tr>
<td><strong>InputBufferLength</strong></td>
<td>[in] Size of the buffer that <strong>InputBuffer</strong> points to, in bytes.</td>
</tr>
<tr>
<td><strong>OutputBuffer</strong></td>
<td>[out] Set to NULL for this FSCTL.</td>
</tr>
<tr>
<td><strong>OutputBufferLength</strong></td>
<td>[in] Ignored when <strong>OutputBuffer</strong> is NULL.</td>
</tr>
<tr>
<td><strong>LengthReturned</strong></td>
<td>[out] Set to NULL.</td>
</tr>
</tbody>
</table>
<h2>See also</h2>
<p><strong><a href="fltfscontrolfile" title="NTSTATUS FLTAPI FltFsControlFile(&#10;  [in]            PFLT_INSTANCE Instance,&#10;  [in]            PFILE_OBJECT  FileObject,&#10;  [in]            ULONG         FsControlCode,&#10;  [in, optional]  PVOID         InputBuffer,&#10;  [in]            ULONG         InputBufferLength,&#10;  [out, optional] PVOID         OutputBuffer,&#10;  [in]            ULONG         OutputBufferLength,&#10;  [out, optional] PULONG        LengthReturned&#10;);">FltFsControlFile</a></strong></p>
<p><strong><a href="ntfscontrolfile" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtFsControlFile(&#10;    _In_ HANDLE FileHandle,&#10;    _In_opt_ HANDLE Event,&#10;    _In_opt_ PIO_APC_ROUTINE ApcRoutine,&#10;    _In_opt_ PVOID ApcContext,&#10;    _Out_ PIO_STATUS_BLOCK IoStatusBlock,&#10;    _In_ ULONG FsControlCode,&#10;    _In_reads_bytes_opt_(InputBufferLength) PVOID InputBuffer,&#10;    _In_ ULONG InputBufferLength,&#10;    _Out_writes_bytes_opt_(OutputBufferLength) PVOID OutputBuffer,&#10;    _In_ ULONG OutputBufferLength&#10;    );">ZwFsControlFile</a></strong></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ni-ntifs-fsctl_mark_handle">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/ni-ntifs-fsctl_mark_handle.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Win32 API reference (ni-winioctl-fsctl_mark_handle)</h1>
</div>
<div class="ntdoc-description">
<h1>FSCTL_MARK_HANDLE IOCTL</h1>
<h2>Description</h2>
<p>Marks a specified file or directory and its change journal record with information about changes to that file or directory.</p>
<p>To perform this operation, call the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol"><strong>DeviceIoControl</strong></a> function using the following parameters.</p>
<pre><code class="language-cpp">BOOL DeviceIoControl(
  (HANDLE) hDevice,             // handle to file or directory
  FSCTL_MARK_HANDLE,            // dwIoControlCode
  (LPVOID)lpInBuffer,           // input buffer
  (<a href="dword" title="typedef unsigned long DWORD;">DWORD</a>)nInBufferSize,         // size of input buffer
  NULL,                         // lpOutBuffer
  0,                            // nOutBufferSize
  (LPDWORD) lpBytesReturned,    // number of bytes returned
  (LPOVERLAPPED) lpOverlapped   // OVERLAPPED structure
);
</code></pre>
<h2>Parameters</h2>
<h3>Input buffer</h3>
<h3>Input buffer length</h3>
<h3>Output buffer</h3>
<h3>Output buffer length</h3>
<h3>Input/output buffer</h3>
<h3>Input/output buffer length</h3>
<h3>Status block</h3>
<p>Irp-&gt;IoStatus.Status is set to <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the request is successful.</p>
<p>Otherwise, Status to the appropriate error condition as a <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> code.</p>
<p>For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/ntstatus-values">NTSTATUS Values</a>.</p>
<h2>Remarks</h2>
<p>For the implications of overlapped I/O on this operation, see the Remarks section of the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">DeviceIoControl</a> topic.</p>
<p><strong>FSCTL_MARK_HANDLE</strong> is the only change journal operation that operates on an individual file or directory. It does not affect anything the user can do with the item. Instead, it adds information to the file or directory, either providing information on how the operating system changed the item or adding a private data stream to the item.</p>
<p>If there are any changes to the file or directory, then the information added with <strong>FSCTL_MARK_HANDLE</strong> is also copied into the USN record created for the file or directory. Note that these two operations can occur independently of each otherâ€”for example, it is not necessary for a USN record to exist to be able to mark a file as unable to be defragmented and it is not necessary to mark a file or directory to update the contents of the corresponding USN record. For details on the information with which <strong>FSCTL_MARK_HANDLE</strong> can mark an item (see <a href="mark_handle_info" title="typedef struct _MARK_HANDLE_INFO {&#10;  union {&#10;    ULONG UsnSourceInfo;&#10;    ULONG CopyNumber;&#10;  } DUMMYUNIONNAME;&#10;  ULONG  UsnSourceInfo;&#10;  HANDLE VolumeHandle;&#10;  ULONG  HandleInfo;&#10;} MARK_HANDLE_INFO, *PMARK_HANDLE_INFO;">MARK_HANDLE_INFO</a> for more information).</p>
<p>It is not an error to use <strong>FSCTL_MARK_HANDLE</strong> while the volume's change journal is being deleted or is inactive. The appropriate information is applied to the file or directory regardless of the state of the change journal, as long as the change journal exists.</p>
<p>Note that the time stamps may not be updated correctly for a remote file. To ensure consistent results, use unbuffered I/O.</p>
<p>The volume must be NTFS.</p>
<p>In Windows 8 and Windows Server 2012, this code is supported by the following technologies.</p>
<table>
<thead>
<tr>
<th>Technology</th>
<th>Supported</th>
</tr>
</thead>
<tbody>
<tr>
<td>Server Message Block (SMB) 3.0 protocol</td>
<td>No</td>
</tr>
<tr>
<td>SMB 3.0 Transparent Failover (TFO)</td>
<td>No</td>
</tr>
<tr>
<td>SMB 3.0 with Scale-out File Shares (SO)</td>
<td>No</td>
</tr>
<tr>
<td>Cluster Shared Volume File System (CsvFS)</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>CsvFs always issues <strong>USN_SOURCE_REPLICATION_MANAGEMENT</strong> and <strong>MARK_HANDLE_PROTECT_CLUSTERS</strong> for the files eligible for direct IO.</p>
<h2>See also</h2>
<ul>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/FileIO/change-journals">Change Journals</a></li>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fileapi/nf-fileapi-createfilea">CreateFile</a></li>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">DeviceIoControl</a></li>
<li><a href="mark_handle_info" title="typedef struct _MARK_HANDLE_INFO {&#10;  union {&#10;    ULONG UsnSourceInfo;&#10;    ULONG CopyNumber;&#10;  } DUMMYUNIONNAME;&#10;  ULONG  UsnSourceInfo;&#10;  HANDLE VolumeHandle;&#10;  ULONG  HandleInfo;&#10;} MARK_HANDLE_INFO, *PMARK_HANDLE_INFO;">MARK_HANDLE_INFO</a></li>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/minwinbase/ns-minwinbase-overlapped">OVERLAPPED</a></li>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/FileIO/volume-management-control-codes">Volume Management Control Codes</a></li>
</ul>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows/win32/api/winioctl/ni-winioctl-fsctl_mark_handle">View the official Win32 API reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/sdk-api/blob/docs/sdk-api-src/content/winioctl/ni-winioctl-fsctl_mark_handle.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script src="modules/highlight.js/highlight.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
