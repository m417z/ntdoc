<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="PFND3DDDI_UNLOCKCB - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>PFND3DDDI_UNLOCKCB - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            PFND3DDDI_UNLOCKCB - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// d3dumddi.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">PFND3DDDI_UNLOCKCB Pfnd3dddiUnlockcb;

HRESULT Pfnd3dddiUnlockcb(
  HANDLE hDevice,
  const <a href="d3dddicb_unlock" title="typedef struct _D3DDDICB_UNLOCK {&#10;  [in] UINT                NumAllocations;&#10;  [in] const D3DKMT_HANDLE *phAllocations;&#10;} D3DDDICB_UNLOCK;">D3DDDICB_UNLOCK</a> *unnamedParam2
)
{...}</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dumddi/nc-d3dumddi-pfnd3dddi_unlockcb">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/pfnd3dddi_unlockcb.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nc-d3dumddi-pfnd3dddi_unlockcb)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="pfnd3dddi_unlockcb-callback-function">PFND3DDDI_UNLOCKCB callback function</h1>

<h2 id="description">Description</h2>

<p>The <strong>pfnUnlockCb</strong> function unlocks an allocation that was locked by a call to the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dumddi/nc-d3dumddi-pfnd3dddi_lockcb">pfnLockCb</a> function.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="hdevice"><code>hDevice</code></h3>

<p>A handle to the display device (graphics context).</p>

<h3 id="unnamedparam2"><code>unnamedParam2</code></h3>

<p><em>pData</em> [in]</p>

<p>A pointer to a <a href="d3dddicb_unlock" title="typedef struct _D3DDDICB_UNLOCK {&#10;  [in] UINT                NumAllocations;&#10;  [in] const D3DKMT_HANDLE *phAllocations;&#10;} D3DDDICB_UNLOCK;">D3DDDICB_UNLOCK</a> structure that describes the allocation to unlock.</p>

<h2 id="return-value">Return value</h2>

<p><strong>pfnUnlockCb</strong> returns one of the following values:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td>S_OK</td>
  <td>The allocation was successfully unlocked.</td>
</tr>
<tr>
  <td>E_OUTOFMEMORY</td>
  <td>pfnUnlockCb could not complete because of insufficient memory. (This error occurs when the system is in an extreme low memory situation and there is not sufficient space to allocate the array of pages.)</td>
</tr>
<tr>
  <td>E_INVALIDARG</td>
  <td>Parameters were validated and determined to be incorrect.</td>
</tr>
</tbody>
</table>

<p>This function might also return other HRESULT values.</p>

<h2 id="remarks">Remarks</h2>

<p>The user-mode display driver must call the <strong>pfnUnlockCb</strong> function to unlock an allocation that was previously locked in a call to the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dumddi/nc-d3dumddi-pfnd3dddi_lockcb">pfnLockCb</a> function. If the driver does not call <strong>pfnUnlockCb</strong>, coordination between the Microsoft Direct3D runtime, the user-mode display driver, and the display miniport driver is lost.</p>

<p>The user-mode display driver typically calls <strong>pfnUnlockCb</strong> in response to a call to its <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dumddi/nc-d3dumddi-pfnd3dddi_unlock">Unlock</a> or <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3d10umddi/nc-d3d10umddi-pfnd3d10ddi_resourceunmap">ResourceUnmap</a> function (or other variations of <em>ResourceUnmap</em> such as <em>DynamicIABufferUnmap</em>) to unlock a resource or a surface within the resource. Before returning from the <em>Unlock</em> or <em>ResourceUnmap</em> call, the user-mode display driver must first map the resource or surface to the appropriate allocation and then call <strong>pfnUnlockCb</strong> to unlock the allocation.</p>

<p>The user-mode display driver can also call <strong>pfnUnlockCb</strong> in response to a call to its <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dumddi/nc-d3dumddi-pfnd3dddi_destroydevice">DestroyDevice</a> or <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3d10umddi/nc-d3d10umddi-pfnd3d10ddi_destroydevice">DestroyDevice(D3D10)</a> function to free all of the resources that it allocated for the device. In the lifetime of a device, every call to <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dumddi/nc-d3dumddi-pfnd3dddi_lockcb">pfnLockCb</a> to lock an allocation must be paired with a call to the <strong>pfnUnlockCb</strong> function to unlock the allocation.</p>

<p>The user-mode display driver can unlock multiple allocations in one call to <strong>pfnUnlockCb</strong> by setting the <strong>NumAllocations</strong> member of the <a href="d3dddicb_unlock" title="typedef struct _D3DDDICB_UNLOCK {&#10;  [in] UINT                NumAllocations;&#10;  [in] const D3DKMT_HANDLE *phAllocations;&#10;} D3DDDICB_UNLOCK;">D3DDDICB_UNLOCK</a> structure to the number of allocations in the array that is specified by the <strong>phAllocations</strong> member of <a href="d3dddicb_unlock" title="typedef struct _D3DDDICB_UNLOCK {&#10;  [in] UINT                NumAllocations;&#10;  [in] const D3DKMT_HANDLE *phAllocations;&#10;} D3DDDICB_UNLOCK;">D3DDDICB_UNLOCK</a>.</p>

<p>The user-mode display driver should call <strong>pfnUnlockCb</strong> to unlock all of the allocations that are referred to in the command stream before calling the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dumddi/nc-d3dumddi-pfnd3dddi_rendercb">pfnRenderCb</a> function. The driver could have allocations locked to support--for example, the <strong>NoOverwrite</strong> bit-field flag. If the driver does not unlock all of these allocations, the video memory manager might be required to place these allocations in AGP memory.</p>

<p>The user-mode display driver should not call <strong>pfnUnlockCb</strong> to unlock an allocation that an application could be using. The driver is notified that the application is no longer reading from or writing to the allocation when the driver receives a call to its <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dumddi/nc-d3dumddi-pfnd3dddi_unlock">Unlock</a> or <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3d10umddi/nc-d3d10umddi-pfnd3d10ddi_resourceunmap">ResourceUnmap</a> function on the corresponding resource.</p>

<h4 id="examples">Examples</h4>

<p>The following code example shows how to unlock an allocation.</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="n">HRESULT</span><span class="w"> </span><span class="nf">CD3DContext::SyncEnginesUsingLock</span><span class="p">(</span><span class="n">VOID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">HRESULT</span><span class="w"> </span><span class="n">hr</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="d3dddicb_lock" title="typedef struct _D3DDDICB_LOCK {&#10;  [in/out] D3DKMT_HANDLE          hAllocation;&#10;  [in]     UINT                   PrivateDriverData;&#10;  [in]     UINT                   NumPages;&#10;  [in]     const UINT             *pPages;&#10;  [out]    VOID                   *pData;&#10;  [in]     D3DDDICB_LOCKFLAGS     Flags;&#10;           D3DGPU_VIRTUAL_ADDRESS GpuVirtualAddress;&#10;} D3DDDICB_LOCK;">D3DDDICB_LOCK</a></span><span class="w">   </span><span class="n">lockCB</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="d3dddicb_unlock" title="typedef struct _D3DDDICB_UNLOCK {&#10;  [in] UINT                NumAllocations;&#10;  [in] const D3DKMT_HANDLE *phAllocations;&#10;} D3DDDICB_UNLOCK;">D3DDDICB_UNLOCK</a></span><span class="w"> </span><span class="n">Unlock</span><span class="p">;</span>

<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lockCB</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n"><a href="d3dddicb_lock" title="typedef struct _D3DDDICB_LOCK {&#10;  [in/out] D3DKMT_HANDLE          hAllocation;&#10;  [in]     UINT                   PrivateDriverData;&#10;  [in]     UINT                   NumPages;&#10;  [in]     const UINT             *pPages;&#10;  [out]    VOID                   *pData;&#10;  [in]     D3DDDICB_LOCKFLAGS     Flags;&#10;           D3DGPU_VIRTUAL_ADDRESS GpuVirtualAddress;&#10;} D3DDDICB_LOCK;">D3DDDICB_LOCK</a></span><span class="p">));</span>
<span class="w">    </span><span class="n">lockCB</span><span class="p">.</span><span class="n">hAllocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_HandleUsedInLastSubmit</span><span class="p">;</span>
<span class="w">    </span><span class="n">lockCB</span><span class="p">.</span><span class="n">PrivateDriverData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_d3dCallbacks</span><span class="p">.</span><span class="n">pfnLockCb</span><span class="p">(</span><span class="n">m_hD3D</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lockCB</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">DBG_BREAK</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">hr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Unlock</span><span class="p">.</span><span class="n">NumAllocations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">Unlock</span><span class="p">.</span><span class="n">phAllocations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_HandleUsedInLastSubmit</span><span class="p">;</span>
<span class="w">    </span><span class="n">m_d3dCallbacks</span><span class="p">.</span><span class="n">pfnUnlockCb</span><span class="p">(</span><span class="n">m_hD3D</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Unlock</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">hr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<h2 id="see-also">See also</h2>

<p><a href="d3dddicb_unlock" title="typedef struct _D3DDDICB_UNLOCK {&#10;  [in] UINT                NumAllocations;&#10;  [in] const D3DKMT_HANDLE *phAllocations;&#10;} D3DDDICB_UNLOCK;">D3DDDICB_UNLOCK</a></p>

<p><a href="d3dddi_devicecallbacks" title="typedef struct _D3DDDI_DEVICECALLBACKS {&#10;  PFND3DDDI_ALLOCATECB                            pfnAllocateCb;&#10;  PFND3DDDI_DEALLOCATECB                          pfnDeallocateCb;&#10;  PFND3DDDI_SETPRIORITYCB                         pfnSetPriorityCb;&#10;  PFND3DDDI_QUERYRESIDENCYCB                      pfnQueryResidencyCb;&#10;  PFND3DDDI_SETDISPLAYMODECB                      pfnSetDisplayModeCb;&#10;  PFND3DDDI_PRESENTCB                             pfnPresentCb;&#10;  PFND3DDDI_RENDERCB                              pfnRenderCb;&#10;  PFND3DDDI_LOCKCB                                pfnLockCb;&#10;  PFND3DDDI_UNLOCKCB                              pfnUnlockCb;&#10;  PFND3DDDI_ESCAPECB                              pfnEscapeCb;&#10;  PFND3DDDI_CREATEOVERLAYCB                       pfnCreateOverlayCb;&#10;  PFND3DDDI_UPDATEOVERLAYCB                       pfnUpdateOverlayCb;&#10;  PFND3DDDI_FLIPOVERLAYCB                         pfnFlipOverlayCb;&#10;  PFND3DDDI_DESTROYOVERLAYCB                      pfnDestroyOverlayCb;&#10;  PFND3DDDI_CREATECONTEXTCB                       pfnCreateContextCb;&#10;  PFND3DDDI_DESTROYCONTEXTCB                      pfnDestroyContextCb;&#10;  PFND3DDDI_CREATESYNCHRONIZATIONOBJECTCB         pfnCreateSynchronizationObjectCb;&#10;  PFND3DDDI_DESTROYSYNCHRONIZATIONOBJECTCB        pfnDestroySynchronizationObjectCb;&#10;  PFND3DDDI_WAITFORSYNCHRONIZATIONOBJECTCB        pfnWaitForSynchronizationObjectCb;&#10;...">D3DDDI_DEVICECALLBACKS</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dumddi/nc-d3dumddi-pfnd3dddi_destroydevice">DestroyDevice</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3d10umddi/nc-d3d10umddi-pfnd3d10ddi_destroydevice">DestroyDevice(D3D10)</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3d10umddi/nc-d3d10umddi-pfnd3d10ddi_resourceunmap">ResourceUnmap</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dumddi/nc-d3dumddi-pfnd3dddi_unlock">Unlock</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dumddi/nc-d3dumddi-pfnd3dddi_lockcb">pfnLockCb</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dumddi/nc-d3dumddi-pfnd3dddi_rendercb">pfnRenderCb</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dumddi/nc-d3dumddi-pfnd3dddi_unlockcb">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/d3dumddi/nc-d3dumddi-pfnd3dddi_unlockcb.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
