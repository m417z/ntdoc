<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="NtAdjustPrivilegesToken - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>NtAdjustPrivilegesToken - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            NtAdjustPrivilegesToken - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">#ifndef _NTSEAPI_H

</span><span class="ntdoc-code-intro">/**
 * The NtAdjustPrivilegesToken routine enables or disables privileges in the specified access token.
 *
 * @param TokenHandle Handle to the token that contains the privileges to be modified. The handle must have TOKEN_ADJUST_PRIVILEGES access.
 * @param DisableAllPrivileges Specifies whether the function disables all of the token&#x27;s privileges. If this value is TRUE, the function disables all privileges and ignores the NewState parameter.
 * If it is FALSE, the function modifies privileges based on the information pointed to by the NewState parameter.
 * @param NewState A pointer to a TOKEN_PRIVILEGES structure that specifies an array of privileges and their attributes. If DisableAllPrivileges is TRUE, the function ignores this parameter.
 * @param BufferLength Specifies the size, in bytes, of the buffer pointed to by the PreviousState parameter. This parameter can be zero if the PreviousState parameter is NULL.
 * @param PreviousState A pointer to a buffer that the function fills with a TOKEN_PRIVILEGES structure that contains the previous state of any privileges that the function modifies.
 * @param ReturnLength A pointer to a variable that receives the required size, in bytes, of the buffer pointed to by the PreviousState parameter. This parameter can be NULL if PreviousState is NULL.
 * @return <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> Successful or errant status.
 * @sa https://learn.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-adjusttokenprivileges
 */
</span><span class="ntdoc-code-body">NTSYSCALLAPI
<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a>
NTAPI
NtAdjustPrivilegesToken(
    _In_ HANDLE TokenHandle,
    _In_ BOOLEAN DisableAllPrivileges,
    _In_opt_ PTOKEN_PRIVILEGES NewState,
    _In_ <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> BufferLength,
    _Out_writes_bytes_to_opt_(BufferLength, *ReturnLength) PTOKEN_PRIVILEGES PreviousState,
    _Out_opt_ PULONG ReturnLength
    );
</span><span class="ntdoc-code-footer">
#endif
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://github.com/winsiderss/systeminformer/blob/7d3941c464a201af155e4b9b0afb66e748a28ca4/phnt/include/ntseapi.h#L601">View code on GitHub</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">#ifndef _NTZWAPI_H

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">NTSYSCALLAPI
<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a>
NTAPI
ZwAdjustPrivilegesToken(
    _In_ HANDLE TokenHandle,
    _In_ BOOLEAN DisableAllPrivileges,
    _In_opt_ PTOKEN_PRIVILEGES NewState,
    _In_ <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> BufferLength,
    _Out_writes_bytes_to_opt_(BufferLength, *ReturnLength) PTOKEN_PRIVILEGES PreviousState,
    _Out_opt_ PULONG ReturnLength
    );
</span><span class="ntdoc-code-footer">
#endif
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://github.com/winsiderss/systeminformer/blob/7d3941c464a201af155e4b9b0afb66e748a28ca4/phnt/include/ntzwapi.h#L223">View code on GitHub</a></span></code></pre></div>
</div>
<div class="ntdoc-description">
<p>Enables, disables, or removes privileges from the token.</p>

<h1 id="parameters">Parameters</h1>

<ul>
<li><code>TokenHandle</code> - a handle to the token. The handle must grant <code>TOKEN_ADJUST_PRIVILEGES</code> access. Additionally, the handle must grant <code>TOKEN_QUERY</code> when the caller provides the <code>PreviousState</code> buffer.</li>
<li><code>DisableAllPrivileges</code> - a boolean indicating if the function should disable all privileges present in the token.</li>
<li><code>NewState</code> - an optional pointer to a collection of privilege LUIDs with their desired states, such as <code>SE_PRIVILEGE_DISABLED</code> (<code>0</code>), <code>SE_PRIVILEGE_ENABLED</code>, or <code>SE_PRIVILEGE_REMOVED</code>.</li>
<li><code>BufferLength</code> - the size of the <code>PreviousState</code> buffer in bytes.</li>
<li><code>PreviousState</code> - an optional pointer to a user-allocated buffer that receives the state of token privileges prior to adjustment.</li>
<li><code>ReturnLength</code> - an optional pointer to a variable that receives the number of bytes written to the <code>PreviousState</code> buffer when the function succeeds or the number of bytes requires when the buffer is too small.</li>
</ul>

<h1 id="notable-return-values">Notable return values</h1>

<ul>
<li><code>STATUS_NOT_ALL_ASSIGNED</code> - this successful status indicates that not all of the requested privileges were adjusted, such as when they are not present or cannot be enabled.</li>
<li><code>STATUS_BUFFER_TOO_SMALL</code> - the previous state data does not fit into the provided buffer.</li>
</ul>

<h1 id="remarks">Remarks</h1>

<p>Disabled privileges are not taken into account during access checks. Some privileges cannot be enabled when token integrity level is too low. Removing privileges in an irreversible operation because this function can only enable privileges that are already present in the token.</p>

<p>Note that this function does not support token pseudo-handles such as <code><a href="ntcurrentprocesstoken" title="#define NtCurrentProcessToken() ((HANDLE)(LONG_PTR)-4) // NtOpenProcessToken(NtCurrentProcess())">NtCurrentProcessToken</a></code>. If you want to adjust the current process/thread token, you need to open it first.</p>

<h1 id="related-win32-api">Related Win32 API</h1>

<ul>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-adjusttokenprivileges"><code>AdjustTokenPrivileges</code></a></li>
</ul>

<h1 id="see-also">See also</h1>

<ul>
<li><code><a href="ntfiltertoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtFilterToken(&#10;    _In_ HANDLE ExistingTokenHandle,&#10;    _In_ ULONG Flags,&#10;    _In_opt_ PTOKEN_GROUPS SidsToDisable,&#10;    _In_opt_ PTOKEN_PRIVILEGES PrivilegesToDelete,&#10;    _In_opt_ PTOKEN_GROUPS RestrictedSids,&#10;    _Out_ PHANDLE NewTokenHandle&#10;    );">NtFilterToken</a></code></li>
<li><code><a href="ntadjustgroupstoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAdjustGroupsToken(&#10;    _In_ HANDLE TokenHandle,&#10;    _In_ BOOLEAN ResetToDefault,&#10;    _In_opt_ PTOKEN_GROUPS NewState,&#10;    _In_opt_ ULONG BufferLength,&#10;    _Out_writes_bytes_to_opt_(BufferLength, *ReturnLength) PTOKEN_GROUPS PreviousState,&#10;    _Out_opt_ PULONG ReturnLength&#10;    );">NtAdjustGroupsToken</a></code></li>
<li><code><a href="rtlremoveprivileges" title="NTSYSAPI&#10;NTSTATUS&#10;NTAPI&#10;RtlRemovePrivileges(&#10;    _In_ HANDLE TokenHandle,&#10;    _In_ PULONG PrivilegesToKeep,&#10;    _In_ ULONG PrivilegeCount&#10;    );">RtlRemovePrivileges</a></code></li>
<li><code><a href="ntopenprocesstoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtOpenProcessToken(&#10;    _In_ HANDLE ProcessHandle,&#10;    _In_ ACCESS_MASK DesiredAccess,&#10;    _Out_ PHANDLE TokenHandle&#10;    );">NtOpenProcessToken</a></code></li>
<li><code><a href="ntopenthreadtoken" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtOpenThreadToken(&#10;    _In_ HANDLE ThreadHandle,&#10;    _In_ ACCESS_MASK DesiredAccess,&#10;    _In_ BOOLEAN OpenAsSelf,&#10;    _Out_ PHANDLE TokenHandle&#10;    );">NtOpenThreadToken</a></code></li>
</ul>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ntadjustprivilegestoken.md">Edit description on GitHub</a>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
