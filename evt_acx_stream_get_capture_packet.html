<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="EVT_ACX_STREAM_GET_CAPTURE_PACKET - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>EVT_ACX_STREAM_GET_CAPTURE_PACKET - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            EVT_ACX_STREAM_GET_CAPTURE_PACKET - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// acxstreams.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">EVT_ACX_STREAM_GET_CAPTURE_PACKET EvtAcxStreamGetCapturePacket;

<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> EvtAcxStreamGetCapturePacket(
  ACXSTREAM Stream,
  PULONG LastCapturePacket,
  PULONGLONG QPCPacketStart,
  PBOOLEAN MoreData
)
{...}</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/acxstreams/nc-acxstreams-evt_acx_stream_get_capture_packet">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/evt_acx_stream_get_capture_packet.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nc-acxstreams-evt_acx_stream_get_capture_packet)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2 id="description">Description</h2>

<p><strong>EvtAcxStreamGetCapturePacket</strong> tells the driver to indicate which packet (0-based) was completely filled most recently, including the QPC value at the time the driver started filling the packet.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="stream"><code>Stream</code></h3>

<p>An ACXSTREAM object represents an audio stream created by a circuit. The stream is composed of a list of elements created based on the parent circuit's elements. For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/audio/acx-summary-of-objects">ACX - Summary of ACX Objects</a>.</p>

<h3 id="lastcapturepacket"><code>LastCapturePacket</code></h3>

<p>A value indicating the position of the last captured packet. This is a 0-based index indicating how many complete packets of data have been captured.</p>

<h3 id="qpcpacketstart"><code>QPCPacketStart</code></h3>

<p>A value indicating the start time of the last captured packet.</p>

<h3 id="moredata"><code>MoreData</code></h3>

<p>Returns TRUE if there is more data ready immediately. The OS may optionally immediately call this routine again after processing the packet to get the next packet information. If the driver returns FALSE, then capture is operating at real time.</p>

<h2 id="return-value">Return value</h2>

<p>Returns <code><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></code> if the call was successful. Otherwise, it returns an appropriate error code. For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/using-ntstatus-values">Using NTSTATUS Values</a>.</p>

<h2 id="remarks">Remarks</h2>

<p>Before reading captured audio data from the audio buffer, the OS calls this routine to get information about the available data.</p>

<p>The packet number identifies a packet within the stream. This resets to zero when <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/acxstreams/nc-acxstreams-evt_acx_stream_release_hardware">EVT_ACX_STREAM_RELEASEHARDWARE</a> has been called for the stream. The number advances with each captured buffer. From the packet number the OS can derive the packet location within the audio buffer and can also derive the stream position of the packet relative to start of stream.</p>

<p>The OS may call this routine at any time. In normal operation, the OS calls this routine after the driver calls <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/acxstreams/nf-acxstreams-acxrtstreamnotifypacketcomplete">AcxRtStreamNotifyPacketComplete</a> or after a previous call returns true for MoreData. When the OS calls this routine, the driver may assume that the OS has finished reading all previous packets. If the hardware has captured enough data, the driver may immediately burst the next complete packet to the audio buffer and call <a href="acxrtstreamnotifypacketcomplete" title="NTSTATUS AcxRtStreamNotifyPacketComplete(&#10;  ACXSTREAM Stream,&#10;  ULONGLONG CompletedPacket,&#10;  ULONGLONG QPCCompletion&#10;);">AcxRtStreamNotifyPacketComplete</a> again. In the case of capture overflow (when the OS does not read data quickly enough) the audio driver may drop or overwrite some audio data. The audio driver drops or overwrites oldest data first. The audio driver may continue to advance its internal packet counter even though the OS may not have read the data.</p>

<h3 id="example">Example</h3>

<p>Example usage is shown below.</p>

<div class="codehilite">
<pre><span></span><code><span class="cp">#pragma code_seg(&quot;PAGE&quot;)</span>
<span class="n"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a></span>
<span class="nf">CodecC_EvtStreamGetCapturePacket</span><span class="p">(</span>
<span class="w">    </span><span class="n">_In_</span><span class="w"> </span><span class="n">ACXSTREAM</span><span class="w">          </span><span class="n">Stream</span><span class="p">,</span>
<span class="w">    </span><span class="n">_Out_</span><span class="w"> </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w">           </span><span class="o">*</span><span class="w"> </span><span class="n">LastCapturePacket</span><span class="p">,</span>
<span class="w">    </span><span class="n">_Out_</span><span class="w"> </span><span class="n"><a href="ulonglong" title="typedef unsigned __int64 ULONGLONG;">ULONGLONG</a></span><span class="w">       </span><span class="o">*</span><span class="w"> </span><span class="n">QPCPacketStart</span><span class="p">,</span>
<span class="w">    </span><span class="n">_Out_</span><span class="w"> </span><span class="n">BOOLEAN</span><span class="w">         </span><span class="o">*</span><span class="w"> </span><span class="n">MoreData</span>
<span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PCODEC_STREAM_CONTEXT</span><span class="w"> </span><span class="n">ctx</span><span class="p">;</span>
<span class="w">    </span><span class="n">CCaptureStreamEngine</span><span class="o">*</span><span class="w"> </span><span class="n">streamEngine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w"> </span><span class="n">currentPacket</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="longlong" title="typedef __int64 LONGLONG;">LONGLONG</a></span><span class="w"> </span><span class="n">qpcPacketStart</span><span class="p">;</span>

<span class="w">    </span><span class="n">PAGED_CODE</span><span class="p">();</span>

<span class="w">    </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetCodecStreamContext</span><span class="p">(</span><span class="n">Stream</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Retrieve the current packet that is being written to by the audio hardware</span>
<span class="w">    </span><span class="n">currentPacket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="p">)</span><span class="n"><a href="interlockedcompareexchange" title="LONG InterlockedCompareExchange(&#10;  [in, out] LONG volatile *Destination,&#10;            LONG          ExChange,&#10;            LONG          Comperand&#10;);">InterlockedCompareExchange</a></span><span class="p">((</span><span class="n"><a href="long" title="typedef long LONG;">LONG</a></span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">CurrentPacket</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>
<span class="w">    </span><span class="n">qpcPacketStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InterlockedCompareExchange64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">LastPacketStart</span><span class="p">.</span><span class="n">QuadPart</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// The Last capture packet is the packet before the current packet.</span>
<span class="w">    </span><span class="o">*</span><span class="n">LastCapturePacket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">currentPacket</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">QPCPacketStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="ulonglong" title="typedef unsigned __int64 ULONGLONG;">ULONGLONG</a></span><span class="p">)</span><span class="n">qpcPacketStart</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">MoreData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n"><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="acx-requirements">ACX requirements</h3>

<p><strong>Minimum ACX version:</strong> 1.0</p>

<p>For more information about ACX versions, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/audio/acx-version-overview">ACX version overview</a>.</p>

<h2 id="see-also">See also</h2>

<ul>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/acxstreams/">acxstreams.h header</a></li>
</ul>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/acxstreams/nc-acxstreams-evt_acx_stream_get_capture_packet">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/acxstreams/nc-acxstreams-evt_acx_stream_get_capture_packet.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
