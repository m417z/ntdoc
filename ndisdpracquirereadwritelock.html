<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="NdisDprAcquireReadWriteLock - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>NdisDprAcquireReadWriteLock - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            NdisDprAcquireReadWriteLock - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ndis.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">VOID NdisDprAcquireReadWriteLock(
  [in, out] <a href="ndis_rw_lock" title="typedef struct _NDIS_RW_LOCK {&#10;  union {&#10;    struct {&#10;      KSPIN_LOCK SpinLock;&#10;      PVOID      Context;&#10;    };&#10;    UCHAR Reserved[16];&#10;  };&#10;  union {&#10;    NDIS_RW_LOCK_REFCOUNT RefCount[MAXIMUM_PROCESSORS];&#10;    ULONG                 *RefCountEx[sizeof(NDIS_RW_LOCK_REFCOUNT)/ sizeof(ULONG) MAXIMUM_PROCESSORS];&#10;    struct {&#10;      KSPIN_LOCK RefCountLock;&#10;      ULONG      SharedRefCount;&#10;      BOOLEAN    WriterWaiting;&#10;    };&#10;  };&#10;} NDIS_RW_LOCK, *PNDIS_RW_LOCK;">PNDIS_RW_LOCK</a> Lock,
  [in]      BOOLEAN       fWrite,
  [out]     <a href="lock_state" title="typedef struct _LOCK_STATE {&#10;  USHORT LockState;&#10;  KIRQL  OldIrql;&#10;} LOCK_STATE, *PLOCK_STATE;">PLOCK_STATE</a>   LockState
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nf-ndis-ndisdpracquirereadwritelock">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ndisdpracquirereadwritelock.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ndis-ndisdpracquirereadwritelock)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1>NdisDprAcquireReadWriteLock function</h1>

<h2>Description</h2>

<p>The
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/hh205388(v=vs.85)">NdisDprAcquireReadWriteLock</a> function acquires a lock that the caller uses for either write or read
access to the resources that are shared among driver threads.</p>

<p><strong>Note</strong> The read-write lock interface is deprecated for NDIS 6.20 and later drivers, which should use <a href="ndisacquirerwlockread" title="VOID NdisAcquireRWLockRead(&#10;  [in]  PNDIS_RW_LOCK_EX Lock,&#10;  [out] PLOCK_STATE_EX   LockState,&#10;  [in]  UCHAR            Flags&#10;);">NdisAcquireRWLockRead</a> or <a href="ndisacquirerwlockwrite" title="VOID NdisAcquireRWLockWrite(&#10;  [in]  PNDIS_RW_LOCK_EX Lock,&#10;  [out] PLOCK_STATE_EX   LockState,&#10;  [in]  UCHAR            Flags&#10;);">NdisAcquireRWLockWrite</a> (setting <strong>NDIS_RWL_AT_DISPATCH_LEVEL</strong> in the <em>Flags</em> parameter) instead of <a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/hh205388(v=vs.85)">NdisDprAcquireReadWriteLock</a>.</p>

<h2>Parameters</h2>

<h3><code>Lock</code> [in, out]</h3>

<p>A pointer to an opaque variable that represents a lock. The caller can use this lock to access
shared resources.</p>

<h3><code>fWrite</code> [in]</h3>

<p>A Boolean value. If the value is TRUE, this function is provided with write access to shared
resources; if the value is FALSE, this function is provided with read access.</p>

<h3><code>LockState</code> [out]</h3>

<p>A pointer to an opaque variable that tracks the state of the lock. This variable exists in the
interval between the time the caller acquires and releases the lock. The caller must use a different
variable of type <a href="lock_state" title="typedef struct _LOCK_STATE {&#10;  USHORT LockState;&#10;  KIRQL  OldIrql;&#10;} LOCK_STATE, *PLOCK_STATE;">LOCK_STATE</a> for each attempt that it makes to acquire the lock from the same non-ISR
driver thread.</p>

<h2>Remarks</h2>

<p>The driver must initialize a variable of type <a href="ndis_rw_lock" title="typedef struct _NDIS_RW_LOCK {&#10;  union {&#10;    struct {&#10;      KSPIN_LOCK SpinLock;&#10;      PVOID      Context;&#10;    };&#10;    UCHAR Reserved[16];&#10;  };&#10;  union {&#10;    NDIS_RW_LOCK_REFCOUNT RefCount[MAXIMUM_PROCESSORS];&#10;    ULONG                 *RefCountEx[sizeof(NDIS_RW_LOCK_REFCOUNT)/ sizeof(ULONG) MAXIMUM_PROCESSORS];&#10;    struct {&#10;      KSPIN_LOCK RefCountLock;&#10;      ULONG      SharedRefCount;&#10;      BOOLEAN    WriterWaiting;&#10;    };&#10;  };&#10;} NDIS_RW_LOCK, *PNDIS_RW_LOCK;">NDIS_RW_LOCK</a> using the
<a href="ndisinitializereadwritelock" title="VOID NdisInitializeReadWriteLock(&#10;  [out] PNDIS_RW_LOCK Lock&#10;);">NdisInitializeReadWriteLock</a> function before the driver calls any other
Ndis<em>Xxx</em>ReadWriteLock function. The driver must provide resident storage for the locks it uses.</p>

<p>After acquiring a lock by using
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/hh205388(v=vs.85)">NdisDprAcquireReadWriteLock</a>, the caller must release that lock by calling the
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/hh205389(v=vs.85)">NdisDprReleaseReadWriteLock</a> function. To decrement the reference count of the lock, a driver must call
<strong><a href="ndisdprreleasereadwritelock" title="VOID NdisDprReleaseReadWriteLock(&#10;  [in, out] PNDIS_RW_LOCK Lock,&#10;            PLOCK_STATE   LockState&#10;);">NdisDprReleaseReadWriteLock</a></strong> once for each call to
<strong>NdisDprAcquireReadWriteLock</strong>.</p>

<p>It is safe to use both <a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/hh205388(v=vs.85)">NdisDprAcquireReadWriteLock</a> and <strong>NdisDprAcquireReadWriteLock</strong> on the same lock. However, calls must be balanced so that if the lock is acquired with <strong>NdisDprAcquireReadWriteLock</strong>, it must be released with <a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/hh205389(v=vs.85)">NdisDprReleaseReadWriteLock</a>. Likewise, if the lock is acquired with <strong><a href="ndisacquirereadwritelock" title="VOID NdisAcquireReadWriteLock(&#10;  [in, out] PNDIS_RW_LOCK Lock,&#10;  [in]      BOOLEAN       fWrite,&#10;  [_out_]   PLOCK_STATE   LockState&#10;);">NdisAcquireReadWriteLock</a></strong>, it must be released with <strong><a href="ndisreleasereadwritelock" title="VOID NdisReleaseReadWriteLock(&#10;  [in, out] PNDIS_RW_LOCK Lock,&#10;  [in]      PLOCK_STATE   LockState&#10;);">NdisReleaseReadWriteLock</a></strong>.</p>

<p>With some architectures, <a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/hh205388(v=vs.85)">NdisDprAcquireReadWriteLock</a> performs faster than <strong><a href="ndisacquirereadwritelock" title="VOID NdisAcquireReadWriteLock(&#10;  [in, out] PNDIS_RW_LOCK Lock,&#10;  [in]      BOOLEAN       fWrite,&#10;  [_out_]   PLOCK_STATE   LockState&#10;);">NdisAcquireReadWriteLock</a></strong>. Drivers can use <strong>NdisDprAcquireReadWriteLock</strong> rather than <strong><a href="ndisacquirereadwritelock" title="VOID NdisAcquireReadWriteLock(&#10;  [in, out] PNDIS_RW_LOCK Lock,&#10;  [in]      BOOLEAN       fWrite,&#10;  [_out_]   PLOCK_STATE   LockState&#10;);">NdisAcquireReadWriteLock</a></strong> when it is certain that the current IRQL is already <strong>DISPATCH_LEVEL</strong>. However, it is not required. The overhead of calling the <a href="kegetcurrentirql" title="NTHALAPI KIRQL KeGetCurrentIrql();">KeGetCurrentIrql</a> function is greater than the performance advantage of calling <strong>NdisDprAcquireReadWriteLock</strong> rather than <strong><a href="ndisacquirereadwritelock" title="VOID NdisAcquireReadWriteLock(&#10;  [in, out] PNDIS_RW_LOCK Lock,&#10;  [in]      BOOLEAN       fWrite,&#10;  [_out_]   PLOCK_STATE   LockState&#10;);">NdisAcquireReadWriteLock</a></strong>.</p>

<p>To modify resources that are shared among driver threads, a driver thread must acquire a write lock.
To simply monitor those resources, a driver thread must acquire a read-only lock. Read access does not
require interlocked operations or contention for spin locks. Using read-only access helps to maintain
good operating system and driver performance.</p>

<p>A driver thread should never hold a write lock for more than 25 microseconds. Holding a write lock for
a prolonged period degrades both operating system and driver performance.</p>

<p>The driver cannot use a lock to protect resources from read or write access that its other functions
share with the
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_isr">MiniportInterrupt</a> and/or
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_disable_interrupt">MiniportDisableInterruptEx</a> functions. Instead, the driver must call
<a href="ndismsynchronizewithinterruptex" title="BOOLEAN NdisMSynchronizeWithInterruptEx(&#10;  [in] NDIS_HANDLE                            NdisInterruptHandle,&#10;  [in] ULONG                                  MessageId,&#10;  [in] MINIPORT_SYNCHRONIZE_INTERRUPT_HANDLER SynchronizeFunction,&#10;  [in] PVOID                                  SynchronizeFunction,&#10;  [in] PVOID                                  SynchronizeContext&#10;);">NdisMSynchronizeWithInterruptEx</a> so that its
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_synchronize_interrupt">MiniportSynchronizeInterrupt</a> function accesses such shared resources at the same DIRQL at which its
<em>MiniportInterrupt</em> and/or
<em>MiniportDisableInterruptEx</em> functions do.</p>

<p>For more information about acquiring and releasing NDIS spin locks, see
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/synchronization-and-notification-in-network-drivers">Synchronization
and Notification in Network Drivers</a>.</p>

<h2>See also</h2>

<p><a href="lock_state" title="typedef struct _LOCK_STATE {&#10;  USHORT LockState;&#10;  KIRQL  OldIrql;&#10;} LOCK_STATE, *PLOCK_STATE;">LOCK_STATE</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_disable_interrupt">MiniportDisableInterruptEx</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_isr">MiniportInterrupt</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_synchronize_interrupt">MiniportSynchronizeInterrupt</a></p>

<p><a href="ndisacquirerwlockread" title="VOID NdisAcquireRWLockRead(&#10;  [in]  PNDIS_RW_LOCK_EX Lock,&#10;  [out] PLOCK_STATE_EX   LockState,&#10;  [in]  UCHAR            Flags&#10;);">NdisAcquireRWLockRead</a></p>

<p><a href="ndisacquirerwlockwrite" title="VOID NdisAcquireRWLockWrite(&#10;  [in]  PNDIS_RW_LOCK_EX Lock,&#10;  [out] PLOCK_STATE_EX   LockState,&#10;  [in]  UCHAR            Flags&#10;);">NdisAcquireRWLockWrite</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/hh205389(v=vs.85)">NdisDprReleaseReadWriteLock</a></p>

<p><a href="ndisinitializereadwritelock" title="VOID NdisInitializeReadWriteLock(&#10;  [out] PNDIS_RW_LOCK Lock&#10;);">NdisInitializeReadWriteLock</a></p>

<p><a href="ndismsynchronizewithinterruptex" title="BOOLEAN NdisMSynchronizeWithInterruptEx(&#10;  [in] NDIS_HANDLE                            NdisInterruptHandle,&#10;  [in] ULONG                                  MessageId,&#10;  [in] MINIPORT_SYNCHRONIZE_INTERRUPT_HANDLER SynchronizeFunction,&#10;  [in] PVOID                                  SynchronizeFunction,&#10;  [in] PVOID                                  SynchronizeContext&#10;);">NdisMSynchronizeWithInterruptEx</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nf-ndis-ndisdpracquirereadwritelock">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ndis/nf-ndis-ndisdpracquirereadwritelock.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
