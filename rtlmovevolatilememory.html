<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="RtlMoveVolatileMemory - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>RtlMoveVolatileMemory - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            RtlMoveVolatileMemory - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">volatile void * RtlMoveVolatileMemory(
  [out] volatile void       *Destination,
  [in]  volatile const void *Source,
  [in]  <a href="size_t" title="typedef unsigned __int64 size_t;">size_t</a>              Length
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlmovevolatilememory">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/rtlmovevolatilememory.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdm-rtlmovevolatilememory)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2>Description</h2>
<p>The <strong>RtlMoveVolatileMemory</strong> function exists to provide <strong><a href="rtlmovememory" title="void RtlMoveMemory(&#10;   void*       Destination,&#10;   const void* Source,&#10;   size_t      Length&#10;);">RtlMoveMemory</a></strong> behavior (for example, copying memory from one location to another) in situations where the developer needs to be sure that the copy operation occurs (for example, isn't subject to compiler optimizations). Unlike <strong><a href="rtlcopyvolatilememory" title="volatile void * RtlCopyVolatileMemory(&#10;  [out] volatile void       *Destination,&#10;  [in]  volatile const void *Source,&#10;  [in]  size_t              Length&#10;);">RtlCopyVolatileMemory</a></strong>, this function handles cases where the <em>Source</em> and <em>Destination</em> buffer overlap.</p>
<h2>Parameters</h2>
<h3><code>Destination</code> [out]</h3>
<p>A pointer to the starting address of the copied block's destination.</p>
<h3><code>Source</code> [in]</h3>
<p>A pointer to the starting address of the block of memory to copy.</p>
<h3><code>Length</code> [in]</h3>
<p>The size of the block of memory to copy, in bytes.</p>
<h2>Return value</h2>
<p>Returns the value of <em>Destination</em>.</p>
<h2>Remarks</h2>
<p>The <strong>RtlMoveVolatileMemory</strong> function has the following properties:</p>
<ul>
<li><p>The function isn't recognized as a compiler intrinsic so the compiler will never optimize away the call (either entirely or replace the call with an equivalent sequence of instructions). This differs from <strong><a href="rtlmovememory" title="void RtlMoveMemory(&#10;   void*       Destination,&#10;   const void* Source,&#10;   size_t      Length&#10;);">RtlMoveMemory</a></strong> which is subject to various compiler optimizations.</p></li>
<li><p>When the call returns, the data has been copied from <em>Source</em> to <em>Destination</em>. This functions memory accesses to the <em>Source</em> and <em>Destination</em> will only be performed within the function (for example, the compiler can't move memory accesses out of this function).</p></li>
<li><p>The function may perform unaligned memory accesses if the platform allows for it.</p></li>
<li><p>The function may access memory locations more than once as part of its copy operation.</p></li>
<li><p>Similar to <strong><a href="rtlmovememory" title="void RtlMoveMemory(&#10;   void*       Destination,&#10;   const void* Source,&#10;   size_t      Length&#10;);">RtlMoveMemory</a></strong> in that it supports copy operations when <em>Source</em> and <em>Destination</em> overlap each other.</p></li>
</ul>
<blockquote>
  <p>[!NOTE]
  This function works on all versions of Windows, not just the latest. You need to consume the latest WDK to get the function declaration from the wdm.h header. You also need the library (volatileaccessk.lib) from the latest WDK. However, the resulting driver will run fine on older versions of Windows.</p>
</blockquote>
<h3>Example</h3>
<pre><code>HEADER MyHeader;
<a href="uchar" title="typedef unsigned char UCHAR;">UCHAR</a> RawBuffer[100];
// Ensure that the shared memory (which could be constantly changing)
// is copied in to the local MyHeader variable.
// Note that the compiler is allowed to optimize away calls to
// <a href="rtlmovememory" title="void RtlMoveMemory(&#10;   void*       Destination,&#10;   const void* Source,&#10;   size_t      Length&#10;);">RtlMoveMemory</a> so those functions are not guaranteed to actually
// make a local copy of data.
//
// RtlMoveVolatileMemory does handle buffers
// that overlap with each other (MoveMemory semantics).
// Assume SharedMemory points to virtual memory that is also mapped in an untrusted process.
// Assume that untrusted process is changing the memory contents while you are accessing it.
PVOID SharedMemory;
RtlMoveVolatileMemory(&amp;MyHeader, SharedMemory, sizeof(MyHeader));
if (MyHeader.Size &lt; 100) {
    // Because MyHeader is local and we are guaranteed we actually made
    // a local copy, we can be sure that the "Size" value will not change
    // between the previous bounds check and the below call to <a href="rtlfillmemory" title="void RtlFillMemory(&#10;   void*  Destination,&#10;   size_t Length&#10;   int    Fill&#10;);">RtlFillMemory</a>.
    // If <a href="rtlmovememory" title="void RtlMoveMemory(&#10;   void*       Destination,&#10;   const void* Source,&#10;   size_t      Length&#10;);">RtlMoveMemory</a> had been used to copy the data, it is possible
    // that a compiler may optimize away the call to MoveMemory and instead fetch
    // the "size" field of MyHeader directly from untrusted memory two times.
    // The first time it would be fetched for the bounds check, and the second
    // time it is fetched is for the call to <a href="rtlfillmemory" title="void RtlFillMemory(&#10;   void*  Destination,&#10;   size_t Length&#10;   int    Fill&#10;);">RtlFillMemory</a>. It is possible the memory
    // could have changed between the two accesses resulting in the size check
    // being ineffective.
    <a href="rtlfillmemory" title="void RtlFillMemory(&#10;   void*  Destination,&#10;   size_t Length&#10;   int    Fill&#10;);">RtlFillMemory</a> (RawBuffer, MyHeader.Size, 0);
}
</code></pre>
<h2>See also</h2>
<p><strong><a href="rtlcopyvolatilememory" title="volatile void * RtlCopyVolatileMemory(&#10;  [out] volatile void       *Destination,&#10;  [in]  volatile const void *Source,&#10;  [in]  size_t              Length&#10;);">RtlCopyVolatileMemory</a></strong></p>
<p><strong><a href="rtlmovememory" title="void RtlMoveMemory(&#10;   void*       Destination,&#10;   const void* Source,&#10;   size_t      Length&#10;);">RtlMoveMemory</a></strong></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-rtlmovevolatilememory">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/nf-wdm-rtlmovevolatilememory.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
