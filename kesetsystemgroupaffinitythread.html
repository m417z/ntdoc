<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="KeSetSystemGroupAffinityThread - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>KeSetSystemGroupAffinityThread - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            KeSetSystemGroupAffinityThread - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">VOID KeSetSystemGroupAffinityThread(
  [in]            <a href="group_affinity" title="typedef struct _GROUP_AFFINITY {&#10;  KAFFINITY Mask;&#10;  USHORT    Group;&#10;  USHORT    Reserved[3];&#10;} GROUP_AFFINITY, *PGROUP_AFFINITY;">PGROUP_AFFINITY</a> Affinity,
  [out, optional] <a href="group_affinity" title="typedef struct _GROUP_AFFINITY {&#10;  KAFFINITY Mask;&#10;  USHORT    Group;&#10;  USHORT    Reserved[3];&#10;} GROUP_AFFINITY, *PGROUP_AFFINITY;">PGROUP_AFFINITY</a> PreviousAffinity
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kesetsystemgroupaffinitythread">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/kesetsystemgroupaffinitythread.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdm-kesetsystemgroupaffinitythread)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="kesetsystemgroupaffinitythread-function">KeSetSystemGroupAffinityThread function</h1>

<h2 id="description">Description</h2>

<p>The <strong>KeSetSystemGroupAffinityThread</strong> routine changes the group number and affinity mask of the calling thread.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="affinity-in"><code>Affinity</code> [in]</h3>

<p>A pointer to a <a href="group_affinity" title="typedef struct _GROUP_AFFINITY {&#10;  KAFFINITY Mask;&#10;  USHORT    Group;&#10;  USHORT    Reserved[3];&#10;} GROUP_AFFINITY, *PGROUP_AFFINITY;">GROUP_AFFINITY</a> structure that specifies the new group number and group-relative affinity mask for the calling thread.</p>

<h3 id="previousaffinity-out-optional"><code>PreviousAffinity</code> [out, optional]</h3>

<p>A pointer to a caller-allocated <strong><a href="group_affinity" title="typedef struct _GROUP_AFFINITY {&#10;  KAFFINITY Mask;&#10;  USHORT    Group;&#10;  USHORT    Reserved[3];&#10;} GROUP_AFFINITY, *PGROUP_AFFINITY;">GROUP_AFFINITY</a></strong> structure into which the routine writes information about the previous group affinity of the calling thread. The caller can later use this pointer as an input parameter to the <a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a> routine to restore the previous thread affinity. Frequently, <strong>KeSetSystemGroupAffinityThread</strong> writes values to this structure that are not valid group affinities but that have special meaning to <strong><a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a></strong>. Do not supply pointers to these special values as <em>Affinity</em> parameters in subsequent <strong>KeSetSystemGroupAffinityThread</strong> calls.</p>

<p>If necessary, the caller can change the thread affinity more than once by calling <strong>KeSetSystemGroupAffinityThread</strong> multiple times. During the first of these calls, the caller should specify a non-<strong>NULL</strong> value for <em>PreviousAffinity</em> so that the original thread affinity can be captured and later restored. However, the later calls to <strong>KeSetSystemGroupAffinityThread</strong> can, as an option, set <em>PreviousAffinity</em> = <strong>NULL</strong>. For more information, see Remarks.</p>

<h2 id="remarks">Remarks</h2>

<p>This routine changes the group number and group-relative affinity mask of the calling thread. The <em>Affinity</em> parameter points to a <a href="group_affinity" title="typedef struct _GROUP_AFFINITY {&#10;  KAFFINITY Mask;&#10;  USHORT    Group;&#10;  USHORT    Reserved[3];&#10;} GROUP_AFFINITY, *PGROUP_AFFINITY;">GROUP_AFFINITY</a> structure. The group number and affinity mask in this structure identify a set of processors on which the thread can run. If successful, the routine schedules the thread to run on a processor in this set.</p>

<p>If the <em>PreviousAffinity</em> parameter is non-<strong>NULL</strong>, the routine saves information about the previous group affinity, which were in effect at the start of the call, in the <strong><a href="group_affinity" title="typedef struct _GROUP_AFFINITY {&#10;  KAFFINITY Mask;&#10;  USHORT    Group;&#10;  USHORT    Reserved[3];&#10;} GROUP_AFFINITY, *PGROUP_AFFINITY;">GROUP_AFFINITY</a></strong> structure that <em>PreviousAffinity</em> points to. To restore the previous thread affinity, the caller can supply the pointer to this structure as an input parameter to the <a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a> routine.</p>

<p>In a multiprocessor system, a kernel-mode driver routine that runs in the context of a user-mode thread might need to call <strong>KeSetSystemGroupAffinityThread</strong> to temporarily change the group affinity of the thread. Before the routine exits, it should call <strong><a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a></strong> to restore the affinity mask of the thread to its original value.</p>

<p>A process can have affinity for more than one group at a time. However, a thread can be assigned to only one group at any time. That group is always in the affinity of the thread's process. A thread can change the group to which it is assigned by calling <strong>KeSetSystemGroupAffinityThread</strong>.</p>

<p><strong>KeSetSystemGroupAffinityThread</strong> changes the group number and affinity mask to the values that are specified in <em>*Affinity</em> only if the following are true:</p>

<ul>
<li>The group number is valid.</li>
<li>The affinity mask is valid (that is, only mask bits that correspond to logical processors in the group are set).</li>
<li>At least one of the processors that is specified in the affinity mask is active.</li>
</ul>

<p>If any of these conditions is not met, the group number and affinity mask of the thread remain unchanged. If <em>PreviousAffinity</em> is non-<strong>NULL</strong>, the routine writes zero to both the group number and the affinity mask in <em>*PreviousAffinity</em>.</p>

<p>Additionally, <strong>KeSetSystemGroupAffinityThread</strong> writes zero to both the group number and the affinity mask in <strong>PreviousAffinity* if the previous group affinity was assigned to the thread in user mode. In response to a **<a href="group_affinity" title="typedef struct _GROUP_AFFINITY {&#10;  KAFFINITY Mask;&#10;  USHORT    Group;&#10;  USHORT    Reserved[3];&#10;} GROUP_AFFINITY, *PGROUP_AFFINITY;">GROUP_AFFINITY</a></strong> structure in which the group number and affinity mask are both zero, <strong><a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a></strong> restores the current user-mode thread affinity. If the user-mode thread affinity changes between the <strong>KeSetSystemGroupAffinityThread</strong> and <strong><a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a></strong> calls, the most recent user-mode affinity is assigned to the thread. (An application can call a function such as <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/processtopologyapi/nf-processtopologyapi-setthreadgroupaffinity">SetThreadGroupAffinity</a> to change the user-mode group affinity of a thread.)</p>

<p>Before the new affinity mask in <strong>Affinity* takes effect, **KeSetSystemGroupAffinityThread</strong> removes (sets to zero) any affinity mask bits that correspond to processors that are not currently active. In a subsequent <strong>KeSetSystemGroupAffinityThread</strong> call, the value that the routine writes to **PreviousAffinity* might contain an affinity mask that has been modified in this way.</p>

<p>A related routine, <a href="kesetsystemaffinitythreadex" title="KAFFINITY KeSetSystemAffinityThreadEx(&#10;  [in] KAFFINITY Affinity&#10;);">KeSetSystemAffinityThreadEx</a>, changes the affinity mask of the calling thread, but this routine, unlike <strong>KeSetSystemGroupAffinityThread</strong>, does not accept a group number as an input parameter. Starting with Windows 7, <strong><a href="kesetsystemaffinitythreadex" title="KAFFINITY KeSetSystemAffinityThreadEx(&#10;  [in] KAFFINITY Affinity&#10;);">KeSetSystemAffinityThreadEx</a></strong> assumes that the affinity mask refers to processors in group 0, which is compatible with the behavior of this routine in earlier versions of Windows that do not support groups. This behavior ensures that existing drivers that call <strong><a href="kesetsystemaffinitythreadex" title="KAFFINITY KeSetSystemAffinityThreadEx(&#10;  [in] KAFFINITY Affinity&#10;);">KeSetSystemAffinityThreadEx</a></strong> and that use no group-oriented features will run correctly in multiprocessor systems that have two or more groups. However, drivers that use any group-oriented features in Windows 7 and later versions of the Windows operating system should call <strong>KeSetSystemGroupAffinityThread</strong> instead of <strong><a href="kesetsystemaffinitythreadex" title="KAFFINITY KeSetSystemAffinityThreadEx(&#10;  [in] KAFFINITY Affinity&#10;);">KeSetSystemAffinityThreadEx</a></strong>.</p>

<p><strong>KeSetSystemGroupAffinityThread</strong> and <strong><a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a></strong> support a variety of calling patterns. Two examples are shown in the following diagrams.</p>

<p>The following diagram represents a driver thread that calls <strong>KeSetSystemGroupAffinityThread</strong> three times to change the thread affinity, and then calls <strong><a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a></strong> to restore the original thread affinity.</p>

<p><img src="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/images/affinity1.png" alt="Diagram illustrating multiple calls to set affinity." /></p>

<p>In the preceding diagram, the three boxes labeled "Set affinity" are calls to <strong>KeSetSystemGroupAffinityThread</strong>, and the box labeled "Revert affinity" is a call to <strong><a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a></strong>. The first <strong>KeSetSystemGroupAffinityThread</strong> call uses the <em>PreviousAffinity</em> output pointer to save the original thread affinity. In the next two calls to <strong>KeSetSystemGroupAffinityThread</strong> (marked with asterisks), the caller sets <em>PreviousAffinity</em> to <strong>NULL</strong>. Before the thread exits, it calls <strong><a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a></strong> to restore the thread affinity that was saved by the first <strong>KeSetSystemGroupAffinityThread</strong> call.</p>

<p>The following diagram shows a somewhat different calling pattern in which pairs of <strong>KeSetSystemGroupAffinityThread</strong> and <strong><a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a></strong> calls are nested. In this diagram, each call to <strong>KeSetSystemGroupAffinityThread</strong> in the driver thread uses the <em>PreviousAffinity</em> output parameter to save the previous thread affinity, and each of these calls is paired with a call to <strong><a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a></strong> that restores the saved thread affinity.</p>

<p><img src="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/images/affinity2.png" alt="Diagram illustrating nested calls to set and restore affinity." /></p>

<p>In the preceding diagram, function A in the driver thread calls function B twice. Assume that on entry to function A, the thread still has the affinity assigned to it by the user-mode application. Thus, the <strong>KeSetSystemGroupAffinityThread</strong> call in function A saves the original, user-mode thread affinity. During the first call to function B, the <strong>KeSetSystemGroupAffinityThread</strong> saves the thread affinity assigned by the driver in function A, and the corresponding call to <strong><a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a></strong> restores this affinity. After B returns, the <strong><a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a></strong> in A restores the original, user-mode thread affinity. During the second call to B, the <strong>KeSetSystemGroupAffinityThread</strong> call saves the original, user-mode thread affinity, and the corresponding call to <strong><a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a></strong> restores this affinity. The point of this example is that function B does not need to know whether the caller (function A) changed the thread affinity to a driver-defined value before calling B.</p>

<p>If <strong>KeSetSystemGroupAffinityThread</strong> is called at IRQL &lt;= APC_LEVEL and the call is successful, the new group affinity takes effect immediately. When the call returns, the calling thread is already running on a processor that is specified in the new group affinity. If <strong>KeSetSystemGroupAffinityThread</strong> is called at IRQL = DISPATCH_LEVEL and the call is successful, the pending processor change is deferred until the caller lowers the IRQL below DISPATCH_LEVEL.</p>

<p>Starting with Windows 11 and Windows Server 2022, on a system with more than 64 processors, process and thread affinities span all processors in the system, across all <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/ProcThread/processor-groups">processor groups</a>, by default.
In order to set a thread's system group affinity over multiple processor groups, use <a href="pssetsystemmultiplegroupaffinitythread" title="NTSTATUS PsSetSystemMultipleGroupAffinityThread(&#10;  [in]      PGROUP_AFFINITY GroupAffinities,&#10;  [in]      USHORT          GroupCount,&#10;  [in, out] PAFFINITY_TOKEN AffinityToken&#10;);">PsSetSystemMultipleGroupAffinityThread</a>.</p>

<h2 id="see-also">See also</h2>

<p><a href="group_affinity" title="typedef struct _GROUP_AFFINITY {&#10;  KAFFINITY Mask;&#10;  USHORT    Group;&#10;  USHORT    Reserved[3];&#10;} GROUP_AFFINITY, *PGROUP_AFFINITY;">GROUP_AFFINITY</a></p>

<p><a href="kereverttousergroupaffinitythread" title="VOID KeRevertToUserGroupAffinityThread(&#10;  [in] PGROUP_AFFINITY PreviousAffinity&#10;);">KeRevertToUserGroupAffinityThread</a></p>

<p><a href="kesetsystemaffinitythreadex" title="KAFFINITY KeSetSystemAffinityThreadEx(&#10;  [in] KAFFINITY Affinity&#10;);">KeSetSystemAffinityThreadEx</a></p>

<p><a href="pssetsystemmultiplegroupaffinitythread" title="NTSTATUS PsSetSystemMultipleGroupAffinityThread(&#10;  [in]      PGROUP_AFFINITY GroupAffinities,&#10;  [in]      USHORT          GroupCount,&#10;  [in, out] PAFFINITY_TOKEN AffinityToken&#10;);">PsSetSystemMultipleGroupAffinityThread</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kesetsystemgroupaffinitythread">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/nf-wdm-kesetsystemgroupaffinitythread.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
