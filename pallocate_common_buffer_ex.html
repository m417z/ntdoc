<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="PALLOCATE_COMMON_BUFFER_EX - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>PALLOCATE_COMMON_BUFFER_EX - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            PALLOCATE_COMMON_BUFFER_EX - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">PALLOCATE_COMMON_BUFFER_EX PallocateCommonBufferEx;

PVOID PallocateCommonBufferEx(
  [in]           PDMA_ADAPTER DmaAdapter,
  [in, optional] <a href="physical_address" title="typedef LARGE_INTEGER PHYSICAL_ADDRESS, *PPHYSICAL_ADDRESS;">PPHYSICAL_ADDRESS</a> MaximumAddress,
  [in]           <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> Length,
  [out]          <a href="physical_address" title="typedef LARGE_INTEGER PHYSICAL_ADDRESS, *PPHYSICAL_ADDRESS;">PPHYSICAL_ADDRESS</a> LogicalAddress,
  [in]           BOOLEAN CacheEnabled,
  [in]           NODE_REQUIREMENT PreferredNode
)
{...}</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-pallocate_common_buffer_ex">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/pallocate_common_buffer_ex.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nc-wdm-pallocate_common_buffer_ex)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2 id="description">Description</h2>

<p>The <strong>AllocateCommonBufferEx</strong> routine allocates memory for a common buffer and maps this memory so that it can be accessed both by the processor and by a device that performs DMA operations.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="dmaadapter-in"><code>DmaAdapter</code> [in]</h3>

<p>A pointer to a <strong><a href="padapter_object" title="typedef struct _DMA_ADAPTER {&#10;  USHORT          Version;&#10;  USHORT          Size;&#10;  PDMA_OPERATIONS DmaOperations;&#10;} *PADAPTER_OBJECT, DMA_ADAPTER, *PDMA_ADAPTER;">DMA_ADAPTER</a></strong> structure. This structure is the adapter object that represents the driver's bus-master DMA device or system DMA channel. The caller obtained this pointer from a previous call to the <a href="iogetdmaadapter" title="_DMA_ADAPTER * IoGetDmaAdapter(&#10;  [in, optional] PDEVICE_OBJECT      PhysicalDeviceObject,&#10;  [in]           _DEVICE_DESCRIPTION *DeviceDescription,&#10;  [out]          PULONG              NumberOfMapRegisters&#10;);">IoGetDmaAdapter</a> routine.</p>

<h3 id="maximumaddress-in-optional"><code>MaximumAddress</code> [in, optional]</h3>

<p>A pointer to a variable that contains the maximum logical address for the common buffer. This parameter indicates that the buffer should be allocated from memory below this address. This parameter is optional and can be specified as NULL to indicate that there is no maximum address.</p>

<h3 id="length-in"><code>Length</code> [in]</h3>

<p>The size, in bytes, of the common buffer that is to be allocated for the DMA operation.</p>

<h3 id="logicaladdress-out"><code>LogicalAddress</code> [out]</h3>

<p>A pointer to a variable into which this routine writes the logical address that the device can use to access the common buffer. The DMA device should use this logical address instead of the physical address that is returned by a routine such as <a href="mmgetphysicaladdress" title="PHYSICAL_ADDRESS MmGetPhysicalAddress(&#10;  [in] PVOID BaseAddress&#10;);">MmGetPhysicalAddress</a>.</p>

<h3 id="cacheenabled-in"><code>CacheEnabled</code> [in]</h3>

<p>Whether the routine must enable or disable cached memory in the common buffer that is to be allocated. If TRUE, caching is enabled. If FALSE, it is disabled. If the hardware platform does not enforce cache coherency for DMA operations, then pass FALSE. For information about this parameter on ARM or ARM 64-based processors target computers, see Remarks.</p>

<h3 id="preferrednode-in"><code>PreferredNode</code> [in]</h3>

<p>The preferred NUMA node from which the memory is to be allocated. If N is the number of NUMA nodes in a multiprocessor system, <em>PreferredNode</em> is a number in the range 0 to Nâ€“1. For a one-processor system or a non-NUMA multiprocessor system, set <em>PreferredNode</em> to zero.</p>

<h2 id="return-value">Return value</h2>

<p><strong>AllocateCommonBufferEx</strong> returns the virtual address of the memory allocated for the common buffer. If the buffer cannot be allocated, NULL is returned.</p>

<h2 id="remarks">Remarks</h2>

<p><strong>AllocateCommonBufferEx</strong> is not a system routine that can be called directly by name. This routine can be called only by pointer from the address returned in a <strong><a href="dma_operations" title="typedef struct _DMA_OPERATIONS {&#10;  ULONG                                   Size;&#10;  PPUT_DMA_ADAPTER                        PutDmaAdapter;&#10;  PALLOCATE_COMMON_BUFFER                 AllocateCommonBuffer;&#10;  PFREE_COMMON_BUFFER                     FreeCommonBuffer;&#10;  PALLOCATE_ADAPTER_CHANNEL               AllocateAdapterChannel;&#10;  PFLUSH_ADAPTER_BUFFERS                  FlushAdapterBuffers;&#10;  PFREE_ADAPTER_CHANNEL                   FreeAdapterChannel;&#10;  PFREE_MAP_REGISTERS                     FreeMapRegisters;&#10;  PMAP_TRANSFER                           MapTransfer;&#10;  PGET_DMA_ALIGNMENT                      GetDmaAlignment;&#10;  PREAD_DMA_COUNTER                       ReadDmaCounter;&#10;  PGET_SCATTER_GATHER_LIST                GetScatterGatherList;&#10;  PPUT_SCATTER_GATHER_LIST                PutScatterGatherList;&#10;  PCALCULATE_SCATTER_GATHER_LIST_SIZE     CalculateScatterGatherList;&#10;  PBUILD_SCATTER_GATHER_LIST              BuildScatterGatherList;&#10;  PBUILD_MDL_FROM_SCATTER_GATHER_LIST     BuildMdlFromScatterGatherList;&#10;  PGET_DMA_ADAPTER_INFO                   GetDmaAdapterInfo;&#10;  PGET_DMA_TRANSFER_INFO                  GetDmaTransferInfo;&#10;  PINITIALIZE_DMA_TRANSFER_CONTEXT        InitializeDmaTransferContext;&#10;...">DMA_OPERATIONS</a></strong> structure. Drivers obtain the address of this routine by calling <a href="iogetdmaadapter" title="_DMA_ADAPTER * IoGetDmaAdapter(&#10;  [in, optional] PDEVICE_OBJECT      PhysicalDeviceObject,&#10;  [in]           _DEVICE_DESCRIPTION *DeviceDescription,&#10;  [out]          PULONG              NumberOfMapRegisters&#10;);">IoGetDmaAdapter</a> with the Version member of the <em>DeviceDescription</em> parameter set to DEVICE_DESCRIPTION_VERSION3. If <strong><a href="iogetdmaadapter" title="_DMA_ADAPTER * IoGetDmaAdapter(&#10;  [in, optional] PDEVICE_OBJECT      PhysicalDeviceObject,&#10;  [in]           _DEVICE_DESCRIPTION *DeviceDescription,&#10;  [out]          PULONG              NumberOfMapRegisters&#10;);">IoGetDmaAdapter</a></strong> returns <strong>NULL</strong>, the routine is not available on your platform.</p>

<p><strong>AllocateCommonBufferEx</strong> is an extended version of the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-pallocate_common_buffer">AllocateCommonBuffer</a> routine. The following list summarizes the features that are available only in the extended version:</p>

<ul>
<li><p>The caller can specify a maximum logical address for the common buffer that is to be allocated.</p></li>
<li><p>The caller can specify a preferred NUMA node in which the common buffer is to be allocated.</p></li>
</ul>

<p>On computers with ARM or ARM 64-based processors, cache settings in the system ACPI have a higher precedence than the <em>CacheEnabled</em> parameter value passed by the driver. If the <strong>ACPI _CCA</strong> method indicates that the device is not cache coherent, the operating system disables caching even if the driver allocates cached memory with <em>CacheEnabled</em> set to TRUE.</p>

<p>On computers with ARM or ARM 64-based processors, the operating system allocates an uncached common buffer as Device Memory. For more information about the buffer, see sections A3.5.1, and A3.5.6 from the <a rel="noopener" target="_blank" href="https://developer.arm.com/documentation">ARMv7 Architecture Reference Manual</a>.</p>

<p>The processor does not permit misaligned access to Device Memory. Your driver must always access data from the common buffer by using naturally-aligned operations. Most kernel routines do not accept Device Memory as input parameters. For example, a network driver cannot pass Device Memory into <a href="ndismindicatereceivenetbufferlists" title="VOID NdisMIndicateReceiveNetBufferLists(&#10;  [in] NDIS_HANDLE      MiniportAdapterHandle,&#10;       PNET_BUFFER_LIST NetBufferList,&#10;  [in] NDIS_PORT_NUMBER PortNumber,&#10;  [in] ULONG            NumberOfNetBufferLists,&#10;  [in] ULONG            ReceiveFlags&#10;);">NdisMIndicateReceiveNetBufferLists</a>. If your driver needs to pass data from a DMA common buffer to a kernel routine, either allocate the buffer with <em>CacheEnabled</em> set to TRUE or copy the data from the uncached common buffer into a temporary pool allocation.</p>

<p>For more information about DMA operations that use a common buffer, see the following topics:</p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/wdf/using-common-buffers">Using Common Buffers</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/using-common-buffer-bus-master-dma">Using Common-Buffer Bus-Master DMA</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/using-common-buffer-system-dma">Using Common-Buffer System DMA</a></p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-pallocate_common_buffer">AllocateCommonBuffer</a></p>

<p><strong><a href="padapter_object" title="typedef struct _DMA_ADAPTER {&#10;  USHORT          Version;&#10;  USHORT          Size;&#10;  PDMA_OPERATIONS DmaOperations;&#10;} *PADAPTER_OBJECT, DMA_ADAPTER, *PDMA_ADAPTER;">DMA_ADAPTER</a></strong></p>

<p><strong><a href="dma_operations" title="typedef struct _DMA_OPERATIONS {&#10;  ULONG                                   Size;&#10;  PPUT_DMA_ADAPTER                        PutDmaAdapter;&#10;  PALLOCATE_COMMON_BUFFER                 AllocateCommonBuffer;&#10;  PFREE_COMMON_BUFFER                     FreeCommonBuffer;&#10;  PALLOCATE_ADAPTER_CHANNEL               AllocateAdapterChannel;&#10;  PFLUSH_ADAPTER_BUFFERS                  FlushAdapterBuffers;&#10;  PFREE_ADAPTER_CHANNEL                   FreeAdapterChannel;&#10;  PFREE_MAP_REGISTERS                     FreeMapRegisters;&#10;  PMAP_TRANSFER                           MapTransfer;&#10;  PGET_DMA_ALIGNMENT                      GetDmaAlignment;&#10;  PREAD_DMA_COUNTER                       ReadDmaCounter;&#10;  PGET_SCATTER_GATHER_LIST                GetScatterGatherList;&#10;  PPUT_SCATTER_GATHER_LIST                PutScatterGatherList;&#10;  PCALCULATE_SCATTER_GATHER_LIST_SIZE     CalculateScatterGatherList;&#10;  PBUILD_SCATTER_GATHER_LIST              BuildScatterGatherList;&#10;  PBUILD_MDL_FROM_SCATTER_GATHER_LIST     BuildMdlFromScatterGatherList;&#10;  PGET_DMA_ADAPTER_INFO                   GetDmaAdapterInfo;&#10;  PGET_DMA_TRANSFER_INFO                  GetDmaTransferInfo;&#10;  PINITIALIZE_DMA_TRANSFER_CONTEXT        InitializeDmaTransferContext;&#10;...">DMA_OPERATIONS</a></strong></p>

<p><a href="iogetdmaadapter" title="_DMA_ADAPTER * IoGetDmaAdapter(&#10;  [in, optional] PDEVICE_OBJECT      PhysicalDeviceObject,&#10;  [in]           _DEVICE_DESCRIPTION *DeviceDescription,&#10;  [out]          PULONG              NumberOfMapRegisters&#10;);">IoGetDmaAdapter</a></p>

<p><a href="mmgetphysicaladdress" title="PHYSICAL_ADDRESS MmGetPhysicalAddress(&#10;  [in] PVOID BaseAddress&#10;);">MmGetPhysicalAddress</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-pallocate_common_buffer_ex">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/nc-wdm-pallocate_common_buffer_ex.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
