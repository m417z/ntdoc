<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="CcPreparePinWrite - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>CcPreparePinWrite - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            CcPreparePinWrite - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">BOOLEAN CcPreparePinWrite(
  [in]  <a href="file_object" title="typedef struct _FILE_OBJECT {&#10;  CSHORT                                Type;&#10;  CSHORT                                Size;&#10;  PDEVICE_OBJECT                        DeviceObject;&#10;  PVPB                                  Vpb;&#10;  PVOID                                 FsContext;&#10;  PVOID                                 FsContext2;&#10;  PSECTION_OBJECT_POINTERS              SectionObjectPointer;&#10;  PVOID                                 PrivateCacheMap;&#10;  NTSTATUS                              FinalStatus;&#10;  struct _FILE_OBJECT                   *RelatedFileObject;&#10;  BOOLEAN                               LockOperation;&#10;  BOOLEAN                               DeletePending;&#10;  BOOLEAN                               ReadAccess;&#10;  BOOLEAN                               WriteAccess;&#10;  BOOLEAN                               DeleteAccess;&#10;  BOOLEAN                               SharedRead;&#10;  BOOLEAN                               SharedWrite;&#10;  BOOLEAN                               SharedDelete;&#10;  ULONG                                 Flags;&#10;...">PFILE_OBJECT</a>   FileObject,
  [in]  PLARGE_INTEGER FileOffset,
  [in]  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>          Length,
  [in]  BOOLEAN        Zero,
  [in]  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>          Flags,
  [out] PVOID          *Bcb,
  [out] PVOID          *Buffer
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ccpreparepinwrite">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ccpreparepinwrite.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ntifs-ccpreparepinwrite)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1>CcPreparePinWrite function</h1>

<h2>Description</h2>

<p>The <strong>CcPreparePinWrite</strong> routine pins the specified byte range of a cached file for write access.</p>

<h2>Parameters</h2>

<h3><code>FileObject</code> [in]</h3>

<p>Pointer to a file object for the cached file to which the data is to be written.</p>

<h3><code>FileOffset</code> [in]</h3>

<p>Pointer to a variable that specifies the starting byte offset within the file where the data is to be written.</p>

<h3><code>Length</code> [in]</h3>

<p>Length of desired data in bytes.</p>

<h3><code>Zero</code> [in]</h3>

<p>Set to <strong>TRUE</strong> if the buffer is to be zeroed on return. This parameter is ignored if the PIN_CALLER_TRACKS_DIRTY_DATA flag is set in the <em>Flags</em> parameter.</p>

<h3><code>Flags</code> [in]</h3>

<p>Bitmask of flags specifying how the pinning operation is to be performed. ORed combination of one or more of the following values:</p>

<table>
<thead>
<tr>
  <th>Value</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td>PIN_WAIT</td>
  <td>The caller can be put into a wait state until the data has been pinned.</td>
</tr>
<tr>
  <td>PIN_EXCLUSIVE</td>
  <td>The buffer control block (BCB) is to be acquired exclusively.</td>
</tr>
<tr>
  <td>PIN_NO_READ</td>
  <td>Only pages that are already resident in memory are to be pinned. If this flag is set, PIN_WAIT must also be set.</td>
</tr>
<tr>
  <td>PIN_IF_BCB</td>
  <td>The data is to be pinned only if a BCB already exists. Otherwise, the pin fails and no BCB is returned.</td>
</tr>
<tr>
  <td>PIN_CALLER_TRACKS_DIRTY_DATA</td>
  <td>The caller is responsible for keeping track of dirty pages. If this flag is set, all other flags are ignored. This flag is available on Microsoft Windows Server 2003 SP1 and later.</td>
</tr>
</tbody>
</table>

<h3><code>Bcb</code> [out]</h3>

<p>Opaque pointer to a pinned buffer control block (BCB). This pointer must be supplied as input on any subsequent calls to <strong>CcPreparePinWrite</strong> or <a href="ccunpindata" title="VOID CcUnpinData(&#10;  [in] PVOID Bcb&#10;);">CcUnpinData</a> for this buffer.</p>

<h3><code>Buffer</code> [out]</h3>

<p>Returns pointer to desired data, valid until the buffer is unpinned or freed.</p>

<h2>Return value</h2>

<p><strong>CcPreparePinWrite</strong> returns <strong>TRUE</strong> if the cached file was pinned successfully, <strong>FALSE</strong> otherwise.</p>

<h2>Remarks</h2>

<p><strong>CcPreparePinWrite</strong> pins the specified file pages in the system cache. Pages to be completely overwritten may be satisfied with pages of zeros.</p>

<p>If the PIN_WAIT flag is set, <strong>CcPreparePinWrite</strong> is guaranteed to complete the preparation request and return <strong>TRUE</strong>. If all of the pages can be prepared immediately, no blocking occurs. If any needed pages are not resident, the caller is put in a wait state until all required pages have been made resident and the pages can be prepared. If the PIN_WAIT flag is not set, but not all of the pages can be prepared immediately, <strong>CcPreparePinWrite</strong> returns <strong>FALSE</strong>, and its output parameter values are meaningless.</p>

<p><strong>Microsoft Windows Server 2003 SP1 and later:</strong> The PIN_CALLER_TRACKS_DIRTY_DATA flag is commonly used in cases where a file system is managing a log file that is written to but not read from. Because the existing file data will be overwritten and not read, the cache manager may return pages of zeros instead of faulting in the actual pages of file data from disk. If this flag is set, the cache manager does not keep track of dirty pages. The caller is responsible for keeping track of any dirty pages. Note that <strong>CcPreparePinWrite</strong> should only be used to pin data in this manner if the buffer will eventually be flushed to disk. Before calling <a href="ccflushcache" title="VOID CcFlushCache(&#10;  [in]            PSECTION_OBJECT_POINTERS SectionObjectPointer,&#10;  [in, optional]  PLARGE_INTEGER           FileOffset,&#10;  [in]            ULONG                    Length,&#10;  [out, optional] PIO_STATUS_BLOCK         IoStatus&#10;);">CcFlushCache</a> to flush the buffer to disk, the caller must first call <a href="mmsetaddressrangemodified" title="BOOLEAN MmSetAddressRangeModified(&#10;  [in] PVOID  Address,&#10;  [in] SIZE_T Length&#10;);">MmSetAddressRangeModified</a> to notify the memory manager that the specified pages in the system cache buffer are dirty and should be written.</p>

<p>Every successful call to <strong>CcPreparePinWrite</strong> must be matched by a subsequent call to <a href="ccunpindata" title="VOID CcUnpinData(&#10;  [in] PVOID Bcb&#10;);">CcUnpinData</a>. If <strong>CcPreparePinWrite</strong> is called multiple times for the same data, <strong><a href="ccunpindata" title="VOID CcUnpinData(&#10;  [in] PVOID Bcb&#10;);">CcUnpinData</a></strong> must be called the same number of times.</p>

<p>The pointer returned in <em>Buffer</em> is valid until <a href="ccunpindata" title="VOID CcUnpinData(&#10;  [in] PVOID Bcb&#10;);">CcUnpinData</a> is called. If <a href="ccpinmappeddata" title="BOOLEAN CcPinMappedData(&#10;  [in]      PFILE_OBJECT   FileObject,&#10;  [in]      PLARGE_INTEGER FileOffset,&#10;  [in]      ULONG          Length,&#10;  [in]      ULONG          Flags,&#10;  [in, out] PVOID          *Bcb&#10;);">CcPinMappedData</a> is called while this pointer is still valid, the pointer remains valid after the call to <strong><a href="ccpinmappeddata" title="BOOLEAN CcPinMappedData(&#10;  [in]      PFILE_OBJECT   FileObject,&#10;  [in]      PLARGE_INTEGER FileOffset,&#10;  [in]      ULONG          Length,&#10;  [in]      ULONG          Flags,&#10;  [in, out] PVOID          *Bcb&#10;);">CcPinMappedData</a></strong> (but only until <strong><a href="ccunpindata" title="VOID CcUnpinData(&#10;  [in] PVOID Bcb&#10;);">CcUnpinData</a></strong> is called).</p>

<p><strong>CcPreparePinWrite</strong> cannot pin data across view boundaries in the cache manager. The cache manager manages files in the system in 256 KB-aligned views. (The cache manager's view size is specified by the system-defined constant VACB_MAPPING_GRANULARITY, which is set to 256 KB in ntifs.h.) Pinned regions cannot span more than one 256 KB view. Therefore, the largest region that can be pinned is 256 KB, beginning at a 256 KB-aligned offset in the file.</p>

<p>Pinning a byte range in a cached file does not ensure that the pages remain resident in memory. As long as the pages are pinned, the byte range is guaranteed to stay mapped into the system cache virtual address space, but the memory manager can page out the physical pages as the system's memory demand requires.</p>

<p>It is not necessary to call <a href="ccsetdirtypinneddata" title="VOID CcSetDirtyPinnedData(&#10;  [in]           PVOID          BcbVoid,&#10;  [in, optional] PLARGE_INTEGER Lsn&#10;);">CcSetDirtyPinnedData</a> after calling <strong>CcPreparePinWrite</strong>. If <strong>CcPreparePinWrite</strong> returns <strong>TRUE</strong>, the BCB is already marked as dirty.</p>

<p>If any failure occurs, <strong>CcPreparePinWrite</strong> raises a status exception for that particular failure. For example, if a pool allocation failure occurs, <strong>CcPreparePinWrite</strong> raises a STATUS_INSUFFICIENT_RESOURCES exception; if an I/O error occurs, <strong>CcPreparePinWrite</strong> raises the status exception of the I/O error. Therefore, to gain control if a failure occurs, the driver should wrap the call to <strong>CcPreparePinWrite</strong> in a <strong>try-except</strong> or <strong>try-finally</strong> statement.</p>

<h2>See also</h2>

<p><a href="ccflushcache" title="VOID CcFlushCache(&#10;  [in]            PSECTION_OBJECT_POINTERS SectionObjectPointer,&#10;  [in, optional]  PLARGE_INTEGER           FileOffset,&#10;  [in]            ULONG                    Length,&#10;  [out, optional] PIO_STATUS_BLOCK         IoStatus&#10;);">CcFlushCache</a></p>

<p><a href="ccmapdata" title="BOOLEAN CcMapData(&#10;  [in]  PFILE_OBJECT   FileObject,&#10;  [in]  PLARGE_INTEGER FileOffset,&#10;  [in]  ULONG          Length,&#10;  [in]  ULONG          Flags,&#10;  [out] PVOID          *Bcb,&#10;  [out] PVOID          *Buffer&#10;);">CcMapData</a></p>

<p><a href="ccpinmappeddata" title="BOOLEAN CcPinMappedData(&#10;  [in]      PFILE_OBJECT   FileObject,&#10;  [in]      PLARGE_INTEGER FileOffset,&#10;  [in]      ULONG          Length,&#10;  [in]      ULONG          Flags,&#10;  [in, out] PVOID          *Bcb&#10;);">CcPinMappedData</a></p>

<p><a href="ccpinread" title="BOOLEAN CcPinRead(&#10;  [in]  PFILE_OBJECT   FileObject,&#10;  [in]  PLARGE_INTEGER FileOffset,&#10;  [in]  ULONG          Length,&#10;  [in]  ULONG          Flags,&#10;  [out] PVOID          *Bcb,&#10;  [out] PVOID          *Buffer&#10;);">CcPinRead</a></p>

<p><a href="ccsetdirtypinneddata" title="VOID CcSetDirtyPinnedData(&#10;  [in]           PVOID          BcbVoid,&#10;  [in, optional] PLARGE_INTEGER Lsn&#10;);">CcSetDirtyPinnedData</a></p>

<p><a href="ccunpindata" title="VOID CcUnpinData(&#10;  [in] PVOID Bcb&#10;);">CcUnpinData</a></p>

<p><a href="mmsetaddressrangemodified" title="BOOLEAN MmSetAddressRangeModified(&#10;  [in] PVOID  Address,&#10;  [in] SIZE_T Length&#10;);">MmSetAddressRangeModified</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ccpreparepinwrite">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/nf-ntifs-ccpreparepinwrite.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
