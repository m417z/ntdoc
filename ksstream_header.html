<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="KSSTREAM_HEADER - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>KSSTREAM_HEADER - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            KSSTREAM_HEADER - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ks.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">typedef struct {
  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>    Size;
  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>    TypeSpecificFlags;
  <a href="kstime" title="typedef struct {&#10;  LONGLONG Time;&#10;  ULONG    Numerator;&#10;  ULONG    Denominator;&#10;} KSTIME, *PKSTIME;">KSTIME</a>   PresentationTime;
  <a href="longlong" title="typedef __int64 LONGLONG;">LONGLONG</a> Duration;
  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>    FrameExtent;
  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>    DataUsed;
  PVOID    Data;
  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>    OptionsFlags;
  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>    Reserved;
} KSSTREAM_HEADER, *PKSSTREAM_HEADER;</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ks/ns-ks-ksstream_header">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ksstream_header.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ns-ks-ksstream_header)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="ksstream_header-structure">KSSTREAM_HEADER structure</h1>

<h2 id="description">Description</h2>

<p>The KSSTREAM_HEADER structure is a variable-length structure that describes a packet of data to be read from or written to a streaming driver pin.</p>

<h2 id="members">Members</h2>

<h3 id="size"><code>Size</code></h3>

<p>Specifies the size, in bytes, of the structure. This should be at least <strong>sizeof</strong>(KSSTREAM_HEADER).</p>

<h3 id="typespecificflags"><code>TypeSpecificFlags</code></h3>

<p>Specifies flags that are specific to a data format. The only flag currently supported for <em>TypeSpecificFlags</em> is KS_AM_UseNewCSSKey. This flag indicates that the hardware decoder should switch to the next queued CSS (Content Scramble System) decryption key, because the data sample that immediately follows the header is the first data sample to which a new title key applies.</p>

<h3 id="presentationtime"><code>PresentationTime</code></h3>

<p>A <a href="kstime" title="typedef struct {&#10;  LONGLONG Time;&#10;  ULONG    Numerator;&#10;  ULONG    Denominator;&#10;} KSTIME, *PKSTIME;">KSTIME</a> structure that specifies the presentation time for the related stream buffer in 100-nanosecond units. For more information, see the <strong>Remarks</strong> section.</p>

<h3 id="duration"><code>Duration</code></h3>

<p>Specifies the duration of this stream segment in the same units as the presentation time (100-nanosecond units). Set to zero when not used.</p>

<h3 id="frameextent"><code>FrameExtent</code></h3>

<p>Specifies the size of the entire frame. The region within the frame extent is available to the filter, and the resulting valid data size for the stream operation is reflected in the <strong>DataUsed</strong> member.</p>

<h3 id="dataused"><code>DataUsed</code></h3>

<p>For a write operation, this member specifies the number of bytes within the frame that are valid when submitting a frame to a lower-level driver. The headers are not modified on a write operation; however, the <strong>Information</strong> member of the <a href="io_status_block" title="typedef struct _IO_STATUS_BLOCK&#10;{&#10;    union&#10;    {&#10;        NTSTATUS Status;&#10;        PVOID Pointer;&#10;    };&#10;    ULONG_PTR Information;&#10;} IO_STATUS_BLOCK, *PIO_STATUS_BLOCK;">IO_STATUS_BLOCK</a> structure contains the total number of bytes actually written. For a read operation, this member is not used when submitting a frame to a lower-level driver and must be set to zero. On return, this member contains the number of bytes actually filled in this frame and the <strong>Information</strong> member of the <a href="io_status_block" title="typedef struct _IO_STATUS_BLOCK&#10;{&#10;    union&#10;    {&#10;        NTSTATUS Status;&#10;        PVOID Pointer;&#10;    };&#10;    ULONG_PTR Information;&#10;} IO_STATUS_BLOCK, *PIO_STATUS_BLOCK;">IO_STATUS_BLOCK</a> structure contains the size of the list of headers actually used. Note that if the minidriver specifies KSPIN_FLAG_GENERATE_MAPPINGS in <a href="kspin_descriptor_ex" title="typedef struct _KSPIN_DESCRIPTOR_EX {&#10;  const KSPIN_DISPATCH         *Dispatch;&#10;  const KSAUTOMATION_TABLE     *AutomationTable;&#10;  KSPIN_DESCRIPTOR             PinDescriptor;&#10;  ULONG                        Flags;&#10;  ULONG                        InstancesPossible;&#10;  ULONG                        InstancesNecessary;&#10;  const KSALLOCATOR_FRAMING_EX *AllocatorFraming;&#10;  PFNKSINTERSECTHANDLEREX      IntersectHandler;&#10;} KSPIN_DESCRIPTOR_EX, *PKSPIN_DESCRIPTOR_EX;">KSPIN_DESCRIPTOR_EX</a>, when a stream pointer is advanced past a frame, <strong>DataUsed</strong> is set to <strong>Count</strong> minus <strong>Remaining</strong> (members of <a href="ksstream_pointer_offset" title="typedef struct _KSSTREAM_POINTER_OFFSET {&#10;  union {&#10;    PUCHAR     Data;&#10;    PKSMAPPING Mappings;&#10;  };&#10;  PUCHAR Data;&#10;  PVOID  Alignment;&#10;  ULONG  Count;&#10;  ULONG  Remaining;&#10;} KSSTREAM_POINTER_OFFSET, *PKSSTREAM_POINTER_OFFSET;">KSSTREAM_POINTER_OFFSET</a>). If the driver does not specify this flag, the minidriver is responsible for setting <strong>DataUsed</strong>.</p>

<h3 id="data"><code>Data</code></h3>

<p>Specifies the virtual address of the data buffer.</p>

<h3 id="optionsflags"><code>OptionsFlags</code></h3>

<p>Specifies a variety of attributes of the data stream. The <strong>OptionsFlags</strong> member can have the values listed in the following table.</p>

<table>
<thead>
<tr>
  <th>Value</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_DATADISCONTINUITY</td>
  <td>Specifies that there has been a discontinuity in the data stream before the data that is contained in this packet. This implies that the filter might need to reset its internal state before processing the data. No actual data buffer need be attached.</td>
</tr>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_DURATIONVALID</td>
  <td>Specifies that the <strong>Duration</strong> member of this structure is valid.</td>
</tr>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_ENDOFPHOTOSEQUENCE</td>
  <td>Indicates that this frame represents the end of a photo sequence.</td>
</tr>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_ENDOFSTREAM</td>
  <td>Indicates that this frame represents the end of the data stream.</td>
</tr>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_FLUSHONPAUSE</td>
  <td>If the stream is paused, this buffer should be flushed. This flag is used, for example, by live data sources, where a pause renders the current data stale.</td>
</tr>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_FRAMEINFO</td>
  <td>Indicates that there is a <a href="ks_frame_info" title="typedef struct tagKS_FRAME_INFO {&#10;  ULONG    ExtendedHeaderSize;&#10;  DWORD    dwFrameFlags;&#10;  LONGLONG PictureNumber;&#10;  LONGLONG DropCount;&#10;  HANDLE   hDirectDraw;&#10;  HANDLE   hSurfaceHandle;&#10;  RECT     DirectDrawRect;&#10;  union {&#10;    LONG  lSurfacePitch;&#10;    DWORD Reserved1;&#10;  };&#10;  DWORD    Reserved2;&#10;  union {&#10;    struct {&#10;      DWORD Reserved3;&#10;      DWORD Reserved4;&#10;    };&#10;    ULONGLONG FrameCompletionNumber;&#10;  };&#10;...">KS_FRAME_INFO</a> structure following KSSTREAM_HEADER.</td>
</tr>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_LOOPEDDATA</td>
  <td>This data buffer is the start of looped data. The driver should loop on this data until explicitly stopped.</td>
</tr>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_METADATA</td>
  <td>Indicates that there is a <a href="ksstream_metadata_info" title="typedef struct {&#10;  ULONG BufferSize;&#10;  ULONG UsedSize;&#10;  PVOID Data;&#10;  PVOID SystemVa;&#10;  ULONG Flags;&#10;  ULONG Reserved;&#10;} KSSTREAM_METADATA_INFO, *PKSSTREAM_METADATA_INFO;">KSSTREAM_METADATA_INFO</a> that follows <a href="ks_frame_info" title="typedef struct tagKS_FRAME_INFO {&#10;  ULONG    ExtendedHeaderSize;&#10;  DWORD    dwFrameFlags;&#10;  LONGLONG PictureNumber;&#10;  LONGLONG DropCount;&#10;  HANDLE   hDirectDraw;&#10;  HANDLE   hSurfaceHandle;&#10;  RECT     DirectDrawRect;&#10;  union {&#10;    LONG  lSurfacePitch;&#10;    DWORD Reserved1;&#10;  };&#10;  DWORD    Reserved2;&#10;  union {&#10;    struct {&#10;      DWORD Reserved3;&#10;      DWORD Reserved4;&#10;    };&#10;    ULONGLONG FrameCompletionNumber;&#10;  };&#10;...">KS_FRAME_INFO</a> after the KSSTREAM_HEADER. This flag is present only if KSPROPERTY_CAMERACONTROL_EXTENDED_METADATA is supported.</td>
</tr>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_PREROLL</td>
  <td>The data in this buffer is used to prime the device state. This is a stream-specific option.</td>
</tr>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_SPLICEPOINT</td>
  <td>The data stream is at a natural point for splicing. A client uses this, for example, when sending data that uses inter-frame compression, such as MPEG video, to indicate that it is safe to splice at this point.</td>
</tr>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_TIMEDISCONTINUITY</td>
  <td>There is a discontinuity in the data stream after this packet. This flag can be used for positional oriented interfaces to indicate an end of stream data. No actual data buffer need be attached.</td>
</tr>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_TIMEVALID</td>
  <td>Specifies that the <strong>PresentationTime</strong> member of this structure is valid. Indicates that this buffer has a valid timestamp associated with it.</td>
</tr>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_TYPECHANGED</td>
  <td>Signifies that the data format for this stream has changed. If this flag is set, the <strong>Data</strong> member contains a <a href="ksdataformat" title="typedef struct {&#10;  ULONG FormatSize;&#10;  ULONG Flags;&#10;  ULONG SampleSize;&#10;  ULONG Reserved;&#10;  GUID  MajorFormat;&#10;  GUID  SubFormat;&#10;  GUID  Specifier;&#10;} KSDATAFORMAT, *PKSDATAFORMAT, KSDATARANGE, *PKSDATARANGE;">KSDATAFORMAT</a> structure that contains the new format. This flag is valid only for streams that have previously negotiated dynamic type changing. For a write operation, include the new data format in place of a media sample. If the media-specific extension size is modified, this header must be the last header in a list of headers for the given stream request. During a read request, any further I/O remains pending until the new format is retrieved through KSPROPERTY_CONNECTION_DATAFORMAT. For a write operation, the header must not be extended, and must be the only header in the write operation.</td>
</tr>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_VRAM_DATA_TRANSFER</td>
  <td>Specifies that the stream header's <em>Data</em> member points to a structure of type <a href="vram_surface_info" title="typedef struct {&#10;  UINT_PTR  hSurface;&#10;  LONGLONG  VramPhysicalAddress;&#10;  DWORD     cbCaptured;&#10;  DWORD     dwWidth;&#10;  DWORD     dwHeight;&#10;  DWORD     dwLinearSize;&#10;  LONG      lPitch;&#10;  ULONGLONG ullReserved[16];&#10;} VRAM_SURFACE_INFO, *PVRAM_SURFACE_INFO;">VRAM_SURFACE_INFO</a>. The system-supplied KS proxy module sets this flag to indicate that it is <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/stream/vram-capture-properties">capturing directly to VRAM</a>.</td>
</tr>
<tr>
  <td>KSSTREAM_HEADER_OPTIONSF_BUFFEREDTRANSFER</td>
  <td>Specifies that the <em>Data</em> member of KSSTREAM_HEADER contains a kernel-mode copy of the original buffer. Ksproxy sets this flag for small data transfers during WVDDM (Windows Vista Display Driver Model) capture. If this flag is not set, KS uses direct I/O into the <em>Data</em> buffer.</td>
</tr>
</tbody>
</table>

<h3 id="reserved"><code>Reserved</code></h3>

<p>Reserved for internal use.</p>

<h2 id="remarks">Remarks</h2>

<p>This structure can be followed in memory by additional information specific to the type of data in the data packet.</p>

<p>The presentation time is typically in 100-nanosecond units; however, the standard format of this time is based on the data format. You can normalize presentation time by using as a scaling fractional the KSSTREAM_HEADER.PresentationTime.Numerator divided by the KSSTREAM_HEADER.PresentationTime.Denominator .</p>

<p>A conversion should use the numerator first, then the denominator, in order to reduce rounding errors. For example, an audio stream might present the current time as a byte offset in the data stream:</p>

<div class="codehilite">
<pre><span></span><code><span class="cp">#define BITS_PER_BYTE8</span>
<span class="cp">#define NANOSECONDS10000000</span>

<span class="n">StreamHdr</span><span class="o">-&gt;</span><span class="n">PresentationTime</span><span class="p">.</span><span class="n">Numerator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BITS_PER_BYTE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">NANOSECONDS</span><span class="p">;</span>
<span class="n">StreamHdr</span><span class="o">-&gt;</span><span class="n">PresentationTime</span><span class="p">.</span><span class="n">Denominator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BitsPerSample</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Channels</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Frequency</span><span class="p">;</span>
<span class="n">StreamHdr</span><span class="o">-&gt;</span><span class="n">PresentationTime</span><span class="p">.</span><span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteOffset</span><span class="p">;</span>
<span class="n">StreamHdr</span><span class="o">-&gt;</span><span class="n">Duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ByteLength</span><span class="p">;</span>
</code></pre>
</div>

<p>On an <a href="ioctl_ks_read_stream" title="// CTL_CODE(0x002f, 0x005, METHOD_NEITHER, FILE_READ_ACCESS)&#10;#define IOCTL_KS_READ_STREAM 0x002F4017">IOCTL_KS_READ_STREAM</a>, portions of the stream header are filled in by the call. Each KSSTREAM_HEADER.DataUsed element contains the actual number of bytes read, which is less than or equal to each KSSTREAM_HEADER.FrameExtent. The pIrp->IoStatus.Information element contains the total size of the header data to return, which is at least one <strong>sizeof</strong>(KSSTREAM_HEADER).</p>

<p>On an <a href="ioctl_ks_write_stream" title="// CTL_CODE(0x002f, 0x004, METHOD_NEITHER, FILE_WRITE_ACCESS)&#10;#define IOCTL_KS_WRITE_STREAM 0x002F8013">IOCTL_KS_WRITE_STREAM</a>, the member elements must be initialized, and each KSSTREAM_HEADER.DataUsed element contains the number of bytes to write. The actual number of total bytes written is returned in pIrp->IoStatus.Information. This is less than or equal to the total of all KSSTREAM_HEADER.DataUsed elements in the headers.</p>

<p>If you are using the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ks/nn-ks-iksreferenceclock">IKsReferenceClock</a> interface to obtain timestamps to place in the <strong>PresentationTime</strong> member of KSSTREAM_HEADER, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/stream/avstream-clocks">AVStream Clocks</a> for more information.</p>

<h2 id="see-also">See also</h2>

<p><a href="ksdataformat" title="typedef struct {&#10;  ULONG FormatSize;&#10;  ULONG Flags;&#10;  ULONG SampleSize;&#10;  ULONG Reserved;&#10;  GUID  MajorFormat;&#10;  GUID  SubFormat;&#10;  GUID  Specifier;&#10;} KSDATAFORMAT, *PKSDATAFORMAT, KSDATARANGE, *PKSDATARANGE;">KSDATAFORMAT</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ks/ns-ks-ksstream_header">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ks/ns-ks-ksstream_header.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
