<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="NtFreeVirtualMemory - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>NtFreeVirtualMemory - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            NtFreeVirtualMemory - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">#ifndef _NTMMAPI_H
//
// Virtual memory
//
#if (PHNT_MODE != PHNT_MODE_KERNEL)

</span><span class="ntdoc-code-intro">/**
 * The NtFreeVirtualMemory routine frees virtual memory allocated for a process.
 *
 * \param ProcessHandle A handle to the process whose virtual memory is to be freed.
 * \param BaseAddress A pointer to the base address of the region of pages to be freed.
 * \param RegionSize A pointer to a variable that specifies the size of the region of memory to be freed.
 * \param FreeType The type of free operation. This parameter can be <a href="mem_decommit" title="#define MEM_DECOMMIT 0x00004000">MEM_DECOMMIT</a> or <a href="mem_release" title="#define MEM_RELEASE 0x00008000">MEM_RELEASE</a>.
 * \return <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> Successful or errant status.
 */
</span><span class="ntdoc-code-body">NTSYSCALLAPI
<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a>
NTAPI
NtFreeVirtualMemory(
    _In_ HANDLE ProcessHandle,
    _Inout_ __drv_freesMem(Mem) PVOID *BaseAddress,
    _Inout_ PSIZE_T RegionSize,
    _In_ <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> FreeType
    );
</span><span class="ntdoc-code-footer">
#endif
#endif
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://github.com/winsiderss/systeminformer/blob/3d935379c6ac1f147cc4e3b25bed778f0d140c69/phnt/include/ntmmapi.h#L775">View code on GitHub</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">#ifndef _NTZWAPI_H

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">NTSYSCALLAPI
<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a>
NTAPI
ZwFreeVirtualMemory(
    _In_ HANDLE ProcessHandle,
    _Inout_ __drv_freesMem(Mem) PVOID *BaseAddress,
    _Inout_ PSIZE_T RegionSize,
    _In_ <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> FreeType
    );
</span><span class="ntdoc-code-footer">
#endif
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://github.com/winsiderss/systeminformer/blob/3d935379c6ac1f147cc4e3b25bed778f0d140c69/phnt/include/ntzwapi.h#L1938">View code on GitHub</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">__kernel_entry NTSYSCALLAPI <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> NtFreeVirtualMemory(
  [in]      HANDLE  ProcessHandle,
  [in, out] PVOID   *BaseAddress,
  [in, out] PSIZE_T RegionSize,
  [in]      <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>   FreeType
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntfreevirtualmemory">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">NTSYSAPI <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> ZwFreeVirtualMemory(
  [in]      HANDLE  ProcessHandle,
  [in, out] PVOID   *BaseAddress,
  [in, out] PSIZE_T RegionSize,
  [in]      <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>   FreeType
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-zwfreevirtualmemory">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ntfreevirtualmemory.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ntifs-ntfreevirtualmemory)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="ntfreevirtualmemory-function">NtFreeVirtualMemory function</h1>

<h2 id="description">Description</h2>

<p>The <strong>NtFreeVirtualMemory</strong> routine releases, decommits, or both releases and decommits, a region of pages within the virtual address space of a specified process.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="processhandle-in"><code>ProcessHandle</code> [in]</h3>

<p>A handle for the process in whose context the pages to be freed reside. Use the <strong><a href="ntcurrentprocess" title="#define NtCurrentProcess() ((HANDLE)(LONG_PTR)-1)">NtCurrentProcess</a></strong> macro, defined in <em>Ntddk.h</em>, to specify the current process.</p>

<h3 id="baseaddress-in-out"><code>BaseAddress</code> [in, out]</h3>

<p>A pointer to a variable that will receive the base virtual address of the freed region of pages.</p>

<p>If the <a href="mem_release" title="#define MEM_RELEASE 0x00008000">MEM_RELEASE</a> flag is set in the <em>FreeType</em> parameter, <em>*BaseAddress</em> must be the base address returned by <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">NtAllocateVirtualMemory</a></strong> when the region was reserved.</p>

<h3 id="regionsize-in-out"><code>RegionSize</code> [in, out]</h3>

<p>A pointer to a variable that will receive the actual size, in bytes, of the freed region of pages. The routine rounds the initial value of this variable up to the next host page size boundary and writes the rounded value back to this variable.</p>

<p>If the <a href="mem_release" title="#define MEM_RELEASE 0x00008000">MEM_RELEASE</a> flag is set in <em>*FreeType</em>, <em>*RegionSize</em> must be zero. <strong>NtFreeVirtualMemory</strong> frees the entire region that was reserved in the initial allocation call to <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">NtAllocateVirtualMemory</a></strong>.</p>

<p>If the <a href="mem_decommit" title="#define MEM_DECOMMIT 0x00004000">MEM_DECOMMIT</a> flag is set in <em>*FreeType</em>, <strong>NtFreeVirtualMemory</strong> decommits all memory pages that contain one or more bytes in the range from <em>*BaseAddress</em> to (<em>*BaseAddress</em> + <em>*RegionSize</em>). This means, for example, that if a two-byte region of memory straddles a page boundary, both pages are decommitted.</p>

<p><strong>NtFreeVirtualMemory</strong> decommits the entire region that was reserved by <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">NtAllocateVirtualMemory</a></strong>. If the following three conditions are met, the entire region enters the reserved state:</p>

<ul>
<li>The <a href="mem_decommit" title="#define MEM_DECOMMIT 0x00004000">MEM_DECOMMIT</a> flag is set.</li>
<li><em>*BaseAddress</em> is the base address returned by <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">NtAllocateVirtualMemory</a></strong> when the region was reserved.</li>
<li><em>*RegionSize</em> is zero.</li>
</ul>

<h3 id="freetype-in"><code>FreeType</code> [in]</h3>

<p>A bitmask containing flags that describe the type of free operation that <strong>NtFreeVirtualMemory</strong> will perform for the specified region of pages. The possible values are listed in the following table.</p>

<table>
<thead>
<tr>
  <th>Flag</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td><a href="mem_decommit" title="#define MEM_DECOMMIT 0x00004000">MEM_DECOMMIT</a></td>
  <td><strong>NtFreeVirtualMemory</strong> will decommit the specified region of pages. The pages enter the reserved state. <strong>NtFreeVirtualMemory</strong> doesn't fail if you attempt to decommit an uncommitted page. This means that you can decommit a range of pages without first determining their current commitment state.</td>
</tr>
<tr>
  <td><a href="mem_release" title="#define MEM_RELEASE 0x00008000">MEM_RELEASE</a></td>
  <td><strong>NtFreeVirtualMemory</strong> will release the specified region of pages. The pages enter the free state. If you specify this flag, <strong>RegionSize</strong> must be zero, and <strong>BaseAddress</strong> must point to the base address returned by <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">NtAllocateVirtualMemory</a></strong> when the region was reserved. <strong>NtFreeVirtualMemory</strong> fails if either of these conditions is not met. If any pages in the region are currently committed, <strong>NtFreeVirtualMemory</strong> first decommits and then releases them. <strong>NtFreeVirtualMemory</strong> doesn't fail if you attempt to release pages that are in different states, some reserved and some committed. This means that you can release a range of pages without first determining their current commitment state.</td>
</tr>
</tbody>
</table>

<h2 id="return-value">Return value</h2>

<p><strong>NtFreeVirtualMemory</strong> returns either <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> or an error status code. Possible error status codes include the following.</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>STATUS_ACCESS_DENIED</strong></td>
  <td>A process has requested access to an object, but has not been granted those access rights.</td>
</tr>
<tr>
  <td><strong>STATUS_INVALID_HANDLE</strong></td>
  <td>An invalid <em>ProcessHandle</em> value was specified.</td>
</tr>
<tr>
  <td><strong>STATUS_OBJECT_TYPE_MISMATCH</strong></td>
  <td>There is a mismatch between the type of object required by the requested operation and the type of object that is specified in the request.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>Each page in the process's virtual address space is in one of the three states described in the following table.</p>

<table>
<thead>
<tr>
  <th>State</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td>FREE</td>
  <td>The page is neither committed nor reserved. The page is not accessible to the process. Attempting to read from or write to a free page results in an access violation exception. You can use <strong>NtFreeVirtualMemory</strong> to put reserved or committed pages into the free state.</td>
</tr>
<tr>
  <td>RESERVED</td>
  <td>The page is reserved. The range of addresses cannot be used by other allocation functions. The page is not accessible to the process and has no physical storage associated with it. Attempting to read from or write to a reserved page results in an access violation exception. You can use <strong>NtFreeVirtualMemory</strong> to put committed memory pages into the reserved state, and to put reserved memory pages into the free state.</td>
</tr>
<tr>
  <td>COMMITTED</td>
  <td>The page is committed. Physical storage in memory or in the paging file on disk is allocated for the page, and access is controlled by a protection code. The system initializes and loads each committed page into physical memory only at the first attempt to read from or write to that page. When a process terminates, the system releases all storage for committed pages. You can use <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">NtAllocateVirtualMemory</a></strong> to put committed memory pages into either the reserved or free state.</td>
</tr>
</tbody>
</table>

<p><strong>NtFreeVirtualMemory</strong> can perform the following operations:</p>

<ul>
<li>Decommit a region of committed or uncommitted pages. After this operation, the pages are in the reserved state.</li>
<li>Release a region of reserved pages. After this operation, the pages are in the free state.</li>
<li>Decommit and release a region of committed or uncommitted pages. After this operation, the pages are in the free state.</li>
</ul>

<p><strong>NtFreeVirtualMemory</strong> can decommit a range of pages that are in different states, some committed and some uncommitted. This means that you can decommit a range of pages without first determining the current commitment state of each page. Decommitting a page releases its physical storage, either in memory or in the paging file on disk.</p>

<p>If a page is decommitted but not released, its state changes to reserved. You can subsequently call <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">NtAllocateVirtualMemory</a></strong> to commit it, or <strong>NtFreeVirtualMemory</strong> to release it. Attempting to read from or write to a reserved page results in an access violation exception.</p>

<p><strong>NtFreeVirtualMemory</strong> can release a range of pages that are in different states, some reserved and some committed. This means that you can release a range of pages without first determining the current commitment state of each page. The entire range of pages originally reserved by <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">NtAllocateVirtualMemory</a></strong> must be released at the same time.</p>

<p>If a page is released, its state changes to free, and it is available for subsequent allocation operations. After memory has been released or decommitted, you can never refer to the memory again. Any information that may have been in that memory is gone forever. Attempting to read from or write to a free page results in an access violation exception. If you require information, do not decommit or free memory that contains that information.</p>

<p>For more information about memory management support for kernel-mode drivers, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/managing-memory-for-drivers">Memory Management for Windows Drivers</a>.</p>

<blockquote>
  <p>[!NOTE]
  If the call to the <strong>NtFreeVirtualMemory</strong> function occurs in user mode, you should use the name "<strong>NtFreeVirtualMemory</strong>" instead of "<strong>ZwFreeVirtualMemory</strong>".</p>
</blockquote>

<p>For calls from kernel-mode drivers, the <strong>Nt<em>Xxx</em></strong> and <strong>Zw<em>Xxx</em></strong> versions of a Windows Native System Services routine can behave differently in the way that they handle and interpret input parameters. For more information about the relationship between the <strong>Nt<em>Xxx</em></strong> and <strong>Zw<em>Xxx</em></strong> versions of a routine, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/using-nt-and-zw-versions-of-the-native-system-services-routines">Using Nt and Zw Versions of the Native System Services Routines</a>.</p>

<h2 id="see-also">See also</h2>

<p><strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">NtAllocateVirtualMemory</a></strong></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntfreevirtualmemory">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/nf-ntifs-ntfreevirtualmemory.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ntifs-zwfreevirtualmemory)</h1>
</div>
<div class="ntdoc-description">
<h1>ZwFreeVirtualMemory function</h1>

<h2>Description</h2>

<p>The <strong>ZwFreeVirtualMemory</strong> routine releases, decommits, or both, a region of pages within the virtual address space of a specified process.</p>

<h2>Parameters</h2>

<h3><code>ProcessHandle</code> [in]</h3>

<p>A handle for the process in whose context the pages to be freed reside. Use the <strong><a href="ntcurrentprocess" title="#define NtCurrentProcess() ((HANDLE)(LONG_PTR)-1)">NtCurrentProcess</a></strong> macro, defined in Ntddk.h, to specify the current process.</p>

<h3><code>BaseAddress</code> [in, out]</h3>

<p>A pointer to a variable that will receive the virtual address of the freed region of pages.</p>

<p>If the <a href="mem_release" title="#define MEM_RELEASE 0x00008000">MEM_RELEASE</a> flag is set in the <em>FreeType</em> parameter, <em>BaseAddress</em> must be the base address returned by <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">ZwAllocateVirtualMemory</a></strong> when the region was reserved.</p>

<h3><code>RegionSize</code> [in, out]</h3>

<p>A pointer to a variable that will receive the actual size, in bytes, of the freed region of pages. The routine rounds the initial value of this variable up to the next host page size boundary and writes the rounded value back to this variable.</p>

<p>If the <a href="mem_release" title="#define MEM_RELEASE 0x00008000">MEM_RELEASE</a> flag is set in the <em>FreeType</em> parameter, the variable pointed to by <em>RegionSize</em> must be zero. <strong>ZwFreeVirtualMemory</strong> frees the entire region that was reserved in the initial allocation call to <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">ZwAllocateVirtualMemory</a></strong>.</p>

<p>If the <a href="mem_decommit" title="#define MEM_DECOMMIT 0x00004000">MEM_DECOMMIT</a> flag is set in the <em>FreeType</em> parameter, <strong>ZwFreeVirtualMemory</strong> decommits all memory pages that contain one or more bytes in the range from the <em>BaseAddress</em> parameter to (<em>BaseAddress</em> + <em>RegionSize</em>). This means, for example, that if a two-byte region of memory straddles a page boundary, both pages are decommitted.</p>

<p><strong>ZwFreeVirtualMemory</strong> decommits the entire region that was reserved by <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">ZwAllocateVirtualMemory</a></strong>. If the following three conditions are met, the entire region enters the reserved state:</p>

<ul>
<li>The <a href="mem_decommit" title="#define MEM_DECOMMIT 0x00004000">MEM_DECOMMIT</a> flag is set.</li>
<li><em>BaseAddress</em> is the base address returned by <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">ZwAllocateVirtualMemory</a></strong> when the region was reserved.</li>
<li><em>RegionSize&lt;</em> is zero.</li>
</ul>

<h3><code>FreeType</code> [in]</h3>

<p>A bitmask that contains flags that describe the type of free operation that <strong>ZwFreeVirtualMemory</strong> will perform for the specified region of pages. Possible values are the following:</p>

<ul>
<li><p><a href="mem_decommit" title="#define MEM_DECOMMIT 0x00004000">MEM_DECOMMIT</a></p>

<ul>
<li><p><strong>ZwFreeVirtualMemory</strong> will decommit the specified region of pages. The pages enter the reserved state.</p></li>
<li><p><strong>ZwFreeVirtualMemory</strong> does not fail if you attempt to decommit an uncommitted page. This means that you can decommit a range of pages without first determining their current commitment state.</p></li>
</ul></li>
<li><p><a href="mem_release" title="#define MEM_RELEASE 0x00008000">MEM_RELEASE</a></p>

<p><strong>ZwFreeVirtualMemory</strong> will release the specified region of pages. The pages enter the free state.</p>

<p>If you specify this flag, The variable that <strong>RegionSize</strong> points to must be zero, and <strong>BaseAddress</strong> must point to the base address returned by <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">ZwAllocateVirtualMemory</a></strong> when the region was reserved. <strong>ZwFreeVirtualMemory</strong> fails if either of these conditions is not met.</p>

<p>If any pages in the region are currently committed, <strong>ZwFreeVirtualMemory</strong> first decommits and then releases them.</p></li>
</ul>

<p><strong>ZwFreeVirtualMemory</strong> does not fail if you attempt to release pages that are in different states, some reserved and some committed. This means that you can release a range of pages without first determining their current commitment state.</p>

<h2>Return value</h2>

<p><strong>ZwFreeVirtualMemory</strong> returns either <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> or an error status code. Possible error status codes include the following.</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td>STATUS_ACCESS_DENIED</td>
  <td>A process has requested access to an object, but has not been granted those access rights.</td>
</tr>
<tr>
  <td>STATUS_INVALID_HANDLE</td>
  <td>An invalid <em>ProcessHandle</em> value was specified.</td>
</tr>
<tr>
  <td>STATUS_OBJECT_TYPE_MISMATCH</td>
  <td>There is a mismatch between the type of object required by the requested operation and the type of object that is specified in the request.</td>
</tr>
</tbody>
</table>

<h2>Remarks</h2>

<p>Each page in the process's virtual address space is in one of the three states described as follows.</p>

<ul>
<li><p>State is FREE</p>

<p>The page is neither committed nor reserved. The page is not accessible to the process. Attempting to read from or write to a free page results in an access violation exception.</p>

<p>You can use <strong>ZwFreeVirtualMemory</strong> to put reserved or committed pages into the free state.</p></li>
<li><p>State is RESERVED</p>

<p>The page is reserved. The range of addresses cannot be used by other allocation functions. The page is not accessible to the process and has no physical storage associated with it. Attempting to read from or write to a reserved page results in an access violation exception.</p>

<p>You can use <strong>ZwFreeVirtualMemory</strong> to put committed memory pages into the reserved state, and to put reserved memory pages into the free state.</p></li>
<li><p>State is COMMITTED</p>

<p>The page is committed. Physical storage in memory or in the paging file on disk is allocated for the page, and access is controlled by a protection code.</p>

<p>The system initializes and loads each committed page into physical memory only at the first attempt to read from or write to that page.</p>

<p>When a process terminates, the system releases all storage for committed pages.</p>

<p>You can use <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">ZwAllocateVirtualMemory</a></strong> to put committed memory pages into either the reserved or free state.</p></li>
</ul>

<p><strong>ZwFreeVirtualMemory</strong> can perform the following operations:</p>

<ul>
<li>Decommit a region of committed or uncommitted pages. After this operation, the pages are in the reserved state.</li>
<li>Release a region of reserved pages. After this operation, the pages are in the free state.</li>
<li>Decommit and release a region of committed or uncommitted pages. After this operation, the pages are in the free state.</li>
</ul>

<p><strong>ZwFreeVirtualMemory</strong> can decommit a range of pages that are in different states, some committed and some uncommitted. This means that you can decommit a range of pages without first determining the current commitment state of each page. Decommitting a page releases its physical storage, either in memory or in the paging file on disk.</p>

<p>If a page is decommitted but not released, its state changes to reserved. You can subsequently call <strong>ZwFreeVirtualMemory</strong> to commit it, or <strong>ZwFreeVirtualMemory</strong> to release it. Attempting to read from or write to a reserved page results in an access violation exception.</p>

<p><strong>ZwFreeVirtualMemory</strong> can release a range of pages that are in different states, some reserved and some committed. This means that you can release a range of pages without first determining the current commitment state of each page. The entire range of pages originally reserved by <strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">ZwAllocateVirtualMemory</a></strong> must be released at the same time.</p>

<p>If a page is released, its state changes to free, and it is available for subsequent allocation operations. After memory has been released or decommitted, you can never refer to the memory again. Any information that may have been in that memory is gone forever. Attempting to read from or write to a free page results in an access violation exception. If you require information, do not decommit or free memory that contains that information.</p>

<p>For more information about memory management support for kernel-mode drivers, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/managing-memory-for-drivers">Memory Management for Windows Drivers</a>.</p>

<blockquote>
  <p>[!NOTE]
  If the call to the <strong>ZwFreeVirtualMemory</strong> function occurs in user mode, you should use the name "<strong>NtFreeVirtualMemory</strong>" instead of "<strong>ZwFreeVirtualMemory</strong>".</p>
</blockquote>

<p>For calls from kernel-mode drivers, the <strong>Nt<em>Xxx</em></strong> and <strong>Zw<em>Xxx</em></strong> versions of a Windows Native System Services routine can behave differently in the way that they handle and interpret input parameters. For more information about the relationship between the <strong>Nt<em>Xxx</em></strong> and <strong>Zw<em>Xxx</em></strong> versions of a routine, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/using-nt-and-zw-versions-of-the-native-system-services-routines">Using Nt and Zw Versions of the Native System Services Routines</a>.</p>

<h2>See also</h2>

<p><strong><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">ZwAllocateVirtualMemory</a></strong></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-zwfreevirtualmemory">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/nf-ntifs-zwfreevirtualmemory.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>NTinternals.net (undocumented.ntinternals.net)</h1>
</div>
<div class="ntdoc-description">
<p>This function is documented in Windows Driver Kit <a rel="noopener" target="_blank" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntfreevirtualmemory">here</a> and <a rel="noopener" target="_blank" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-zwfreevirtualmemory">here</a>.</p>

<hr />

<h3>RegionSize</h3>

<p>If you put pointer to <em>NULL</em> value as <code>RegionSize</code>, system will free all region, and put size of it in result.</p>

<h3>FreeType</h3>

<p>Can be one of the values: <code><a href="mem_decommit" title="#define MEM_DECOMMIT 0x00004000">MEM_DECOMMIT</a></code>, or <code><a href="mem_release" title="#define MEM_RELEASE 0x00008000">MEM_RELEASE</a></code>.</p>

<h1>Documented by</h1>

<ul>
<li>Tomasz Nowak</li>
<li>ReactOS</li>
</ul>

<h1>See also</h1>

<ul>
<li><code><a href="ntallocatevirtualmemory" title="_Must_inspect_result_&#10;_When_(return == 0, __drv_allocatesMem(mem))&#10;NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtAllocateVirtualMemory(&#10;    _In_ HANDLE ProcessHandle,&#10;    _Inout_ _At_(*BaseAddress, _Readable_bytes_(*RegionSize) _Writable_bytes_(*RegionSize) _Post_readable_byte_size_(*RegionSize)) PVOID *BaseAddress,&#10;    _In_ ULONG_PTR ZeroBits,&#10;    _Inout_ PSIZE_T RegionSize,&#10;    _In_ ULONG AllocationType,&#10;    _In_ ULONG PageProtection&#10;    );">NtAllocateVirtualMemory</a></code></li>
</ul>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/undocumented.ntinternals.net/ntfreevirtualmemory.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
