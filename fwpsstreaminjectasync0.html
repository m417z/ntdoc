<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="FwpsStreamInjectAsync0 - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>FwpsStreamInjectAsync0 - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            FwpsStreamInjectAsync0 - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// fwpsk.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> FwpsStreamInjectAsync0(
  [in]           HANDLE                injectionHandle,
  [in, optional] HANDLE                injectionContext,
  [in]           <a href="uint32" title="typedef unsigned int UINT32;">UINT32</a>                flags,
  [in]           <a href="uint64" title="typedef unsigned __int64 UINT64;">UINT64</a>                flowId,
  [in]           <a href="uint32" title="typedef unsigned int UINT32;">UINT32</a>                calloutId,
  [in]           <a href="uint16" title="typedef unsigned short UINT16;">UINT16</a>                layerId,
  [in]           <a href="uint32" title="typedef unsigned int UINT32;">UINT32</a>                streamFlags,
  [in, out]      <a href="net_buffer_list" title="typedef struct _NET_BUFFER_LIST {&#10;  union {&#10;    struct {&#10;      NET_BUFFER_LIST *Next;&#10;      NET_BUFFER      *FirstNetBuffer;&#10;    };&#10;    SLIST_HEADER           Link;&#10;    NET_BUFFER_LIST_HEADER NetBufferListHeader;&#10;  };&#10;  NET_BUFFER_LIST_CONTEXT *Context;&#10;  NET_BUFFER_LIST         *ParentNetBufferList;&#10;  NDIS_HANDLE             NdisPoolHandle;&#10;  PVOID                   NdisReserved[2];&#10;  PVOID                   ProtocolReserved[4];&#10;  PVOID                   MiniportReserved[2];&#10;  PVOID                   Scratch;&#10;  NDIS_HANDLE             SourceHandle;&#10;  ULONG                   NblFlags;&#10;  LONG                    ChildRefCount;&#10;  ULONG                   Flags;&#10;...">NET_BUFFER_LIST</a>       *netBufferList,
  [in]           <a href="size_t-2" title="typedef ULONG_PTR SIZE_T;">SIZE_T</a>                dataLength,
  [in]           FWPS_INJECT_COMPLETE0 completionFn,
  [in, optional] HANDLE                completionContext
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nf-fwpsk-fwpsstreaminjectasync0">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/fwpsstreaminjectasync0.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-fwpsk-fwpsstreaminjectasync0)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="fwpsstreaminjectasync0-function">FwpsStreamInjectAsync0 function</h1>

<h2 id="description">Description</h2>

<p>The
<strong>FwpsStreamInjectAsync0</strong> function injects TCP data segments into a TCP data stream.</p>

<p><strong>Note</strong> <strong>FwpsStreamInjectAsync0</strong> is a specific version of <strong>FwpsStreamInjectAsync</strong>. See <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/FWP/wfp-version-independent-names-and-targeting-specific-versions-of-windows">WFP Version-Independent Names and Targeting Specific Versions of Windows</a> for more information.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="injectionhandle-in"><code>injectionHandle</code> [in]</h3>

<p>An injection handle that was previously created by a call to the
<a href="fwpsinjectionhandlecreate0" title="NTSTATUS FwpsInjectionHandleCreate0(&#10;  [in, optional] ADDRESS_FAMILY addressFamily,&#10;  [in]           UINT32         flags,&#10;  [out]          HANDLE         *injectionHandle&#10;);">FwpsInjectionHandleCreate0</a> function.</p>

<h3 id="injectioncontext-in-optional"><code>injectionContext</code> [in, optional]</h3>

<p>An optional handle to the injection context.</p>

<h3 id="flags-in"><code>flags</code> [in]</h3>

<p>Reserved. Callout drivers should set this parameter to zero.</p>

<h3 id="flowid-in"><code>flowId</code> [in]</h3>

<p>A run-time identifier that specifies the data flow into which to inject the data. The run-time
identifier for a data flow is provided to a callout driver through the FWPS_METADATA_FIELD_FLOW_HANDLE
metadata value that the filter engine provided to the callout driver's
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/_netvista/">classifyFn</a> callout function.</p>

<h3 id="calloutid-in"><code>calloutId</code> [in]</h3>

<p>The run-time identifier for the callout in the filter engine. This identifier was returned when
the callout driver called either the
<a href="fwpscalloutregister0" title="NTSTATUS FwpsCalloutRegister0(&#10;  [in, out]       void                *deviceObject,&#10;  [in]            const FWPS_CALLOUT0 *callout,&#10;  [out, optional] UINT32              *calloutId&#10;);">FwpsCalloutRegister0</a> or
<a href="fwpscalloutregister1" title="NTSTATUS FwpsCalloutRegister1(&#10;  [in, out]       void                *deviceObject,&#10;  [in]            const FWPS_CALLOUT1 *callout,&#10;  [out, optional] UINT32              *calloutId&#10;);">FwpsCalloutRegister1</a> functions to
register the callout with the filter engine.</p>

<h3 id="layerid-in"><code>layerId</code> [in]</h3>

<p>The run-time identifier for the filtering layer at which the data stream is being processed. This
value must be either FWPS_LAYER_STREAM_V4 or FWPS_LAYER_STREAM_V6. The run-time identifier for the layer
at which the data stream is being processed is provided to a callout in the
<strong>layerId</strong> member of the
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fwpstypes/ns-fwpstypes-fwps_incoming_values0">FWPS_INCOMING_VALUES0</a> structure that
the filter engine passed to the callout driver's
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/_netvista/">classifyFn</a> callout function.</p>

<h3 id="streamflags-in"><code>streamFlags</code> [in]</h3>

<p>Flags that specify characteristics of the data stream into which the data is to be injected.</p>

<p>When injecting data into an inbound data stream, a callout driver specifies one or more of the
following flags:</p>

<h4 id="fwps_stream_flag_receive">FWPS_STREAM_FLAG_RECEIVE</h4>

<p>Specifies that the data is to be injected into the inbound data stream. This flag is required
when injecting data into an inbound data stream.</p>

<h4 id="fwps_stream_flag_receive_disconnect">FWPS_STREAM_FLAG_RECEIVE_DISCONNECT</h4>

<p>Specifies that the FIN flag is to be set in the TCP header for the data being injected into the
inbound data stream.</p>

<p><strong>Note</strong> If this flag is set, the <strong>FWPS_STREAM_FLAG_RECEIVE</strong> flag must also be set, or else <strong>STATUS_FWP_INVALID_PARAMETER</strong> will be returned.</p>

<h4 id="fwps_stream_flag_receive_expedited">FWPS_STREAM_FLAG_RECEIVE_EXPEDITED</h4>

<p>Specifies that the data being injected into the inbound data stream is high-priority,
out-of-band data.</p>

<h4 id="fwps_stream_flag_receive_push">FWPS_STREAM_FLAG_RECEIVE_PUSH</h4>

<p>Specifies that the inbound data has arrived with the PUSH flag set in the TCP header, which
indicates that the sender requests immediate data transfer. Unwanted delays in data transfer can occur
if this flag is not set. This flag is available starting with Windows Vista with SP1.</p>

<p>When injecting data into an outbound data stream, a callout driver specifies one or more of the
following flags:</p>

<h4 id="fwps_stream_flag_send">FWPS_STREAM_FLAG_SEND</h4>

<p>Specifies that the data is to be injected into the outbound data stream. This flag is required
when injecting data into an outbound data stream.</p>

<h4 id="fwps_stream_flag_send_expedited">FWPS_STREAM_FLAG_SEND_EXPEDITED</h4>

<p>Specifies that the data being injected into the outbound data stream is high-priority,
out-of-band data.</p>

<h4 id="fwps_stream_flag_send_nodelay">FWPS_STREAM_FLAG_SEND_NODELAY</h4>

<p>Specifies that the callout driver requests that there is no buffering of the data being injected
into the outbound data stream.</p>

<h4 id="fwps_stream_flag_send_disconnect">FWPS_STREAM_FLAG_SEND_DISCONNECT</h4>

<p>Specifies that the stream is to be disconnected after the data being injected into the outbound
data stream has been sent. The network stack will set the FIN flag in the TCP header of the last
packet that is sent out.</p>

<p><strong>Note</strong> If this flag is set, the <strong>FWPS_STREAM_FLAG_SEND</strong> flag must also be set, or else <strong>STATUS_FWP_INVALID_PARAMETER</strong> will be returned.</p>

<h3 id="netbufferlist-in-out"><code>netBufferList</code> [in, out]</h3>

<p>A pointer to a
<a href="net_buffer_list" title="typedef struct _NET_BUFFER_LIST {&#10;  union {&#10;    struct {&#10;      NET_BUFFER_LIST *Next;&#10;      NET_BUFFER      *FirstNetBuffer;&#10;    };&#10;    SLIST_HEADER           Link;&#10;    NET_BUFFER_LIST_HEADER NetBufferListHeader;&#10;  };&#10;  NET_BUFFER_LIST_CONTEXT *Context;&#10;  NET_BUFFER_LIST         *ParentNetBufferList;&#10;  NDIS_HANDLE             NdisPoolHandle;&#10;  PVOID                   NdisReserved[2];&#10;  PVOID                   ProtocolReserved[4];&#10;  PVOID                   MiniportReserved[2];&#10;  PVOID                   Scratch;&#10;  NDIS_HANDLE             SourceHandle;&#10;  ULONG                   NblFlags;&#10;  LONG                    ChildRefCount;&#10;  ULONG                   Flags;&#10;...">NET_BUFFER_LIST</a> structure that describes
the data that is being injected into the data stream. A callout driver allocates a <strong><a href="net_buffer_list" title="typedef struct _NET_BUFFER_LIST {&#10;  union {&#10;    struct {&#10;      NET_BUFFER_LIST *Next;&#10;      NET_BUFFER      *FirstNetBuffer;&#10;    };&#10;    SLIST_HEADER           Link;&#10;    NET_BUFFER_LIST_HEADER NetBufferListHeader;&#10;  };&#10;  NET_BUFFER_LIST_CONTEXT *Context;&#10;  NET_BUFFER_LIST         *ParentNetBufferList;&#10;  NDIS_HANDLE             NdisPoolHandle;&#10;  PVOID                   NdisReserved[2];&#10;  PVOID                   ProtocolReserved[4];&#10;  PVOID                   MiniportReserved[2];&#10;  PVOID                   Scratch;&#10;  NDIS_HANDLE             SourceHandle;&#10;  ULONG                   NblFlags;&#10;  LONG                    ChildRefCount;&#10;  ULONG                   Flags;&#10;...">NET_BUFFER_LIST</a></strong>
structure to use for injecting data into a data stream by calling the
<a href="fwpsallocateclonenetbufferlist0" title="NTSTATUS FwpsAllocateCloneNetBufferList0(&#10;  [in, out]      NET_BUFFER_LIST *originalNetBufferList,&#10;  [in, optional] NDIS_HANDLE     netBufferListPoolHandle,&#10;  [in, optional] NDIS_HANDLE     netBufferPoolHandle,&#10;  [in]           ULONG           allocateCloneFlags,&#10;  [out]          NET_BUFFER_LIST **netBufferList&#10;);">FwpsAllocateCloneNetBufferList0</a>,
<a href="fwpsallocatenetbufferandnetbufferlist0" title="NTSTATUS FwpsAllocateNetBufferAndNetBufferList0(&#10;  [in]           NDIS_HANDLE     poolHandle,&#10;  [in]           USHORT          contextSize,&#10;  [in]           USHORT          contextBackFill,&#10;  [in, optional] MDL             *mdlChain,&#10;  [in]           ULONG           dataOffset,&#10;  [in]           SIZE_T          dataLength,&#10;  [out]          NET_BUFFER_LIST **netBufferList&#10;);">FwpsAllocateNetBufferAndNetBufferList0</a>, or
<a href="fwpsclonestreamdata0" title="NTSTATUS FwpsCloneStreamData0(&#10;  [in, out]      FWPS_STREAM_DATA0 *calloutStreamData,&#10;  [in, optional] NDIS_HANDLE       netBufferListPoolHandle,&#10;  [in, optional] NDIS_HANDLE       netBufferPoolHandle,&#10;  [in]           ULONG             allocateCloneFlags,&#10;  [out]          NET_BUFFER_LIST   **netBufferListChain&#10;);">FwpsCloneStreamData0</a> functions. The
<strong><a href="net_buffer_list" title="typedef struct _NET_BUFFER_LIST {&#10;  union {&#10;    struct {&#10;      NET_BUFFER_LIST *Next;&#10;      NET_BUFFER      *FirstNetBuffer;&#10;    };&#10;    SLIST_HEADER           Link;&#10;    NET_BUFFER_LIST_HEADER NetBufferListHeader;&#10;  };&#10;  NET_BUFFER_LIST_CONTEXT *Context;&#10;  NET_BUFFER_LIST         *ParentNetBufferList;&#10;  NDIS_HANDLE             NdisPoolHandle;&#10;  PVOID                   NdisReserved[2];&#10;  PVOID                   ProtocolReserved[4];&#10;  PVOID                   MiniportReserved[2];&#10;  PVOID                   Scratch;&#10;  NDIS_HANDLE             SourceHandle;&#10;  ULONG                   NblFlags;&#10;  LONG                    ChildRefCount;&#10;  ULONG                   Flags;&#10;...">NET_BUFFER_LIST</a></strong> structure can describe a chain of network buffer lists. If the
<em>streamFlags</em> parameter is <strong>FWPS_STREAM_FLAG_RECEIVE_DISCONNECT</strong> or <strong>FWPS_STREAM_FLAG_SEND_DISCONNECT</strong>,
<em>netBufferList</em> can be <strong>NULL</strong>.</p>

<h3 id="datalength-in"><code>dataLength</code> [in]</h3>

<p>The number of bytes of data being injected into the data stream.</p>

<h3 id="completionfn-in"><code>completionFn</code> [in]</h3>

<p>A pointer to a
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nc-fwpsk-fwps_inject_complete0">completionFn</a> callout function provided by
the callout driver. The filter engine calls this function after the packet data, described by the
<em>netBufferList</em> parameter, has been injected into the network stack.</p>

<p>If the
<em>netBufferList</em> parameter describes a <a href="net_buffer_list" title="typedef struct _NET_BUFFER_LIST {&#10;  union {&#10;    struct {&#10;      NET_BUFFER_LIST *Next;&#10;      NET_BUFFER      *FirstNetBuffer;&#10;    };&#10;    SLIST_HEADER           Link;&#10;    NET_BUFFER_LIST_HEADER NetBufferListHeader;&#10;  };&#10;  NET_BUFFER_LIST_CONTEXT *Context;&#10;  NET_BUFFER_LIST         *ParentNetBufferList;&#10;  NDIS_HANDLE             NdisPoolHandle;&#10;  PVOID                   NdisReserved[2];&#10;  PVOID                   ProtocolReserved[4];&#10;  PVOID                   MiniportReserved[2];&#10;  PVOID                   Scratch;&#10;  NDIS_HANDLE             SourceHandle;&#10;  ULONG                   NblFlags;&#10;  LONG                    ChildRefCount;&#10;  ULONG                   Flags;&#10;...">NET_BUFFER_LIST</a> chain,
<em>completionFn</em> will be called once for each <strong><a href="net_buffer_list" title="typedef struct _NET_BUFFER_LIST {&#10;  union {&#10;    struct {&#10;      NET_BUFFER_LIST *Next;&#10;      NET_BUFFER      *FirstNetBuffer;&#10;    };&#10;    SLIST_HEADER           Link;&#10;    NET_BUFFER_LIST_HEADER NetBufferListHeader;&#10;  };&#10;  NET_BUFFER_LIST_CONTEXT *Context;&#10;  NET_BUFFER_LIST         *ParentNetBufferList;&#10;  NDIS_HANDLE             NdisPoolHandle;&#10;  PVOID                   NdisReserved[2];&#10;  PVOID                   ProtocolReserved[4];&#10;  PVOID                   MiniportReserved[2];&#10;  PVOID                   Scratch;&#10;  NDIS_HANDLE             SourceHandle;&#10;  ULONG                   NblFlags;&#10;  LONG                    ChildRefCount;&#10;  ULONG                   Flags;&#10;...">NET_BUFFER_LIST</a></strong> in the chain.</p>

<p>If the
<em>netBufferList</em> parameter is <strong>NULL</strong> and the
<em>streamFlags</em> parameter has either <strong>FWPS_STREAM_FLAG_RECEIVE_DISCONNECT</strong> or <strong>FWPS_STREAM_FLAG_SEND_DISCONNECT</strong> set, the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nc-fwpsk-fwps_inject_complete0">completionFn</a> function will not be called.</p>

<p>This parameter is required and cannot be <strong>NULL</strong>. If it is <strong>NULL</strong>, <strong>STATUS_FWP_NULL_POINTER</strong> will be returned.</p>

<h3 id="completioncontext-in-optional"><code>completionContext</code> [in, optional]</h3>

<p>A pointer to a callout driver–provided context that is passed to the callout function pointed to
by the
<em>completionFn</em> parameter. This parameter is optional and can be <strong>NULL</strong>.</p>

<h2 id="return-value">Return value</h2>

<p>The
<strong>FwpsStreamInjectAsync0</strong> function an <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> code such as one of the following.</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></strong></td>
  <td>The injection into the data stream was initiated successfully. The filter engine will call the completion function that was specified when the <a href="net_buffer_list" title="typedef struct _NET_BUFFER_LIST {&#10;  union {&#10;    struct {&#10;      NET_BUFFER_LIST *Next;&#10;      NET_BUFFER      *FirstNetBuffer;&#10;    };&#10;    SLIST_HEADER           Link;&#10;    NET_BUFFER_LIST_HEADER NetBufferListHeader;&#10;  };&#10;  NET_BUFFER_LIST_CONTEXT *Context;&#10;  NET_BUFFER_LIST         *ParentNetBufferList;&#10;  NDIS_HANDLE             NdisPoolHandle;&#10;  PVOID                   NdisReserved[2];&#10;  PVOID                   ProtocolReserved[4];&#10;  PVOID                   MiniportReserved[2];&#10;  PVOID                   Scratch;&#10;  NDIS_HANDLE             SourceHandle;&#10;  ULONG                   NblFlags;&#10;  LONG                    ChildRefCount;&#10;  ULONG                   Flags;&#10;...">NET_BUFFER_LIST</a> structure was allocated after the filter engine has completed injecting the data into the data stream.</td>
</tr>
<tr>
  <td><strong>STATUS_FWP_TCPIP_NOT_READY</strong></td>
  <td>The TCP/IP network stack is not ready to accept injection of stream data.</td>
</tr>
<tr>
  <td><strong>STATUS_FWP_INJECT_HANDLE_CLOSING</strong></td>
  <td>The injection handle is being closed.</td>
</tr>
<tr>
  <td><strong>Other status codes</strong></td>
  <td>An error occurred.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>A callout driver calls the
<strong>FwpsStreamInjectAsync0</strong> function from within a callout's
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/_netvista/">classifyFn</a> callout function to inject new
or cloned data into the data stream that is currently being processed. A callout driver can call the
FwpsStreamInjectAsync0 function only if it is processing a data flow at the stream layer.</p>

<p>A callout driver can also call the
<strong>FwpsStreamInjectAsync0</strong> function from outside of a callout's
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/_netvista/">classifyFn</a> callout function to inject data into a data stream that is currently deferred. A data
stream is deferred when a callout's
<em>classifyFn</em> callout function sets the
<strong>streamAction</strong> member of the
<a href="fwps_stream_callout_io_packet0_" title="typedef struct FWPS_STREAM_CALLOUT_IO_PACKET0_ {&#10;  FWPS_STREAM_DATA0       *streamData;&#10;  SIZE_T                  missedBytes;&#10;  UINT32                  countBytesRequired;&#10;  SIZE_T                  countBytesEnforced;&#10;  FWPS_STREAM_ACTION_TYPE streamAction;&#10;} FWPS_STREAM_CALLOUT_IO_PACKET0;">FWPS_STREAM_CALLOUT_IO_PACKET0</a> structure to FWPS_STREAM_ACTION_DEFER.</p>

<p>In addition, a callout driver can call the
<strong>FwpsStreamInjectAsync0</strong> function from outside of a callout's
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/_netvista/">classifyFn</a> callout function to inject data into a data stream after a FIN indication has been
pended.</p>

<p>Alternately, a callout driver can call the
<strong>FwpsStreamInjectAsync0</strong> function from an arbitrary thread context outside a callout's
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/_netvista/">classifyFn</a> callout function if the callout driver clones and blocks all data indicated for
out-of-band processing. A callout driver that redirects all indicated data to user mode for processing
can call the
<strong>FwpsStreamInjectAsync0</strong> function in this way.</p>

<p>A callout can pend a data segment by first cloning it with a call to the
<a href="fwpsclonestreamdata0" title="NTSTATUS FwpsCloneStreamData0(&#10;  [in, out]      FWPS_STREAM_DATA0 *calloutStreamData,&#10;  [in, optional] NDIS_HANDLE       netBufferListPoolHandle,&#10;  [in, optional] NDIS_HANDLE       netBufferPoolHandle,&#10;  [in]           ULONG             allocateCloneFlags,&#10;  [out]          NET_BUFFER_LIST   **netBufferListChain&#10;);">FwpsCloneStreamData0</a> function,
followed by blocking the data segment by setting FWP_ACTION_BLOCK in the
<strong>actionType</strong> member of the
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fwpstypes/ns-fwpstypes-fwps_classify_out0">FWPS_CLASSIFY_OUT0</a> structure.</p>

<p>Injected stream data will not be reindicated to the callout, but it will be made available to stream
callouts from lower-weight sublayers.</p>

<p>If the return value is not <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a>, the completion function will not be called. In this case,
the network buffer list pointed to by
<em>netBufferList</em> must be freed by a call to
<a href="fwpsfreenetbufferlist0" title="void FwpsFreeNetBufferList0(&#10;  [in, out] NET_BUFFER_LIST *netBufferList&#10;);">FwpsFreeNetBufferList0</a> or
<a href="fwpsfreeclonenetbufferlist0" title="void FwpsFreeCloneNetBufferList0(&#10;  [in, out] NET_BUFFER_LIST *netBufferList,&#10;  [in]      ULONG           freeCloneFlags&#10;);">FwpsFreeCloneNetBufferList0</a>.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fwpstypes/ns-fwpstypes-fwps_incoming_values0">FWPS_INCOMING_VALUES0</a></p>

<p><a href="fwps_stream_callout_io_packet0_" title="typedef struct FWPS_STREAM_CALLOUT_IO_PACKET0_ {&#10;  FWPS_STREAM_DATA0       *streamData;&#10;  SIZE_T                  missedBytes;&#10;  UINT32                  countBytesRequired;&#10;  SIZE_T                  countBytesEnforced;&#10;  FWPS_STREAM_ACTION_TYPE streamAction;&#10;} FWPS_STREAM_CALLOUT_IO_PACKET0;">FWPS_STREAM_CALLOUT_IO_PACKET0</a></p>

<p><a href="fwpsallocateclonenetbufferlist0" title="NTSTATUS FwpsAllocateCloneNetBufferList0(&#10;  [in, out]      NET_BUFFER_LIST *originalNetBufferList,&#10;  [in, optional] NDIS_HANDLE     netBufferListPoolHandle,&#10;  [in, optional] NDIS_HANDLE     netBufferPoolHandle,&#10;  [in]           ULONG           allocateCloneFlags,&#10;  [out]          NET_BUFFER_LIST **netBufferList&#10;);">FwpsAllocateCloneNetBufferList0</a></p>

<p><a href="fwpsallocatenetbufferandnetbufferlist0" title="NTSTATUS FwpsAllocateNetBufferAndNetBufferList0(&#10;  [in]           NDIS_HANDLE     poolHandle,&#10;  [in]           USHORT          contextSize,&#10;  [in]           USHORT          contextBackFill,&#10;  [in, optional] MDL             *mdlChain,&#10;  [in]           ULONG           dataOffset,&#10;  [in]           SIZE_T          dataLength,&#10;  [out]          NET_BUFFER_LIST **netBufferList&#10;);">FwpsAllocateNetBufferAndNetBufferList0</a></p>

<p><a href="fwpscalloutregister0" title="NTSTATUS FwpsCalloutRegister0(&#10;  [in, out]       void                *deviceObject,&#10;  [in]            const FWPS_CALLOUT0 *callout,&#10;  [out, optional] UINT32              *calloutId&#10;);">FwpsCalloutRegister0</a></p>

<p><a href="fwpscalloutregister1" title="NTSTATUS FwpsCalloutRegister1(&#10;  [in, out]       void                *deviceObject,&#10;  [in]            const FWPS_CALLOUT1 *callout,&#10;  [out, optional] UINT32              *calloutId&#10;);">FwpsCalloutRegister1</a></p>

<p><a href="fwpsclonestreamdata0" title="NTSTATUS FwpsCloneStreamData0(&#10;  [in, out]      FWPS_STREAM_DATA0 *calloutStreamData,&#10;  [in, optional] NDIS_HANDLE       netBufferListPoolHandle,&#10;  [in, optional] NDIS_HANDLE       netBufferPoolHandle,&#10;  [in]           ULONG             allocateCloneFlags,&#10;  [out]          NET_BUFFER_LIST   **netBufferListChain&#10;);">FwpsCloneStreamData0</a></p>

<p><a href="fwpsinjectionhandlecreate0" title="NTSTATUS FwpsInjectionHandleCreate0(&#10;  [in, optional] ADDRESS_FAMILY addressFamily,&#10;  [in]           UINT32         flags,&#10;  [out]          HANDLE         *injectionHandle&#10;);">FwpsInjectionHandleCreate0</a></p>

<p><a href="fwpsinjectionhandledestroy0" title="NTSTATUS FwpsInjectionHandleDestroy0(&#10;  [in] HANDLE injectionHandle&#10;);">FwpsInjectionHandleDestroy0</a></p>

<p><a href="net_buffer_list" title="typedef struct _NET_BUFFER_LIST {&#10;  union {&#10;    struct {&#10;      NET_BUFFER_LIST *Next;&#10;      NET_BUFFER      *FirstNetBuffer;&#10;    };&#10;    SLIST_HEADER           Link;&#10;    NET_BUFFER_LIST_HEADER NetBufferListHeader;&#10;  };&#10;  NET_BUFFER_LIST_CONTEXT *Context;&#10;  NET_BUFFER_LIST         *ParentNetBufferList;&#10;  NDIS_HANDLE             NdisPoolHandle;&#10;  PVOID                   NdisReserved[2];&#10;  PVOID                   ProtocolReserved[4];&#10;  PVOID                   MiniportReserved[2];&#10;  PVOID                   Scratch;&#10;  NDIS_HANDLE             SourceHandle;&#10;  ULONG                   NblFlags;&#10;  LONG                    ChildRefCount;&#10;  ULONG                   Flags;&#10;...">NET_BUFFER_LIST</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/_netvista/">classifyFn</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nc-fwpsk-fwps_inject_complete0">completionFn</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nf-fwpsk-fwpsstreaminjectasync0">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/fwpsk/nf-fwpsk-fwpsstreaminjectasync0.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
