<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="IOCTL_TCP_QUERY_INFORMATION_EX - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>IOCTL_TCP_QUERY_INFORMATION_EX - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            IOCTL_TCP_QUERY_INFORMATION_EX - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// tcpioctl.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x0012, 0x000, METHOD_NEITHER, FILE_ANY_ACCESS)
#define IOCTL_TCP_QUERY_INFORMATION_EX 0x00120003</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows/win32/api/tcpioctl/ni-tcpioctl-ioctl_tcp_query_information_ex">View the official Win32 API reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ioctl_tcp_query_information_ex.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Win32 API reference (ni-tcpioctl-ioctl_tcp_query_information_ex)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="ioctl_tcp_query_information_ex-ioctl">IOCTL_TCP_QUERY_INFORMATION_EX IOCTL</h1>

<h2 id="description">Description</h2>

<p>[This control code may be altered or unavailable in future versions of Windows.
Use Internet Protocol Helper API instead of this
control code.]</p>

<p>Retrieves information from the TCP/IP driver.</p>

<p>To perform the <strong>IOCTL_TCP_QUERY_INFORMATION_EX</strong> operation, call the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/ioapiset/nf-ioapiset-deviceiocontrol">DeviceIoControl</a>
function with the following parameters.</p>

<div class="codehilite">
<pre><span></span><code><span class="n">BOOL</span><span class="w"> </span><span class="n">DeviceIoControl</span><span class="p">(</span>
<span class="w">  </span><span class="p">(</span><span class="n">HANDLE</span><span class="p">)</span><span class="w"> </span><span class="n">hDevice</span><span class="p">,</span><span class="w">                  </span><span class="c1">// Open handle to the TCP driver</span>
<span class="w">  </span><span class="n">IOCTL_TCP_QUERY_INFORMATION_EX</span><span class="p">,</span><span class="w">    </span><span class="c1">// dwIoControlCode</span>
<span class="w">  </span><span class="nb">NULL</span><span class="p">,</span><span class="w">                              </span><span class="c1">// lpInBuffer (the output buffer is used for input too)</span>
<span class="w">  </span><span class="mi">0</span><span class="p">,</span><span class="w">                                 </span><span class="c1">// nInBufferSize</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="w"> </span><span class="n">lpOutBuffer</span><span class="p">,</span><span class="w">              </span><span class="c1">// Pointer to the output buffer</span>
<span class="w">  </span><span class="p">(</span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="p">)</span><span class="w"> </span><span class="n">nOutBufferSize</span><span class="p">,</span><span class="w">            </span><span class="c1">// Size of the output buffer</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPDWORD</span><span class="p">)</span><span class="w"> </span><span class="n">lpBytesReturned</span><span class="p">,</span><span class="w">         </span><span class="c1">// Number of bytes returned (if called synchronously)</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPOVERLAPPED</span><span class="p">)</span><span class="w"> </span><span class="n">lpOverlapped</span><span class="w">        </span><span class="c1">// OVERLAPPED structure (if called asynchronously)</span>
<span class="p">);</span>
</code></pre>
</div>

<h2 id="parameters">Parameters</h2>

<h3 id="input-buffer">Input buffer</h3>

<h3 id="input-buffer-length">Input buffer length</h3>

<h3 id="output-buffer">Output buffer</h3>

<h3 id="output-buffer-length">Output buffer length</h3>

<h3 id="inputoutput-buffer">Input/output buffer</h3>

<h3 id="inputoutput-buffer-length">Input/output buffer length</h3>

<h3 id="status-block">Status block</h3>

<p>Irp->IoStatus.Status is set to <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the request is successful.</p>

<p>Otherwise, Status to the appropriate error condition as a <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> code.</p>

<p>For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/ntstatus-values">NTSTATUS Values</a>.</p>

<h2 id="remarks">Remarks</h2>

<p>To use <strong>IOCTL_TCP_QUERY_INFORMATION_EX</strong>, you should be familiar with Windows Driver Development, as documented in the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/download-the-wdk">Windows Driver Kit (WDK)</a>, and specifically with Transport Driver Interface (TDI) drivers.</p>

<p><strong>Note</strong> To use this control code, include the Windows.h header file. In addition, specifically include Tcpioctl.h, a header file published in the Windows SDK for use with <strong>IOCTL_TCP_QUERY_INFORMATION_EX</strong>, and also Tdiinfo.h and Tdistat.h, header files published in the WDK for TDI driver development.</p>

<p><strong>Note</strong> Various flags and other constants defined in the Tdiinfo.h WDK header file for the <strong>IOCTL_TCP_QUERY_INFORMATION_EX</strong> operation use the following naming convention.</p>

<table>
<thead>
<tr>
  <th>Letters</th>
  <th>Stand for</th>
  <th>Comments</th>
</tr>
</thead>
<tbody>
<tr>
  <td>"AT"</td>
  <td>Address Translation</td>
  <td>Address resolution such as that provided by ARP (Address Resolution Protocol).</td>
</tr>
<tr>
  <td>"NL"</td>
  <td>Network Layer</td>
  <td>As in the Open Systems Interconnection (OSI) reference model.</td>
</tr>
<tr>
  <td>"TL"</td>
  <td>Transport Layer</td>
  <td>As in the OSI reference model.</td>
</tr>
<tr>
  <td>"CL"</td>
  <td>Connection-Less</td>
  <td>A connectionless protocol based on broadcast packets.</td>
</tr>
<tr>
  <td>"CO"</td>
  <td>Connected</td>
  <td>A connected protocol based on directed packets.</td>
</tr>
<tr>
  <td>"ER"</td>
  <td>Echo Request/Reply</td>
  <td>Packet types used by Ping to test TCP/IP connectivity.</td>
</tr>
<tr>
  <td>"IF"</td>
  <td>Interface</td>
  <td>An interface in the sense used in SNMP.</td>
</tr>
</tbody>
</table>

<p>The <strong>IOCTL_TCP_QUERY_INFORMATION_EX</strong> operation
retrieves different kinds of information, depending on what the
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/tdiinfo/ns-tdiinfo-tcp_request_query_information_ex_w2k">TCP_REQUEST_QUERY_INFORMATION_EX</a> structure
pointed to by the <em>lpInBuffer</em> parameter contains, as described in the following paragraph and example code.</p>

<ol>
<li><p>Enumerate TDI Entities.</p>

<p>To retrieve an array of <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/tdiinfo/ns-tdiinfo-tdientityid">TDIEntityID</a>
structures that identifies all the TCP entities on the machine, set the <strong>ID.toi_entity.tei_entity</strong>
member of the input structure to <strong>GENERIC_ENTITY</strong>. <strong>ID.toi_class</strong> must then
be set to <strong>INFO_CLASS_GENERIC</strong>, <strong>ID.toi_type</strong> must be set to
<strong>INFO_TYPE_PROVIDER</strong>, and <strong>ID.toi_id</strong> must be set to
<strong>ENTITY_LIST_ID<em>*, or the operation fails with a TDI_INVALID_PARAMETER error code.
The *</em>Context</strong> member of the input structure is ignored when a list is requested.
The output in this case is an array of <strong>TDIEntityID</strong> structures.
The <strong>GetEntityArray</strong> function in the first code example below shows how to retrieve such an array.</p></li>
<li><p>Obtain Type Information about a Specific TDI Entity.</p></li>
</ol>

<p>If the <strong>ID.toi_entity</strong> member of the input
structure identifies a specific entity (as in the case of the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/tdiinfo/ns-tdiinfo-tdientityid">TDIEntityID</a>
structures returned by the enumeration request above), then setting the <strong>ID.toi_class</strong> to
<strong>INFO_CLASS_GENERIC</strong>, the <strong>ID.toi_type</strong> to
<strong>INFO_TYPE_PROVIDER</strong>, and the <strong>ID.toi_id</strong> to
<strong>ENTITY_TYPE_ID</strong> causes one or more flag values to be returned into an <strong>unsigned long</strong> pointed to by the <em>lpOutBuffer</em> parameter. These flag values identify the type of the specified entity. Once again, the
<strong>Context</strong> member of the input structure is ignored.</p>

<p>The possible type-flag values that can be returned are shown in the following table.</p>

<table>
<thead>
<tr>
  <th>Flag</th>
  <th>Significance</th>
</tr>
</thead>
<tbody>
<tr>
  <td>AT_ARP</td>
  <td>Entity implements ARP (Address Resolution Protocol).</td>
</tr>
<tr>
  <td>AT_NULL</td>
  <td>Entity does no address translation.</td>
</tr>
<tr>
  <td>CL_NL_IP</td>
  <td>Entity implements IP (Internet Protocol), connectionless on the network layer.</td>
</tr>
<tr>
  <td>CL_NL_IPX</td>
  <td>Entity implements IPX (Internetwork Packet Exchange protocol), connectionless on the network layer.</td>
</tr>
<tr>
  <td>CL_TL_NBF</td>
  <td>Entity implements NBF (NetBEUI Frame protocol), connectionless on the transport layer.</td>
</tr>
<tr>
  <td>CL_TL_UDP</td>
  <td>Entity implements UDP (User Datagram Protocol) connectionless on the transport layer.</td>
</tr>
<tr>
  <td>CO_TL_NBF</td>
  <td>Entity implements NBF (NetBEUI Frame protocol), directed packets on the transport layer.</td>
</tr>
<tr>
  <td>CO_TL_SPP</td>
  <td>Entity implements SPP (Sequenced Packet Protocol), directed packets on the transport layer.</td>
</tr>
<tr>
  <td>CO_TL_SPX</td>
  <td>Entity implements SPX (Sequenced Packet Exchange protocol), directed packets on the transport layer.</td>
</tr>
<tr>
  <td>CO_TL_TCP</td>
  <td>Entity implements TCP (Transmission Control Protocol), directed packets on the transport layer.</td>
</tr>
<tr>
  <td>ER_ICMP</td>
  <td>Entity implements ICMP (Internet Control Message Protocol) for Echo Request/Reply.</td>
</tr>
<tr>
  <td>IF_GENERIC</td>
  <td>Entity implements a generic interface.</td>
</tr>
<tr>
  <td>IF_MIB</td>
  <td>Entity implements an interface with SNMP MIB-II support.</td>
</tr>
</tbody>
</table>

<ol start="3">
<li>Obtain MIB-II Information about an Interface Entity.</li>
</ol>

<p>If the entity type is IF_MIB, then a MIB request can be sent to it that results in the return of an <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/tcpioctl/ns-tcpioctl-ifentry">IFEntry</a> structure. Set the <strong>ID.toi_entity</strong> member of the input
structure to identify the entity, the <strong>ID.toi_class</strong> to
<strong>INFO_CLASS_PROTOCOL</strong>, the <strong>ID.toi_type</strong> to
<strong>INFO_TYPE_PROVIDER</strong>, and the <strong>ID.toi_id</strong> to
<strong>IF_MIB_STATS_ID</strong>.</p>

<p>Note that because <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/tcpioctl/ns-tcpioctl-ifentry">IFEntry</a> is a variable-length structure, the output buffer should be allocated not just as "sizeof(IFEntry)" but as "sizeof(IFEntry) + MAX_ADAPTER_DESCRIPTION_LENGTH + 1".</p>

<ol start="4">
<li>Obtain MIB-II Information about a Particular IP Entity.</li>
</ol>

<p>MIB information can also be retrieved from an IP entity (one whose type is <strong>CL_NL_ENTITY</strong>) by setting the <strong>ID.toi_entity</strong> member to identify the entity, the <strong>ID.toi_class</strong> to
<strong>INFO_CLASS_PROTOCOL</strong>, the <strong>ID.toi_type</strong> to
<strong>INFO_TYPE_PROVIDER</strong>, and the <strong>ID.toi_id</strong> to
<strong>IP_MIB_STATS_ID</strong>. In this case, an <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/tcpioctl/ns-tcpioctl-ipsnmpinfo">IPSNMPInfo</a> structure is returned, and the output buffer can be allocated to "sizeof(IPSNMPInfo)".</p>

<ol start="5">
<li>Obtain Address Information about a Particular IP Entity.</li>
</ol>

<p>If the <strong>ipsi_numaddr</strong> member of the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/tcpioctl/ns-tcpioctl-ipsnmpinfo">IPSNMPInfo</a> structure returned for a particular IP entity is nonzero, an array of <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/tcpioctl/ns-tcpioctl-ipaddrentry">IPAddrEntry</a> structures can be retrieved by setting the <strong>ID.toi_entity</strong> member to identify the entity, the <strong>ID.toi_class</strong> to
<strong>INFO_CLASS_PROTOCOL</strong>, the <strong>ID.toi_type</strong> to
<strong>INFO_TYPE_PROVIDER</strong>, and the <strong>ID.toi_id</strong> to
<strong>IP_MIB_ADDRTABLE_ENTRY_ID</strong>. In this case, the output buffer should be allocated to hold an array of size:</p>

<p><code>sizeof(IPAddrEntry) * pIpSnmpInfoReturned-&gt;ipsi_numaddr</code></p>

<ol start="6">
<li>Obtain Interface Information about a Particular IP Address.</li>
</ol>

<p>More interface information can be retrieved for a given IP address returned in the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/tcpioctl/ns-tcpioctl-ipaddrentry">IPAddrEntry</a> array above by leaving the <strong>ID.toi_entity</strong> member set to identify the IP entity, the <strong>ID.toi_class</strong> set to
<strong>INFO_CLASS_PROTOCOL</strong>, and the <strong>ID.toi_type</strong> set to
<strong>INFO_TYPE_PROVIDER</strong>, and then by setting the <strong>ID.toi_id</strong> to
<strong>IP_INTFC_INFO_ID</strong> and the <strong>Context</strong> member of the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/tdiinfo/ns-tdiinfo-tcp_request_query_information_ex_w2k">TCP_REQUEST_QUERY_INFORMATION_EX</a> structure to the IPv4 or IPv6 address in question.</p>

<p>Allocate an output buffer large enough to contain <code>sizeof(IPINTERFACEINFO) + MAX_PHYSADDR_SIZE</code>.</p>

<p>On return, the output buffer contains a filled-in <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/tcpioctl/ns-tcpioctl-ipinterfaceinfo">IPInterfaceInfo</a> structure.</p>

<h4 id="examples">Examples</h4>

<p>The following example shows how to obtain a list of the entities present
on the TCP adapter on the current machine.</p>

<div class="codehilite">
<pre><span></span><code><span class="cp">#define  UNICODE</span>
<span class="cp">#define  _WIN32_WINNT  0x0500</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;windows.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iptypes.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;winternl.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;tdiinfo.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;tdistat.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;tcpioctl.h&quot;</span>

<span class="cm">/*  Function:              GetTCPHandle</span>
<span class="cm">    Description:</span>
<span class="cm">      Opens a handle to the TCP driver</span>
<span class="cm">    Parameters:</span>
<span class="cm">      pTCPDriverHandle --  Pointer to a handle variable.</span>
<span class="cm">    Return Value (<a href="dword" title="typedef unsigned long DWORD;">DWORD</a>):  Returns TRUE if successful, and places</span>
<span class="cm">                           a valid handle to the TCP driver in the</span>
<span class="cm">                           handle pointed to by pTCPDriverHandle, or</span>
<span class="cm">                           returns FALSE otherwise, and sets the</span>
<span class="cm">                           handle to INVALID_HANDLE_VALUE.</span>
<span class="cm">*/</span>
<span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="w"> </span><span class="nf">GetTCPHandle</span><span class="p">(</span><span class="w"> </span><span class="n">PHANDLE</span><span class="w"> </span><span class="n">pTCPDriverHandle</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define <a href="file_open_if" title="#define FILE_OPEN_IF 0x00000003">FILE_OPEN_IF</a>                    0x00000003</span>
<span class="cp">#define <a href="file_synchronous_io_nonalert" title="#define FILE_SYNCHRONOUS_IO_NONALERT 0x00000020">FILE_SYNCHRONOUS_IO_NONALERT</a>    0x00000020</span>
<span class="cp">#define <a href="obj_case_insensitive" title="#define OBJ_CASE_INSENSITIVE 0x00000040L">OBJ_CASE_INSENSITIVE</a>            0x00000040L</span>

<span class="k">typedef</span><span class="w"> </span><span class="n"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a></span><span class="w"> </span><span class="p">(</span><span class="n">NTAPI</span><span class="w"> </span><span class="o">*</span><span class="n">P_NT_CREATE_FILE</span><span class="p">)(</span>
<span class="w">    </span><span class="n">OUT</span><span class="w"> </span><span class="n">PHANDLE</span><span class="w">              </span><span class="n">FileHandle</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w">  </span><span class="n">ACCESS_MASK</span><span class="w">          </span><span class="n">DesiredAccess</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w">  </span><span class="n"><a href="object_attributes" title="typedef struct _OBJECT_ATTRIBUTES&#10;{&#10;    ULONG Length;&#10;    HANDLE RootDirectory;&#10;    PCUNICODE_STRING ObjectName;&#10;    ULONG Attributes;&#10;    PVOID SecurityDescriptor; // PSECURITY_DESCRIPTOR;&#10;    PVOID SecurityQualityOfService; // PSECURITY_QUALITY_OF_SERVICE&#10;} OBJECT_ATTRIBUTES, *POBJECT_ATTRIBUTES;">POBJECT_ATTRIBUTES</a></span><span class="w">   </span><span class="n">ObjectAttributes</span><span class="p">,</span>
<span class="w">    </span><span class="n">OUT</span><span class="w"> </span><span class="n"><a href="io_status_block" title="typedef struct _IO_STATUS_BLOCK&#10;{&#10;    union&#10;    {&#10;        NTSTATUS Status;&#10;        PVOID Pointer;&#10;    };&#10;    ULONG_PTR Information;&#10;} IO_STATUS_BLOCK, *PIO_STATUS_BLOCK;">PIO_STATUS_BLOCK</a></span><span class="w">     </span><span class="n">IoStatusBlock</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w">  </span><span class="n">PLARGE_INTEGER</span><span class="w">       </span><span class="n">AllocationSize</span><span class="w"> </span><span class="n">OPTIONAL</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w">  </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w">                </span><span class="n">FileAttributes</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w">  </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w">                </span><span class="n">ShareAccess</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w">  </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w">                </span><span class="n">CreateDisposition</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w">  </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w">                </span><span class="n">CreateOptions</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w">  </span><span class="n">PVOID</span><span class="w">                </span><span class="n">EaBuffer</span><span class="w"> </span><span class="n">OPTIONAL</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w">  </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w">                </span><span class="n">EaLength</span><span class="w"> </span><span class="p">);</span>

<span class="w">  </span><span class="n">HINSTANCE</span><span class="w"> </span><span class="n">hNtDLL</span><span class="p">;</span>
<span class="w">  </span><span class="n">P_NT_CREATE_FILE</span><span class="w"> </span><span class="n">pNtCreateFile</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a></span><span class="w"> </span><span class="n">rVal</span><span class="p">;</span>
<span class="w">  </span><span class="n">WCHAR</span><span class="w"> </span><span class="n">TCPDriverName</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="dd_tcp_device_name" title="#define DD_TCP_DEVICE_NAME L&quot;\\Device\\Tcp&quot;">DD_TCP_DEVICE_NAME</a></span><span class="p">;</span>

<span class="w">  </span><span class="n"><a href="object_attributes" title="typedef struct _OBJECT_ATTRIBUTES&#10;{&#10;    ULONG Length;&#10;    HANDLE RootDirectory;&#10;    PCUNICODE_STRING ObjectName;&#10;    ULONG Attributes;&#10;    PVOID SecurityDescriptor; // PSECURITY_DESCRIPTOR;&#10;    PVOID SecurityQualityOfService; // PSECURITY_QUALITY_OF_SERVICE&#10;} OBJECT_ATTRIBUTES, *POBJECT_ATTRIBUTES;">OBJECT_ATTRIBUTES</a></span><span class="w">  </span><span class="n">objectAttributes</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="io_status_block" title="typedef struct _IO_STATUS_BLOCK&#10;{&#10;    union&#10;    {&#10;        NTSTATUS Status;&#10;        PVOID Pointer;&#10;    };&#10;    ULONG_PTR Information;&#10;} IO_STATUS_BLOCK, *PIO_STATUS_BLOCK;">IO_STATUS_BLOCK</a></span><span class="w">    </span><span class="n">ioStatusBlock</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="unicode_string" title="typedef struct _UNICODE_STRING&#10;{&#10;    USHORT Length;&#10;    USHORT MaximumLength;&#10;    _Field_size_bytes_part_opt_(MaximumLength, Length) PWCH Buffer;&#10;} UNICODE_STRING, *PUNICODE_STRING;">UNICODE_STRING</a></span><span class="w">     </span><span class="n">UnicodeStr</span><span class="p">;</span>

<span class="w">  </span><span class="o">*</span><span class="n">pTCPDriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">hNtDLL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoadLibrary</span><span class="p">(</span><span class="w"> </span><span class="sa">L</span><span class="s">&quot;ntdll&quot;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="w"> </span><span class="n">FALSE</span><span class="w"> </span><span class="p">);</span>

<span class="w">  </span><span class="n">pNtCreateFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">P_NT_CREATE_FILE</span><span class="p">)</span><span class="w"> </span><span class="n">GetProcAddress</span><span class="p">(</span><span class="w"> </span><span class="n">hNtDLL</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;<a href="ntcreatefile" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtCreateFile(&#10;    _Out_ PHANDLE FileHandle,&#10;    _In_ ACCESS_MASK DesiredAccess,&#10;    _In_ PCOBJECT_ATTRIBUTES ObjectAttributes,&#10;    _Out_ PIO_STATUS_BLOCK IoStatusBlock,&#10;    _In_opt_ PLARGE_INTEGER AllocationSize,&#10;    _In_ ULONG FileAttributes,&#10;    _In_ ULONG ShareAccess,&#10;    _In_ ULONG CreateDisposition,&#10;    _In_ ULONG CreateOptions,&#10;    _In_reads_bytes_opt_(EaLength) PVOID EaBuffer,&#10;    _In_ ULONG EaLength&#10;    );">NtCreateFile</a>&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">pNtCreateFile</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="w"> </span><span class="n">FALSE</span><span class="w"> </span><span class="p">);</span>

<span class="w">  </span><span class="n">UnicodeStr</span><span class="p">.</span><span class="n">Buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TCPDriverName</span><span class="p">;</span>
<span class="w">  </span><span class="n">UnicodeStr</span><span class="p">.</span><span class="n">Length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="ushort" title="typedef unsigned short USHORT;">USHORT</a></span><span class="p">)(</span><span class="n">wcslen</span><span class="p">(</span><span class="n">TCPDriverName</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">WCHAR</span><span class="p">));</span>
<span class="w">  </span><span class="n">UnicodeStr</span><span class="p">.</span><span class="n">MaximumLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnicodeStr</span><span class="p">.</span><span class="n">Length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UNICODE_NULL</span><span class="p">);</span>

<span class="w">  </span><span class="n">objectAttributes</span><span class="p">.</span><span class="n">Length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="w"> </span><span class="n"><a href="object_attributes" title="typedef struct _OBJECT_ATTRIBUTES&#10;{&#10;    ULONG Length;&#10;    HANDLE RootDirectory;&#10;    PCUNICODE_STRING ObjectName;&#10;    ULONG Attributes;&#10;    PVOID SecurityDescriptor; // PSECURITY_DESCRIPTOR;&#10;    PVOID SecurityQualityOfService; // PSECURITY_QUALITY_OF_SERVICE&#10;} OBJECT_ATTRIBUTES, *POBJECT_ATTRIBUTES;">OBJECT_ATTRIBUTES</a></span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="n">objectAttributes</span><span class="p">.</span><span class="n">ObjectName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UnicodeStr</span><span class="p">;</span>
<span class="w">  </span><span class="n">objectAttributes</span><span class="p">.</span><span class="n">Attributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="obj_case_insensitive" title="#define OBJ_CASE_INSENSITIVE 0x00000040L">OBJ_CASE_INSENSITIVE</a></span><span class="p">;</span>
<span class="w">  </span><span class="n">objectAttributes</span><span class="p">.</span><span class="n">RootDirectory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">objectAttributes</span><span class="p">.</span><span class="n">SecurityDescriptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">objectAttributes</span><span class="p">.</span><span class="n">SecurityQualityOfService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">  </span><span class="n">rVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pNtCreateFile</span><span class="p">(</span><span class="w"> </span><span class="n">pTCPDriverHandle</span><span class="p">,</span>
<span class="w">                       </span><span class="n">SYNCHRONIZE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GENERIC_EXECUTE</span><span class="p">,</span>
<span class="w">                       </span><span class="o">&amp;</span><span class="n">objectAttributes</span><span class="p">,</span>
<span class="w">                       </span><span class="o">&amp;</span><span class="n">ioStatusBlock</span><span class="p">,</span>
<span class="w">                       </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                       </span><span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span>
<span class="w">                       </span><span class="n"><a href="file_share_read" title="#define FILE_SHARE_READ 0x00000001">FILE_SHARE_READ</a></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n"><a href="file_share_write" title="#define FILE_SHARE_WRITE 0x00000002">FILE_SHARE_WRITE</a></span><span class="p">,</span>
<span class="w">                       </span><span class="n"><a href="file_open_if" title="#define FILE_OPEN_IF 0x00000003">FILE_OPEN_IF</a></span><span class="p">,</span>
<span class="w">                       </span><span class="n"><a href="file_synchronous_io_nonalert" title="#define FILE_SYNCHRONOUS_IO_NONALERT 0x00000020">FILE_SYNCHRONOUS_IO_NONALERT</a></span><span class="p">,</span>
<span class="w">                       </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                       </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">rVal</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Failed to create TCP Driver handle; NT status code = %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rVal</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="o">*</span><span class="n">pTCPDriverHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="w"> </span><span class="n">FALSE</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="p">(</span><span class="w"> </span><span class="n">TRUE</span><span class="w"> </span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*  Function:              GetEntityList</span>
<span class="cm">    Description:</span>
<span class="cm">      Allocates a buffer for and retrieves an array of TDIEntityID</span>
<span class="cm">    structures that identifies the entities supported by</span>
<span class="cm">    the TCP/IP device driver.</span>
<span class="cm">    Parameters:</span>
<span class="cm">      TCPDriverHandle  --  An open handle to the TCP Driver; if</span>
<span class="cm">            no such handle is available,</span>
<span class="cm">            may be INVALID_HANDLE_VALUE.</span>
<span class="cm">      lplpEntities     --  Pointer to a buffer that contains</span>
<span class="cm">            the array of TDIEntityID structures.</span>
<span class="cm">            Must be freed by the calling process</span>
<span class="cm">            using LocalFree( ).</span>
<span class="cm">    Return Value:</span>
<span class="cm">      <a href="dword" title="typedef unsigned long DWORD;">DWORD</a>  --  the number of entity structures in the returned array</span>
<span class="cm">*/</span>
<span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="w"> </span><span class="nf">GetEntityArray</span><span class="p">(</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">TCPDriverHandle</span><span class="p">,</span>
<span class="w">    </span><span class="n">OUT</span><span class="w"> </span><span class="n">TDIEntityID</span><span class="w"> </span><span class="o">**</span><span class="n">lplpEntities</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">TCP_REQUEST_QUERY_INFORMATION_EX</span><span class="w">  </span><span class="n">req</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="w"> </span><span class="n">arrayLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">TDIEntityID</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAX_TDI_ENTITIES</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="w"> </span><span class="n">bufferLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arrayLen</span><span class="p">;</span>
<span class="w">  </span><span class="n">TDIEntityID</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a></span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TDI_SUCCESS</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="w"> </span><span class="n">temporaryHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="c1">// First, if the handle passed in is not valid, try to obtain one.</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">TCPDriverHandle</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INVALID_HANDLE_VALUE</span><span class="w"> </span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">GetTCPHandle</span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TCPDriverHandle</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FALSE</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="o">*</span><span class="n">lplpEntities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">temporaryHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">// Next, set up the input structure for the IOCTL operation.</span>
<span class="w">  </span><span class="n">req</span><span class="p">.</span><span class="n">ID</span><span class="p">.</span><span class="n">toi_entity</span><span class="p">.</span><span class="n">tei_entity</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">GENERIC_ENTITY</span><span class="p">;</span>
<span class="w">  </span><span class="n">req</span><span class="p">.</span><span class="n">ID</span><span class="p">.</span><span class="n">toi_entity</span><span class="p">.</span><span class="n">tei_instance</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">req</span><span class="p">.</span><span class="n">ID</span><span class="p">.</span><span class="n">toi_class</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="n">INFO_CLASS_GENERIC</span><span class="p">;</span>
<span class="w">  </span><span class="n">req</span><span class="p">.</span><span class="n">ID</span><span class="p">.</span><span class="n">toi_type</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="n">INFO_TYPE_PROVIDER</span><span class="p">;</span>
<span class="w">  </span><span class="n">req</span><span class="p">.</span><span class="n">ID</span><span class="p">.</span><span class="n">toi_id</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="n">ENTITY_LIST_ID</span><span class="p">;</span>

<span class="c1">// The loop below is defensively engineered:</span>
<span class="c1">// (1)  In the first place, it is unlikely that more</span>
<span class="c1">//     than MAX_TDI_ENTITIES of TCP/IP entities exist,</span>
<span class="c1">//     so the loop should execute only once.</span>
<span class="c1">// (2)  Execution is limited to 4 iterations to rule out</span>
<span class="c1">//     infinite looping in case of parameter corruption. Only 2</span>
<span class="c1">//     iterations should ever be necessary unless entities are</span>
<span class="c1">//     being added while the loop is running.</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="w"> </span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">pEntity</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">LocalFree</span><span class="p">(</span><span class="w"> </span><span class="n">pEntity</span><span class="w"> </span><span class="p">);</span>
<span class="w">      </span><span class="n">pEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">      </span><span class="n">bufferLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arrayLen</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">arrayLen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="n">pEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TDIEntityID</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">LocalAlloc</span><span class="p">(</span><span class="w"> </span><span class="n">LMEM_FIXED</span><span class="p">,</span><span class="w"> </span><span class="n">bufferLen</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">pEntity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">arrayLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">DeviceIoControl</span><span class="p">(</span><span class="w"> </span><span class="n">TCPDriverHandle</span><span class="p">,</span><span class="w"> </span><span class="c1">// Handle to TCP driver</span>
<span class="w">                          </span><span class="n">IOCTL_TCP_QUERY_INFORMATION_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">// Cmd code</span>
<span class="w">                          </span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span><span class="w">            </span><span class="c1">// Pointer to input buffer</span>
<span class="w">                          </span><span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">),</span><span class="w">     </span><span class="c1">// Size of ipt buffer</span>
<span class="w">                          </span><span class="n">pEntity</span><span class="p">,</span><span class="w">         </span><span class="c1">// Ptr to output buffer</span>
<span class="w">                          </span><span class="n">bufferLen</span><span class="p">,</span><span class="w">       </span><span class="c1">// Size of output buffer</span>
<span class="w">                          </span><span class="o">&amp;</span><span class="n">arrayLen</span><span class="p">,</span><span class="w">       </span><span class="c1">// Actual size of array</span>
<span class="w">                          </span><span class="nb">NULL</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">      </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetLastError</span><span class="p">(</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Even if the output buffer is too small, the TCP driver</span>
<span class="w">    </span><span class="c1">// returns a status of TDI_SUCCESS; it is the value returned in</span>
<span class="w">    </span><span class="c1">// arrayLen that indicates whether the entire array was</span>
<span class="w">    </span><span class="c1">// successfully copied to the output buffer.</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TDI_SUCCESS</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">arrayLen</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">arrayLen</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">bufferLen</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">arrayLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">temporaryHandle</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="n">CloseHandle</span><span class="p">(</span><span class="w"> </span><span class="n">TCPDriverHandle</span><span class="w"> </span><span class="p">);</span>

<span class="w">  </span><span class="o">*</span><span class="n">lplpEntities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pEntity</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="p">)(</span><span class="w"> </span><span class="n">arrayLen</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">TDIEntityID</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">  </span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="w"> </span><span class="n">entityCount</span><span class="p">;</span>
<span class="w">  </span><span class="n">TDIEntityID</span>
<span class="w">    </span><span class="o">*</span><span class="n">entityArray</span><span class="p">,</span>
<span class="w">    </span><span class="o">*</span><span class="n">entityPtr</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="w"> </span><span class="n">entityCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetEntityArray</span><span class="p">(</span><span class="w"> </span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">,</span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">entityArray</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">);</span>

<span class="w">  </span><span class="n">entityPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entityArray</span><span class="p">;</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">List of %d Transport Driver Interface Entities on this machine:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">entityCount</span><span class="w"> </span><span class="p">);</span>

<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">entityCount</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="w"> </span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">  Entity #%d:</span><span class="se">\n</span><span class="s">    Category (tei_entity) is &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="k">switch</span><span class="p">(</span><span class="w"> </span><span class="n">entityPtr</span><span class="o">-&gt;</span><span class="n">tei_entity</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">GENERIC_ENTITY</span><span class="p">:</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;Generic.&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">CL_NL_ENTITY</span><span class="p">:</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;Connectionless Network-Layer (CL_NL)&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">CO_NL_ENTITY</span><span class="p">:</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;Connected Network-Layer (CO_NL)&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">CL_TL_ENTITY</span><span class="p">:</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;Connectionless Transport-Layer (CL_TL)&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">CO_TL_ENTITY</span><span class="p">:</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;Connected Transport-Layer (CO_TL)&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">AT_ENTITY</span><span class="p">:</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;Address Translation (AT)&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">IF_ENTITY</span><span class="p">:</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;Interface (IF)&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">ER_ENTITY</span><span class="p">:</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;Echo Request/Response (ER)&quot;</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;[Unidentified Entity Type] = 0x%x&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">entityPtr</span><span class="o">-&gt;</span><span class="n">tei_entity</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> Instance (tei_instance) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">entityPtr</span><span class="o">-&gt;</span><span class="n">tei_instance</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="o">++</span><span class="n">entityPtr</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">//  Free the entity-array buffer before quitting.</span>
<span class="w">    </span><span class="n">LocalFree</span><span class="p">(</span><span class="w"> </span><span class="n">entityArray</span><span class="w"> </span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/ioapiset/nf-ioapiset-deviceiocontrol">DeviceIoControl</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/IpHlp/ip-helper-start-page">Internet Protocol Helper API</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/previous-versions/windows/desktop/mib/management-information-base-reference">Management Information Base Reference</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows/win32/api/tcpioctl/ni-tcpioctl-ioctl_tcp_query_information_ex">View the official Win32 API reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/sdk-api/blob/docs/sdk-api-src/content/tcpioctl/ni-tcpioctl-ioctl_tcp_query_information_ex.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
