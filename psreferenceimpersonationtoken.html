<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="PsReferenceImpersonationToken - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>PsReferenceImpersonationToken - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            PsReferenceImpersonationToken - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">PACCESS_TOKEN PsReferenceImpersonationToken(
  [in, out] PETHREAD                      Thread,
  [out]     PBOOLEAN                      CopyOnOpen,
  [out]     PBOOLEAN                      EffectiveOnly,
  [out]     <a href="security_impersonation_level" title="typedef enum _SECURITY_IMPERSONATION_LEVEL {&#10;  SecurityAnonymous,&#10;  SecurityIdentification,&#10;  SecurityImpersonation,&#10;  SecurityDelegation&#10;} SECURITY_IMPERSONATION_LEVEL, *PSECURITY_IMPERSONATION_LEVEL;">PSECURITY_IMPERSONATION_LEVEL</a> ImpersonationLevel
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-psreferenceimpersonationtoken">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/psreferenceimpersonationtoken.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ntifs-psreferenceimpersonationtoken)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1>PsReferenceImpersonationToken function</h1>
<h2>Description</h2>
<p>The <strong>PsReferenceImpersonationToken</strong> routine increments the reference count of the impersonation token for the specified thread.</p>
<h2>Parameters</h2>
<h3><code>Thread</code> [in, out]</h3>
<p>Address of the thread whose impersonation token's reference count is to be incremented.</p>
<h3><code>CopyOnOpen</code> [out]</h3>
<p>Pointer to a caller-allocated Boolean variable. On return, this parameter receives TRUE if the token cannot be opened directly. In this case, the token must be duplicated, and the duplicate token must be used instead. If the token can be opened directly, this parameter receives FALSE.</p>
<h3><code>EffectiveOnly</code> [out]</h3>
<p>Pointer to a caller-allocated Boolean variable. On return, this parameter receives FALSE if the thread is allowed to enable groups and privileges that are currently disabled in the client security context, TRUE otherwise.</p>
<h3><code>ImpersonationLevel</code> [out]</h3>
<p>Pointer to a caller-allocated <a href="security_impersonation_level" title="typedef enum _SECURITY_IMPERSONATION_LEVEL {&#10;  SecurityAnonymous,&#10;  SecurityIdentification,&#10;  SecurityImpersonation,&#10;  SecurityDelegation&#10;} SECURITY_IMPERSONATION_LEVEL, *PSECURITY_IMPERSONATION_LEVEL;">SECURITY_IMPERSONATION_LEVEL</a> variable. On return, this parameter receives a value that specifies the impersonation level at which the thread is allowed to access the token.</p>
<h2>Return value</h2>
<p><strong>PsReferenceImpersonationToken</strong> returns a pointer to the impersonation token for the given thread. If the thread is not currently impersonating a client, a NULL pointer is returned.</p>
<h2>Remarks</h2>
<p>If the thread is currently impersonating a client, <strong>PsReferenceImpersonationToken</strong> increments the reference count of the impersonation token and returns a pointer to the token. If the returned pointer is non-<strong>NULL</strong>, the impersonation token's reference count must be decremented by calling one of the following functions:</p>
<ul>
<li>

</li>
<li>

</li>
</ul>
<p>For more information about security and access control, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/driversecurity/windows-security-model">Windows security model for driver developers</a> and the documentation on these topics in the Windows SDK.</p>
<h2>See also</h2>
<p><strong><a href="obdereferenceobject" title="void ObDereferenceObject(&#10;  [in] a&#10;);">ObDereferenceObject</a></strong></p>
<p><strong><a href="psdereferenceimpersonationtoken" title="VOID PsDereferenceImpersonationToken(&#10;  [in] PACCESS_TOKEN ImpersonationToken&#10;);">PsDereferenceImpersonationToken</a></strong></p>
<p><strong><a href="psimpersonateclient" title="NTSTATUS PsImpersonateClient(&#10;  [in, out] PETHREAD                     Thread,&#10;  [in]      PACCESS_TOKEN                Token,&#10;  [in]      BOOLEAN                      CopyOnOpen,&#10;  [in]      BOOLEAN                      EffectiveOnly,&#10;  [in]      SECURITY_IMPERSONATION_LEVEL ImpersonationLevel&#10;);">PsImpersonateClient</a></strong></p>
<p><strong><a href="security_impersonation_level" title="typedef enum _SECURITY_IMPERSONATION_LEVEL {&#10;  SecurityAnonymous,&#10;  SecurityIdentification,&#10;  SecurityImpersonation,&#10;  SecurityDelegation&#10;} SECURITY_IMPERSONATION_LEVEL, *PSECURITY_IMPERSONATION_LEVEL;">SECURITY_IMPERSONATION_LEVEL</a></strong></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-psreferenceimpersonationtoken">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/nf-ntifs-psreferenceimpersonationtoken.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
