<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="PoFxRegisterDevice - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>PoFxRegisterDevice - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            PoFxRegisterDevice - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> PoFxRegisterDevice(
  [in]  <a href="device_object" title="typedef struct _DEVICE_OBJECT {&#10;  CSHORT                   Type;&#10;  USHORT                   Size;&#10;  LONG                     ReferenceCount;&#10;  struct _DRIVER_OBJECT    *DriverObject;&#10;  struct _DEVICE_OBJECT    *NextDevice;&#10;  struct _DEVICE_OBJECT    *AttachedDevice;&#10;  struct _IRP              *CurrentIrp;&#10;  PIO_TIMER                Timer;&#10;  ULONG                    Flags;&#10;  ULONG                    Characteristics;&#10;  __volatile PVPB          Vpb;&#10;  PVOID                    DeviceExtension;&#10;  DEVICE_TYPE              DeviceType;&#10;  CCHAR                    StackSize;&#10;  union {&#10;    LIST_ENTRY         ListEntry;&#10;    WAIT_CONTEXT_BLOCK Wcb;&#10;  } Queue;&#10;  ULONG                    AlignmentRequirement;&#10;...">PDEVICE_OBJECT</a> Pdo,
  [in]  PPO_FX_DEVICE  Device,
  [out] POHANDLE       *Handle
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-pofxregisterdevice">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/pofxregisterdevice.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdm-pofxregisterdevice)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="pofxregisterdevice-function">PoFxRegisterDevice function</h1>

<h2 id="description">Description</h2>

<p>The <strong>PoFxRegisterDevice</strong> routine registers a device with the power management framework (PoFx).</p>

<h2 id="parameters">Parameters</h2>

<h3 id="pdo-in"><code>Pdo</code> [in]</h3>

<p>A pointer to a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/">physical device object</a> (PDO). This parameter points to a <a href="device_object" title="typedef struct _DEVICE_OBJECT {&#10;  CSHORT                   Type;&#10;  USHORT                   Size;&#10;  LONG                     ReferenceCount;&#10;  struct _DRIVER_OBJECT    *DriverObject;&#10;  struct _DEVICE_OBJECT    *NextDevice;&#10;  struct _DEVICE_OBJECT    *AttachedDevice;&#10;  struct _IRP              *CurrentIrp;&#10;  PIO_TIMER                Timer;&#10;  ULONG                    Flags;&#10;  ULONG                    Characteristics;&#10;  __volatile PVPB          Vpb;&#10;  PVOID                    DeviceExtension;&#10;  DEVICE_TYPE              DeviceType;&#10;  CCHAR                    StackSize;&#10;  union {&#10;    LIST_ENTRY         ListEntry;&#10;    WAIT_CONTEXT_BLOCK Wcb;&#10;  } Queue;&#10;  ULONG                    AlignmentRequirement;&#10;...">DEVICE_OBJECT</a> structure that represents the physical device that is being registered. The caller is the power policy owner for the device, which is typically the device's function driver.</p>

<h3 id="device-in"><code>Device</code> [in]</h3>

<p>A pointer to a caller-allocated <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/ns-wdm-_po_fx_device_v1">PO_FX_DEVICE</a> structure that contains the registration information for the device. This structure contains pointers to a set of callback routines that are implemented by the device driver. PoFx calls these routines to communicate with the driver.</p>

<h3 id="handle-out"><code>Handle</code> [out]</h3>

<p>A pointer to a location into which the routine writes a handle that represents the registration of the device with PoFx. The device driver passes this handle as an input parameter to the other <strong>PoFx*Xxx</strong>* routines that it calls. The driver must first call <strong>PoFxRegisterDevice</strong> to register the device before the driver calls any other <strong>PoFx*Xxx</strong>* routines to power-manage the device.</p>

<h2 id="return-value">Return value</h2>

<p><strong>PoFxRegisterDevice</strong> returns <strong><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></strong> if the routine successfully registers the device. Possible error return values include the following status codes.</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><em>*<strong>STATUS_INVALID_PARAMETER</strong></em>*</td>
  <td><em>Pdo</em> is NULL; or the <strong>PPO_FX_DEVICE</strong> structure has an invalid version number or a component count of zero; or the number of idle states specified for a component is zero; or the description of an idle state is invalid.</td>
</tr>
<tr>
  <td><em>*<strong>STATUS_DEVICE_NOT_READY</strong></em>*</td>
  <td>The device is not ready.</td>
</tr>
<tr>
  <td><em>*<strong>STATUS_INSUFFICIENT_RESOURCES</strong></em>*</td>
  <td>Insufficient resources are available to complete the registration.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>A device driver typically calls this routine from the driver's <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/irp-mn-start-device">IRP_MN_START_DEVICE</a> request handler. The driver must not call this routine before the device receives an <strong><a href="irp_mn_start_device" title="#define IRP_MN_START_DEVICE 0x00">IRP_MN_START_DEVICE</a></strong> request. The device receives the first <strong><a href="irp_mn_start_device" title="#define IRP_MN_START_DEVICE 0x00">IRP_MN_START_DEVICE</a></strong> request when the device is being started for the first time. The device receives an additional <strong><a href="irp_mn_start_device" title="#define IRP_MN_START_DEVICE 0x00">IRP_MN_START_DEVICE</a></strong> request each time the device is restarted after being stopped for resource balancing. A <strong>PoFxRegisterDevice</strong> call to register a device that is already registered is a fatal error and causes a bug check. Note that PoFx performs a deep-copy of the device structures into its memory.</p>

<p>Before the driver calls <strong>PoFxRegisterDevice</strong>, the device must meet the following conditions:</p>

<ul>
<li>The device (that is, the PDO) is not already registered with PoFx.</li>
<li>The device is in the D0 (fully on) power state.</li>
<li>The device is in the running condition.</li>
<li>Every component in the device is in the F0 (fully on) power state.</li>
<li>Every component is in the active condition.</li>
</ul>

<p>By registering the device with PoFx, the driver assumes the responsibility for informing PoFx when a component is actively being used and when the component is idle. While the device is registered, the driver must call the <a href="pofxactivatecomponent" title="VOID PoFxActivateComponent(&#10;  [in] POHANDLE Handle,&#10;  [in] ULONG    Component,&#10;  [in] ULONG    Flags&#10;);">PoFxActivateComponent</a> routine to gain access to a component's hardware registers, and the driver must call the <a href="pofxidlecomponent" title="VOID PoFxIdleComponent(&#10;  [in] POHANDLE Handle,&#10;  [in] ULONG    Component,&#10;  [in] ULONG    Flags&#10;);">PoFxIdleComponent</a> routine to notify PoFx when the driver no longer requires access to the component.</p>

<p>After a driver calls <strong>PoFxRegisterDevice</strong> to register a device with PoFx, all components in the device are fully on and in the active condition so that the driver can finish initializing the hardware. To start active power management, the driver must call the <a href="pofxstartdevicepowermanagement" title="VOID PoFxStartDevicePowerManagement(&#10;  [in] POHANDLE Handle&#10;);">PoFxStartDevicePowerManagement</a> routine.</p>

<p>By default, <strong><a href="pofxstartdevicepowermanagement" title="VOID PoFxStartDevicePowerManagement(&#10;  [in] POHANDLE Handle&#10;);">PoFxStartDevicePowerManagement</a></strong> switches all components to the idle condition. If the driver requires a component to be in the active condition immediately after power management starts, the driver must explicitly activate the component by calling the <strong><a href="pofxactivatecomponent" title="VOID PoFxActivateComponent(&#10;  [in] POHANDLE Handle,&#10;  [in] ULONG    Component,&#10;  [in] ULONG    Flags&#10;);">PoFxActivateComponent</a></strong> routine, and this call must occur after the <strong>PoFxRegisterDevice</strong> call but before the <strong><a href="pofxstartdevicepowermanagement" title="VOID PoFxStartDevicePowerManagement(&#10;  [in] POHANDLE Handle&#10;);">PoFxStartDevicePowerManagement</a></strong> call.</p>

<p>Typically, the Kernel-Mode Driver Framework (KMDF) driver for a single-component device does not call <strong>PoFxRegisterDevice</strong> to register the device with PoFx. Instead, this driver receives a PoFx registration handle when KMDF calls the driver's <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdevice/nc-wdfdevice-evt_wdfdevice_wdm_post_po_fx_register_device">EvtDeviceWdmPostPoFxRegisterDevice</a> callback function. For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/wdf/supporting-multiple-functional-power-states-for-single-component-devices">Supporting Multiple Functional Power States for Single-Component Devices</a>.</p>

<p>For information about how the KMDF driver for a multiple-component device registers with PoFx, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/wdf/supporting-multiple-functional-power-states-for-multiple-component-devices">Supporting Multiple Functional Power States for Multiple-Component Devices</a>.</p>

<h2 id="see-also">See also</h2>

<p><a href="device_object" title="typedef struct _DEVICE_OBJECT {&#10;  CSHORT                   Type;&#10;  USHORT                   Size;&#10;  LONG                     ReferenceCount;&#10;  struct _DRIVER_OBJECT    *DriverObject;&#10;  struct _DEVICE_OBJECT    *NextDevice;&#10;  struct _DEVICE_OBJECT    *AttachedDevice;&#10;  struct _IRP              *CurrentIrp;&#10;  PIO_TIMER                Timer;&#10;  ULONG                    Flags;&#10;  ULONG                    Characteristics;&#10;  __volatile PVPB          Vpb;&#10;  PVOID                    DeviceExtension;&#10;  DEVICE_TYPE              DeviceType;&#10;  CCHAR                    StackSize;&#10;  union {&#10;    LIST_ENTRY         ListEntry;&#10;    WAIT_CONTEXT_BLOCK Wcb;&#10;  } Queue;&#10;  ULONG                    AlignmentRequirement;&#10;...">DEVICE_OBJECT</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdevice/nc-wdfdevice-evt_wdfdevice_wdm_post_po_fx_register_device">EvtDeviceWdmPostPoFxRegisterDevice</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/irp-mn-start-device">IRP_MN_START_DEVICE</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/ns-wdm-_po_fx_device_v1">PO_FX_DEVICE</a></p>

<p><a href="pofxactivatecomponent" title="VOID PoFxActivateComponent(&#10;  [in] POHANDLE Handle,&#10;  [in] ULONG    Component,&#10;  [in] ULONG    Flags&#10;);">PoFxActivateComponent</a></p>

<p><a href="pofxidlecomponent" title="VOID PoFxIdleComponent(&#10;  [in] POHANDLE Handle,&#10;  [in] ULONG    Component,&#10;  [in] ULONG    Flags&#10;);">PoFxIdleComponent</a></p>

<p><a href="pofxstartdevicepowermanagement" title="VOID PoFxStartDevicePowerManagement(&#10;  [in] POHANDLE Handle&#10;);">PoFxStartDevicePowerManagement</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-pofxregisterdevice">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/nf-wdm-pofxregisterdevice.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
