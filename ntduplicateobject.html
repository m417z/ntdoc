<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="NtDuplicateObject - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>NtDuplicateObject - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            NtDuplicateObject - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">#ifndef _NTOBAPI_H
//
// Objects, handles
//
#if (PHNT_MODE != PHNT_MODE_KERNEL)

</span><span class="ntdoc-code-intro">/**
 * The NtDuplicateObject routine creates a handle that is a duplicate of the specified source handle.
 *
 * @param SourceProcessHandle A handle to the source process for the handle being duplicated.
 * @param SourceHandle The handle to duplicate.
 * @param TargetProcessHandle A handle to the target process that is to receive the new handle. This parameter is optional and can be specified as NULL if the <a href="duplicate_close_source" title="#define DUPLICATE_CLOSE_SOURCE 0x00000001 // Close the source handle.">DUPLICATE_CLOSE_SOURCE</a> flag is set in Options.
 * @param TargetHandle A pointer to a HANDLE variable into which the routine writes the new duplicated handle. The duplicated handle is valid in the specified target process. This parameter is optional and can be specified as NULL if no duplicate handle is to be created.
 * @param DesiredAccess An ACCESS_MASK value that specifies the desired access for the new handle.
 * @param HandleAttributes A <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> that specifies the desired attributes for the new handle.
 * @param Options A set of flags to control the behavior of the duplication operation.
 * @return <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> Successful or errant status.
 * @sa https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-zwduplicateobject
 */
</span><span class="ntdoc-code-body">NTSYSCALLAPI
<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a>
NTAPI
NtDuplicateObject(
    _In_ HANDLE SourceProcessHandle,
    _In_ HANDLE SourceHandle,
    _In_opt_ HANDLE TargetProcessHandle,
    _Out_opt_ PHANDLE TargetHandle,
    _In_ ACCESS_MASK DesiredAccess,
    _In_ <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> HandleAttributes,
    _In_ <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> Options
    );
</span><span class="ntdoc-code-footer">
#endif
#endif
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://github.com/winsiderss/systeminformer/blob/addd49805cb586a891f7c6f31d88a43545cc1c80/phnt/include/ntobapi.h#L244">View code on GitHub</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">#ifndef _NTZWAPI_H

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">NTSYSCALLAPI
<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a>
NTAPI
ZwDuplicateObject(
    _In_ HANDLE SourceProcessHandle,
    _In_ HANDLE SourceHandle,
    _In_opt_ HANDLE TargetProcessHandle,
    _Out_opt_ PHANDLE TargetHandle,
    _In_ ACCESS_MASK DesiredAccess,
    _In_ <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> HandleAttributes,
    _In_ <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> Options
    );
</span><span class="ntdoc-code-footer">
#endif
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://github.com/winsiderss/systeminformer/blob/addd49805cb586a891f7c6f31d88a43545cc1c80/phnt/include/ntzwapi.h#L1710">View code on GitHub</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">NTSYSAPI <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> ZwDuplicateObject(
  [in]            HANDLE      SourceProcessHandle,
  [in]            HANDLE      SourceHandle,
  [in, optional]  HANDLE      TargetProcessHandle,
  [out, optional] PHANDLE     TargetHandle,
  [in]            ACCESS_MASK DesiredAccess,
  [in]            <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>       HandleAttributes,
  [in]            <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>       Options
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-zwduplicateobject">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<p>Allows copying handles across process boundaries and opening additional handles pointing to the same underlying kernel object. This function is <a rel="noopener" target="_blank" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-zwduplicateobject">documented in Windows Driver Kit</a>.</p>

<h1 id="parameters">Parameters</h1>

<ul>
<li><code>SourceProcessHandle</code> - a handle to the source process. This can be the <code><a href="ntcurrentprocess" title="#define NtCurrentProcess() ((HANDLE)(LONG_PTR)-1)">NtCurrentProcess</a></code> pseudo-handle or a handle granting <code><a href="process_dup_handle" title="#define PROCESS_DUP_HANDLE 0x0040">PROCESS_DUP_HANDLE</a></code> access.</li>
<li><code>SourceHandle</code> - the source handle to duplicate. This value is meaningful in the context of the source process.</li>
<li><code>TargetProcessHandle</code> - a handle to the target process. This can be the <code><a href="ntcurrentprocess" title="#define NtCurrentProcess() ((HANDLE)(LONG_PTR)-1)">NtCurrentProcess</a></code> pseudo-handle or a handle granting <code><a href="process_dup_handle" title="#define PROCESS_DUP_HANDLE 0x0040">PROCESS_DUP_HANDLE</a></code> access.</li>
<li><code>TargetHandle</code> - an optional pointer to a variable that receives the new handle. This value is meaningful in the context of the target process.</li>
<li><code>DesiredAccess</code> - the access mask to grant on the new handle.</li>
<li><code>HandleAttributes</code> - the object attribute flags to set on the new handle. Supported flags are <code><a href="obj_inherit" title="#define OBJ_INHERIT 0x00000002">OBJ_INHERIT</a></code> and <code><a href="obj_protect_close" title="#define OBJ_PROTECT_CLOSE 0x00000001">OBJ_PROTECT_CLOSE</a></code>.</li>
<li><code>Options</code> - the flags that control the behavior of the function described below.</li>
</ul>

<h1 id="supported-flags">Supported flags</h1>

<ul>
<li><code><a href="duplicate_close_source" title="#define DUPLICATE_CLOSE_SOURCE 0x00000001 // Close the source handle.">DUPLICATE_CLOSE_SOURCE</a></code> - instructs the system to close the source handle. Note that this occurs regardless of any error status returned. The target handle parameter becomes optional when using this flag.</li>
<li><code><a href="duplicate_same_access" title="#define DUPLICATE_SAME_ACCESS 0x00000002 // Instead of using the DesiredAccess parameter, copy the access rights from the source handle to the target handle.">DUPLICATE_SAME_ACCESS</a></code> - instructs the system to ignore the <code>DesiredAccess</code> parameter and copy the access mask from the source handle.</li>
<li><code><a href="duplicate_same_attributes" title="#define DUPLICATE_SAME_ATTRIBUTES 0x00000004 // Instead of using the HandleAttributes parameter, copy the attributes from the source handle to the target handle.">DUPLICATE_SAME_ATTRIBUTES</a></code> - instructs the system to ignore the <code>HandleAttributes</code> parameter and copy the handle attributes from the source handle.</li>
</ul>

<h1 id="remarks">Remarks</h1>

<p>This function offers a wide range of modes of operation:</p>

<ol>
<li>Duplicate or reopen handles within the calling process. This function allows making copies of existing handles with different access/attributes.</li>
<li>Copying handles from other processes.</li>
<li>Copying handles into other processes.</li>
<li>Closing handles in other processes.</li>
</ol>

<p>Note that this function performs an access check against the security descriptor of the source handle only when the <code>Options</code> parameter does not include the <code><a href="duplicate_same_access" title="#define DUPLICATE_SAME_ACCESS 0x00000002 // Instead of using the DesiredAccess parameter, copy the access rights from the source handle to the target handle.">DUPLICATE_SAME_ACCESS</a></code> flag.</p>

<h1 id="related-win32-api">Related Win32 API</h1>

<ul>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/en-us/windows/win32/api/handleapi/nf-handleapi-duplicatehandle"><code>DuplicateHandle</code></a></li>
</ul>

<h1 id="see-also">See also</h1>

<ul>
<li><code><a href="ntclose" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtClose(&#10;    _In_ _Post_ptr_invalid_ HANDLE Handle&#10;    );">NtClose</a></code></li>
<li><code><a href="ntqueryobject" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtQueryObject(&#10;    _In_opt_ HANDLE Handle,&#10;    _In_ OBJECT_INFORMATION_CLASS ObjectInformationClass,&#10;    _Out_writes_bytes_opt_(ObjectInformationLength) PVOID ObjectInformation,&#10;    _In_ ULONG ObjectInformationLength,&#10;    _Out_opt_ PULONG ReturnLength&#10;    );">NtQueryObject</a></code></li>
<li><code><a href="ntsetinformationobject" title="NTSYSCALLAPI&#10;NTSTATUS&#10;NTAPI&#10;NtSetInformationObject(&#10;    _In_ HANDLE Handle,&#10;    _In_ OBJECT_INFORMATION_CLASS ObjectInformationClass,&#10;    _In_reads_bytes_(ObjectInformationLength) PVOID ObjectInformation,&#10;    _In_ ULONG ObjectInformationLength&#10;    );">NtSetInformationObject</a></code></li>
</ul>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ntduplicateobject.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ntifs-zwduplicateobject)</h1>
</div>
<div class="ntdoc-description">
<h1>ZwDuplicateObject function</h1>

<h2>Description</h2>

<p>The <strong>ZwDuplicateObject</strong> routine creates a handle that is a duplicate of the specified source handle.</p>

<h2>Parameters</h2>

<h3><code>SourceProcessHandle</code> [in]</h3>

<p>A handle to the source process for the handle being duplicated.</p>

<h3><code>SourceHandle</code> [in]</h3>

<p>The handle to duplicate.</p>

<h3><code>TargetProcessHandle</code> [in, optional]</h3>

<p>A handle to the target process that is to receive the new handle. This parameter is optional and can be specified as NULL if the <strong><a href="duplicate_close_source" title="#define DUPLICATE_CLOSE_SOURCE 0x00000001 // Close the source handle.">DUPLICATE_CLOSE_SOURCE</a></strong> flag is set in <em>Options</em>.</p>

<h3><code>TargetHandle</code> [out, optional]</h3>

<p>A pointer to a HANDLE variable into which the routine writes the new duplicated handle. The duplicated handle is valid in the specified target process. This parameter is optional and can be specified as NULL if no duplicate handle is to be created.</p>

<h3><code>DesiredAccess</code> [in]</h3>

<p>An <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/access-mask">ACCESS_MASK</a> value that specifies the desired access for the new handle.</p>

<h3><code>HandleAttributes</code> [in]</h3>

<p>A <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> that specifies the desired attributes for the new handle. For more information about attributes, see the description of the <strong>Attributes</strong> member in <a href="object_attributes" title="typedef struct _OBJECT_ATTRIBUTES&#10;{&#10;    ULONG Length;&#10;    HANDLE RootDirectory;&#10;    PCUNICODE_STRING ObjectName;&#10;    ULONG Attributes;&#10;    PVOID SecurityDescriptor; // PSECURITY_DESCRIPTOR;&#10;    PVOID SecurityQualityOfService; // PSECURITY_QUALITY_OF_SERVICE&#10;} OBJECT_ATTRIBUTES, *POBJECT_ATTRIBUTES;">OBJECT_ATTRIBUTES</a>.</p>

<h3><code>Options</code> [in]</h3>

<p>A set of flags to control the behavior of the duplication operation. Set this parameter to zero or to the bitwise OR of one or more of the following flags.</p>

<table>
<thead>
<tr>
  <th>Flag name</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong><a href="duplicate_same_attributes" title="#define DUPLICATE_SAME_ATTRIBUTES 0x00000004 // Instead of using the HandleAttributes parameter, copy the attributes from the source handle to the target handle.">DUPLICATE_SAME_ATTRIBUTES</a></strong></td>
  <td>Instead of using the <em>HandleAttributes</em> parameter, copy the attributes from the source handle to the target handle.</td>
</tr>
<tr>
  <td><strong><a href="duplicate_same_access" title="#define DUPLICATE_SAME_ACCESS 0x00000002 // Instead of using the DesiredAccess parameter, copy the access rights from the source handle to the target handle.">DUPLICATE_SAME_ACCESS</a></strong></td>
  <td>Instead of using the <em>DesiredAccess</em> parameter, copy the access rights from the source handle to the target handle.</td>
</tr>
<tr>
  <td><strong><a href="duplicate_close_source" title="#define DUPLICATE_CLOSE_SOURCE 0x00000001 // Close the source handle.">DUPLICATE_CLOSE_SOURCE</a></strong></td>
  <td>Close the source handle.</td>
</tr>
</tbody>
</table>

<h2>Return value</h2>

<p><strong>ZwDuplicateObject</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the call is successful. Otherwise, it returns an appropriate error status code.</p>

<h2>Remarks</h2>

<p>The source handle is evaluated in the context of the specified source process. The calling process must have <strong><a href="process_dup_handle" title="#define PROCESS_DUP_HANDLE 0x0040">PROCESS_DUP_HANDLE</a></strong> access to the source process. The duplicate handle is created in the handle table of the specified target process. The calling process must have <strong><a href="process_dup_handle" title="#define PROCESS_DUP_HANDLE 0x0040">PROCESS_DUP_HANDLE</a></strong> access to the target process.</p>

<p>By default, the duplicate handle is created with the attributes specified by the <em>HandleAttributes</em> parameter, and with the access rights specified by the <em>DesiredAccess</em> parameter. If necessary, the caller can override one or both defaults by setting the <strong><a href="duplicate_same_attributes" title="#define DUPLICATE_SAME_ATTRIBUTES 0x00000004 // Instead of using the HandleAttributes parameter, copy the attributes from the source handle to the target handle.">DUPLICATE_SAME_ATTRIBUTES</a></strong> and <strong><a href="duplicate_same_access" title="#define DUPLICATE_SAME_ACCESS 0x00000002 // Instead of using the DesiredAccess parameter, copy the access rights from the source handle to the target handle.">DUPLICATE_SAME_ACCESS</a></strong> flags in the <em>Options</em> parameter.</p>

<p>If the call to this function occurs in user mode, you should use the name "<strong>NtDuplicateObject</strong>" instead of "<strong>ZwDuplicateObject</strong>".</p>

<p>For calls from kernel-mode drivers, the <strong>Nt*Xxx</strong>* and <strong>Zw*Xxx</strong>* versions of a Windows Native System Services routine can behave differently in the way that they handle and interpret input parameters. For more information about the relationship between the <strong>Nt*Xxx</strong>* and <strong>Zw*Xxx</strong>* versions of a routine, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/using-nt-and-zw-versions-of-the-native-system-services-routines">Using Nt and Zw Versions of the Native System Services Routines</a>.</p>

<h2>See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/access-mask">ACCESS_MASK</a></p>

<p><a href="object_attributes" title="typedef struct _OBJECT_ATTRIBUTES&#10;{&#10;    ULONG Length;&#10;    HANDLE RootDirectory;&#10;    PCUNICODE_STRING ObjectName;&#10;    ULONG Attributes;&#10;    PVOID SecurityDescriptor; // PSECURITY_DESCRIPTOR;&#10;    PVOID SecurityQualityOfService; // PSECURITY_QUALITY_OF_SERVICE&#10;} OBJECT_ATTRIBUTES, *POBJECT_ATTRIBUTES;">OBJECT_ATTRIBUTES</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/using-nt-and-zw-versions-of-the-native-system-services-routines">Using Nt and Zw Versions of the Native System Services Routines</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-zwduplicateobject">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/nf-ntifs-zwduplicateobject.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>NTinternals.net (undocumented.ntinternals.net)</h1>
</div>
<div class="ntdoc-description">
<p>This function is <a rel="noopener" target="_blank" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-zwduplicateobject">documented in Windows Driver Kit</a>.</p>

<hr />

<p>See <em>Microsoft SDK</em> for description of <code>DuplicateHandle</code> <em>Win32 API</em>.</p>

<h1>Documented by</h1>

<ul>
<li>Tomasz Nowak</li>
</ul>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/undocumented.ntinternals.net/ntduplicateobject.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
