<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="EVT_SPB_CONTROLLER_UNLOCK - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>EVT_SPB_CONTROLLER_UNLOCK - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            EVT_SPB_CONTROLLER_UNLOCK - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// spbcx.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">EVT_SPB_CONTROLLER_UNLOCK EvtSpbControllerUnlock;

VOID EvtSpbControllerUnlock(
  [in] WDFDEVICE Controller,
  [in] SPBTARGET Target,
  [in] SPBREQUEST UnlockRequest
)
{...}</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/spbcx/nc-spbcx-evt_spb_controller_unlock">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/evt_spb_controller_unlock.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nc-spbcx-evt_spb_controller_unlock)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="evt_spb_controller_unlock-callback-function">EVT_SPB_CONTROLLER_UNLOCK callback function</h1>

<h2 id="description">Description</h2>

<p>An SPB controller driver's <em>EvtSpbControllerUnlock</em> event callback function unlocks the SPB controller, which was locked by a previous call to the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/spbcx/nc-spbcx-evt_spb_controller_lock">EvtSpbControllerLock</a> event callback function.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="controller-in"><code>Controller</code> [in]</h3>

<p>A WDFDEVICE handle to the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/wdf/framework-device-object">framework device object</a> that represents the SPB controller.</p>

<h3 id="target-in"><code>Target</code> [in]</h3>

<p>An <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/spb/spbcx-object-handles">SPBTARGET</a> handle to the target for this I/O request. The target is a peripheral device or port that is attached to the bus. The SPB framework extension (SpbCx) previously assigned this handle to the target in the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/spbcx/nc-spbcx-evt_spb_target_connect">EvtSpbTargetConnect</a> callback that opened the connection to the target.</p>

<h3 id="unlockrequest-in"><code>UnlockRequest</code> [in]</h3>

<p>An <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/spb/spbcx-object-handles">SPBREQUEST</a> handle to an I/O control request to unlock the controller. Your SPB controller driver must complete this request either by performing the requested operation or by returning an error status. For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/spbcx/nc-spbcx-evt_spb_controller_unlock#remarks">Remarks</a>.</p>

<h2 id="remarks">Remarks</h2>

<p>SpbCx manages the I/O queue for the SPB controller. SpbCx calls this function when a client (peripheral driver) of the controller sends an <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/spb/spb-ioctls#ioctl_spb_unlock_controller-control-code">IOCTL_SPB_UNLOCK_CONTROLLER</a> request to a target on the bus. The <em>UnlockRequest</em> parameter value is a handle that encapsulates this request.</p>

<p>The <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/spbcx/nc-spbcx-evt_spb_controller_lock">EvtSpbControllerLock</a> and <em>EvtSpbControllerUnlock</em> functions perform complementary operations. Both functions are optional. If your SPB controller driver implements an <em>EvtSpbControllerUnlock</em> function, the driver is not required to implement an <em>EvtSpbControllerLock</em> function, but might do so. However, if your SPB controller driver implements an <em>EvtSpbControllerLock</em> function, it must also implement an <em>EvtSpbControllerUnlock</em> function. For more information, see Remarks in <a href="spb_controller_config" title="typedef struct _SPB_CONTROLLER_CONFIG {&#10;  ULONG                       Size;&#10;  WDF_IO_QUEUE_DISPATCH_TYPE  ControllerDispatchType;&#10;  WDF_TRI_STATE               PowerManaged;&#10;  PFN_SPB_TARGET_CONNECT      EvtSpbTargetConnect;&#10;  PFN_SPB_TARGET_DISCONNECT   EvtSpbTargetDisconnect;&#10;  PFN_SPB_CONTROLLER_LOCK     EvtSpbControllerLock;&#10;  PFN_SPB_CONTROLLER_UNLOCK   EvtSpbControllerUnlock;&#10;  PFN_SPB_CONTROLLER_READ     EvtSpbIoRead;&#10;  PFN_SPB_CONTROLLER_WRITE    EvtSpbIoWrite;&#10;  PFN_SPB_CONTROLLER_SEQUENCE EvtSpbIoSequence;&#10;} SPB_CONTROLLER_CONFIG, *PSPB_CONTROLLER_CONFIG;">SPB_CONTROLLER_CONFIG</a>.</p>

<p>If the SPB controller driver needs to change the mode of its controller to restore normal target selection, it can do so during the <em>EvtSpbControllerUnlock</em> callback. If this change of mode involves a long delay or requires the driver to wait for a device interrupt, the driver should initiate the mode change and then return from the callback without delay. Later, the driver can complete the unlock request in an interrupt DPC or a timer DPC.</p>

<p>An <em>EvtSpbControllerUnlock</em> callback must avoid failing an unlock request. If <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/what-s-new-in-driver-development">Driver Verifier</a> is enabled, such a failure will trigger a verifier trap, which will report to the Plug and Play manager that the controller has failed. SpbCx ignores the failure of an unlock request and does not try to handle or mitigate the failure.</p>

<p>The <em>EvtSpbControllerUnlock</em> function does not return a value. Instead, the SPB controller driver indicates the status of the unlock operation in the completion status of the I/O request that is identified by the <em>UnlockRequest</em> parameter. Set the completion status to <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a>.</p>

<p>To register an <em>EvtSpbControllerUnlock</em> callback function, call the <a href="spbdeviceinitialize" title="NTSTATUS SpbDeviceInitialize(&#10;  [in] WDFDEVICE              FxDevice,&#10;  [in] PSPB_CONTROLLER_CONFIG Config&#10;);">SpbDeviceInitialize</a> method.</p>

<p>For more information about the <em>EvtSpbControllerUnlock</em> function, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/spb/handling-client-implemented-sequences">Handling Client-Implemented Sequences</a>.</p>

<h3 id="examples">Examples</h3>

<p>To define an <em>EvtSpbControllerUnlock</em> callback function, you must first provide a function declaration that identifies the type of callback function you're defining. Windows provides a set of callback function types for drivers. Declaring a function using the callback function types helps <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/code-analysis-for-drivers">Code Analysis for Drivers</a>, <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/static-driver-verifier">Static Driver Verifier</a> (SDV), and other verification tools find errors, and it's a requirement for writing drivers for the Windows operating system.</p>

<p>For example, to define an <em>EvtSpbControllerUnlock</em> callback function that is named <code>MyEvtSpbControllerUnlock</code>, use the EVT_SPB_CONTROLLER_UNLOCK function type, as shown in this code example:</p>

<div class="codehilite">
<pre><span></span><code><span class="n">EVT_SPB_CONTROLLER_UNLOCK</span><span class="w">  </span><span class="n">MyEvtSpbControllerUnlock</span><span class="p">;</span>
</code></pre>
</div>

<p>Then, implement your callback function as follows:</p>

<div class="codehilite">
<pre><span></span><code><span class="n">_Use_decl_annotations_</span>
<span class="n">VOID</span>
<span class="w">  </span><span class="n">MyEvtSpbControllerUnlock</span><span class="p">(</span>
<span class="w">    </span><span class="n">WDFDEVICE</span><span class="w"> </span><span class="n">Controller</span><span class="p">,</span>
<span class="w">    </span><span class="n">SPBTARGET</span><span class="w"> </span><span class="n">Target</span><span class="p">,</span>
<span class="w">    </span><span class="n">SPBREQUEST</span><span class="w"> </span><span class="n">UnlockRequest</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
</code></pre>
</div>

<p>The EVT_SPB_CONTROLLER_UNLOCK function type is defined in the Spbcx.h header file. To more accurately identify errors when you run the code analysis tools, be sure to add the <em>Use_decl_annotations</em> annotation to your function definition. The <em>Use_decl_annotations</em> annotation ensures that the annotations that are applied to the EVT_SPB_CONTROLLER_UNLOCK function type in the header file are used. For more information about the requirements for function declarations, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/declaring-functions-by-using-function-role-types-for-kmdf-drivers">Declaring Functions by Using Function Role Types for KMDF Drivers</a>. For more information about <em>Use_decl_annotations</em>, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/visualstudio/code-quality/annotating-function-behavior">Annotating Function Behavior</a>.</p>

<h2 id="see-also">See also</h2>

<ul>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/spbcx/nc-spbcx-evt_spb_controller_lock">EvtSpbControllerLock</a></li>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/spbcx/nc-spbcx-evt_spb_target_connect">EvtSpbTargetConnect</a></li>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/spb/spb-ioctls#ioctl_spb_unlock_controller-control-code">IOCTL_SPB_UNLOCK_CONTROLLER</a></li>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/spb/spbcx-object-handles">SPBTARGET</a></li>
<li><a href="spb_controller_config" title="typedef struct _SPB_CONTROLLER_CONFIG {&#10;  ULONG                       Size;&#10;  WDF_IO_QUEUE_DISPATCH_TYPE  ControllerDispatchType;&#10;  WDF_TRI_STATE               PowerManaged;&#10;  PFN_SPB_TARGET_CONNECT      EvtSpbTargetConnect;&#10;  PFN_SPB_TARGET_DISCONNECT   EvtSpbTargetDisconnect;&#10;  PFN_SPB_CONTROLLER_LOCK     EvtSpbControllerLock;&#10;  PFN_SPB_CONTROLLER_UNLOCK   EvtSpbControllerUnlock;&#10;  PFN_SPB_CONTROLLER_READ     EvtSpbIoRead;&#10;  PFN_SPB_CONTROLLER_WRITE    EvtSpbIoWrite;&#10;  PFN_SPB_CONTROLLER_SEQUENCE EvtSpbIoSequence;&#10;} SPB_CONTROLLER_CONFIG, *PSPB_CONTROLLER_CONFIG;">SPB_CONTROLLER_CONFIG</a></li>
<li><a href="spbdeviceinitialize" title="NTSTATUS SpbDeviceInitialize(&#10;  [in] WDFDEVICE              FxDevice,&#10;  [in] PSPB_CONTROLLER_CONFIG Config&#10;);">SpbDeviceInitialize</a></li>
</ul>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/spbcx/nc-spbcx-evt_spb_controller_unlock">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/spbcx/nc-spbcx-evt_spb_controller_unlock.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
