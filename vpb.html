<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="VPB - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>VPB - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            VPB - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">typedef struct _VPB {
  <a href="cshort" title="typedef short CSHORT;">CSHORT</a>                Type;
  <a href="cshort" title="typedef short CSHORT;">CSHORT</a>                Size;
  <a href="ushort" title="typedef unsigned short USHORT;">USHORT</a>                Flags;
  <a href="ushort" title="typedef unsigned short USHORT;">USHORT</a>                VolumeLabelLength;
  <a href="device_object" title="typedef struct _DEVICE_OBJECT {&#10;  CSHORT                   Type;&#10;  USHORT                   Size;&#10;  LONG                     ReferenceCount;&#10;  struct _DRIVER_OBJECT    *DriverObject;&#10;  struct _DEVICE_OBJECT    *NextDevice;&#10;  struct _DEVICE_OBJECT    *AttachedDevice;&#10;  struct _IRP              *CurrentIrp;&#10;  PIO_TIMER                Timer;&#10;  ULONG                    Flags;&#10;  ULONG                    Characteristics;&#10;  __volatile PVPB          Vpb;&#10;  PVOID                    DeviceExtension;&#10;  DEVICE_TYPE              DeviceType;&#10;  CCHAR                    StackSize;&#10;  union {&#10;    LIST_ENTRY         ListEntry;&#10;    WAIT_CONTEXT_BLOCK Wcb;&#10;  } Queue;&#10;  ULONG                    AlignmentRequirement;&#10;...">struct _DEVICE_OBJECT</a> *DeviceObject;
  <a href="device_object" title="typedef struct _DEVICE_OBJECT {&#10;  CSHORT                   Type;&#10;  USHORT                   Size;&#10;  LONG                     ReferenceCount;&#10;  struct _DRIVER_OBJECT    *DriverObject;&#10;  struct _DEVICE_OBJECT    *NextDevice;&#10;  struct _DEVICE_OBJECT    *AttachedDevice;&#10;  struct _IRP              *CurrentIrp;&#10;  PIO_TIMER                Timer;&#10;  ULONG                    Flags;&#10;  ULONG                    Characteristics;&#10;  __volatile PVPB          Vpb;&#10;  PVOID                    DeviceExtension;&#10;  DEVICE_TYPE              DeviceType;&#10;  CCHAR                    StackSize;&#10;  union {&#10;    LIST_ENTRY         ListEntry;&#10;    WAIT_CONTEXT_BLOCK Wcb;&#10;  } Queue;&#10;  ULONG                    AlignmentRequirement;&#10;...">struct _DEVICE_OBJECT</a> *RealDevice;
  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                 SerialNumber;
  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                 ReferenceCount;
  WCHAR                 VolumeLabel[MAXIMUM_VOLUME_LABEL_LENGTH / sizeof(WCHAR)];
} VPB, *PVPB;</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/ns-wdm-_vpb">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/vpb.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ns-wdm-_vpb)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2>Description</h2>

<p>The volume parameter block (VPB) structure is used to map a device object that represents a mounted file system volume to a device object that represents a physical or virtual disk device.</p>

<h2>Members</h2>

<h3><code>Type</code></h3>

<p>A read-only member that is used by the system to indicate that the structure is a VPB object.</p>

<h3><code>Size</code></h3>

<p>A read-only member that is used by the system to indicate that the structure is a VPB object.</p>

<h3><code>Flags</code></h3>

<table>
<thead>
<tr>
  <th>Value</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td>VPB_MOUNTED</td>
  <td>This bit is set by the I/O manager to indicate that the file system has mounted the logical volume.</td>
</tr>
<tr>
  <td>VPB_LOCKED</td>
  <td>This bit can be set or cleared by the file system driver that has mounted the logical volume. When set, the I/O manager will fail all subsequent create/open requests that are targeted at the logical volume. File systems may choose to set this member in response to application requests to lock the volume, or if they temporarily wish to prevent any create/open request from proceeding.</td>
</tr>
<tr>
  <td>VPB_PERSISTENT</td>
  <td>This bit can be set or cleared by file system drivers. If set, the I/O manager will not delete the VPB structure even if <strong>ReferenceCount</strong> is zero.</td>
</tr>
<tr>
  <td>VPB_REMOVE_PENDING</td>
  <td>Set by the Plug and Play (PnP) manager to indicate that the underlying device is being removed.</td>
</tr>
<tr>
  <td>VPB_RAW_MOUNT</td>
  <td>Indicates that only the RAW file system can be mounted on the device.</td>
</tr>
<tr>
  <td>VPB_DIRECT_WRITES_ALLOWED</td>
  <td>Indicates that direct write operations to the volume are allowed. This flag is set either by the I/O manager when the RAW file system is mounted or by the file system itself when it determines that the volume can be safely written to. It is typically safe to write to a volume when the file system is dismounted.</td>
</tr>
</tbody>
</table>

<h3><code>VolumeLabelLength</code></h3>

<p>A read/write member that specifies the length of the volume label, in bytes. This member must be set by the file system driver. If the volume has no label, this member must be set to zero.</p>

<h3><code>DeviceObject</code></h3>

<p>A read/write member, set by the file system driver, which points to a device object of type <strong>FILE_DEVICE_DISK_FILE_SYSTEM</strong>. This device object is created by the file system driver to represent the mounted volume.</p>

<h3><code>RealDevice</code></h3>

<p>A read-only member, set by the I/O manager, which points to the device object for a physical or virtual disk device that contains the mountable logical volume (pointed to by <strong>DeviceObject</strong>).</p>

<h3><code>SerialNumber</code></h3>

<p>A read/write member that specifies the serial number associated with the file system volume. This member should be set by the file system driver, if available.</p>

<h3><code>ReferenceCount</code></h3>

<p>A read-only member that specifies the reference count for the VPB structure. If the reference count for the VPB structure is greater than zero, the I/O manager does not deallocate the VPB structure. Be aware that <strong>ReferenceCount</strong> can be considered a read/write member when a file system driver must keep the volume present to process a tear down request.</p>

<h3><code>VolumeLabel</code></h3>

<p>A read/write member, set by the file system driver, that specifies the label of the mounted volume. The length of the volume label must be 32 wide-characters or less. Currently <strong>MAXIMUM_VOLUME_LABEL_LENGTH</strong> is defined as follows:</p>

<div class="codehilite">
<pre><span></span><code><span class="cp">#define MAXIMUM_VOLUME_LABEL_LENGTH  (32 * sizeof(WCHAR));</span>
</code></pre>
</div>

<h2>Remarks</h2>

<p>A volume parameter block (VPB) object is used to create an association between a physical disk device object and a logical volume device object. That is, a VPB maps a file system's volume device object to the device or partition upon which the volume is mounted. A VPB object exists only for device objects that represent physical media, virtual media, or logical media that can be mounted.</p>

<p>The I/O manager allocates and deallocates memory for the VPB structure from nonpaged pool. This allocation (or deallocation) occurs when a device object (as described previously) is created by calling either the <a href="iocreatedevice" title="NTSTATUS IoCreateDevice(&#10;  [in]           PDRIVER_OBJECT  DriverObject,&#10;  [in]           ULONG           DeviceExtensionSize,&#10;  [in, optional] PUNICODE_STRING DeviceName,&#10;  [in]           DEVICE_TYPE     DeviceType,&#10;  [in]           ULONG           DeviceCharacteristics,&#10;  [in]           BOOLEAN         Exclusive,&#10;  [out]          PDEVICE_OBJECT  *DeviceObject&#10;);">IoCreateDevice</a> or <a href="ioverifyvolume" title="NTSTATUS IoVerifyVolume(&#10;  [in] PDEVICE_OBJECT DeviceObject,&#10;  [in] BOOLEAN        AllowRawMount&#10;);">IoVerifyVolume</a> functions. That is, the device object that is created must be one of the following types:</p>

<ul>
<li><p>FILE_DEVICE_DISK</p></li>
<li><p>FILE_DEVICE_CD_ROM</p></li>
<li><p>FILE_DEVICE_TAPE</p></li>
<li><p>FILE_DEVICE_VIRTUAL_DISK</p></li>
</ul>

<p>For more information about device object types, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/specifying-device-types">Specifying Device Types</a>.</p>

<p>Drivers must call <a href="ioacquirevpbspinlock" title="VOID IoAcquireVpbSpinLock(&#10;  [out] PKIRQL Irql&#10;);">IoAcquireVpbSpinLock</a> before they access any applicable members of the VPB object.</p>

<p>Opaque members should be considered inaccessible. Drivers with dependencies on object member locations or access to opaque members might not remain portable and interoperable with other drivers over time.</p>

<p>Drivers can use read-only members to acquire relevant information. Drivers must not modify read-only members or the object that the member points to, if the member is a pointer.</p>

<h2>See also</h2>

<p><strong><a href="device_object" title="typedef struct _DEVICE_OBJECT {&#10;  CSHORT                   Type;&#10;  USHORT                   Size;&#10;  LONG                     ReferenceCount;&#10;  struct _DRIVER_OBJECT    *DriverObject;&#10;  struct _DEVICE_OBJECT    *NextDevice;&#10;  struct _DEVICE_OBJECT    *AttachedDevice;&#10;  struct _IRP              *CurrentIrp;&#10;  PIO_TIMER                Timer;&#10;  ULONG                    Flags;&#10;  ULONG                    Characteristics;&#10;  __volatile PVPB          Vpb;&#10;  PVOID                    DeviceExtension;&#10;  DEVICE_TYPE              DeviceType;&#10;  CCHAR                    StackSize;&#10;  union {&#10;    LIST_ENTRY         ListEntry;&#10;    WAIT_CONTEXT_BLOCK Wcb;&#10;  } Queue;&#10;  ULONG                    AlignmentRequirement;&#10;...">DEVICE_OBJECT</a></strong></p>

<p><strong><a href="file_object" title="typedef struct _FILE_OBJECT {&#10;  CSHORT                                Type;&#10;  CSHORT                                Size;&#10;  PDEVICE_OBJECT                        DeviceObject;&#10;  PVPB                                  Vpb;&#10;  PVOID                                 FsContext;&#10;  PVOID                                 FsContext2;&#10;  PSECTION_OBJECT_POINTERS              SectionObjectPointer;&#10;  PVOID                                 PrivateCacheMap;&#10;  NTSTATUS                              FinalStatus;&#10;  struct _FILE_OBJECT                   *RelatedFileObject;&#10;  BOOLEAN                               LockOperation;&#10;  BOOLEAN                               DeletePending;&#10;  BOOLEAN                               ReadAccess;&#10;  BOOLEAN                               WriteAccess;&#10;  BOOLEAN                               DeleteAccess;&#10;  BOOLEAN                               SharedRead;&#10;  BOOLEAN                               SharedWrite;&#10;  BOOLEAN                               SharedDelete;&#10;  ULONG                                 Flags;&#10;...">FILE_OBJECT</a></strong></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ifs/how-the-volume-is-mounted">How the Volume Is Mounted</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/ns-wdm-_vpb">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/ns-wdm-_vpb.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
