<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="WdfMemoryCreate - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>WdfMemoryCreate - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            WdfMemoryCreate - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdfmemory.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> WdfMemoryCreate(
  [in, optional]  <a href="wdf_object_attributes" title="typedef struct _WDF_OBJECT_ATTRIBUTES {&#10;  ULONG                          Size;&#10;  PFN_WDF_OBJECT_CONTEXT_CLEANUP EvtCleanupCallback;&#10;  PFN_WDF_OBJECT_CONTEXT_DESTROY EvtDestroyCallback;&#10;  WDF_EXECUTION_LEVEL            ExecutionLevel;&#10;  WDF_SYNCHRONIZATION_SCOPE      SynchronizationScope;&#10;  WDFOBJECT                      ParentObject;&#10;  size_t                         ContextSizeOverride;&#10;  PCWDF_OBJECT_CONTEXT_TYPE_INFO ContextTypeInfo;&#10;} WDF_OBJECT_ATTRIBUTES, *PWDF_OBJECT_ATTRIBUTES;">PWDF_OBJECT_ATTRIBUTES</a> Attributes,
  [in]            <a href="pool_type" title="typedef enum _POOL_TYPE {&#10;    NonPagedPool,&#10;    NonPagedPoolExecute = NonPagedPool,&#10;    PagedPool,&#10;    NonPagedPoolMustSucceed = NonPagedPool + 2,&#10;    DontUseThisType,&#10;    NonPagedPoolCacheAligned = NonPagedPool + 4,&#10;    PagedPoolCacheAligned,&#10;    NonPagedPoolCacheAlignedMustS = NonPagedPool + 6,&#10;    MaxPoolType,&#10;    NonPagedPoolBase = 0,&#10;    NonPagedPoolBaseMustSucceed = NonPagedPoolBase + 2,&#10;    NonPagedPoolBaseCacheAligned = NonPagedPoolBase + 4,&#10;    NonPagedPoolBaseCacheAlignedMustS = NonPagedPoolBase + 6,&#10;    NonPagedPoolSession = 32,&#10;    PagedPoolSession = NonPagedPoolSession + 1,&#10;    NonPagedPoolMustSucceedSession = PagedPoolSession + 1,&#10;    DontUseThisTypeSession = NonPagedPoolMustSucceedSession + 1,&#10;    NonPagedPoolCacheAlignedSession = DontUseThisTypeSession + 1,&#10;    PagedPoolCacheAlignedSession = NonPagedPoolCacheAlignedSession + 1,&#10;...">POOL_TYPE</a>              PoolType,
  [in, optional]  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                  PoolTag,
  [in]            <a href="size_t" title="typedef unsigned __int64 size_t;">size_t</a>                 BufferSize,
  [out]           WDFMEMORY              *Memory,
  [out, optional] PVOID                  *Buffer
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfmemory/nf-wdfmemory-wdfmemorycreate">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/wdfmemorycreate.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdfmemory-wdfmemorycreate)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="wdfmemorycreate-function">WdfMemoryCreate function</h1>

<h2 id="description">Description</h2>

<p>[Applies to KMDF and UMDF]</p>

<p>The <strong>WdfMemoryCreate</strong> method creates a framework memory object and allocates a memory buffer of a specified size.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="attributes-in-optional"><code>Attributes</code> [in, optional]</h3>

<p>A pointer to a <a rel="noopener" target="_blank" href="wdf_object_attributes">WDF_OBJECT_ATTRIBUTES</a> structure that contains object attributes for the new memory object. This parameter is optional and can be WDF_NO_OBJECT_ATTRIBUTES.</p>

<h3 id="pooltype-in"><code>PoolType</code> [in]</h3>

<p>A <a rel="noopener" target="_blank" href="pool_type">POOL_TYPE</a>-typed value that specifies the type of memory to be allocated.</p>

<h3 id="pooltag-in-optional"><code>PoolTag</code> [in, optional]</h3>

<p>A driver-defined pool tag for the allocated memory. Debuggers display this tag. Drivers typically specify a character string of up to four characters, delimited by single quotation marks, in reverse order (for example, 'dcba'). The ASCII value of each character in the tag must be between 0 and 127. Debugging your driver is easier if each pool tag is unique.</p>

<p>If <em>PoolTag</em> is zero, the framework provides a default pool tag that uses the first four characters of your driver's kernel-mode service name. If the service name begins with "WDF" (the name is not case sensitive and does not include the quotation marks), the next four characters are used. If fewer than four characters are available, "FxDr" is used.</p>

<p>For KMDF versions 1.5 and later, your driver can use the <strong>DriverPoolTag</strong> member of the <a rel="noopener" target="_blank" href="wdf_driver_config">WDF_DRIVER_CONFIG</a> structure to specify a default pool tag.</p>

<h3 id="buffersize-in"><code>BufferSize</code> [in]</h3>

<p>The nonzero specified size, in bytes, of the buffer.</p>

<h3 id="memory-out"><code>Memory</code> [out]</h3>

<p>A pointer to a location that receives a handle to the new memory object.</p>

<h3 id="buffer-out-optional"><code>Buffer</code> [out, optional]</h3>

<p>A pointer to a location that receives a pointer to the buffer that is associated with the new memory object. This parameter is optional and can be <strong>NULL</strong>.</p>

<h2 id="return-value">Return value</h2>

<p><strong>WdfMemoryCreate</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the operation succeeds. Otherwise, this method might return one of the following values:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>STATUS_INVALID_PARAMETER</strong></td>
  <td>An invalid parameter was detected.</td>
</tr>
<tr>
  <td><strong>STATUS_INSUFFICIENT_RESOURCES</strong></td>
  <td>There was insufficient memory.</td>
</tr>
</tbody>
</table>

<p>For a list of other return values that the <strong>WdfMemoryCreate</strong> method might return, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/wdf/framework-object-creation-errors">Framework Object Creation Errors</a>.</p>

<p>This method also might return other <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/ntstatus-values">NTSTATUS values</a>.</p>

<h2 id="remarks">Remarks</h2>

<p>The <strong>WdfMemoryCreate</strong> method allocates a buffer of the size that the <em>BufferSize</em> parameter specifies and creates a framework memory object that represents the buffer.</p>

<p>To obtain the buffer's address, your driver can supply a non-<strong>NULL</strong> value for the <strong>WdfMemoryCreate</strong> function's <em>Buffer</em> parameter, or the driver can call <a rel="noopener" target="_blank" href="wdfmemorygetbuffer">WdfMemoryGetBuffer</a>.</p>

<p>It is good practice to zero memory for memory allocation, especially for allocations that will be copied to an untrusted location (user mode, over the network, etc.) to avoid disclosing sensitive information.
<strong>WdfMemoryCreate</strong> does not zero initialize allocated memory by default.</p>

<p>Based on the driver's usage pattern of the allocated memory, the recommendation for driver writers is to consider:</p>

<ul>
<li><a rel="noopener" target="_blank" href="rtlzeromemory"><strong>RtlZeroMemory</strong></a> immediately after calling <strong>WdfMemoryCreate</strong></li>
<li>Or, use a zero-allocation API (<a rel="noopener" target="_blank" href="exallocatepool2"><strong>ExAllocatePool2</strong></a>, <a rel="noopener" target="_blank" href="exallocatepoolzero"><strong>ExAllocatePoolZero</strong></a> for kernel mode; <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/heapapi/nf-heapapi-heapalloc"><strong>HeapAlloc</strong></a> with the <strong>HEAP_ZERO_MEMORY</strong> flag for user mode), followed by <a rel="noopener" target="_blank" href="wdfmemorycreatepreallocated"><strong>WdfMemoryCreatePreallocated</strong></a>. Because pre-allocated buffer is not automatically deleted as part of WDFMEMORY or its parent deletion, this is not the best approach.</li>
</ul>

<p>The default parent object for each memory object is the framework driver object that represents the driver that called <strong>WdfMemoryCreate</strong>. If your driver creates a memory object that it uses with a specific device object, request object, or other framework object, it should set the memory object's parent appropriately. The memory object and its buffer will be deleted when the parent object is deleted. If you do not change the default parent object, the memory object and its buffer will remain until the I/O manager unloads your driver.</p>

<p>A driver can also delete a memory object and its buffer by calling <a rel="noopener" target="_blank" href="wdfobjectdelete">WdfObjectDelete</a>.</p>

<p>If <em>BufferSize</em> is less than <a href="page_size" title="#define PAGE_SIZE 0x1000">PAGE_SIZE</a>, the operating system gives the caller exactly the number of requested bytes of memory. The buffer is not necessarily page-aligned, but it is aligned by the number of bytes that the <a href="memory_allocation_alignment" title="#define MEMORY_ALLOCATION_ALIGNMENT 16">MEMORY_ALLOCATION_ALIGNMENT</a> constant specifies in <em>Ntdef.h</em>.</p>

<p>If <em>BufferSize</em> is <a href="page_size" title="#define PAGE_SIZE 0x1000">PAGE_SIZE</a> or greater, for KMDF only the system allocates a page-aligned buffer. If the <em>PoolType</em> parameter is <strong>NonPagedPool</strong>, the system allocates the number of pages that are necessary to hold all of the bytes. Any unused bytes on the last-allocated page are essentially wasted.</p>

<p>For more information about framework memory objects, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/wdf/using-memory-buffers">Using Memory Buffers</a>.</p>

<p>If your driver specifies <strong>PagedPool</strong> for <em>PoolType</em>, the <strong>WdfMemoryCreate</strong> method must be called at IRQL &lt;= APC_LEVEL. Otherwise, the method can be called at IRQL &lt;= DISPATCH_LEVEL.</p>

<h4 id="examples">Examples</h4>

<p>The following code example creates a framework memory object and allocates a buffer whose size is WRITE_BUFFER_SIZE. The memory object's parent is a request object.</p>

<div class="codehilite">
<pre><span></span><code><span class="n"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a></span><span class="w">  </span><span class="n">status</span><span class="p">;</span>
<span class="n"><a href="wdf_object_attributes" title="typedef struct _WDF_OBJECT_ATTRIBUTES {&#10;  ULONG                          Size;&#10;  PFN_WDF_OBJECT_CONTEXT_CLEANUP EvtCleanupCallback;&#10;  PFN_WDF_OBJECT_CONTEXT_DESTROY EvtDestroyCallback;&#10;  WDF_EXECUTION_LEVEL            ExecutionLevel;&#10;  WDF_SYNCHRONIZATION_SCOPE      SynchronizationScope;&#10;  WDFOBJECT                      ParentObject;&#10;  size_t                         ContextSizeOverride;&#10;  PCWDF_OBJECT_CONTEXT_TYPE_INFO ContextTypeInfo;&#10;} WDF_OBJECT_ATTRIBUTES, *PWDF_OBJECT_ATTRIBUTES;">WDF_OBJECT_ATTRIBUTES</a></span><span class="w">  </span><span class="n">attributes</span><span class="p">;</span>
<span class="n">WDFMEMORY</span><span class="w">  </span><span class="n">writeBufferMemHandle</span><span class="p">;</span>
<span class="n">PVOID</span><span class="w">  </span><span class="n">writeBufferPointer</span><span class="p">;</span>

<span class="n"><a href="wdf_object_attributes_init" title="VOID WDF_OBJECT_ATTRIBUTES_INIT(&#10;  [out] PWDF_OBJECT_ATTRIBUTES Attributes&#10;);">WDF_OBJECT_ATTRIBUTES_INIT</a></span><span class="p">(</span><span class="o">&amp;</span><span class="n">attributes</span><span class="p">);</span>
<span class="n">attributes</span><span class="p">.</span><span class="n">ParentObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestHandle</span><span class="p">;</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WdfMemoryCreate</span><span class="p">(</span>
<span class="w">                         </span><span class="o">&amp;</span><span class="n">attributes</span><span class="p">,</span>
<span class="w">                         </span><span class="n">NonPagedPool</span><span class="p">,</span>
<span class="w">                         </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                         </span><span class="n">WRITE_BUFFER_SIZE</span><span class="p">,</span>
<span class="w">                         </span><span class="o">&amp;</span><span class="n">writeBufferMemHandle</span><span class="p">,</span>
<span class="w">                         </span><span class="o">&amp;</span><span class="n">writeBufferPointer</span>
<span class="w">                         </span><span class="p">);</span>
</code></pre>
</div>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="pool_type">POOL_TYPE</a></p>

<p><a rel="noopener" target="_blank" href="wdf_object_attributes">WDF_OBJECT_ATTRIBUTES</a></p>

<p><a rel="noopener" target="_blank" href="wdf_object_attributes_init">WDF_OBJECT_ATTRIBUTES_INIT</a></p>

<p><a rel="noopener" target="_blank" href="wdfmemorycreatefromlookaside">WdfMemoryCreateFromLookaside</a></p>

<p><a rel="noopener" target="_blank" href="wdfmemorycreatepreallocated">WdfMemoryCreatePreallocated</a></p>

<p><a rel="noopener" target="_blank" href="wdfmemorygetbuffer">WdfMemoryGetBuffer</a></p>

<p><a rel="noopener" target="_blank" href="wdfobjectdelete">WdfObjectDelete</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfmemory/nf-wdfmemory-wdfmemorycreate">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdfmemory/nf-wdfmemory-wdfmemorycreate.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
