<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="IOCTL_EHSTOR_BANDMGMT_CREATE_BAND - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>IOCTL_EHSTOR_BANDMGMT_CREATE_BAND - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            IOCTL_EHSTOR_BANDMGMT_CREATE_BAND - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ehstorbandmgmt.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x002d, 0x524, METHOD_BUFFERED, FILE_READ_ACCESS | FILE_WRITE_ACCESS)
#define IOCTL_EHSTOR_BANDMGMT_CREATE_BAND 0x002DD490</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ehstorbandmgmt/ni-ehstorbandmgmt-ioctl_ehstor_bandmgmt_create_band">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ioctl_ehstor_bandmgmt_create_band.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ni-ehstorbandmgmt-ioctl_ehstor_bandmgmt_create_band)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="ioctl_ehstor_bandmgmt_create_band-ioctl">IOCTL_EHSTOR_BANDMGMT_CREATE_BAND IOCTL</h1>

<h2 id="description">Description</h2>

<p>New bands are created on a band-managed storage device with the <strong>IOCTL_EHSTOR_BANDMGMT_CREATE_BAND</strong> request. A new band is added to the table of band entries, which includes band location and security properties.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="major-code">Major code</h3>

<h3 id="input-buffer">Input buffer</h3>

<p>The buffer at <em>Irp->AssociatedIrp.SystemBuffer</em> must contain an <a href="create_band_parameters" title="typedef struct _CREATE_BAND_PARAMETERS {&#10;  ULONG StructSize;&#10;  ULONG Flags;&#10;  ULONG BandLocationInfoOffset;&#10;  ULONG BandSecurityInfoOffset;&#10;  ULONG AuthKeyOffset;&#10;} CREATE_BAND_PARAMETERS, *PCREATE_BAND_PARAMETERS;">CREATE_BAND_PARAMETERS</a> structure followed by the <a href="band_location_info" title="typedef struct _BAND_LOCATION_INFO {&#10;  ULONG         StructSize;&#10;  ULONG         Reserved;&#10;  LARGE_INTEGER BandStart;&#10;  LARGE_INTEGER BandSize;&#10;  BYTE          Metadata[32];&#10;} BAND_LOCATION_INFO, *PBAND_LOCATION_INFO;">BAND_LOCATION_INFO</a>, <a href="band_security_info" title="typedef struct _BAND_SECURITY_INFO {&#10;  ULONG      StructSize;&#10;  LOCKSTATE  ReadLock;&#10;  LOCKSTATE  WriteLock;&#10;  ALGOIDTYPE CryptoAlgoIdType;&#10;  union {&#10;    struct {&#10;      ULONG Offset;&#10;      ULONG Length;&#10;    } CryptoAlgoOidString;&#10;    ULONG CryptoAlgoNumericId;&#10;  };&#10;  BYTE       Metadata[32];&#10;} BAND_SECURITY_INFO, *PBAND_SECURITY_INFO;">BAND_SECURITY_INFO</a>, and <strong>AUTH_KEY</strong> structures.</p>

<p>If the <strong>AuthKeyOffset</strong> member of <a href="create_band_parameters" title="typedef struct _CREATE_BAND_PARAMETERS {&#10;  ULONG StructSize;&#10;  ULONG Flags;&#10;  ULONG BandLocationInfoOffset;&#10;  ULONG BandSecurityInfoOffset;&#10;  ULONG AuthKeyOffset;&#10;} CREATE_BAND_PARAMETERS, *PCREATE_BAND_PARAMETERS;">CREATE_BAND_PARAMETERS</a> is set to <strong>EHSTOR_BANDMGR_NO_KEY</strong>, the input data in the system buffer need not include an <strong>AUTH_KEY</strong> structure.</p>

<h3 id="input-buffer-length">Input buffer length</h3>

<p><em>Parameters.DeviceIoControl.InputBufferLength</em> indicates the size, in bytes, of the buffer, which must be at least <strong>sizeof</strong> (<a href="create_band_parameters" title="typedef struct _CREATE_BAND_PARAMETERS {&#10;  ULONG StructSize;&#10;  ULONG Flags;&#10;  ULONG BandLocationInfoOffset;&#10;  ULONG BandSecurityInfoOffset;&#10;  ULONG AuthKeyOffset;&#10;} CREATE_BAND_PARAMETERS, *PCREATE_BAND_PARAMETERS;">CREATE_BAND_PARAMETERS</a>) + <strong>sizeof</strong>(<a href="band_location_info" title="typedef struct _BAND_LOCATION_INFO {&#10;  ULONG         StructSize;&#10;  ULONG         Reserved;&#10;  LARGE_INTEGER BandStart;&#10;  LARGE_INTEGER BandSize;&#10;  BYTE          Metadata[32];&#10;} BAND_LOCATION_INFO, *PBAND_LOCATION_INFO;">BAND_LOCATION_INFO</a>) +  *<em>sizeof</em>* (<a href="band_security_info" title="typedef struct _BAND_SECURITY_INFO {&#10;  ULONG      StructSize;&#10;  LOCKSTATE  ReadLock;&#10;  LOCKSTATE  WriteLock;&#10;  ALGOIDTYPE CryptoAlgoIdType;&#10;  union {&#10;    struct {&#10;      ULONG Offset;&#10;      ULONG Length;&#10;    } CryptoAlgoOidString;&#10;    ULONG CryptoAlgoNumericId;&#10;  };&#10;  BYTE       Metadata[32];&#10;} BAND_SECURITY_INFO, *PBAND_SECURITY_INFO;">BAND_SECURITY_INFO</a>) + *<em>sizeof</em>*(AUTH_KEY).</p>

<h3 id="output-buffer">Output buffer</h3>

<p>The output buffer at <em>Irp->AssociatedIrp.SystemBuffer</em> optionally contains a <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> value for the identifier of the newly created band.</p>

<h3 id="output-buffer-length">Output buffer length</h3>

<p><em>Parameters.DeviceIoControl.OutputBufferLength</em> must be at least <strong>sizeof</strong>(<a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>) to receive the band identifier. If return of the band identifier is not wanted, set <em>Parameters.DeviceIoControl.OutputBufferLength</em> to 0.</p>

<h3 id="inputoutput-buffer">Input/output buffer</h3>

<h3 id="inputoutput-buffer-length">Input/output buffer length</h3>

<h3 id="status-block">Status block</h3>

<p>One of the following values can be returned in the <strong>Status</strong> field.</p>

<table>
<thead>
<tr>
  <th>Status Value</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></td>
  <td>The new band was created.</td>
</tr>
<tr>
  <td>STATUS_INVALID_DEVICE_REQUEST</td>
  <td>The storage device does not support band management.</td>
</tr>
<tr>
  <td>STATUS_INVALID_BUFFER_SIZE</td>
  <td>The input buffer size is invalid.</td>
</tr>
<tr>
  <td>STATUS_INVALID_PARAMETER</td>
  <td>Information in the input buffer is invalid.</td>
</tr>
<tr>
  <td>STATUS_CONFLICTING_ADDRESSES</td>
  <td>The band was not created due to overlapping locations.</td>
</tr>
<tr>
  <td>STATUS_INSUFFICIENT_RESOURCES</td>
  <td>The band was not created because the band table is already full.</td>
</tr>
<tr>
  <td>STATUS_IO_DEVICE_ERROR</td>
  <td>Communication failed. The storage device might be incompatible with security protocols.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>Assigning an authentication key to a newly created band is optional. If no key is provided, where <strong>AuthKeyOffset</strong> = <strong>EHSTOR_BANDMGR_NO_KEY</strong> in the <a href="create_band_parameters" title="typedef struct _CREATE_BAND_PARAMETERS {&#10;  ULONG StructSize;&#10;  ULONG Flags;&#10;  ULONG BandLocationInfoOffset;&#10;  ULONG BandSecurityInfoOffset;&#10;  ULONG AuthKeyOffset;&#10;} CREATE_BAND_PARAMETERS, *PCREATE_BAND_PARAMETERS;">CREATE_BAND_PARAMETERS</a> structure, a default authentication key is used. However, this leaves the band vulnerable to another caller who may take control over the band immediately after its creation by changing its authentication key. It is recommended to assign a non-default authentication key to the band at creation time.</p>

<p>The changes made to the band table by this request are committed to the device atomically before the IOCTL request completes. Therefore, it is guaranteed that the band is created with all of its properties set or not created at all should a system or power failure occur.</p>

<p>The location of the new band must not overlap with an existing band or this request will fail with STATUS_CONFLICTING_ADDRESSES.</p>

<p>If the band is unlocked, either the <strong>ReadLock</strong> or <strong>WriteLock</strong> members of <a href="band_security_info" title="typedef struct _BAND_SECURITY_INFO {&#10;  ULONG      StructSize;&#10;  LOCKSTATE  ReadLock;&#10;  LOCKSTATE  WriteLock;&#10;  ALGOIDTYPE CryptoAlgoIdType;&#10;  union {&#10;    struct {&#10;      ULONG Offset;&#10;      ULONG Length;&#10;    } CryptoAlgoOidString;&#10;    ULONG CryptoAlgoNumericId;&#10;  };&#10;  BYTE       Metadata[32];&#10;} BAND_SECURITY_INFO, *PBAND_SECURITY_INFO;">BAND_SECURITY_INFO</a> are set to FALSE, and <strong>CREATEBAND_AUTHKEY_CACHING_ENABLED</strong> is set in the <strong>Flags</strong> member of <a href="create_band_parameters" title="typedef struct _CREATE_BAND_PARAMETERS {&#10;  ULONG StructSize;&#10;  ULONG Flags;&#10;  ULONG BandLocationInfoOffset;&#10;  ULONG BandSecurityInfoOffset;&#10;  ULONG AuthKeyOffset;&#10;} CREATE_BAND_PARAMETERS, *PCREATE_BAND_PARAMETERS;">CREATE_BAND_PARAMETERS</a>, then credential caching is enabled. The authentication silo driver will cache the band authentication key in memory. This allows the silo driver to automatically authenticate host access to the storage device when volume maintenance is required, such as resizing the band.</p>

<h2 id="see-also">See also</h2>

<p><a href="band_location_info" title="typedef struct _BAND_LOCATION_INFO {&#10;  ULONG         StructSize;&#10;  ULONG         Reserved;&#10;  LARGE_INTEGER BandStart;&#10;  LARGE_INTEGER BandSize;&#10;  BYTE          Metadata[32];&#10;} BAND_LOCATION_INFO, *PBAND_LOCATION_INFO;">BAND_LOCATION_INFO</a></p>

<p><a href="band_security_info" title="typedef struct _BAND_SECURITY_INFO {&#10;  ULONG      StructSize;&#10;  LOCKSTATE  ReadLock;&#10;  LOCKSTATE  WriteLock;&#10;  ALGOIDTYPE CryptoAlgoIdType;&#10;  union {&#10;    struct {&#10;      ULONG Offset;&#10;      ULONG Length;&#10;    } CryptoAlgoOidString;&#10;    ULONG CryptoAlgoNumericId;&#10;  };&#10;  BYTE       Metadata[32];&#10;} BAND_SECURITY_INFO, *PBAND_SECURITY_INFO;">BAND_SECURITY_INFO</a></p>

<p><a href="create_band_parameters" title="typedef struct _CREATE_BAND_PARAMETERS {&#10;  ULONG StructSize;&#10;  ULONG Flags;&#10;  ULONG BandLocationInfoOffset;&#10;  ULONG BandSecurityInfoOffset;&#10;  ULONG AuthKeyOffset;&#10;} CREATE_BAND_PARAMETERS, *PCREATE_BAND_PARAMETERS;">CREATE_BAND_PARAMETERS</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ehstorbandmgmt/ni-ehstorbandmgmt-ioctl_ehstor_bandmgmt_create_band">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ehstorbandmgmt/ni-ehstorbandmgmt-ioctl_ehstor_bandmgmt_create_band.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
