<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="KsCreateFilterFactory - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>KsCreateFilterFactory - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            KsCreateFilterFactory - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ks.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">KSDDKAPI <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> KsCreateFilterFactory(
  [in]            <a href="device_object" title="typedef struct _DEVICE_OBJECT {&#10;  CSHORT                   Type;&#10;  USHORT                   Size;&#10;  LONG                     ReferenceCount;&#10;  struct _DRIVER_OBJECT    *DriverObject;&#10;  struct _DEVICE_OBJECT    *NextDevice;&#10;  struct _DEVICE_OBJECT    *AttachedDevice;&#10;  struct _IRP              *CurrentIrp;&#10;  PIO_TIMER                Timer;&#10;  ULONG                    Flags;&#10;  ULONG                    Characteristics;&#10;  __volatile PVPB          Vpb;&#10;  PVOID                    DeviceExtension;&#10;  DEVICE_TYPE              DeviceType;&#10;  CCHAR                    StackSize;&#10;  union {&#10;    LIST_ENTRY         ListEntry;&#10;    WAIT_CONTEXT_BLOCK Wcb;&#10;  } Queue;&#10;  ULONG                    AlignmentRequirement;&#10;...">PDEVICE_OBJECT</a>            DeviceObject,
  [in]            const <a href="ksfilter_descriptor" title="typedef struct _KSFILTER_DESCRIPTOR {&#10;  const KSFILTER_DISPATCH     *Dispatch;&#10;  const KSAUTOMATION_TABLE    *AutomationTable;&#10;  ULONG                       Version;&#10;  ULONG                       Flags;&#10;  const GUID                  *ReferenceGuid;&#10;  ULONG                       PinDescriptorsCount;&#10;  ULONG                       PinDescriptorSize;&#10;  const KSPIN_DESCRIPTOR_EX   *PinDescriptors;&#10;  ULONG                       CategoriesCount;&#10;  const GUID                  *Categories;&#10;  ULONG                       NodeDescriptorsCount;&#10;  ULONG                       NodeDescriptorSize;&#10;  const KSNODE_DESCRIPTOR     *NodeDescriptors;&#10;  ULONG                       ConnectionsCount;&#10;  const KSTOPOLOGY_CONNECTION *Connections;&#10;  const KSCOMPONENTID         *ComponentId;&#10;} KSFILTER_DESCRIPTOR, *PKSFILTER_DESCRIPTOR;">KSFILTER_DESCRIPTOR</a> *Descriptor,
  [in, optional]  PWSTR                     RefString,
  [in, optional]  PSECURITY_DESCRIPTOR      SecurityDescriptor,
  [in]            <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                     CreateItemFlags,
  [in, optional]  PFNKSFILTERFACTORYPOWER   SleepCallback,
  [in, optional]  PFNKSFILTERFACTORYPOWER   WakeCallback,
  [out, optional] <a href="ksfilterfactory" title="typedef struct _KSFILTERFACTORY {&#10;  const KSFILTER_DESCRIPTOR *FilterDescriptor;&#10;  KSOBJECT_BAG              Bag;&#10;  PVOID                     Context;&#10;} KSFILTERFACTORY, *PKSFILTERFACTORY;">PKSFILTERFACTORY</a>          *FilterFactory
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ks/nf-ks-kscreatefilterfactory">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/kscreatefilterfactory.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ks-kscreatefilterfactory)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="kscreatefilterfactory-function">KsCreateFilterFactory function</h1>

<h2 id="description">Description</h2>

<p>The<em>* KsCreateFilterFactory</em>* function adds a filter factory to a given device.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="deviceobject-in"><code>DeviceObject</code> [in]</h3>

<p>A pointer to a <a href="device_object" title="typedef struct _DEVICE_OBJECT {&#10;  CSHORT                   Type;&#10;  USHORT                   Size;&#10;  LONG                     ReferenceCount;&#10;  struct _DRIVER_OBJECT    *DriverObject;&#10;  struct _DEVICE_OBJECT    *NextDevice;&#10;  struct _DEVICE_OBJECT    *AttachedDevice;&#10;  struct _IRP              *CurrentIrp;&#10;  PIO_TIMER                Timer;&#10;  ULONG                    Flags;&#10;  ULONG                    Characteristics;&#10;  __volatile PVPB          Vpb;&#10;  PVOID                    DeviceExtension;&#10;  DEVICE_TYPE              DeviceType;&#10;  CCHAR                    StackSize;&#10;  union {&#10;    LIST_ENTRY         ListEntry;&#10;    WAIT_CONTEXT_BLOCK Wcb;&#10;  } Queue;&#10;  ULONG                    AlignmentRequirement;&#10;...">DEVICE_OBJECT</a> structure for which to add a filter factory.</p>

<h3 id="descriptor-in"><code>Descriptor</code> [in]</h3>

<p>A pointer to a <a href="ksfilter_descriptor" title="typedef struct _KSFILTER_DESCRIPTOR {&#10;  const KSFILTER_DISPATCH     *Dispatch;&#10;  const KSAUTOMATION_TABLE    *AutomationTable;&#10;  ULONG                       Version;&#10;  ULONG                       Flags;&#10;  const GUID                  *ReferenceGuid;&#10;  ULONG                       PinDescriptorsCount;&#10;  ULONG                       PinDescriptorSize;&#10;  const KSPIN_DESCRIPTOR_EX   *PinDescriptors;&#10;  ULONG                       CategoriesCount;&#10;  const GUID                  *Categories;&#10;  ULONG                       NodeDescriptorsCount;&#10;  ULONG                       NodeDescriptorSize;&#10;  const KSNODE_DESCRIPTOR     *NodeDescriptors;&#10;  ULONG                       ConnectionsCount;&#10;  const KSTOPOLOGY_CONNECTION *Connections;&#10;  const KSCOMPONENTID         *ComponentId;&#10;} KSFILTER_DESCRIPTOR, *PKSFILTER_DESCRIPTOR;">KSFILTER_DESCRIPTOR</a> that describes the characteristics of individual filters that this factory can create.</p>

<h3 id="refstring-in-optional"><code>RefString</code> [in, optional]</h3>

<p>If this argument is provided, this string is used as the reference string for filters created by this factory. Otherwise, the reference GUID provided in the descriptor is used.</p>

<h3 id="securitydescriptor-in-optional"><code>SecurityDescriptor</code> [in, optional]</h3>

<p>The security descriptor to use in creation of filters by this filter factory. If <strong>NULL</strong>, no descriptor is provided.</p>

<h3 id="createitemflags-in"><code>CreateItemFlags</code> [in]</h3>

<p>The following table lists the flags that the minidriver writer uses to specify the characteristics of filters that the new filter factory can create. Set this parameter to the bitwise OR of the flags below.</p>

<table>
<thead>
<tr>
  <th>Flag</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td>KSCREATE_ITEM_SECURITY_CHANGED</td>
  <td>Indicates that the security descriptor on this object type has been changed and should be persisted.</td>
</tr>
<tr>
  <td>KSCREATE_ITEM_WILDCARD</td>
  <td>Indicates that this create item represents a wildcard that is used for any create requests that do not match any other create items. The ordering of the wildcard entry in the list of create items is irrelevant. Only a single wildcard entry is valid on any list of create items.</td>
</tr>
<tr>
  <td>KSCREATE_ITEM_NOPARAMETERS</td>
  <td>Indicates that this create item does not allow any parameters to be passed, and fails if any are found. (Normally, create parameters are passed on to the create handler.) This flag cannot be used with a wildcard flag.</td>
</tr>
<tr>
  <td>KSCREATE_ITEM_FREEONSTOP</td>
  <td>Indicates that the create item should be freed when the PnP manager sends <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/irp-mn-stop-device">IRP_MN_STOP_DEVICE</a>. Note that AVStream automatically frees such create items when the device receives PnP stop (<em>after</em> the client has received the PnP stop notification).</td>
</tr>
</tbody>
</table>

<h3 id="sleepcallback-in-optional"><code>SleepCallback</code> [in, optional]</h3>

<p>A pointer to a minidriver-provided routine that receives notifications that the device associated with this filter is going to sleep. Prototype the routine as follows:</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">SleepCallback</span><span class="w"> </span><span class="p">(</span><span class="n">IN</span><span class="w"> </span><span class="n"><a href="ksfilterfactory" title="typedef struct _KSFILTERFACTORY {&#10;  const KSFILTER_DESCRIPTOR *FilterDescriptor;&#10;  KSOBJECT_BAG              Bag;&#10;  PVOID                     Context;&#10;} KSFILTERFACTORY, *PKSFILTERFACTORY;">PKSFILTERFACTORY</a></span><span class="w"> </span><span class="n">FilterFactory</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n"><a href="device_power_state" title="typedef enum _DEVICE_POWER_STATE {&#10;  PowerDeviceUnspecified,&#10;  PowerDeviceD0,&#10;  PowerDeviceD1,&#10;  PowerDeviceD2,&#10;  PowerDeviceD3,&#10;  PowerDeviceMaximum&#10;} DEVICE_POWER_STATE, *PDEVICE_POWER_STATE;">DEVICE_POWER_STATE</a></span><span class="w"> </span><span class="n">State</span><span class="p">);</span>
</code></pre>
</div>

<p>If this parameter is <strong>NULL</strong>, this filter factory is not notified that the device is going to sleep. See <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/device-power-states">Device Power States</a>.</p>

<h3 id="wakecallback-in-optional"><code>WakeCallback</code> [in, optional]</h3>

<p>A pointer to a minidriver-provided routine that receives notifications that the device associated with this filter is waking up. Prototype the routine as follows:</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">WakeCallback</span><span class="w"> </span><span class="p">(</span><span class="n">IN</span><span class="w"> </span><span class="n"><a href="ksfilterfactory" title="typedef struct _KSFILTERFACTORY {&#10;  const KSFILTER_DESCRIPTOR *FilterDescriptor;&#10;  KSOBJECT_BAG              Bag;&#10;  PVOID                     Context;&#10;} KSFILTERFACTORY, *PKSFILTERFACTORY;">PKSFILTERFACTORY</a></span><span class="w"> </span><span class="n">FilterFactory</span><span class="p">,</span>
<span class="w">    </span><span class="n">IN</span><span class="w"> </span><span class="n"><a href="device_power_state" title="typedef enum _DEVICE_POWER_STATE {&#10;  PowerDeviceUnspecified,&#10;  PowerDeviceD0,&#10;  PowerDeviceD1,&#10;  PowerDeviceD2,&#10;  PowerDeviceD3,&#10;  PowerDeviceMaximum&#10;} DEVICE_POWER_STATE, *PDEVICE_POWER_STATE;">DEVICE_POWER_STATE</a></span><span class="w"> </span><span class="n">State</span><span class="p">);</span>
</code></pre>
</div>

<p>If this parameter is <strong>NULL</strong>, this filter factory is not notified that the device is waking up. See <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/device-power-states">Device Power States</a>.</p>

<h3 id="filterfactory-out-optional"><code>FilterFactory</code> [out, optional]</h3>

<p>A pointer to a <a href="ksfilterfactory" title="typedef struct _KSFILTERFACTORY {&#10;  const KSFILTER_DESCRIPTOR *FilterDescriptor;&#10;  KSOBJECT_BAG              Bag;&#10;  PVOID                     Context;&#10;} KSFILTERFACTORY, *PKSFILTERFACTORY;">KSFILTERFACTORY</a> structure that AVStream sets to point to the newly created filter factory object. If this optional parameter is unspecified, the caller is not informed about the resulting filter factory object.</p>

<h2 id="return-value">Return value</h2>

<p>Returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the filter factory can be created. Otherwise, it returns an appropriate error code.</p>

<h2 id="remarks">Remarks</h2>

<p>If you call <strong>KsCreateFilterFactory</strong> after <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ks/nc-ks-pfnksdevice">AVStrMiniDevicePostStart</a>), you must then call <a href="ksfilterfactorysetdeviceclassesstate" title="KSDDKAPI NTSTATUS KsFilterFactorySetDeviceClassesState(&#10;  [in] PKSFILTERFACTORY FilterFactory,&#10;  [in] BOOLEAN          NewState&#10;);">KsFilterFactorySetDeviceClassesState</a> to enable the device class. (Also call <strong><a href="ksfilterfactorysetdeviceclassesstate" title="KSDDKAPI NTSTATUS KsFilterFactorySetDeviceClassesState(&#10;  [in] PKSFILTERFACTORY FilterFactory,&#10;  [in] BOOLEAN          NewState&#10;);">KsFilterFactorySetDeviceClassesState</a></strong> to disable a filter factory.)</p>

<p>If you call <strong>KsCreateFilterFactory</strong> in the context of <em>AVStrMiniDevicePostStart</em> or before, you do not need to do this.</p>

<p>Before calling this function, the minidriver must obtain the device mutex. For information about how to do this, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/stream/device-mutex-in-avstream">Device Mutex in AVStream</a>.</p>

<p>This function should be used by minidrivers that either initialize themselves without a call to <a href="ksinitializedriver" title="KSDDKAPI NTSTATUS KsInitializeDriver(&#10;  [in]           PDRIVER_OBJECT            DriverObject,&#10;  [in]           PUNICODE_STRING           RegistryPathName,&#10;  [in, optional] const KSDEVICE_DESCRIPTOR *Descriptor&#10;);">KsInitializeDriver</a> or that must dynamically add and remove new filter types.</p>

<h2 id="see-also">See also</h2>

<p><a href="ksfilter_descriptor" title="typedef struct _KSFILTER_DESCRIPTOR {&#10;  const KSFILTER_DISPATCH     *Dispatch;&#10;  const KSAUTOMATION_TABLE    *AutomationTable;&#10;  ULONG                       Version;&#10;  ULONG                       Flags;&#10;  const GUID                  *ReferenceGuid;&#10;  ULONG                       PinDescriptorsCount;&#10;  ULONG                       PinDescriptorSize;&#10;  const KSPIN_DESCRIPTOR_EX   *PinDescriptors;&#10;  ULONG                       CategoriesCount;&#10;  const GUID                  *Categories;&#10;  ULONG                       NodeDescriptorsCount;&#10;  ULONG                       NodeDescriptorSize;&#10;  const KSNODE_DESCRIPTOR     *NodeDescriptors;&#10;  ULONG                       ConnectionsCount;&#10;  const KSTOPOLOGY_CONNECTION *Connections;&#10;  const KSCOMPONENTID         *ComponentId;&#10;} KSFILTER_DESCRIPTOR, *PKSFILTER_DESCRIPTOR;">KSFILTER_DESCRIPTOR</a></p>

<p><a href="ksnode_descriptor" title="typedef struct _KSNODE_DESCRIPTOR {&#10;  const KSAUTOMATION_TABLE *AutomationTable;&#10;  const GUID               *Type;&#10;  const GUID               *Name;&#10;  PVOID                    Alignment;&#10;} KSNODE_DESCRIPTOR, *PKSNODE_DESCRIPTOR;">KSNODE_DESCRIPTOR</a></p>

<p><a href="kspin_descriptor_ex" title="typedef struct _KSPIN_DESCRIPTOR_EX {&#10;  const KSPIN_DISPATCH         *Dispatch;&#10;  const KSAUTOMATION_TABLE     *AutomationTable;&#10;  KSPIN_DESCRIPTOR             PinDescriptor;&#10;  ULONG                        Flags;&#10;  ULONG                        InstancesPossible;&#10;  ULONG                        InstancesNecessary;&#10;  const KSALLOCATOR_FRAMING_EX *AllocatorFraming;&#10;  PFNKSINTERSECTHANDLEREX      IntersectHandler;&#10;} KSPIN_DESCRIPTOR_EX, *PKSPIN_DESCRIPTOR_EX;">KSPIN_DESCRIPTOR_EX</a></p>

<p><a href="ksdeletefilterfactory" title="void KsDeleteFilterFactory(&#10;  [in] FilterFactory&#10;);">KsDeleteFilterFactory</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ks/nf-ks-kscreatefilterfactory">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ks/nf-ks-kscreatefilterfactory.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
