<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="FSCTL_DELETE_USN_JOURNAL - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>FSCTL_DELETE_USN_JOURNAL - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            FSCTL_DELETE_USN_JOURNAL - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x0009, 0x03e, METHOD_BUFFERED, FILE_ANY_ACCESS)
#define FSCTL_DELETE_USN_JOURNAL 0x000900F8</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ni-ntifs-fsctl_delete_usn_journal">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// winioctl.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x0009, 0x03e, METHOD_BUFFERED, FILE_ANY_ACCESS)
#define FSCTL_DELETE_USN_JOURNAL 0x000900F8</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows/win32/api/winioctl/ni-winioctl-fsctl_delete_usn_journal">View the official Win32 API reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/fsctl_delete_usn_journal.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ni-ntifs-fsctl_delete_usn_journal)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2 id="description">Description</h2>

<p>The <strong>FSCTL_DELETE_USN_JOURNAL</strong> control code deletes the update sequence number (USN) change journal on a volume, or waits for notification of change journal deletion. See Remarks.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="major-code">Major code</h3>

<p>FSCTL_DELETE_USN_JOURNAL</p>

<h3 id="input-buffer">Input buffer</h3>

<h3 id="input-buffer-length">Input buffer length</h3>

<h3 id="output-buffer">Output buffer</h3>

<h3 id="output-buffer-length">Output buffer length</h3>

<h3 id="inputoutput-buffer">Input/output buffer</h3>

<h3 id="inputoutput-buffer-length">Input/output buffer length</h3>

<h3 id="status-block">Status block</h3>

<h2 id="remarks">Remarks</h2>

<p><strong>FSCTL_DELETE_USN_JOURNAL</strong> can be used to:</p>

<ul>
<li><p>Delete a change journal. The NTFS file system starts a deletion operation and returns immediately to the calling process, unless the <strong>USN_DELETE_FLAG_NOTIFY</strong> flag is set in the <strong>DeleteFlags</strong> member of <a rel="noopener" target="_blank" href="delete_usn_journal_data"><strong>DELETE_USN_JOURNAL_DATA</strong></a>.</p>

<p>If the <strong>USN_DELETE_FLAG_NOTIFY</strong> and <strong>USN_DELETE_FLAG_DELETE</strong> flags are both set, a call to <strong>FSCTL_DELETE_USN_JOURNAL</strong> begins the deletion process. Then the call either blocks the calling thread and waits for the deletion (on a synchronous or non-overlapped call), or sets up event notification by using an I/O completion port or other mechanism, and returns (on an asynchronous or overlapped call).</p></li>
<li><p>Receive notification that a change journal deletion is complete, by setting only <strong>USN_DELETE_FLAG_NOTIFY</strong>. If you do so, the <strong>FSCTL_DELETE_USN_JOURNAL</strong> operation either waits until the deletion completes before returning (on a synchronous or non-overlapped call), or sets up event notification by using an I/O completion port or other mechanism (on an asynchronous or overlapped call).</p></li>
</ul>

<p>To perform this operation, call <a rel="noopener" target="_blank" href="fltfscontrolfile"><strong>FltFsControlFile</strong></a> or <a rel="noopener" target="_blank" href="ntfscontrolfile"><strong>ZwFsControlFile</strong></a> with the following parameters.</p>

<ul>
<li><p><strong>FileObject</strong> [in]: Parameter for <a rel="noopener" target="_blank" href="fltfscontrolfile"><strong>FltFsControlFile</strong></a> only. A file object pointer for the remote volume. This parameter is required and can't be NULL.</p></li>
<li><p><strong>FileHandle</strong> [in]: Parameter for <a rel="noopener" target="_blank" href="ntfscontrolfile"><strong>ZwFsControlFile</strong></a> only. A handle for the remote volume. This parameter is required and can't be NULL.</p></li>
<li><p><strong>FsControlCode</strong> [in]: A control code for the operation. Use <strong><a href="fsctl_create_usn_journal" title="// CTL_CODE(0x0009, 0x039, METHOD_NEITHER, FILE_ANY_ACCESS)&#10;#define FSCTL_CREATE_USN_JOURNAL 0x000900E7">FSCTL_CREATE_USN_JOURNAL</a></strong> for this operation.</p></li>
<li><p><strong>InputBuffer</strong> [in]: Pointer to a <a rel="noopener" target="_blank" href="delete_usn_journal_data"><strong>DELETE_USN_JOURNAL_DATA</strong></a> structure that contains the parameters for the operation.</p></li>
<li><p><strong>InputBufferLength</strong> [in]: The size, in bytes, of the input buffer.</p></li>
<li><p><strong>OutputBuffer</strong> [out]: Not used.</p></li>
<li><p><strong>OutputBufferLength</strong> [in]: Not used.</p></li>
</ul>

<p><a rel="noopener" target="_blank" href="fltfscontrolfile"><strong>FltFsControlFile</strong></a> or <a rel="noopener" target="_blank" href="ntfscontrolfile"><strong>ZwFsControlFile</strong></a> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the operation succeeds. Otherwise, the appropriate function returns the appropriate <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> error code.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="fltfscontrolfile"><strong>FltFsControlFile</strong></a></p>

<p><a rel="noopener" target="_blank" href="fsctl_create_usn_journal"><strong>FSCTL_CREATE_USN_JOURNAL</strong></a></p>

<p><a rel="noopener" target="_blank" href="ntfscontrolfile"><strong>ZwFsControlFile</strong></a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ni-ntifs-fsctl_delete_usn_journal">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/ni-ntifs-fsctl_delete_usn_journal.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Win32 API reference (ni-winioctl-fsctl_delete_usn_journal)</h1>
</div>
<div class="ntdoc-description">
<h1>FSCTL_DELETE_USN_JOURNAL IOCTL</h1>

<h2>Description</h2>

<p>Deletes the update sequence number (USN) change journal on a volume, or waits for notification of
change journal deletion.</p>

<table>
<thead>
<tr>
  <th>C++</th>
</tr>
</thead>
<tbody>
<tr>
  <td><code>BOOL  WINAPI  DeviceIoControl( (HANDLE) hDevice,              // handle to volume                  FSCTL_DELETE_USN_JOURNAL,      // dwIoControlCode(LPVOID) lpInBuffer,           // input buffer                  (<a href="dword" title="typedef unsigned long DWORD;">DWORD</a>) nInBufferSize,         // size of input buffer                  NULL,                          // lpOutBuffer0,                             // nOutBufferSize(LPDWORD) lpBytesReturned,     // number of bytes returned                  (LPOVERLAPPED) lpOverlapped ); // OVERLAPPED structure</code></td>
</tr>
</tbody>
</table>

<h2>Parameters</h2>

<h3>Input buffer</h3>

<h3>Input buffer length</h3>

<h3>Output buffer</h3>

<h3>Output buffer length</h3>

<h3>Input/output buffer</h3>

<h3>Input/output buffer length</h3>

<h3>Status block</h3>

<p>Irp->IoStatus.Status is set to <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the request is successful.</p>

<p>Otherwise, Status to the appropriate error condition as a <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> code.</p>

<p>For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/ntstatus-values">NTSTATUS Values</a>.</p>

<h2>Remarks</h2>

<p>For the implications of overlapped I/O on this operation, see the Remarks section of the
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/ioapiset/nf-ioapiset-deviceiocontrol">DeviceIoControl</a> topic.</p>

<p>You can use <strong>FSCTL_DELETE_USN_JOURNAL</strong> to delete
a change journal. The NTFS file system starts a deletion operation and returns immediately to the calling process,
unless the <strong>USN_DELETE_FLAG_NOTIFY</strong> flag is set in the
<strong>DeleteFlags</strong> member of
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winioctl/ns-winioctl-delete_usn_journal_data">DELETE_USN_JOURNAL_DATA</a>.</p>

<p>If the <strong>USN_DELETE_FLAG_NOTIFY</strong> and <strong>USN_DELETE_FLAG_DELETE</strong>
flags are both set, a call to
<strong>FSCTL_DELETE_USN_JOURNAL</strong> begins the deletion
process. Then the call either blocks the calling thread and waits for the deletion (on a synchronous or
non-overlapped call), or sets up event notification by using an I/O completion port or other mechanism, and
returns (on an asynchronous or overlapped call).</p>

<p>You can also use <strong>FSCTL_DELETE_USN_JOURNAL</strong> to
receive notification that a change journal deletion is complete, by setting only
<strong>USN_DELETE_FLAG_NOTIFY</strong>. If you do so, the
<strong>FSCTL_DELETE_USN_JOURNAL</strong> operation either waits
until the deletion completes before returning (on a synchronous or non-overlapped call), or sets up event
notification by using an I/O completion port or other mechanism (on an asynchronous or overlapped call).</p>

<p>The deletion on which an application receives notification may have been initiated by the current process, or
some other process. For example, when an application is started, it can use
<strong>FSCTL_DELETE_USN_JOURNAL</strong> to determine if a
deletion started by some other process is in progress and if it is, exit.</p>

<p>Complete deletion of a change journal requires a scan of the volume where the change journal resides, which
may take a long time on a volume with many files. The operation continues to completion even across system
restarts. Attempts to create, modify, delete, or query the change journal while deletion is in progress fail and
return the error code <strong>ERROR_JOURNAL_DELETE_IN_PROGRESS</strong>.</p>

<p>The <strong>FSCTL_DELETE_USN_JOURNAL</strong> operation has a
significant performance cost, so it should be used sparingly. An administrator should delete a journal when the
current USN value approaches that of the maximum possible USN value.</p>

<p>For more information, see
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/FileIO/creating-modifying-and-deleting-a-change-journal">Creating, Modifying, and Deleting a Change Journal</a>.</p>

<p>To retrieve a handle to a volume, call
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/fileapi/nf-fileapi-createfilea">CreateFile</a> with the
<em>lpFileName</em> parameter set to a string in the following form:</p>

<p>\.*X*:</p>

<p>In the preceding string, <em>X</em> is the letter identifying the drive on which the volume
appears. The volume must be NTFS.</p>

<p>In Windows 8 and Windows Server 2012, this code is supported by the following technologies.</p>

<table>
<thead>
<tr>
  <th>Technology</th>
  <th>Supported</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Server Message Block (SMB) 3.0 protocol</td>
  <td>No</td>
</tr>
<tr>
  <td>SMB 3.0 Transparent Failover (TFO)</td>
  <td>No</td>
</tr>
<tr>
  <td>SMB 3.0 with Scale-out File Shares (SO)</td>
  <td>No</td>
</tr>
<tr>
  <td>Cluster Shared Volume File System (CsvFS)</td>
  <td>Yes</td>
</tr>
</tbody>
</table>

<h2>See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winioctl/ns-winioctl-create_usn_journal_data">CREATE_USN_JOURNAL_DATA</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/FileIO/change-journals">Change Journals</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/fileapi/nf-fileapi-createfilea">CreateFile</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winioctl/ns-winioctl-delete_usn_journal_data">DELETE_USN_JOURNAL_DATA</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/ioapiset/nf-ioapiset-deviceiocontrol">DeviceIoControl</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winioctl/ni-winioctl-fsctl_create_usn_journal">FSCTL_CREATE_USN_JOURNAL</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/minwinbase/ns-minwinbase-overlapped">OVERLAPPED</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/FileIO/volume-management-control-codes">Volume Management Control Codes</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows/win32/api/winioctl/ni-winioctl-fsctl_delete_usn_journal">View the official Win32 API reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/sdk-api/blob/docs/sdk-api-src/content/winioctl/ni-winioctl-fsctl_delete_usn_journal.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
