<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="EVT_MBB_DEVICE_SEND_MBIM_FRAGMENT - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>EVT_MBB_DEVICE_SEND_MBIM_FRAGMENT - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            EVT_MBB_DEVICE_SEND_MBIM_FRAGMENT - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// mbbcx.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">EVT_MBB_DEVICE_SEND_MBIM_FRAGMENT EvtMbbDeviceSendMbimFragment;

VOID EvtMbbDeviceSendMbimFragment(
  WDFDEVICE Device,
  MBBREQUEST SendRequest
)
{...}</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/mbbcx/nc-mbbcx-evt_mbb_device_send_mbim_fragment">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/evt_mbb_device_send_mbim_fragment.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nc-mbbcx-evt_mbb_device_send_mbim_fragment)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="evt_mbb_device_send_mbim_fragment-callback-function">EVT_MBB_DEVICE_SEND_MBIM_FRAGMENT callback function</h1>

<h2 id="description">Description</h2>

<p>A client driver's <em>EvtMbbDeviceSendMbimFragment</em> event callback function instructs its device to perform the task specified by the MBIM control message. This callback function is the equivalent of the <em>SendEncapsulatedCommand</em> request defined in the MBIM specification.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="device"><code>Device</code></h3>

<p>A handle to a framework device object the client driver obtained from a previous call to <strong><a href="wdfdevicecreate" title="NTSTATUS WdfDeviceCreate(&#10;  [in, out]      PWDFDEVICE_INIT        *DeviceInit,&#10;  [in, optional] PWDF_OBJECT_ATTRIBUTES DeviceAttributes,&#10;  [out]          WDFDEVICE              *Device&#10;);">WdfDeviceCreate</a></strong>.</p>

<h3 id="sendrequest"><code>SendRequest</code></h3>

<p>A handle to the framework object that represents the request to send a fragmented MBIM message to the device.</p>

<h2 id="prototype">Prototype</h2>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="c1">//Declaration</span>

<span class="n">EVT_MBB_DEVICE_SEND_MBIM_FRAGMENT</span><span class="w"> </span><span class="n">EvtMbbDeviceSendMbimFragment</span><span class="p">;</span>

<span class="c1">// Definition</span>

<span class="n">VOID</span><span class="w"> </span><span class="nf">EvtMbbDeviceSendMbimFragment</span>
<span class="p">(</span>
<span class="w">    </span><span class="n">WDFDEVICE</span><span class="w"> </span><span class="n">Device</span>
<span class="w">    </span><span class="n">MBBREQUEST</span><span class="w"> </span><span class="n">SendRequest</span>
<span class="p">)</span>
<span class="p">{...}</span>
</code></pre>
</div>

<h2 id="remarks">Remarks</h2>

<p>An MBBCx client driver must register an <em>EvtMbbDeviceSendMbimFragment</em> callback function by calling <strong><a href="mbbdeviceinitialize" title="NTSTATUS MbbDeviceInitialize(&#10;  WDFDEVICE          Device,&#10;  PMBB_DEVICE_CONFIG Config&#10;);">MbbDeviceInitialize</a></strong>.</p>

<p>The MBBCx framework calls this callback function when it wants to issue a command in the format of an MBIM control message to the client driver. If the size of the MBIM control message is larger than the maximum fragment size set by the client driver in the <strong><a href="mbb_device_mbim_parameters" title="typedef struct _MBB_DEVICE_MBIM_PARAMETERS {&#10;  ULONG                     Size;&#10;  MBB_MBIM_VERSION          Version;&#10;  MBB_MBIM_EXTENDED_VERSION ExtendedVersion;&#10;  ULONG                     MaximumFragmentSize;&#10;} MBB_DEVICE_MBIM_PARAMETERS, *PMBB_DEVICE_MBIM_PARAMETERS;">MBB_DEVICE_MBIM_PARAMETERS</a></strong> structure, the MBBCx framework splits the MBIM control message into multiple fragmented messages and calls this callback function once per fragmented message.</p>

<p>To get the actual MBIM message fragment being sent, the client driver should call <strong><a href="mbbrequestgetbuffer" title="PVOID MbbRequestGetBuffer(&#10;  MBBREQUEST Request,&#10;  size_t     *BufferSize&#10;);">MbbRequestGetBuffer</a></strong> to get the buffer where the MBIM message fragment is stored. Once its device has successfully accepted the control request, or any failure condition has occurred, the client driver must acknowledge this to MBBCx by calling <strong><a href="mbbrequestcomplete" title="VOID MbbRequestComplete(&#10;  MBBREQUEST Request,&#10;  NTSTATUS   NtStatus&#10;);">MbbRequestComplete</a></strong> either asynchronously or synchronously.</p>

<p>For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/netcx/writing-an-mbbcx-client-driver#handling-mbim-control-messages">Handling MBIM control messages</a>.</p>

<h3 id="example">Example</h3>

<p>Error handling code has been left out of this example for brevity and clarity.</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="n">VOID</span>
<span class="nf">EvtMbbDeviceSendMbimFragment</span><span class="p">(</span>
<span class="w">    </span><span class="n">WDFDEVICE</span><span class="w">  </span><span class="n">Device</span><span class="p">,</span>
<span class="w">    </span><span class="n">MBBREQUEST</span><span class="w"> </span><span class="n">SendRequest</span>
<span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// The client driver-specified framework object context</span>
<span class="w">    </span><span class="n">PMY_DEVICE_CONTEXT</span><span class="w"> </span><span class="n">myContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetMyDeviceContext</span><span class="p">(</span><span class="n">Device</span><span class="p">);</span>

<span class="w">    </span><span class="kt"><a href="size_t" title="typedef unsigned __int64 size_t;">size_t</a></span><span class="w"> </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">PVOID</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="mbbrequestgetbuffer" title="PVOID MbbRequestGetBuffer(&#10;  MBBREQUEST Request,&#10;  size_t     *BufferSize&#10;);">MbbRequestGetBuffer</a></span><span class="p">(</span><span class="n">SendRequest</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bufferSize</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// This client driver example uses asynchronous completion</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">myDeviceSendCompletionRoutine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[](</span><span class="n">MBBREQUEST</span><span class="w"> </span><span class="n">SendRequest</span><span class="p">,</span><span class="w"> </span><span class="n"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a></span><span class="w"> </span><span class="n">NtStatus</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//Acknowledge back to MBBCx</span>
<span class="w">        </span><span class="n"><a href="mbbrequestcomplete" title="VOID MbbRequestComplete(&#10;  MBBREQUEST Request,&#10;  NTSTATUS   NtStatus&#10;);">MbbRequestComplete</a></span><span class="p">(</span><span class="n">SendRequest</span><span class="p">,</span><span class="w"> </span><span class="n">NtStatus</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// The client driver-specified function call into its device</span>
<span class="w">    </span><span class="n"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a></span><span class="w"> </span><span class="n">sendStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyDeviceAsyncSend</span><span class="p">(</span>

<span class="w">        </span><span class="c1">// The client driver-specific handle</span>
<span class="w">        </span><span class="n">myContext</span><span class="o">-&gt;</span><span class="n">MyDeviceHandle</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// The context for completion</span>
<span class="w">        </span><span class="n">SendRequest</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// MBIM message</span>
<span class="w">        </span><span class="n">buffer</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// MBIM message size</span>
<span class="w">        </span><span class="n">bufferSize</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// Can be used for logging purpose, for example</span>
<span class="w">        </span><span class="n">MbbRequestGetActivityId</span><span class="p">(</span><span class="n">SendRequest</span><span class="p">),</span>

<span class="w">        </span><span class="c1">// The client driver-specific completion routine</span>
<span class="w">        </span><span class="n">myDeviceSendCompletionRoutine</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sendStatus</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">STATUS_PENDING</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Acknowledge back to MBBCx</span>
<span class="w">        </span><span class="n">myDeviceSendCompletionRoutine</span><span class="p">(</span>
<span class="w">            </span><span class="n">SendRequest</span><span class="p">,</span>
<span class="w">            </span><span class="n">sendStatus</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h2 id="see-also">See also</h2>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/mbbcx/nc-mbbcx-evt_mbb_device_send_mbim_fragment">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/mbbcx/nc-mbbcx-evt_mbb_device_send_mbim_fragment.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
