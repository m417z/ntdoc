<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="ExInitializeLookasideListEx - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>ExInitializeLookasideListEx - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            ExInitializeLookasideListEx - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> ExInitializeLookasideListEx(
  [out]          PLOOKASIDE_LIST_EX    Lookaside,
  [in, optional] PALLOCATE_FUNCTION_EX Allocate,
  [in, optional] PFREE_FUNCTION_EX     Free,
  [in]           <a href="pool_type" title="typedef enum _POOL_TYPE {&#10;    NonPagedPool,&#10;    NonPagedPoolExecute = NonPagedPool,&#10;    PagedPool,&#10;    NonPagedPoolMustSucceed = NonPagedPool + 2,&#10;    DontUseThisType,&#10;    NonPagedPoolCacheAligned = NonPagedPool + 4,&#10;    PagedPoolCacheAligned,&#10;    NonPagedPoolCacheAlignedMustS = NonPagedPool + 6,&#10;    MaxPoolType,&#10;    NonPagedPoolBase = 0,&#10;    NonPagedPoolBaseMustSucceed = NonPagedPoolBase + 2,&#10;    NonPagedPoolBaseCacheAligned = NonPagedPoolBase + 4,&#10;    NonPagedPoolBaseCacheAlignedMustS = NonPagedPoolBase + 6,&#10;    NonPagedPoolSession = 32,&#10;    PagedPoolSession = NonPagedPoolSession + 1,&#10;    NonPagedPoolMustSucceedSession = PagedPoolSession + 1,&#10;    DontUseThisTypeSession = NonPagedPoolMustSucceedSession + 1,&#10;    NonPagedPoolCacheAlignedSession = DontUseThisTypeSession + 1,&#10;    PagedPoolCacheAlignedSession = NonPagedPoolCacheAlignedSession + 1,&#10;...">POOL_TYPE</a>             PoolType,
  [in]           <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                 Flags,
  [in]           <a href="size_t-2" title="typedef ULONG_PTR SIZE_T;">SIZE_T</a>                Size,
  [in]           <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                 Tag,
  [in]           <a href="ushort" title="typedef unsigned short USHORT;">USHORT</a>                Depth
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-exinitializelookasidelistex">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/exinitializelookasidelistex.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdm-exinitializelookasidelistex)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2 id="description">Description</h2>

<p>The <strong>ExInitializeLookasideListEx</strong> routine initializes a lookaside list.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="lookaside-out"><code>Lookaside</code> [out]</h3>

<p>A pointer to the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/eprocess">LOOKASIDE_LIST_EX</a> structure to initialize. On return, this structure describes an empty lookaside list. The caller must use nonpaged system space for this structure, regardless of whether the entries in the lookaside list are allocated from paged or nonpaged memory. On 64-bit platforms, this structure must be 16-byte aligned.</p>

<h3 id="allocate-in-optional"><code>Allocate</code> [in, optional]</h3>

<p>A pointer to a caller-supplied <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-allocate_function_ex">LookasideListAllocateEx</a> routine that allocates a new lookaside-list entry. The <a href="exallocatefromlookasidelistex" title="PVOID ExAllocateFromLookasideListEx(&#10;  [in, out] PLOOKASIDE_LIST_EX Lookaside&#10;);">ExAllocateFromLookasideListEx</a> routine calls this <em>LookasideListAllocateEx</em> routine if the lookaside list is empty (contains no entries). This parameter is optional and can be specified as <strong>NULL</strong> if a custom allocation routine is not required. If this parameter is <strong>NULL</strong>, calls to <strong><a href="exallocatefrompagedlookasidelist" title="PVOID ExAllocateFromPagedLookasideList(&#10;  [in, out] PPAGED_LOOKASIDE_LIST Lookaside&#10;);">ExAllocateFromPagedLookasideList</a></strong> automatically allocate the paged or nonpaged storage (as determined by the <em>PoolType</em> parameter) for the new entries.</p>

<h3 id="free-in-optional"><code>Free</code> [in, optional]</h3>

<p>A pointer to a caller-supplied <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-free_function_ex">LookasideListFreeEx</a> routine that frees a previously allocated lookaside-list entry. The <a href="exfreetopagedlookasidelist" title="VOID ExFreeToPagedLookasideList(&#10;  [in, out] PPAGED_LOOKASIDE_LIST Lookaside,&#10;  [in]      PVOID                 Entry&#10;);">ExFreeToPagedLookasideList</a> routine calls this <em>LookasideListFreeEx</em> routine if the lookaside list is full (that is, the list already contains the maximum number of entries, as determined by the operating system). This parameter is optional and can be specified as <strong>NULL</strong> if a custom deallocation routine is not required. If this parameter is <strong>NULL</strong>, calls to <strong><a href="exfreetopagedlookasidelist" title="VOID ExFreeToPagedLookasideList(&#10;  [in, out] PPAGED_LOOKASIDE_LIST Lookaside,&#10;  [in]      PVOID                 Entry&#10;);">ExFreeToPagedLookasideList</a></strong> automatically free the storage for the specified entries.</p>

<h3 id="pooltype-in"><code>PoolType</code> [in]</h3>

<p>Specifies the pool type of the entries in the lookaside list. Set this parameter to a valid <a href="pool_type" title="typedef enum _POOL_TYPE {&#10;    NonPagedPool,&#10;    NonPagedPoolExecute = NonPagedPool,&#10;    PagedPool,&#10;    NonPagedPoolMustSucceed = NonPagedPool + 2,&#10;    DontUseThisType,&#10;    NonPagedPoolCacheAligned = NonPagedPool + 4,&#10;    PagedPoolCacheAligned,&#10;    NonPagedPoolCacheAlignedMustS = NonPagedPool + 6,&#10;    MaxPoolType,&#10;    NonPagedPoolBase = 0,&#10;    NonPagedPoolBaseMustSucceed = NonPagedPoolBase + 2,&#10;    NonPagedPoolBaseCacheAligned = NonPagedPoolBase + 4,&#10;    NonPagedPoolBaseCacheAlignedMustS = NonPagedPoolBase + 6,&#10;    NonPagedPoolSession = 32,&#10;    PagedPoolSession = NonPagedPoolSession + 1,&#10;    NonPagedPoolMustSucceedSession = PagedPoolSession + 1,&#10;    DontUseThisTypeSession = NonPagedPoolMustSucceedSession + 1,&#10;    NonPagedPoolCacheAlignedSession = DontUseThisTypeSession + 1,&#10;    PagedPoolCacheAlignedSession = NonPagedPoolCacheAlignedSession + 1,&#10;...">POOL_TYPE</a> enumeration value.</p>

<h3 id="flags-in"><code>Flags</code> [in]</h3>

<p>Specifies an optional flag value to modify the default behavior of the <em>LookasideListAllocateEx</em> routine. Set this parameter to zero or to one of the following EX_LOOKASIDE_LIST_EX_FLAGS_<em>XXX</em> flag bits.</p>

<table>
<thead>
<tr>
  <th>Flag bit</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td>EX_LOOKASIDE_LIST_EX_FLAGS_RAISE_ON_FAIL</td>
  <td>If the allocation fails, raise an exception.</td>
</tr>
<tr>
  <td>EX_LOOKASIDE_LIST_EX_FLAGS_FAIL_NO_RAISE</td>
  <td>If the allocation fails, return <strong>NULL</strong> instead of raising an exception. This flag is intended for use with an allocation routine, such as <a href="exallocatepoolwithquotatag" title="PVOID ExAllocatePoolWithQuotaTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithQuotaTag</a>, that charges quotas for pool usage.</td>
</tr>
</tbody>
</table>

<p>These two flag bits are mutually exclusive.</p>

<p>If <em>Allocate</em> is <strong>NULL</strong>, set <em>Flags</em> to either zero or EX_LOOKASIDE_LIST_EX_FLAGS_RAISE_ON_FAIL, but not to EX_LOOKASIDE_LIST_EX_FLAGS_FAIL_NO_RAISE. Otherwise, the behavior of the default allocation routine is undefined.</p>

<p>If <em>Flags</em> = EX_LOOKASIDE_LIST_EX_FLAGS_RAISE_ON_FAIL, the <em>PoolType</em> parameter value is bitwise ORed with the POOL_RAISE_IF_ALLOCATION_FAILURE flag bit to form the <em>PoolType</em> parameter value that is passed to the <em>LookasideListAllocateEx</em> routine. The <em>LookasideListAllocateEx</em> routine can pass this <em>PoolType</em> value, without modification, to the <strong><a href="exallocatepoolwithtag" title="PVOID ExAllocatePoolWithTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithTag</a></strong> routine. For more information about the POOL_RAISE_IF_ALLOCATION_FAILURE flag, see <a href="exallocatepoolwithtag" title="PVOID ExAllocatePoolWithTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithTag</a>.</p>

<p>If <em>Flags</em> = EX_LOOKASIDE_LIST_EX_FLAGS_FAIL_NO_RAISE, the <em>PoolType</em> parameter value is bitwise ORed with the POOL_QUOTA_FAIL_INSTEAD_OF_RAISE flag bit to form the <em>PoolType</em> parameter value that is passed to the <em>LookasideListAllocateEx</em> routine. The <em>LookasideListAllocateEx</em> routine can pass this <em>PoolType</em> value, without modification, to the <strong><a href="exallocatepoolwithquotatag" title="PVOID ExAllocatePoolWithQuotaTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithQuotaTag</a></strong> routine. For more information about the POOL_QUOTA_FAIL_INSTEAD_OF_RAISE flag, see <a href="exallocatepoolwithquotatag" title="PVOID ExAllocatePoolWithQuotaTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithQuotaTag</a>.</p>

<h3 id="size-in"><code>Size</code> [in]</h3>

<p>Specifies the size, in bytes, of each entry in the lookaside list.</p>

<h3 id="tag-in"><code>Tag</code> [in]</h3>

<p>Specifies the four-byte pool tag to use to mark the allocated storage for lookaside-list entries. For more information about pool tags, see the description of the <em>Tag</em> parameter in <strong><a href="exallocatepoolwithtag" title="PVOID ExAllocatePoolWithTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithTag</a></strong>.</p>

<h3 id="depth-in"><code>Depth</code> [in]</h3>

<p>Controls the maximum number of items the Lookaside may store. It is recommended that you pass 0 for this parameter, but it can validly take any value between EX_MAXIMUM_LOOKASIDE_DEPTH_BASE and EX_MAXIMUM_LOOKASIDE_DEPTH_LIMIT inclusive.</p>

<h2 id="return-value">Return value</h2>

<p><strong>ExInitializeLookasideListEx</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the call is successful. Possible return values include the following error code:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td>STATUS_INVALID_PARAMETER_4</td>
  <td>The <em>PoolType</em> parameter value is not valid.</td>
</tr>
<tr>
  <td>STATUS_INVALID_PARAMETER_5</td>
  <td>The <em>Flags</em> parameter value is not valid.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>A driver must call this routine to initialize a lookaside list before the driver can begin to use the list. A lookaside list is a pool of fixed-size buffers that the driver can manage locally to reduce the number of calls to system allocation routines and, thereby, to improve performance. The buffers are stored as entries in the lookaside list. All entries in the list are of the same, uniform size, which is specified by the <em>Size</em> parameter.</p>

<p>After <strong>ExInitializeLookasideListEx</strong> returns, the lookaside list is initialized but contains no entries. When a client calls the <a href="exallocatefromlookasidelistex" title="PVOID ExAllocateFromLookasideListEx(&#10;  [in, out] PLOOKASIDE_LIST_EX Lookaside&#10;);">ExAllocateFromLookasideListEx</a> routine to request an entry, this routine determines that the lookaside list is empty and calls the driver-supplied <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-allocate_function_ex">LookasideListAllocateEx</a> routine to dynamically allocate storage for a new entry. Additional entries might be allocated in response to similar requests from clients. Later, when clients call the <a href="exfreetolookasidelistex" title="VOID ExFreeToLookasideListEx(&#10;  [in, out] PLOOKASIDE_LIST_EX Lookaside,&#10;  [in]      PVOID              Entry&#10;);">ExFreeToLookasideListEx</a> to release these entries, this routine inserts the entries into the lookaside list. If the number of entries in the list reaches a limit that is determined by the operating system, <strong><a href="exfreetolookasidelistex" title="VOID ExFreeToLookasideListEx(&#10;  [in, out] PLOOKASIDE_LIST_EX Lookaside,&#10;  [in]      PVOID              Entry&#10;);">ExFreeToLookasideListEx</a></strong> ceases to add further entries to the list and instead passes these entries to the driver-supplied <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-free_function_ex">LookasideListFreeEx</a> routine to be freed.</p>

<p>If the driver does not supply <em>LookasideListAllocateEx</em> and <em>LookasideListFreeEx</em> routines, the <strong><a href="exallocatefromlookasidelistex" title="PVOID ExAllocateFromLookasideListEx(&#10;  [in, out] PLOOKASIDE_LIST_EX Lookaside&#10;);">ExAllocateFromLookasideListEx</a></strong> and <strong><a href="exfreetolookasidelistex" title="VOID ExFreeToLookasideListEx(&#10;  [in, out] PLOOKASIDE_LIST_EX Lookaside,&#10;  [in]      PVOID              Entry&#10;);">ExFreeToLookasideListEx</a></strong> routines use default allocation and deallocation routines instead.</p>

<p>There is no benefit to providing <em>LookasideListAllocateEx</em> and <em>LookasideListFreeEx</em> routines that do nothing but call <a href="exallocatepoolwithtag" title="PVOID ExAllocatePoolWithTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithTag</a> and <a href="exfreepool" title="void ExFreePool(&#10;  a&#10;);">ExFreePool</a>. The same effect can be achieved with better performance by simply setting the <em>Allocate</em> and <em>Free</em> parameters to <strong>NULL</strong>.</p>

<p>Before a driver unloads, it must explicitly free any lookaside lists it created. Failure to do so is a serious programming error. Call the <a href="exdeletelookasidelistex" title="VOID ExDeleteLookasideListEx(&#10;  [in, out] PLOOKASIDE_LIST_EX Lookaside&#10;);">ExDeleteLookasideListEx</a> routine to free a lookaside list. This routine frees the storage for any remaining entries in the specified lookaside list and then removes the list from the system-wide set of active lookaside lists.</p>

<p>The operating system keeps track of all lookaside lists that are currently in use. As both the amount of available nonpaged memory and the demand for lookaside list entries vary over time, the operating system dynamically adjusts its limits for the maximum number of entries in each nonpaged lookaside list.</p>

<p>In Windows 2000 and later versions of Windows, a lookaside list that contains paged or nonpaged entries can be described by a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/eprocess">PAGED_LOOKASIDE_LIST</a> or <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/eprocess">NPAGED_LOOKASIDE_LIST</a> structure, respectively.</p>

<p>For more information about lookaside lists, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/using-lookaside-lists">Using Lookaside Lists</a>.</p>

<p>Callers of <strong>ExInitializeLookasideListEx</strong> can be running at IRQL &lt;= DISPATCH_LEVEL, but are typically running at IRQL = PASSIVE_LEVEL.</p>

<h3 id="examples">Examples</h3>

<p>The driver-supplied <em>LookasideListAllocateEx</em> and <em>LookasideListFreeEx</em> routines both receive <em>Lookaside</em> parameters that point to the <strong>LOOKASIDE_LIST_EX</strong> structure that describes the lookaside list. The routines can use this parameter to access private data that the driver has associated with the lookaside list. For example, the driver might allocate an instance of the following structure to collect private data for each lookaside list that it creates:</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
<span class="p">{</span>
<span class="w">  </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w"> </span><span class="n">NumberOfAllocations</span><span class="p">;</span><span class="w">  </span><span class="c1">// number of entries allocated</span>
<span class="w">  </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w"> </span><span class="n">NumberOfFrees</span><span class="p">;</span><span class="w">        </span><span class="c1">// number of entries freed</span>
<span class="w">  </span><span class="n">LOOKASIDE_LIST_EX</span><span class="w"> </span><span class="n">LookasideField</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">MY_PRIVATE_DATA</span><span class="p">;</span>
</code></pre>
</div>

<p>The driver can initialize a lookaside list as shown in the following code example:</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="cp">#define ENTRY_SIZE  256</span>
<span class="cp">#define MY_POOL_TAG  &#39;tsLL&#39;</span>
<span class="n">MY_PRIVATE_DATA</span><span class="w"> </span><span class="o">*</span><span class="n">MyContext</span><span class="p">;</span>
<span class="n"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a></span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></span><span class="p">;</span>

<span class="n">MyContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="exallocatepoolwithtag" title="PVOID ExAllocatePoolWithTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithTag</a></span><span class="p">(</span><span class="n">NonPagedPool</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">MY_PRIVATE_DATA</span><span class="p">),</span><span class="w"> </span><span class="n">MY_POOL_TAG</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">MyContext</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">MyContext</span><span class="p">.</span><span class="n">NumberOfAllocations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">MyContext</span><span class="p">.</span><span class="n">NumberOfFrees</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExInitializeLookasideListEx</span><span class="p">(</span>
<span class="w">                 </span><span class="o">&amp;</span><span class="n">MyContext</span><span class="p">.</span><span class="n">LookasideField</span><span class="p">,</span>
<span class="w">                 </span><span class="n">MyLookasideListAllocateEx</span><span class="p">,</span>
<span class="w">                 </span><span class="n">MyLookasideListFreeEx</span><span class="p">,</span>
<span class="w">                 </span><span class="n">NonPagedPool</span><span class="p">,</span>
<span class="w">                 </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                 </span><span class="n">ENTRY_SIZE</span><span class="p">,</span>
<span class="w">                 </span><span class="n">MY_POOL_TAG</span><span class="p">,</span>
<span class="w">                 </span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STATUS_INSUFFICIENT_RESOURCES</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The following code example shows how the <em>LookasideListAllocateEx</em> routine can use its <em>Lookaside</em> parameter to access the private data that is associated with the lookaside list:</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="n">PVOID</span>
<span class="w">  </span><span class="nf">MyLookasideListAllocateEx</span><span class="p">(</span>
<span class="w">    </span><span class="n">__in</span><span class="w"> </span><span class="n"><a href="pool_type" title="typedef enum _POOL_TYPE {&#10;    NonPagedPool,&#10;    NonPagedPoolExecute = NonPagedPool,&#10;    PagedPool,&#10;    NonPagedPoolMustSucceed = NonPagedPool + 2,&#10;    DontUseThisType,&#10;    NonPagedPoolCacheAligned = NonPagedPool + 4,&#10;    PagedPoolCacheAligned,&#10;    NonPagedPoolCacheAlignedMustS = NonPagedPool + 6,&#10;    MaxPoolType,&#10;    NonPagedPoolBase = 0,&#10;    NonPagedPoolBaseMustSucceed = NonPagedPoolBase + 2,&#10;    NonPagedPoolBaseCacheAligned = NonPagedPoolBase + 4,&#10;    NonPagedPoolBaseCacheAlignedMustS = NonPagedPoolBase + 6,&#10;    NonPagedPoolSession = 32,&#10;    PagedPoolSession = NonPagedPoolSession + 1,&#10;    NonPagedPoolMustSucceedSession = PagedPoolSession + 1,&#10;    DontUseThisTypeSession = NonPagedPoolMustSucceedSession + 1,&#10;    NonPagedPoolCacheAlignedSession = DontUseThisTypeSession + 1,&#10;    PagedPoolCacheAlignedSession = NonPagedPoolCacheAlignedSession + 1,&#10;...">POOL_TYPE</a></span><span class="w">  </span><span class="n">PoolType</span><span class="p">,</span>
<span class="w">    </span><span class="n">__in</span><span class="w"> </span><span class="n"><a href="size_t-2" title="typedef ULONG_PTR SIZE_T;">SIZE_T</a></span><span class="w">  </span><span class="n">NumberOfBytes</span><span class="p">,</span>
<span class="w">    </span><span class="n">__in</span><span class="w"> </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w">  </span><span class="n">Tag</span><span class="p">,</span>
<span class="w">    </span><span class="n">__inout</span><span class="w"> </span><span class="n">PLOOKASIDE_LIST_EX</span><span class="w">  </span><span class="n">Lookaside</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">MY_PRIVATE_DATA</span><span class="w"> </span><span class="o">*</span><span class="n">MyContext</span><span class="p">;</span>
<span class="w">    </span><span class="n">PVOID</span><span class="w"> </span><span class="n">NewEntry</span><span class="p">;</span>

<span class="w">    </span><span class="n">MyContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="containing_record" title="#define CONTAINING_RECORD(address, type, field) \&#10;    ((type *)((ULONG_PTR)(address) - UFIELD_OFFSET(type, field)))">CONTAINING_RECORD</a></span><span class="p">(</span><span class="n">Lookaside</span><span class="p">,</span><span class="w"> </span><span class="n">MY_PRIVATE_DATA</span><span class="p">,</span><span class="w"> </span><span class="n">LookasideField</span><span class="p">);</span>

<span class="w">    </span><span class="n">NewEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n"><a href="exallocatepoolwithtag" title="PVOID ExAllocatePoolWithTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithTag</a></span><span class="p">(</span><span class="n">PoolType</span><span class="p">,</span><span class="w"> </span><span class="n">NumberOfBytes</span><span class="p">,</span><span class="w"> </span><span class="n">Tag</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NewEntry</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w"> </span><span class="n">NumberOfAllocations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="p">)</span><span class="w"> </span><span class="n"><a href="interlockedincrement" title="LONG InterlockedIncrement(&#10;  [in, out] LONG volatile *Addend&#10;);">InterlockedIncrement</a></span><span class="p">((</span><span class="n"><a href="long" title="typedef long LONG;">LONG</a></span><span class="w"> </span><span class="k">volatile</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">MyContext</span><span class="o">-&gt;</span><span class="n">NumberOfAllocations</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">NewEntry</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The <strong><a href="containing_record" title="#define CONTAINING_RECORD(address, type, field) \&#10;    ((type *)((ULONG_PTR)(address) - UFIELD_OFFSET(type, field)))">CONTAINING_RECORD</a></strong> macro is defined in the Ntdef.h header file. The <em>LookAsideListFreeEx</em> routine can similarly use its <em>Lookaside</em> parameter to access private data.</p>

<p>After the <strong>MyLookasideListAllocateEx</strong> routine in this example returns, <strong><a href="exallocatefromlookasidelistex" title="PVOID ExAllocateFromLookasideListEx(&#10;  [in, out] PLOOKASIDE_LIST_EX Lookaside&#10;);">ExAllocateFromLookasideListEx</a></strong> inserts the buffer pointed to by the <strong>NewEntry</strong> variable into the lookaside list. To make this insertion operation thread-safe, <strong><a href="exallocatefromlookasidelistex" title="PVOID ExAllocateFromLookasideListEx(&#10;  [in, out] PLOOKASIDE_LIST_EX Lookaside&#10;);">ExAllocateFromLookasideListEx</a></strong> synchronizes its access of the lookaside list with other list insertion and removal operations that might be performed by other threads. Similarly, when <strong>ExFreeFromLookasideListEx</strong> removes a buffer from the lookaside list, it synchronizes its access to the list.</p>

<p><strong><a href="exallocatefromlookasidelistex" title="PVOID ExAllocateFromLookasideListEx(&#10;  [in, out] PLOOKASIDE_LIST_EX Lookaside&#10;);">ExAllocateFromLookasideListEx</a></strong> and <strong>ExFreeFromLookasideListEx</strong> do not synchronize their calls to driver-supplied <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-allocate_function_ex">LookasideListAllocateEx</a> and <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-free_function_ex">LookasideListFreeEx</a> routines. Thus, if the <strong>MyLookasideListAllocateEx</strong> and <strong>MyLookasideListFreeEx</strong> routines in the preceding code examples must be thread-safe, the driver must provide the necessary synchronization.</p>

<p>The example routine, <strong>MyLookasideListAllocateEx</strong>, synchronizes its access of the <strong>MyContext->NumberOfAllocations</strong> variable with other threads that might increment and decrement this variable. To provide this synchronization, <strong>MyLookasideListAllocateEx</strong> calls the <a href="interlockedincrement" title="LONG InterlockedIncrement(&#10;  [in, out] LONG volatile *Addend&#10;);">InterlockedIncrement</a> routine to atomically increment this variable. Similarly, the <strong>MyLookasideListFreeEx</strong> routine (not shown) can call the <a href="interlockeddecrement" title="LONG InterlockedDecrement(&#10;  [in, out] LONG volatile *Addend&#10;);">InterlockedDecrement</a> routine to atomically decrement this variable.</p>

<p>However, if the sole purpose of the <strong>MyContext->NumberOfAllocations</strong> variable in the preceding code example is simply to gather statistics on lookaside list allocations, atomic increments and decrements are hardly necessary. In this case, the remote possibility of a missed increment or decrement should not be a concern.</p>

<p>For more information about thread safety for lookaside lists, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/using-lookaside-lists">Using Lookaside Lists</a>.</p>

<h2 id="see-also">See also</h2>

<p><a href="exallocatefromlookasidelistex" title="PVOID ExAllocateFromLookasideListEx(&#10;  [in, out] PLOOKASIDE_LIST_EX Lookaside&#10;);">ExAllocateFromLookasideListEx</a></p>

<p><a href="exallocatepoolwithquotatag" title="PVOID ExAllocatePoolWithQuotaTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithQuotaTag</a></p>

<p><a href="exallocatepoolwithtag" title="PVOID ExAllocatePoolWithTag(&#10;  [in] __drv_strictTypeMatch(__drv_typeExpr)POOL_TYPE PoolType,&#10;  [in] SIZE_T                                         NumberOfBytes,&#10;  [in] ULONG                                          Tag&#10;);">ExAllocatePoolWithTag</a></p>

<p><a href="exdeletelookasidelistex" title="VOID ExDeleteLookasideListEx(&#10;  [in, out] PLOOKASIDE_LIST_EX Lookaside&#10;);">ExDeleteLookasideListEx</a></p>

<p><a href="exfreepool" title="void ExFreePool(&#10;  a&#10;);">ExFreePool</a></p>

<p><a href="exfreetolookasidelistex" title="VOID ExFreeToLookasideListEx(&#10;  [in, out] PLOOKASIDE_LIST_EX Lookaside,&#10;  [in]      PVOID              Entry&#10;);">ExFreeToLookasideListEx</a></p>

<p><a href="interlockeddecrement" title="LONG InterlockedDecrement(&#10;  [in, out] LONG volatile *Addend&#10;);">InterlockedDecrement</a></p>

<p><a href="interlockedincrement" title="LONG InterlockedIncrement(&#10;  [in, out] LONG volatile *Addend&#10;);">InterlockedIncrement</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/eprocess">LOOKASIDE_LIST_EX</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-allocate_function_ex">LookasideListAllocateEx</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nc-wdm-free_function_ex">LookasideListFreeEx</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/eprocess">NPAGED_LOOKASIDE_LIST</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/eprocess">PAGED_LOOKASIDE_LIST</a></p>

<p><a href="pool_type" title="typedef enum _POOL_TYPE {&#10;    NonPagedPool,&#10;    NonPagedPoolExecute = NonPagedPool,&#10;    PagedPool,&#10;    NonPagedPoolMustSucceed = NonPagedPool + 2,&#10;    DontUseThisType,&#10;    NonPagedPoolCacheAligned = NonPagedPool + 4,&#10;    PagedPoolCacheAligned,&#10;    NonPagedPoolCacheAlignedMustS = NonPagedPool + 6,&#10;    MaxPoolType,&#10;    NonPagedPoolBase = 0,&#10;    NonPagedPoolBaseMustSucceed = NonPagedPoolBase + 2,&#10;    NonPagedPoolBaseCacheAligned = NonPagedPoolBase + 4,&#10;    NonPagedPoolBaseCacheAlignedMustS = NonPagedPoolBase + 6,&#10;    NonPagedPoolSession = 32,&#10;    PagedPoolSession = NonPagedPoolSession + 1,&#10;    NonPagedPoolMustSucceedSession = PagedPoolSession + 1,&#10;    DontUseThisTypeSession = NonPagedPoolMustSucceedSession + 1,&#10;    NonPagedPoolCacheAlignedSession = DontUseThisTypeSession + 1,&#10;    PagedPoolCacheAlignedSession = NonPagedPoolCacheAlignedSession + 1,&#10;...">POOL_TYPE</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-exinitializelookasidelistex">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/nf-wdm-exinitializelookasidelistex.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
