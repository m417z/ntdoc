<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="RDF_CARD_TRACKING - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>RDF_CARD_TRACKING - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            RDF_CARD_TRACKING - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// smclib.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> (*ReaderFunction[RDF_CARD_TRACKING])(
   <a href="smartcard_extension" title="typedef struct _SMARTCARD_EXTENSION {&#10;  ULONG                     Version;&#10;  VENDOR_ATTR               VendorAttr;&#10;  NTSTATUS(                 *ReaderFunction[16];&#10;  SCARD_CARD_CAPABILITIES   CardCapabilities;&#10;  ULONG                     LastError;&#10;  struct {&#10;    PULONG Information;&#10;    PUCHAR RequestBuffer;&#10;    ULONG  RequestBufferLength;&#10;    PUCHAR ReplyBuffer;&#10;    ULONG  ReplyBufferLength;&#10;  } IoRequest;&#10;  ULONG                     MajorIoControlCode;&#10;  ULONG                     MinorIoControlCode;&#10;  POS_DEP_DATA              OsData;&#10;  SCARD_READER_CAPABILITIES ReaderCapabilities;&#10;  PREADER_EXTENSION         ReaderExtension;&#10;  SMARTCARD_REPLY           SmartcardReply;&#10;  SMARTCARD_REQUEST         SmartcardRequest;&#10;...">PSMARTCARD_EXTENSION</a> SmartcardExtension
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/smartcard/smartcard-rdf-card-tracking-callback">View the official Windows hardware development documentation</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/rdf_card_tracking.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows hardware development documentation (smartcard-rdf-card-tracking-callback)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="rdf_card_tracking-callback-function">RDF_CARD_TRACKING callback function</h1>

<p>The RDF_CARD_TRACKING callback function installs an event handler to track every time a card is inserted in or removed from a card reader.</p>

<h2 id="parameters">Parameters</h2>

<ul>
<li><em>SmartcardExtension</em>
A pointer to the smart card extension, <strong><a href="smartcard_extension" title="typedef struct _SMARTCARD_EXTENSION {&#10;  ULONG                     Version;&#10;  VENDOR_ATTR               VendorAttr;&#10;  NTSTATUS(                 *ReaderFunction[16];&#10;  SCARD_CARD_CAPABILITIES   CardCapabilities;&#10;  ULONG                     LastError;&#10;  struct {&#10;    PULONG Information;&#10;    PUCHAR RequestBuffer;&#10;    ULONG  RequestBufferLength;&#10;    PUCHAR ReplyBuffer;&#10;    ULONG  ReplyBufferLength;&#10;  } IoRequest;&#10;  ULONG                     MajorIoControlCode;&#10;  ULONG                     MinorIoControlCode;&#10;  POS_DEP_DATA              OsData;&#10;  SCARD_READER_CAPABILITIES ReaderCapabilities;&#10;  PREADER_EXTENSION         ReaderExtension;&#10;  SMARTCARD_REPLY           SmartcardReply;&#10;  SMARTCARD_REQUEST         SmartcardRequest;&#10;...">SMARTCARD_EXTENSION</a></strong>, of the device.
<strong>SmartcardExtension-&gt;OsData-&gt;NotificationIrp</strong> contains the <a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a> that receives notification of the insertion or removal event.</li>
</ul>

<h2 id="return-value">Return value</h2>

<p>This function returns one of the following <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> values:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>STATUS_PENDING</strong></td>
  <td>Smart card tracking has started.</td>
</tr>
<tr>
  <td><strong>STATUS_INVALID_DEVICE_STATE</strong></td>
  <td>The device cannot accept the request.</td>
</tr>
<tr>
  <td><strong><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></strong></td>
  <td>Smart card status matches the requested tracking call.</td>
</tr>
<tr>
  <td><strong>STATUS_DEVICE_BUSY</strong></td>
  <td>A smart card tracking event is pending.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>It is mandatory for smart card reader drivers to implement this callback function.</p>

<p>Upon receiving an <strong><a href="ioctl_smartcard_is_present" title="// CTL_CODE(0x0031, 0x00a, METHOD_BUFFERED, FILE_ANY_ACCESS)&#10;#define IOCTL_SMARTCARD_IS_PRESENT 0x00310028">IOCTL_SMARTCARD_IS_PRESENT</a></strong> request, the driver library determines if the smart card is already present. If the smart card is present, the driver library completes the request with a status of <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a>. If there is no smart card present, the driver library calls the reader driver's smart card tracking callback function, and the reader driver starts looking for the smart card. After initiating smart card tracking, the driver library marks the request as having a status of STATUS_PENDING.</p>

<p>The driver library completes the request.</p>

<p><strong>WDM Device Drivers</strong></p>

<p>The corresponding WDM driver library adds a pointer to the request in <strong>SmartcardExtension-&gt;OsData-&gt;NotificationIrp</strong>. The reader driver must complete the request as soon as it detects that a smart card has been inserted or removed. The reader driver completes the request by calling <a rel="noopener" target="_blank" href="https://msdn.microsoft.com/library/ff548343/(v=vs.85/)"><strong>IoCompleteRequest</strong></a>, after which, the reader driver must set the <strong>NotificationIrp</strong> member of <strong>SmartcardExtension -&gt; OsData</strong> back to <strong>NULL</strong> to inform the driver library that the reader driver can accept further smart card tracking requests.</p>

<p>Because this call can have an indefinite duration and the caller can terminate the request before it is complete, it is important to mark this <a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a> as cancelable.</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="w">    </span><span class="n">MyDriverCardSupervision</span><span class="p">(</span>
<span class="w">    </span><span class="n">SmartcardExtension</span><span class="p">,</span>
<span class="w">    </span><span class="n">OtherParameters</span><span class="p">)</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">//    This function is called whenever the card status changes</span>
<span class="w">    </span><span class="c1">//    For example, the card has been inserted or the card has been removed</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SmartcardExtension</span><span class="o">-&gt;</span><span class="n">OsData</span><span class="o">-&gt;</span><span class="n">NotificationOverlappedData</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">){</span>

<span class="w">            </span><span class="n">SmartcardCompleteCardTracking</span><span class="p">(</span><span class="n">SmartcardExtension</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// Do additional tasks</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">    </span><span class="p">}</span>
</code></pre>
</div>

<h2 id="requirements">Requirements</h2>

<table>
<thead>
<tr>
  <th></th>
  <th></th>
</tr>
</thead>
<tbody>
<tr>
  <td>Target platform</td>
  <td>Desktop</td>
</tr>
<tr>
  <td>Header</td>
  <td>Smclib.h (include Smclib.h)</td>
</tr>
</tbody>
</table>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://msdn.microsoft.com/library/ff548343/(v=vs.85/)"><strong>IoCompleteRequest</strong></a></p>

<p><strong><a href="ioctl_smartcard_is_present" title="// CTL_CODE(0x0031, 0x00a, METHOD_BUFFERED, FILE_ANY_ACCESS)&#10;#define IOCTL_SMARTCARD_IS_PRESENT 0x00310028">IOCTL_SMARTCARD_IS_PRESENT</a></strong></p>

<p><strong><a href="smartcard_extension" title="typedef struct _SMARTCARD_EXTENSION {&#10;  ULONG                     Version;&#10;  VENDOR_ATTR               VendorAttr;&#10;  NTSTATUS(                 *ReaderFunction[16];&#10;  SCARD_CARD_CAPABILITIES   CardCapabilities;&#10;  ULONG                     LastError;&#10;  struct {&#10;    PULONG Information;&#10;    PUCHAR RequestBuffer;&#10;    ULONG  RequestBufferLength;&#10;    PUCHAR ReplyBuffer;&#10;    ULONG  ReplyBufferLength;&#10;  } IoRequest;&#10;  ULONG                     MajorIoControlCode;&#10;  ULONG                     MinorIoControlCode;&#10;  POS_DEP_DATA              OsData;&#10;  SCARD_READER_CAPABILITIES ReaderCapabilities;&#10;  PREADER_EXTENSION         ReaderExtension;&#10;  SMARTCARD_REPLY           SmartcardReply;&#10;  SMARTCARD_REQUEST         SmartcardRequest;&#10;...">SMARTCARD_EXTENSION</a></strong></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/smartcard/smartcard-rdf-card-tracking-callback">View the official Windows hardware development documentation</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs/blob/staging/windows-driver-docs-pr/smartcard/smartcard-rdf-card-tracking-callback.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
