<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="PROTOCOL_CM_REG_SAP - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>PROTOCOL_CM_REG_SAP - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            PROTOCOL_CM_REG_SAP - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ndis.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">PROTOCOL_CM_REG_SAP ProtocolCmRegSap;

NDIS_STATUS ProtocolCmRegSap(
  [in]  NDIS_HANDLE CallMgrAfContext,
  [in]  PCO_SAP Sap,
  [in]  NDIS_HANDLE NdisSapHandle,
  [out] PNDIS_HANDLE CallMgrSapContext
)
{...}</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-protocol_cm_reg_sap">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/protocol_cm_reg_sap.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nc-ndis-protocol_cm_reg_sap)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="protocol_cm_reg_sap-callback-function">PROTOCOL_CM_REG_SAP callback function</h1>

<h2 id="description">Description</h2>

<p>The
<em>ProtocolCmRegisterSap</em> function is a required function that is called by NDIS to request that a call
manager register a SAP (service access point) on behalf of a connection-oriented client.</p>

<p><strong>Note</strong> You must declare the function by using the <strong>PROTOCOL_CM_REG_SAP</strong> type.
For more information, see the following Examples section.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="callmgrafcontext-in"><code>CallMgrAfContext</code> [in]</h3>

<p>Specifies the handle to a call manager-allocated context area in which the call manager maintains
its per-open AF state. The call manager supplied this handle to NDIS from its
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-protocol_cm_open_af">ProtocolCmOpenAf</a> function.</p>

<h3 id="sap-in"><code>Sap</code> [in]</h3>

<p>Pointer to a media-specific CO_SAP structure that contains the specific SAP that a
connection-oriented client is registering.</p>

<h3 id="ndissaphandle-in"><code>NdisSapHandle</code> [in]</h3>

<p>Specifies a handle, supplied by NDIS, that uniquely identifies this SAP. This handle is opaque to
the call manager and reserved for NDIS library use.</p>

<h3 id="callmgrsapcontext-out"><code>CallMgrSapContext</code> [out]</h3>

<p>On return, specifies the handle to a call manager-supplied context area in which the call manager
maintains state about this SAP.</p>

<h2 id="return-value">Return value</h2>

<p><em>ProtocolCmRegisterSap</em> returns the status of its operation(s) as one of the following:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>NDIS_STATUS_SUCCESS</strong></td>
  <td>Indicates that the call manager successfully allocated and/or initialized any necessary resources to register and maintain the SAP. In addition, it also indicates that the SAP was registered successfully as required by the network media that the call manager supports.</td>
</tr>
<tr>
  <td><strong>NDIS_STATUS_PENDING</strong></td>
  <td>Indicates that the call manager will complete the processing of this request asynchronously. Call managers must call <a href="ndiscmregistersapcomplete" title="VOID NdisCmRegisterSapComplete(&#10;  [in] NDIS_STATUS Status,&#10;  [in] NDIS_HANDLE NdisSapHandle,&#10;  [in] NDIS_HANDLE CallMgrSapContext&#10;);">NdisCmRegisterSapComplete</a> when all processing has been completed to signal NDIS that the registration is finished.</td>
</tr>
<tr>
  <td><strong>NDIS_STATUS_RESOURCES</strong></td>
  <td>Indicates that the call manager was unable to allocated and/or initialize its resources required to register the SAP on behalf of the connection-oriented client.</td>
</tr>
<tr>
  <td><strong>NDIS_STATUS_INVALID_DATA</strong></td>
  <td>Indicates that the specification provided at <em>Sap</em> is invalid or cannot be supported.</td>
</tr>
<tr>
  <td><strong>NDIS_STATUS_*XXX*</strong></td>
  <td>Indicates that the call manager encountered an error in attempting to register the SAP for the connection-oriented client. The return code is appropriate to the error and could be a return code propagated from another NDIS library function.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p><em>ProtocolCmMakeCall</em> communicates with network control devices or other media-specific agents, as
necessary, to register the SAP, as specified at
<em>Sap</em>, on the network for a connection-oriented client. Such actions could include, but are not
limited to communicating with switching hardware, communicating with a network control station, or other
actions that are appropriate to the network medium.</p>

<p>If a call manager is required to communicate with networking control agents (in other words, a network
switch) it should use a virtual connection to the network control agent that it established in its
<em>ProtocolBindAdapterEx</em> function. Stand-alone call managers communicate through the underlying
miniport driver by calling
<a href="ndiscosendnetbufferlists" title="VOID NdisCoSendNetBufferLists(&#10;  [in] NDIS_HANDLE      NdisVcHandle,&#10;  [in] PNET_BUFFER_LIST NetBufferLists,&#10;  [in] ULONG            SendFlags&#10;);">NdisCoSendNetBufferLists</a>.
Miniport drivers with integrated call-management support never call
<strong><a href="ndiscosendnetbufferlists" title="VOID NdisCoSendNetBufferLists(&#10;  [in] NDIS_HANDLE      NdisVcHandle,&#10;  [in] PNET_BUFFER_LIST NetBufferLists,&#10;  [in] ULONG            SendFlags&#10;);">NdisCoSendNetBufferLists</a></strong>. Instead, they transmit the data directly across the network.</p>

<p>In addition,
<em>ProtocolCmRegisterSap</em> should perform any necessary allocations of dynamic resources and structures
that the call manager needs to maintain state information about the SAP on behalf of the
connection-oriented client. Such resources include, but are not limited to, memory buffers, data
structures, events, and other such similar resources. A call manager must also initialize any resources
it allocates before returning control to NDIS. Call managers must store the NDIS-supplied handle
identifying the SAP, provided at
<em>NdisSapHandle</em>, in their context area for future use.</p>

<p>If
<em>ProtocolCmRegisterSap</em> will return NDIS_STATUS_SUCCESS, it should, after allocating the per-SAP
state area, set the address of this state area in
<em>CallMgrSapContext</em> before returning control to NDIS. To do this, dereference
<em>CallMgrSapContext</em> and store a pointer to the data area as the value of the handle. For example:</p>

<pre><code>*CallMgrSapContext = SomeBuffer ;
</code></pre>

<p>If the given SAP that is already registered by another connection-oriented client, the call manager
must fail the request and return NDIS_STATUS_INVALID_DATA.</p>

<p>After a call manager has registered a SAP on behalf of a connection-oriented client, it notifies that
client of an incoming call offer directed to that SAP by calling
<a href="ndiscmdispatchincomingcall" title="NDIS_STATUS NdisCmDispatchIncomingCall(&#10;  [in] NDIS_HANDLE         NdisSapHandle,&#10;  [in] NDIS_HANDLE         NdisVcHandle,&#10;  [in] PCO_CALL_PARAMETERS CallParameters&#10;);">NdisCmDispatchIncomingCall</a>.</p>

<h3 id="examples">Examples</h3>

<p>To define a <em>ProtocolCmRegisterSap</em> function, you must first provide a function declaration that identifies the type of function you're defining. Windows provides a set of function types for drivers. Declaring a function using the function types helps <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/code-analysis-for-drivers">Code Analysis for Drivers</a>, <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/static-driver-verifier">Static Driver Verifier</a> (SDV), and other verification tools find errors, and it's a requirement for writing drivers for the Windows operating system.</p>

<p>For example, to define a <em>ProtocolCmRegisterSap</em> function that is named "MyCmRegisterSap", use the <strong>PROTOCOL_CM_REG_SAP</strong> type as shown in this code example:</p>

<pre><code>PROTOCOL_CM_REG_SAP MyCmRegisterSap;
</code></pre>

<p>Then, implement your function as follows:</p>

<pre><code>_Use_decl_annotations_
NDIS_STATUS
 MyCmRegisterSap(
    NDIS_HANDLE  CallMgrAfContext,
    PCO_SAP  Sap,
    NDIS_HANDLE  NdisSapHandle,
    PNDIS_HANDLE  CallMgrSapContext
    )
  {...}
</code></pre>

<p>The <strong>PROTOCOL_CM_REG_SAP</strong> function type is defined in the Ndis.h header file. To more accurately identify errors when you run the code analysis tools, be sure to add the _Use_decl_annotations_ annotation to your function definition. The _Use_decl_annotations_ annotation ensures that the annotations that are applied to the <strong>PROTOCOL_CM_REG_SAP</strong> function type in the header file are used. For more information about the requirements for function declarations, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/declaring-functions-by-using-function-role-types-for-ndis-drivers">Declaring Functions by Using Function Role Types for NDIS Drivers</a>.</p>

<p>For information about _Use_decl_annotations_, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/visualstudio/code-quality/annotating-function-behavior">Annotating Function Behavior</a>.</p>

<h2 id="see-also">See also</h2>

<p><a href="ndiscmdispatchincomingcall" title="NDIS_STATUS NdisCmDispatchIncomingCall(&#10;  [in] NDIS_HANDLE         NdisSapHandle,&#10;  [in] NDIS_HANDLE         NdisVcHandle,&#10;  [in] PCO_CALL_PARAMETERS CallParameters&#10;);">NdisCmDispatchIncomingCall</a></p>

<p><a href="ndiscmregistersapcomplete" title="VOID NdisCmRegisterSapComplete(&#10;  [in] NDIS_STATUS Status,&#10;  [in] NDIS_HANDLE NdisSapHandle,&#10;  [in] NDIS_HANDLE CallMgrSapContext&#10;);">NdisCmRegisterSapComplete</a></p>

<p><a href="ndiscosendnetbufferlists" title="VOID NdisCoSendNetBufferLists(&#10;  [in] NDIS_HANDLE      NdisVcHandle,&#10;  [in] PNET_BUFFER_LIST NetBufferLists,&#10;  [in] ULONG            SendFlags&#10;);">NdisCoSendNetBufferLists</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-protocol_cm_deregister_sap">ProtocolCmDeregisterSap</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-protocol_cm_open_af">ProtocolCmOpenAf</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/nc-ndis-protocol_cm_reg_sap">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ndis/nc-ndis-protocol_cm_reg_sap.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
