<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="SIO_ACQUIRE_PORT_RESERVATION - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>SIO_ACQUIRE_PORT_RESERVATION - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            SIO_ACQUIRE_PORT_RESERVATION - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header"></span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">#define SIO_ACQUIRE_PORT_RESERVATION /* IOCTL code */</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows/win32/winsock/sio-acquire-port-reservation">View the official Win32 development documentation</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/sio_acquire_port_reservation.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Win32 development documentation (sio-acquire-port-reservation)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="sio_acquire_port_reservation-control-code">SIO_ACQUIRE_PORT_RESERVATION control code</h1>

<h2 id="description">Description</h2>

<p>The <strong>SIO_ACQUIRE_PORT_RESERVATION</strong> control code acquires a runtime reservation for a block of TCP or UDP ports.</p>

<p>To perform this operation, call the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/nf-winsock2-wsaioctl"><strong>WSAIoctl</strong></a> or <strong>WSPIoctl</strong> function with the following parameters.</p>

<div class="codehilite">
<pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">WSAIoctl</span><span class="p">(</span>
<span class="w">  </span><span class="p">(</span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w">             </span><span class="c1">// descriptor identifying a socket</span>
<span class="w">  </span><span class="n">SIO_ACQUIRE_PORT_RESERVATION</span><span class="p">,</span><span class="w"> </span><span class="c1">// dwIoControlCode</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="w"> </span><span class="n">lpvInBuffer</span><span class="p">,</span><span class="w">  </span><span class="c1">// pointer to an INET_PORT_RANGE structure</span>
<span class="w">  </span><span class="p">(</span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="p">)</span><span class="w"> </span><span class="n">cbInBuffer</span><span class="p">,</span><span class="w">    </span><span class="c1">// size, in bytes, of the input buffer</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="w"> </span><span class="n">lpvOutBuffer</span><span class="p">,</span><span class="w">             </span><span class="c1">// pointer to an INET_PORT_RESERVATION_INSTANCE structure</span>
<span class="w">  </span><span class="p">(</span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="p">)</span><span class="w"> </span><span class="n">cbOutBuffer</span><span class="p">,</span><span class="w">   </span><span class="c1">// size, in bytes, of the output buffer</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPDWORD</span><span class="p">)</span><span class="w"> </span><span class="n">lpcbBytesReturned</span><span class="p">,</span><span class="w">    </span><span class="c1">// number of bytes returned</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPWSAOVERLAPPED</span><span class="p">)</span><span class="w"> </span><span class="n">lpOverlapped</span><span class="p">,</span><span class="w">   </span><span class="c1">// OVERLAPPED structure</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPWSAOVERLAPPED_COMPLETION_ROUTINE</span><span class="p">)</span><span class="w"> </span><span class="n">lpCompletionRoutine</span><span class="p">,</span><span class="w">  </span><span class="c1">// completion routine</span>
<span class="p">);</span>
</code></pre>
</div>

<div class="codehilite">
<pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">WSPIoctl</span><span class="p">(</span>
<span class="w">  </span><span class="p">(</span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w">             </span><span class="c1">// descriptor identifying a socket</span>
<span class="w">  </span><span class="n">SIO_ACQUIRE_PORT_RESERVATION</span><span class="p">,</span><span class="w"> </span><span class="c1">// dwIoControlCode</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="w"> </span><span class="n">lpvInBuffer</span><span class="p">,</span><span class="w">  </span><span class="c1">// pointer to an INET_PORT_RANGE structure</span>
<span class="w">  </span><span class="p">(</span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="p">)</span><span class="w"> </span><span class="n">cbInBuffer</span><span class="p">,</span><span class="w">    </span><span class="c1">// size, in bytes, of the input buffer</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="w"> </span><span class="n">lpvOutBuffer</span><span class="p">,</span><span class="w">             </span><span class="c1">// pointer to a INET_PORT_RESERVATION_INSTANCE structure</span>
<span class="w">  </span><span class="p">(</span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="p">)</span><span class="w"> </span><span class="n">cbOutBuffer</span><span class="p">,</span><span class="w">   </span><span class="c1">// size, in bytes, of the output buffer</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPDWORD</span><span class="p">)</span><span class="w"> </span><span class="n">lpcbBytesReturned</span><span class="p">,</span><span class="w">    </span><span class="c1">// number of bytes returned</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPWSAOVERLAPPED</span><span class="p">)</span><span class="w"> </span><span class="n">lpOverlapped</span><span class="p">,</span><span class="w">   </span><span class="c1">// OVERLAPPED structure</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPWSAOVERLAPPED_COMPLETION_ROUTINE</span><span class="p">)</span><span class="w"> </span><span class="n">lpCompletionRoutine</span><span class="p">,</span><span class="w">  </span><span class="c1">// completion routine</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPWSATHREADID</span><span class="p">)</span><span class="w"> </span><span class="n">lpThreadId</span><span class="p">,</span><span class="w">   </span><span class="c1">// a WSATHREADID structure</span>
<span class="w">  </span><span class="p">(</span><span class="n">LPINT</span><span class="p">)</span><span class="w"> </span><span class="n">lpErrno</span><span class="w">   </span><span class="c1">// a pointer to the error code.</span>
<span class="p">);</span>
</code></pre>
</div>

<h2 id="parameters">Parameters</h2>

<h3 id="s">s</h3>

<p>A descriptor identifying a socket.</p>

<h3 id="dwiocontrolcode">dwIoControlCode</h3>

<p>The control code for the operation.
Use <strong>SIO_ACQUIRE_PORT_RESERVATION</strong> for this operation.</p>

<h3 id="lpvinbuffer">lpvInBuffer</h3>

<p>A pointer to the input buffer.
This parameter contains a pointer to an <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/mstcpip/ns-mstcpip-inet_port_range"><strong>INET_PORT_RANGE</strong></a> structure that specifies the starting point number and the number of ports to reserve.</p>

<h3 id="cbinbuffer">cbInBuffer</h3>

<p>The size, in bytes, of the input buffer.
This parameter should be the size of the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/mstcpip/ns-mstcpip-inet_port_range"><strong>INET_PORT_RANGE</strong></a> structure.</p>

<h3 id="lpvoutbuffer">lpvOutBuffer</h3>

<p>A pointer to the output buffer.
On successful output, this parameter contains a pointer to an <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/mstcpip/ns-mstcpip-inet_port_reservation_instance"><strong>INET_PORT_RESERVATION_INSTANCE</strong></a> structure.</p>

<h3 id="cboutbuffer">cbOutBuffer</h3>

<p>The size, in bytes, of the output buffer.
This parameter must be at least the size of the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/mstcpip/ns-mstcpip-inet_port_reservation_instance"><strong>INET_PORT_RESERVATION_INSTANCE</strong></a> structure.</p>

<h3 id="lpcbbytesreturned">lpcbBytesReturned</h3>

<p>A pointer to a variable that receives the size, in bytes, of the data stored in the output buffer.</p>

<p>If the output buffer is too small, the call fails, <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock/nf-winsock-wsagetlasterror"><strong>WSAGetLastError</strong></a> returns <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/winsock/windows-sockets-error-codes-2"><strong>WSAEINVAL</strong></a>, and the <em>lpcbBytesReturned</em> parameter points to a <strong><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></strong> value of zero.</p>

<p>If <em>lpOverlapped</em> is <strong>NULL</strong>, the <strong><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></strong> value pointed to by the <em>lpcbBytesReturned</em> parameter that is returned on a successful call cannot be zero.</p>

<p>If the <em>lpOverlapped</em> parameter is not <strong>NULL</strong> for overlapped sockets, operations that cannot be completed immediately will be initiated, and completion will be indicated at a later time.
The <strong><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></strong> value pointed to by the <em>lpcbBytesReturned</em> parameter that is returned may be zero since the size of the data stored can't be determined until the overlapped operation has completed.
The final completion status can be retrieved when the appropriate completion method is signaled when the operation has completed.</p>

<h3 id="lpvoverlapped">lpvOverlapped</h3>

<p>A pointer to a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped"><strong>WSAOVERLAPPED</strong></a> structure.</p>

<p>If socket <em>s</em> was created without the overlapped attribute, the <em>lpOverlapped</em> parameter is ignored.</p>

<p>If <em>s</em> was opened with the overlapped attribute and the <em>lpOverlapped</em> parameter is not <strong>NULL</strong>, the operation is performed as an overlapped (asynchronous) operation.
In this case, <em>lpOverlapped</em> parameter must point to a valid <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped"><strong>WSAOVERLAPPED</strong></a> structure.</p>

<p>For overlapped operations, the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/nf-winsock2-wsaioctl"><strong>WSAIoctl</strong></a> or <strong>WSPIoctl</strong> function returns immediately, and the appropriate completion method is signaled when the operation has been completed.
Otherwise, the function does not return until the operation has been completed or an error occurs.</p>

<h3 id="lpcompletionroutine">lpCompletionRoutine</h3>

<p>Type: _In_opt_ <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/winsock2/nc-winsock2-lpwsaoverlapped_completion_routine"><strong>LPWSAOVERLAPPED_COMPLETION_ROUTINE</strong></a></p>

<p>A pointer to the completion routine called when the operation has been completed (ignored for non-overlapped sockets).</p>

<h3 id="lpthreadid">lpThreadId</h3>

<p>A pointer to a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/ws2spi/ns-ws2spi-wsathreadid"><strong>WSATHREADID</strong></a> structure to be used by the provider in a subsequent call to <strong>WPUQueueApc</strong>.
The provider should store the referenced <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/ws2spi/ns-ws2spi-wsathreadid"><strong>WSATHREADID</strong></a> structure (not the pointer to same) until after the <strong>WPUQueueApc</strong> function returns.</p>

<p><strong>Note</strong> This parameter applies only to the <strong>WSPIoctl</strong> function.</p>

<h3 id="lperrno">lpErrno</h3>

<p>A pointer to the error code.</p>

<p><strong>Note</strong> This parameter applies only to the <strong>WSPIoctl</strong> function.</p>

<h2 id="return-value">Return value</h2>

<p>If the operation completes successfully, the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/nf-winsock2-wsaioctl"><strong>WSAIoctl</strong></a> or <strong>WSPIoctl</strong> function returns zero.</p>

<p>If the operation fails or is pending, the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/nf-winsock2-wsaioctl"><strong>WSAIoctl</strong></a> or <strong>WSPIoctl</strong> function returns <strong>SOCKET_ERROR</strong>.
To get extended error information, call <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock/nf-winsock-wsagetlasterror"><strong>WSAGetLastError</strong></a>.</p>

<table>
<thead>
<tr>
  <th>Error code</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>WSA_IO_PENDING</strong></td>
  <td>Overlapped I/O operation is in progress. This value is returned if an overlapped operation was successfully initiated and completion will be indicated at a later time.</td>
</tr>
<tr>
  <td><strong>WSA_OPERATION_ABORTED</strong></td>
  <td>The I/O operation has been aborted because of either a thread exit or an application request. This error is returned if an overlapped operation was canceled due to the closure of the socket or the execution of the <strong>SIO_FLUSH</strong> IOCTL command.</td>
</tr>
<tr>
  <td><strong>WSAEFAULT</strong></td>
  <td>The system detected an invalid pointer address in attempting to use a pointer argument in a call. This error is returned of the <em>lpvInBuffer</em>, <em>lpvoutBuffer</em>, <em>lpcbBytesReturned</em>, <em>lpOverlapped</em> or <em>lpCompletionRoutine</em> parameter is not totally contained in a valid part of the user address space.</td>
</tr>
<tr>
  <td><strong>WSAEINPROGRESS</strong></td>
  <td>A blocking operation is currently executing. This error is returned if the function is invoked when a callback is in progress.</td>
</tr>
<tr>
  <td><strong>WSAEINTR</strong></td>
  <td>A blocking operation was interrupted by a call to <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/nf-winsock2-wsacancelblockingcall"><strong>WSACancelBlockingCall</strong></a>. This error is returned if a blocking operation was interrupted.</td>
</tr>
<tr>
  <td><strong>WSAEINVAL</strong></td>
  <td>An invalid argument was supplied. This error is returned if the <em>dwIoControlCode</em> parameter is not a valid command, or a specified input parameter is not acceptable, or the command is not applicable to the type of socket specified.</td>
</tr>
<tr>
  <td><strong>WSAENETDOWN</strong></td>
  <td>A socket operation encountered a dead network. This error is returned if the network subsystem has failed.</td>
</tr>
<tr>
  <td><strong>WSAENOTSOCK</strong></td>
  <td>An operation was attempted on something that is not a socket. This error is returned if the descriptor <em>s</em> is not a socket.</td>
</tr>
<tr>
  <td><strong>WSAEOPNOTSUPP</strong></td>
  <td>The attempted operation is not supported for the type of object referenced. This error is returned if the specified IOCTL command is not supported. This error is also returned if the <strong>SIO_ACQUIRE_PORT_RESERVATION</strong> IOCTL is not supported by the transport provider. This error is also returned when an attempt to use the <strong>SIO_ACQUIRE_PORT_RESERVATION</strong> IOCTL is made on a socket other than UDP or TCP.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>The <strong>SIO_ACQUIRE_PORT_RESERVATION</strong> IOCTL is supported on Windows Vista and later versions of the operating system.</p>

<p>Applications and services which need to reserve ports fall into two categories.
The first category includes components which need a particular port as part of their operation.
Such components will generally prefer to specify their required port at installation time (in an application manifest, for example).
The second category includes components which need any available port or block of ports at runtime.
These two categories correspond to specific and wildcard port reservation requests.
Specific reservation requests may be persistent or runtime, while wildcard port reservation requests are only supported at runtime.</p>

<p>The <strong>SIO_ACQUIRE_PORT_RESERVATION</strong> IOCTL is used to request a runtime reservation for a block of TCP or UDP ports.
For runtime port reservations, the port pool requires that reservations be consumed from the process on whose socket the reservation was granted.
Runtime port reservations last only as long as the lifetime of the socket on which the <strong>SIO_ACQUIRE_PORT_RESERVATION</strong> IOCTL was called.
In contrast, persistent port reservations created using the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/iphlpapi/nf-iphlpapi-createpersistenttcpportreservation"><strong>CreatePersistentTcpPortReservation</strong></a> or <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/iphlpapi/nf-iphlpapi-createpersistentudpportreservation"><strong>CreatePersistentUdpPortReservation</strong></a> function may be consumed by any process with the ability to obtain persistent reservations.</p>

<p>Once a runtime TCP or UDP port reservation has been obtained, an application can request port assignments from the port reservation by opening a TCP or UDP socket, then calling the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/nf-winsock2-wsaioctl"><strong>WSAIoctl</strong></a> function specifying the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/winsock/sio-associate-port-reservation"><strong>SIO_ASSOCIATE_PORT_RESERVATION</strong></a> IOCTL and passing the reservation token before issuing a call to the bind function on the socket.</p>

<p>If both <em>lpOverlapped</em> and <em>lpCompletionRoutine</em> parameters are <strong>NULL</strong>, the socket in this function will be treated as a non-overlapped socket.
For a non-overlapped socket, <em>lpOverlapped</em> and <em>lpCompletionRoutine</em> parameters are ignored, except that the function can block if socket <em>s</em> is in blocking mode.
If socket <em>s</em> is in non-blocking mode, this function will still block since this particular IOCTL does not support non-blocking mode.</p>

<p>For overlapped sockets, operations that cannot be completed immediately will be initiated, and completion will be indicated at a later time.</p>

<p>Any IOCTL may block indefinitely, depending on the service provider's implementation.
If the application cannot tolerate blocking in a WSAIoctl or <strong>WSPIoctl</strong> function call, overlapped I/O would be advised for IOCTLs that are especially likely to block.</p>

<p>The <strong>SIO_ACQUIRE_PORT_RESERVATION</strong> IOCTL can fail with <strong>WSAEINTR</strong> or <strong>WSA_OPERATION_ABORTED</strong> under the following cases:</p>

<ul>
<li>The request is canceled by the I/O Manager.</li>
<li>The socket is closed.</li>
</ul>

<h2 id="examples">Examples</h2>

<p>The following example acquires a runtime port reservation, then creates a socket and allocates a port from the runtime port reservation for the socket, and then closes the socket and the releases the runtime port reservation.</p>

<div class="codehilite">
<pre><span></span><code><span class="cp">#ifndef UNICODE</span>
<span class="cp">#define UNICODE</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef WIN32_LEAN_AND_MEAN</span>
<span class="cp">#define WIN32_LEAN_AND_MEAN</span>
<span class="cp">#endif</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Windows.h.&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;winsock2.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mstcpip.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ws2ipdef.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="c1">// Need to link with Ws2_32.lib for Winsock functions</span>
<span class="cp">#pragma comment(lib, &quot;ws2_32.lib&quot;)</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">wmain</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">WCHAR</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>

<span class="w">    </span><span class="c1">// Declare and initialize variables</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">startPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">          </span><span class="c1">// host byte order</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">numPorts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n"><a href="ushort" title="typedef unsigned short USHORT;">USHORT</a></span><span class="w"> </span><span class="n">startPortns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">     </span><span class="c1">// Network byte order</span>

<span class="w">    </span><span class="n">INET_PORT_RANGE</span><span class="w"> </span><span class="n">portRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">INET_PORT_RESERVATION_INSTANCE</span><span class="w"> </span><span class="n">portRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">WSADATA</span><span class="w"> </span><span class="n">wsaData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">SOCKET</span><span class="w"> </span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INVALID_SOCKET</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iFamily</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AF_INET</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iProtocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">SOCKET</span><span class="w"> </span><span class="n">sockRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INVALID_SOCKET</span><span class="p">;</span>

<span class="w">    </span><span class="n"><a href="dword" title="typedef unsigned long DWORD;">DWORD</a></span><span class="w"> </span><span class="n">bytesReturned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Note that the sockaddr_in struct works only with AF_INET not AF_INET6</span>
<span class="w">    </span><span class="c1">// An application needs to use the sockaddr_in6 for AF_INET6</span>
<span class="w">    </span><span class="n">sockaddr_in</span><span class="w"> </span><span class="n">service</span><span class="p">;</span>
<span class="w">    </span><span class="n">sockaddr_in</span><span class="w"> </span><span class="n">sockName</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nameLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">sockName</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Validate the parameters</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wprintf</span>
<span class="w">            </span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;usage: %s &lt;addressfamily&gt; &lt;type&gt; &lt;protocol&gt; &lt;StartingPort&gt; &lt;NumberOfPorts&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;Opens a socket for the specified family, type, &amp; protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">wprintf</span>
<span class="w">            </span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;and then acquires a runtime port reservation for the protocol specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;%ws example usage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;   %ws 2 2 17 5000 20</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;   where AF_INET=2 SOCK_DGRAM=2 IPPROTO_UDP=17 StartPort=5000 NumPorts=20&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">iFamily</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_wtoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">    </span><span class="n">iType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_wtoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">    </span><span class="n">iProtocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_wtoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

<span class="w">    </span><span class="n">startPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_wtoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">startPort</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">startPort</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">65535</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;Starting point must be either 0 or between 1 and 65,535</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">startPortns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htons</span><span class="p">((</span><span class="n"><a href="ushort" title="typedef unsigned short USHORT;">USHORT</a></span><span class="p">)</span><span class="w"> </span><span class="n">startPort</span><span class="p">);</span>

<span class="w">    </span><span class="n">numPorts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_wtoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numPorts</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;Number of ports must be a positive number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">portRange</span><span class="p">.</span><span class="n">StartPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startPortns</span><span class="p">;</span>
<span class="w">    </span><span class="n">portRange</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="ushort" title="typedef unsigned short USHORT;">USHORT</a></span><span class="p">)</span><span class="w"> </span><span class="n">numPorts</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Initialize Winsock</span>
<span class="w">    </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WSAStartup</span><span class="p">(</span><span class="n">MAKEWORD</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wsaData</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;WSAStartup failed with error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">iResult</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="p">(</span><span class="n">iFamily</span><span class="p">,</span><span class="w"> </span><span class="n">iType</span><span class="p">,</span><span class="w"> </span><span class="n">iProtocol</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sock</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INVALID_SOCKET</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;socket function failed with error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">WSAGetLastError</span><span class="p">());</span>
<span class="w">        </span><span class="n">WSACleanup</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;socket function succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">WSAIoctl</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="n">SIO_ACQUIRE_PORT_RESERVATION</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">portRange</span><span class="p">,</span>
<span class="w">                     </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">INET_PORT_RANGE</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">portRes</span><span class="p">,</span>
<span class="w">                     </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">INET_PORT_RESERVATION_INSTANCE</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bytesReturned</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;WSAIoctl(SIO_ACQUIRE_PORT_RESERVATION) failed with error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">WSAGetLastError</span><span class="p">());</span>
<span class="w">            </span><span class="n">closesocket</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
<span class="w">            </span><span class="n">WSACleanup</span><span class="p">();</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">wprintf</span>
<span class="w">                </span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;WSAIoctl(SIO_ACQUIRE_PORT_RESERVATION) succeeded, bytesReturned = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="n">bytesReturned</span><span class="p">);</span>
<span class="w">            </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;  Starting port=%d,  Number of Ports=%d, Token=%I64d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">htons</span><span class="p">(</span><span class="n">portRes</span><span class="p">.</span><span class="n">Reservation</span><span class="p">.</span><span class="n">StartPort</span><span class="p">),</span>
<span class="w">                    </span><span class="n">portRes</span><span class="p">.</span><span class="n">Reservation</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">,</span><span class="w"> </span><span class="n">portRes</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>

<span class="w">            </span><span class="n">sockRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="p">(</span><span class="n">iFamily</span><span class="p">,</span><span class="w"> </span><span class="n">iType</span><span class="p">,</span><span class="w"> </span><span class="n">iProtocol</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sockRes</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INVALID_SOCKET</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;socket function for second socket failed with error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="n">WSAGetLastError</span><span class="p">());</span>
<span class="w">                </span><span class="n">closesocket</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
<span class="w">                </span><span class="n">WSACleanup</span><span class="p">();</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;socket function for second socket succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">                </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="n">WSAIoctl</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="n">SIO_ASSOCIATE_PORT_RESERVATION</span><span class="p">,</span>
<span class="w">                             </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">portRes</span><span class="p">.</span><span class="n">Token</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="ulong64" title="typedef unsigned __int64 ULONG64;">ULONG64</a></span><span class="p">),</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                             </span><span class="o">&amp;</span><span class="n">bytesReturned</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">wprintf</span>
<span class="w">                        </span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;WSAIoctl(SIO_ASSOCIATE_PORT_RESERVATION) failed with error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="n">WSAGetLastError</span><span class="p">());</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">wprintf</span>
<span class="w">                        </span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;WSAIoctl(SIO_ASSOCIATE_PORT_RESERVATION) succeeded, bytesReturned = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="n">bytesReturned</span><span class="p">);</span>

<span class="w">                    </span><span class="n">service</span><span class="p">.</span><span class="n">sin_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="address_family" title="typedef USHORT ADDRESS_FAMILY;">ADDRESS_FAMILY</a></span><span class="p">)</span><span class="w"> </span><span class="n">iFamily</span><span class="p">;</span>
<span class="w">                    </span><span class="n">service</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INADDR_ANY</span><span class="p">;</span>
<span class="w">                    </span><span class="n">service</span><span class="p">.</span><span class="n">sin_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">                    </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">SOCKADDR</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">service</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">service</span><span class="p">));</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SOCKET_ERROR</span><span class="p">)</span>
<span class="w">                        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;bind failed with error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">WSAGetLastError</span><span class="p">());</span>
<span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;bind succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">                        </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getsockname</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">SOCKADDR</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">sockName</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nameLen</span><span class="p">);</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SOCKET_ERROR</span><span class="p">)</span>
<span class="w">                            </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;getsockname failed with error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                                    </span><span class="n">WSAGetLastError</span><span class="p">());</span>
<span class="w">                        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;getsockname succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">                            </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;Port number allocated = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                                    </span><span class="n">ntohs</span><span class="p">(</span><span class="n">sockName</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// comment out this block of code if you don&#39;t want to delete the reservation just created</span>
<span class="w">            </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">WSAIoctl</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="n">SIO_RELEASE_PORT_RESERVATION</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">portRes</span><span class="p">.</span><span class="n">Token</span><span class="p">,</span>
<span class="w">                         </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n"><a href="ulong64" title="typedef unsigned __int64 ULONG64;">ULONG64</a></span><span class="p">),</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bytesReturned</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">wprintf</span>
<span class="w">                    </span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;WSAIoctl(SIO_RELEASE_PORT_RESERVATION) failed with error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="n">WSAGetLastError</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">wprintf</span>
<span class="w">                    </span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;WSAIoctl(SIO_RELEASE_PORT_RESERVATION) succeeded, bytesReturned = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="n">bytesReturned</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sockRes</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">INVALID_SOCKET</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">closesocket</span><span class="p">(</span><span class="n">sockRes</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SOCKET_ERROR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;closesocket for second socket failed with error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="n">WSAGetLastError</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sock</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">INVALID_SOCKET</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">closesocket</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SOCKET_ERROR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;closesocket for first socket failed with error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="n">WSAGetLastError</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">WSACleanup</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/nf-winsock2-accept"><strong>accept</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock/nf-winsock-bind"><strong>bind</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/iphlpapi/nf-iphlpapi-createpersistenttcpportreservation"><strong>CreatePersistentTcpPortReservation</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/iphlpapi/nf-iphlpapi-createpersistentudpportreservation"><strong>CreatePersistentUdpPortReservation</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/iphlpapi/nf-iphlpapi-deletepersistenttcpportreservation"><strong>DeletePersistentTcpPortReservation</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/iphlpapi/nf-iphlpapi-deletepersistentudpportreservation"><strong>DeletePersistentUdpPortReservation</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/mstcpip/ns-mstcpip-inet_port_range"><strong>INET_PORT_RANGE</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/mstcpip/ns-mstcpip-inet_port_reservation_instance"><strong>INET_PORT_RESERVATION_INSTANCE</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/iphlpapi/nf-iphlpapi-lookuppersistenttcpportreservation"><strong>LookupPersistentTcpPortReservation</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/iphlpapi/nf-iphlpapi-lookuppersistentudpportreservation"><strong>LookupPersistentUdpPortReservation</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/winsock/sio-associate-port-reservation"><strong>SIO_ASSOCIATE_PORT_RESERVATION</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/winsock/sio-release-port-reservation"><strong>SIO_RELEASE_PORT_RESERVATION</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/nf-winsock2-socket"><strong>socket</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock/nf-winsock-wsagetlasterror"><strong>WSAGetLastError</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/nf-winsock2-wsagetoverlappedresult"><strong>WSAGetOverlappedResult</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/nf-winsock2-wsaioctl"><strong>WSAIoctl</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/ns-winsock2-wsaoverlapped"><strong>WSAOVERLAPPED</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/nf-winsock2-wsasocketa"><strong>WSASocketA</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/winsock2/nf-winsock2-wsasocketw"><strong>WSASocketW</strong></a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows/win32/winsock/sio-acquire-port-reservation">View the official Win32 development documentation</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/win32/blob/docs/desktop-src/WinSock/sio-acquire-port-reservation.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
