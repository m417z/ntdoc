<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="RtlVirtualUnwind2 - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>RtlVirtualUnwind2 - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            RtlVirtualUnwind2 - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">NTSYSAPI <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> RtlVirtualUnwind2(
  [in]                <a href="dword" title="typedef unsigned long DWORD;">DWORD</a>                          HandlerType,
  [in]                <a href="dword64" title="typedef unsigned __int64 DWORD64;">DWORD64</a>                        ImageBase,
  [in]                <a href="dword64" title="typedef unsigned __int64 DWORD64;">DWORD64</a>                        ControlPc,
  [in, optional]      PRUNTIME_FUNCTION              FunctionEntry,
  [in, out]           PCONTEXT                       ContextRecord,
  [in, out, optional] PBOOLEAN                       MachineFrameUnwound
  [out]               PVOID                          *HandlerData,
  [out]               PDWORD64                       EstablisherFrame,
  [in, out, optional] PKNONVOLATILE_CONTEXT_POINTERS ContextPointers,
  [in, optional]      PDWORD64                       LowLimit,
  [in, optional]      PDWORD64                       HighLimit,
  [out, optional]     PEXCEPTION_ROUTINE             *HandlerRoutine
  [in]                <a href="dword" title="typedef unsigned long DWORD;">DWORD</a>                          UnwindFlags
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows/win32/devnotes/rtlvirtualunwind2">View the official Win32 development documentation</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/rtlvirtualunwind2.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Win32 development documentation (rtlvirtualunwind2)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="rtlvirtualunwind2-function">RtlVirtualUnwind2 function</h1>

<p>Given a representation of the CPU context within a function, calculates CPU context representing the parent (caller) stack frame.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="handlertype-in">HandlerType [in]</h3>

<p>The handler type. This parameter can be one of the following values.</p>

<table>
<thead>
<tr>
  <th>Value</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td>UNW_FLAG_NHANDLER</td>
  <td>The function has no handler.</td>
</tr>
<tr>
  <td>UNW_FLAG_EHANDLER</td>
  <td>The function has an exception handler that should be called.</td>
</tr>
<tr>
  <td>UNW_FLAG_UHANDLER</td>
  <td>The function has a termination handler that should be called when unwinding an exception.</td>
</tr>
<tr>
  <td>UNW_FLAG_CHAININFO</td>
  <td>The FunctionEntry member is the contents of a previous function table entry.</td>
</tr>
</tbody>
</table>

<h3 id="imagebase-in">ImageBase [in]</h3>

<p>The base address of the module that includes the function represented by the execution context in the ContextRecord at the time the call is made (input).</p>

<h3 id="controlpc-in">ControlPc [in]</h3>

<p>The address within the function represented by the ContextRecord state which should be regarded as the Instruction Pointer for the unwind operation. This takes precedence over the Instruction Pointer field in the ContextRecord itself.</p>

<h3 id="functionentry-in">FunctionEntry [in]</h3>

<p>The address of the function table entry for the function represented by the execution context in the ContextRecord. To obtain the function table entry, call the <a href="rtllookupfunctionentry" title="NTSYSAPI PRUNTIME_FUNCTION RtlLookupFunctionEntry(&#10;  [in]  DWORD64               ControlPc,&#10;  [out] PDWORD64              ImageBase,&#10;  [out] PUNWIND_HISTORY_TABLE HistoryTable&#10;);">RtlLookupFunctionEntry</a> function. If NULL, the function will be assumed to be a leaf function with no stack frame of its own and a trivial unwind will be performed (e.g. emulate a solitary RET).</p>

<h3 id="contextrecord-in-out">ContextRecord [in, out]</h3>

<p>A pointer to a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/winnt/ns-winnt-context">CONTEXT</a> structure. On entry, this should represent the state of the CPU within a given function. On successful return, the context will represent the CPU context at the parent (caller) frame.</p>

<h3 id="handlerdata-out">HandlerData [out]</h3>

<p>This parameter provides a pointer that, on return, receives the Exception Handler Data associated with function that was running in the stack frame the unwinder unwound from (input). The format of the data is opaque to the unwinder and is expected to be processed and understood by the <code>HandlerRoutine</code>.</p>

<h3 id="establisherframe-out">EstablisherFrame* [out]</h3>

<p>This parameter provides a pointer that, on return, receives the <code>Establisher Frame</code> associated with function that was running in the stack frame the unwinder unwound from (input).
Windows uses the <code>Establisher Frame</code> to uniquely identify a specific stack frame in a given stack. For example, this value can be then provided to <strong><a href="rtlunwindex" title="NTSYSAPI VOID RtlUnwindEx(&#10;  [in, optional] PVOID                 TargetFrame,&#10;  [in, optional] PVOID                 TargetIp,&#10;  [in, optional] PEXCEPTION_RECORD     ExceptionRecord,&#10;  [in]           PVOID                 ReturnValue,&#10;  [in]           PCONTEXT              ContextRecord,&#10;  [in, optional] PUNWIND_HISTORY_TABLE HistoryTable&#10;);">RtlUnwindEx</a></strong> to identify the frame at which the stack unwind operation should stop at. This value is also provided to the Exception Handlers when unwinding the stack so they can locate particular data in the stack. An example of this is the /GS cookie validation handler using the <code>Establisher Frame</code> to locate the position of the cookie in the stack.</p>

<p>The actual definition of the <code>Establisher Frame</code> is platform-specific:</p>

<table>
<thead>
<tr>
  <th>Platform</th>
  <th>Definition</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Arm64</td>
  <td>It always represents the value of the <code>Stack Pointer</code> when the function was entered. This value does not change regardless of where in the function <code>ControlPc</code> points at, including within the Prolog and Epilog of the function</td>
</tr>
<tr>
  <td>x86-64</td>
  <td>This value depends on where <code>ControlPc</code> points at in the function. When the <code>ControlPc</code> points to the Body of a function, the value is well defined as the value of the stack pointer within the Body, when the function doesn't have a <code>Frame Pointer</code>, or the value of the <code>Frame Pointer</code> when it has one. In the Prolog of a function <code>Establisher Frame</code> is the same as the <code>Stack Pointer</code> up to the point where a <code>Frame Pointer</code> is defined after which is remains constant - if one is never defined, <code>Establisher Frame</code> continues to <em>shadow</em> the <code>Stack Pointer</code> all the way to the body of the function, after which it must remain constant until it reaches the Epilog. <code>Establisher Frame</code> is not well defined in the Epilog of a function.</td>
</tr>
</tbody>
</table>

<h3 id="contextpointers-in-out-optional">ContextPointers* [in, out, optional]</h3>

<p>When performing the virtual unwind operation, the unwinder will recover the values for the (callee-saved) registers which were spilled in the stack as part of the transition between the two frames. The stack addresses which each register was restored from will be stored in this structure. This parameter is optional.</p>

<h3 id="lowlimit-in-optional">LowLimit [in, optional]</h3>

<p>This optional parameter provides a value to test for stack <strong>overflow</strong>. If, during unwinding, the Stack Pointer moves beyond (lower numeric value, in architectures where the stack grows towards lower values) the value of <code>LowLimit</code>, the unwind will fail with <code>STATUS_BAD_STACK</code>.</p>

<h3 id="highlimit-in-optional">HighLimit [in, optional]</h3>

<p>This optional parameter provides a value to test for stack <strong>underflow</strong>. If, during unwinding, the Stack Pointer moves prior (higher numeric value, in architectures where the stack grows towards lower values) the value of <code>HighLimit</code>, the unwind will fail with <code>STATUS_BAD_STACK</code>.</p>

<h3 id="handlerroutine-out-optional">HandlerRoutine [out, optional]</h3>

<p>This optional parameter provides a function pointer that, on return, receives the Exception Handler routine associated with function that was running in the stack frame the unwinder unwound from (input).</p>

<h3 id="unwindflags-in">UnwindFlags [in]</h3>

<p>A bitmask of option flags with the following values and meanings:</p>

<table>
<thead>
<tr>
  <th>Name</th>
  <th>Value</th>
  <th>Meaning</th>
  <th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
  <td>RTL_VIRTUAL_UNWIND2_VALIDATE_PAC</td>
  <td>0x00000001UL</td>
  <td>During stack unwinding, verify the PAC signature of return address values. Without this flag, the PAC signature is removed from the return address values without verification.</td>
  <td>Arm64 only</td>
</tr>
</tbody>
</table>

<h2 id="return-value">Return value</h2>

<p>This function returns zero on success. (More detail).</p>

<p>See <a rel="noopener" target="_blank" href="https://learn.microsoft.com/openspecs/windows_protocols/ms-erref/596a1078-e883-4972-9bbc-49e60bebca55">NTSTATUS Values</a> for a list of <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> values.</p>

<h2 id="remarks">Remarks</h2>

<p>This function has no associated import library or header file; you must call it using the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/libloaderapi/nf-libloaderapi-loadlibrarya"><strong>LoadLibrary</strong></a> and <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/api/libloaderapi/nf-libloaderapi-getprocaddress"><strong>GetProcAddress</strong></a> functions.</p>

<h2 id="requirements">Requirements</h2>

<table>
<thead>
<tr>
  <th>Requirement</th>
  <th>Value</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Minimum supported client<br></td>
  <td>Windows 11 [desktop apps only]<br></td>
</tr>
<tr>
  <td>Minimum supported server<br></td>
  <td>Windows Server 2022 [desktop apps only]<br></td>
</tr>
<tr>
  <td>Target platform<br></td>
  <td><a rel="noopener" target="_blank" href="https://msdn.microsoft.com/Library/Windows/Hardware/EB2264A4-BAE8-446B-B9A5-19893936DDCA">Universal</a></td>
</tr>
<tr>
  <td>Header<br></td>
  <td>Wdm.h (include Wdm.h, Ntddk.h, or Ntifs.h)</td>
</tr>
<tr>
  <td>DLL<br></td>
  <td>Ntdll.dll</td>
</tr>
</tbody>
</table>

<h2 id="see-also">See also</h2>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows/win32/devnotes/rtlvirtualunwind2">View the official Win32 development documentation</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/win32/blob/docs/desktop-src/DevNotes/rtlvirtualunwind2.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
