<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="PREFETCH_OPEN_ECP_CONTEXT - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>PREFETCH_OPEN_ECP_CONTEXT - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            PREFETCH_OPEN_ECP_CONTEXT - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">typedef struct _PREFETCH_OPEN_ECP_CONTEXT {
  PVOID Context;
} PREFETCH_OPEN_ECP_CONTEXT, *PPREFETCH_OPEN_ECP_CONTEXT;</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ns-ntifs-_prefetch_open_ecp_context">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/prefetch_open_ecp_context.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ns-ntifs-_prefetch_open_ecp_context)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="prefetch_open_ecp_context-structure">PREFETCH_OPEN_ECP_CONTEXT structure</h1>

<h2 id="description">Description</h2>

<p>The <strong>PREFETCH_OPEN_ECP_CONTEXT</strong> structure communicates whether the prefetcher performs a given open request on a file.</p>

<h2 id="members">Members</h2>

<h3 id="context"><code>Context</code></h3>

<p>A pointer to an opaque context that is associated with the open request.</p>

<h2 id="remarks">Remarks</h2>

<p>The prefetcher is a component of the operating system that is tightly integrated with the cache manager and the memory manager to make disk accesses more efficient and therefore improve performance. If other components interfere with the prefetcher, system performance decreases and might deadlock. Therefore, the prefetcher attaches the <strong>PREFETCH_OPEN_ECP_CONTEXT</strong> structure to a file to communicate that the prefetcher has performed an open request on that file. The prefetcher uses the <strong>GUID_ECP_PREFETCH_OPEN</strong> GUID in a call to the <strong><a href="fltcreatefileex2" title="NTSTATUS FLTAPI FltCreateFileEx2(&#10;  [in]            PFLT_FILTER               Filter,&#10;  [in, optional]  PFLT_INSTANCE             Instance,&#10;  [out]           PHANDLE                   FileHandle,&#10;  [out, optional] PFILE_OBJECT              *FileObject,&#10;  [in]            ACCESS_MASK               DesiredAccess,&#10;  [in]            POBJECT_ATTRIBUTES        ObjectAttributes,&#10;  [out]           PIO_STATUS_BLOCK          IoStatusBlock,&#10;  [in, optional]  PLARGE_INTEGER            AllocationSize,&#10;  [in]            ULONG                     FileAttributes,&#10;  [in]            ULONG                     ShareAccess,&#10;  [in]            ULONG                     CreateDisposition,&#10;  [in]            ULONG                     CreateOptions,&#10;  [in, optional]  PVOID                     EaBuffer,&#10;  [in]            ULONG                     EaLength,&#10;  [in]            ULONG                     Flags,&#10;  [in, optional]  PIO_DRIVER_CREATE_CONTEXT DriverContext&#10;);">FltCreateFileEx2</a></strong> or <strong><a href="iocreatefileex" title="NTSTATUS IoCreateFileEx(&#10;  [out]          PHANDLE                   FileHandle,&#10;  [in]           ACCESS_MASK               DesiredAccess,&#10;  [in]           POBJECT_ATTRIBUTES        ObjectAttributes,&#10;  [out]          PIO_STATUS_BLOCK          IoStatusBlock,&#10;  [in, optional] PLARGE_INTEGER            AllocationSize,&#10;  [in]           ULONG                     FileAttributes,&#10;  [in]           ULONG                     ShareAccess,&#10;  [in]           ULONG                     Disposition,&#10;  [in]           ULONG                     CreateOptions,&#10;  [in, optional] PVOID                     EaBuffer,&#10;  [in]           ULONG                     EaLength,&#10;  [in]           CREATE_FILE_TYPE          CreateFileType,&#10;  [in, optional] PVOID                     InternalParameters,&#10;  [in]           ULONG                     Options,&#10;  [in, optional] PIO_DRIVER_CREATE_CONTEXT DriverContext&#10;);">IoCreateFileEx</a></strong> routine to attach the <strong>PREFETCH_OPEN_ECP_CONTEXT</strong> structure. A file system filter driver (filter) can call <strong><a href="fltfindextracreateparameter" title="NTSTATUS FLTAPI FltFindExtraCreateParameter(&#10;  [in]            PFLT_FILTER Filter,&#10;  [in]            PECP_LIST   EcpList,&#10;  [in]            LPCGUID     EcpType,&#10;  [out, optional] PVOID       *EcpContext,&#10;  [out, optional] ULONG       *EcpContextSize&#10;);">FltFindExtraCreateParameter</a></strong> to determine whether <strong>PREFETCH_OPEN_ECP_CONTEXT</strong> is attached to the file and then take appropriate action. The filter should call the <strong><a href="fltisecpfromusermode" title="BOOLEAN FLTAPI FltIsEcpFromUserMode(&#10;  [in] PFLT_FILTER Filter,&#10;  [in] PVOID       EcpContext&#10;);">FltIsEcpFromUserMode</a></strong> routine to determine whether the <strong>PREFETCH_OPEN_ECP_CONTEXT</strong> context structure originated from kernel mode. To prevent malicious applications from spoofing the prefetcher, the filter shouldn't accept <strong>PREFETCH_OPEN_ECP_CONTEXT</strong> if it originated from user mode.</p>

<p>After the prefetcher attaches the <strong>PREFETCH_OPEN_ECP_CONTEXT</strong> structure to a file, all additional prefetcher activity for the file involves the file object that has <strong>PREFETCH_OPEN_ECP_CONTEXT</strong> attached. If a filter must identify prefetcher file system requests other than create requests, the filter should maintain its own state (for example, filter manager handle contexts). The filter maintains its own state in order to determine whether a particular file object is a prefetcher file object.</p>

<p>The memory manager can cache the prefetcher file object. The memory manager can then use the prefetcher file object for other applications that perform mapped I/O or cached I/O by using the cache manager. Therefore, the prefetcher file object can be used for paging I/O before or after the prefetcher closes its handle. This paging I/O can include paging writes, even though the prefetcher never writes any data. The paging writes are generated by other applications. The memory manager writes data from the applications by using its cached prefetcher file object. Therefore, filter performs work that is triggered by paging writes, the filter should still perform that work, even if the paging writes come on a prefetcher file object.</p>

<p>When a filter determines that a cleanup operation occurred on a prefetcher file object, the filter should no longer consider that file object to be prefetcher-opened.</p>

<p>The following are common operations that the prefetcher performs (however, in these operations, the prefetcher never changes file contents):</p>

<ul>
<li>Volume open and close</li>
<li>File open and close</li>
<li>Query file information</li>
<li>Set file information (only to instruct the file system not to update last access time for this open)</li>
<li>Create image and data section</li>
<li>Perform asynchronous paging I/O</li>
</ul>

<p>To avoid inducing a possible deadlock situation, a filter should:</p>

<ul>
<li>Never block any prefetcher operations.</li>
<li>Pass prefetcher operations through without issuing other file system requests.</li>
</ul>

<p>For any application or driver to access any of the data that is being prefetched, it must open its own handle to the file or create a section or both.</p>

<p>For information about how to use ECPs to associate additional information with an <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ifs/irp-mj-create">IRP_MJ_CREATE</a> operation on a file, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ifs/using-extra-create-parameters-with-an-irp-mj-create-operation">Using Extra Create Parameters with an IRP_MJ_CREATE Operation</a>.</p>

<p>The <strong>PREFETCH_OPEN_ECP_CONTEXT</strong> structure is read-only. You should use it to retrieve information about a prefetcher open ECP only. For more information about this issue, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ifs/system-defined-ecps">System-Defined ECPs</a>.</p>

<h2 id="see-also">See also</h2>

<p><strong><a href="fltcreatefileex2" title="NTSTATUS FLTAPI FltCreateFileEx2(&#10;  [in]            PFLT_FILTER               Filter,&#10;  [in, optional]  PFLT_INSTANCE             Instance,&#10;  [out]           PHANDLE                   FileHandle,&#10;  [out, optional] PFILE_OBJECT              *FileObject,&#10;  [in]            ACCESS_MASK               DesiredAccess,&#10;  [in]            POBJECT_ATTRIBUTES        ObjectAttributes,&#10;  [out]           PIO_STATUS_BLOCK          IoStatusBlock,&#10;  [in, optional]  PLARGE_INTEGER            AllocationSize,&#10;  [in]            ULONG                     FileAttributes,&#10;  [in]            ULONG                     ShareAccess,&#10;  [in]            ULONG                     CreateDisposition,&#10;  [in]            ULONG                     CreateOptions,&#10;  [in, optional]  PVOID                     EaBuffer,&#10;  [in]            ULONG                     EaLength,&#10;  [in]            ULONG                     Flags,&#10;  [in, optional]  PIO_DRIVER_CREATE_CONTEXT DriverContext&#10;);">FltCreateFileEx2</a></strong></p>

<p><strong><a href="fltisecpfromusermode" title="BOOLEAN FLTAPI FltIsEcpFromUserMode(&#10;  [in] PFLT_FILTER Filter,&#10;  [in] PVOID       EcpContext&#10;);">FltIsEcpFromUserMode</a></strong></p>

<p><strong><a href="iocreatefileex" title="NTSTATUS IoCreateFileEx(&#10;  [out]          PHANDLE                   FileHandle,&#10;  [in]           ACCESS_MASK               DesiredAccess,&#10;  [in]           POBJECT_ATTRIBUTES        ObjectAttributes,&#10;  [out]          PIO_STATUS_BLOCK          IoStatusBlock,&#10;  [in, optional] PLARGE_INTEGER            AllocationSize,&#10;  [in]           ULONG                     FileAttributes,&#10;  [in]           ULONG                     ShareAccess,&#10;  [in]           ULONG                     Disposition,&#10;  [in]           ULONG                     CreateOptions,&#10;  [in, optional] PVOID                     EaBuffer,&#10;  [in]           ULONG                     EaLength,&#10;  [in]           CREATE_FILE_TYPE          CreateFileType,&#10;  [in, optional] PVOID                     InternalParameters,&#10;  [in]           ULONG                     Options,&#10;  [in, optional] PIO_DRIVER_CREATE_CONTEXT DriverContext&#10;);">IoCreateFileEx</a></strong></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ns-ntifs-_prefetch_open_ecp_context">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/ns-ntifs-_prefetch_open_ecp_context.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
