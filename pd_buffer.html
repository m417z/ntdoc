<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="PD_BUFFER - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>PD_BUFFER - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
        <link rel="stylesheet" href="modules/highlight.js/styles/github.ntdoc.min.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/highlight.js/styles/github-dark-dimmed.ntdoc.min.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            PD_BUFFER - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header language-cpp">// ndis.h

</span><span class="ntdoc-code-intro language-cpp"></span><span class="ntdoc-code-body language-cpp">typedef struct _PD_BUFFER {
  struct _PD_BUFFER   *NextPDBuffer;
  struct _PD_BUFFER   *NextPartialPDBuffer;
  PVOID               PDClientReserved;
  PVOID               PDClientContext;
  PUCHAR              DataBufferVirtualAddress;
  DMA_LOGICAL_ADDRESS DataBufferDmaLogicalAddress;
  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>               DataBufferSize;
  <a href="ushort" title="typedef unsigned short USHORT;">USHORT</a>              PDClientContextSize;
  <a href="ushort" title="typedef unsigned short USHORT;">USHORT</a>              Attributes;
  <a href="ushort" title="typedef unsigned short USHORT;">USHORT</a>              Flags;
  <a href="ushort" title="typedef unsigned short USHORT;">USHORT</a>              DataStart;
  <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>               DataLength;
  union {
    struct {
      union {
        <a href="ulong64" title="typedef unsigned __int64 ULONG64;">ULONG64</a> RxFilterContext;
        <a href="ulong64" title="typedef unsigned __int64 ULONG64;">ULONG64</a> GftFlowEntryId;
      };
      <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                         RxHashValue;
      union {
        struct {
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxIPHeaderChecksumSucceeded : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxTCPChecksumSucceeded : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxUDPChecksumSucceeded : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxIPHeaderChecksumFailed : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxTCPChecksumFailed : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxUDPChecksumFailed : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxHashComputed : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxHashWithL4PortNumbers : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxGftDirectionIngress : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxGftExceptionPacket : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxGftCopyPacket : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxGftSamplePacket : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxReserved1 : 4;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxCoalescedSegCount : 16;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxRscTcpTimestampDelta;
        };
        <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> RxOffloads[2];
      };
      union {
        struct {
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxIsIPv4 : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxIsIPv6 : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxTransportHeaderOffset : 10;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxMSS : 20;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxComputeIPHeaderChecksum : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxComputeTCPChecksum : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxComputeUDPChecksum : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxIsEncapsulatedPacket : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxInnerPacketOffsetsValid : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxReserved1 : 11;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxInnerFrameOffset : 8;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxInnerIpHeaderRelativeOffset : 6;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxInnerIsIPv6 : 1;
          <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxInnerTcpOptionsPresent : 1;
        };
        <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> TxOffloads[2];
      };
      <a href="pd_buffer_virtual_subnet_info" title="typedef struct _PD_BUFFER_VIRTUAL_SUBNET_INFO {&#10;  UINT32 VirtualSubnetId : 24;&#10;  UINT32 Reserved : 8;&#10;} PD_BUFFER_VIRTUAL_SUBNET_INFO;">PD_BUFFER_VIRTUAL_SUBNET_INFO</a> VirtualSubnetInfo;
      <a href="pd_buffer_8021q_info" title="typedef struct _PD_BUFFER_8021Q_INFO {&#10;  UINT16 UserPriority : 3;&#10;  UINT16 CanonicalFormatId : 1;&#10;  UINT16 VlanId : 12;&#10;} PD_BUFFER_8021Q_INFO;">PD_BUFFER_8021Q_INFO</a>          Ieee8021qInfo;
      <a href="ushort" title="typedef unsigned short USHORT;">USHORT</a>                        GftSourceVPortId;
      <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                         Reserved;
      <a href="uint64" title="typedef unsigned __int64 UINT64;">UINT64</a>                        ProviderScratch;
    } MetaDataV0;
  };
} PD_BUFFER;</span><span class="ntdoc-code-footer language-cpp"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/ns-ndis-_pd_buffer">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/pd_buffer.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ns-ndis-_pd_buffer)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1>_PD_BUFFER structure</h1>
<h2>Description</h2>
<p>This structure represents a PacketDirect (PD) packet, or a portion of a PD packet in a queue.</p>
<h2>Members</h2>
<h3><code>NextPDBuffer</code></h3>
<p>A pointer to the next <strong>PD_BUFFER</strong> structure in the queue.</p>
<h3><code>NextPartialPDBuffer</code></h3>
<p>A pointer to the next partial <strong>PD_BUFFER</strong> structure in the queue.</p>
<h3><code>PDClientReserved</code></h3>
<p>Reserved for system use. Do not use.</p>
<h3><code>PDClientContext</code></h3>
<p>The client and the provider are not allowed to modify this field. If a client has allocated the <strong>PD_BUFFER</strong> with a non-zero value for ClientContextSize, then the PDClientContext refers to a buffer size of ClientContextSize. Otherwise, this field is NULL.</p>
<h3><code>DataBufferVirtualAddress</code></h3>
<p>This field represents the address that hosts and software can use to access/modify the packet contents. The actual packet data is always at DataBufferVirtualAddress+DataStart. The provider and the platform never modify the value of this field after the <strong>PD_BUFFER</strong> initialization.</p>
<h3><code>DataBufferDmaLogicalAddress</code></h3>
<p>This field represents the logical memory location used for storing the packet data. The provider
must use for DMA. The actual packet data is always at
DataBufferDmaLogicalAddress+DataStart. The provider and the
platform must never modify the value of this field after the <strong>PD_BUFFER</strong>
initialization.</p>
<h3><code>DataBufferSize</code></h3>
<p>This is the total size of the allocated data buffer. The provider and the platform must never modify the value of this field
after the <strong>PD_BUFFER</strong> initialization. This data type is <strong><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></strong> instead of
<strong><a href="ushort" title="typedef unsigned short USHORT;">USHORT</a></strong> because of large send offload.</p>
<h3><code>PDClientContextSize</code></h3>
<p>When this value is non-zero, it is the size of the buffer pointed to by PDClientContext.
The value of this field must only be modified by the platform. The platform does not change the value of this field after the <strong>PD_BUFFER</strong> allocation.</p>
<h3><code>Attributes</code></h3>
<p>The attributes must never be modified by the provider. The table below lists attributes that this <strong>PD_BUFFER</strong> structure can have.</p>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>PD_BUFFER_ATTR_BUILT_IN_DATA_BUFFER</td>
<td>A <strong>PD_BUFFER</strong> allocated with its own accompanying data buffer will have this attribute set. The <strong>PD_BUFFER</strong> attributes must never be modified by clients or providers.</td>
</tr>
</tbody>
</table>
<h3><code>Flags</code></h3>
<p>The following table lists flags that this <strong>PD_BUFFER</strong> structure can have.</p>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>PD_BUFFER_FLAG_PARTIAL_PACKET_HEAD</td>
<td>Indicates that this buffer is the head of partial packets.</td>
</tr>
</tbody>
</table>
<h3><code>DataStart</code></h3>
<p>This field denotes where the packet starts relative to the original starting address of the allocated data buffer. The provider must never modify this field. The provider adds this value to the
DataBufferDmaLogicalAddress value to derive the actual
target DMA address for packet reception/transmission. For example, the
target DMA address value in the hardware receive/transmit descriptor
must be set to DataBufferDmaLogicalAddress+DataStart when a <strong>PD_BUFFER</strong>
is posted to a receive/transmit queue.</p>
<h3><code>DataLength</code></h3>
<p>The length of the packet or partial packet data.</p>
<h3><code>MetaDataV0</code></h3>
<h3><code>MetaDataV0.RxFilterContext</code></h3>
<p>The provider sets this to the filter context value obtained
from the matched filter that steered the packet to the receive
queue. Filter context values are specified by the clients
when configuring filters.</p>
<h3><code>MetaDataV0.GftFlowEntryId</code></h3>
<p>If one of the RxGftExceptionPacket or RxGftCopyPacket or RxGftSamplePacket bits are set, the RxFilterContext value is
overwritten with a GFT flow entry Id value.</p>
<h3><code>MetaDataV0.RxHashValue</code></h3>
<p>The hash value computed for the incoming packet
that is steered to the receive queue using RSS.</p>
<h3><code>MetaDataV0.RxIPHeaderChecksumSucceeded</code></h3>
<p>A common RX offload field that indicates if the IP header checksum succeeded.</p>
<h3><code>MetaDataV0.RxTCPChecksumSucceeded</code></h3>
<p>A common RX offload field that indicates if the TCP checksum succeeded.</p>
<h3><code>MetaDataV0.RxUDPChecksumSucceeded</code></h3>
<p>A common RX offload field that indicates if the UDP checksum succeeded.</p>
<h3><code>MetaDataV0.RxIPHeaderChecksumFailed</code></h3>
<p>A common RX offload field that indicates if the IP header checksum failed.</p>
<h3><code>MetaDataV0.RxTCPChecksumFailed</code></h3>
<p>A common RX offload field that indicates if the TCP checksum failed.</p>
<h3><code>MetaDataV0.RxUDPChecksumFailed</code></h3>
<p>A common RX offload field that indicates if the UDP checksum failed.</p>
<h3><code>MetaDataV0.RxHashComputed</code></h3>
<p>A common RX offload field that indicates if the hash is computed.</p>
<h3><code>MetaDataV0.RxHashWithL4PortNumbers</code></h3>
<p>A common RX offload field that indicates the hash is computed with L4 port numbers.</p>
<h3><code>MetaDataV0.RxGftDirectionIngress</code></h3>
<h3><code>MetaDataV0.RxGftExceptionPacket</code></h3>
<p>A common RX offload field that indicates this is a GFT exception packet.</p>
<h3><code>MetaDataV0.RxGftCopyPacket</code></h3>
<p>A common RX offload field that indicates this is a GFT copy packet.</p>
<h3><code>MetaDataV0.RxGftSamplePacket</code></h3>
<p>A common RX offload field that indicates this is a GFT sample packet.</p>
<h3><code>MetaDataV0.RxReserved1</code></h3>
<p>Reserved.</p>
<h3><code>MetaDataV0.RxCoalescedSegCount</code></h3>
<p>A common RX offload field that contains the amount of coalesced segments.</p>
<h3><code>MetaDataV0.RxRscTcpTimestampDelta</code></h3>
<p>A common RX offload field that contains RSC and TCP timestamp difference.</p>
<h3><code>MetaDataV0.RxOffloads</code></h3>
<p>RX offloads for this buffer.</p>
<h3><code>MetaDataV0.TxIsIPv4</code></h3>
<p>A common TX offload field that indicates this packet is IPv4.</p>
<h3><code>MetaDataV0.TxIsIPv6</code></h3>
<p>A common TX offload field that indicates this packet is IPv6.</p>
<h3><code>MetaDataV0.TxTransportHeaderOffset</code></h3>
<p>A common TX offload field that contains the packet's header offset.</p>
<h3><code>MetaDataV0.TxMSS</code></h3>
<p>A common TX offload field that contains the maximum segment size of this packet.</p>
<h3><code>MetaDataV0.TxComputeIPHeaderChecksum</code></h3>
<p>A common TX offload field that indicates the IP header checksum is computed.</p>
<h3><code>MetaDataV0.TxComputeTCPChecksum</code></h3>
<p>A common TX offload field that indicates the TCP checksum is computed.</p>
<h3><code>MetaDataV0.TxComputeUDPChecksum</code></h3>
<p>A common TX offload field that indicates the UDP checksum is computed.</p>
<h3><code>MetaDataV0.TxIsEncapsulatedPacket</code></h3>
<p>A common TX offload field that indicates the packet is encapsulated.</p>
<h3><code>MetaDataV0.TxInnerPacketOffsetsValid</code></h3>
<p>A common TX offload field that indicates the inner packet offsets are valid.</p>
<h3><code>MetaDataV0.TxReserved1</code></h3>
<p>Reserved.</p>
<h3><code>MetaDataV0.TxInnerFrameOffset</code></h3>
<p>A common TX offload field that contains the inner frame offset.</p>
<h3><code>MetaDataV0.TxInnerIpHeaderRelativeOffset</code></h3>
<p>A common TX offload field that contains the inner IP header relative offset.</p>
<h3><code>MetaDataV0.TxInnerIsIPv6</code></h3>
<p>A common TX offload field that indicates the inner packet is IPv6.</p>
<h3><code>MetaDataV0.TxInnerTcpOptionsPresent</code></h3>
<p>A common TX offload field that indicates the inner TCP options are present.</p>
<h3><code>MetaDataV0.TxOffloads</code></h3>
<p>TX offloads for this buffer.</p>
<h3><code>MetaDataV0.VirtualSubnetInfo</code></h3>
<p>The virtual subnet information.</p>
<h3><code>MetaDataV0.Ieee8021qInfo</code></h3>
<p>The IEEE 802.1Q information.</p>
<h3><code>MetaDataV0.GftSourceVPortId</code></h3>
<p>The GFT source virtual port ID.</p>
<h3><code>MetaDataV0.Reserved</code></h3>
<p>Reserved for system use.</p>
<h3><code>MetaDataV0.ProviderScratch</code></h3>
<p>A scratch field that the PD provider can use for its own purposes while the PD_BUFFER is sitting in the provider queue (in other words, posted by the client but not yet drained back by the client). Once the PD_BUFFER is drained by the client, there is no guarantee that the contents of this field will be preserved.</p>
<h2>Remarks</h2>
<p>If an L2 packet is represented by multiple <strong>PD_BUFFER</strong> structures, the first <strong>PD_BUFFER</strong>
must have the PD_BUFFER_ATTR_BUILT_IN_DATA_BUFFER flag set and the
NextPartialPDBuffer field must point to the partial <strong>PD_BUFFER</strong> structures that
constitute the whole packet. Each of the partial <strong>PD_BUFFER</strong> structures must point to the next partial <strong>PD_BUFFER</strong> by using the NextPartialPDBuffer as opposed to the NextPDBuffer field. The NextPDBuffer field must be NULL in all partial <strong>PD_BUFFER</strong> structures except
for the head buffer. All partial PD_BUFFER structures except for the head buffer must
have the PD_BUFFER_ATTR_BUILT_IN_DATA_BUFFER flag cleared. The last partial
<strong>PD_BUFFER</strong> must have it's NextPartialPDBuffer field set to NULL. The total
length of the L2 packet is the sum of DataLength fields from each partial
<strong>PD_BUFFER</strong>. The head <strong>PD_BUFFER</strong> must contain up to and including the IP transport (TCP, UDP, SCTP, etc) header. In the case of encapsulation or double-encapsulation,
the inner-most IP transport header must be contained in the head <strong>PD_BUFFER</strong>.</p>
<p>When posting <strong>PD_BUFFER</strong> structures to receive queues, DataLength is ignored by
the provider (For more information see the ReceiveDataLength description in the <a href="ndis_pd_queue_parameters" title="typedef struct _NDIS_PD_QUEUE_PARAMETERS {&#10;  NDIS_OBJECT_HEADER     Header;&#10;  ULONG                  Flags;&#10;  NDIS_PD_QUEUE_TYPE     QueueType;&#10;  ULONG                  QueueSize;&#10;  ULONG                  ReceiveDataLength;&#10;  GROUP_AFFINITY         Affinity;&#10;  ULONG                  TrafficClassId;&#10;  ULONG                  MaximumPartialBufferCount;&#10;  NDIS_PD_COUNTER_HANDLE CounterHandle;&#10;} NDIS_PD_QUEUE_PARAMETERS;">NDIS_PD_QUEUE_PARAMETERS</a> structure).
When draining completed <strong>PD_BUFFER</strong> structures from receive queues,
the provider stores the length of the received packet in the DataLength field. The length does not include FCS or any stripped 801Q
headers.
When posting <strong>PD_BUFFER</strong> structures to transmit queues, DataLength denotes the length
of the packet to be sent. When draining completed <strong>PD_BUFFER</strong> structures from
transmit queues, the provider leaves the DataLength field unmodified.</p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ndis/ns-ndis-_pd_buffer">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ndis/ns-ndis-_pd_buffer.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script src="modules/highlight.js/highlight.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
