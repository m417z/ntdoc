<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="KeQueryActiveProcessors - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>KeQueryActiveProcessors - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            KeQueryActiveProcessors - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntddk.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">KAFFINITY KeQueryActiveProcessors();</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntddk/nf-ntddk-kequeryactiveprocessors">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">KAFFINITY KeQueryActiveProcessors();</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kequeryactiveprocessors">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/kequeryactiveprocessors.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ntddk-kequeryactiveprocessors)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="kequeryactiveprocessors-function-ntddkh">KeQueryActiveProcessors function (ntddk.h)</h1>

<h2 id="description">Description</h2>

<p>The <strong>KeQueryActiveProcessors</strong> routine returns a bitmask of the currently active processors.</p>

<h2 id="return-value">Return value</h2>

<p><strong>KeQueryActiveProcessors</strong> returns a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/interrupt-affinity-and-priority#about-kaffinity"><strong>KAFFINITY</strong></a> value that represents the set of currently active processors.</p>

<h2 id="remarks">Remarks</h2>

<p>Callers cannot assume that <strong>KeQueryActiveProcessors</strong> maps processors to bits consecutively, or that the routine consistently uses the same mapping each time it is called. The only valid use for the return value is to determine the number of active processors by counting the number of bits that are set.</p>

<p>Callers must also be aware that the value returned by <strong>KeQueryActiveProcessors</strong> can change during runtime on versions of Windows that support hot-add CPU functionality.</p>

<p>Windows 7 and later versions of Windows support processor groups. Drivers that are designed to handle information about processor groups should use the <a href="kequerygroupaffinity" title="KAFFINITY KeQueryGroupAffinity(&#10;  [in] USHORT GroupNumber&#10;);">KeQueryGroupAffinity</a> routine, which specifies a processor group, instead of <strong>KeQueryActiveProcessors</strong>, which does not. However, the implementation of <strong>KeQueryActiveProcessors</strong> in Windows 7 and later versions of Windows provides compatibility for drivers that were written for earlier versions of Windows, which do not support processor groups. In this implementation, <strong>KeQueryActiveProcessors</strong> returns an affinity mask that specifies the set of active logical processors in group 0.</p>

<p>In Windows Vista and later versions of Windows, this routine can be called at any IRQL. However, in Windows Server 2003 and earlier versions of Windows, this routine must be called at IRQL &lt;= APC_LEVEL.</p>

<p>The <strong>KeNumberProcessors</strong> kernel variable is obsolete in Windows Vista with Service Pack 1 (SP1), Windows Server 2008, and later versions of Windows. <strong>KeNumberProcessors</strong> does not appear in WDK headers for WDK releases starting with Windows Vista SP1; however, the variable is still exported from the kernel, so drivers built for earlier platforms will not break</p>

<p>Windows Server 2008 includes support for <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/dynamic-hardware-partitioning-architecture">Dynamic Hardware Partitioning</a> (DHP) in the Windows Datacenter and Enterprise Edition SKUs. As part of DHP, Windows Server 2008 supports hot adding CPUs at runtime. In a hot-add CPU environment, the number of processors may not remain constant during runtime.</p>

<p>Accordingly, in Windows Server 2008, code that can determine the number of processors must use <strong>KeQueryActiveProcessors</strong> instead of direct references to the kernel variable, <strong>KeNumberProcessors</strong>.</p>

<p>Review any code that currently references <strong>KeNumberProcessors</strong> to make sure that it accommodates changes to CPU count in hot-add CPU environments.</p>

<p>You can use the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/pnpcpu">PNPCPU</a> tool to simulate hot adding a CPU for testing purposes.</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="cp">#if (NTDDI_VERSION &gt;= NTDDI_VISTA)</span>
<span class="k">extern</span><span class="w"> </span><span class="n">NTSYSAPI</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="n"><a href="cchar" title="typedef char CCHAR;">CCHAR</a></span><span class="w"> </span><span class="n">KeNumberProcessors</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#if (NTDDI_VERSION &gt;= NTDDI_WINXP)</span>
<span class="k">extern</span><span class="w"> </span><span class="n">NTSYSAPI</span><span class="w"> </span><span class="n"><a href="cchar" title="typedef char CCHAR;">CCHAR</a></span><span class="w"> </span><span class="n">KeNumberProcessors</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">extern</span><span class="w"> </span><span class="n"><a href="pcchar" title="typedef CCHAR *PCCHAR;">PCCHAR</a></span><span class="w"> </span><span class="n">KeNumberProcessors</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
</code></pre>
</div>

<p>Starting with Windows XP, <strong>KeNumberProcessors</strong> is an 8-bit integer value that indicates the number of processors in the platform. In earlier versions of Windows, <strong>KeNumberProcessors</strong> is a pointer to an 8-bit integer value that indicates the number of processors in the platform.</p>

<h2 id="see-also">See also</h2>

<p><a href="kequeryactiveprocessorcount" title="ULONG KeQueryActiveProcessorCount(&#10;  [out, optional] PKAFFINITY ActiveProcessors&#10;);">KeQueryActiveProcessorCount</a></p>

<p><a href="kequerygroupaffinity" title="KAFFINITY KeQueryGroupAffinity(&#10;  [in] USHORT GroupNumber&#10;);">KeQueryGroupAffinity</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntddk/nf-ntddk-kequeryactiveprocessors">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntddk/nf-ntddk-kequeryactiveprocessors.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdm-kequeryactiveprocessors)</h1>
</div>
<div class="ntdoc-description">
<h1>KeQueryActiveProcessors function (wdm.h)</h1>

<h2>Description</h2>

<p>The <strong>KeQueryActiveProcessors</strong> routine returns a bitmask of the currently active processors.</p>

<h2>Return value</h2>

<p><strong>KeQueryActiveProcessors</strong> returns a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/interrupt-affinity-and-priority#about-kaffinity"><strong>KAFFINITY</strong></a> value that represents the set of currently active processors.</p>

<h2>Remarks</h2>

<p>Callers cannot assume that <strong>KeQueryActiveProcessors</strong> maps processors to bits consecutively, or that the routine consistently uses the same mapping each time it is called. The only valid use for the return value is to determine the number of active processors by counting the number of bits that are set.</p>

<p>Callers must also be aware that the value returned by <strong>KeQueryActiveProcessors</strong> can change during runtime on versions of Windows that support hot-add CPU functionality.</p>

<p>Windows 7 and later versions of Windows support processor groups. Drivers that are designed to handle information about processor groups should use the <a href="kequerygroupaffinity" title="KAFFINITY KeQueryGroupAffinity(&#10;  [in] USHORT GroupNumber&#10;);">KeQueryGroupAffinity</a> routine, which specifies a processor group, instead of <strong>KeQueryActiveProcessors</strong>, which does not. However, the implementation of <strong>KeQueryActiveProcessors</strong> in Windows 7 and later versions of Windows provides compatibility for drivers that were written for earlier versions of Windows, which do not support processor groups. In this implementation, <strong>KeQueryActiveProcessors</strong> returns an affinity mask that specifies the set of active logical processors in group 0.</p>

<p>In Windows Vista and later versions of Windows, this routine can be called at any IRQL. However, in Windows Server 2003 and earlier versions of Windows, this routine must be called at IRQL &lt;= APC_LEVEL.</p>

<p>The <strong>KeNumberProcessors</strong> kernel variable is obsolete in Windows Vista with Service Pack 1 (SP1), Windows Server 2008, and later versions of Windows. <strong>KeNumberProcessors</strong> does not appear in WDK headers for WDK releases starting with Windows Vista SP1; however, the variable is still exported from the kernel, so drivers built for earlier platforms will not break</p>

<p>Windows Server 2008 includes support for <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/dynamic-hardware-partitioning-architecture">Dynamic Hardware Partitioning</a> (DHP) in the Windows Datacenter and Enterprise Edition SKUs. As part of DHP, Windows Server 2008 supports hot adding CPUs at runtime. In a hot-add CPU environment, the number of processors may not remain constant during runtime.</p>

<p>Accordingly, in Windows Server 2008, code that can determine the number of processors must use <strong>KeQueryActiveProcessors</strong> instead of direct references to the kernel variable, <strong>KeNumberProcessors</strong>.</p>

<p>Review any code that currently references <strong>KeNumberProcessors</strong> to make sure that it accommodates changes to CPU count in hot-add CPU environments.</p>

<p>You can use the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/pnpcpu">PNPCPU</a> tool to simulate hot adding a CPU for testing purposes.</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="cp">#if (NTDDI_VERSION &gt;= NTDDI_VISTA)</span>
<span class="k">extern</span><span class="w"> </span><span class="n">NTSYSAPI</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="n"><a href="cchar" title="typedef char CCHAR;">CCHAR</a></span><span class="w"> </span><span class="n">KeNumberProcessors</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#if (NTDDI_VERSION &gt;= NTDDI_WINXP)</span>
<span class="k">extern</span><span class="w"> </span><span class="n">NTSYSAPI</span><span class="w"> </span><span class="n"><a href="cchar" title="typedef char CCHAR;">CCHAR</a></span><span class="w"> </span><span class="n">KeNumberProcessors</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">extern</span><span class="w"> </span><span class="n"><a href="pcchar" title="typedef CCHAR *PCCHAR;">PCCHAR</a></span><span class="w"> </span><span class="n">KeNumberProcessors</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
</code></pre>
</div>

<p>Starting with Windows XP, <strong>KeNumberProcessors</strong> is an 8-bit integer value that indicates the number of processors in the platform. In earlier versions of Windows, <strong>KeNumberProcessors</strong> is a pointer to an 8-bit integer value that indicates the number of processors in the platform.</p>

<h2>See also</h2>

<p><a href="kequeryactiveprocessorcount" title="ULONG KeQueryActiveProcessorCount(&#10;  [out, optional] PKAFFINITY ActiveProcessors&#10;);">KeQueryActiveProcessorCount</a></p>

<p><a href="kequerygroupaffinity" title="KAFFINITY KeQueryGroupAffinity(&#10;  [in] USHORT GroupNumber&#10;);">KeQueryGroupAffinity</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kequeryactiveprocessors">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/nf-wdm-kequeryactiveprocessors.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
