<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="ObReferenceObjectByHandleWithTag - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>ObReferenceObjectByHandleWithTag - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            ObReferenceObjectByHandleWithTag - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> ObReferenceObjectByHandleWithTag(
  [in]            HANDLE                     Handle,
  [in]            ACCESS_MASK                DesiredAccess,
  [in, optional]  POBJECT_TYPE               ObjectType,
  [in]            KPROCESSOR_MODE            AccessMode,
  [in]            <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>                      Tag,
  [out]           PVOID                      *Object,
  [out, optional] POBJECT_HANDLE_INFORMATION HandleInformation
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-obreferenceobjectbyhandlewithtag">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/obreferenceobjectbyhandlewithtag.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdm-obreferenceobjectbyhandlewithtag)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="obreferenceobjectbyhandlewithtag-function">ObReferenceObjectByHandleWithTag function</h1>

<h2 id="description">Description</h2>

<p>The <strong>ObReferenceObjectByHandleWithTag</strong> routine increments the reference count of the object that is identified by the specified handle, and writes a four-byte tag value to the object to support <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/debugger/object-reference-tracing">object reference tracing</a>.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="handle-in"><code>Handle</code> [in]</h3>

<p>Specifies an open handle for an object.</p>

<h3 id="desiredaccess-in"><code>DesiredAccess</code> [in]</h3>

<p>Specifies the types of access to the object that the caller requests. This parameter is a bitmask of type <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/access-mask">ACCESS_MASK</a>. The interpretation of this field depends on the object type. Do not use any generic access rights.</p>

<h3 id="objecttype-in-optional"><code>ObjectType</code> [in, optional]</h3>

<p>A pointer to an opaque structure that specifies the object type. This parameter points to an <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/eprocess">OBJECT_TYPE</a> structure. Set <em>ObjectType</em> to <strong>NULL</strong> or to one of the following pointer values, which are declared in the Wdm.h header file: *<strong>ExEventObjectType</strong>, *<strong>ExSemaphoreObjectType</strong>, *<strong>IoFileObjectType</strong>, *<strong>PsProcessType</strong>, *<strong>PsThreadType</strong>, *<strong>SeTokenObjectType</strong>, *<strong>TmEnlistmentObjectType</strong>, *<strong>TmResourceManagerObjectType</strong>, *<strong>TmTransactionManagerObjectType</strong>, or *<strong>TmTransactionObjectType</strong>. If <em>ObjectType</em> is not <strong>NULL</strong>, the routine verifies that the supplied object type matches the object type of the object that the <em>Handle</em> parameter specifies.</p>

<h3 id="accessmode-in"><code>AccessMode</code> [in]</h3>

<p>Specifies the access mode to use for the access check. It must be either <strong>UserMode</strong> or <strong>KernelMode</strong>. Drivers should always specify <strong>UserMode</strong> for handles they receive from user address space.</p>

<h3 id="tag-in"><code>Tag</code> [in]</h3>

<p>Specifies a four-byte, custom tag value. For more information, see the following Remarks section.</p>

<h3 id="object-out"><code>Object</code> [out]</h3>

<p>A pointer to a variable into which the routine writes a pointer to the object. The following table lists the <em>Object</em> pointer types that are designated by the possible <em>ObjectType</em> parameter values.</p>

<table>
<thead>
<tr>
  <th><em>ObjectType</em> parameter</th>
  <th><em>Object</em> pointer type</th>
</tr>
</thead>
<tbody>
<tr>
  <td>*<strong>ExEventObjectType</strong></td>
  <td>PKEVENT</td>
</tr>
<tr>
  <td>*<strong>ExSemaphoreObjectType</strong></td>
  <td>PKSEMAPHORE</td>
</tr>
<tr>
  <td>*<strong>IoFileObjectType</strong></td>
  <td><a href="file_object" title="typedef struct _FILE_OBJECT {&#10;  CSHORT                                Type;&#10;  CSHORT                                Size;&#10;  PDEVICE_OBJECT                        DeviceObject;&#10;  PVPB                                  Vpb;&#10;  PVOID                                 FsContext;&#10;  PVOID                                 FsContext2;&#10;  PSECTION_OBJECT_POINTERS              SectionObjectPointer;&#10;  PVOID                                 PrivateCacheMap;&#10;  NTSTATUS                              FinalStatus;&#10;  struct _FILE_OBJECT                   *RelatedFileObject;&#10;  BOOLEAN                               LockOperation;&#10;  BOOLEAN                               DeletePending;&#10;  BOOLEAN                               ReadAccess;&#10;  BOOLEAN                               WriteAccess;&#10;  BOOLEAN                               DeleteAccess;&#10;  BOOLEAN                               SharedRead;&#10;  BOOLEAN                               SharedWrite;&#10;  BOOLEAN                               SharedDelete;&#10;  ULONG                                 Flags;&#10;...">PFILE_OBJECT</a></td>
</tr>
<tr>
  <td>*<strong>PsProcessType</strong></td>
  <td>PEPROCESS or PKPROCESS</td>
</tr>
<tr>
  <td>*<strong>PsThreadType</strong></td>
  <td>PETHREAD or PKTHREAD</td>
</tr>
<tr>
  <td>*<strong>SeTokenObjectType</strong></td>
  <td>PACCESS_TOKEN</td>
</tr>
<tr>
  <td>*<strong>TmEnlistmentObjectType</strong></td>
  <td>PKENLISTMENT</td>
</tr>
<tr>
  <td>*<strong>TmResourceManagerObjectType</strong></td>
  <td>PKRESOURCEMANAGER</td>
</tr>
<tr>
  <td>*<strong>TmTransactionManagerObjectType</strong></td>
  <td>PKTM</td>
</tr>
<tr>
  <td>*<strong>TmTransactionObjectType</strong></td>
  <td>PKTRANSACTION</td>
</tr>
</tbody>
</table>

<p>The structures that the pointer types reference are opaque, and drivers cannot access the structure members. Because the structures are opaque, PEPROCESS is equivalent to PKPROCESS, and PETHREAD is equivalent to PKTHREAD.</p>

<h3 id="handleinformation-out-optional"><code>HandleInformation</code> [out, optional]</h3>

<p>Drivers set this parameter to <strong>NULL</strong>.</p>

<h2 id="return-value">Return value</h2>

<p><strong>ObReferenceObjectByHandleWithTag</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the call is successful. Possible error return values include the following:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>STATUS_OBJECT_TYPE_MISMATCH</strong></td>
  <td>The <em>ObjectType</em> parameter specifies the wrong object type for the object that is identified by the <em>Handle</em> parameter.</td>
</tr>
<tr>
  <td><strong>STATUS_ACCESS_DENIED</strong></td>
  <td>The caller does not have the required access rights to the object.</td>
</tr>
<tr>
  <td><strong>STATUS_INVALID_HANDLE</strong></td>
  <td>The specified handle is not valid.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>This routine does access validation of the specified object handle. If access can be granted, the routine increments the object reference count and provides an object pointer to the caller. This increment prevents the object from being deleted while the caller uses the object. When the object is no longer needed, the caller should decrement the reference count by calling the <a rel="noopener" target="_blank" href="obdereferenceobjectwithtag">ObDereferenceObjectWithTag</a> or <a rel="noopener" target="_blank" href="obdereferenceobjectdeferdeletewithtag">ObDereferenceObjectDeferDeleteWithTag</a> routine.</p>

<p>For more information about object references, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/life-cycle-of-an-object">Life Cycle of an Object</a>.</p>

<p><strong>ObReferenceObjectByHandleWithTag</strong> does not close or invalidate the object handle that is specified by the <em>Handle</em> parameter. When the handle is no longer needed, the caller can close the handle by calling the <a rel="noopener" target="_blank" href="ntclose">ZwClose</a> routine.</p>

<p>If the <em>AccessMode</em> parameter value is <strong>KernelMode</strong>, the requested access is always allowed. If <em>AccessMode</em> is <strong>UserMode</strong>, the requested access is compared to the access rights that the caller has to the object. Only highest-level drivers can safely specify the <strong>UserMode</strong> value for the <em>AccessMode</em> parameter.</p>

<p>Starting with Windows 7, if <em>AccessMode</em> is <strong>KernelMode</strong> and handle is received from user address space, <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/driver-verifier">Driver Verifier</a> issues bugcheck C4, subcode F6.</p>

<p>The <a rel="noopener" target="_blank" href="obreferenceobjectbyhandle">ObReferenceObjectByHandle</a> routine is similar to <strong>ObReferenceObjectByHandleWithTag</strong>, except that it does not enable the caller to write a custom tag to an object. In Windows 7 and later versions of Windows, <strong><a href="obreferenceobjectbyhandle" title="NTSTATUS ObReferenceObjectByHandle(&#10;  [in]            HANDLE                     Handle,&#10;  [in]            ACCESS_MASK                DesiredAccess,&#10;  [in, optional]  POBJECT_TYPE               ObjectType,&#10;  [in]            KPROCESSOR_MODE            AccessMode,&#10;  [out]           PVOID                      *Object,&#10;  [out, optional] POBJECT_HANDLE_INFORMATION HandleInformation&#10;);">ObReferenceObjectByHandle</a></strong> always writes a default tag value ('tlfD') to the object. A call to <strong><a href="obreferenceobjectbyhandle" title="NTSTATUS ObReferenceObjectByHandle(&#10;  [in]            HANDLE                     Handle,&#10;  [in]            ACCESS_MASK                DesiredAccess,&#10;  [in, optional]  POBJECT_TYPE               ObjectType,&#10;  [in]            KPROCESSOR_MODE            AccessMode,&#10;  [out]           PVOID                      *Object,&#10;  [out, optional] POBJECT_HANDLE_INFORMATION HandleInformation&#10;);">ObReferenceObjectByHandle</a></strong> has the same effect as a call to <strong>ObReferenceObjectByHandleWithTag</strong> that specifies <em>Tag</em> = 'tlfD'.</p>

<p>To view an object reference trace in the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/debugger/">Windows debugging tools</a>, use the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/debugger/-obtrace">!obtrace</a> kernel-mode debugger extension. The <strong>!obtrace</strong> extension is enhanced to display object reference tags, if object reference tracing is enabled. By default, object reference tracing is turned off. Use the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/debugger/gflags">Global Flags Editor</a> (Gflags) to enable object reference tracing. For more information, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/object-reference-tracing-with-tags">Object Reference Tracing with Tags</a>.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/access-mask">ACCESS_MASK</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/eprocess">OBJECT_TYPE</a></p>

<p><a rel="noopener" target="_blank" href="obdereferenceobjectdeferdeletewithtag">ObDereferenceObjectDeferDeleteWithTag</a></p>

<p><a rel="noopener" target="_blank" href="obdereferenceobjectwithtag">ObDereferenceObjectWithTag</a></p>

<p><a rel="noopener" target="_blank" href="obreferenceobjectbyhandle">ObReferenceObjectByHandle</a></p>

<p><a rel="noopener" target="_blank" href="ntclose">ZwClose</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-obreferenceobjectbyhandlewithtag">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/nf-wdm-obreferenceobjectbyhandlewithtag.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
