<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="D3DKMTCreateNativeFence - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>D3DKMTCreateNativeFence - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            D3DKMTCreateNativeFence - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// d3dkmthk.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> D3DKMTCreateNativeFence(
  <a href="d3dkmt_createnativefence" title="typedef struct _D3DKMT_CREATENATIVEFENCE {&#10;  D3DKMT_HANDLE                  hDevice;&#10;  D3DKMT_HANDLE                  hSyncObject;&#10;  BYTE                           PrivateDriverData[D3DDDI_NATIVE_FENCE_PDD_SIZE];&#10;  D3DDDI_NATIVEFENCEINFO         Info;&#10;  D3DKMT_CREATENATIVEFENCE_FLAGS Flags;&#10;  BYTE                           Reserved[28];&#10;} D3DKMT_CREATENATIVEFENCE;">D3DKMT_CREATENATIVEFENCE</a> *unnamedParam1
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dkmthk/nf-d3dkmthk-d3dkmtcreatenativefence">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/d3dkmtcreatenativefence.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-d3dkmthk-d3dkmtcreatenativefence)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2 id="description">Description</h2>

<p>The D3D runtime calls <strong>D3DKMTCreateNativeFence</strong> to create a native GPU fence object on a particular device.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="unnamedparam1"><code>unnamedParam1</code></h3>

<p>[in/out] Pointer to a <a rel="noopener" target="_blank" href="d3dkmt_createnativefence"><strong>D3DKMT_CREATENATIVEFENCE</strong></a> structure that describes the fence object to create.</p>

<h2 id="return-value">Return value</h2>

<p><strong>D3DKMTCreateNativeFence</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> on successful creation. Otherwise it returns an <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> error code such as STATUS_INVALID_PARAMETER.</p>

<h2 id="remarks">Remarks</h2>

<p>The specified <a rel="noopener" target="_blank" href="d3dddi_nativefence_type"><strong>D3DDDI_NATIVEFENCE_TYPE</strong></a> dictates the type of native fence that the OS creates. These fences differ in functionality, performance characteristics, and storage requirements for <strong>CurrentValue</strong> and <strong>MonitoredValue</strong>. The following table shows these differences, where CVal stands for <strong>CurrentValue</strong> and MVal stands for <strong>MonitoredValue</strong>.</p>

<table>
<thead>
<tr>
  <th>Type</th>
  <th>CurrentValue</th>
  <th>MonitoredValue</th>
  <th>Supports Cross-process Sharing on CPU</th>
  <th>Supports Cross-Adapter Sharing</th>
  <th>UM CPUVA CVal</th>
  <th>KM CPUVA CVal</th>
  <th>GPU VA CVal</th>
  <th>CMPVA CVal</th>
  <th>UM MVal</th>
  <th>KM MVal</th>
  <th>GPU VA MVal</th>
  <th>CMPVA MVal</th>
  <th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>D3DDDI_NATIVEFENCE_TYPE_DEFAULT</strong></td>
  <td>Sysmem</td>
  <td>Sysmem</td>
  <td>Yes</td>
  <td>Yes</td>
  <td>ReadOnly</td>
  <td>Read/Write</td>
  <td>Read/Write</td>
  <td>Read/Write</td>
  <td>N/A</td>
  <td>Write</td>
  <td>ReadOnly (or Read/Write)</td>
  <td>Read/Write</td>
  <td>Application fences with reduced CPU interrupts. GPU waiter is unblocked without waking up CPU</td>
</tr>
<tr>
  <td><strong>D3DDDI_NATIVEFENCE_TYPE_DEFAULT</strong> (<em>OPTIMIZED</em>)</td>
  <td>Sysmem</td>
  <td>VRAM</td>
  <td>Yes</td>
  <td>Yes</td>
  <td>ReadOnly</td>
  <td>Read/Write</td>
  <td>Read/Write</td>
  <td>Read/Write</td>
  <td>N/A</td>
  <td>Write</td>
  <td>ReadOnly (or Read/Write)</td>
  <td>Read/Write</td>
  <td>Same as Type 0 but with reduced PCI bus traffic as MVal reads are local to the GPU. The GPU signal command completes faster because of this reduced latency (throughput++).</td>
</tr>
<tr>
  <td><strong>D3DDDI_NATIVEFENCE_TYPE_INTRA_GPU</strong></td>
  <td>VRAM</td>
  <td>VRAM</td>
  <td>Yes</td>
  <td>No</td>
  <td>N/A</td>
  <td>N/A</td>
  <td>Read/Write</td>
  <td>Read/Write</td>
  <td>N/A</td>
  <td>N/A</td>
  <td>ReadOnly (or Read/Write)</td>
  <td>Read/Write</td>
  <td>Command buffer level (not application visible) synchronization within the same GPU. Read/Write to fence value (CVal) is local, so signal/unblock operations are fast.</td>
</tr>
</tbody>
</table>

<ul>
<li><p><strong>D3DDDI_NATIVEFENCE_TYPE_DEFAULT</strong></p>

<ul>
<li>Supported in Windows 11, version 24H2.</li>
<li>This fence type supports all existing D3DKMT sync object Wait/Signal from CPU/GPU operations.</li>
<li>Both <strong>CurrentValue</strong> and <strong>MonitoredValue</strong> storage for this fence type are allocated in system memory segment.</li>
</ul></li>
<li><p><strong>D3DDDI_NATIVEFENCE_TYPE_DEFAULT</strong> (<em>Optimized</em>)</p>

<ul>
<li>This capability is not currently supported by the OS.</li>
<li>The optimized version of <strong>D3DDDI_NATIVEFENCE_TYPE_DEFAULT</strong>, in which the <strong>MonitoredValue</strong> storage can be allocated in VRAM, will speed up reads of <strong>MonitoredValue</strong> from the GPU engine.</li>
<li>This optimization is not exposed to UMD. Instead, <em>Dxgkrnl</em> and KMD will decide whether the default fence type can be optimized by allocating MonitoredValue storage in VRAM.</li>
<li><strong>MonitoredValue</strong> storage allocated in VRAM may still be demoted to system memory if the system is under local memory pressure.</li>
<li>If the OS supports this fence type, it sets <strong>SupportOptimizedDefaultFenceType</strong> to TRUE in the <a rel="noopener" target="_blank" href="dxgkargcb_feature_nativefence_caps_1"><strong>DXGKARGCB_FEATURE_NATIVEFENCE_CAPS_1</strong></a> feature interface table. KMD is expected to query the feature interface table during driver initialization to determine this OS capability.</li>
</ul></li>
<li><p><strong>D3DDDI_NATIVEFENCE_TYPE_INTRA_GPU</strong></p>

<ul>
<li>This capability is not currently supported by the OS.</li>
<li>A <strong>D3DDDI_NATIVEFENCE_TYPE_INTRA_GPU</strong> fence doesn't support any CPU operations; that is, the OS doesn't allow user mode to queue wait and signals to this fence object.</li>
<li>Hence, this type can't be used for DX application fences that must support CPU wait and signal semantics. This type is mainly used for internal UMD fences for synchronization between GPU engines. Creating this type as a D3DKMT native fence object provides visibility into these fences for tools such as <em>GpuView</em> and debugging.</li>
<li>The supported segment for this fence must be a non-CPU visible local memory segment.</li>
<li>Storage allocated in local memory may still be demoted to system memory if the system is under local memory pressure.</li>
<li>If the OS supports this fence type, it sets <strong>SupportIntraGpuFenceType</strong> to TRUE in the <a rel="noopener" target="_blank" href="dxgkargcb_feature_nativefence_caps_1"><strong>DXGKARGCB_FEATURE_NATIVEFENCE_CAPS_1</strong></a> feature interface table. KMD is expected to query the feature interface table during driver initialization to determine this OS capability.</li>
</ul></li>
</ul>

<p>For more information about native GPU fences, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/display/native-gpu-fence-objects">Native GPU fence objects</a>.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="d3dkmt_createnativefence"><strong>D3DKMT_CREATENATIVEFENCE</strong></a></p>

<p><a rel="noopener" target="_blank" href="d3dkmtopennativefencefromnthandle"><strong>D3DKMTOpenNativeFenceFromNTHandle</strong></a></p>

<p><a rel="noopener" target="_blank" href="d3dkmtdestroysynchronizationobject"><strong>D3DKMTDestroySynchronizationObject</strong></a></p>

<p><a rel="noopener" target="_blank" href="dxgkddi_createnativefence"><strong>DxgkDdiCreateNativeFence</strong></a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/d3dkmthk/nf-d3dkmthk-d3dkmtcreatenativefence">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/d3dkmthk/nf-d3dkmthk-d3dkmtcreatenativefence.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
