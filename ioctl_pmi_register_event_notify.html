<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="IOCTL_PMI_REGISTER_EVENT_NOTIFY - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>IOCTL_PMI_REGISTER_EVENT_NOTIFY - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            IOCTL_PMI_REGISTER_EVENT_NOTIFY - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// pmi.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">// <a href="ctl_code" title="void CTL_CODE(&#10;  DeviceType,&#10;  Function,&#10;  Method,&#10;  Access&#10;);">CTL_CODE</a>(0x0045, 0x004, METHOD_BUFFERED, FILE_READ_ACCESS | FILE_WRITE_ACCESS)
#define IOCTL_PMI_REGISTER_EVENT_NOTIFY 0x0045C010</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/pmi/ni-pmi-ioctl_pmi_register_event_notify">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ioctl_pmi_register_event_notify.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ni-pmi-ioctl_pmi_register_event_notify)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1>IOCTL_PMI_REGISTER_EVENT_NOTIFY IOCTL</h1>

<h2>Description</h2>

<p>The <strong>IOCTL_PMI_REGISTER_EVENT_NOTIFY</strong> request registers the IOCTL initiator to be notified about a power meter event. When the event occurs, the Power Meter Interface (PMI) completes the IOCTL request and returns information about the event.</p>

<h2>Parameters</h2>

<h3>Major code</h3>

<h3>Input buffer</h3>

<p>The <strong>AssociatedIrp.SystemBuffer</strong> member of the I/O request packet (<a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a>) points to an initiator-allocated input buffer that contains a <a href="pmi_event" title="typedef struct _PMI_EVENT {&#10;  ULONG          Version;&#10;  PMI_EVENT_TYPE EventType;&#10;} PMI_EVENT, *PPMI_EVENT;">PMI_EVENT</a> structure.</p>

<h3>Input buffer length</h3>

<p>The <strong>Parameters.DeviceIoControl.InputBufferLength</strong> member of the <a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a>'s current I/O stack location (<a href="io_stack_location" title="typedef struct _IO_STACK_LOCATION {&#10;  UCHAR                  MajorFunction;&#10;  UCHAR                  MinorFunction;&#10;  UCHAR                  Flags;&#10;  UCHAR                  Control;&#10;  union {&#10;    struct {&#10;      PIO_SECURITY_CONTEXT     SecurityContext;&#10;      ULONG                    Options;&#10;      USHORT POINTER_ALIGNMENT FileAttributes;&#10;      USHORT                   ShareAccess;&#10;      ULONG POINTER_ALIGNMENT  EaLength;&#10;    } Create;&#10;    struct {&#10;      PIO_SECURITY_CONTEXT          SecurityContext;&#10;      ULONG                         Options;&#10;      USHORT POINTER_ALIGNMENT      Reserved;&#10;      USHORT                        ShareAccess;&#10;      PNAMED_PIPE_CREATE_PARAMETERS Parameters;&#10;    } CreatePipe;&#10;...">IO_STACK_LOCATION</a>) is set to the size in bytes of the input buffer that is pointed to by the <strong>AssociatedIrp.SystemBuffer</strong> member. This size must be greater than or equal to <strong>sizeof</strong>(<strong><a href="pmi_event" title="typedef struct _PMI_EVENT {&#10;  ULONG          Version;&#10;  PMI_EVENT_TYPE EventType;&#10;} PMI_EVENT, *PPMI_EVENT;">PMI_EVENT</a></strong>) or the request will fail with an error status of STATUS_BUFFER_TOO_SMALL.</p>

<h3>Output buffer</h3>

<p>None.</p>

<h3>Output buffer length</h3>

<p>None.</p>

<h3>Input/output buffer</h3>

<h3>Input/output buffer length</h3>

<h3>Status block</h3>

<p>The <strong>Information</strong> member is set to the size, in bytes, of a <a href="pmi_event" title="typedef struct _PMI_EVENT {&#10;  ULONG          Version;&#10;  PMI_EVENT_TYPE EventType;&#10;} PMI_EVENT, *PPMI_EVENT;">PMI_EVENT</a> structure.</p>

<p>The <strong>Status</strong> member is set to one of the following values:</p>

<p><strong>STATUS_BUFFER_TOO_SMALL</strong></p>

<p>The <strong>Parameters.DeviceIoControl.OutputBufferLength</strong> member of the <a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a> is less than the size, in bytes, of a <a href="pmi_event" title="typedef struct _PMI_EVENT {&#10;  ULONG          Version;&#10;  PMI_EVENT_TYPE EventType;&#10;} PMI_EVENT, *PPMI_EVENT;">PMI_EVENT</a> structure.</p>

<p><strong>STATUS_PENDING</strong></p>

<p>The WDM driver that supports the PMI interface has put the IOCTL request in a queue and will complete it after a PMI event occurs.</p>

<p><strong><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></strong></p>

<p>The WDM driver that supports the PMI interface has completed the IOCTL request successfully.</p>

<h2>Remarks</h2>

<p>PMI creates an event notification queue for each initiator that opens the device instance for a power meter by using the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fileapi/nf-fileapi-createfilea">CreateFile</a> function. A separate queue is created for each caller's connection to a device instance. The following points apply to the event notification queue:</p>

<ul>
<li>When PMI creates the event notification queue, the queue is empty. After the queue is created, PMI sends events to the caller after the caller has registered for event notification by using the <strong>IOCTL_PMI_REGISTER_EVENT_NOTIFY</strong> request.</li>
<li>If the event notification queue is empty when the caller registers, the <strong>IOCTL_PMI_REGISTER_EVENT_NOTIFY</strong> request remains pending until either an event occurs or the device instance connection is broken through the <strong>CloseFile</strong> function.</li>
<li>After the event notification queue is created, the queue will contain unsent events for the caller. This prevents callers from missing events during the interval between when the driver processes one event and the caller registers for another. If there are events in the caller's queue, they are sent immediately after the caller registers by using an <strong>IOCTL_PMI_REGISTER_EVENT_NOTIFY</strong> request.</li>
</ul>

<p>When PMI sends a power meter event to the caller, it completes the <strong>IOCTL_PMI_REGISTER_EVENT_NOTIFY</strong> request. The data that describes the event is contained within the <a href="pmi_event" title="typedef struct _PMI_EVENT {&#10;  ULONG          Version;&#10;  PMI_EVENT_TYPE EventType;&#10;} PMI_EVENT, *PPMI_EVENT;">PMI_EVENT</a> structure in the output buffer that is referenced by the <strong>MdlAddress</strong> member of the <a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a>. The <strong>EventType</strong> member of this structure contains information about the power meter event's type. For example, if <strong>EventType</strong> is set to <strong>PmiConfigurationChangedEvent</strong>, the power meter's configuration has changed. In this case, the caller can query the power meter's new configuration by using an <a href="ioctl_pmi_get_configuration" title="// CTL_CODE(0x0045, 0x001, METHOD_BUFFERED, FILE_READ_ACCESS)&#10;#define IOCTL_PMI_GET_CONFIGURATION 0x00454004">IOCTL_PMI_GET_CONFIGURATION</a> request.</p>

<p>For more information about the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fileapi/nf-fileapi-createfilea">CreateFile</a> and <strong>CloseFile</strong> functions, refer to the Windows SDK documentation.</p>

<h2>See also</h2>

<p><a href="ioctl_pmi_get_configuration" title="// CTL_CODE(0x0045, 0x001, METHOD_BUFFERED, FILE_READ_ACCESS)&#10;#define IOCTL_PMI_GET_CONFIGURATION 0x00454004">IOCTL_PMI_GET_CONFIGURATION</a></p>

<p><a href="io_stack_location" title="typedef struct _IO_STACK_LOCATION {&#10;  UCHAR                  MajorFunction;&#10;  UCHAR                  MinorFunction;&#10;  UCHAR                  Flags;&#10;  UCHAR                  Control;&#10;  union {&#10;    struct {&#10;      PIO_SECURITY_CONTEXT     SecurityContext;&#10;      ULONG                    Options;&#10;      USHORT POINTER_ALIGNMENT FileAttributes;&#10;      USHORT                   ShareAccess;&#10;      ULONG POINTER_ALIGNMENT  EaLength;&#10;    } Create;&#10;    struct {&#10;      PIO_SECURITY_CONTEXT          SecurityContext;&#10;      ULONG                         Options;&#10;      USHORT POINTER_ALIGNMENT      Reserved;&#10;      USHORT                        ShareAccess;&#10;      PNAMED_PIPE_CREATE_PARAMETERS Parameters;&#10;    } CreatePipe;&#10;...">IO_STACK_LOCATION</a></p>

<p><a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a></p>

<p><a href="pmi_event" title="typedef struct _PMI_EVENT {&#10;  ULONG          Version;&#10;  PMI_EVENT_TYPE EventType;&#10;} PMI_EVENT, *PPMI_EVENT;">PMI_EVENT</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/pmi/ni-pmi-ioctl_pmi_register_event_notify">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/pmi/ni-pmi-ioctl_pmi_register_event_notify.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
