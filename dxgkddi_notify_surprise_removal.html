<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="DXGKDDI_NOTIFY_SURPRISE_REMOVAL - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>DXGKDDI_NOTIFY_SURPRISE_REMOVAL - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            DXGKDDI_NOTIFY_SURPRISE_REMOVAL - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// dispmprt.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">DXGKDDI_NOTIFY_SURPRISE_REMOVAL DxgkddiNotifySurpriseRemoval;

<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> DxgkddiNotifySurpriseRemoval(
  [in] PVOID MiniportDeviceContext,
  [in] <a href="dxgk_surprise_removal_type" title="typedef enum _DXGK_SURPRISE_REMOVAL_TYPE {&#10;  DxgkRemovalHibernation,&#10;  DxgkRemovalPnPNotify&#10;} DXGK_SURPRISE_REMOVAL_TYPE;">DXGK_SURPRISE_REMOVAL_TYPE</a> RemovalType
)
{...}</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/dispmprt/nc-dispmprt-dxgkddi_notify_surprise_removal">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/dxgkddi_notify_surprise_removal.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nc-dispmprt-dxgkddi_notify_surprise_removal)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="dxgkddi_notify_surprise_removal-callback-function">DXGKDDI_NOTIFY_SURPRISE_REMOVAL callback function</h1>

<h2 id="description">Description</h2>

<p><strong>DXGKDDI_NOTIFY_SURPRISE_REMOVAL</strong> is called by the operating system when a user disconnects an external display device without notifying the system.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="miniportdevicecontext-in"><code>MiniportDeviceContext</code> [in]</h3>

<p>A handle to a context block associated with a display adapter. The display miniport driver's <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/dispmprt/nc-dispmprt-dxgkddi_add_device"><strong>DxgkDdiAddDevice</strong></a> function previously provided this handle to the DirectX graphics kernel subsystem.</p>

<h3 id="removaltype-in"><code>RemovalType</code> [in]</h3>

<p>A value of type <strong><a href="dxgk_surprise_removal_type" title="typedef enum _DXGK_SURPRISE_REMOVAL_TYPE {&#10;  DxgkRemovalHibernation,&#10;  DxgkRemovalPnPNotify&#10;} DXGK_SURPRISE_REMOVAL_TYPE;">DXGK_SURPRISE_REMOVAL_TYPE</a></strong> that identifies the type of surprise removal event.</p>

<h2 id="return-value">Return value</h2>

<p>Returns <strong><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></strong> if software resources were cleaned up for <strong>RemovalType</strong> = <strong>DxgkRemovalHibernation</strong>. If the driver instead returns an error code, the operating system will attempt to reboot the system, as described in the following Remarks section.</p>

<h2 id="remarks">Remarks</h2>

<p>This callback can be optionally be implemented by Windows Display Driver Model (WDDM) 1.2 and later display miniport drivers.</p>

<blockquote>
  <p>[!NOTE]</p>
  
  <p>The operating system calls <strong>DxgkDdiNotifySurpriseRemoval</strong> only if the display miniport driver indicates support by setting the <strong>SupportSurpriseRemovalInHibernation</strong> member of the <strong><a href="dxgk_drivercaps" title="typedef struct _DXGK_DRIVERCAPS {&#10;  [out] PHYSICAL_ADDRESS                   HighestAcceptableAddress;&#10;  [out] UINT                               MaxAllocationListSlotId;&#10;  [out] SIZE_T                             ApertureSegmentCommitLimit;&#10;  [out] UINT                               MaxPointerWidth;&#10;  [out] UINT                               MaxPointerHeight;&#10;  [out] DXGK_POINTERFLAGS                  PointerCaps;&#10;  [out] UINT                               InterruptMessageNumber;&#10;  [out] UINT                               NumberOfSwizzlingRanges;&#10;  [out] UINT                               MaxOverlays;&#10;  union {&#10;    [out] DXGK_GAMMARAMPCAPS      GammaRampCaps;&#10;    [out] DXGK_COLORTRANSFORMCAPS ColorTransformCaps;&#10;  };&#10;  [out] DXGK_PRESENTATIONCAPS              PresentationCaps;&#10;  [out] UINT                               MaxQueuedFlipOnVSync;&#10;  [out] DXGK_FLIPCAPS                      FlipCaps;&#10;  [out] DXGK_VIDSCHCAPS                    SchedulingCaps;&#10;  [out] DXGK_VIDMMCAPS                     MemoryManagementCaps;&#10;  [out] DXGK_GPUENGINETOPOLOGY             GpuEngineTopology;&#10;...">DXGK_DRIVERCAPS</a></strong> structure to 1.</p>
</blockquote>

<p>When the OS detects a surprise removal, it notifies the driver as quickly as possible. <strong>DxgkDdiNotifySurpriseRemoval</strong> is a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/display/threading-and-synchronization-zero-level">level zero</a> DDI function, which means that it can be called when a driver has pending GPU workload and/or is running inside other DDI functions. Since a call to this function indicates the graphics hardware has been physically removed or has disappeared from system, any further attempt to access hardware might cause problems such as a hard hang.</p>

<p>The OS categorizes surprise removal as follows:</p>

<ul>
<li><p>The surprise removal occurs when the system and graphics device are in a low-power state, such as sleep or hibernation. When the OS resumes from the low power state, it detects this surprise removal and immediately calls the driver's <strong>DxgkDdiNotifySurpriseRemoval</strong> callback with <strong>RemovalType = DxgkRemovalHibernation</strong>. There will not likely any pending GPU work or DDI calls in this case, so it should be relatively safe and easy for the driver to handle. Return status details are as follows:</p>

<ul>
<li>The OS expects the driver to handle the <strong>DxgkDdiNotifySurpriseRemoval</strong> call correctly and return <strong><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></strong>.</li>
<li>If the removed graphics device is the power-on self-test (POST) device, the OS will try to reboot the system gracefully regardless of the returned status.</li>
<li>For a non-POST device, if the driver fails the call and only supports <strong>SupportSurpriseRemovalInHibernation</strong> in its <strong><a href="dxgk_drivercaps" title="typedef struct _DXGK_DRIVERCAPS {&#10;  [out] PHYSICAL_ADDRESS                   HighestAcceptableAddress;&#10;  [out] UINT                               MaxAllocationListSlotId;&#10;  [out] SIZE_T                             ApertureSegmentCommitLimit;&#10;  [out] UINT                               MaxPointerWidth;&#10;  [out] UINT                               MaxPointerHeight;&#10;  [out] DXGK_POINTERFLAGS                  PointerCaps;&#10;  [out] UINT                               InterruptMessageNumber;&#10;  [out] UINT                               NumberOfSwizzlingRanges;&#10;  [out] UINT                               MaxOverlays;&#10;  union {&#10;    [out] DXGK_GAMMARAMPCAPS      GammaRampCaps;&#10;    [out] DXGK_COLORTRANSFORMCAPS ColorTransformCaps;&#10;  };&#10;  [out] DXGK_PRESENTATIONCAPS              PresentationCaps;&#10;  [out] UINT                               MaxQueuedFlipOnVSync;&#10;  [out] DXGK_FLIPCAPS                      FlipCaps;&#10;  [out] DXGK_VIDSCHCAPS                    SchedulingCaps;&#10;  [out] DXGK_VIDMMCAPS                     MemoryManagementCaps;&#10;  [out] DXGK_GPUENGINETOPOLOGY             GpuEngineTopology;&#10;...">DXGK_DRIVERCAPS</a></strong>, the OS will reboot the system gracefully. If it supports <strong>SupportSurpriseRemoval</strong> in <strong><a href="dxgk_drivercaps" title="typedef struct _DXGK_DRIVERCAPS {&#10;  [out] PHYSICAL_ADDRESS                   HighestAcceptableAddress;&#10;  [out] UINT                               MaxAllocationListSlotId;&#10;  [out] SIZE_T                             ApertureSegmentCommitLimit;&#10;  [out] UINT                               MaxPointerWidth;&#10;  [out] UINT                               MaxPointerHeight;&#10;  [out] DXGK_POINTERFLAGS                  PointerCaps;&#10;  [out] UINT                               InterruptMessageNumber;&#10;  [out] UINT                               NumberOfSwizzlingRanges;&#10;  [out] UINT                               MaxOverlays;&#10;  union {&#10;    [out] DXGK_GAMMARAMPCAPS      GammaRampCaps;&#10;    [out] DXGK_COLORTRANSFORMCAPS ColorTransformCaps;&#10;  };&#10;  [out] DXGK_PRESENTATIONCAPS              PresentationCaps;&#10;  [out] UINT                               MaxQueuedFlipOnVSync;&#10;  [out] DXGK_FLIPCAPS                      FlipCaps;&#10;  [out] DXGK_VIDSCHCAPS                    SchedulingCaps;&#10;  [out] DXGK_VIDMMCAPS                     MemoryManagementCaps;&#10;  [out] DXGK_GPUENGINETOPOLOGY             GpuEngineTopology;&#10;...">DXGK_DRIVERCAPS</a></strong>, the OS will ignore the return status and continue stopping the graphics device. See additional return notes below.</li>
</ul></li>
<li><p>The graphics device is surprise removed/unplugged when it is still running. When the OS detects this type of surprise removal, it immediately calls the driver's <strong>DxgkDdiNotifySurpriseRemoval</strong> callback with <strong>RemovalType = DxgkRemovalPnPNotify</strong>. There might still be some pending GPU work or DDI calls to complete in this case. When the driver receives this notification and can handle this surprise removal, the driver should immediately mark this device as surprise removal in its own device context to avoid any hardware access and then return <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> back to the OS. The OS will continue calling other DDI functions to clean up the resources and stop the graphics device. As noted below, the driver should only release or clean up the software resources and must not touch or access any hardware in these DDI calls. If the driver cannot handle this surprise removal, it should return a proper failure to the OS. For any failure, the OS will bugcheck the system immediately to avoid any further hardware or data damage.</p></li>
</ul>

<p>If the display miniport driver returns <strong><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></strong>, the DirectX graphics kernel subsystem will continue to remove the external display adapter from the graphics stack and will call other driver-implemented <em>DxgkDdiXxx</em> kernel-mode functions to release all resources. In this case, the driver must complete its cleanup of software resources in response to calls from the operating system but must not touch or clean any hardware settings. If no other hardware is using the driver, the operating system will unload the driver.</p>

<p>If the driver returns an error code, does not set <strong><a href="dxgk_drivercaps" title="typedef struct _DXGK_DRIVERCAPS {&#10;  [out] PHYSICAL_ADDRESS                   HighestAcceptableAddress;&#10;  [out] UINT                               MaxAllocationListSlotId;&#10;  [out] SIZE_T                             ApertureSegmentCommitLimit;&#10;  [out] UINT                               MaxPointerWidth;&#10;  [out] UINT                               MaxPointerHeight;&#10;  [out] DXGK_POINTERFLAGS                  PointerCaps;&#10;  [out] UINT                               InterruptMessageNumber;&#10;  [out] UINT                               NumberOfSwizzlingRanges;&#10;  [out] UINT                               MaxOverlays;&#10;  union {&#10;    [out] DXGK_GAMMARAMPCAPS      GammaRampCaps;&#10;    [out] DXGK_COLORTRANSFORMCAPS ColorTransformCaps;&#10;  };&#10;  [out] DXGK_PRESENTATIONCAPS              PresentationCaps;&#10;  [out] UINT                               MaxQueuedFlipOnVSync;&#10;  [out] DXGK_FLIPCAPS                      FlipCaps;&#10;  [out] DXGK_VIDSCHCAPS                    SchedulingCaps;&#10;  [out] DXGK_VIDMMCAPS                     MemoryManagementCaps;&#10;  [out] DXGK_GPUENGINETOPOLOGY             GpuEngineTopology;&#10;...">DXGK_DRIVERCAPS</a></strong>.<strong>SupportSurpriseRemovalInHibernation</strong>, or does not implement this function, the DirectX graphics kernel subsystem will not call any more driver-implemented <em>DxgkDdiXxx</em> functions and will attempt to reboot the system. In this case, the resource that was allocated before the external display device was disconnected will not be released.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/display/d3dkmt-wddm-1-2-caps"><strong>D3DKMT_WDDM_1_2_CAPS</strong></a></p>

<p><strong><a href="dxgk_drivercaps" title="typedef struct _DXGK_DRIVERCAPS {&#10;  [out] PHYSICAL_ADDRESS                   HighestAcceptableAddress;&#10;  [out] UINT                               MaxAllocationListSlotId;&#10;  [out] SIZE_T                             ApertureSegmentCommitLimit;&#10;  [out] UINT                               MaxPointerWidth;&#10;  [out] UINT                               MaxPointerHeight;&#10;  [out] DXGK_POINTERFLAGS                  PointerCaps;&#10;  [out] UINT                               InterruptMessageNumber;&#10;  [out] UINT                               NumberOfSwizzlingRanges;&#10;  [out] UINT                               MaxOverlays;&#10;  union {&#10;    [out] DXGK_GAMMARAMPCAPS      GammaRampCaps;&#10;    [out] DXGK_COLORTRANSFORMCAPS ColorTransformCaps;&#10;  };&#10;  [out] DXGK_PRESENTATIONCAPS              PresentationCaps;&#10;  [out] UINT                               MaxQueuedFlipOnVSync;&#10;  [out] DXGK_FLIPCAPS                      FlipCaps;&#10;  [out] DXGK_VIDSCHCAPS                    SchedulingCaps;&#10;  [out] DXGK_VIDMMCAPS                     MemoryManagementCaps;&#10;  [out] DXGK_GPUENGINETOPOLOGY             GpuEngineTopology;&#10;...">DXGK_DRIVERCAPS</a></strong></p>

<p><strong><a href="dxgk_surprise_removal_type" title="typedef enum _DXGK_SURPRISE_REMOVAL_TYPE {&#10;  DxgkRemovalHibernation,&#10;  DxgkRemovalPnPNotify&#10;} DXGK_SURPRISE_REMOVAL_TYPE;">DXGK_SURPRISE_REMOVAL_TYPE</a></strong></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/dispmprt/nc-dispmprt-dxgkddi_add_device"><strong>DxgkDdiAddDevice</strong></a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/dispmprt/nc-dispmprt-dxgkddi_notify_surprise_removal">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/dispmprt/nc-dispmprt-dxgkddi_notify_surprise_removal.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
