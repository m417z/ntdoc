<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="PFNKSALLOCATOR - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>PFNKSALLOCATOR - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            PFNKSALLOCATOR - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ks.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">PFNKSALLOCATOR Pfnksallocator;

<a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> Pfnksallocator(
  [in] PIRP Irp,
  [in] <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> BufferSize,
  [in] BOOLEAN InputOperation
)
{...}</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ks/nc-ks-pfnksallocator">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/pfnksallocator.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nc-ks-pfnksallocator)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="pfnksallocator-callback-function">PFNKSALLOCATOR callback function</h1>

<h2 id="description">Description</h2>

<p>Minidrivers can optionally supply a callback function of type <strong>PFNKSALLOCATOR</strong> as a parameter in calls to <a href="ksenableeventwithallocator" title="KSDDKAPI NTSTATUS KsEnableEventWithAllocator(&#10;  [in]           PIRP              Irp,&#10;  [in]           ULONG             EventSetsCount,&#10;  [in]           const KSEVENT_SET *EventSet,&#10;  [in, out]      PLIST_ENTRY       EventsList,&#10;  [in, optional] KSEVENTS_LOCKTYPE EventsFlags,&#10;  [in, optional] PVOID             EventsLock,&#10;  [in, optional] PFNKSALLOCATOR    Allocator,&#10;  [in, optional] ULONG             EventItemSize&#10;);">KsEnableEventWithAllocator</a>, <a href="kspropertyhandlerwithallocator" title="KSDDKAPI NTSTATUS KsPropertyHandlerWithAllocator(&#10;  [in]           PIRP                 Irp,&#10;  [in]           ULONG                PropertySetsCount,&#10;  [in]           const KSPROPERTY_SET *PropertySet,&#10;  [in, optional] PFNKSALLOCATOR       Allocator,&#10;  [in, optional] ULONG                PropertyItemSize&#10;);">KsPropertyHandlerWithAllocator</a>, and <a href="ksmethodhandlerwithallocator" title="KSDDKAPI NTSTATUS KsMethodHandlerWithAllocator(&#10;  [in]           PIRP               Irp,&#10;  [in]           ULONG              MethodSetsCount,&#10;  [in]           const KSMETHOD_SET *MethodSet,&#10;  [in, optional] PFNKSALLOCATOR     Allocator,&#10;  [in, optional] ULONG              MethodItemSize&#10;);">KsMethodHandlerWithAllocator</a>.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="irp-in"><code>Irp</code> [in]</h3>

<p>Specifies the <a href="irp" title="typedef struct _IRP {&#10;  CSHORT                    Type;&#10;  USHORT                    Size;&#10;  PMDL                      MdlAddress;&#10;  ULONG                     Flags;&#10;  union {&#10;    struct _IRP     *MasterIrp;&#10;    __volatile LONG IrpCount;&#10;    PVOID           SystemBuffer;&#10;  } AssociatedIrp;&#10;  LIST_ENTRY                ThreadListEntry;&#10;  IO_STATUS_BLOCK           IoStatus;&#10;  KPROCESSOR_MODE           RequestorMode;&#10;  BOOLEAN                   PendingReturned;&#10;  CHAR                      StackCount;&#10;  CHAR                      CurrentLocation;&#10;  BOOLEAN                   Cancel;&#10;  KIRQL                     CancelIrql;&#10;  CCHAR                     ApcEnvironment;&#10;  UCHAR                     AllocationFlags;&#10;...">IRP</a> for which the buffer allocation request is being made.</p>

<h3 id="buffersize-in"><code>BufferSize</code> [in]</h3>

<p>Specifies the size of buffer needed. This size covers all parameters in the request.</p>

<h3 id="inputoperation-in"><code>InputOperation</code> [in]</h3>

<p>Set to <strong>TRUE</strong> if this is an input operation, meaning that on successful return, the Irp->IoStatus.Information field will contain the number of bytes to copy back to the original input buffer.</p>

<h2 id="return-value">Return value</h2>

<p>Returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the request is handled. Otherwise returns an appropriate error code.</p>

<h2 id="remarks">Remarks</h2>

<p>Typically, pool memory is used for buffer allocations. This enables filters that pass event, property, and method queries directly to hardware to avoid extra data copies by allowing them to provide the buffer into which such data is placed by the standard handling functions. So, a filter may have memory blocks that have already been mapped to an adapter from which buffer allocations can occur.</p>

<p>Since this memory presumably is not typical pool-allocated memory, the filter must perform buffer cleanup on completion of the Irp. This means that for input operations from usermode that are not synchronous, the allocator must allocate an <a href="mdl" title="typedef struct _MDL {&#10;  struct _MDL      *Next;&#10;  CSHORT           Size;&#10;  CSHORT           MdlFlags;&#10;  struct _EPROCESS *Process;&#10;  PVOID            MappedSystemVa;&#10;  PVOID            StartVa;&#10;  ULONG            ByteCount;&#10;  ULONG            ByteOffset;&#10;} MDL, *PMDL;">MDL</a> for the destination buffer, probe and lock it, and retrieve a system address. This must be done in order to enable copying of the return data to the original buffer.</p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ks/nc-ks-pfnksallocator">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ks/nc-ks-pfnksallocator.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
