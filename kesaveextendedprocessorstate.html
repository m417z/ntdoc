<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="KeSaveExtendedProcessorState - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>KeSaveExtendedProcessorState - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            KeSaveExtendedProcessorState - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> KeSaveExtendedProcessorState(
  [in]  <a href="ulong64" title="typedef unsigned __int64 ULONG64;">ULONG64</a>      Mask,
  [out] PXSTATE_SAVE XStateSave
);</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kesaveextendedprocessorstate">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/kesaveextendedprocessorstate.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdm-kesaveextendedprocessorstate)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1>KeSaveExtendedProcessorState function</h1>
<h2>Description</h2>
<p>The <strong>KeSaveExtendedProcessorState</strong> routine saves extended processor state information.</p>
<h2>Parameters</h2>
<h3><code>Mask</code> [in]</h3>
<p>A 64-bit feature mask. The bits in this mask identify the extended processor feature states to save. If a mask bit is one, the routine saves the state of the feature that is identified by this bit. If a mask bit is zero, the state for the corresponding feature is not saved. This mask must not identify extended processor features that the operating system has not enabled. To obtain a mask of the enabled features, call the <a href="rtlgetenabledextendedfeatures" title="NTSYSAPI&#10;ULONG64&#10;NTAPI&#10;RtlGetEnabledExtendedFeatures(&#10;    _In_ ULONG64 FeatureMask&#10;    );">RtlGetEnabledExtendedFeatures</a> routine.</p>
<p>A caller can set this parameter to the bitwise OR of one or more of the following <strong>XSTATE_MASK_*XXX</strong>* flag bits:</p>
<table>
<thead>
<tr>
  <th>Value</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>XSTATE_MASK_LEGACY_FLOATING_POINT</strong></td>
  <td>The floating-point extension (x87/MMX).</td>
</tr>
<tr>
  <td><strong>XSTATE_MASK_LEGACY_SSE</strong></td>
  <td>The streaming SIMD extension (SSE).</td>
</tr>
<tr>
  <td><strong>XSTATE_MASK_LEGACY</strong></td>
  <td>Both the x87/MMX and SSE extensions.</td>
</tr>
<tr>
  <td><strong>XSTATE_MASK_GSSE</strong></td>
  <td>The Intel Sandy Bridge (formerly Gesher) SSE extension.</td>
</tr>
<tr>
  <td><strong>XSTATE_MASK_AVX512</strong></td>
  <td>AVX-512 extension</td>
</tr>
<tr>
  <td><strong>XSTATE_MASK_MPX</strong></td>
  <td>MPX extension</td>
</tr>
<tr>
  <td><strong>XSTATE_MASK_AMX_TILE_CONFIG</strong></td>
  <td>AMX extension (configuration)</td>
</tr>
<tr>
  <td><strong>XSTATE_MASK_AMX_TILE_DATA</strong></td>
  <td>AMX extension (data)</td>
</tr>
</tbody>
</table>
<h3><code>XStateSave</code> [out]</h3>
<p>A pointer to a caller-allocated buffer into which the routine writes an <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/eprocess">XSTATE_SAVE</a> structure. This structure contains the saved state information for the extended processor features indicated by the <em>Mask</em> parameter. The buffer must be large enough to contain this structure.</p>
<h2>Return value</h2>
<p><strong>KeSaveExtendedProcessorState</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> if the call is successful. Possible error return values include the following:</p>
<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>STATUS_INSUFFICIENT_RESOURCES</strong></td>
  <td>A memory allocation operation failed.</td>
</tr>
</tbody>
</table>
<h2>Remarks</h2>
<p>On x86-based processors that support the XSAVE and XRSTOR instructions, these instructions provide a flexible mechanism to save and restore extended processor state information. <strong>KeSaveExtendedProcessorState</strong> uses these instructions if they are available.</p>
<p>To restore the extended processor state that was saved by <strong>KeSaveExtendedProcessorState</strong>, call the <a href="kerestoreextendedprocessorstate" title="VOID KeRestoreExtendedProcessorState(&#10;  [in] PXSTATE_SAVE XStateSave&#10;);">KeRestoreExtendedProcessorState</a> routine.</p>
<p>The <em>Mask</em> parameter specifies the extended processor features whose state is to be saved. A <strong><a href="kerestoreextendedprocessorstate" title="VOID KeRestoreExtendedProcessorState(&#10;  [in] PXSTATE_SAVE XStateSave&#10;);">KeRestoreExtendedProcessorState</a></strong> call restores only the extended processor state that was saved by the <strong>KeSaveExtendedProcessorState</strong> call that saved the state.</p>
<p>Kernel-mode code must save the state of an extended processor feature before it uses that feature, and it must restore the state before it exits.</p>
<p>Interrupt service routines (ISRs) run under severe time constraints that typically prevent them from using extended processor features. However, an ISR can schedule a deferred procedure call (DPC) that uses one or more extended processor features. The DPC routine must save and restore the state of the extended features to preserve the context of the interrupted program in whose process address space the routine runs.</p>
<p>The <a href="kesavefloatingpointstate" title="NTSTATUS KeSaveFloatingPointState(&#10;  [out] PKFLOATING_SAVE FloatSave&#10;);">KeSaveFloatingPointState</a> and <a href="kerestorefloatingpointstate" title="NTSTATUS KeRestoreFloatingPointState(&#10;  [in] PKFLOATING_SAVE FloatSave&#10;);">KeRestoreFloatingPointState</a> routines save and restore just the floating-point state (the x87/MMX registers) and the SSE state.</p>
<h2>See also</h2>
<p><a href="kerestoreextendedprocessorstate" title="VOID KeRestoreExtendedProcessorState(&#10;  [in] PXSTATE_SAVE XStateSave&#10;);">KeRestoreExtendedProcessorState</a></p>
<p><a href="kerestorefloatingpointstate" title="NTSTATUS KeRestoreFloatingPointState(&#10;  [in] PKFLOATING_SAVE FloatSave&#10;);">KeRestoreFloatingPointState</a></p>
<p><a href="kesavefloatingpointstate" title="NTSTATUS KeSaveFloatingPointState(&#10;  [out] PKFLOATING_SAVE FloatSave&#10;);">KeSaveFloatingPointState</a></p>
<p><a href="rtlgetenabledextendedfeatures" title="NTSYSAPI&#10;ULONG64&#10;NTAPI&#10;RtlGetEnabledExtendedFeatures(&#10;    _In_ ULONG64 FeatureMask&#10;    );">RtlGetEnabledExtendedFeatures</a></p>
<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/eprocess">XSTATE_SAVE</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-kesaveextendedprocessorstate">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/nf-wdm-kesaveextendedprocessorstate.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
