<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="FwpmConnectionPolicyAdd0 - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>FwpmConnectionPolicyAdd0 - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            FwpmConnectionPolicyAdd0 - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// fwpmk.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> FwpmConnectionPolicyAdd0(
  [in]                             HANDLE                       engineHandle,
  [in]                             const FWPM_PROVIDER_CONTEXT3 *connectionPolicy,
  [in]                             FWP_IP_VERSION               ipVersion,
  [in]                             <a href="uint64" title="typedef unsigned __int64 UINT64;">UINT64</a>                       weight,
  [in]                             <a href="uint32" title="typedef unsigned int UINT32;">UINT32</a>                       numFilterConditions,
  [in, reads(numFilterConditions)] const FWPM_FILTER_CONDITION0 *filterConditions,
  [in, optional]                   PSECURITY_DESCRIPTOR         sd
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpmk/nf-fwpmk-fwpmconnectionpolicyadd0">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/fwpmconnectionpolicyadd0.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-fwpmk-fwpmconnectionpolicyadd0)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2 id="description">Description</h2>

<p>The <strong>FwpmConnectionPolicyAdd0API</strong> function configures routing policies for outbound connections.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="enginehandle-in"><code>engineHandle</code> [in]</h3>

<p>A handle to an open session with the filter engine. To open a session with the filter engine, call <strong><a href="fwpmengineopen0" title="NTSTATUS FwpmEngineOpen0(&#10;  [in, optional] const wchar_t             *serverName,&#10;  [in]           UINT32                    authnService,&#10;  [in, optional] SEC_WINNT_AUTH_IDENTITY_W *authIdentity,&#10;  [in, optional] const FWPM_SESSION0       *session,&#10;  [out]          HANDLE                    *engineHandle&#10;);">FwpmEngineOpen0</a></strong>.</p>

<h3 id="connectionpolicy-in"><code>connectionPolicy</code> [in]</h3>

<p>The state associated with a provider context.</p>

<h3 id="ipversion-in"><code>ipVersion</code> [in]</h3>

<p>IP version of the traffic.</p>

<h3 id="weight-in"><code>weight</code> [in]</h3>

<p>Specifies the weight that this Trusted Intermediary Agent (TIA) should be given compared to any peers.</p>

<h3 id="numfilterconditions-in"><code>numFilterConditions</code> [in]</h3>

<p>The number of elements in <em>filterConditions</em>.</p>

<h3 id="filterconditions-in-readsnumfilterconditions"><code>filterConditions</code> [in, reads(numFilterConditions)]</h3>

<p>A filter condition that must be true for the action to be taken.</p>

<p>Of the possible match conditions (see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/fwp/filtering-condition-identifiers-">Filtering condition identifiers</a>), the ones in the following list are supported by <strong>FwpmConnectionPolicyAdd0</strong>. Set these values in <strong>FWPM_FILTER_CONDITION0::fieldKey</strong>.</p>

<ul>
<li><strong>FWPM_CONDITION_ALE_APP_ID</strong></li>
<li><strong>FWPM_CONDITION_ALE_USER_ID</strong></li>
<li><strong>FWPM_CONDITION_IP_LOCAL_ADDRESS</strong></li>
<li><strong>FWPM_CONDITION_IP_LOCAL_ADDRESS_TYPE</strong></li>
<li><strong>FWPM_CONDITION_IP_LOCAL_PORT</strong></li>
<li><strong>FWPM_CONDITION_IP_PROTOCOL</strong></li>
<li><strong>FWPM_CONDITION_IP_REMOTE_ADDRESS</strong></li>
<li><strong>FWPM_CONDITION_IP_DESTINATION_ADDRESS_TYPE</strong></li>
<li><strong>FWPM_CONDITION_IP_REMOTE_PORT</strong></li>
<li><strong>FWPM_CONDITION_FLAGS</strong></li>
<li><strong>FWPM_CONDITION_ALE_ORIGINAL_APP_ID</strong></li>
<li><strong>FWPM_CONDITION_ALE_PACKAGE_ID</strong></li>
<li><strong>FWPM_CONDITION_COMPARTMENT_ID</strong></li>
</ul>

<h3 id="sd-in-optional"><code>sd</code> [in, optional]</h3>

<p>The security information.</p>

<h2 id="return-value">Return value</h2>

<table>
<thead>
<tr>
  <th>Return code/value</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>ERROR_SUCCESS</strong>&lt;br&gt;0</td>
  <td>The routing policy was successfully configured.</td>
</tr>
<tr>
  <td><strong>FWP_E_* error code</strong>&lt;br&gt;0x80320001—0x80320039</td>
  <td>A Windows Filtering Platform (WFP) specific error. See <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/fwp/wfp-error-codes">WFP Error Codes</a> for details.</td>
</tr>
<tr>
  <td><strong>RPC_* error code</strong>&lt;br&gt;0x80010001—0x80010122</td>
  <td>Failure to communicate with the remote or local firewall engine.</td>
</tr>
<tr>
  <td><strong>Other <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> codes</strong></td>
  <td>An error occurred.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>The TCP/IP stack supports destination address-based routing for outbound connections. FwpmConnectionPolicyAdd0API allows you to configure more expressive routing policies for outbound connections, and thereby to enable more complex scenarios such as source address-based routing, process-based routing, port-based routing, and others. A connection policy consists of an array of match conditions, an array of route settings, and an associated weight. You can configure multiple policies, and they are evaluated based on their configured weights for an outbound connection (a higher weight takes precedence). The route setting of the first policy whose conditions (ANDed) matches the outbound connection is applied.</p>

<p>These are the supported route settings (see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fwptypes/ne-fwptypes-fwp_network_connection_policy_setting_type">FWP_NETWORK_CONNECTION_POLICY_SETTING_TYPE</a>):</p>

<p><strong>FWP_NETWORK_CONNECTION_POLICY_SOURCE_ADDRESS</strong>. The source address to use for the connection. The value should be a <strong>FWP_UINT32</strong> for an IPv4 address, and a <strong>FWP_BYTE_ARRAY16_TYPE</strong> for an IPv6 address.</p>

<p><strong>FWP_NETWORK_CONNECTION_POLICY_NEXT_HOP_INTERFACE</strong>. The <a href="luid" title="typedef struct _LUID {&#10;  DWORD LowPart;&#10;  LONG  HighPart;&#10;} LUID, *PLUID;">LUID</a> of the outgoing interface to use for the connection. The value should be a <strong>FWP_UINT64</strong>.</p>

<p><strong>FWP_NETWORK_CONNECTION_POLICY_NEXT_HOP</strong>. The nexthop address (or gateway) to use for the connection. The value should be a <strong>FWP_UINT32</strong> for an IPv4 address, and a <strong>FWP_BYTE_ARRAY16_TYPE</strong> for an IPv6 address.</p>

<h2 id="see-also">See also</h2>

<ul>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fwptypes/ne-fwptypes-fwp_network_connection_policy_setting_type">FWP_NETWORK_CONNECTION_POLICY_SETTING_TYPE</a></li>
<li><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/fwp/wfp-error-codes">WFP Error Codes</a></li>
</ul>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpmk/nf-fwpmk-fwpmconnectionpolicyadd0">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/fwpmk/nf-fwpmk-fwpmconnectionpolicyadd0.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
