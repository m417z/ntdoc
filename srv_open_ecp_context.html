<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="SRV_OPEN_ECP_CONTEXT - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>SRV_OPEN_ECP_CONTEXT - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            SRV_OPEN_ECP_CONTEXT - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">typedef struct _SRV_OPEN_ECP_CONTEXT {
  <a href="unicode_string" title="typedef struct _UNICODE_STRING&#10;{&#10;    USHORT Length;&#10;    USHORT MaximumLength;&#10;    _Field_size_bytes_part_opt_(MaximumLength, Length) PWCH Buffer;&#10;} UNICODE_STRING, *PUNICODE_STRING;">PUNICODE_STRING</a>       ShareName;
  PSOCKADDR_STORAGE_NFS SocketAddress;
  BOOLEAN               OplockBlockState;
  BOOLEAN               OplockAppState;
  BOOLEAN               OplockFinalState;
  <a href="ushort" title="typedef unsigned short USHORT;">USHORT</a>                Version;
  <a href="srv_instance_type" title="typedef enum _SRV_INSTANCE_TYPE {&#10;  SrvInstanceTypeUndefined,&#10;  SrvInstanceTypePrimary,&#10;  SrvInstanceTypeCsv,&#10;  SrvInstanceTypeSBL,&#10;  SrvInstanceTypeSR,&#10;  SrvInstanceTypeVSMB&#10;} SRV_INSTANCE_TYPE, *PSRV_INSTANCE_TYPE;">SRV_INSTANCE_TYPE</a>     InstanceType;
} SRV_OPEN_ECP_CONTEXT, *PSRV_OPEN_ECP_CONTEXT;</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ns-ntifs-_srv_open_ecp_context">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/srv_open_ecp_context.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ns-ntifs-_srv_open_ecp_context)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1>_SRV_OPEN_ECP_CONTEXT structure</h1>

<h2>Description</h2>

<p>The SRV_OPEN_ECP_CONTEXT structure is used by a server to conditionally open files in response to client requests.</p>

<h2>Members</h2>

<h3><code>ShareName</code></h3>

<p>Pointer to a <a href="unicode_string" title="typedef struct _UNICODE_STRING&#10;{&#10;    USHORT Length;&#10;    USHORT MaximumLength;&#10;    _Field_size_bytes_part_opt_(MaximumLength, Length) PWCH Buffer;&#10;} UNICODE_STRING, *PUNICODE_STRING;">UNICODE_STRING</a> structure that supplies the share name for the server that contains the files to be open. This field is optional and can be NULL.</p>

<h3><code>SocketAddress</code></h3>

<p>Pointer to a <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ws2def/ns-ws2def-sockaddr_storage_lh">SOCKADDR_STORAGE</a> structure that specifies the transport address of a client computer. This client originates the open file request. This field is optional and can be a NULL.</p>

<h3><code>OplockBlockState</code></h3>

<p>A Boolean value that indicates whether the Server Message Block (SMB) server blocks the open thread that is waiting for the oplock break. <strong>TRUE</strong> indicates that the open thread is in the blocking state and <strong>FALSE</strong> otherwise.</p>

<h3><code>OplockAppState</code></h3>

<p>A Boolean value that indicates whether the SMB server requests an oplock with the current open thread. Set to <strong>TRUE</strong> to request the oplock and <strong>FALSE</strong> otherwise.</p>

<h3><code>OplockFinalState</code></h3>

<p>A Boolean value that indicates whether a file-open operation is the final file-open operation to request the oplock. <strong>TRUE</strong> indicates the final file-open operation to obtain the oplock and <strong>FALSE</strong> indicates otherwise.</p>

<h3><code>Version</code></h3>

<p>Version of this structure. This member was added in Windows 10 version 1703, so before trying to access it you must first check to see if it exists. If the structure size is &gt;= <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/debugger/c---numbers-and-operators">RTL_SIZEOF_THROUGH_FIELD</a>(SRV_OPEN_ECP_CONTEXT, Version), you can access this field. This member can be currently be set to SRV_OPEN_ECP_CONTEXT_VERSION_2.</p>

<h3><code>InstanceType</code></h3>

<p>The <a href="srv_instance_type" title="typedef enum _SRV_INSTANCE_TYPE {&#10;  SrvInstanceTypeUndefined,&#10;  SrvInstanceTypePrimary,&#10;  SrvInstanceTypeCsv,&#10;  SrvInstanceTypeSBL,&#10;  SrvInstanceTypeSR,&#10;  SrvInstanceTypeVSMB&#10;} SRV_INSTANCE_TYPE, *PSRV_INSTANCE_TYPE;">SRV_INSTANCE_TYPE</a> that the open is coming from. File system minifilters that attach to NTFS or ReFS used by CSVFS can use this field to detect if this open is bypassing CSVFS. If the open goes through CSVFS, then this ECP is either absent or the instance type is SrvInstanceTypeCsv. If the open is bypassing CSVFS and goes directly to the hidden volume, then <strong>InstanceType</strong> is SrvInstanceTypePrimary. The <strong>InstanceType</strong> field is present only if <strong>Version</strong> is &gt;= SRV_OPEN_ECP_CONTEXT_VERSION_2.</p>

<h2>Remarks</h2>

<p>The file-system stack can determine whether SRV_OPEN_ECP_CONTEXT is attached to the create file request. The file-system stack can then use the information in SRV_OPEN_ECP_CONTEXT to determine which client requested that the file be opened, and why it requested it. For information about how to retrieve the SRV_OPEN_ECP_CONTEXT extra information that is attached to a create file request, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ifs/using-ecps-to-process-irp-mj-create-operations-in-a-file-system-minifilter">Retrieving ECPs</a>.</p>

<p>The SRV_OPEN_ECP_CONTEXT structure is read-only. You should use it to retrieve information about a server open ECP only. For more information about this issue, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ifs/system-defined-ecps">System-Defined ECPs</a>.</p>

<p>The oplock state values (<strong>OplockBlockState</strong>, <strong>OplockAppState</strong>, and <strong>OplockFinalState</strong>) are used with oplock breaking logic for system management for SMB and SMB2.</p>

<h2>See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ws2def/ns-ws2def-sockaddr_storage_lh">SOCKADDR_STORAGE</a></p>

<p><a href="srv_instance_type" title="typedef enum _SRV_INSTANCE_TYPE {&#10;  SrvInstanceTypeUndefined,&#10;  SrvInstanceTypePrimary,&#10;  SrvInstanceTypeCsv,&#10;  SrvInstanceTypeSBL,&#10;  SrvInstanceTypeSR,&#10;  SrvInstanceTypeVSMB&#10;} SRV_INSTANCE_TYPE, *PSRV_INSTANCE_TYPE;">SRV_INSTANCE_TYPE</a></p>

<p><a href="unicode_string" title="typedef struct _UNICODE_STRING&#10;{&#10;    USHORT Length;&#10;    USHORT MaximumLength;&#10;    _Field_size_bytes_part_opt_(MaximumLength, Length) PWCH Buffer;&#10;} UNICODE_STRING, *PUNICODE_STRING;">UNICODE_STRING</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/ns-ntifs-_srv_open_ecp_context">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/ns-ntifs-_srv_open_ecp_context.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
