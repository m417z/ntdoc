<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="PoRegisterPowerSettingCallback - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>PoRegisterPowerSettingCallback - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            PoRegisterPowerSettingCallback - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// ntifs.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> PoRegisterPowerSettingCallback(
  [in, optional] <a href="device_object" title="typedef struct _DEVICE_OBJECT {&#10;  CSHORT                   Type;&#10;  USHORT                   Size;&#10;  LONG                     ReferenceCount;&#10;  struct _DRIVER_OBJECT    *DriverObject;&#10;  struct _DEVICE_OBJECT    *NextDevice;&#10;  struct _DEVICE_OBJECT    *AttachedDevice;&#10;  struct _IRP              *CurrentIrp;&#10;  PIO_TIMER                Timer;&#10;  ULONG                    Flags;&#10;  ULONG                    Characteristics;&#10;  __volatile PVPB          Vpb;&#10;  PVOID                    DeviceExtension;&#10;  DEVICE_TYPE              DeviceType;&#10;  CCHAR                    StackSize;&#10;  union {&#10;    LIST_ENTRY         ListEntry;&#10;    WAIT_CONTEXT_BLOCK Wcb;&#10;  } Queue;&#10;  ULONG                    AlignmentRequirement;&#10;...">PDEVICE_OBJECT</a>          DeviceObject,
  [in]           LPCGUID                 SettingGuid,
  [in]           PPOWER_SETTING_CALLBACK Callback,
  [in, optional] PVOID                   Context,
  [out]          PVOID                   *Handle
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-poregisterpowersettingcallback">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// wdm.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> PoRegisterPowerSettingCallback(
  [in, optional] <a href="device_object" title="typedef struct _DEVICE_OBJECT {&#10;  CSHORT                   Type;&#10;  USHORT                   Size;&#10;  LONG                     ReferenceCount;&#10;  struct _DRIVER_OBJECT    *DriverObject;&#10;  struct _DEVICE_OBJECT    *NextDevice;&#10;  struct _DEVICE_OBJECT    *AttachedDevice;&#10;  struct _IRP              *CurrentIrp;&#10;  PIO_TIMER                Timer;&#10;  ULONG                    Flags;&#10;  ULONG                    Characteristics;&#10;  __volatile PVPB          Vpb;&#10;  PVOID                    DeviceExtension;&#10;  DEVICE_TYPE              DeviceType;&#10;  CCHAR                    StackSize;&#10;  union {&#10;    LIST_ENTRY         ListEntry;&#10;    WAIT_CONTEXT_BLOCK Wcb;&#10;  } Queue;&#10;  ULONG                    AlignmentRequirement;&#10;...">PDEVICE_OBJECT</a>          DeviceObject,
  [in]           LPCGUID                 SettingGuid,
  [in]           PPOWER_SETTING_CALLBACK Callback,
  [in, optional] PVOID                   Context,
  [out]          PVOID                   *Handle
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-poregisterpowersettingcallback">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/poregisterpowersettingcallback.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-ntifs-poregisterpowersettingcallback)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="poregisterpowersettingcallback-function-ntifsh">PoRegisterPowerSettingCallback function (ntifs.h)</h1>

<h2 id="description">Description</h2>

<p>The <strong>PoRegisterPowerSettingCallback</strong> routine registers a power-setting callback routine to receive notifications of changes in the specified power setting.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="deviceobject-in-optional"><code>DeviceObject</code> [in, optional]</h3>

<p>A pointer to a <strong><a href="device_object" title="typedef struct _DEVICE_OBJECT {&#10;  CSHORT                   Type;&#10;  USHORT                   Size;&#10;  LONG                     ReferenceCount;&#10;  struct _DRIVER_OBJECT    *DriverObject;&#10;  struct _DEVICE_OBJECT    *NextDevice;&#10;  struct _DEVICE_OBJECT    *AttachedDevice;&#10;  struct _IRP              *CurrentIrp;&#10;  PIO_TIMER                Timer;&#10;  ULONG                    Flags;&#10;  ULONG                    Characteristics;&#10;  __volatile PVPB          Vpb;&#10;  PVOID                    DeviceExtension;&#10;  DEVICE_TYPE              DeviceType;&#10;  CCHAR                    StackSize;&#10;  union {&#10;    LIST_ENTRY         ListEntry;&#10;    WAIT_CONTEXT_BLOCK Wcb;&#10;  } Queue;&#10;  ULONG                    AlignmentRequirement;&#10;...">DEVICE_OBJECT</a></strong> structure that is associated with the caller of this routine. This parameter is optional. It is used internally only for debugging purposes. If this parameter is not supplied, it must be set to NULL.</p>

<h3 id="settingguid-in"><code>SettingGuid</code> [in]</h3>

<p>A pointer to the GUID that represents the power setting for this registration. When the specified power setting changes, the power manager calls the callback routine to notify the driver of the change and to supply the new value of the setting. For more information, see Remarks.</p>

<h3 id="callback-in"><code>Callback</code> [in]</h3>

<p>A pointer to a caller-implemented power-setting callback routine that the power manager calls when the specified power setting changes. For the functional prototype for the callback routine, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-poregisterpowersettingcallback#power-setting-callback">Power-Setting Callback</a>, below.</p>

<h3 id="context-in-optional"><code>Context</code> [in, optional]</h3>

<p>A pointer to the context for the callback routine. This parameter is optional. It is provided so that a driver or device context can be passed to the callback routine. If this parameter is not used, it must be set to NULL.</p>

<h3 id="handle-out"><code>Handle</code> [out]</h3>

<p>A handle that the power manager uses to represent the callback routine. A driver must subsequently supply this handle in a call to <strong><a href="pounregisterpowersettingcallback" title="NTSTATUS PoUnregisterPowerSettingCallback(&#10;  [in, out] PVOID Handle&#10;);">PoUnregisterPowerSettingCallback</a></strong> to unregister the callback routine.</p>

<h2 id="return-value">Return value</h2>

<p><strong>PoRegisterPowerSettingCallback</strong> returns one of the following:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></td>
  <td>The routine registered the callback routine.</td>
</tr>
<tr>
  <td>STATUS_ INSUFFICIENT_RESOURCES</td>
  <td>The routine could not allocate the system resources that are required to register the callback routine.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p>A driver calls <strong>PoRegisterPowerSettingCallback</strong> to register a callback routine with the power manager. The power manager subsequently calls this callback routine to notify the driver after there is a change to the specified power setting. In addition, the power manager initializes the power setting of the driver by immediately calling the callback routine and passing the current value of the power setting. The power manager initializes the power setting of the driver this way regardless of whether the power setting has actually changed.</p>

<p>A driver should call <strong>PoRegisterPowerSettingCallback</strong> for each power setting that the driver needs to monitor. Drivers should call this routine in their <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/writing-a-driverentry-routine"><strong>DriverEntry</strong></a> routine during initialization. Typically, most drivers pass a pointer to a device extension in the <strong>Context</strong> parameter.</p>

<p>To unregister a power-setting callback, call the <strong><a href="pounregisterpowersettingcallback" title="NTSTATUS PoUnregisterPowerSettingCallback(&#10;  [in, out] PVOID Handle&#10;);">PoUnregisterPowerSettingCallback</a></strong> routine.</p>

<p>Typically, Kernel-Mode Driver Framework (KMDF) drivers should call <strong>PoRegisterPowerSettingCallback</strong> from their <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdevice/nc-wdfdevice-evt_wdf_device_self_managed_io_init"><strong>EvtDeviceSelfManagedIoInit</strong></a> callback function, and should call <strong><a href="pounregisterpowersettingcallback" title="NTSTATUS PoUnregisterPowerSettingCallback(&#10;  [in, out] PVOID Handle&#10;);">PoUnregisterPowerSettingCallback</a></strong> from their <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdevice/nc-wdfdevice-evt_wdf_device_self_managed_io_cleanup"><strong>EvtDeviceSelfManagedIoCleanup</strong></a> callback function. These drivers shouldn't call <strong>PoRegisterPowerSettingCallback</strong> from their <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdriver/nc-wdfdriver-evt_wdf_driver_device_add"><strong>EvtDriverDeviceAdd</strong></a> callback function; otherwise, the power-setting callback routine might be called before the driver stack is completely built.</p>

<p>The callback routine that is registered for a particular power setting is called when a transition in power state occurs that changes the value of the setting, or when the power manager changes the value of the setting. For example, if <strong>SettingGuid</strong> points to the GUID value GUID_LIDSWITCH_STATE_CHANGE, the callback routine is called when the lid to a laptop computer clicks open or closed. The <strong>Value</strong> parameter passed to the callback routine in this example points to a <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> value that is 1 if the state of the lid switch changed from closed to open, and is 0 if the state of the lid switch changed from open to closed. For more information, see the power-setting GUID definitions and extensive comments in the Wdm.h header file.</p>

<p>The initial call to a callback routine might occur immediately, before the <strong>PoRegisterPowerSettingCallback</strong> call that registers the routine returns.</p>

<p><strong>PoRegisterPowerSettingCallback</strong> can be called only at IRQL = PASSIVE_LEVEL.</p>

<h3 id="power-setting-callback">Power-Setting Callback</h3>

<p>The function prototype of the power-setting callback routine and its parameters are as follows. The power manager calls a power-setting callback at IRQL = PASSIVE_LEVEL.</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="n"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a></span>
<span class="nf">POWER_SETTING_CALLBACK</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">_In_</span><span class="w"> </span><span class="n">LPCGUID</span><span class="w"> </span><span class="n">SettingGuid</span><span class="p">,</span>
<span class="w">  </span><span class="n">_In_</span><span class="w"> </span><span class="n">PVOID</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span>
<span class="w">  </span><span class="n">_In_</span><span class="w"> </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w"> </span><span class="n">ValueLength</span><span class="p">,</span>
<span class="w">  </span><span class="n">_Inout_opt_</span><span class="w"> </span><span class="n">PVOID</span><span class="w"> </span><span class="n">Context</span>
<span class="p">);</span>
</code></pre>
</div>

<table>
<thead>
<tr>
  <th>Parameter</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>SettingGuid</strong></td>
  <td>A pointer to a GUID that represents the power setting that changed. Power settings and their corresponding GUIDs are defined in Wdm.h.</td>
</tr>
<tr>
  <td><strong>Value</strong></td>
  <td>A pointer to the new value of the power setting that changed.</td>
</tr>
<tr>
  <td><strong>ValueLength</strong></td>
  <td>A value of type <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> that specifies the size, in bytes, of the new power setting value.</td>
</tr>
<tr>
  <td><strong>Context</strong></td>
  <td>The pointer to the context that a driver supplied in the call to <strong>PoRegisterPowerSettingCallback</strong> that registered the callback routine.</td>
</tr>
</tbody>
</table>

<h4 id="examples">Examples</h4>

<p>To define a power-setting callback routine, you must first provide a function declaration that identifies the type of callback function you’re defining. Windows provides a set of callback function types for drivers. Declaring a function using the callback function types helps <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/code-analysis-for-drivers">Code Analysis for Drivers</a>, <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/static-driver-verifier">Static Driver Verifier</a> (SDV), and other verification tools find errors, and it’s a requirement for writing drivers for the Windows operating system.</p>

<p>For example, to define a power-setting callback routine that is named <code>MyPowerSettingCallback</code>, use the POWER_SETTING_CALLBACK type as shown in this code example:</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="n">POWER_SETTING_CALLBACK</span><span class="w"> </span><span class="n">MyPowerSettingCallback</span><span class="p">;</span>
</code></pre>
</div>

<p>Then, implement your callback routine as follows:</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="n">_Use_decl_annotations_</span>
<span class="n"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a></span>
<span class="w">  </span><span class="n">MyPowerSettingCallback</span><span class="p">(</span>
<span class="w">    </span><span class="n">LPCGUID</span><span class="w"> </span><span class="n">SettingGuid</span><span class="p">,</span>
<span class="w">    </span><span class="n">PVOID</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span>
<span class="w">    </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w"> </span><span class="n">ValueLength</span><span class="p">,</span>
<span class="w">    </span><span class="n">PVOID</span><span class="w"> </span><span class="n">Context</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Function body</span>
<span class="w">  </span><span class="p">}</span>
</code></pre>
</div>

<p>The POWER_SETTING_CALLBACK function type is defined in the Wdm.h header file. To more accurately identify errors when you run the code analysis tools, be sure to add the _Use_decl_annotations_ annotation to your function definition. The _Use_decl_annotations_ annotation ensures that the annotations that are applied to the POWER_SETTING_CALLBACK function type in the header file are used. For more information about the requirements for function declarations, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/declaring-functions-using-function-role-types-for-wdm-drivers">Declaring Functions by Using Function Role Types for WDM Drivers</a>. For information about _Use_decl_annotations_, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/visualstudio/code-quality/annotating-function-behavior">Annotating Function Behavior</a>.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/kernel/writing-a-driverentry-routine"><strong>DriverEntry</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdevice/nc-wdfdevice-evt_wdf_device_self_managed_io_cleanup"><strong>EvtDeviceSelfManagedIoCleanup</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdevice/nc-wdfdevice-evt_wdf_device_self_managed_io_init"><strong>EvtDeviceSelfManagedIoInit</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdriver/nc-wdfdriver-evt_wdf_driver_device_add"><strong>EvtDriverDeviceAdd</strong></a></p>

<p><strong><a href="pounregisterpowersettingcallback" title="NTSTATUS PoUnregisterPowerSettingCallback(&#10;  [in, out] PVOID Handle&#10;);">PoUnregisterPowerSettingCallback</a></strong></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/ntifs/nf-ntifs-poregisterpowersettingcallback">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/ntifs/nf-ntifs-poregisterpowersettingcallback.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-wdm-poregisterpowersettingcallback)</h1>
</div>
<div class="ntdoc-description">
<h2>Description</h2>

<p>The <strong>PoRegisterPowerSettingCallback</strong> routine registers a power-setting callback routine to receive notifications of changes in the specified power setting.</p>

<h2>Parameters</h2>

<h3><code>DeviceObject</code> [in, optional]</h3>

<p>A pointer to a <a href="device_object" title="typedef struct _DEVICE_OBJECT {&#10;  CSHORT                   Type;&#10;  USHORT                   Size;&#10;  LONG                     ReferenceCount;&#10;  struct _DRIVER_OBJECT    *DriverObject;&#10;  struct _DEVICE_OBJECT    *NextDevice;&#10;  struct _DEVICE_OBJECT    *AttachedDevice;&#10;  struct _IRP              *CurrentIrp;&#10;  PIO_TIMER                Timer;&#10;  ULONG                    Flags;&#10;  ULONG                    Characteristics;&#10;  __volatile PVPB          Vpb;&#10;  PVOID                    DeviceExtension;&#10;  DEVICE_TYPE              DeviceType;&#10;  CCHAR                    StackSize;&#10;  union {&#10;    LIST_ENTRY         ListEntry;&#10;    WAIT_CONTEXT_BLOCK Wcb;&#10;  } Queue;&#10;  ULONG                    AlignmentRequirement;&#10;...">DEVICE_OBJECT</a> structure that is associated with the caller of this routine. This parameter is optional. It is used internally only for debugging purposes. If this parameter is not supplied, it must be set to <strong>NULL</strong>.</p>

<h3><code>SettingGuid</code> [in]</h3>

<p>A pointer to the GUID that represents the power setting for this registration. When the specified power setting changes, the power manager calls the callback routine to notify the driver of the change and to supply the new value of the setting. For more information, see Remarks.</p>

<h3><code>Callback</code> [in]</h3>

<p>A pointer to a caller-implemented power-setting callback routine that the power manager calls when the specified power setting changes. For the functional prototype for the callback routine, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/">Power-Setting Callback</a>.</p>

<h3><code>Context</code> [in, optional]</h3>

<p>A pointer to the context for the callback routine. This parameter is optional. It is provided so that a driver or device context can be passed to the callback routine. If this parameter is not used, it must be set to <strong>NULL</strong>.</p>

<h3><code>Handle</code> [out]</h3>

<p>A handle that the power manager uses to represent the callback routine. A driver must subsequently supply this handle in a call to <a href="pounregisterpowersettingcallback" title="NTSTATUS PoUnregisterPowerSettingCallback(&#10;  [in, out] PVOID Handle&#10;);">PoUnregisterPowerSettingCallback</a> to unregister the callback routine.</p>

<h2>Return value</h2>

<p><strong>PoRegisterPowerSettingCallback</strong> returns one of the following:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong><a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a></strong></td>
  <td>The routine registered the callback routine.</td>
</tr>
<tr>
  <td><strong>STATUS_INSUFFICIENT_RESOURCES</strong></td>
  <td>The routine could not allocate the system resources that are required to register the callback routine.</td>
</tr>
</tbody>
</table>

<h2>Remarks</h2>

<p>A driver calls <strong>PoRegisterPowerSettingCallback</strong> to register a callback routine with the power manager. The power manager subsequently calls this callback routine to notify the driver after there is a change to the specified power setting. In addition, the power manager initializes the power setting of the driver by immediately calling the callback routine and passing the current value of the power setting. The power manager initializes the power setting of the driver this way regardless of whether the power setting has actually changed.</p>

<p>A driver should call <strong>PoRegisterPowerSettingCallback</strong> for each power setting that the driver needs to monitor. Drivers should call this routine in their <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/storage/driverentry-of-ide-controller-minidriver">DriverEntry</a> routine during initialization. Typically, most drivers pass a pointer to a device extension in the <em>Context</em> parameter.</p>

<p>To unregister a power-setting callback, call the <a href="pounregisterpowersettingcallback" title="NTSTATUS PoUnregisterPowerSettingCallback(&#10;  [in, out] PVOID Handle&#10;);">PoUnregisterPowerSettingCallback</a> routine.</p>

<p>Typically, Kernel-Mode Driver Framework (KMDF) drivers should call <strong>PoRegisterPowerSettingCallback</strong> from their <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdevice/nc-wdfdevice-evt_wdf_device_self_managed_io_init">EvtDeviceSelfManagedIoInit</a> callback function, and should call <strong><a href="pounregisterpowersettingcallback" title="NTSTATUS PoUnregisterPowerSettingCallback(&#10;  [in, out] PVOID Handle&#10;);">PoUnregisterPowerSettingCallback</a></strong> from their <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdevice/nc-wdfdevice-evt_wdf_device_self_managed_io_cleanup">EvtDeviceSelfManagedIoCleanup</a> callback function. These drivers should not call <strong>PoRegisterPowerSettingCallback</strong> from their <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdriver/nc-wdfdriver-evt_wdf_driver_device_add">EvtDriverDeviceAdd</a> callback function; otherwise, the power-setting callback routine might be called before the driver stack is completely built.</p>

<p>The callback routine that is registered for a particular power setting is called when a transition in power state occurs that changes the value of the setting, or when the power manager changes the value of the setting. For example, if <em>SettingGuid</em> points to the GUID value GUID_LIDSWITCH_STATE_CHANGE, the callback routine is called when the lid to a laptop computer clicks open or closed. The <em>Value</em> parameter passed to the callback routine in this example points to a <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> value that is 1 if the state of the lid switch changed from closed to open, and is 0 if the state of the lid switch changed from open to closed. For more information, see the power-setting GUID definitions and extensive comments in the Wdm.h header file.</p>

<p>The initial call to a callback routine might occur immediately, before the <strong>PoRegisterPowerSettingCallback</strong> call that registers the routine returns.</p>

<p><strong>PoRegisterPowerSettingCallback</strong> can be called only at IRQL = PASSIVE_LEVEL.</p>

<h3>Power-Setting Callback</h3>

<p>The function prototype of the power-setting callback routine is as follows:</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="n"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a></span>
<span class="nf">POWER_SETTING_CALLBACK</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">_In_</span><span class="w"> </span><span class="n">LPCGUID</span><span class="w"> </span><span class="n">SettingGuid</span><span class="p">,</span>
<span class="w">  </span><span class="n">_In_</span><span class="w"> </span><span class="n">PVOID</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span>
<span class="w">  </span><span class="n">_In_</span><span class="w"> </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w"> </span><span class="n">ValueLength</span><span class="p">,</span>
<span class="w">  </span><span class="n">_Inout_opt_</span><span class="w"> </span><span class="n">PVOID</span><span class="w"> </span><span class="n">Context</span>
<span class="p">);</span>
</code></pre>
</div>

<p>The power-setting callback parameters are:</p>

<p><strong>SettingGuid</strong>
A pointer to a GUID that represents the power setting that changed. Power settings and their corresponding GUIDs are defined in Wdm.h.</p>

<p><strong>Value</strong>
A pointer to the new value of the power setting that changed.</p>

<p><strong>ValueLength</strong>
A value of type <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a> that specifies the size, in bytes, of the new power setting value.</p>

<p><strong>Context</strong>
The pointer to the context that a driver supplied in the call to <strong>PoRegisterPowerSettingCallback</strong> that registered the callback routine.</p>

<p>The power manager calls a power-setting callback at IRQL = PASSIVE_LEVEL.</p>

<h4>Examples</h4>

<p>To define a power-setting callback routine, you must first provide a function declaration that identifies the type of callback function you're defining. Windows provides a set of callback function types for drivers. Declaring a function using the callback function types helps <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/code-analysis-for-drivers">Code Analysis for Drivers</a>, <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/static-driver-verifier">Static Driver Verifier</a> (SDV), and other verification tools find errors, and it's a requirement for writing drivers for the Windows operating system.</p>

<p>For example, to define a power-setting callback routine that is named <code>MyPowerSettingCallback</code>, use the POWER_SETTING_CALLBACK type as shown in this code example:</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="n">POWER_SETTING_CALLBACK</span><span class="w"> </span><span class="n">MyPowerSettingCallback</span><span class="p">;</span>
</code></pre>
</div>

<p>Then, implement your callback routine as follows:</p>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="n">_Use_decl_annotations_</span>
<span class="n"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a></span>
<span class="w">  </span><span class="n">MyPowerSettingCallback</span><span class="p">(</span>
<span class="w">    </span><span class="n">LPCGUID</span><span class="w"> </span><span class="n">SettingGuid</span><span class="p">,</span>
<span class="w">    </span><span class="n">PVOID</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span>
<span class="w">    </span><span class="n"><a href="ulong" title="typedef unsigned long ULONG;">ULONG</a></span><span class="w"> </span><span class="n">ValueLength</span><span class="p">,</span>
<span class="w">    </span><span class="n">PVOID</span><span class="w"> </span><span class="n">Context</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Function body</span>
<span class="w">  </span><span class="p">}</span>
</code></pre>
</div>

<p>The POWER_SETTING_CALLBACK function type is defined in the Wdm.h header file. To more accurately identify errors when you run the code analysis tools, be sure to add the <code>_Use_decl_annotations_</code> annotation to your function definition. The <code>_Use_decl_annotations_</code> annotation ensures that the annotations that are applied to the POWER_SETTING_CALLBACK function type in the header file are used. For more information about the requirements for function declarations, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/devtest/declaring-functions-using-function-role-types-for-wdm-drivers">Declaring Functions by Using Function Role Types for WDM Drivers</a>. For information about <code>_Use_decl_annotations_</code>, see <a rel="noopener" target="_blank" href="https://learn.microsoft.com/visualstudio/code-quality/annotating-function-behavior">Annotating Function Behavior</a>.</p>

<h2>See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/storage/driverentry-of-ide-controller-minidriver">DriverEntry</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdevice/nc-wdfdevice-evt_wdf_device_self_managed_io_cleanup">EvtDeviceSelfManagedIoCleanup</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdevice/nc-wdfdevice-evt_wdf_device_self_managed_io_init">EvtDeviceSelfManagedIoInit</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdfdriver/nc-wdfdriver-evt_wdf_driver_device_add">EvtDriverDeviceAdd</a></p>

<p><a href="pounregisterpowersettingcallback" title="NTSTATUS PoUnregisterPowerSettingCallback(&#10;  [in, out] PVOID Handle&#10;);">PoUnregisterPowerSettingCallback</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-poregisterpowersettingcallback">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/wdm/nf-wdm-poregisterpowersettingcallback.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
