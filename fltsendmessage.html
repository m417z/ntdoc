<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="FltSendMessage - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>FltSendMessage - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            FltSendMessage - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// fltkernel.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body"><a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> FLTAPI FltSendMessage(
  [in]            PFLT_FILTER    Filter,
  [in]            PFLT_PORT      *ClientPort,
  [in]            PVOID          SenderBuffer,
  [in]            <a href="ulong" title="typedef unsigned long ULONG;">ULONG</a>          SenderBufferLength,
  [out, optional] PVOID          ReplyBuffer,
  [in, out]       PULONG         ReplyLength,
  [in, optional]  PLARGE_INTEGER Timeout
);</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fltkernel/nf-fltkernel-fltsendmessage">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/fltsendmessage.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-fltkernel-fltsendmessage)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="fltsendmessage-function">FltSendMessage function</h1>

<h2 id="description">Description</h2>

<p><strong>FltSendMessage</strong> sends a message to a waiting user-mode application on behalf of a minifilter driver or a minifilter driver instance.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="filter-in"><code>Filter</code> [in]</h3>

<p>Opaque filter pointer for the caller. This parameter is required and can't be NULL.</p>

<h3 id="clientport-in"><code>ClientPort</code> [in]</h3>

<p>Pointer to a variable that contains the opaque client port pointer for the connection port between the user-mode application and the kernel-mode minifilter driver. For more information about the client port pointer, see the description of the <strong>ConnectNotifyCallback</strong> parameter in the reference entry for <a rel="noopener" target="_blank" href="fltcreatecommunicationport"><strong>FltCreateCommunicationPort</strong></a>.</p>

<h3 id="senderbuffer-in"><code>SenderBuffer</code> [in]</h3>

<p>Pointer to a minifilter-allocated buffer containing the message to send to the user-mode application. This parameter is required and can't be NULL.</p>

<h3 id="senderbufferlength-in"><code>SenderBufferLength</code> [in]</h3>

<p>Size, in bytes, of the buffer that <strong>SenderBuffer</strong> points to. See <strong>Remarks</strong> for more information.</p>

<h3 id="replybuffer-out-optional"><code>ReplyBuffer</code> [out, optional]</h3>

<p>Pointer to a miniport-allocated buffer that receives a reply from the application, if any. This parameter is optional and can be NULL.</p>

<h3 id="replylength-in-out"><code>ReplyLength</code> [in, out]</h3>

<p>Size, in bytes, of the buffer that <strong>ReplyBuffer</strong> points to. This parameter is optional, but must be non-NULL when <strong>ReplyBuffer</strong> isn't NULL.</p>

<h3 id="timeout-in-optional"><code>Timeout</code> [in, optional]</h3>

<p>A pointer to a timeout value that specifies the total absolute or relative length of time, in units of 100 nanoseconds, for which the caller (miniport) can be put into a wait state until the message is received by the user-mode application and until it receives a reply if a reply is expected.</p>

<p>A positive value specifies an absolute time, relative to January 1, 1601. A negative value specifies an interval relative to the current time. Set <strong>Timeout</strong> to NULL if the caller can be put into a wait state indefinitely.</p>

<h2 id="return-value">Return value</h2>

<p><strong>FltSendMessage</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a> or an appropriate <a href="ntstatus" title="typedef _Return_type_success_(return &gt;= 0) long NTSTATUS;">NTSTATUS</a> value such as one of the following:</p>

<table>
<thead>
<tr>
  <th>Return code</th>
  <th>Description</th>
</tr>
</thead>
<tbody>
<tr>
  <td>STATUS_BUFFER_OVERFLOW</td>
  <td>A miniport-allocated buffer wasn't large enough. This is an error code.</td>
</tr>
<tr>
  <td>STATUS_INSUFFICIENT_RESOURCES</td>
  <td><strong>FltSendMessage</strong> encountered a pool allocation failure. This is an error code.</td>
</tr>
<tr>
  <td>STATUS_PORT_DISCONNECTED</td>
  <td>The communication port has been disconnected. This is an error code.</td>
</tr>
<tr>
  <td>STATUS_THREAD_IS_TERMINATING</td>
  <td>The wait was interrupted because the thread has been terminated by an application or user.</td>
</tr>
<tr>
  <td>STATUS_TIMEOUT</td>
  <td>The <strong>Timeout</strong> interval expired before the message could be delivered or before a reply was received. This is a success code.</td>
</tr>
</tbody>
</table>

<h2 id="remarks">Remarks</h2>

<p><strong>FltSendMessage</strong> sends a message to a user-mode application on behalf of a minifilter driver or a minifilter driver instance.</p>

<p>If the application calls <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fltuser/nf-fltuser-filtergetmessage"><strong>FilterGetMessage</strong></a> to get the message before the minifilter driver calls <strong>FltSendMessage</strong> to send it, the message that <strong>SendBuffer</strong> points to is delivered immediately when <strong>FltSendMessage</strong> is called. This is typically the case when the application calls <strong>FilterGetMessage</strong> from inside a message loop.</p>

<p>Otherwise, if an application has not called to get a message, <em>FltMgr</em> puts the minifilter into a wait state as follows:</p>

<ul>
<li><p>If <strong>Timeout</strong> points to a nonzero value and the application calls <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fltuser/nf-fltuser-filtergetmessage"><strong>FilterGetMessage</strong></a> before the <strong>Timeout</strong> interval expires, the message is delivered.</p></li>
<li><p>If <strong>Timeout</strong> points to a nonzero value and the application doesn't call <strong>FilterGetMessage</strong> before the <strong>Timeout</strong> interval expires, the message isn't delivered and <strong>FltSendMessage</strong> returns STATUS_TIMEOUT as a success code.</p></li>
<li><p>If <strong>Timeout</strong> points to zero (<code>*Timeout == 0</code>), <strong>FltSendMessage</strong> returns without waiting.</p></li>
<li><p>If <strong>Timeout</strong> is NULL (<code>Timeout == NULL</code>), the minifilter is put into a wait state indefinitely. When the application calls <strong>FilterGetMessage</strong>, the message is delivered.</p></li>
</ul>

<p>After the message is delivered, if <strong>ReplyBuffer</strong> is NULL, <strong>FltSendMessage</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a>.</p>

<p>Otherwise, if <strong>ReplyBuffer</strong> isn't NULL, the minifilter is put into a wait state as follows:</p>

<ul>
<li><p>If <strong>Timeout</strong> is nonzero and the application calls <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fltuser/nf-fltuser-filterreplymessage"><strong>FilterReplyMessage</strong></a> before the <strong>Timeout</strong> interval expires, the minifilter receives the reply, and <strong>FltSendMessage</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a>.</p></li>
<li><p>If <strong>Timeout</strong> is nonzero and the minifilter doesn't receive a reply before the <strong>Timeout</strong> interval expires, <strong>FltSendMessage</strong> returns STATUS_TIMEOUT as a success code.</p></li>
<li><p>If <strong>Timeout</strong> points to zero (<code>*Timeout == 0</code>), <strong>FltSendMessage</strong> returns without waiting.</p></li>
<li><p>If <strong>Timeout</strong> is zero when the minifilter is waiting for the reply, the minifilter is put into a wait state indefinitely. When the application calls <strong>FilterReplyMessage</strong>, the minifilter receives the reply, and <strong>FltSendMessage</strong> returns <a href="status_success" title="#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)">STATUS_SUCCESS</a>.</p></li>
</ul>

<h3 id="padding-and-buffer-size">Padding and Buffer Size</h3>

<p>Problems can occur when the caller doesn't consider system-specific structure padding that might occur.</p>

<p>For example, say a minifilter declares the following structure in which to receive a reply, and passes a pointer to it in <strong>ReplyBuffer</strong>:</p>

<div class="codehilite">
<pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_REPLY_STRUCT</span>
<span class="p">{</span>
<span class="w">    </span><span class="n"><a href="filter_reply_header" title="typedef struct _FILTER_REPLY_HEADER {&#10;  NTSTATUS  Status;&#10;  ULONGLONG MessageId;&#10;} FILTER_REPLY_HEADER, *PFILTER_REPLY_HEADER;">FILTER_REPLY_HEADER</a></span><span class="w"> </span><span class="n">Header</span><span class="p">;</span>
<span class="w">    </span><span class="n">REPLY_DATA</span><span class="w"> </span><span class="n">Data</span><span class="p">;</span><span class="w">  </span><span class="c1">// The structure to be sent to the minifilter with the reply.</span>
<span class="p">}</span><span class="w"> </span><span class="n">REPLY_STRUCT</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">PREPLY_STRUCT</span><span class="p">;</span>
</code></pre>
</div>

<p>Setting <strong>ReplyLength</strong> to <code>sizeof(REPLY_STRUCT)</code> would capture any padding that might be added to the end of any member of the structure, but isn't an accurate representation of the actual size of the structure and each of its members.</p>

<p>Setting <strong>ReplyLength</strong> to <code>sizeof(<a href="filter_reply_header" title="typedef struct _FILTER_REPLY_HEADER {&#10;  NTSTATUS  Status;&#10;  ULONGLONG MessageId;&#10;} FILTER_REPLY_HEADER, *PFILTER_REPLY_HEADER;">FILTER_REPLY_HEADER</a>) + sizeof(REPLY_DATA)</code> ensures that any padding at the end of either structures is ignored. In the event that padding might be added after the <strong>Header</strong> structure, <code>offsetof(REPLY_STRUCT, Data)</code> can be used to accurately access the beginning of the <strong>Data</strong> structure, and <code>sizeof(REPLY_DATA)</code> can be used to determine the true number of bytes in the <strong>Data</strong> structure.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fltuser/nf-fltuser-filtergetmessage"><strong>FilterGetMessage</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fltuser/nf-fltuser-filterreplymessage"><strong>FilterReplyMessage</strong></a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fltuser/nf-fltuser-filtersendmessage"><strong>FilterSendMessage</strong></a></p>

<p><a rel="noopener" target="_blank" href="fltcreatecommunicationport"><strong>FltCreateCommunicationPort</strong></a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fltkernel/nf-fltkernel-fltsendmessage">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/fltkernel/nf-fltkernel-fltsendmessage.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
