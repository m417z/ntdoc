<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="CopyFromModeAligned - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>CopyFromModeAligned - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            CopyFromModeAligned - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// usermode_accessors.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">#define CopyFromModeAligned(Destination, Source, Length, Mode, Alignment)                           \
            do {                                                                                    \
                if ((Mode) != KernelMode) {                                                         \
                    ExProbeAlignment((Source), (Length), (Alignment));                              \
                }                                                                                   \
                <a href="copyfrommode" title="VOID CopyFromMode(&#10;  VOID            *Destination,&#10;  const VOID      *Source,&#10;  SIZE_T          Length,&#10;  KPROCESSOR_MODE Mode&#10;);">CopyFromMode</a>((Destination), (Source), (Length), (Mode));                            \
            } while (0)</span><span class="ntdoc-code-footer"></span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/usermode_accessors/nf-usermode_accessors-copyfrommodealigned">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/copyfrommodealigned.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (nf-usermode_accessors-copyfrommodealigned)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h2 id="description">Description</h2>

<p>The <strong>CopyFromModeAligned</strong> macro safely copies data from specified-mode memory to kernel memory, with alignment checking.</p>

<h2 id="parameters">Parameters</h2>

<h3 id="destination"><code>Destination</code></h3>

<p>[out] A pointer to the kernel memory location where the data will be copied.</p>

<h3 id="source"><code>Source</code></h3>

<p>[in] A pointer to the memory location from which to copy the data.</p>

<h3 id="length"><code>Length</code></h3>

<p>[in] The number of bytes to copy.</p>

<h3 id="mode"><code>Mode</code></h3>

<p>[in] The processor mode that determines how the memory access is performed. <strong>Mode</strong> can be one of the following values.</p>

<table>
<thead>
<tr>
  <th>Value</th>
  <th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>KernelMode</strong></td>
  <td><strong>Source</strong> points to kernel-mode memory. The macro performs a direct memory copy with <a rel="noopener" target="_blank" href="https://learn.microsoft.com/cpp/standard-library/atomic-enums?view=msvc-170#memory_order_enum">memory_order_relaxed semantics</a>.</td>
</tr>
<tr>
  <td><strong>UserMode</strong></td>
  <td><strong>Source</strong> points to user-mode memory. The macro raises an exception if <strong>Source</strong> doesn't point to user-mode memory; otherwise it performs a copy from the specified address with <a rel="noopener" target="_blank" href="https://learn.microsoft.com/cpp/standard-library/atomic-enums?view=msvc-170#memory_order_enum">memory_order_relaxed semantics</a>.</td>
</tr>
</tbody>
</table>

<h3 id="alignment"><code>Alignment</code></h3>

<p>[in] The alignment boundary that the source pointer must satisfy.</p>

<h2 id="syntax">Syntax</h2>

<p><!-- CODE_MARKER --></p>

<div class="codehilite">
<pre><span></span><code><span class="cp">#define CopyFromModeAligned(Destination, Source, Length, Mode, Alignment)                           \</span>
<span class="cp">            do {                                                                                    \</span>
<span class="cp">                if ((Mode) != KernelMode) {                                                         \</span>
<span class="cp">                    ExProbeAlignment((Source), (Length), (Alignment));                              \</span>
<span class="cp">                }                                                                                   \</span>
<span class="cp">                <a href="copyfrommode" title="VOID CopyFromMode(&#10;  VOID            *Destination,&#10;  const VOID      *Source,&#10;  SIZE_T          Length,&#10;  KPROCESSOR_MODE Mode&#10;);">CopyFromMode</a>((Destination), (Source), (Length), (Mode));                            \</span>
<span class="cp">            } while (0)</span>
</code></pre>
</div>

<h2 id="remarks">Remarks</h2>

<p>This macro provides a safe way to copy data from either kernel or user-mode memory to kernel memory, with the copy mechanism determined by the specified processor mode and alignment verification. This allows for flexible memory operations that can adapt to different execution contexts while ensuring proper alignment requirements.</p>

<p>When <strong>Mode</strong> is <strong>KernelMode</strong>:</p>

<ul>
<li><p>The macro performs a volatile copy using <a rel="noopener" target="_blank" href="https://learn.microsoft.com/cpp/standard-library/atomic-enums?view=msvc-170#memory_order_enum">memory_order_relaxed semantics</a>.</p></li>
<li><p>The macro isn't recognized as a compiler intrinsic so the compiler will never optimize away the call (either entirely or replace the call with an equivalent sequence of instructions).</p></li>
<li><p>When the call returns, the data has been copied from <strong>Source</strong> to <strong>Destination</strong>. This macro's memory accesses to the <strong>Source</strong> and <strong>Destination</strong> will only be performed within the function (for example, the compiler can't move memory accesses out of this function).</p></li>
<li><p>The macro might access memory locations more than once as part of its copy operation.</p></li>
<li><p>The macro doesn't support copy operations when <strong>Source</strong> and <strong>Destination</strong> overlap each other.</p></li>
</ul>

<p>The macro raises a structured exception if the copy operation fails, such as when the source address is not valid for the specified mode, is not properly aligned according to the <strong>Alignment</strong> parameter, or is inaccessible.</p>

<p>If you are copying from a fixed-sized structure, you should use <strong><a href="readstructfrommodealigned" title="void ReadStructFromModeAligned(&#10;  Destination,&#10;  Source,&#10;  Mode,&#10;  Alignment&#10;);">ReadStructFromModeAligned</a></strong> instead to avoid the risk of passing the wrong size.</p>

<p>This macro will never be optimized away by the compiler, nor will the compiler create additional accesses to this memory location before the macro is called or after the macro returns (unless the source code explicitly performs these accesses).</p>

<p>This macro works on all versions of Windows, not just the latest. You need to consume the latest WDK to get the function declaration from the <em>usermode_accessors.h</em> header. You also need the library (<em>umaccess.lib</em>) from the latest WDK. However, the resulting driver will run fine on older versions of Windows.</p>

<h2 id="see-also">See also</h2>

<p><strong><a href="copyfrommode" title="VOID CopyFromMode(&#10;  VOID            *Destination,&#10;  const VOID      *Source,&#10;  SIZE_T          Length,&#10;  KPROCESSOR_MODE Mode&#10;);">CopyFromMode</a></strong></p>

<p><strong><a href="copyfromuser" title="VOID CopyFromUser(&#10;  VOID                *Destination,&#10;  volatile const VOID *Source,&#10;  SIZE_T              Length&#10;);">CopyFromUser</a></strong></p>

<p><strong><a href="copyfromuseraligned" title="#define CopyFromUserAligned(Destination, Source, Length, Alignment)                                 \&#10;            do {                                                                                    \&#10;                ExProbeAlignment((Source), (Length), (Alignment));                                  \&#10;                CopyFromUser((Destination), (Source), (Length));                                    \&#10;            } while (0)">CopyFromUserAligned</a></strong></p>

<p><strong><a href="copyfrommodenontemporal" title="VOID CopyFromModeNonTemporal(&#10;  VOID            *Destination,&#10;  const VOID      *Source,&#10;  SIZE_T          Length,&#10;  KPROCESSOR_MODE Mode&#10;);">CopyFromModeNonTemporal</a></strong></p>

<p><strong><a href="copytomode" title="VOID CopyToMode(&#10;  VOID            *Destination,&#10;  const VOID      *Source,&#10;  SIZE_T          Length,&#10;  KPROCESSOR_MODE Mode&#10;);">CopyToMode</a></strong></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/usermode_accessors/nf-usermode_accessors-copyfrommodealigned">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/usermode_accessors/nf-usermode_accessors-copyfrommodealigned.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
