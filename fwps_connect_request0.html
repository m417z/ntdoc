<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="FWPS_CONNECT_REQUEST0 - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>FWPS_CONNECT_REQUEST0 - NtDoc</title>
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <noscript id="dark-mode-toggle-stylesheets">
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <script src="dark-mode-toggle-stylesheets-loader.min.js"></script>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            FWPS_CONNECT_REQUEST0 - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><span class="ntdoc-code-header">// fwpsk.h

</span><span class="ntdoc-code-intro"></span><span class="ntdoc-code-body">typedef struct _FWPS_CONNECT_REQUEST0 {
  SOCKADDR_STORAGE              localAddressAndPort;
  SOCKADDR_STORAGE              remoteAddressAndPort;
  <a href="uint64" title="typedef unsigned __int64 UINT64;">UINT64</a>                        portReservationToken;
  <a href="dword" title="typedef unsigned long DWORD;">DWORD</a>                         localRedirectTargetPID;
  struct _FWPS_CONNECT_REQUEST0 *previousVersion;
  <a href="uint64" title="typedef unsigned __int64 UINT64;">UINT64</a>                        modifierFilterId;
  HANDLE                        localRedirectHandle;
  void                          *localRedirectContext;
  <a href="size_t-2" title="typedef ULONG_PTR SIZE_T;">SIZE_T</a>                        localRedirectContextSize;
} FWPS_CONNECT_REQUEST0;</span><span class="ntdoc-code-footer">
</span><span class="ntdoc-code-links"><hr><a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/ns-fwpsk-_fwps_connect_request0">View the official Windows Driver Kit DDI reference</a></span></code></pre></div>
</div>
<div class="ntdoc-descriptions">
<div class="ntdoc-description-title">
<h1>NtDoc</h1>
</div>
<div class="ntdoc-description">
<div class="ntdoc-description-none">
<p>No description available.</p>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/fwps_connect_request0.md">Edit description on GitHub</a>
</div>
</div>
<div class="ntdoc-description-title">
<h1>Windows Driver Kit DDI reference (ns-fwpsk-_fwps_connect_request0)</h1>
</div>
<div class="ntdoc-description ntdoc-description-selected">
<h1 id="_fwps_connect_request0-structure">_FWPS_CONNECT_REQUEST0 structure</h1>

<h2 id="description">Description</h2>

<p>The <strong>FWPS_CONNECT_REQUEST0</strong> structure defines modifiable data for the
<strong>FWPM_LAYER_ALE_AUTH_CONNECT_REDIRECT_V4</strong> and <strong>FWPM_LAYER_ALE_AUTH_CONNECT_REDIRECT_V6</strong> layers. The callout
driver uses this data to inspect or modify the connection information.</p>

<p><strong>Note</strong> <strong>FWPS_CONNECT_REQUEST0</strong> is a specific version of <strong>FWPS_CONNECT_REQUEST</strong>. See <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/desktop/FWP/wfp-version-independent-names-and-targeting-specific-versions-of-windows">WFP Version-Independent Names and Targeting Specific Versions of Windows</a> for more information.</p>

<h2 id="members">Members</h2>

<h3 id="localaddressandport"><code>localAddressAndPort</code></h3>

<p>The local transport address of the connect request. This is an IPV4 or IPV6 address and TCP port
formatted as a
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ws2def/ns-ws2def-sockaddr_storage_lh">SOCKADDR_STORAGE</a> structure.</p>

<h3 id="remoteaddressandport"><code>remoteAddressAndPort</code></h3>

<p>The remote transport address of the connect request. This is an IPV4 or IPV6 address and TCP/UDP
port formatted as a
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ws2def/ns-ws2def-sockaddr_storage_lh">SOCKADDR_STORAGE</a> structure.</p>

<h3 id="portreservationtoken"><code>portReservationToken</code></h3>

<p>A token used to reserve the appropriate port. The token is obtained when a port is reserved by
calling either
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/iphlpapi/nf-iphlpapi-createpersistenttcpportreservation">CreatePersistentTcpPortReservation</a> or
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/iphlpapi/nf-iphlpapi-createpersistentudpportreservation">CreatePersistentUdpPortReservation</a>.</p>

<h3 id="localredirecttargetpid"><code>localRedirectTargetPID</code></h3>

<p>The process identifier of the local host process that will be handling traffic to the address
specified in
<strong>localAddressAndPort</strong>. This value must be set for loopback redirect changes to be accepted by the
engine.</p>

<h3 id="previousversion"><code>previousVersion</code></h3>

<p>The previous version of the connect request data. This read-only field records the modification history of the connect request. If the connect
request data has not been previously modified by another WFP filter,
<em>previousVersion</em> will be set to <strong>NULL</strong>.</p>

<h3 id="modifierfilterid"><code>modifierFilterId</code></h3>

<p>The value of the
<strong>FilterId</strong> member of the
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/_netvista/">classifyFn</a> function's
<em>filter</em> parameter. For more information about the
<strong>FilterId</strong> member, see
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fwpstypes/ns-fwpstypes-fwps_filter1">FWPS_FILTER1</a>.</p>

<h3 id="localredirecthandle"><code>localRedirectHandle</code></h3>

<p>The redirect handle that the callout driver created by calling the <a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nf-fwpsk-fwpsredirecthandlecreate0">FwpsRedirectHandleCreate0</a> function.</p>

<p><strong>Note</strong> Starting with Windows 8, the <strong>localRedirectHandle</strong> must be populated for redirection to work.</p>

<h3 id="localredirectcontext"><code>localRedirectContext</code></h3>

<p>A callout driver context area that the callout driver allocated by calling the
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-exallocatepoolwithtag">ExAllocatePoolWithTag</a> function.</p>

<p><strong>Note</strong> Starting with Windows 8, memory allocated for <strong>localRedirectContext</strong> will have its ownership taken by WFP, and will be freed when the proxied flow is removed.</p>

<h3 id="localredirectcontextsize"><code>localRedirectContextSize</code></h3>

<p>The size, in bytes, of the callout-supplied context area.</p>

<p><strong>Note</strong> Supported starting with Windows 8.</p>

<h2 id="remarks">Remarks</h2>

<p>The callout driver obtains this structure by calling the
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nf-fwpsk-fwpsacquirewritablelayerdatapointer0">FwpsAcquireWritableLayerDataPointer0</a> function, which returns a pointer to a <strong>FWPS_CONNECT_REQUEST0</strong>
structure through the
<em>writableLayerData</em> parameter. The
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/_netvista/">classifyFn</a> function can modify the connect
request's parameters, such as redirecting the local or remote transport address or port to another
address or port. If it modifies the connect request's parameters, the <em>classifyFn</em> function must do the
following:</p>

<ul>
<li>Make all changes to the <strong>FWPS_CONNECT_REQUEST0</strong> structure that was returned by
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nf-fwpsk-fwpsacquirewritablelayerdatapointer0">FwpsAcquireWritableLayerDataPointer0</a>. Only the
<strong>remoteAddressAndPort</strong>,
<strong>portReservationToken</strong>, <strong>localRedirectTargetPID</strong>, <strong>localRedirectHandle</strong>, <strong>localRedirectContext</strong>, and <strong>localRedirectContextSize</strong> members can be modified.</li>
<li>Call
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nf-fwpsk-fwpsapplymodifiedlayerdata0">FwpsApplyModifiedLayerData0</a> with the
<em>modifiedLayerData</em> parameter set to the address of the <strong>FWPS_CONNECT_REQUEST0</strong> structure, even if the callout driver didn't modify any data. This value
must be the same as the
<em>modifiedLayerData</em> parameter value returned through
<a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nf-fwpsk-fwpsacquirewritablelayerdatapointer0">FwpsAcquireWritableLayerDataPointer0</a>.</li>
</ul>

<p>This structure acts as a linked list that contains a record of all the changes made by other callout
drivers. There is previous version information if the
<strong>previousVersion</strong> member is not <strong>NULL</strong>. To examine the complete version history, the callout driver
must continue to examine the
<strong>previousVersion</strong> member of each structure in the list until it is set to <strong>NULL</strong>.</p>

<h2 id="see-also">See also</h2>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/wdm/nf-wdm-exallocatepoolwithtag">ExAllocatePoolWithTag</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/fwpstypes/ns-fwpstypes-fwps_filter1">FWPS_FILTER1</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nf-fwpsk-fwpsacquirewritablelayerdatapointer0">FwpsAcquireWritableLayerDataPointer0</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nf-fwpsk-fwpsapplymodifiedlayerdata0">FwpsApplyModifiedLayerData0</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/nf-fwpsk-fwpsredirecthandlecreate0">FwpsRedirectHandleCreate0</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows/win32/api/ws2def/ns-ws2def-sockaddr_storage_lh">SOCKADDR_STORAGE</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/network/using-bind-or-connect-redirection">Using Bind or Connect
Redirection</a></p>

<p><a rel="noopener" target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/_netvista/">classifyFn</a></p>
<hr>
<div class="ntdoc-description-links">
<p>
<a target="_blank" href="https://learn.microsoft.com/windows-hardware/drivers/ddi/fwpsk/ns-fwpsk-_fwps_connect_request0">View the official Windows Driver Kit DDI reference</a>
</p>
<a target="_blank" href="https://github.com/MicrosoftDocs/windows-driver-docs-ddi/blob/staging/wdk-ddi-src/content/fwpsk/ns-fwpsk-_fwps_connect_request0.md">Edit description on GitHub</a>
</div>
</div>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        content by <a href="https://github.com/diversenok" target="_blank" rel="noopener">diversenok</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script src="modules/popper-2.11.8.min.js"></script>
    <script src="modules/tippy-6.3.7.min.js"></script>
    <script src="modules/anchor-5.0.0.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
